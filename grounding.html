<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Grounding/Earthing System Design Calculator - Design Calculators - Electrical</title>
    <!-- SEO Meta Tags -->
    <meta name="description" content="Professional industrial grounding/earthing system design calculator. Calculates earth resistance, step & touch potentials, and safety compliance per IEEE 80, IEC 60364 standards.">
    <meta name="keywords" content="grounding calculator, earthing system, earth resistance, step potential, touch potential, IEEE 80, IEC 60364, industrial electrical safety">
    <meta name="author" content="Design Calculators">
    <meta name="robots" content="index, follow">
    <!-- AdSense & Analytics -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5936527763614780" crossorigin="anonymous"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-23Y1V450SR"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-23Y1V450SR');
    </script>
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Montserrat:wght@700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- MathJax for Formulas -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['\\(', '\\)'], ['$', '$']],
                displayMath: [['\\[', '\\]'], ['$$', '$$']]
            },
            svg: { fontCache: 'global' }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <!-- PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root {
            --primary: #1E3A8A;
            --secondary: #2563EB;
            --accent: #F59E0B;
            --success: #10B981;
            --danger: #DC2626;
            --warning: #F59E0B;
            --bg: #F8FAFC;
            --card: #FFFFFF;
            --text: #4B5563;
            --heading: #111827;
            --footer-bg: #0F172A;
            --border: #E2E8F0;
            --grad: linear-gradient(135deg, var(--primary), var(--secondary));
            --grad-dark: linear-gradient(135deg, #0F172A, #1E293B);
            --shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        body.dark-mode {
            --primary: #10B981;
            --secondary: #34D399;
            --bg: #0F172A;
            --card: #1E293B;
            --text: #CBD5E1;
            --heading: #F1F5F9;
            --footer-bg: #020617;
            --border: #334155;
        }

        * { box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.7;
            margin: 0;
            padding: 0;
        }

        .container { max-width: 1280px; margin: 0 auto; padding: 0 24px; }

        /* Header & Nav */
        header {
            background: var(--grad);
            color: white;
            padding: 24px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo-container {
            display: flex;
            flex-direction: column;
            text-decoration: none;
            color: white;
        }
        .logo-text {
            font-size: 1.75rem;
            font-weight: 800;
            font-family: 'Montserrat', sans-serif;
        }
        .logo-subtitle {
            font-size: 0.8rem;
            margin: 4px 0 0 0;
            color: #E0E7FF;
            opacity: 0.9;
        }
        .nav-links {
            display: flex;
            gap: 24px;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        .nav-links a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }
        .nav-links a:hover { color: var(--accent); }
        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .switch {
            position: relative;
            width: 56px;
            height: 30px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.2);
            transition: .4s;
            border-radius: 30px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--accent);
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        /* Main Content & Cards */
        main { padding: 40px 0; }
        .card {
            background: var(--card);
            border-radius: 12px;
            padding: 30px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            border: 1px solid var(--border);
        }
        h2 {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
            padding-bottom: 15px;
            margin-top: 0;
            font-family: 'Montserrat', sans-serif;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        h3 {
            color: var(--heading);
            font-family: 'Montserrat', sans-serif;
            font-size: 1.5rem;
            margin-top: 25px;
            margin-bottom: 20px;
        }
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--heading);
        }
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 6px;
            background-color: var(--bg);
            color: var(--text);
            font-size: 1rem;
        }
        .form-group input:focus,
        .form-group select:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
        }
        body.dark-mode .form-group input:focus {
             box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }
        
        /* Input Modes */
        .input-mode-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background-color: var(--bg);
            border-radius: 8px;
            padding: 5px;
        }
        .input-mode-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            background: transparent;
            color: var(--text);
            font-weight: 600;
            transition: all 0.3s;
        }
        .input-mode-btn.active {
            background: var(--card);
            color: var(--primary);
            border-color: var(--primary);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .btn {
            background: var(--grad);
            color: white;
            border: none;
            padding: 16px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(30, 58, 138, 0.3);
            transition: all 0.3s;
            width: 100%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(30, 58, 138, 0.4);
        }
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .btn-group .btn {
            flex: 1;
            min-width: 150px;
        }
        .btn.secondary {
            background: var(--secondary);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }
        .btn.accent {
            background: var(--accent);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }

        /* CALCULATION STEPS DISPLAY - REVAMPED */
        .steps-container {
            display: none;
            margin-top: 30px;
        }
        .steps-container.active {
            display: block;
        }
        .step-card {
            background: var(--card);
            border-radius: 12px;
            padding: 25px 30px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            animation: slideIn 0.6s ease-out;
            transition: all 0.3s;
            margin-bottom: 25px; /* Spacing between cards */
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .step-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }
        .step-card h4 {
            color: var(--primary);
            margin: 0 0 20px 0;
            font-size: 1.4rem;
            font-family: 'Montserrat', sans-serif;
            display: flex;
            align-items: center;
        }
        .step-card .number {
            display: inline-block;
            width: 40px;
            height: 40px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 40px;
            font-weight: 700;
            margin-right: 15px;
            font-size: 1.3rem;
            flex-shrink: 0;
        }
        .step-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            align-items: center;
        }
        .step-content-full {
             grid-template-columns: 1fr;
        }
         @media (max-width: 768px) {
            .step-content {
                grid-template-columns: 1fr;
            }
        }
        .step-value {
            font-size: 2.2rem;
            font-weight: 800;
            color: var(--success);
            margin: 10px 0;
            line-height: 1.2;
        }
        .step-unit {
            font-size: 1rem;
            color: var(--text);
            opacity: 0.8;
            font-weight: 500;
            margin-left: 5px;
        }
        .formula {
            background: var(--bg);
            border-left: 3px solid var(--accent);
            padding: 15px;
            margin: 12px 0;
            font-size: 1rem;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
        }
        .step-explanation {
            font-size: 1.05rem;
            line-height: 1.8;
        }
        .step-explanation strong {
            color: var(--heading);
        }
        .analogy {
            background: var(--bg);
            border: 1px dashed var(--border);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-style: italic;
        }
        .analogy i {
            color: var(--primary);
            margin-right: 8px;
        }
        .step-recommendation {
            border-radius: 8px;
            padding: 20px;
        }
        .step-recommendation.warning {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(245, 158, 11, 0.05));
            border-left: 5px solid var(--warning);
        }
        .step-recommendation.warning h5 { color: var(--warning); }
        
        .step-recommendation.success {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
            border-left: 5px solid var(--success);
        }
         .step-recommendation.success h5 { color: var(--success); }
        
        .step-recommendation h5 {
            margin: 0 0 10px 0;
            font-size: 1.2rem;
            font-weight: 700;
        }
        .step-recommendation ul {
            padding-left: 20px;
            margin: 10px 0 0 0;
        }

        /* Results */
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-radius: 8px;
            overflow: hidden;
        }
        .results-table th,
        .results-table td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        .results-table th {
            background: var(--grad);
            color: white;
            font-weight: 700;
        }
        .results-table tr:nth-child(even) {
            background-color: var(--bg);
        }
        .results-table td:first-child {
            font-weight: 600;
            color: var(--heading);
        }
        .results-table .highlight {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--success);
        }
        .highlight-box {
            background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(16,185,129,0.05));
            border-left: 4px solid var(--success);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .highlight-box h4 {
            color: var(--success);
            margin-top: 0;
        }

        /* Educational Section */
        .education-section {
            margin-top: 60px;
        }
        .insight-card {
            background: linear-gradient(135deg, var(--card), rgba(37,99,235,0.03));
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            border-left: 5px solid var(--secondary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: all 0.3s;
        }
        .insight-card:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .insight-card h4 {
            color: var(--secondary);
            font-size: 1.3rem;
            margin: 0 0 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .insight-card h4 i {
            font-size: 1.5rem;
        }
        .insight-card p {
            margin: 10px 0;
            line-height: 1.8;
        }
        .stat-highlight {
            display: inline-block;
            background: var(--accent);
            color: #333;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 700;
            margin: 0 4px;
        }
        .danger-box {
            background: linear-gradient(135deg, rgba(220,38,38,0.1), rgba(220,38,38,0.05));
            border-left: 5px solid var(--danger);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }
        .danger-box h4 {
            color: var(--danger);
            margin-top: 0;
        }
        .success-box {
            background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(16,185,129,0.05));
            border-left: 5px solid var(--success);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }
        .success-box h4 {
            color: var(--success);
            margin-top: 0;
        }
        .three-col {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .metric-box {
            background: var(--card);
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        .metric-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
            margin: 10px 0;
        }
        .metric-label {
            font-size: 0.9rem;
            color: var(--text);
        }
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            border-radius: 8px;
            overflow: hidden;
        }
        .comparison-table th,
        .comparison-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }
        .comparison-table th {
            background: var(--grad);
            color: white;
            font-weight: 700;
        }
        .comparison-table tr:nth-child(even) {
            background: var(--bg);
        }

        /* Message Box */
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 16px 28px;
            border-radius: 8px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.25);
            z-index: 10000;
            font-weight: 600;
            color: white;
            opacity: 0;
            transition: all 0.4s;
            display: none;
        }
        .message-box.show {
            display: block;
            opacity: 1;
            top: 30px;
        }

        /* Footer */
        footer {
            background: var(--grad-dark);
            color: #CBD5E1;
            padding: 50px 0 20px 0;
            margin-top: 60px;
        }
        .footer-content {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 40px;
            margin-bottom: 30px;
        }
        .footer-col {
            flex: 1;
            min-width: 200px;
        }
        .footer-col h4 {
            color: white;
            margin-bottom: 15px;
            font-weight: 700;
        }
        .footer-col ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .footer-col a {
            color: #CBD5E1;
            text-decoration: none;
            transition: color 0.3s;
        }
        .footer-col a:hover {
            color: var(--accent);
        }
        .social-buttons {
            display: flex;
            gap: 12px;
            margin-top: 15px;
        }
        .social-btn {
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            border-radius: 50%;
            font-size: 1.1rem;
            transition: transform 0.3s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .social-btn:hover {
            transform: translateY(-4px);
        }
        .social-btn.linkedin { background-color: #0A66C2; }
        .social-btn.youtube { background-color: #FF0000; }
        .social-btn.twitter { background-color: #1DA1F2; }
        .social-btn.facebook { background-color: #1877F2; }
        .social-btn.whatsapp { background-color: #25D366; }
        .footer-disclaimer {
            text-align: center;
            padding-top: 25px;
            border-top: 1px solid #334155;
            max-width: 800px;
            margin: 0 auto;
            font-size: 0.9rem;
        }
        .footer-bottom {
            text-align: center;
            padding-top: 20px;
            font-size: 0.9rem;
            color: #94A3B8;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container { padding: 0 15px; }
            .navbar { flex-direction: column; gap: 20px; }
            .nav-links { flex-direction: column; gap: 12px; text-align: center; }
            .form-row { grid-template-columns: 1fr; }
            .card { padding: 20px; }
            .footer-content { flex-direction: column; gap: 25px; }
            .btn-group { flex-direction: column; }
            .input-mode-toggle { flex-direction: column; }
        }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div id="message-box" class="message-box"></div>

    <header>
        <div class="container">
            <nav class="navbar">
                <a href="#" class="logo-container">
                    <span class="logo-text">Design Calculators</span>
                    <p class="logo-subtitle">Inspired by standards such as IEC, IEEE, ISA, ASME, and API.</p>
                </a>
                <ul class="nav-links">
                    <li><a href='/'>Home</a></li>
                    <li><a href="articles">Articles</a></li>
                    <li><a href="indexmech">Mechanical</a></li>
                    <li><a href="indexele">Electrical</a></li>
                    <li><a href="indexinst">Instrumentation</a></li>
                </ul>
                <div class="theme-toggle">
                    <i class="fas fa-sun"></i>
                    <label class="switch">
                        <input type="checkbox" id="theme-switch">
                        <span class="slider"></span>
                    </label>
                    <i class="fas fa-moon"></i>
                </div>
            </nav>
        </div>
    </header>

    <main class="container">
        <div class="card">
            <h2><i class="fas fa-bolt"></i> Advanced Grounding/Earthing System Design Calculator</h2>
            <p>Calculate earth resistance, step & touch potentials, and design safe grounding systems for industrial applications. Aligned with IEEE 80, IEC 60364, and other international standards.</p>

            <form id="grounding-form">
                <h3>System & Soil Parameters</h3>
                
                <!-- Input Mode Toggle -->
                <div class="input-mode-toggle">
                    <button type="button" class="input-mode-btn active" data-mode="basic"><i class="fas fa-sliders-h"></i> Basic Parameters</button>
                    <button type="button" class="input-mode-btn" data-mode="advanced"><i class="fas fa-cogs"></i> Advanced Parameters</button>
                </div>
                
                <!-- Mode 1: Basic -->
                <div id="mode-basic">
                     <div class="form-row">
                        <div class="form-group">
                            <label for="soil-resistivity">Soil Resistivity (Ω·m)</label>
                            <input type="number" id="soil-resistivity" min="1" step="1" value="100" required>
                        </div>
                        <div class="form-group">
                            <label for="rod-length">Earth Rod Length (m)</label>
                            <input type="number" id="rod-length" min="0.5" step="0.1" value="3.0" required>
                        </div>
                         <div class="form-group">
                            <label for="rod-diameter">Earth Rod Diameter (mm)</label>
                            <input type="number" id="rod-diameter" min="5" step="1" value="16" required>
                        </div>
                    </div>
                </div>

                <!-- Mode 2: Advanced -->
                <div id="mode-advanced" class="hidden">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="number-of-rods">Number of Parallel Rods</label>
                            <input type="number" id="number-of-rods" min="1" step="1" value="1">
                        </div>
                        <div class="form-group">
                            <label for="rod-spacing">Rod Spacing (m)</label>
                            <input type="number" id="rod-spacing" min="0" step="0.1" value="6.0">
                        </div>
                        <div class="form-group">
                            <label for="fault-current">Maximum Fault Current (A)</label>
                            <input type="number" id="fault-current" min="1" step="1" value="5000" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="fault-duration">Fault Duration (s)</label>
                            <input type="number" id="fault-duration" min="0.01" step="0.01" value="0.2" required>
                        </div>
                        <div class="form-group">
                            <label for="surface-resistivity">Surface Layer Resistivity (Ω·m)</label>
                            <input type="number" id="surface-resistivity" min="1" step="1" value="3000" required>
                        </div>
                        <div class="form-group">
                            <label for="system-type">System Type</label>
                            <select id="system-type" required>
                                <option value="substation">Substation</option>
                                <option value="industrial" selected>Industrial Facility</option>
                                <option value="commercial">Commercial Building</option>
                                <option value="residential">Residential</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <hr style="margin: 15px 0; border: none; border-top: 1px solid var(--border);">

                <h3>Advanced Configuration</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="soil-layers">Soil Layers</label>
                        <select id="soil-layers" required>
                            <option value="single" selected>Single Layer (Simplified)</option>
                            <option value="two">Two Layers (Advanced)</option>
                            <option value="multi">Multi-Layer (Professional)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="electrode-type">Electrode Type</label>
                        <select id="electrode-type" required>
                            <option value="rod" selected>Vertical Rod</option>
                            <option value="plate">Ground Plate</option>
                            <option value="grid">Ground Grid</option>
                            <option value="ring">Ring Electrode</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="material">Electrode Material</label>
                        <select id="material" required>
                            <option value="copper" selected>Copper</option>
                            <option value="copper-clad">Copper-Clad Steel</option>
                            <option value="galvanized">Galvanized Steel</option>
                        </select>
                    </div>
                </div>

                <div class="btn-group" style="margin-top: 25px;">
                    <button type="button" id="calc-btn" class="btn"><i class="fas fa-calculator"></i> Calculate Grounding System</button>
                    <button type="button" id="reset-btn" class="btn accent"><i class="fas fa-sync-alt"></i> Reset</button>
                    <button type="button" id="pdf-btn" class="btn secondary" style="display: none;"><i class="fas fa-file-pdf"></i> Download PDF</button>
                </div>
            </form>
        </div>

        <!-- LIVE CALCULATION STEPS -->
        <div id="steps-container" class="steps-container">
            
            <div class="step-card">
                <h4><span class="number">1</span> Soil & Electrode Analysis</h4>
                <div class="step-content">
                    <div class="step-explanation">
                        <p>First, we analyze your <strong>soil characteristics</strong> and <strong>electrode configuration</strong> to understand the baseline conditions. Soil resistivity is the most critical parameter in grounding design, as it directly impacts how effectively current can dissipate into the earth.</p>
                        <p>Different electrode types (rods, plates, grids) have varying effectiveness depending on soil conditions and available space.</p>
                        <div class="analogy">
                            <i class="fas fa-tint"></i><strong>The Water Analogy:</strong> Think of soil resistivity like the porosity of soil - sandy soil (low resistivity) allows water to flow through easily, while clay (high resistivity) resists water flow. Your grounding system needs to work with your specific "soil porosity" to safely dissipate electrical faults.
                        </div>
                    </div>
                    <div id="step1-content">
                        <!-- Content dynamically inserted by JS -->
                    </div>
                </div>
            </div>

            <div class="step-card">
                <h4><span class="number">2</span> Earth Resistance Calculation</h4>
                <div class="step-content">
                     <div class="step-explanation">
                        <p>Next, we calculate the <strong>earth resistance</strong> of your grounding system. This resistance determines how effectively your system can dissipate fault currents into the earth.</p>
                        <p>For multiple electrodes, we account for mutual resistance effects - electrodes placed too close together don't work efficiently because their "zones of influence" overlap.</p>
                    </div>
                    <div id="step2-content">
                        <!-- Content dynamically inserted by JS -->
                    </div>
                </div>
            </div>
            
            <div class="step-card">
                <h4><span class="number">3</span> Safety Potential Analysis</h4>
                <div class="step-content">
                    <div class="step-explanation">
                        <p>The most critical aspect of grounding design is ensuring personnel safety during fault conditions. We calculate <strong>step and touch potentials</strong> - the voltage differences a person could experience during a ground fault.</p>
                        <p>These potentials must be kept below safe limits defined by standards like IEEE 80 to prevent electrocution.</p>
                        <p><strong>Formula (Touch Voltage):</strong><br> $E_{touch} = \frac{(1000 + 1.5 \cdot C_s \cdot \rho_s) \cdot K}{\sqrt{t_f}}$</p>
                    </div>
                    <div id="step3-content">
                        <!-- Content dynamically inserted by JS -->
                    </div>
                </div>
            </div>
            
            <div class="step-card">
                <h4><span class="number">4</span> Professional System Design</h4>
                 <div class="step-content step-content-full">
                    <div class="step-explanation">
                        <p>Based on your specific application and calculated values, we recommend the optimal grounding system configuration to ensure both safety and performance.</p>
                    </div>
                    <div id="step4-content" style="margin-top: 20px;">
                        <!-- Recommendations inserted by JS -->
                    </div>
                </div>
            </div>
            
             <div class="step-card">
                <h4><span class="number">5</span> System Performance & Compliance</h4>
                 <div class="step-content step-content-full">
                    <div class="step-explanation">
                        <p>We evaluate your system against international standards and provide specific recommendations for achieving compliance and optimal performance.</p>
                    </div>
                    <div id="step5-content" style="margin-top: 20px;">
                        <!-- Sizing inserted by JS -->
                    </div>
                </div>
            </div>

            <div class="step-card">
                <h4><span class="number">6</span> Implementation Guidelines</h4>
                 <div class="step-content">
                    <div class="step-explanation">
                        <p>Proper installation is crucial for grounding system effectiveness. We provide specific guidelines for electrode placement, connections, and testing to ensure your system performs as designed.</p>
                    </div>
                    <div id="step6-content">
                        <!-- Implementation details inserted by JS -->
                    </div>
                </div>
            </div>

        </div>

        <!-- RESULTS TABLE -->
        <div id="results-section" class="card hidden" style="margin-top: 40px;">
            <h3><i class="fas fa-clipboard-check"></i> Complete Grounding System Design Report</h3>
            <table class="results-table">
                <thead>
                    <tr>
                        <th>Parameter</th>
                        <th>Specification / Value</th>
                    </tr>
                </thead>
                <tbody id="results-tbody"></tbody>
            </table>
        </div>

        <!-- EDUCATIONAL INSIGHTS SECTION -->
        <div class="education-section card">
            <h2><i class="fas fa-lightbulb"></i> Professional Insights: The Science of Safe Grounding</h2>

            <!-- New: Grounding Fundamentals -->
            <div class="danger-box">
                <h4>⚠️ The Critical Role of Grounding in Electrical Safety</h4>
                <p><strong>What is grounding?</strong> Grounding provides a safe path for electrical current to flow into the earth during fault conditions, preventing dangerous voltage buildup on equipment enclosures and ensuring protective devices operate correctly.</p>
                <p><strong>The Life-Saving Function:</strong> During a fault, proper grounding:
                    <ul>
                        <li>Limits touch and step potentials to safe levels</li>
                        <li>Ensures rapid operation of overcurrent protection</li>
                        <li>Prevents equipment damage and fire hazards</li>
                        <li>Provides voltage stabilization for sensitive electronics</li>
                    </ul>
                <strong>The Standards:</strong> IEEE Std 80 provides comprehensive guidelines for substation grounding, while IEC 60364 covers general electrical installations. These standards define safe limits for step and touch potentials based on fault duration and body weight assumptions.</p>
            </div>

            <div class="insight-card">
                <h4><i class="fas fa-mountain"></i> Soil Resistivity: The Foundation of Grounding Design</h4>
                <p><strong>The Most Critical Parameter:</strong> Soil resistivity ($\rho$) varies dramatically - from 1 Ω·m for marshy ground to over 10,000 Ω·m for bedrock. This single parameter can change your grounding system requirements by orders of magnitude.</p>
                <p><strong>Measurement Methods:</strong> The Wenner four-pin method is the industry standard for soil resistivity measurement. It involves placing four electrodes in a straight line at equal spacing and measuring the resistance between the inner electrodes while passing current through the outer ones.</p>
                <p><strong>Seasonal Variations:</strong> Soil resistivity changes with moisture content and temperature. Design should consider the worst-case (highest resistivity) conditions, typically during freezing or drought periods.</p>
                <p><strong>Multi-Layer Analysis:</strong> Real soil is rarely uniform. Professional designs use two-layer or multi-layer models where resistivity changes with depth, requiring specialized software like CDEGS or ETAP for accurate analysis.</p>
            </div>
            
            <!-- Existing content below -->

            <div class="insight-card">
                <h4><i class="fas fa-chart-line"></i> Step & Touch Potentials: The Invisible Danger</h4>
                <p><strong>Step Potential:</strong> The voltage difference between two feet (approximately 1 meter apart) of a person standing on earth during a fault. Current flows through the legs and lower body.</p>
                <p><strong>Touch Potential:</strong> The voltage difference between a person's hand (touching grounded equipment) and their feet during a fault. Current flows through the heart, making it more dangerous than step potential.</p>
                <p><strong>Real-World Impact:</strong> A 2008 incident at a Texas refinery resulted in a worker's death due to inadequate grounding during a 13.8kV cable fault. The step potential exceeded 5,000V while the permissible limit was only 375V for the 0.3-second fault duration. <span class="stat-highlight">Proper grounding design could have prevented this tragedy.</span></p>
                <p><strong>IEEE Std 80 Formulas:</strong> The standard provides detailed calculations for permissible body current limits:
                $$E_{step} = \frac{(1000 + 6C_s\rho_s)K}{\sqrt{t_s}}$$
                $$E_{touch} = \frac{(1000 + 1.5C_s\rho_s)K}{\sqrt{t_s}}$$
                Where $C_s$ is the surface layer derating factor and $K$ is 0.116 for 50kg body weight.</p>
            </div>

            <div class="three-col">
                <div class="metric-box">
                    <div class="metric-label">Typical Target Resistance</div>
                    <div class="metric-value" style="color: var(--success);">1-5 Ω</div>
                    <p style="margin: 10px 0 0 0; font-size: 0.85rem;">For most industrial applications</p>
                </div>
                <div class="metric-box">
                    <div class="metric-label">Cost of Poor Grounding</div>
                    <div class="metric-value" style="color: var(--danger);">$50,000+</div>
                    <p style="margin: 10px 0 0 0; font-size: 0.85rem;">Equipment damage per incident</p>
                </div>
                <div class="metric-box">
                    <div class="metric-label">Lives Saved Annually</div>
                    <div class="metric-value" style="color: var(--primary);">50+</div>
                    <p style="margin: 10px 0 0 0; font-size: 0.85rem;">Through proper grounding in US alone</p>
                </div>
            </div>

            <div class="insight-card">
                <h4><i class="fas fa-bolt"></i> Grounding Electrode Systems: Beyond Simple Rods</h4>
                <p>While vertical rods are common, professional grounding systems often combine multiple electrode types for optimal performance:</p>
                <p><strong>Ground Grids:</strong> Interconnected conductors buried horizontally, typically used in substations. They provide excellent potential control but require significant space.</p>
                <p><strong>Ring Electrodes:</strong> Conductors encircling a structure at a constant depth, effective for potential gradient control around buildings.</p>
                <p><strong>Ground Plates:</strong> Large metallic plates buried horizontally, effective in areas with limited vertical depth.</p>
                <p><strong>Chemical Electrodes:</strong> Rods surrounded by special backfill material that maintains low resistivity by retaining moisture and providing ionic conduction paths.</p>
                <p><strong>Deep Ground Wells:</strong> Electrodes installed in boreholes reaching low-resistivity layers, sometimes extending hundreds of feet deep.</p>
            </div>

            <div class="success-box">
                <h4>✓ Advanced Techniques for Challenging Sites</h4>
                <p><strong>High-Resistivity Locations:</strong> When soil resistivity exceeds 1,000 Ω·m, standard approaches may be insufficient:</p>
                <ul>
                    <li><strong>Chemical Treatment:</strong> Adding bentonite, marconite, or other conductive backfill materials around electrodes</li>
                    <li><strong>Deep Grounding:</strong> Extending electrodes to reach lower resistivity layers at greater depths</li>
                    <li><strong>Multiple Electrode Arrays:</strong> Using numerous rods with optimal spacing (2-2.5 times rod length)</li>
                    <li><strong>Horizontal Counterpoise:</strong> Adding radial conductors to increase surface area contact with soil</li>
                    <li><strong>Ground Enhancement Materials:</strong> Using conductive concrete or other specialized materials</li>
                </ul>
            </div>
            
            <div class="insight-card">
                <h4><i class="fas fa-cogs"></i> Standards & Regulations: The Engineering Framework</h4>
                <p><strong>IEEE Std 80:</strong> The definitive guide for AC substation grounding safety - covers calculation methods, material specifications, and safety limits.</p>
                <p><strong>IEEE Std 81:</strong> Guide for measuring earth resistivity, ground impedance, and earth surface potentials.</p>
                <p><strong>IEC 60364-5-54:</strong> International standard for earthing arrangements and protective conductors in electrical installations.</p>
                <p><strong>NEC Article 250:</strong> US National Electrical Code requirements for grounding and bonding.</p>
                <p><strong>OSHA 1910.304:</strong> US Occupational Safety and Health Administration requirements for grounding to protect workers.</p>
                <p><strong>ANSI/IEEE C62.41:</strong> Guide for surge protection in low-voltage AC power circuits, closely related to grounding practices.</p>
            </div>

            <div class="danger-box">
                <h4>⚠️ Common Grounding Design Mistakes & How to Avoid Them</h4>
                <p>Even experienced engineers can make critical errors in grounding design:</p>
                <ul>
                    <li><strong>Underestimating Soil Resistivity:</strong> Always conduct proper soil testing across seasons</li>
                    <li><strong>Ignoring Step & Touch Potentials:</strong> Focusing only on resistance values while neglecting safety voltages</li>
                    <li><strong>Inadequate Electrode Spacing:</strong> Placing rods too close together, reducing effectiveness</li>
                    <li><strong>Corrosion Issues:</strong> Using incompatible materials or failing to account for soil chemistry</li>
                    <li><strong>Poor Connections:</strong> Using improper connectors or techniques that degrade over time</li>
                    <li><strong>Neglecting Maintenance:</strong> Failing to periodically test and inspect grounding systems</li>
                    <li><strong>Insufficient Fault Current Analysis:</strong> Not considering maximum possible fault scenarios</li>
                </ul>
                <p><strong>The Solution:</strong> Follow a systematic design process using verified calculation methods and always validate with field measurements after installation.</p>
            </div>
           
        </div>
    </main>

    <!-- FOOTER -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-col">
                    <h4>Design Calculators</h4>
                    <p style="font-size: 0.9rem; line-height: 1.6; margin-bottom: 15px;">If you find this tool helpful, please consider sharing it with your colleagues!</p>
                    <div class="social-buttons">
                        <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn linkedin" title="LinkedIn"><i class="fab fa-linkedin-in"></i></a>
                        <a href="https://www.youtube.com/@designcalculators" target="_blank" rel="noopener noreferrer" class="social-btn youtube" title="YouTube"><i class="fab fa-youtube"></i></a>
                        <a href="https://twitter.com/intent/tweet?url=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn twitter" title="Twitter"><i class="fab fa-twitter"></i></a>
                        <a href="https://www.facebook.com/sharer/sharer.php?u=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn facebook" title="Facebook"><i class="fab fa-facebook-f"></i></a>
                        <a href="https://api.whatsapp.com/send?text=Check%20out%20this%20amazing%20engineering%20resource%20https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn whatsapp" title="WhatsApp"><i class="fab fa-whatsapp"></i></a>
                    </div>
                </div>
                <div class="footer-col">
                    <h4>Quick Links</h4>
                    <ul>
                        <li><a href='/'>Home</a></li>
                        <li><a href="indexele">Electrical</a></li>
                        <li><a href="indexmech">Mechanical</a></li>
                        <li><a href="indexinst">Instrumentation</a></li>
                        <li><a href="articles">Articles</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>Resources</h4>
                    <ul>
                        <li><a href="about">About Us</a></li>
                        <li><a href="contact">Contact</a></li>
                        <li><a href="faq">FAQ</a></li>
                        <li><a href="privacy-policy">Privacy Policy</a></li>
                        <li><a href="terms-of-service">Terms of Service</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>More</h4>
                    <ul>
                        <li><a href='/articles'>Articles & Whitepapers</a></li>
                        <li><a href="sitemap.html">Sitemap</a></li>
                        <li><a href="https://www.youtube.com/@designcalculators" target="_blank" rel="noopener noreferrer">YouTube Channel</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-disclaimer">
                <p>All calculations are for preliminary engineering design guidance. Final grounding system installation must comply with IEEE 80, IEEE 81, IEC 60364-5-54, NEC Article 250, and local electrical codes. Always perform detailed soil resistivity testing and consider seasonal variations. For critical installations, comprehensive analysis using specialized software (e.g., CDEGS, ETAP) is required. Consult with a licensed professional engineer before implementation.</p>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Design Calculators. Created by <span style="color: var(--secondary); font-weight: bold;">A Sharma</span>. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Form Elements
            const form = document.getElementById('grounding-form');
            const calcBtn = document.getElementById('calc-btn');
            const resetBtn = document.getElementById('reset-btn');
            const pdfBtn = document.getElementById('pdf-btn');
            
            // Input Mode
            const modeButtons = document.querySelectorAll('.input-mode-btn');
            const modeBasic = document.getElementById('mode-basic');
            const modeAdvanced = document.getElementById('mode-advanced');
            let currentMode = 'basic';
            
            // Outputs
            const stepsContainer = document.getElementById('steps-container');
            const resultsSection = document.getElementById('results-section');
            const resultsTbody = document.getElementById('results-tbody');
            const messageBox = document.getElementById('message-box');
            
            // Theme
            const themeSwitch = document.getElementById('theme-switch');

            // --- Event Listeners ---
            
            // Input Mode Toggle
            modeButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    currentMode = btn.dataset.mode;
                    modeButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    if (currentMode === 'basic') {
                        modeBasic.classList.remove('hidden');
                        modeAdvanced.classList.add('hidden');
                    } else {
                        modeBasic.classList.add('hidden');
                        modeAdvanced.classList.remove('hidden');
                    }
                });
            });

            // Dark Mode
            themeSwitch.addEventListener('change', function() {
                if (this.checked) {
                    document.body.classList.add('dark-mode');
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.body.classList.remove('dark-mode');
                    localStorage.setItem('theme', 'light');
                }
            });

            // Load Dark Mode Preference
            if (localStorage.getItem('theme') === 'dark') {
                document.body.classList.add('dark-mode');
                themeSwitch.checked = true;
            }

            // Calculate Button
            calcBtn.addEventListener('click', performCalculation);

            // Reset Button
            resetBtn.addEventListener('click', function() {
                form.reset();
                stepsContainer.classList.remove('active');
                resultsSection.classList.add('hidden');
                pdfBtn.style.display = 'none';
                // Reset mode to default
                modeButtons[0].click();
                showMessage('Form reset');
            });

            // PDF Button
            pdfBtn.addEventListener('click', generatePDF);

            // --- Utility Functions ---

            function showMessage(msg, type = 'success') {
                messageBox.textContent = msg;
                if (type === 'error') {
                    messageBox.style.backgroundColor = 'var(--danger)';
                } else if (type === 'warning') {
                     messageBox.style.backgroundColor = 'var(--warning)';
                } else {
                    messageBox.style.backgroundColor = 'var(--success)';
                }
                messageBox.classList.add('show');
                setTimeout(() => messageBox.classList.remove('show'), 4000);
            }
            
            function format(num, decimals = 2) {
                return num.toFixed(decimals).replace(/\.00$/, '');
            }

            // --- Main Calculation Logic ---

            function performCalculation() {
                try {
                    // 1. Get All Inputs
                    const soilResistivity = parseFloat(document.getElementById('soil-resistivity').value);
                    const rodLength = parseFloat(document.getElementById('rod-length').value);
                    const rodDiameter = parseFloat(document.getElementById('rod-diameter').value);
                    const numberOfRods = parseInt(document.getElementById('number-of-rods').value) || 1;
                    const rodSpacing = parseFloat(document.getElementById('rod-spacing').value) || 0;
                    const faultCurrent = parseFloat(document.getElementById('fault-current').value);
                    const faultDuration = parseFloat(document.getElementById('fault-duration').value);
                    const surfaceResistivity = parseFloat(document.getElementById('surface-resistivity').value);
                    const systemType = document.getElementById('system-type').value;
                    const soilLayers = document.getElementById('soil-layers').value;
                    const electrodeType = document.getElementById('electrode-type').value;
                    const material = document.getElementById('material').value;

                    // Input validation
                    if (!soilResistivity || !rodLength || !rodDiameter || !faultCurrent || !faultDuration || !surfaceResistivity) {
                        throw new Error('Please fill all required fields');
                    }

                    if (soilResistivity <= 0 || rodLength <= 0 || rodDiameter <= 0 || faultCurrent <= 0 || 
                        faultDuration <= 0 || surfaceResistivity <= 0) {
                        throw new Error('All values must be positive numbers');
                    }

                    if (numberOfRods > 1 && rodSpacing <= 0) {
                        throw new Error('For multiple rods, please enter a positive value for rod spacing');
                    }

                    // 2. Core Calculations
                    const rodRadiusMeters = (rodDiameter / 2) / 1000;
                    
                    // Single rod resistance using Dwight's formula
                    let earthResistanceSingleRod = (soilResistivity / (2 * Math.PI * rodLength)) * 
                                                 (Math.log((4 * rodLength) / rodRadiusMeters) - 1);
                    
                    // Multiple rods combining factor
                    let combiningFactorK = 1;
                    let totalEarthResistance = earthResistanceSingleRod;
                    
                    if (numberOfRods > 1) {
                        // Empirical combining factor for parallel rods
                        combiningFactorK = (0.377527 * Math.log(numberOfRods)) + 0.89057;
                        totalEarthResistance = earthResistanceSingleRod * combiningFactorK;
                    }
                    
                    // 3. Safety Potential Calculations (IEEE Std 80)
                    let Cs = 1;
                    if (surfaceResistivity > soilResistivity) {
                        Cs = 1 - (0.09 * (1 - (soilResistivity / surfaceResistivity)));
                    }
                    
                    const K_touch_50 = 0.116; // Constant for 50kg person
                    const E_touch_permissible = (1000 + 1.5 * Cs * surfaceResistivity) * K_touch_50 / Math.sqrt(faultDuration);
                    
                    const K_step_50 = 0.116; // Constant for 50kg person
                    const E_step_permissible = (1000 + 6 * Cs * surfaceResistivity) * K_step_50 / Math.sqrt(faultDuration);
                    
                    const GPR = faultCurrent * totalEarthResistance;
                    
                    // 4. System Recommendations
                    let systemRecommendation = "";
                    let safetyStatus = "";
                    
                    if (GPR < E_touch_permissible && GPR < E_step_permissible) {
                        safetyStatus = "SAFE";
                        systemRecommendation = "Your grounding system design appears safe based on calculated values.";
                    } else {
                        safetyStatus = "REQUIRES IMPROVEMENT";
                        systemRecommendation = "Your grounding system may not provide adequate safety during fault conditions. Consider adding more electrodes, using chemical treatment, or implementing a ground grid.";
                    }
                    
                    // 5. Update UI - Step 1
                    document.getElementById('step1-content').innerHTML = `
                        <p><strong>Soil Resistivity:</strong> <span class="step-value" style="color:var(--heading);">${format(soilResistivity, 2)}<span class="step-unit">Ω·m</span></span></p>
                        <p><strong>Electrode Type:</strong> <span class="step-value" style="color:var(--heading); font-size: 1.2rem;">${electrodeType.toUpperCase()}</span></p>
                        <p><strong>Electrode Material:</strong> <span class="step-value" style="color:var(--heading); font-size: 1.2rem;">${material.toUpperCase()}</span></p>
                        <p><strong>Soil Model:</strong> <span class="step-value" style="color:var(--heading); font-size: 1.2rem;">${soilLayers.toUpperCase()} LAYER</span></p>
                    `;
                    
                    // Step 2
                    document.getElementById('step2-content').innerHTML = `
                        <p><strong>Single Rod Resistance:</strong> <span class="step-value" style="color:var(--heading);">${format(earthResistanceSingleRod, 3)}<span class="step-unit">Ω</span></span></p>
                        ${numberOfRods > 1 ? `
                        <p><strong>Combining Factor (K):</strong> <span class="step-value" style="color:var(--heading);">${format(combiningFactorK, 3)}</span></p>
                        ` : ''}
                        <p><strong>Total Earth Resistance:</strong> <span class="step-value" style="color:var(--success);">${format(totalEarthResistance, 3)}<span class="step-unit">Ω</span></span></p>
                    `;
                    
                    // Step 3
                    document.getElementById('step3-content').innerHTML = `
                        <p><strong>Ground Potential Rise (GPR):</strong> <span class="step-value" style="color:var(--danger);">${format(GPR, 2)}<span class="step-unit">V</span></span></p>
                        <p><strong>Permissible Touch Voltage:</strong> <span class="step-value" style="color:var(--success);">${format(E_touch_permissible, 2)}<span class="step-unit">V</span></span></p>
                        <p><strong>Permissible Step Voltage:</strong> <span class="step-value" style="color:var(--success);">${format(E_step_permissible, 2)}<span class="step-unit">V</span></span></p>
                    `;
                    
                    // Step 4
                    let safetyClass = safetyStatus === "SAFE" ? "success" : "warning";
                    
                    document.getElementById('step4-content').innerHTML = `
                        <div class="step-recommendation ${safetyClass}">
                            <h5><i class="fas fa-shield-alt"></i> Safety Assessment: ${safetyStatus}</h5>
                            <p>${systemRecommendation}</p>
                        </div>
                        <div class="highlight-box" style="margin-top: 20px;">
                            <h4><i class="fas fa-check-circle"></i> Recommended Actions</h4>
                            <ul>
                                <li>Verify soil resistivity with on-site testing</li>
                                <li>Consider seasonal variations in soil conditions</li>
                                <li>Perform detailed analysis for critical installations</li>
                                <li>Validate design with field measurements after installation</li>
                            </ul>
                        </div>
                    `;

                    // Step 5
                    let targetResistance = "";
                    switch(systemType) {
                        case "substation": targetResistance = "0.5-2 Ω"; break;
                        case "industrial": targetResistance = "1-5 Ω"; break;
                        case "commercial": targetResistance = "5-10 Ω"; break;
                        case "residential": targetResistance = "10-25 Ω"; break;
                        default: targetResistance = "1-5 Ω";
                    }
                    
                    document.getElementById('step5-content').innerHTML = `
                        <p><strong>System Type:</strong> <span class="step-value" style="color:var(--heading); font-size: 1.2rem;">${systemType.toUpperCase()}</span></p>
                        <p><strong>Target Resistance:</strong> <span class="step-value" style="color:var(--heading); font-size: 1.2rem;">${targetResistance}</span></p>
                        <p><strong>Your System Resistance:</strong> <span class="step-value" style="color:${totalEarthResistance <= 5 ? 'var(--success)' : 'var(--danger)'}; font-size: 1.2rem;">${format(totalEarthResistance, 3)} Ω</span></p>
                        <p><strong>Compliance Status:</strong> <span class="step-value" style="color:${totalEarthResistance <= 5 ? 'var(--success)' : 'var(--danger)'}; font-size: 1.2rem;">${totalEarthResistance <= 5 ? 'WITHIN TARGET' : 'ABOVE TARGET'}</span></p>
                    `;

                    // Step 6
                    document.getElementById('step6-content').innerHTML = `
                        <p><strong>Electrode Installation:</strong> Ensure proper depth and spacing</p>
                        <p><strong>Connection Method:</strong> Use exothermic welding or listed compression connectors</p>
                        <p><strong>Testing Protocol:</strong> Perform fall-of-potential testing after installation</p>
                        <p><strong>Documentation:</strong> Maintain as-built drawings and test records</p>
                        <p style="font-size: 0.9rem; margin-top: 10px;">Always consult local codes and standards for specific requirements.</p>
                    `;
                    
                    // 6. Update Results Table
                    resultsTbody.innerHTML = `
                        <tr><td>Soil Resistivity (ρ)</td><td>${format(soilResistivity, 2)} Ω·m</td></tr>
                        <tr><td>Earth Rod Length (L)</td><td>${format(rodLength, 2)} m</td></tr>
                        <tr><td>Earth Rod Diameter (d)</td><td>${format(rodDiameter, 2)} mm</td></tr>
                        <tr><td>Number of Parallel Rods (N)</td><td>${numberOfRods}</td></tr>
                        ${numberOfRods > 1 ? `<tr><td>Rod Spacing (S)</td><td>${format(rodSpacing, 2)} m</td></tr>` : ''}
                        <tr><td>Single Rod Resistance</td><td>${format(earthResistanceSingleRod, 3)} Ω</td></tr>
                        ${numberOfRods > 1 ? `<tr><td>Combining Factor (K)</td><td>${format(combiningFactorK, 3)}</td></tr>` : ''}
                        <tr><td><strong>Total Earth Resistance (R<sub>total</sub>)</strong></td><td class="highlight">${format(totalEarthResistance, 3)} Ω</td></tr>
                        <tr><td>Maximum Fault Current (I<sub>f</sub>)</td><td>${format(faultCurrent, 0)} A</td></tr>
                        <tr><td>Fault Duration (t<sub>f</sub>)</td><td>${format(faultDuration, 2)} s</td></tr>
                        <tr><td>Surface Layer Resistivity (ρ<sub>s</sub>)</td><td>${format(surfaceResistivity, 0)} Ω·m</td></tr>
                        <tr><td>Current Distribution Factor (C<sub>s</sub>)</td><td>${format(Cs, 3)}</td></tr>
                        <tr><td><strong>Ground Potential Rise (GPR)</strong></td><td class="highlight">${format(GPR, 2)} V</td></tr>
                        <tr><td>Permissible Touch Voltage</td><td>${format(E_touch_permissible, 2)} V</td></tr>
                        <tr><td>Permissible Step Voltage</td><td>${format(E_step_permissible, 2)} V</td></tr>
                        <tr><td><strong>Safety Assessment</strong></td><td><strong style="color: ${safetyStatus === 'SAFE' ? 'var(--success)' : 'var(--danger)'}">${safetyStatus}</strong></td></tr>
                    `;

                    // 7. Show sections
                    stepsContainer.classList.add('active');
                    resultsSection.classList.remove('hidden');
                    pdfBtn.style.display = 'inline-flex';

                    // 8. Scroll and notify
                    setTimeout(() => stepsContainer.scrollIntoView({ behavior: 'smooth' }), 100);
                    showMessage('Calculation complete! Professional specification below.');
                    
                    // 9. Re-render MathJax
                    if (window.MathJax && window.MathJax.typeset) {
                        window.MathJax.typeset();
                    }

                } catch (e) {
                    showMessage(e.message || 'Calculation error', 'error');
                    // Hide results on error
                    stepsContainer.classList.remove('active');
                    resultsSection.classList.add('hidden');
                    pdfBtn.style.display = 'none';
                }
            }

            function generatePDF() {
                try {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    let y = 15;

                    pdf.setFont('helvetica', 'bold');
                    pdf.setFontSize(16);
                    pdf.text('Grounding System Design Specification Report', 105, y, { align: 'center' });
                    y += 8;

                    pdf.setFont('helvetica', 'normal');
                    pdf.setFontSize(9);
                    pdf.text(`Generated by Design Calculators | ${new Date().toLocaleString()}`, 105, y, { align: 'center' });
                    y += 10;
                    
                    pdf.setFont('helvetica', 'bold');
                    pdf.setFontSize(12);
                    pdf.text('Calculation & Specification', 14, y);
                    y += 2;

                    const rows = Array.from(resultsTbody.querySelectorAll('tr')).map(tr => [
                        tr.cells[0].textContent,
                        tr.cells[1].textContent
                    ]);

                    pdf.autoTable({
                        startY: y,
                        head: [['Parameter', 'Specification / Value']],
                        body: rows,
                        margin: { left: 14, right: 14 },
                        theme: 'grid',
                        headStyles: { 
                            fillColor: [30, 58, 138], 
                            textColor: [255, 255, 255], 
                            fontSize: 10, 
                            fontStyle: 'bold' 
                        },
                        bodyStyles: { 
                            fontSize: 9,
                            cellPadding: 2.5,
                        },
                        alternateRowStyles: {
                            fillColor: [248, 250, 252]
                        },
                        didParseCell: function (data) {
                            if (data.row.index === 6 || data.row.index === 12 || data.row.index === 13) { // Highlight rows
                                data.cell.styles.fontStyle = 'bold';
                                data.cell.styles.textColor = [16, 185, 129];
                            }
                        }
                    });
                    
                    y = pdf.autoTable.previous.finalY + 15;

                    pdf.setFont('helvetica', 'bold');
                    pdf.setFontSize(10);
                    pdf.text('Disclaimer:', 14, y);
                    y += 5;
                    
                    pdf.setFont('helvetica', 'normal');
                    pdf.setFontSize(8);
                    const disclaimer = document.querySelector('.footer-disclaimer p').textContent;
                    const splitDisclaimer = pdf.splitTextToSize(disclaimer, 182); // 210mm - 14 - 14
                    pdf.text(splitDisclaimer, 14, y);
                    
                    pdf.save('Grounding-System-Design-Report.pdf');
                    showMessage('PDF downloaded successfully');
                } catch(e) {
                    showMessage('Error generating PDF: ' + e.message, 'error');
                }
            }
            
            // Re-render MathJax on load if needed
            if (window.MathJax && window.MathJax.typeset) {
                window.MathJax.typeset();
            }
        });
    </script>
</body>
</html>
