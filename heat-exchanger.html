<!DOCTYPE html>
<html lang="en">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-23Y1V450SR"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-23Y1V450SR');
</script>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5936527763614780"
     crossorigin="anonymous"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Heat Exchanger Design - Design Calculators - Mechanical</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- MathJax for LaTeX rendering -->
    <script type="text/javascript" id="MathJax-script" async
            src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
    </script>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="icon" href="/favicon.ico" type="image/x-icon">

    <script>
        MathJax = {
            tex: {
                inlineMath: [['\\(', '\\)']],
                displayMath: [['\\[', '\\]']],
                processEscapes: true
            }
        };
    </script>
    <style>
        /* General styles, color variables, and responsive design based on the provided file */
        :root {
            --primary-color: #2196F3;
            --secondary-color: #1976D2;
            --accent-color: #FFC107;
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --text-color: #333333;
            --header-bg: #2C3E50;
            --footer-bg: #34495E;
            --border-color: #cccccc;
            --card-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
            --hover-color: #e2e6ea;
            --primary-color-rgb: 33, 150, 243;
        }
        body.dark-mode {
            --primary-color: #5DADE2;
            --secondary-color: #2874A6;
            --bg-color: #252D3A;
            --card-bg: #2F3C4C;
            --text-color: #E0E6EB;
            --header-bg: #252D3A;
            --footer-bg: #252D3A;
            --border-color: #4C5C70;
            --card-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
            --hover-color: #3A475C;
            --primary-color-rgb: 93, 173, 226;
        }
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            background-image: radial-gradient(circle at center, var(--bg-color) 0%, rgba(244, 247, 246, 0.8) 100%);
            color: var(--text-color);
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s, background-image 0.3s;
        }
        .container {
            max-width: 960px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            background-color: var(--header-bg);
            color: white;
            padding: 25px 0;
            text-align: center;
            box-shadow: var(--card-shadow);
            position: relative;
        }
        header h1 {
            margin: 0;
            font-size: 2.8em;
            color: var(--primary-color);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }
        header .subtitle {
            margin: 8px 0 0;
            font-size: 1.1em;
            color: #bdc3c7;
        }
        main {
            padding: 30px 0;
        }
        .tool-container {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 30px;
            box-shadow: var(--card-shadow);
            margin-bottom: 25px;
            transition: transform 0.3s ease-in-out;
        }
        .tool-container:hover {
            transform: translateY(-5px);
        }
        .tool-container h2 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 12px;
            margin-top: 0;
            margin-bottom: 25px;
            font-size: 2em;
        }
        .tool-description {
            margin-bottom: 25px;
            color: var(--text-color);
            font-size: 1.05em;
        }
        .tool-description ul {
            list-style-type: disc;
            margin-left: 25px;
            padding-left: 0;
            margin-top: 15px;
        }
        .tool-description ul li {
            margin-bottom: 8px;
        }
        .tool-description strong {
            color: var(--primary-color);
        }
        .back-button {
            display: inline-block;
            background-color: var(--primary-color);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            text-decoration: none;
            margin-bottom: 25px;
            transition: background-color 0.3s, transform 0.2s ease-in-out;
            font-weight: bold;
        }
        .back-button:hover {
            background-color: var(--secondary-color);
            transform: scale(1.03);
        }
        .theme-toggle {
            position: absolute;
            top: 25px;
            right: 25px;
            display: flex;
            align-items: center;
        }
        .theme-toggle .light-icon,
        .theme-toggle .dark-icon {
            color: white;
            margin: 0 8px;
            font-size: 1.3em;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 65px;
            height: 38px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 30px;
            width: 30px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
        }
        input:checked + .slider {
            background-color: var(--primary-color);
        }
        input:focus + .slider {
            box-shadow: 0 0 1px var(--primary-color);
        }
        input:checked + .slider:before {
            transform: translateX(27px);
        }
        .slider.round {
            border-radius: 38px;
        }
        .slider.round:before {
            border-radius: 50%;
        }
        footer {
            background-color: var(--footer-bg);
            color: white;
            padding: 25px 0;
            text-align: center;
            box-shadow: 0 -3px 10px rgba(0, 0, 0, 0.2);
            margin-top: 40px;
        }
        footer .disclaimer h3,
        footer .social-share h3 {
            color: var(--primary-color);
            margin-bottom: 12px;
            font-size: 1.3em;
        }
        footer .disclaimer p {
            font-size: 0.95em;
            color: #bdc3c7;
        }
        .social-buttons {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        .social-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            color: white;
            text-decoration: none;
            font-size: 1.4em;
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .social-btn:hover {
            transform: translateY(-5px) scale(1.1);
            box-shadow: 0 8px 15px rgba(0,0,0,0.3);
        }
        .social-btn.linkedin { background-color: #0A66C2; }
        .social-btn.facebook { background-color: #1877F2; }
        .social-btn.twitter { background-color: #1DA1F2; }
        .social-btn.whatsapp { background-color: #25D366; }
        .social-btn.reddit { background-color: #FF4500; }
        .social-btn.email { background-color: #7f8c8d; }
        .calculator-form {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 30px;
            margin-top: 25px;
            box-shadow: var(--card-shadow);
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            font-size: 1.05em;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--bg-color);
            color: var(--text-color);
            box-sizing: border-box;
            font-size: 1em;
            transition: border-color 0.3s, box-shadow 0.3s;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.08);
        }
        .form-group input:focus, .form-group select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(var(--primary-color-rgb), 0.3);
            outline: none;
        }
        .form-row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        .form-row .form-group {
            flex: 1 1 calc(50% - 10px);
            min-width: 280px;
        }
        @media (max-width: 600px) {
            .form-row .form-group {
                flex: 1 1 100%;
            }
        }
        .calculate-btn {
            background-image: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 18px 25px; /* Increased padding for taller button */
            border-radius: 8px;
            cursor: pointer;
            font-size: 17px;
            font-weight: bold;
            margin-top: 20px;
            transition: background-image 0.3s ease-in-out, transform 0.2s ease-in-out, box-shadow 0.3s ease-in-out;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .calculate-btn:hover {
            background-image: linear-gradient(to right, var(--secondary-color), var(--primary-color));
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }
        .result-container {
            margin-top: 40px;
            padding: 30px;
            border-radius: 12px;
            background-color: var(--card-bg);
            box-shadow: var(--card-shadow);
            display: block;
            opacity: 0;
            transition: opacity 0.6s ease-out;
            pointer-events: none;
        }
        .result-container.show {
            opacity: 1;
            pointer-events: auto;
        }
        .result-container h3 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 1.8em;
        }
        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .result-table th, .result-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        .result-table th {
            background-color: var(--hover-color);
            font-weight: bold;
            font-size: 1.1em;
        }
        .result-table tr:last-child td {
            border-bottom: none;
        }
        .standard-reference {
            margin-top: 25px;
            font-style: italic;
            font-size: 0.95rem;
            line-height: 1.5;
            padding: 10px;
            background-color: var(--bg-color);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        .info-icon {
            color: var(--primary-color);
            margin-left: 8px;
            cursor: help;
            font-size: 1em;
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 220px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -110px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.85em;
        }
        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        #custom-message-box {
            position: fixed;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            padding: 18px 30px;
            border-radius: 10px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.3);
            z-index: 1000;
            font-weight: bold;
            color: white;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            font-size: 1.1em;
        }
        #calculation-details {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
            font-size: 0.98em;
        }
        #calculation-details h4 {
            color: var(--secondary-color);
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        #calculation-details p.formula {
            font-family: 'Times New Roman', serif;
            font-style: italic;
            font-size: 1.2em;
            text-align: center;
            padding: 12px 0;
            background-color: var(--hover-color);
            border-radius: 6px;
            margin: 15px 0;
            overflow-x: auto;
            border: 1px dashed var(--border-color);
        }
        #calculation-details p.calculation-step {
            font-family: 'Courier New', monospace;
            background-color: var(--hover-color);
            padding: 8px 12px;
            border-radius: 5px;
            margin-bottom: 8px;
            font-size: 0.95em;
        }
        #calculation-details ul {
            list-style-type: disc;
            margin-left: 25px;
            padding-left: 0;
        }
        #calculation-details ul li {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>Design Calculators - Mechanical</h1>
            <p class="subtitle">Smart Tools for Modern Mechanical Engineers</p>
            <div class="theme-toggle">
                <span class="light-icon"><i class="fas fa-sun"></i></span>
                <label class="switch">
                    <input type="checkbox" id="theme-switch">
                    <span class="slider round"></span>
                </label>
                <span class="dark-icon"><i class="fas fa-moon"></i></span>
            </div>
        </div>
    </header>
    <main class="container">
        <!-- Back button, if needed, can be linked to an index.html or similar -->
            <a href="indexMech.html" class="back-button">
                <i class="fas fa-arrow-left"></i> Back to Tools
            </a>

        <div class="tool-container">
            <h2>Heat Exchanger Design Calculator</h2>
            <div class="tool-description">
                <p>This calculator assists in the design and analysis of heat exchangers using two fundamental methods:</p>
                <ul>
                    <li><strong>Log Mean Temperature Difference (LMTD) Method:</strong> Suitable for known inlet and outlet temperatures of both fluids and helps determine the required heat transfer area.</li>
                    <li><strong>Effectiveness-Number of Transfer Units (Effectiveness-NTU) Method:</strong> Ideal when only inlet temperatures are known and the heat exchanger performance (effectiveness) or size (NTU) needs to be evaluated.</li>
                </ul>
                <p>Choose the appropriate method and unit system, input your fluid and heat exchanger parameters, and let the tool calculate the key design values.</p>
            </div>

            <div class="calculator-form">
                <form id="heat-exchanger-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="calculation-method">Calculation Method: <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Choose between LMTD method (for known outlet temperatures) or Effectiveness-NTU method (for unknown outlet temperatures).</span></span></label>
                            <select id="calculation-method" required>
                                <option value="lmtd">LMTD Method</option>
                                <option value="ntu">Effectiveness-NTU Method</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="unit-system">Unit System: <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Select Metric (e.g., kW, kg/s, °C) or Imperial (e.g., BTU/h, lb/s, °F) units.</span></span></label>
                            <select id="unit-system" required>
                                <option value="metric">Metric (kW, kg/s, °C)</option>
                                <option value="imperial">Imperial (BTU/h, lb/s, °F)</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="hx-type">Heat Exchanger Type: <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Select the type of heat exchanger for specific LMTD correction factor (F) or Effectiveness-NTU correlations.</span></span></label>
                        <select id="hx-type" required>
                            <option value="parallel">Parallel Flow</option>
                            <option value="counter">Counter Flow</option>
                            <option value="shell-1-2">Shell and Tube (1 shell pass, 2 tube passes)</option>
                            <option value="shell-1-multi">Shell and Tube (1 shell pass, 4, 6, ... tube passes)</option>
                            <option value="cross-unmixed">Cross Flow (one fluid unmixed, one mixed)</option>
                            <option value="cross-mixed">Cross Flow (both fluids mixed)</option>
                        </select>
                    </div>

                    <h3>Hot Fluid Parameters</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="m_h">Mass Flow Rate (\( \dot{m}_h \)): <span class="mass-flow-unit-label">(kg/s)</span> <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Mass flow rate of the hot fluid.</span></span></label>
                            <input type="number" id="m_h" step="0.01" value="0.5" required>
                        </div>
                        <div class="form-group">
                            <label for="cp_h">Specific Heat Capacity (\( C_{p,h} \)): <span class="cp-unit-label">(kJ/kg°C)</span> <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Specific heat capacity of the hot fluid.</span></span></label>
                            <input type="number" id="cp_h" step="0.01" value="4.18" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="T_h_in">Inlet Temperature (\( T_{h,in} \)): <span class="temp-unit-label">(°C)</span> <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Inlet temperature of the hot fluid.</span></span></label>
                            <input type="number" id="T_h_in" step="0.1" value="90" required>
                        </div>
                        <div class="form-group" id="T_h_out_group">
                            <label for="T_h_out">Outlet Temperature (\( T_{h,out} \)): <span class="temp-unit-label">(°C)</span> <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Outlet temperature of the hot fluid (required for LMTD, optional for NTU).</span></span></label>
                            <input type="number" id="T_h_out" step="0.1" value="50">
                        </div>
                    </div>

                    <h3>Cold Fluid Parameters</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="m_c">Mass Flow Rate (\( \dot{m}_c \)): <span class="mass-flow-unit-label">(kg/s)</span> <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Mass flow rate of the cold fluid.</span></span></label>
                            <input type="number" id="m_c" step="0.01" value="0.4" required>
                        </div>
                        <div class="form-group">
                            <label for="cp_c">Specific Heat Capacity (\( C_{p,c} \)): <span class="cp-unit-label">(kJ/kg°C)</span> <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Specific heat capacity of the cold fluid.</span></span></label>
                            <input type="number" id="cp_c" step="0.01" value="4.18" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="T_c_in">Inlet Temperature (\( T_{c,in} \)): <span class="temp-unit-label">(°C)</span> <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Inlet temperature of the cold fluid.</span></span></label>
                            <input type="number" id="T_c_in" step="0.1" value="20" required>
                        </div>
                        <div class="form-group" id="T_c_out_group">
                            <label for="T_c_out">Outlet Temperature (\( T_{c,out} \)): <span class="temp-unit-label">(°C)</span> <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Outlet temperature of the cold fluid (required for LMTD, optional for NTU).</span></span></label>
                            <input type="number" id="T_c_out" step="0.1" value="40"> <!-- Changed default from 60 to 40 for parallel flow to avoid negative dT2 -->
                        </div>
                    </div>

                    <h3>Overall Heat Transfer Coefficient & Area (for LMTD Method)</h3>
                    <div class="form-row lmtd-only">
                        <div class="form-group">
                            <label for="U_overall">Overall Heat Transfer Coefficient (\( U \)): <span class="U-unit-label">(kW/m²°C)</span> <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Overall heat transfer coefficient.</span></span></label>
                            <input type="number" id="U_overall" step="0.1" value="0.8">
                        </div>
                        <div class="form-group" id="area-group">
                            <label for="area">Heat Transfer Area (\( A \)): <span class="area-unit-label">(m²)</span> <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Heat transfer surface area.</span></span></label>
                            <input type="number" id="area" step="0.01" value="">
                        </div>
                    </div>

                    <h3>NTU Parameter (for Effectiveness-NTU Method)</h3>
                    <div class="form-row ntu-only">
                        <div class="form-group">
                            <label for="NTU">Number of Transfer Units (NTU): <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Dimensionless parameter for heat exchanger size (required for Effectiveness-NTU if Area is unknown).</span></span></label>
                            <input type="number" id="NTU_input" step="0.01" value="">
                        </div>
                        <div class="form-group">
                            <label for="U_overall_ntu">Overall Heat Transfer Coefficient (\( U \)): <span class="U-unit-label">(kW/m²°C)</span> <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Overall heat transfer coefficient (required for NTU if Area is to be calculated).</span></span></label>
                            <input type="number" id="U_overall_ntu" step="0.1" value="0.8">
                        </div>
                    </div>

                    <button type="button" id="calculate-hx-btn" class="calculate-btn">Calculate Heat Exchanger</button>
                </form>
            </div>

            <div id="result-container" class="result-container">
                <h3>Calculation Results</h3>
                <div id="calculation-details"></div>
                <table class="result-table">
                    <thead>
                        <tr>
                            <th>Parameter</th>
                            <th>Value</th>
                        </tr>
                    </thead>
                    <tbody id="result-table-body"></tbody>
                </table>
                <div class="standard-reference" id="standard-reference"></div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <div class="disclaimer">
                <h3>Disclaimer</h3>
                <p>To ensure accuracy and reliability, always verify the results obtained from these tools against the relevant engineering standards and guidelines.</p>
            </div>
            <div class="credit">
                <p>Created by A Sharma</p>
            </div>
            <div class="social-share">
                <h3>Share This Site</h3>
                <div class="social-buttons">
                    <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://designcalculators.co.in&title=Design Calculators - Mechanical" target="_blank" class="social-btn linkedin">
                        <i class="fab fa-linkedin"></i>
                    </a>
                    <a href="https://www.facebook.com/sharer/sharer.php?u=https://designcalculators.co.in" target="_blank" class="social-btn facebook">
                        <i class="fab fa-facebook"></i>
                    </a>
                    <a href="https://twitter.com/intent/tweet?text=Check out this amazing Design Calculators - Mechanical!&url=https://designcalculators.co.in" target="_blank" class="social-btn twitter">
                        <i class="fab fa-twitter"></i>
                    </a>
                    <a href="https://api.whatsapp.com/send?text=Check out this amazing Design Calculators - Mechanical! https://designcalculators.co.in" target="_blank" class="social-btn whatsapp">
                        <i class="fab fa-whatsapp"></i>
                    </a>
                    <a href="https://www.reddit.com/submit?url=https://designcalculators.co.in&title=Design Calculators - Mechanical" target="_blank" class="social-btn reddit">
                        <i class="fab fa-reddit"></i>
                    </a>
                    <a href="mailto:?subject=Check out Design Calculators - Mechanical!&body=I found this amazing Heat Exchanger Design Calculator and other mechanical tools: https://designcalculators.co.in" class="social-btn email">
                        <i class="fas fa-envelope"></i>
                    </a>
                </div>
            </div>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const calculateBtn = document.getElementById('calculate-hx-btn');
            const resultContainer = document.getElementById('result-container');
            const resultTableBody = document.getElementById('result-table-body');
            const standardReference = document.getElementById('standard-reference');
            const calculationDetailsDiv = document.getElementById('calculation-details');

            // Input elements
            const calculationMethodSelect = document.getElementById('calculation-method');
            const unitSystemSelect = document.getElementById('unit-system');
            const hxTypeSelect = document.getElementById('hx-type');

            const m_h_input = document.getElementById('m_h');
            const cp_h_input = document.getElementById('cp_h');
            const T_h_in_input = document.getElementById('T_h_in');
            const T_h_out_input = document.getElementById('T_h_out');
            const T_h_out_group = document.getElementById('T_h_out_group');

            const m_c_input = document.getElementById('m_c');
            const cp_c_input = document.getElementById('cp_c');
            const T_c_in_input = document.getElementById('T_c_in');
            const T_c_out_input = document.getElementById('T_c_out');
            const T_c_out_group = document.getElementById('T_c_out_group');

            const U_overall_input = document.getElementById('U_overall'); // For LMTD
            const area_input = document.getElementById('area'); // For LMTD (output)
            const lmtdOnlyDivs = document.querySelectorAll('.lmtd-only');

            const NTU_input_field = document.getElementById('NTU_input'); // For NTU
            const U_overall_ntu_input = document.getElementById('U_overall_ntu'); // For NTU (U input)
            const ntuOnlyDivs = document.querySelectorAll('.ntu-only');

            // Unit Labels
            const massFlowUnitLabels = document.querySelectorAll('.mass-flow-unit-label');
            const cpUnitLabels = document.querySelectorAll('.cp-unit-label');
            const tempUnitLabels = document.querySelectorAll('.temp-unit-label');
            const UUnitLabels = document.querySelectorAll('.U-unit-label');
            const areaUnitLabels = document.querySelectorAll('.area-unit-label');

            const themeSwitch = document.getElementById('theme-switch');

            /**
             * Displays a custom message box at the top of the screen.
             * @param {string} message - The message to display.
             * @param {string} type - The type of message ('info', 'error', 'warning').
             */
            function displayMessage(message, type = "info") {
                let messageBox = document.getElementById('custom-message-box');
                if (!messageBox) {
                    messageBox = document.createElement('div');
                    messageBox.id = 'custom-message-box';
                    document.body.appendChild(messageBox);
                }
                messageBox.textContent = message;
                if (type === "error") {
                    messageBox.style.backgroundColor = '#dc3545';
                    messageBox.style.color = 'white';
                } else if (type === "warning") {
                    messageBox.style.backgroundColor = '#ffc107';
                    messageBox.style.color = '#333';
                } else {
                    messageBox.style.backgroundColor = '#28a745';
                    messageBox.style.color = 'white';
                }
                messageBox.style.opacity = 1;
                setTimeout(() => {
                    messageBox.style.opacity = 0;
                }, 5000);
            }

            /**
             * Updates the visibility of input fields and unit labels based on the selected calculation method and unit system.
             */
            function updateUI() {
                const method = calculationMethodSelect.value;
                const unitSystem = unitSystemSelect.value;

                // Update unit labels
                if (unitSystem === 'imperial') {
                    massFlowUnitLabels.forEach(label => label.innerHTML = '(lb/s)');
                    cpUnitLabels.forEach(label => label.innerHTML = '(BTU/lb°F)');
                    tempUnitLabels.forEach(label => label.innerHTML = '(°F)');
                    UUnitLabels.forEach(label => label.innerHTML = '(BTU/h ft²°F)');
                    areaUnitLabels.forEach(label => label.innerHTML = '(ft²)');

                    // Adjust default values for Imperial
                    if (m_h_input.value === "0.5") m_h_input.value = "1.1"; // Approx 0.5 kg/s
                    if (cp_h_input.value === "4.18") cp_h_input.value = "1"; // Approx for water
                    if (T_h_in_input.value === "90") T_h_in_input.value = "194"; // 90C to F
                    if (T_h_out_input.value === "50") T_h_out_input.value = "122"; // 50C to F
                    if (m_c_input.value === "0.4") m_c_input.value = "0.88"; // Approx 0.4 kg/s
                    if (cp_c_input.value === "4.18") cp_c_input.value = "1";
                    if (T_c_in_input.value === "20") T_c_in_input.value = "68"; // 20C to F
                    if (T_c_out_input.value === "40") T_c_out_input.value = "104"; // 40C to F (updated default)
                    if (U_overall_input.value === "0.8") U_overall_input.value = "140"; // Approx 0.8 kW/m2C to BTU/h ft2F
                    if (U_overall_ntu_input.value === "0.8") U_overall_ntu_input.value = "140";

                } else { // Metric
                    massFlowUnitLabels.forEach(label => label.innerHTML = '(kg/s)');
                    cpUnitLabels.forEach(label => label.innerHTML = '(kJ/kg°C)');
                    tempUnitLabels.forEach(label => label.innerHTML = '(°C)');
                    UUnitLabels.forEach(label => label.innerHTML = '(kW/m²°C)');
                    areaUnitLabels.forEach(label => label.innerHTML = '(m²)');

                    // Adjust default values back to Metric
                    if (m_h_input.value === "1.1") m_h_input.value = "0.5";
                    if (cp_h_input.value === "1") cp_h_input.value = "4.18";
                    if (T_h_in_input.value === "194") T_h_in_input.value = "90";
                    if (T_h_out_input.value === "122") T_h_out_input.value = "50";
                    if (m_c_input.value === "0.88") m_c_input.value = "0.4";
                    if (cp_c_input.value === "1") cp_c_input.value = "4.18";
                    if (T_c_in_input.value === "68") T_c_in_input.value = "20";
                    if (T_c_out_input.value === "104") T_c_out_input.value = "40"; // Updated default
                    if (U_overall_input.value === "140") U_overall_input.value = "0.8";
                    if (U_overall_ntu_input.value === "140") U_overall_ntu_input.value = "0.8";
                }

                // Show/hide groups based on method
                if (method === 'lmtd') {
                    lmtdOnlyDivs.forEach(div => div.style.display = 'flex');
                    ntuOnlyDivs.forEach(div => div.style.display = 'none');
                    T_h_out_group.style.display = 'block'; // Outlet temps required for LMTD
                    T_c_out_group.style.display = 'block'; // Outlet temps required for LMTD
                    U_overall_input.required = true;
                    area_input.required = false; // Area is output for LMTD

                    // Clear NTU specific inputs
                    NTU_input_field.value = '';
                    U_overall_ntu_input.value = '0.8'; // Reset U for NTU method
                } else { // NTU method
                    lmtdOnlyDivs.forEach(div => div.style.display = 'none');
                    ntuOnlyDivs.forEach(div => div.style.display = 'flex');
                    T_h_out_group.style.display = 'block'; // T_h_out and T_c_out are initially visible as they might be needed for C_min/C_max or as outputs
                    T_c_out_group.style.display = 'block';
                    U_overall_input.required = false; // U for LMTD is not needed
                    area_input.required = false; // Area for LMTD is not needed

                    // Clear LMTD specific inputs
                    U_overall_input.value = '0.8'; // Reset U for LMTD
                    area_input.value = '';
                }

                // If NTU method is selected, and NTU input is empty, make U_overall_ntu and Area required (to calculate NTU)
                // If NTU input has a value, U_overall_ntu and Area are optional (to calculate Q)
                const isNTUInputProvided = NTU_input_field.value !== '';
                if (method === 'ntu') {
                    if (isNTUInputProvided) {
                        U_overall_ntu_input.required = false;
                        // If NTU is provided, Area is also not required as it can be calculated or is not needed for Q_max * epsilon
                    } else {
                        U_overall_ntu_input.required = true;
                        // When NTU is not provided, U and A are needed to calculate it.
                        // However, the current UI doesn't have an 'Area' input for NTU directly,
                        // it's implied that if U is given, A is the output.
                        // Let's assume if NTU is empty, then U_overall_ntu must be provided.
                    }
                }
            }

            // Event Listeners for UI updates
            calculationMethodSelect.addEventListener('change', updateUI);
            unitSystemSelect.addEventListener('change', updateUI);

            // Initial UI update on load
            updateUI();


            /**
             * Helper function to parse float values from input fields.
             * @param {HTMLElement} inputElement - The input element to parse.
             * @param {string} paramName - The name of the parameter for error messages.
             * @returns {number|null} Parsed float value or null if invalid.
             */
            function getFloatValue(inputElement, paramName) {
                const value = parseFloat(inputElement.value);
                if (isNaN(value)) {
                    displayMessage(`Please enter a valid number for ${paramName}.`, "error");
                    return null;
                }
                return value;
            }

            /**
             * Converts temperature from Celsius to Fahrenheit.
             * @param {number} C - Temperature in Celsius.
             * @returns {number} Temperature in Fahrenheit.
             */
            function CtoF(C) {
                return (C * 9/5) + 32;
            }

            /**
             * Converts temperature from Fahrenheit to Celsius.
             * @param {number} F - Temperature in Fahrenheit.
             * @returns {number} Temperature in Celsius.
             */
            function FtoC(F) {
                return (F - 32) * 5/9;
            }

            /**
             * Converts specific heat capacity from kJ/kg°C to BTU/lb°F.
             * @param {number} Cp_kJ_kgC - Specific heat capacity in kJ/kg°C.
             * @returns {number} Specific heat capacity in BTU/lb°F.
             */
            function Cp_kJ_kgC_to_BTU_lbF(Cp_kJ_kgC) {
                return Cp_kJ_kgC * 0.238846; // 1 kJ/kg°C = 0.238846 BTU/lb°F
            }

            /**
             * Converts specific heat capacity from BTU/lb°F to kJ/kg°C.
             * @param {number} Cp_BTU_lbF - Specific heat capacity in BTU/lb°F.
             * @returns {number} Specific heat capacity in kJ/kg°C.
             */
            function Cp_BTU_lbF_to_kJ_kgC(Cp_BTU_lbF) {
                return Cp_BTU_lbF / 0.238846;
            }

            /**
             * Converts mass flow rate from kg/s to lb/s.
             * @param {number} m_kg_s - Mass flow rate in kg/s.
             * @returns {number} Mass flow rate in lb/s.
             */
            function m_kg_s_to_lb_s(m_kg_s) {
                return m_kg_s * 2.20462; // 1 kg/s = 2.20462 lb/s
            }

            /**
             * Converts mass flow rate from lb/s to kg/s.
             * @param {number} m_lb_s - Mass flow rate in lb/s.
             * @returns {number} Mass flow rate in kg/s.
             */
            function m_lb_s_to_kg_s(m_lb_s) {
                return m_lb_s / 2.20462;
            }

            /**
             * Converts overall heat transfer coefficient from kW/m²°C to BTU/h ft²°F.
             * @param {number} U_kW_m2C - U in kW/m²°C.
             * @returns {number} U in BTU/h ft²°F.
             */
            function U_kW_m2C_to_BTU_h_ft2F(U_kW_m2C) {
                return U_kW_m2C * 176.11; // 1 kW/m²°C = 176.11 BTU/h ft²°F
            }

            /**
             * Converts overall heat transfer coefficient from BTU/h ft²°F to kW/m²°C.
             * @param {number} U_BTU_h_ft2F - U in BTU/h ft²°F.
             * @returns {number} U in kW/m²°C.
             */
            function U_BTU_h_ft2F_to_kW_m2C(U_BTU_h_ft2F) {
                return U_BTU_h_ft2F / 176.11;
            }

            /**
             * Calculates the Log Mean Temperature Difference (LMTD).
             * @param {number} dT1 - Temperature difference at one end.
             * @param {number} dT2 - Temperature difference at the other end.
             * @returns {number} LMTD value.
             */
            function calculateLMTD(dT1, dT2) {
                if (dT1 === dT2) return dT1;
                if (dT1 <= 0 || dT2 <= 0) {
                     displayMessage("Invalid temperature differences for LMTD calculation (must be positive).", "error");
                     return NaN;
                }
                return (dT1 - dT2) / Math.log(dT1 / dT2);
            }

            /**
             * Calculates the correction factor F for LMTD based on heat exchanger type.
             * This function uses simplified correlations or assumes F=1 for basic cases.
             * For complex shell-and-tube or cross-flow configurations, P and R values
             * (and potentially charts/iterative solutions) are needed, which are beyond
             * a simple analytical function. We'll provide placeholders/approximations.
             *
             * @param {string} hxType - Type of heat exchanger.
             * @param {number} R - Heat capacity rate ratio (C_min / C_max).
             * @param {number} P - Temperature effectiveness parameter.
             * @returns {number} LMTD correction factor F.
             */
            function calculateF(hxType, R, P) {
                // For parallel and counter flow, F is typically 1 (ideal cases)
                if (hxType === 'parallel' || hxType === 'counter') {
                    return 1.0;
                }

                // Simplified approximations for shell and tube / cross flow.
                // In a real application, you'd need empirical correlations or charts for F,
                // which often depend on R and P.
                // Here, we'll return a value less than 1 to signify non-ideality.
                // These are NOT precise, just illustrative.
                if (hxType === 'shell-1-2') {
                    // For 1 shell pass, 2 or more tube passes, F can be estimated with complex formulas
                    // A very simplified approach for demonstration:
                    if (R === 0) return 1; // Isothermal fluid
                    const X = (1 - P * R) / (1 - P);
                    // This is a highly simplified F factor, for a proper calculation,
                    // one would need to implement the exact equations for specific configurations
                    // or look up from charts (e.g., from Incropera, Cengel).
                    // For now, let's just make it a fixed value less than 1 if R > 0.
                    return 0.9; // Placeholder
                }
                if (hxType === 'shell-1-multi') {
                    return 0.85; // Placeholder
                }
                if (hxType === 'cross-unmixed') {
                    return 0.95; // Placeholder
                }
                if (hxType === 'cross-mixed') {
                    return 0.8; // Placeholder
                }
                return 1.0; // Default or fallback
            }


            /**
             * Calculates the effectiveness (epsilon) for various heat exchanger types.
             * @param {string} hxType - Type of heat exchanger.
             * @param {number} NTU - Number of Transfer Units.
             * @param {number} C_r - Heat capacity rate ratio (C_min / C_max).
             * @returns {number} Heat exchanger effectiveness.
             */
            function calculateEffectiveness(hxType, NTU, C_r) {
                // If NTU is 0, effectiveness is 0 (no heat transfer)
                if (NTU === 0) {
                    return 0;
                }

                let epsilon;
                if (hxType === 'parallel') {
                    epsilon = (1 - Math.exp(-NTU * (1 + C_r))) / (1 + C_r);
                } else if (hxType === 'counter') {
                    if (C_r === 1) {
                        epsilon = NTU / (1 + NTU);
                    } else {
                        epsilon = (1 - Math.exp(-NTU * (1 - C_r))) / (1 - C_r * Math.exp(-NTU * (1 - C_r)));
                    }
                } else if (hxType === 'shell-1-2' || hxType === 'shell-1-multi') {
                    // For 1 shell pass, 2 or more tube passes (common formula for shell-and-tube)
                    const beta = Math.sqrt(1 + C_r * C_r);
                    const exp_term = Math.exp(-NTU * beta);
                    epsilon = 2 / ((1 + C_r + beta) * (1 + exp_term) / (1 - exp_term) + (1 + C_r - beta));

                } else if (hxType === 'cross-unmixed') {
                    // One fluid unmixed, one mixed
                    if (C_r === 0) { // isothermal
                         epsilon = 1 - Math.exp(-NTU);
                    } else {
                         epsilon = 1 - Math.exp(- (1 - Math.exp(-C_r * NTU)) / C_r );
                    }
                } else if (hxType === 'cross-mixed') {
                    // Both fluids mixed - simplified approximation for demo purposes
                    epsilon = 0.8 * (1 - Math.exp(-NTU * (1 + C_r))) / (1 + C_r);
                } else {
                    epsilon = 0; // Unknown type, return 0
                }

                // Clamp epsilon between 0 and 1
                return Math.max(0, Math.min(1, epsilon));
            }


            calculateBtn.addEventListener('click', function() {
                // Clear previous results
                resultTableBody.innerHTML = '';
                calculationDetailsDiv.innerHTML = '';
                resultContainer.classList.remove('show');
                standardReference.innerHTML = '';

                const method = calculationMethodSelect.value;
                const unitSystem = unitSystemSelect.value;
                const hxType = hxTypeSelect.value;

                // Parse input values
                let m_h = getFloatValue(m_h_input, 'Hot Fluid Mass Flow Rate');
                let cp_h = getFloatValue(cp_h_input, 'Hot Fluid Specific Heat Capacity');
                let T_h_in = getFloatValue(T_h_in_input, 'Hot Fluid Inlet Temperature');
                let T_h_out = getFloatValue(T_h_out_input, 'Hot Fluid Outlet Temperature');

                let m_c = getFloatValue(m_c_input, 'Cold Fluid Mass Flow Rate');
                let cp_c = getFloatValue(cp_c_input, 'Cold Fluid Specific Heat Capacity');
                let T_c_in = getFloatValue(T_c_in_input, 'Cold Fluid Inlet Temperature');
                let T_c_out = getFloatValue(T_c_out_input, 'Cold Fluid Outlet Temperature');

                let U_overall = getFloatValue(U_overall_input, 'Overall Heat Transfer Coefficient');
                let area = getFloatValue(area_input, 'Heat Transfer Area');

                let NTU_val_input = getFloatValue(NTU_input_field, 'NTU'); // User provided NTU
                let U_overall_ntu = getFloatValue(U_overall_ntu_input, 'Overall Heat Transfer Coefficient (NTU)'); // U for NTU method

                // Input validation
                if (m_h === null || cp_h === null || T_h_in === null ||
                    m_c === null || cp_c === null || T_c_in === null) {
                    return; // Error message already displayed by getFloatValue
                }

                // Convert all inputs to SI (Metric) for internal calculations
                let m_h_SI = m_h, cp_h_SI = cp_h, T_h_in_SI = T_h_in, T_h_out_SI = T_h_out;
                let m_c_SI = m_c, cp_c_SI = cp_c, T_c_in_SI = T_c_in, T_c_out_SI = T_c_out;
                let U_overall_SI = U_overall;
                let U_overall_ntu_SI = U_overall_ntu;
                let area_SI = area;

                let Q_max_unit = "kW";
                let Q_actual_unit = "kW";
                let LMTD_unit = "°C";
                let U_unit = "kW/m²°C";
                let Area_unit = "m²";

                if (unitSystem === 'imperial') {
                    displayMessage("Imperial units are converted to metric for calculations. Results will be converted back.", "info");

                    T_h_in_SI = FtoC(T_h_in);
                    T_h_out_SI = FtoC(T_h_out);
                    T_c_in_SI = FtoC(T_c_in);
                    T_c_out_SI = FtoC(T_c_out);

                    m_h_SI = m_lb_s_to_kg_s(m_h);
                    cp_h_SI = Cp_BTU_lbF_to_kJ_kgC(cp_h);
                    m_c_SI = m_lb_s_to_kg_s(m_c);
                    cp_c_SI = Cp_BTU_lbF_to_kJ_kgC(cp_c);

                    U_overall_SI = U_BTU_h_ft2F_to_kW_m2C(U_overall);
                    U_overall_ntu_SI = U_BTU_h_ft2F_to_kW_m2C(U_overall_ntu);

                    Q_max_unit = "BTU/h";
                    Q_actual_unit = "BTU/h";
                    LMTD_unit = "°F";
                    U_unit = "BTU/h ft²°F";
                    Area_unit = "ft²";
                }

                let calculationHtml = '<h4>Detailed Calculation Steps:</h4>';
                let results = [];

                // Common calculations
                const C_h_SI = m_h_SI * cp_h_SI; // Hot fluid heat capacity rate in kW/°C
                const C_c_SI = m_c_SI * cp_c_SI; // Cold fluid heat capacity rate in kW/°C
                const C_min_SI = Math.min(C_h_SI, C_c_SI);
                const C_max_SI = Math.max(C_h_SI, C_c_SI);
                const C_r_SI = C_min_SI / C_max_SI;

                calculationHtml += `<p><strong>1. Input Parameters:</strong></p>`;
                calculationHtml += `<ul>
                    <li>Calculation Method: ${method === 'lmtd' ? 'LMTD Method' : 'Effectiveness-NTU Method'}</li>
                    <li>Unit System: ${unitSystem === 'imperial' ? 'Imperial' : 'Metric'}</li>
                    <li>Heat Exchanger Type: ${hxTypeSelect.options[hxTypeSelect.selectedIndex].text}</li>
                    <li>Hot Fluid: Mass Flow Rate (\\(\\dot{m}_h\\)): ${m_h} ${massFlowUnitLabels[0].textContent}, Specific Heat (\\(C_{p,h}\\)): ${cp_h} ${cpUnitLabels[0].textContent}, Inlet Temp (\\(T_{h,in}\\)): ${T_h_in} ${tempUnitLabels[0].textContent}</li>
                    <li>Cold Fluid: Mass Flow Rate (\\(\\dot{m}_c\\)): ${m_c} ${massFlowUnitLabels[0].textContent}, Specific Heat (\\(C_{p,c}\\)): ${cp_c} ${cpUnitLabels[0].textContent}, Inlet Temp (\\(T_{c,in}\\)): ${T_c_in} ${tempUnitLabels[0].textContent}</li>
                    <li>Hot Fluid Heat Capacity Rate (\\(C_h\\)): ${C_h_SI.toFixed(3)} kW/°C</li>
                    <li>Cold Fluid Heat Capacity Rate (\\(C_c\\)): ${C_c_SI.toFixed(3)} kW/°C</li>
                    <li>\\(C_{min}\\): ${C_min_SI.toFixed(3)} kW/°C, \\(C_{max}\\): ${C_max_SI.toFixed(3)} kW/°C</li>
                    <li>Heat Capacity Rate Ratio (\\(C_r = C_{min} / C_{max}\\)): ${C_r_SI.toFixed(3)}</li>
                </ul>`;

                if (method === 'lmtd') {
                    // LMTD Method
                    if (T_h_out === null || T_c_out === null) {
                        displayMessage("For LMTD method, please enter all inlet and outlet temperatures.", "error");
                        return;
                    }
                    if (U_overall === null) {
                        displayMessage("For LMTD method, please enter the Overall Heat Transfer Coefficient (U).", "error");
                        return;
                    }

                    // Check for valid temperature crossovers (Hot out < Cold in or Hot in < Hot out etc.)
                    if (T_h_out_SI >= T_h_in_SI || T_c_out_SI <= T_c_in_SI) {
                        displayMessage("Temperature violation: Hot fluid outlet temperature must be less than inlet, and cold fluid outlet temperature must be greater than inlet.", "error");
                        return;
                    }
                    if (T_h_out_SI < T_c_in_SI) {
                        displayMessage("Temperature violation: Hot fluid outlet temperature cannot be less than cold fluid inlet temperature.", "warning");
                    }
                    if (T_c_out_SI > T_h_in_SI) {
                        displayMessage("Temperature violation: Cold fluid outlet temperature cannot be greater than hot fluid inlet temperature.", "warning");
                    }


                    const Q_h_SI = C_h_SI * (T_h_in_SI - T_h_out_SI);
                    const Q_c_SI = C_c_SI * (T_c_out_SI - T_c_in_SI);

                    let Q_actual_SI = (Q_h_SI + Q_c_SI) / 2; // Average for heat balance check
                    if (Math.abs(Q_h_SI - Q_c_SI) / Q_actual_SI > 0.05) { // 5% tolerance
                        displayMessage(`Heat balance error. Hot fluid heat removal: ${Q_h_SI.toFixed(2)} kW, Cold fluid heat gain: ${Q_c_SI.toFixed(2)} kW. Consider adjusting outlet temperatures or flow rates.`, "warning");
                    }

                    if (hxType === 'parallel') {
                        var dT1_SI = T_h_in_SI - T_c_in_SI;
                        var dT2_SI = T_h_out_SI - T_c_out_SI;
                    } else if (hxType === 'counter') {
                        var dT1_SI = T_h_in_SI - T_c_out_SI;
                        var dT2_SI = T_h_out_SI - T_c_in_SI;
                    } else {
                        // For shell-and-tube and cross-flow, use counter-flow basis for LMTD calculation, then apply F.
                        dT1_SI = T_h_in_SI - T_c_out_SI;
                        dT2_SI = T_h_out_SI - T_c_in_SI;
                    }

                    if (dT1_SI <= 0 || dT2_SI <= 0) {
                        displayMessage("Temperature differences (ΔT1 or ΔT2) must be positive. Check your temperature inputs for proper heat transfer.", "error");
                        return;
                    }

                    const LMTD_SI = calculateLMTD(dT1, dT2);

                    // Calculate P and R for F factor
                    const P_factor = (T_c_out_SI - T_c_in_SI) / (T_h_in_SI - T_c_in_SI);
                    const R_factor = (T_h_in_SI - T_h_out_SI) / (T_c_out_SI - T_c_in_SI);
                    const F_factor = calculateF(hxType, R_factor, P_factor); // Correction factor

                    if (isNaN(LMTD_SI)) {
                        return; // Error already displayed by calculateLMTD
                    }

                    const LMTD_corrected_SI = LMTD_SI * F_factor;
                    const area_calculated_SI = Q_actual_SI / (U_overall_SI * LMTD_corrected_SI);

                    let Q_display, LMTD_display, Area_display;
                    if (unitSystem === 'imperial') {
                        Q_display = (Q_actual_SI * 3600).toFixed(2); // kW to BTU/h (approx, using 1 kW = 3412.14 BTU/h for heat rate)
                        LMTD_display = CtoF(LMTD_corrected_SI).toFixed(2);
                        Area_display = (area_calculated_SI * 10.7639).toFixed(2); // m^2 to ft^2
                    } else {
                        Q_display = Q_actual_SI.toFixed(2);
                        LMTD_display = LMTD_corrected_SI.toFixed(2);
                        Area_display = area_calculated_SI.toFixed(2);
                    }

                    // Populate results
                    results.push(["Calculation Method", "LMTD Method"]);
                    results.push(["Hot Fluid Heat Capacity Rate (\\(C_h\\))", `${C_h_SI.toFixed(3)} kW/°C`]);
                    results.push(["Cold Fluid Heat Capacity Rate (\\(C_c\\))", `${C_c_SI.toFixed(3)} kW/°C`]);
                    results.push(["Hot Fluid Heat Transfer Rate (\\(Q_h\\))", `${(unitSystem === 'imperial' ? Q_h_SI * 3600 : Q_h_SI).toFixed(2)} ${Q_actual_unit}`]);
                    results.push(["Cold Fluid Heat Transfer Rate (\\(Q_c\\))", `${(unitSystem === 'imperial' ? Q_c_SI * 3600 : Q_c_SI).toFixed(2)} ${Q_actual_unit}`]);
                    results.push(["Average Heat Transfer Rate (\\(Q\\))", `<strong>${Q_display} ${Q_actual_unit}</strong>`]);
                    results.push(["Log Mean Temperature Difference (LMTD)", `${LMTD_SI.toFixed(2)} ${LMTD_unit}`]);
                    results.push(["LMTD Correction Factor (F)", F_factor.toFixed(3)]);
                    results.push(["Corrected LMTD (\\( \\Delta T_{lm,F} \\))", `<strong>${LMTD_display} ${LMTD_unit}</strong>`]);
                    results.push(["Required Heat Transfer Area (\\( A \\))", `<strong>${Area_display} ${Area_unit}</strong>`]);

                    // Add calculation details
                    calculationHtml += `<p><strong>2. Calculate Heat Transfer Rate (\\(Q\\)):</strong></p>`;
                    calculationHtml += `<p class="formula">\\[ Q = \\dot{m}_h C_{p,h} (T_{h,in} - T_{h,out}) \\text{ (Hot Fluid)} \\]</p>`;
                    calculationHtml += `<p class="calculation-step">
                        \\(Q_h\\) = ${m_h_SI.toFixed(2)} kg/s \\times ${cp_h_SI.toFixed(2)} kJ/kg°C \\times (${T_h_in_SI.toFixed(2)} - ${T_h_out_SI.toFixed(2)})°C = ${Q_h_SI.toFixed(2)} kW
                    </p>`;
                    calculationHtml += `<p class="formula">\\[ Q = \\dot{m}_c C_{p,c} (T_{c,out} - T_{c,in}) \\text{ (Cold Fluid)} \\]</p>`;
                    calculationHtml += `<p class="calculation-step">
                        \\(Q_c\\) = ${m_c_SI.toFixed(2)} kg/s \\times ${cp_c_SI.toFixed(2)} kJ/kg°C \\times (${T_c_out_SI.toFixed(2)} - ${T_c_in_SI.toFixed(2)})°C = ${Q_c_SI.toFixed(2)} kW
                    </p>`;
                    calculationHtml += `<p class="calculation-step">
                        \\(Q_{avg}\\) = (${Q_h_SI.toFixed(2)} + ${Q_c_SI.toFixed(2)}) / 2 = ${Q_actual_SI.toFixed(2)} kW
                    </p>`;

                    calculationHtml += `<p><strong>3. Calculate LMTD and Correction Factor (F):</strong></p>`;
                    if (hxType === 'parallel') {
                        calculationHtml += `<p>For Parallel Flow:</p>`;
                        calculationHtml += `<p class="formula">\\[ \\Delta T_1 = T_{h,in} - T_{c,in} = ${T_h_in_SI.toFixed(2)} - ${T_c_in_SI.toFixed(2)} = ${dT1_SI.toFixed(2)} \\]</p>`;
                        calculationHtml += `<p class="formula">\\[ \\Delta T_2 = T_{h,out} - T_{c,out} = ${T_h_out_SI.toFixed(2)} - ${T_c_out_SI.toFixed(2)} = ${dT2_SI.toFixed(2)} \\]</p>`;
                    } else if (hxType === 'counter') {
                        calculationHtml += `<p>For Counter Flow:</p>`;
                        calculationHtml += `<p class="formula">\\[ \\Delta T_1 = T_{h,in} - T_{c,out} = ${T_h_in_SI.toFixed(2)} - ${T_c_out_SI.toFixed(2)} = ${dT1_SI.toFixed(2)} \\]</p>`;
                        calculationHtml += `<p class="formula">\\[ \\Delta T_2 = T_{h,out} - T_{c,in} = ${T_h_out_SI.toFixed(2)} - ${T_c_in_SI.toFixed(2)} = ${dT2_SI.toFixed(2)} \\]</p>`;
                    } else {
                        calculationHtml += `<p>For ${hxTypeSelect.options[hxTypeSelect.selectedIndex].text} (LMTD for Counter Flow basis):</p>`;
                        calculationHtml += `<p class="formula">\\[ \\Delta T_1 = T_{h,in} - T_{c,out} = ${T_h_in_SI.toFixed(2)} - ${T_c_out_SI.toFixed(2)} = ${dT1_SI.toFixed(2)} \\]</p>`;
                        calculationHtml += `<p class="formula">\\[ \\Delta T_2 = T_{h,out} - T_{c,in} = ${T_h_out_SI.toFixed(2)} - ${T_c_in_SI.toFixed(2)} = ${dT2_SI.toFixed(2)} \\]</p>`;
                    }

                    calculationHtml += `<p class="formula">\\[ \\Delta T_{lm} = \\frac{\\Delta T_1 - \\Delta T_2}{\\ln(\\Delta T_1 / \\Delta T_2)} = \\frac{${dT1_SI.toFixed(2)} - ${dT2_SI.toFixed(2)}}{\\ln(${dT1_SI.toFixed(2)} / ${dT2_SI.toFixed(2)})} = ${LMTD_SI.toFixed(2)} \\]</p>`;
                    calculationHtml += `<p class="calculation-step">
                        LMTD Correction Factor (F): ${F_factor.toFixed(3)} (Based on heat exchanger type, R = ${R_factor.toFixed(3)}, P = ${P_factor.toFixed(3)}).
                    </p>`;
                    calculationHtml += `<p class="formula">\\[ \\Delta T_{lm,F} = F \\cdot \\Delta T_{lm} = ${F_factor.toFixed(3)} \\times ${LMTD_SI.toFixed(2)} = ${LMTD_corrected_SI.toFixed(2)} \\]</p>`;

                    calculationHtml += `<p><strong>4. Calculate Required Heat Transfer Area (\\(A\\)):</strong></p>`;
                    calculationHtml += `<p class="formula">\\[ Q = U A \\Delta T_{lm,F} \\Rightarrow A = \\frac{Q}{U \\Delta T_{lm,F}} \\]</p>`;
                    calculationHtml += `<p class="calculation-step">
                        \\(A\\) = \\frac{${Q_actual_SI.toFixed(2)} \\text{ kW}}{${U_overall_SI.toFixed(3)} \\text{ kW/m}^2\\text{°C} \\times ${LMTD_corrected_SI.toFixed(2)} \\text{°C}} = ${area_calculated_SI.toFixed(2)} \\text{ m}^2
                    </p>`;

                } else {
                    // Effectiveness-NTU Method
                    // Validate U_overall_ntu or NTU_val_input
                    if (NTU_val_input === null && U_overall_ntu === null) {
                         displayMessage("For Effectiveness-NTU method, please provide either NTU or the Overall Heat Transfer Coefficient (U) to calculate NTU and Area.", "error");
                         return;
                    }

                    // Q_max calculation
                    const Q_max_SI = C_min_SI * (T_h_in_SI - T_c_in_SI);

                    // Determine if we are calculating Effectiveness or NTU/Area
                    let calculated_NTU, calculated_epsilon, calculated_area;

                    if (NTU_val_input !== null) {
                        // User provided NTU, calculate effectiveness
                        calculated_NTU = NTU_val_input;
                        calculated_epsilon = calculateEffectiveness(hxType, calculated_NTU, C_r_SI);

                        // Calculate actual heat transfer
                        const Q_actual_SI = calculated_epsilon * Q_max_SI;

                        // Calculate outlet temperatures
                        T_h_out_SI = T_h_in_SI - (Q_actual_SI / C_h_SI);
                        T_c_out_SI = T_c_in_SI + (Q_actual_SI / C_c_SI);

                        // If U_overall_ntu is provided, we can also calculate Area
                        if (U_overall_ntu !== null) {
                            calculated_area = (calculated_NTU * C_min_SI) / U_overall_ntu_SI; // More direct from NTU definition
                        }

                    } else {
                        // NTU is not provided, so assume U_overall_ntu and outlet temperatures are needed to calculate actual Q and then effectiveness, then NTU
                        if (T_h_out === null || T_c_out === null) {
                            displayMessage("For Effectiveness-NTU method (when NTU is not provided), please enter all inlet and outlet temperatures.", "error");
                            return;
                        }
                        if (U_overall_ntu === null) {
                             displayMessage("For Effectiveness-NTU method, if NTU is not provided, U must be provided to calculate it.", "error");
                             return;
                        }

                        // Calculate actual heat transfer rate based on provided outlet temperatures
                        const Q_h_actual_SI = C_h_SI * (T_h_in_SI - T_h_out_SI);
                        const Q_c_actual_SI = C_c_SI * (T_c_out_SI - T_c_in_SI);
                        const Q_actual_SI = (Q_h_actual_SI + Q_c_actual_SI) / 2;

                        if (Math.abs(Q_h_actual_SI - Q_c_actual_SI) / Q_actual_SI > 0.05) {
                            displayMessage(`Heat balance error. Hot fluid heat removal: ${Q_h_actual_SI.toFixed(2)} kW, Cold fluid heat gain: ${Q_c_actual_SI.toFixed(2)} kW. Consider adjusting outlet temperatures or flow rates.`, "warning");
                        }
                        calculated_epsilon = Q_actual_SI / Q_max_SI;

                        // Now, given epsilon, try to find NTU (iterative or inverse formula depending on HX type)
                        // For basic types, inverse relationships exist:
                        if (hxType === 'parallel') {
                            calculated_NTU = -Math.log(1 - calculated_epsilon * (1 + C_r_SI)) / (1 + C_r_SI);
                        } else if (hxType === 'counter') {
                            if (C_r_SI === 1) {
                                calculated_NTU = calculated_epsilon / (1 - calculated_epsilon);
                            } else {
                                calculated_NTU = 1 / (C_r_SI - 1) * Math.log((calculated_epsilon * C_r_SI - 1) / (calculated_epsilon - 1));
                            }
                        } else {
                            // For other types, solving for NTU from epsilon is non-trivial without specific inverse functions
                            // or numerical methods. For this demo, we'll indicate this limitation.
                            displayMessage("Calculating NTU from effectiveness for this heat exchanger type is complex and not directly supported in this simplified tool. Please provide NTU directly.", "warning");
                            calculated_NTU = NaN; // Cannot easily calculate
                        }
                        calculated_area = (calculated_NTU * C_min_SI) / U_overall_ntu_SI;
                    }

                    // Convert results back to user's selected unit system for display
                    let Q_max_display, Q_actual_display, epsilon_display, NTU_display, Area_display_ntu;
                    let T_h_out_display, T_c_out_display;

                    if (unitSystem === 'imperial') {
                        Q_max_display = (Q_max_SI * 3600).toFixed(2); // kW to BTU/h
                        Q_actual_display = (calculated_epsilon * Q_max_SI * 3600).toFixed(2);
                        T_h_out_display = CtoF(T_h_out_SI).toFixed(2);
                        T_c_out_display = CtoF(T_c_out_SI).toFixed(2);
                        Area_display_ntu = (calculated_area * 10.7639).toFixed(2); // m^2 to ft^2
                    } else {
                        Q_max_display = Q_max_SI.toFixed(2);
                        Q_actual_display = (calculated_epsilon * Q_max_SI).toFixed(2);
                        T_h_out_display = T_h_out_SI.toFixed(2);
                        T_c_out_display = T_c_out_SI.toFixed(2);
                        Area_display_ntu = calculated_area ? calculated_area.toFixed(2) : "N/A";
                    }

                    epsilon_display = calculated_epsilon.toFixed(3);
                    NTU_display = calculated_NTU ? calculated_NTU.toFixed(3) : "N/A";
                    Area_display_ntu = calculated_area ? Area_display_ntu : "N/A";

                    results.push(["Calculation Method", "Effectiveness-NTU Method"]);
                    results.push(["Hot Fluid Heat Capacity Rate (\\(C_h\\))", `${C_h_SI.toFixed(3)} kW/°C`]);
                    results.push(["Cold Fluid Heat Capacity Rate (\\(C_c\\))", `${C_c_SI.toFixed(3)} kW/°C`]);
                    results.push(["Maximum Possible Heat Transfer (\\(Q_{max}\\))", `${Q_max_display} ${Q_actual_unit}`]);
                    results.push(["Heat Capacity Rate Ratio (\\(C_r\\))", C_r_SI.toFixed(3)]);
                    results.push(["Number of Transfer Units (NTU)", `<strong>${NTU_display}</strong>`]);
                    results.push(["Heat Exchanger Effectiveness (\\( \\epsilon \\))", `<strong>${epsilon_display}</strong>`]);
                    results.push(["Actual Heat Transfer Rate (\\(Q\\))", `<strong>${Q_actual_display} ${Q_actual_unit}</strong>`]);
                    results.push(["Hot Fluid Outlet Temperature (\\(T_{h,out}\\))", `<strong>${T_h_out_display} ${tempUnitLabels[0].textContent}</strong>`]);
                    results.push(["Cold Fluid Outlet Temperature (\\(T_{c,out}\\))", `<strong>${T_c_out_display} ${tempUnitLabels[0].textContent}</strong>`]);
                    if (U_overall_ntu_input.value) { // Only show area if U was provided to calculate it
                        results.push(["Calculated Heat Transfer Area (\\(A\\))", `<strong>${Area_display_ntu} ${Area_unit}</strong>`]);
                    }


                    // Add calculation details
                    calculationHtml += `<p><strong>2. Calculate Maximum Possible Heat Transfer Rate (\\(Q_{max}\\)):</strong></p>`;
                    calculationHtml += `<p class="formula">\\[ Q_{max} = C_{min} (T_{h,in} - T_{c,in}) = ${C_min_SI.toFixed(3)} \\times (${T_h_in_SI.toFixed(2)} - ${T_c_in_SI.toFixed(2)}) = ${Q_max_SI.toFixed(2)} \\text{ kW} \\]</p>`;

                    calculationHtml += `<p><strong>3. Calculate Effectiveness (\\(\\epsilon\\)) and/or NTU:</strong></p>`;
                    if (NTU_val_input !== null) {
                        calculationHtml += `<p class="calculation-step">
                            NTU provided by user: ${calculated_NTU.toFixed(3)}
                        </p>`;
                        calculationHtml += `<p>Using the Effectiveness-NTU relation for ${hxTypeSelect.options[hxTypeSelect.selectedIndex].text}:</p>`;
                        calculationHtml += `<p class="formula">\\[ \\epsilon = f(NTU, C_r) \\]</p>`;
                        calculationHtml += `<p class="calculation-step">
                            \\(\\epsilon\\) = ${calculated_epsilon.toFixed(3)}
                        </p>`;
                    } else {
                        calculationHtml += `<p>Calculate Actual Heat Transfer Rate (\\(Q\\)) from given temperatures:</p>`;
                        calculationHtml += `<p class="formula">\\[ Q = \\dot{m}_h C_{p,h} (T_{h,in} - T_{h,out}) = ${C_h_SI.toFixed(2)} \\times (${T_h_in_SI.toFixed(2)} - ${T_h_out_SI.toFixed(2)}) = ${Q_h_actual_SI.toFixed(2)} \\text{ kW} \\]</p>`;
                        calculationHtml += `<p class="formula">\\[ Q = \\dot{m}_c C_{p,c} (T_{c,out} - T_{c,in}) = ${C_c_SI.toFixed(2)} \\times (${T_c_out_SI.toFixed(2)} - ${T_c_in_SI.toFixed(2)}) = ${Q_c_actual_SI.toFixed(2)} \\text{ kW} \\]</p>`;
                        calculationHtml += `<p class="calculation-step">
                            Average Actual Heat Transfer Rate = ${(Q_h_actual_SI + Q_c_actual_SI) / 2 .toFixed(2)} kW
                        </p>`;
                        calculationHtml += `<p class="formula">\\[ \\epsilon = \\frac{Q_{actual}}{Q_{max}} = \\frac{${Q_actual_SI.toFixed(2)}}{${Q_max_SI.toFixed(2)}} = ${calculated_epsilon.toFixed(3)} \\]</p>`;
                        if (!isNaN(calculated_NTU)) {
                            calculationHtml += `<p>Inversely calculating NTU from \\(\\epsilon\\) for ${hxTypeSelect.options[hxTypeSelect.selectedIndex].text}:</p>`;
                            calculationHtml += `<p class="formula">\\[ NTU = f^{-1}(\\epsilon, C_r) \\]</p>`;
                            calculationHtml += `<p class="calculation-step">
                                NTU = ${calculated_NTU.toFixed(3)}
                            </p>`;
                        }
                    }

                    if (!isNaN(calculated_epsilon)) {
                        calculationHtml += `<p><strong>4. Calculate Actual Heat Transfer Rate and Outlet Temperatures:</strong></p>`;
                        calculationHtml += `<p class="formula">\\[ Q = \\epsilon Q_{max} = ${calculated_epsilon.toFixed(3)} \\times ${Q_max_SI.toFixed(2)} = ${(calculated_epsilon * Q_max_SI).toFixed(2)} \\text{ kW} \\]</p>`;
                        calculationHtml += `<p class="formula">\\[ T_{h,out} = T_{h,in} - \\frac{Q}{C_h} = ${T_h_in_SI.toFixed(2)} - \\frac{${(calculated_epsilon * Q_max_SI).toFixed(2)}}{${C_h_SI.toFixed(2)}} = ${T_h_out_SI.toFixed(2)} \\text{ °C} \\]</p>`;
                        calculationHtml += `<p class="formula">\\[ T_{c,out} = T_{c,in} + \\frac{Q}{C_c} = ${T_c_in_SI.toFixed(2)} + \\frac{${(calculated_epsilon * Q_max_SI).toFixed(2)}}{${C_c_SI.toFixed(2)}} = ${T_c_out_SI.toFixed(2)} \\text{ °C} \\]</p>`;
                    }

                    if (!isNaN(calculated_NTU) && U_overall_ntu_input.value) {
                         calculationHtml += `<p><strong>5. Calculate Heat Transfer Area (\\(A\\)):</strong></p>`;
                         calculationHtml += `<p class="formula">\\[ NTU = \\frac{U A}{C_{min}} \\Rightarrow A = \\frac{NTU \\cdot C_{min}}{U} \\]</p>`;
                         calculationHtml += `<p class="calculation-step">
                             \\(A\\) = \\frac{${calculated_NTU.toFixed(3)} \\times ${C_min_SI.toFixed(3)} \\text{ kW/°C}}{${U_overall_ntu_SI.toFixed(3)} \\text{ kW/m}^2\\text{°C}} = ${calculated_area.toFixed(2)} \\text{ m}^2
                         </p>`;
                    }
                }

                // Populate results table
                function addResultRow(parameterHtml, valueHtml) {
                    const row = resultTableBody.insertRow();
                    const paramCell = row.insertCell();
                    const valueCell = row.insertCell();
                    paramCell.innerHTML = parameterHtml;
                    valueCell.innerHTML = valueHtml;
                }
                results.forEach(row => addResultRow(row[0], row[1]));

                // Update calculation details and MathJax rendering
                calculationDetailsDiv.innerHTML = calculationHtml;
                if (window.MathJax) {
                    window.MathJax.typesetPromise([calculationDetailsDiv, resultTableBody]);
                }

                // Display standard reference
                standardReference.innerHTML = "Heat exchanger design principles are extensively covered in thermodynamics and heat transfer textbooks. For detailed correlations, charts, and limitations, refer to standard texts such as <strong>Cengel, Y. A., & Ghajar, A. J., 'Heat and Mass Transfer: Fundamentals & Applications'</strong> or <strong>Incropera, F. P., et al., 'Fundamentals of Heat and Mass Transfer'</strong>. Consult engineering standards for specific applications.";

                // Show result container
                resultContainer.style.display = 'block';
                setTimeout(() => {
                    resultContainer.classList.add('show');
                }, 10);
                resultContainer.scrollIntoView({ behavior: 'smooth' });
                displayMessage("Calculation completed successfully!", "info");
            });

            // Theme switch functionality
            if (themeSwitch) {
                if (localStorage.getItem('theme') === 'dark') {
                    document.body.classList.add('dark-mode');
                    themeSwitch.checked = true;
                }
                themeSwitch.addEventListener('change', function() {
                    if (this.checked) {
                        document.body.classList.add('dark-mode');
                        localStorage.setItem('theme', 'dark');
                    } else {
                        document.body.classList.remove('dark-mode');
                        localStorage.setItem('theme', 'light');
                    }
                });
            }
        });
    </script>
</body>
</html>


