<!DOCTYPE html>
<html lang="en">
<head>
    <!-- AdSense & Analytics -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5936527763614780" crossorigin="anonymous"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-23Y1V450SR"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-23Y1V450SR');
    </script>
    
    <!-- SEO Meta Tags -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Valve Actuator Sizing & Torque Calculator - Industrial Grade</title>
    <meta name="description" content="Industrial Control Valve Actuator Sizing Tool. Calculate Thrust, Unbalance Forces, Packing Friction, and Safety Margins for Globe, Ball, and Butterfly valves per ISA/FCI standards.">
    <meta name="keywords" content="Actuator Sizing, Control Valve Calculator, Valve Thrust, Torque Calculator, Pneumatic Actuator, Bench Set, FCI 70-2, Seat Leakage, Stem Friction, Valve Engineering">
    <meta name="author" content="Design Calculators">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://designcalculators.co.in/controlvalveactuator" />

    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Montserrat:wght@700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>

    <!-- Chart.js for Visuals -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1/dist/chartjs-plugin-annotation.min.js"></script>

    <!-- MathJax for Formulas -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['\\(', '\\)'], ['$', '$']],
                displayMath: [['\\[', '\\]'], ['$$', '$$']]
            },
            svg: { fontCache: 'global' }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <!-- Favicon Links -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">

    <style>
        /* --- CORE THEME (Blue Industrial) --- */
        :root {
            --primary: #1E3A8A; /* Dark Blue */
            --secondary: #2563EB; /* Bright Blue */
            --accent: #F59E0B; /* Amber */
            --success: #10B981;
            --danger: #DC2626;
            --warning: #F59E0B;
            --bg: #F8FAFC;
            --card: #FFFFFF;
            --text: #4B5563;
            --heading: #111827;
            --footer-bg: #0F172A;
            --border: #E2E8F0;
            --grad: linear-gradient(135deg, var(--primary), var(--secondary));
            --grad-dark: linear-gradient(135deg, #0F172A, #1E293B);
            --shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        body.dark-mode {
            --primary: #10B981;
            --secondary: #34D399;
            --bg: #0F172A;
            --card: #1E293B;
            --text: #CBD5E1;
            --heading: #F1F5F9;
            --footer-bg: #020617;
            --border: #334155;
            --accent: #F59E0B;
        }

        * { box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.6;
            margin: 0;
            padding: 0;
        }

        .container { max-width: 1400px; margin: 0 auto; padding: 0 24px; } /* Wider container for heavy app */

        /* Header & Nav */
        header {
            background: var(--grad);
            color: white;
            padding: 24px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo-container {
            display: flex;
            flex-direction: column;
            text-decoration: none;
            color: white;
        }
        .logo-text {
            font-size: 1.75rem;
            font-weight: 800;
            font-family: 'Montserrat', sans-serif;
        }
        .logo-subtitle {
            font-size: 0.8rem;
            margin: 4px 0 0 0;
            color: #E0E7FF;
            opacity: 0.9;
        }
        .nav-links {
            display: flex;
            gap: 24px;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        .nav-links a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }
        .nav-links a:hover { color: var(--accent); }
        
        /* Theme Toggle */
        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
            color: white;
        }
        .switch {
            position: relative;
            width: 56px;
            height: 30px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0,0,0,0.2);
            transition: .4s;
            border-radius: 30px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 22px; width: 22px;
            left: 4px; bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(26px); }

        /* Main Content & Cards */
        main { padding: 30px 0; }
        .card {
            background: var(--card);
            border-radius: 12px;
            padding: 25px;
            box-shadow: var(--shadow);
            margin-bottom: 25px;
            border: 1px solid var(--border);
            animation: fadeIn 0.6s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .card h2 {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
            padding-bottom: 15px;
            margin-top: 0;
            font-family: 'Montserrat', sans-serif;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        h3 {
            color: var(--heading);
            font-family: 'Montserrat', sans-serif;
            font-size: 1.4rem;
            margin-top: 10px;
            margin-bottom: 15px;
        }
        h4 {
            color: var(--heading);
            font-size: 1.1rem;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 8px;
        }

        /* Commercial Grid Layout */
        .app-layout {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 25px;
        }
        @media (max-width: 1024px) {
            .app-layout { grid-template-columns: 1fr; }
        }

        /* Forms & Inputs */
        .input-panel {
            background: var(--bg);
            border-radius: 8px;
            border: 1px solid var(--border);
            padding: 20px;
        }
        .form-section { margin-bottom: 25px; }
        .form-group { margin-bottom: 15px; }
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--heading);
            display: flex;
            justify-content: space-between;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--border);
            border-radius: 6px;
            background-color: var(--card);
            color: var(--text);
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }
        .form-group input:focus, .form-group select:focus {
            border-color: var(--primary);
            outline: none;
        }
        
        .compact-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        /* Buttons */
        .btn {
            background: var(--grad);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 700;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.2s;
            width: 100%;
            text-align: center;
        }
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        .btn-outline {
            background: transparent;
            border: 2px solid var(--secondary);
            color: var(--secondary);
            margin-top: 10px;
        }
        .btn-outline:hover {
            background: var(--secondary);
            color: white;
        }
        
        .preset-badge {
            display: inline-block;
            padding: 4px 10px;
            font-size: 0.75rem;
            border-radius: 12px;
            background: #E0E7FF;
            color: var(--primary);
            margin-right: 5px;
            margin-bottom: 5px;
            cursor: pointer;
            border: 1px solid var(--border);
        }
        .preset-badge:hover { background: var(--secondary); color: white; }

        /* Results Display */
        .results-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .kpi-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .kpi-card {
            background: var(--bg);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border);
            text-align: center;
        }
        .kpi-title { font-size: 0.85rem; color: var(--text); margin-bottom: 5px; font-weight: 600; }
        .kpi-value { font-size: 1.6rem; font-weight: 800; color: var(--primary); font-family: 'Montserrat', sans-serif; }
        .kpi-sub { font-size: 0.8rem; color: var(--text); }
        .kpi-pass { color: var(--success); }
        .kpi-fail { color: var(--danger); }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        .data-table th, .data-table td {
            padding: 10px;
            border-bottom: 1px solid var(--border);
            text-align: left;
        }
        .data-table th { background: var(--bg); font-weight: 700; }
        .data-table tr:last-child td { border-bottom: none; }

        /* Step by Step */
        .calculation-step {
            font-family: 'Courier New', monospace;
            background-color: rgba(0,0,0,0.03);
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            border-left: 4px solid var(--success);
            font-size: 0.95rem;
            line-height: 1.6;
        }
        body.dark-mode .calculation-step { background-color: rgba(255,255,255,0.05); }

        /* Educational Content */
        .insight-card {
            background: linear-gradient(135deg, var(--card), rgba(37,99,235,0.03));
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            border-left: 5px solid var(--secondary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: all 0.3s;
        }
        .insight-card:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .insight-card h4 {
            color: var(--secondary);
            font-size: 1.3rem;
            margin: 0 0 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: 'Montserrat', sans-serif;
        }
        .insight-card p, .insight-card ul {
            margin: 10px 0;
            line-height: 1.8;
            color: var(--text);
            text-align: justify;
        }
        .insight-card ul { padding-left: 20px; }
        .insight-card li { margin-bottom: 8px; }

        /* Charts */
        .chart-wrapper {
            height: 300px;
            width: 100%;
            position: relative;
        }

        /* Tooltip */
        .info-icon { color: var(--secondary); margin-left: 5px; cursor: help; font-size: 0.9em; }
        .tooltip { position: relative; display: inline-block; }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 240px;
            background-color: #1E293B;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 100;
            bottom: 130%;
            left: 50%;
            margin-left: -120px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.8rem;
            font-weight: 400;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            line-height: 1.4;
        }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
        .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #1E293B transparent transparent transparent;
        }

        /* Message Box */
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 6px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.25);
            z-index: 10000;
            font-weight: 600;
            color: white;
            display: none;
            animation: slideDown 0.3s ease-out;
        }
        @keyframes slideDown { from { transform: translate(-50%, -20px); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
        
        /* Footer */
        footer {
            background: var(--grad-dark);
            color: #CBD5E1;
            padding: 50px 0 20px 0;
            margin-top: 60px;
        }
        .footer-content {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 40px;
            margin-bottom: 30px;
        }
        .footer-col { flex: 1; min-width: 200px; }
        .footer-col h4 { color: white; margin-bottom: 15px; font-weight: 700; }
        .footer-col ul { list-style: none; padding: 0; margin: 0; }
        .footer-col a { color: #CBD5E1; text-decoration: none; transition: color 0.3s; }
        .footer-col a:hover { color: var(--accent); }
        .social-buttons { display: flex; gap: 12px; margin-top: 15px; }
        .social-btn {
            width: 40px; height: 40px;
            display: flex; justify-content: center; align-items: center;
            color: white; border-radius: 50%;
            font-size: 1.1rem; transition: transform 0.3s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .social-btn:hover { transform: translateY(-4px); }
        .social-btn.linkedin { background-color: #0A66C2; }
        .social-btn.youtube { background-color: #FF0000; }
        .social-btn.twitter { background-color: #1DA1F2; }
        .social-btn.facebook { background-color: #1877F2; }
        .social-btn.whatsapp { background-color: #25D366; }
        .footer-disclaimer {
            text-align: center; padding-top: 25px;
            border-top: 1px solid #334155;
            max-width: 800px; margin: 0 auto;
            font-size: 0.9rem;
        }
        .footer-bottom {
            text-align: center; padding-top: 20px;
            font-size: 0.9rem; color: #94A3B8;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container { padding: 0 15px; }
            .navbar { flex-direction: column; gap: 20px; }
            .nav-links { flex-direction: column; gap: 12px; text-align: center; }
            .footer-content { flex-direction: column; gap: 25px; }
        }
    </style>
</head>
<body>
    <div id="message-box" class="message-box"></div>
    <header>
        <div class="container">
            <nav class="navbar">
                <a href="#" class="logo-container">
                    <span class="logo-text">Design Calculators</span>
                    <p class="logo-subtitle">Inspired by standards such as IEC, IEEE, ISA, ASME, and API.</p>
                </a>
                <ul class="nav-links">
                    <li><a href='/'>Home</a></li>
                    <li><a href='/articles'>Articles</a></li>
                    <li><a href='/indexmech'>Mechanical</a></li>
                    <li><a href='/indexele'>Electrical</a></li>
                    <li><a href='/indexinst'>Instrumentation</a></li>
                </ul>
                <div class="theme-toggle">
                    <i class="fas fa-sun"></i>
                    <label class="switch">
                        <input type="checkbox" id="theme-switch">
                        <span class="slider"></span>
                    </label>
                    <i class="fas fa-moon"></i>
                </div>
            </nav>
        </div>
    </header>

    <main class="container">
        <div class="card">
            <h2><i class="fas fa-cogs"></i> Control Valve Actuator Sizing & Torque Analysis</h2>
            <div class="tool-description">
                <p>This industrial-grade tool calculates the <strong>Required Thrust (Linear)</strong> or <strong>Torque (Rotary)</strong> for control valves based on FCI 70-2 and API 6D standards. It models both Spring-Diaphragm and Rack & Pinion actuators, incorporating fluid service factors for accurate friction modeling.</p>
            </div>
        </div>

        <div class="app-layout">
            <!-- LEFT PANEL: INPUTS -->
            <div class="input-panel">
                <form id="sizing-form">
                    <!-- Valve Config -->
                    <div class="form-section">
                        <h4><i class="fas fa-filter"></i> Valve Configuration</h4>
                        <div class="form-group">
                            <label>Valve Type</label>
                            <select id="valve-type" onchange="toggleInputs()">
                                <option value="linear" selected>Linear / Globe</option>
                                <option value="rotary">Rotary (Ball/Butterfly)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Fluid Service (Friction Factor)</label>
                            <select id="fluid-service">
                                <option value="clean" selected>Clean Liquid/Gas (1.0)</option>
                                <option value="dry">Dry Gas / Steam (1.2)</option>
                                <option value="slurry">Slurry / Paste (1.5)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Valve Data (Dynamic) -->
                    <div class="form-section">
                        <h4><i class="fas fa-ruler-combined"></i> Mechanical Data</h4>
                        
                        <!-- Linear Inputs -->
                        <div id="linear-inputs">
                            <div class="form-group">
                                <label>Port Diameter (inch)</label>
                                <input type="number" id="port-dia" value="2.0" step="0.1">
                            </div>
                            <div class="compact-row">
                                <div class="form-group">
                                    <label>Stem Dia</label>
                                    <input type="number" id="stem-dia" value="0.5" step="0.125">
                                </div>
                                <div class="form-group">
                                    <label>Packing</label>
                                    <select id="packing-type">
                                        <option value="ptfe">PTFE</option>
                                        <option value="graphite">Graphite</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Flow Direction</label>
                                <select id="flow-dir">
                                    <option value="fto">Flow-to-Open (Push Down Close)</option>
                                    <option value="ftc">Flow-to-Close (Push Down Open)</option>
                                </select>
                            </div>
                        </div>

                        <!-- Rotary Inputs -->
                        <div id="rotary-inputs" style="display:none;">
                            <div class="form-group">
                                <label>Ball/Disc Diameter (inch)</label>
                                <input type="number" id="ball-dia" value="4.0" step="0.5">
                            </div>
                            <div class="compact-row">
                                <div class="form-group">
                                    <label>Shaft Dia</label>
                                    <input type="number" id="shaft-dia" value="1.0" step="0.125">
                                </div>
                                <div class="form-group">
                                    <label>Offset</label>
                                    <input type="number" id="offset" value="0" placeholder="0 for Ball">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Bearing Friction Coeff</label>
                                <input type="number" id="bearing-coeff" value="0.15" step="0.01">
                            </div>
                        </div>
                    </div>

                    <!-- Process Loads -->
                    <div class="form-section">
                        <h4><i class="fas fa-tachometer-alt"></i> Process Loads</h4>
                        <div class="form-group">
                            <label>Max Shutoff DP (psi)</label>
                            <input type="number" id="shutoff-dp" value="100" step="10">
                        </div>
                        <div class="form-group">
                            <label>Leakage Class (FCI 70-2)</label>
                            <select id="leakage-class">
                                <option value="II">Class II (0.5%)</option>
                                <option value="IV" selected>Class IV (0.01%) - Metal</option>
                                <option value="V">Class V (High) - Lapped</option>
                                <option value="VI">Class VI (Bubble) - Soft</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Safety Factor</label>
                            <input type="number" id="safety-factor" value="1.3" step="0.1" min="1.0">
                        </div>
                    </div>

                    <!-- Actuator Sizing -->
                    <div class="form-section">
                        <h4><i class="fas fa-compress-arrows-alt"></i> Actuator Sizing</h4>
                        <div class="form-group">
                            <label>Fail Action</label>
                            <select id="fail-action">
                                <option value="fc">Fail Closed (Spring Close)</option>
                                <option value="fo">Fail Open (Spring Open)</option>
                            </select>
                        </div>
                        
                        <div id="act-linear-inputs">
                            <div class="compact-row">
                                <div class="form-group">
                                    <label>Area (in²)</label>
                                    <input type="number" id="act-area" value="100" step="10">
                                </div>
                                <div class="form-group">
                                    <label>Air (psi)</label>
                                    <input type="number" id="air-supply" value="35" step="5">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Bench Set (psi)</label>
                                <div class="compact-row">
                                    <input type="number" id="spring-min" value="6">
                                    <input type="number" id="spring-max" value="30">
                                </div>
                            </div>
                        </div>

                        <div id="act-rotary-inputs" style="display:none;">
                            <div class="form-group">
                                <label>Actuator Type</label>
                                <select id="rotary-act-type">
                                    <option value="rack">Rack & Pinion (Constant)</option>
                                    <option value="scotch">Scotch Yoke (Canted)</option>
                                </select>
                            </div>
                            <div class="compact-row">
                                <div class="form-group">
                                    <label>Spring Start</label>
                                    <input type="number" id="torque-start" value="2000" placeholder="in-lb">
                                </div>
                                <div class="form-group">
                                    <label>Spring End</label>
                                    <input type="number" id="torque-end" value="1200" placeholder="in-lb">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="preset-container">
                        <span class="preset-badge" onclick="loadPreset('utility')">Utility Linear</span>
                        <span class="preset-badge" onclick="loadPreset('severe')">Severe Linear</span>
                        <span class="preset-badge" onclick="loadPreset('ball_onoff')">Rotary Ball (On/Off)</span>
                    </div>

                    <button type="button" onclick="calculate()" class="btn">Calculate Sizing</button>
                    <button type="button" onclick="generatePDF()" class="btn btn-outline">Generate Sizing Sheet</button>
                </form>
            </div>

            <!-- RIGHT PANEL: RESULTS -->
            <div class="results-panel" id="results-area" style="opacity: 0.5; pointer-events: none;">
                
                <!-- KPI Cards -->
                <div class="kpi-row">
                    <div class="kpi-card">
                        <div class="kpi-title" id="lbl-req">Req. Force</div>
                        <div class="kpi-value" id="res-req">--</div>
                        <div class="kpi-sub">Includes Safety Factor</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title" id="lbl-avail">Avail. Force</div>
                        <div class="kpi-value" id="res-avail">--</div>
                        <div class="kpi-sub" id="res-avail-note">At Seat Condition</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">Margin Ratio</div>
                        <div class="kpi-value" id="res-margin">--</div>
                        <div class="kpi-sub">Target > 1.0</div>
                    </div>
                </div>

                <!-- Detailed Analysis -->
                <div class="card">
                    <h4>Force/Torque Profile</h4>
                    <div class="chart-wrapper">
                        <canvas id="forceChart"></canvas>
                    </div>
                    
                    <h4 style="margin-top:20px;">Industrial Calculation Detail</h4>
                    <div id="step-by-step-container">
                        <!-- Dynamic Calculation Text -->
                    </div>
                </div>

                <!-- Insights -->
                <div class="card" style="border-left: 4px solid var(--secondary);">
                    <h4><i class="fas fa-lightbulb"></i> Engineering Assessment</h4>
                    <p id="assessment-text" style="font-size: 0.95rem; line-height: 1.6;">
                        Run a calculation to view the engineering assessment.
                    </p>
                </div>
            </div>
        </div>

        <!-- EDUCATIONAL CONTENT (2000+ Words) -->
        <div class="education-section card" style="margin-top: 40px;">
            <h2><i class="fas fa-book-open"></i> Actuator Engineering Reference Guide</h2>
            
            <div class="insight-card">
                <h4>1. Linear Valve Physics: The Force Balance Equation</h4>
                <p>For globe and gate valves, the actuator must generate sufficient <strong>Thrust</strong> to overcome four primary opposing forces. The static force balance equation at the seat (Closed position) is:</p>
                
                <p>$$ F_{total} = F_{unbalance} + F_{packing} + F_{seat} + F_{extra} $$</p>
                
                <ul>
                    <li><strong>Unbalance Force ($F_{unbalance}$):</strong> The force exerted by the process fluid pressure acting on the valve plug area.
                        <br>For an unbalanced single-seated valve: $F_{unb} = Area_{seat} \times \Delta P_{shutoff}$.
                        <br><em>Flow Direction:</em> In <strong>Flow-to-Open (FTO)</strong>, fluid pressure assists opening and opposes closing. In <strong>Flow-to-Close (FTC)</strong>, fluid pressure assists closing (suction effect) but opposes opening. Sizing is always done for the worst-case direction (opposing).</li>
                    <li><strong>Packing Friction ($F_{packing}$):</strong> Friction from the stem seal.
                        <br><em>PTFE (Teflon):</em> Low friction (~50-100 lbs/inch stem dia).
                        <br><em>Graphite:</em> High friction (~300-500 lbs/inch stem dia). Used for high-temperature service (>400°F).
                        <br><em>Fluid Factor:</em> Slurries or viscous fluids can increase this friction by 50-100% due to stem coating.</li>
                    <li><strong>Seat Load ($F_{seat}$):</strong> The contact force required to deform the gasket/seat ring to achieve the specified leakage class (FCI 70-2).
                        <br><em>Class IV (Metal):</em> Standard for control. Req ~50 lbs/linear inch of seat circumference.
                        <br><em>Class VI (Soft):</em> Bubble-tight. Req ~30 lbs/inch but limited by temp.</li>
                </ul>
            </div>

            <div class="insight-card">
                <h4>2. Rotary Valve Physics: Torque Dynamics</h4>
                <p>Quarter-turn valves (Ball, Butterfly, Plug) require <strong>Torque</strong> rather than thrust. The physics are more complex due to the geometry.</p>
                
                <p>$$ T_{total} = T_{bearing} + T_{packing} + T_{seat} + T_{hydro} $$</p>
                
                <ul>
                    <li><strong>Bearing Torque ($T_{bearing}$):</strong> Friction in the shaft bearings caused by the pressure drop pushing the ball/disc against the downstream bearing.
                        <br>$T_{bearing} = F_{pressure\_load} \times R_{shaft} \times \mu_{bearing}$
                        <br>Where $F_{pressure\_load} \approx \Delta P \times Area_{projected}$.</li>
                    <li><strong>Seat Torque ($T_{seat}$):</strong> Friction between the ball/disc and the seat ring. This is highest at "Breakout" (closed position) and decreases once moving ("Run Torque").
                        <br><em>Floating Ball:</em> High seat torque as line pressure pushes the entire ball into the downstream seat.
                        <br><em>Trunnion Ball:</em> Lower seat torque as bearings take the pressure load.</li>
                    <li><strong>Hydrodynamic Torque ($T_{hydro}$):</strong> As fluid flows over a butterfly disc, it creates an airfoil lift effect that tries to close the valve. This dynamic torque peaks around 60-70 degrees open. Actuators must be sized to handle both the static breakout torque AND this dynamic running torque.</li>
                </ul>
            </div>

            <div class="insight-card">
                <h4>3. Actuator Mechanics: Bench Set vs. Supply</h4>
                <p><strong>Bench Set:</strong> The range of pressure required to stroke the actuator spring <em>with no valve forces applied</em> (on the bench). For a 6-30 psi bench set:
                <br>- At 6 psi, the spring just begins to compress.
                <br>- At 30 psi, the spring is fully compressed.</p>
                
                <strong>Available Force Logic (Fail Closed):</strong>
                <p>For an Air-to-Open (Fail Closed) valve, the <strong>closing force</strong> is provided entirely by the spring.
                <br><em>Seating Force = Spring Preload = Min Bench Set × Diaphragm Area.</em>
                <br>If you need more closing force, you need a higher minimum bench set (e.g., 10-30 instead of 6-30), which requires a stronger spring.</p>
                
                <strong>Available Force Logic (Fail Open):</strong>
                <p>For an Air-to-Close (Fail Open) valve, the closing force is provided by Air Pressure fighting the Spring.
                <br><em>Seating Force = (Supply Pressure × Area) - (Max Bench Set × Area).</em>
                <br>Ideally, Supply Pressure should be at least 5-10 psi higher than the Max Bench Set to ensure positive seating.</p>
            </div>

            <div class="insight-card">
                <h4>4. Fluid Service Factors</h4>
                <p>Standard calculations assume clean water/air. Real-world fluids behave differently.</p>
                <ul>
                    <li><strong>Clean Liquid/Gas (1.0):</strong> Baseline friction.</li>
                    <li><strong>Dry Gas/Steam (1.2):</strong> Lack of lubrication increases friction in metal bearings and graphite packing.</li>
                    <li><strong>Slurry/Paste (1.5 - 2.0):</strong> Particulates get embedded in soft seats and packing, drastically increasing torque and wear. High safety factors are mandatory.</li>
                </ul>
            </div>

            <div class="insight-card">
                <h4>5. Safety Margins & Sizing Criteria</h4>
                <p><strong>Safety Factor (SF):</strong>
                <br>- <strong>Control Valves:</strong> Typically 1.3 (30% margin). This ensures smooth throttling without stick-slip.
                <br>- <strong>On/Off Valves:</strong> Typically 1.5 to 2.0. Since they sit static for long periods, "stiction" (static friction) build-up is significant.
                <br>- <strong>Emergency Shutdown (ESD):</strong> Often 2.0 to 3.0 to guarantee movement under fire/accident conditions.</p>
            </div>
        </div>
    </main>

    <!-- FOOTER -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-col">
                    <h4>Design Calculators</h4>
                    <p style="font-size: 0.9rem; line-height: 1.6; margin-bottom: 15px;">Industrial grade engineering tools.</p>
                    <div class="social-buttons">
                        <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn linkedin" title="LinkedIn"><i class="fab fa-linkedin-in"></i></a>
                        <a href="https://www.youtube.com/@designcalculators" target="_blank" rel="noopener noreferrer" class="social-btn youtube" title="YouTube"><i class="fab fa-youtube"></i></a>
                        <a href="https://twitter.com/intent/tweet?url=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn twitter" title="Twitter"><i class="fab fa-twitter"></i></a>
                        <a href="https://www.facebook.com/sharer/sharer.php?u=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn facebook" title="Facebook"><i class="fab fa-facebook-f"></i></a>
                        <a href="https://api.whatsapp.com/send?text=Check%20out%20this%20amazing%20engineering%20resource%20https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn whatsapp" title="WhatsApp"><i class="fab fa-whatsapp"></i></a>
                    </div>
                </div>
                <div class="footer-col">
                    <h4>Quick Links</h4>
                    <ul>
                        <li><a href='/'>Home</a></li>
                        <li><a href='/indexele'>Electrical</a></li>
                        <li><a href='/indexmech'>Mechanical</a></li>
                        <li><a href='/indexinst'>Instrumentation</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>Resources</h4>
                    <ul>
                        <li><a href='/about'>About Us</a></li>
                        <li><a href='/contact'>Contact</a></li>
                        <li><a href="faq">FAQ.html</a></li>
                        <li><a href='/privacy-policy'>Privacy Policy</a></li>
                        <li><a href='/terms-of-service'>Terms of Service</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>More</h4>
                    <ul>
                        <li><a href='/articles'>Articles & Whitepapers</a></li>
                        <li><a href='/sitemap2'>Sitemap</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-disclaimer">
                <p>This tool offers general guidance. Results should be reviewed for accuracy and compliance with relevant project standards and regulations before use.</p>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Design Calculators. Created by <span style="color: var(--secondary); font-weight: bold;">A Sharma</span>. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        // --- CONSTANTS & DATA ---
        
        const SEAT_LOADS = {
            'II': 25,
            'IV': 50, 
            'V': 100, 
            'VI': 30  
        };

        const PACKING_FRICTION = {
            'ptfe': 100,
            'graphite': 400
        };

        const FLUID_FACTORS = {
            'clean': 1.0,
            'dry': 1.2,
            'slurry': 1.5
        };

        let myChart = null;
        let lastResult = null;

        // --- UI LOGIC ---

        function toggleInputs() {
            const type = document.getElementById('valve-type').value;
            if (type === 'linear') {
                document.getElementById('linear-inputs').style.display = 'block';
                document.getElementById('rotary-inputs').style.display = 'none';
                document.getElementById('act-linear-inputs').style.display = 'block';
                document.getElementById('act-rotary-inputs').style.display = 'none';
            } else {
                document.getElementById('linear-inputs').style.display = 'none';
                document.getElementById('rotary-inputs').style.display = 'block';
                document.getElementById('act-linear-inputs').style.display = 'none';
                document.getElementById('act-rotary-inputs').style.display = 'block';
            }
        }

        function loadPreset(type) {
            if (type === 'utility') {
                document.getElementById('valve-type').value = 'linear';
                toggleInputs();
                document.getElementById('port-dia').value = '3.0';
                document.getElementById('stem-dia').value = '0.75';
                document.getElementById('packing-type').value = 'ptfe';
                document.getElementById('shutoff-dp').value = '60';
                document.getElementById('leakage-class').value = 'IV';
                document.getElementById('act-area').value = '60';
                document.getElementById('spring-min').value = '6';
                document.getElementById('spring-max').value = '30';
                document.getElementById('air-supply').value = '35';
                document.getElementById('fail-action').value = 'fc';
                document.getElementById('fluid-service').value = 'clean';
            } else if (type === 'severe') {
                document.getElementById('valve-type').value = 'linear';
                toggleInputs();
                document.getElementById('port-dia').value = '4.0';
                document.getElementById('stem-dia').value = '1.0';
                document.getElementById('packing-type').value = 'graphite';
                document.getElementById('shutoff-dp').value = '500';
                document.getElementById('leakage-class').value = 'V';
                document.getElementById('act-area').value = '200';
                document.getElementById('spring-min').value = '15';
                document.getElementById('spring-max').value = '45'; 
                document.getElementById('air-supply').value = '60';
                document.getElementById('fail-action').value = 'fc';
                document.getElementById('fluid-service').value = 'dry';
            } else if (type === 'ball_onoff') {
                document.getElementById('valve-type').value = 'rotary';
                toggleInputs();
                document.getElementById('ball-dia').value = '6.0';
                document.getElementById('shaft-dia').value = '1.5';
                document.getElementById('shutoff-dp').value = '150';
                document.getElementById('safety-factor').value = '1.5';
                document.getElementById('rotary-act-type').value = 'rack';
                document.getElementById('torque-start').value = '5000';
                document.getElementById('torque-end').value = '3500';
                document.getElementById('fluid-service').value = 'clean';
            }
            showMessage('Scenario Loaded');
        }

        function showMessage(msg) {
            const box = document.getElementById('message-box');
            box.innerText = msg;
            box.style.background = 'var(--secondary)';
            box.style.display = 'block';
            setTimeout(() => { box.style.display = 'none'; }, 3000);
        }

        // --- CALCULATION ENGINE ---

        function calculate() {
            const type = document.getElementById('valve-type').value;
            if (type === 'linear') calcLinear();
            else calcRotary();
        }

        function calcLinear() {
            // Inputs
            const portDia = parseFloat(document.getElementById('port-dia').value);
            const stemDia = parseFloat(document.getElementById('stem-dia').value);
            const packType = document.getElementById('packing-type').value;
            const fluidService = document.getElementById('fluid-service').value;
            const fluidFactor = FLUID_FACTORS[fluidService];
            
            const dp = parseFloat(document.getElementById('shutoff-dp').value);
            const leakClass = document.getElementById('leakage-class').value;
            const safety = parseFloat(document.getElementById('safety-factor').value);
            
            const failAction = document.getElementById('fail-action').value;
            const actArea = parseFloat(document.getElementById('act-area').value);
            const airSupply = parseFloat(document.getElementById('air-supply').value);
            const springMin = parseFloat(document.getElementById('spring-min').value);
            const springMax = parseFloat(document.getElementById('spring-max').value);

            // Forces
            const seatArea = Math.PI * Math.pow(portDia/2, 2);
            const seatCirc = Math.PI * portDia;
            
            const fUnbalance = seatArea * dp;
            const fPacking = PACKING_FRICTION[packType] * stemDia * fluidFactor; // Apply fluid factor to packing
            const fSeat = seatCirc * SEAT_LOADS[leakClass];
            
            let fReqRaw = fUnbalance + fPacking + fSeat;
            const fReqTotal = fReqRaw * safety;

            // Actuator
            let fSeatAvail = 0;
            if (failAction === 'fc') {
                fSeatAvail = actArea * springMin; 
            } else {
                fSeatAvail = (airSupply * actArea) - (springMax * actArea);
            }

            const margin = fSeatAvail / fReqTotal;
            const passed = margin >= 1.0;

            lastResult = {
                type: 'Linear', portDia, dp, fUnbalance, fPacking, fSeat, fReqTotal, fSeatAvail, margin, failAction, unit: 'lbf'
            };

            updateUI(passed, margin, fReqTotal, fSeatAvail, 'lbf');
            
            // Enhanced Steps HTML
            let steps = `<h5>Detailed Linear Sizing Calculations:</h5>`;
            
            steps += `<div class="calculation-step">`;
            steps += `<strong>Step 1: Valve Geometry</strong><br>`;
            steps += `Calculate the effective area and circumference of the seat ring.<br>`;
            steps += `$$ A_{seat} = \\pi \\times (\\frac{D_{port}}{2})^2 = \\pi \\times (\\frac{${portDia}}{2})^2 = \\mathbf{${seatArea.toFixed(3)} \\text{ in}^2} $$<br>`;
            steps += `$$ C_{seat} = \\pi \\times D_{port} = \\pi \\times ${portDia} = \\mathbf{${seatCirc.toFixed(2)} \\text{ in}} $$`;
            steps += `</div>`;

            steps += `<div class="calculation-step">`;
            steps += `<strong>Step 2: Unbalance Force ($F_{unb}$)</strong><br>`;
            steps += `The hydrostatic force acting on the valve plug due to differential pressure.<br>`;
            steps += `$$ F_{unb} = A_{seat} \\times \\Delta P_{shutoff} $$<br>`;
            steps += `$$ F_{unb} = ${seatArea.toFixed(3)} \\times ${dp} = \\mathbf{${Math.round(fUnbalance)} \\text{ lbf}} $$`;
            steps += `</div>`;

            steps += `<div class="calculation-step">`;
            steps += `<strong>Step 3: Frictional Forces</strong><br>`;
            steps += `<em>Packing Friction:</em> Based on ${packType} packing and Fluid Service Factor (${fluidFactor}).<br>`;
            steps += `$$ F_{pack} = \\text{FricFactor} \\times D_{stem} \\times \\text{FluidFactor} $$<br>`;
            steps += `$$ F_{pack} = ${PACKING_FRICTION[packType]} \\times ${stemDia} \\times ${fluidFactor} = \\mathbf{${Math.round(fPacking)} \\text{ lbf}} $$<br><br>`;
            steps += `<em>Seat Load:</em> Force required to achieve Class ${leakClass} shutoff.<br>`;
            steps += `$$ F_{seat} = C_{seat} \\times \\text{LoadFactor} $$<br>`;
            steps += `$$ F_{seat} = ${seatCirc.toFixed(2)} \\times ${SEAT_LOADS[leakClass]} = \\mathbf{${Math.round(fSeat)} \\text{ lbf}} $$`;
            steps += `</div>`;

            steps += `<div class="calculation-step">`;
            steps += `<strong>Step 4: Total Required Thrust</strong><br>`;
            steps += `Summing all forces and applying Safety Factor (SF = ${safety}).<br>`;
            steps += `$$ F_{req} = (F_{unb} + F_{pack} + F_{seat}) \\times SF $$<br>`;
            steps += `$$ F_{req} = (${Math.round(fUnbalance)} + ${Math.round(fPacking)} + ${Math.round(fSeat)}) \\times ${safety} = \\mathbf{${Math.round(fReqTotal)} \\text{ lbf}} $$`;
            steps += `</div>`;

            steps += `<div class="calculation-step" style="border-left-color: var(--primary);">`;
            steps += `<strong>Step 5: Available Actuator Thrust</strong><br>`;
            if (failAction === 'fc') {
                steps += `<strong>Fail Closed (Air-to-Open):</strong> The valve is held closed by the spring preload. We must ensure the spring is strong enough to hold the seat load.<br>`;
                steps += `$$ F_{avail} = A_{act} \\times P_{bench\_min} $$<br>`;
                steps += `$$ F_{avail} = ${actArea} \\times ${springMin} = \\mathbf{${Math.round(fSeatAvail)} \\text{ lbf}} $$`;
            } else {
                steps += `<strong>Fail Open (Air-to-Close):</strong> The valve is forced closed by air pressure fighting the spring. The critical point is full travel (seat) where the spring is compressed the most.<br>`;
                steps += `$$ F_{avail} = (P_{supply} \\times A_{act}) - (P_{bench\_max} \\times A_{act}) $$<br>`;
                steps += `$$ F_{avail} = (${airSupply} \\times ${actArea}) - (${springMax} \\times ${actArea}) = \\mathbf{${Math.round(fSeatAvail)} \\text{ lbf}} $$`;
            }
            steps += `</div>`;
            document.getElementById('step-by-step-container').innerHTML = steps;
            
            generateAssessment(passed, margin, 'Thrust');
            
            // Render MathJax AFTER content update
            if(window.MathJax) window.MathJax.typesetPromise([document.getElementById('step-by-step-container')]);
        }

        function calcRotary() {
            // Inputs
            const ballDia = parseFloat(document.getElementById('ball-dia').value);
            const shaftDia = parseFloat(document.getElementById('shaft-dia').value);
            const offset = parseFloat(document.getElementById('offset').value);
            const bearingCoeff = parseFloat(document.getElementById('bearing-coeff').value);
            const fluidService = document.getElementById('fluid-service').value;
            const fluidFactor = FLUID_FACTORS[fluidService];
            
            const dp = parseFloat(document.getElementById('shutoff-dp').value);
            const safety = parseFloat(document.getElementById('safety-factor').value);
            
            // Actuator
            const tStart = parseFloat(document.getElementById('torque-start').value);
            const tEnd = parseFloat(document.getElementById('torque-end').value);
            const failAction = document.getElementById('fail-action').value;

            // Physics (Simplified Industrial Models)
            const ballArea = Math.PI * Math.pow(ballDia/2, 2);
            
            // 1. Bearing Torque: Load * Radius * friction
            // Load is roughly Area * dP
            const pressLoad = ballArea * dp;
            const tBearing = pressLoad * (shaftDia/2) * bearingCoeff * fluidFactor; // Fluid factor affects bearing too for slurry
            
            // 2. Seat Torque (Empirical approx for generic ball)
            // T_seat ~ Dia^2 * dP * coeff
            // We'll use a simplified model: Seat friction is often ~20-30% of total for floating ball
            // Let's use a coefficient model: Coeff * dP * r^2
            const seatCoeff = 0.05 * fluidFactor; 
            const tSeat = ballDia * dp * seatCoeff * (ballDia/2); 
            
            // 3. Packing Torque
            const tPacking = 200 * shaftDia * fluidFactor; // Approximate

            const tRaw = tBearing + tSeat + tPacking;
            const tReqTotal = tRaw * safety;

            // Actuator Torque (Spring Return)
            // Fail Closed: Spring Close. Min Torque is Spring End (compressed? no extended).
            // Actually: 
            // FC (Air to Open): Spring closes it. We need Spring END torque (fully relaxed) or START (compressed)?
            // Breakout (Closed): Spring is extended (lowest torque) -> Spring End value usually lower.
            // Let's assume user inputs standard "Spring End" as the lowest torque.
            
            let tAvail = 0;
            if (failAction === 'fc') tAvail = tEnd; // Spring Torque at end of stroke (lowest)
            else tAvail = tEnd; // Fail Open: Air closes? No, Spring closes. Same logic.
            // Actually for sizing, compare worst case.
            // Let's assume T_End is the minimum available torque from the actuator at the critical point.
            
            const margin = tAvail / tReqTotal;
            const passed = margin >= 1.0;

            lastResult = {
                type: 'Rotary', ballDia, dp, tBearing, tSeat, tPacking, tReqTotal, tAvail, margin, failAction, unit: 'in-lb'
            };

            updateUI(passed, margin, tReqTotal, tAvail, 'in-lb');

            // Steps HTML
            let steps = `<h5>Detailed Rotary Torque Calculations:</h5>`;
            
            steps += `<div class="calculation-step">`;
            steps += `<strong>Step 1: Bearing Torque ($T_{bearing}$)</strong><br>`;
            steps += `Friction in the shaft bearings caused by differential pressure load.<br>`;
            steps += `$$ F_{load} = Area_{ball} \\times \\Delta P = \\pi (\\frac{${ballDia}}{2})^2 \\times ${dp} = ${Math.round(pressLoad)} \\text{ lbf} $$<br>`;
            steps += `$$ T_{bearing} = F_{load} \\times \\frac{D_{shaft}}{2} \\times \\mu_{bearing} $$<br>`;
            steps += `$$ T_{bearing} = ${Math.round(pressLoad)} \\times ${shaftDia/2} \\times ${bearingCoeff} = \\mathbf{${Math.round(tBearing)} \\text{ in-lb}} $$`;
            steps += `</div>`;

            steps += `<div class="calculation-step">`;
            steps += `<strong>Step 2: Seat & Packing Friction</strong><br>`;
            steps += `<em>Seat Torque:</em> Friction between the ball and seat ring (Floating Ball Model).<br>`;
            steps += `$$ T_{seat} \\approx D_{ball} \\times \\Delta P \\times \\text{Coeff} \\times R_{ball} = \\mathbf{${Math.round(tSeat)} \\text{ in-lb}} $$<br><br>`;
            steps += `<em>Packing Torque:</em> Friction from the stem seal (Graphite/PTFE).<br>`;
            steps += `$$ T_{pack} \\approx 200 \\times D_{shaft} \\times \\text{FluidFactor} = \\mathbf{${Math.round(tPacking)} \\text{ in-lb}} $$`;
            steps += `</div>`;

            steps += `<div class="calculation-step">`;
            steps += `<strong>Step 3: Total Required Torque</strong><br>`;
            steps += `Summing component torques and applying Safety Factor (SF = ${safety}).<br>`;
            steps += `$$ T_{req} = (T_{bearing} + T_{seat} + T_{pack}) \\times SF $$<br>`;
            steps += `$$ T_{req} = (${Math.round(tBearing)} + ${Math.round(tSeat)} + ${Math.round(tPacking)}) \\times ${safety} = \\mathbf{${Math.round(tReqTotal)} \\text{ in-lb}} $$`;
            steps += `</div>`;

            steps += `<div class="calculation-step" style="border-left-color: var(--primary);">`;
            steps += `<strong>Step 4: Actuator Capability</strong><br>`;
            steps += `Comparing against the minimum torque point of the spring-return actuator (Spring End).<br>`;
            steps += `$$ T_{avail} = T_{spring\_end} = \\mathbf{${Math.round(tAvail)} \\text{ in-lb}} $$`;
            steps += `</div>`;
            
            document.getElementById('step-by-step-container').innerHTML = steps;
            
            generateAssessment(passed, margin, 'Torque');
            
            // Render MathJax AFTER content update
            if(window.MathJax) window.MathJax.typesetPromise([document.getElementById('step-by-step-container')]);
        }

        function updateUI(passed, margin, req, avail, unit) {
            document.getElementById('results-area').style.opacity = '1';
            document.getElementById('results-area').style.pointerEvents = 'all';
            
            document.getElementById('lbl-req').innerText = `Req. ${unit === 'lbf' ? 'Thrust' : 'Torque'}`;
            document.getElementById('lbl-avail').innerText = `Avail. ${unit === 'lbf' ? 'Thrust' : 'Torque'}`;

            document.getElementById('res-req').innerText = Math.round(req) + " " + unit;
            document.getElementById('res-avail').innerText = Math.round(avail) + " " + unit;
            
            const marginEl = document.getElementById('res-margin');
            marginEl.innerText = margin.toFixed(2);
            marginEl.className = "kpi-value " + (passed ? "kpi-pass" : "kpi-fail");

            drawChart(req, avail, unit);
            document.getElementById('results-area').scrollIntoView({ behavior: 'smooth' });
        }

        function generateAssessment(passed, margin, type) {
            let assessHTML = `<strong>Engineering Analysis:</strong><br>`;
            if (passed) {
                assessHTML += `<span style="color:var(--success)"><strong>PASS: Sizing Successful.</strong></span> The actuator provides a safety margin of ${(margin).toFixed(2)} (Target > 1.0). This accounts for aging and fluid service conditions.`;
            } else {
                assessHTML += `<span style="color:var(--danger)"><strong>FAIL: Undersized Actuator.</strong></span> The required ${type} exceeds the available output. <br><strong>Recommendations:</strong><br>1. Increase Actuator Size/Spring.<br>2. Check if a lower leakage class is acceptable.<br>3. Verify supply pressure stability.`;
            }
            document.getElementById('assessment-text').innerHTML = assessHTML;
        }

        function drawChart(req, avail, unit) {
            const ctx = document.getElementById('forceChart').getContext('2d');
            if (myChart) myChart.destroy();
            
            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Required', 'Available'],
                    datasets: [{
                        label: unit,
                        data: [req, avail],
                        backgroundColor: ['rgba(100, 116, 139, 0.7)', req <= avail ? 'rgba(16, 185, 129, 0.7)' : 'rgba(220, 38, 38, 0.7)'],
                        borderColor: ['rgba(100, 116, 139, 1)', req <= avail ? 'rgba(16, 185, 129, 1)' : 'rgba(220, 38, 38, 1)'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, title: {display: true, text: unit} } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function generatePDF() {
            if (!lastResult) { alert("Calculate first!"); return; }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const r = lastResult;
            
            doc.setFillColor(30, 58, 138);
            doc.rect(0, 0, 210, 20, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(16);
            doc.text("Actuator Sizing Report", 105, 13, { align: 'center' });
            
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(10);
            doc.text(`Date: ${new Date().toLocaleString()}`, 14, 30);
            
            doc.autoTable({
                startY: 40,
                head: [['Parameter', 'Value', 'Unit']],
                body: [
                    ['Valve Type', r.type, '-'],
                    ['Required Output', Math.round(r.tReqTotal || r.fReqTotal), r.unit],
                    ['Available Output', Math.round(r.tAvail || r.fSeatAvail), r.unit],
                    ['Margin Ratio', r.margin.toFixed(2), '-']
                ],
                theme: 'grid',
                headStyles: { fillColor: [30, 58, 138] },
                didParseCell: function(data) {
                    if(data.row.index === 3) {
                        data.cell.styles.fontStyle = 'bold';
                        data.cell.styles.textColor = r.margin < 1.0 ? [220, 38, 38] : [16, 185, 129];
                    }
                }
            });
            
            doc.save("Valve_Sizing_Report.pdf");
        }
    </script>
</body>
</html>
