<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-Main">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Industrial Furnace Performance Analyzer (Direct & Indirect Method)</title>
<meta name="description" content="A professional-grade calculator for industrial furnaces, performing both Direct (Input-Output) and Indirect (Heat Loss) efficiency analysis per API/ASME principles.">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5936527763614780" crossorigin="anonymous"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-23Y1V450SR"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-23Y1V450SR');
</script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Montserrat:wght@700;800;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- MathJax for LaTeX rendering -->
<script type="text/javascript" id="MathJax-script" async
src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<script>
// MathJax configuration to support inline and display LaTeX
MathJax = {
tex: {
inlineMath: [['$', '$'], ['\\(', '\\)']],
displayMath: [['$$', '$$'], ['\\[', '\\]']],
processEscapes: true
},
svg: {fontCache: 'global'}
};
</script>
<style>
/* Base Styles */
:root {
--primary-color: #1E3A8A; /* Professional Dark Blue */
--secondary-color: #2563EB; /* Bright Blue */
--accent-color: #F59E0B; /* Warm Amber */
--bg-color: #F8FAFC;
--card-bg: #FFFFFF;
--text-color: #4B5563;
--heading-color: #111827;
--footer-bg: #0F172A;
--border-color: #E2E8F0;
--gradient-primary: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
--gradient-dark: linear-gradient(135deg, #0F172A, #1E293B);
--card-shadow: 0 10px 25px rgba(0, 0, 0, 0.1), 0 5px 10px rgba(0, 0, 0, 0.04);
--hover-color: #eef2ff;
--button-hover-shadow: 0 7px 20px rgba(37, 99, 235, 0.4);
--highlight-bg: rgba(245, 158, 11, 0.15);
--success-color: #10B981;
--fail-color: #EF4444;
--warning-color: #F59E0B;
--primary-color-rgb: 30, 58, 138;
}

body.dark-mode {
--primary-color: #10B981;
--secondary-color: #34D399;
--bg-color: #0F172A;
--card-bg: #1E293B;
--text-color: #CBD5E1;
--heading-color: #F1F5F9;
--footer-bg: #020617;
--border-color: #334155;
--highlight-bg: rgba(16, 185, 129, 0.2);
--hover-color: #334155;
--button-hover-shadow: 0 7px 20px rgba(16, 185, 129, 0.3);
--primary-color-rgb: 16, 185, 129;
}

html { scroll-behavior: smooth; }

body {
font-family: 'Inter', sans-serif;
margin: 0;
padding: 0;
background-color: var(--bg-color);
color: var(--text-color);
line-height: 1.6;
transition: background-color 0.3s, color 0.3s;
}

.container { max-width: 1280px; margin: 0 auto; padding: 0 24px; }
.content-container { max-width: 1100px; margin: 0 auto; padding: 20px; }

/* --- NEW HEADER STYLES --- */
.header {
background: var(--gradient-primary);
color: white;
padding: 24px 0;
box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.navbar {
display: flex;
justify-content: space-between;
align-items: center;
}

.logo-container {
display: flex;
align-items: center;
gap: 16px;
text-decoration: none;
color: white;
}

.logo-text {
font-size: 1.75rem;
font-weight: 800;
font-family: 'Montserrat', sans-serif;
}

.nav-links {
display: flex;
gap: 24px;
list-style: none;
margin: 0;
padding: 0;
}

.nav-links a {
color: white;
text-decoration: none;
font-weight: 500;
transition: all 0.3s;
}

.nav-links a:hover {
color: var(--accent-color);
transform: translateY(-2px);
}

.theme-toggle {
display: flex;
align-items: center;
gap: 12px;
}

.theme-toggle .icon {
color: white;
font-size: 1.2rem;
}

.switch {
position: relative;
display: inline-block;
width: 56px;
height: 30px;
}

.switch input { opacity: 0; width: 0; height: 0; }

.slider {
position: absolute;
cursor: pointer;
top: 0;
left: 0;
right: 0;
bottom: 0;
background-color: rgba(0,0,0,0.2);
transition: .4s;
border-radius: 30px;
}

.slider:before {
position: absolute;
content: "";
height: 22px;
width: 22px;
left: 4px;
bottom: 4px;
background-color: white;
transition: .4s;
border-radius: 50%;
}

input:checked + .slider { background-color: var(--accent-color); }
input:checked + .slider:before { transform: translateX(26px); }
/* --- END OF NEW HEADER STYLES --- */


main { padding: 40px 0; }

.tool-container {
background-color: var(--card-bg);
border-radius: 12px;
padding: 30px;
box-shadow: var(--card-shadow);
margin-bottom: 30px;
}

.tool-container h2 {
color: var(--primary-color);
border-bottom: 3px solid var(--primary-color);
padding-bottom: 15px;
margin-top: 0;
margin-bottom: 25px;
font-family: 'Montserrat', sans-serif;
font-size: 1.8rem;
}

/* Added styles for new content */
.tool-container h3 {
color: var(--primary-color);
margin-top: 25px;
font-family: 'Montserrat', sans-serif;
}
.tool-container p {
margin-bottom: 15px;
}
.tool-container ul, .tool-container ol {
padding-left: 20px;
margin-bottom: 15px;
}
.tool-container li {
margin-bottom: 10px;
}
.tool-container h4 {
color: var(--secondary-color);
margin-top: 20px;
font-family: 'Montserrat', sans-serif;
}
/* End of added styles */


.tool-description {
margin-bottom: 25px;
color: var(--text-color);
font-size: 1.05em;
background-color: var(--hover-color);
border-radius: 8px;
padding: 20px;
border-left: 5px solid var(--primary-color);
}
.tool-description ul {
list-style-type: disc;
margin-left: 20px;
padding-left: 0;
margin-top: 15px;
}
.tool-description ul li {
margin-bottom: 8px;
}
.tool-description strong {
color: var(--primary-color);
}

.back-button {
display: inline-block;
background-color: var(--primary-color);
color: white;
padding: 12px 20px;
border-radius: 8px;
text-decoration: none;
margin-bottom: 25px;
transition: background-color 0.3s, transform 0.2s;
font-weight: 600;
}

.back-button:hover {
background-color: var(--secondary-color);
transform: translateY(-2px);
}

.calculator-form {
background-color: var(--card-bg);
border-radius: 8px;
padding: 25px;
margin-top: 25px;
box-shadow: 0 4px 15px rgba(0,0,0,0.05);
}

.form-section-header {
font-size: 1.2rem;
font-weight: 700;
color: var(--primary-color);
margin-top: 25px;
margin-bottom: 15px;
padding-bottom: 8px;
border-bottom: 2px solid var(--border-color);
}

.form-group {
margin-bottom: 20px;
}

.form-group label {
display: flex;
align-items: center;
margin-bottom: 8px;
font-weight: 600;
color: var(--heading-color);
}

.form-group input, .form-group select {
width: 100%;
padding: 12px 15px;
border: 1px solid var(--border-color);
border-radius: 8px;
background-color: var(--bg-color);
color: var(--text-color);
box-sizing: border-box;
font-size: 1em;
transition: border-color 0.3s, box-shadow 0.3s;
box-shadow: inset 0 1px 3px rgba(0,0,0,0.08);
}

.form-group input:focus, .form-group select:focus {
border-color: var(--primary-color);
box-shadow: 0 0 0 3px rgba(var(--primary-color-rgb), 0.3);
outline: none;
}

.radio-group {
display: flex;
gap: 20px;
margin-bottom: 15px;
flex-wrap: wrap;
}

.radio-group label {
display: flex;
align-items: center;
cursor: pointer;
font-weight: normal;
margin-bottom: 0;
}

.radio-group input[type="radio"] {
width: auto;
margin-right: 8px;
accent-color: var(--primary-color);
}

.form-row {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
gap: 20px;
}

.calculate-btn {
background-image: var(--gradient-primary);
color: white;
border: none;
padding: 18px 25px;
border-radius: 8px;
cursor: pointer;
font-size: 1.2rem;
font-weight: bold;
font-family: 'Montserrat', sans-serif;
margin-top: 20px;
transition: transform 0.2s ease-in-out, box-shadow 0.3s ease-in-out;
box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
width: 100%;
}

.calculate-btn:hover {
transform: translateY(-3px) scale(1.02);
box-shadow: var(--button-hover-shadow);
}

.result-container {
margin-top: 40px;
padding: 30px;
border-radius: 12px;
background-color: var(--card-bg);
box-shadow: var(--card-shadow);
opacity: 0;
transform: translateY(30px);
transition: opacity 0.6s ease-out, transform 0.6s ease-out;
display: none; /* Initially hidden */
}

.result-container.show {
display: block;
opacity: 1;
transform: translateY(0);
}

.result-container h3 {
color: var(--primary-color);
margin-bottom: 25px;
font-family: 'Montserrat', sans-serif;
font-size: 1.8rem;
text-align: center;
}

.result-table {
width: 100%;
border-collapse: collapse;
margin-top: 20px;
}

.result-table th, .result-table td {
padding: 15px;
text-align: left;
border-bottom: 1px solid var(--border-color);
}

.result-table th {
background-color: var(--hover-color);
font-weight: 600;
color: var(--heading-color);
font-size: 1.1em;
}

.result-table tr:last-child td {
border-bottom: none;
}

/* Special styling for key results */
.result-table .highlight-row td {
font-weight: bold;
color: var(--primary-color);
background-color: var(--highlight-bg);
font-size: 1.1rem;
}

.result-table .discrepancy-row td {
font-weight: bold;
color: var(--warning-color);
background-color: rgba(245, 158, 11, 0.1);
font-size: 1.1rem;
}


.standard-reference {
margin-top: 25px;
font-style: italic;
font-size: 0.95rem;
line-height: 1.5;
padding: 20px;
background-color: var(--bg-color);
border-radius: 8px;
border: 1px solid var(--border-color);
}
.standard-reference ul {
list-style-type: disc;
margin-left: 20px;
padding-left: 0;
margin-top: 10px;
}
.standard-reference li {
margin-bottom: 8px;
}


.info-icon {
color: var(--secondary-color);
margin-left: 8px;
cursor: help;
font-size: 0.9em;
}

.tooltip {
position: relative;
display: inline-block;
}

.tooltip .tooltiptext {
visibility: hidden;
width: 280px;
background-color: #333;
color: #fff;
text-align: left;
line-height: 1.4;
border-radius: 8px;
padding: 10px;
position: absolute;
z-index: 10;
bottom: 135%;
left: 50%;
margin-left: -140px;
opacity: 0;
transition: opacity 0.3s;
font-weight: normal;
font-size: 0.9rem;
}

.tooltip .tooltiptext::after {
content: "";
position: absolute;
top: 100%;
left: 50%;
margin-left: -5px;
border-width: 5px;
border-style: solid;
border-color: #333 transparent transparent transparent;
}

.tooltip:hover .tooltiptext {
visibility: visible;
opacity: 1;
}

#custom-message-box {
position: fixed;
top: 20px;
left: 50%;
transform: translateX(-50%);
padding: 18px 30px;
border-radius: 10px;
box-shadow: 0 6px 15px rgba(0,0,0,0.3);
z-index: 1000;
font-weight: bold;
color: white;
opacity: 0;
visibility: hidden;
transition: opacity 0.5s ease-in-out, visibility 0.5s, background-color 0.3s;
font-size: 1.1em;
}
#custom-message-box.show {
opacity: 1;
visibility: visible;
}
#custom-message-box.info {
background-color: var(--success-color);
}
#custom-message-box.error {
background-color: var(--fail-color);
}
#custom-message-box.warning {
background-color: var(--warning-color);
color: #333;
}

#calculation-details {
background-color: var(--bg-color);
border: 1px solid var(--border-color);
border-radius: 8px;
padding: 20px;
margin-bottom: 25px;
font-size: 0.98em;
overflow-x: auto;
}

#calculation-details h4 {
color: var(--secondary-color);
margin-top: 0;
margin-bottom: 15px;
font-size: 1.3em;
}

#calculation-details p.formula {
font-family: 'Times New Roman', serif;
font-style: italic;
font-size: 1.2em;
text-align: center;
padding: 12px;
background-color: var(--hover-color);
border-radius: 6px;
margin: 15px 0;
border: 1px dashed var(--border-color);
overflow-x: auto;
white-space: nowrap;
}

#calculation-details p.calculation-step {
font-family: 'Courier New', monospace;
background-color: var(--hover-color);
padding: 8px 12px;
border-radius: 5px;
margin-bottom: 8px;
font-size: 0.95em;
overflow-x: auto;
white-space: normal;
word-wrap: break-word;
}
#calculation-details ul {
list-style-type: disc;
margin-left: 25px;
padding-left: 0;
}
#calculation-details ul li {
margin-bottom: 5px;
}

input:required:invalid {
border-color: var(--fail-color);
}
input:required:valid {
border-color: var(--success-color);
}

@media (max-width: 768px) {
.navbar { flex-direction: column; gap: 24px; }
.nav-links { flex-direction: column; gap: 12px; text-align: center; }
.form-row { grid-template-columns: 1fr; }
.container, .content-container { padding: 0 15px; }
.tool-container { padding: 20px; }
.tooltip .tooltiptext { width: 200px; margin-left: -100px; }
.footer-content { flex-direction: column; }
}
</style>
</head>
<body>

<!-- HEADER (Replaced) -->
<header class="header">
<div class="container">
<nav class="navbar">
<a href="/" class="logo-container">
<span class="logo-text">Design Calculators</span>
</a>
<ul class="nav-links">
<li><a href="/">Home</a></li>
<li><a href='/indexmech.html'>Mechanical</a></li>
<li><a href='/indexele.html'>Electrical</a></li>
<li><a href='/indexinst.html'>Instrumentation</a></li>
</ul>
<div class="theme-toggle">
<i class="fas fa-sun icon"></i>
<label class="switch">
<input type="checkbox" id="theme-switch">
<span class="slider"></span>
</label>
<i class="fas fa-moon icon"></i>
</div>
</nav>
</div>
</header>

<main class="content-container">
<div class="tool-container">
<h2>Furnace Performance Analyzer (Direct & Indirect Method)</h2>
<div class="tool-description">
<p>This comprehensive tool determines the <strong>Heat Duty</strong> (heat absorbed) and <strong>Thermal Efficiency</strong> of an industrial furnace using two independent, industry-standard methods. This hybrid approach is essential for accurate performance monitoring and troubleshooting.</p>
<p><strong>1. Direct Method (Input-Output):</strong></p>
<ul>
<li>Calculates heat duty ($\small Q_{output, direct}$) directly from the process fluid's measured flow rate and energy change (enthalpy or temp/Cp).</li>
<li>Provides a direct measure of the heat *actually absorbed* by the process.</li>
</ul>
<p><strong>2. Indirect Method (Heat Loss):</strong></p>
<ul>
<li>Calculates the heat *lost* from the system, primarily through stack gases (Dry Gas and Water Vapor) and casing radiation.</li>
<li>Requires flue gas analysis (O2, Temp) and fuel composition.</li>
<li>Heat Duty is then calculated as: $\small Q_{output, indirect} = Q_{input, fuel} - Q_{losses, total}$.</li>
<li>This method is the basis for standards like <strong>ASME PTC 4</strong> and is often more accurate as loss measurements can be more precise than process-side flow.</li>
</ul>
<p><strong>Industrial Reconciliation:</strong></p>
<p>The tool's primary power lies in comparing the two results. The <strong>Discrepancy (Unaccounted Loss)</strong> is a critical diagnostic metric. A large discrepancy often indicates instrumentation errors (e.g., flow meters, thermocouples) or significant unmeasured losses (e.g., large air leaks, casing damage, incomplete combustion).</p>
</div>

<div class="calculator-form">
<form id="furnace-calculator-form">
<div class="form-section-header">1. General Parameters</div>
<div class="form-row">
<div class="form-group">
<label for="unit-system">Unit System: <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Select Metric (kg, kJ, °C) or Imperial (lb, BTU, °F).</span></span></label>
<select id="unit-system" required>
<option value="metric">Metric (kg/hr, kJ/kg, °C)</option>
<option value="imperial">Imperial (lb/hr, BTU/lb, °F)</option>
</select>
</div>
</div>

<div class="form-section-header">2. Fuel Input Parameters</div>
<div class="form-row">
<div class="form-group">
<label for="fuel-input-rate">Fuel Mass Flow Rate ($\small M_{fuel}$) <span class="fuel-rate-unit">(kg/hr)</span>: <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Mass flow rate of fuel supplied to the furnace. Ensure accurate measurement from flow meters.</span></span></label>
<input type="number" id="fuel-input-rate" step="any" value="500" required min="0.01">
</div>
<div class="form-group">
<label for="fuel-hhv">Fuel HHV <span class="hhv-unit">(kJ/kg)</span>: <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Higher Heating Value (Gross Calorific Value) of the fuel. Use measured HHV from reliable fuel analysis (e.g., ASTM standards).</span></span></label>
<input type="number" id="fuel-hhv" step="any" value="45000" required min="0.01">
</div>
</div>

<div class="form-section-header">3. Process Fluid Parameters (Direct Method)</div>
<div class="form-row">
<div class="form-group">
<label for="fluid-mass-flow">Process Fluid Mass Flow Rate ($\small M_{fluid}$) <span class="fluid-rate-unit">(kg/hr)</span>: <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Mass flow rate of the fluid being heated inside the furnace coils. Obtain from process data sheets and flow meters.</span></span></label>
<input type="number" id="fluid-mass-flow" step="any" value="10000" required min="0.01">
</div>
</div>
<div class="form-group">
<label>Process Fluid Data Input Type:</label>
<div class="radio-group">
<label>
<input type="radio" name="fluid-input-type" value="enthalpy" checked>
Enthalpies (for phase change or high accuracy)
</label>
<label>
<input type="radio" name="fluid-input-type" value="temperature-cp">
Temperatures & Specific Heat (for sensible heat)
</label>
</div>
</div>
<div id="enthalpy-inputs" class="form-row">
<div class="form-group">
<label for="enthalpy-in">Inlet Enthalpy (h<sub>in</sub>) <span class="enthalpy-unit">(kJ/kg)</span>: <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Specific enthalpy of process fluid at inlet. Obtain from thermodynamic tables or process simulation software.</span></span></label>
<input type="number" id="enthalpy-in" step="any" value="200" required min="0">
</div>
<div class="form-group">
<label for="enthalpy-out">Outlet Enthalpy (h<sub>out</sub>) <span class="enthalpy-unit">(kJ/kg)</span>: <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Specific enthalpy of process fluid at outlet. Obtain from thermodynamic tables or process simulation software.</span></span></label>
<input type="number" id="enthalpy-out" step="any" value="1500" required min="0.01">
</div>
</div>
<div id="temperature-cp-inputs" class="form-row" style="display: none;">
<div class="form-group">
<label for="temperature-in">Inlet Temperature (T<sub>in</sub>) <span class="temp-unit">(°C)</span>: <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Inlet temperature of process fluid. Ensure accurate measurement.</span></span></label>
<input type="number" id="temperature-in" step="any" value="30" required>
</div>
<div class="form-group">
<label for="temperature-out">Outlet Temperature (T<sub>out</sub>) <span class="temp-unit">(°C)</span>: <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Outlet temperature of process fluid. Ensure accurate measurement.</span></span></label>
<input type="number" id="temperature-out" step="any" value="300" required>
</div>
<div class="form-group">
<label for="specific-heat">Specific Heat (C<sub>p</sub>) <span class="cp-unit">(kJ/kg·°C)</span>: <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Average specific heat capacity of the process fluid over the temperature range. For gases, consider temperature dependency.</span></span></label>
<input type="number" id="specific-heat" step="any" value="2.0" required min="0.01">
</div>
</div>

<div class="form-section-header">4. Industrial Analysis (Indirect / Heat Loss Method)</div>
<div class="form-row">
<div class="form-group">
<label for="flue-gas-o2">Flue Gas O<sub>2</sub> (%): <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Percent of Oxygen (O2) in the dry flue gas, measured at the stack. Typically 2-4%.</span></span></label>
<input type="number" id="flue-gas-o2" step="0.1" value="3.0" required min="0" max="21">
</div>
<div class="form-group">
<label for="stack-temp">Stack Temperature ($\small T_{stack}$) <span class="temp-unit">(°C)</span>: <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Flue gas temperature at the stack exit (after any preheaters).</span></span></label>
<input type="number" id="stack-temp" step="any" value="150" required>
</div>
<div class="form-group">
<label for="ambient-temp">Ambient Air Temp ($\small T_{amb}$) <span class="temp-unit">(°C)</span>: <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Inlet temperature of the combustion air.</span></span></label>
<input type="number" id="ambient-temp" step="any" value="25" required>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label for="radiant-loss-pct">Casing Loss (% of Heat Input): <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Estimated percentage of total heat input lost from furnace casing to ambient. API 560 default is 2.5% for T > 1400°F, 2% for T < 1400°F.</span></span></label>
<input type="number" id="radiant-loss-pct" step="0.1" value="2.5" required min="0" max="100">
</div>
</div>

<div class="form-section-header">5. Fuel Composition (Simplified Elemental, % by mass)</div>
<div class="form-row" style="grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));">
<div class="form-group">
<label for="fuel-c">Carbon (%C):</label>
<input type="number" id="fuel-c" class="fuel-comp" step="0.1" value="85.0" required min="0" max="100">
</div>
<div class="form-group">
<label for="fuel-h">Hydrogen (%H):</label>
<input type="number" id="fuel-h" class="fuel-comp" step="0.1" value="12.0" required min="0" max="100">
</div>
<div class="form-group">
<label for="fuel-s">Sulfur (%S):</label>
<input type="number" id="fuel-s" class="fuel-comp" step="0.1" value="0.5" required min="0" max="100">
</div>
<div class="form-group">
<label for="fuel-o">Oxygen (%O):</label>
<input type="number" id="fuel-o" class="fuel-comp" step="0.1" value="1.0" required min="0" max="100">
</div>
<div class="form-group">
<label for="fuel-n">Nitrogen (%N):</label>
<input type="number" id="fuel-n" class="fuel-comp" step="0.1" value="1.0" required min="0" max="100">
</div>
<div class="form-group">
<label for="fuel-water">Water/Inerts (%):</label>
<input type="number" id="fuel-water" class="fuel-comp" step="0.1" value="0.5" required min="0" max="100">
</div>
</div>
<div id="fuel-comp-total" style="text-align: right; font-weight: bold; margin-top: -10px; margin-bottom: 20px;">Total: 100.0%</div>

<button type="button" id="calculate-furnace-btn" class="calculate-btn"><i class="fas fa-fire"></i> Run Performance Analysis</button>
</form>
</div>
<div id="result-container" class="result-container">
<h3>Furnace Performance Analysis</h3>
<div id="calculation-details"></div>
<table class="result-table">
<thead>
<tr>
<th>Parameter</th>
<th>Value</th>
</tr>
</thead>
<tbody id="result-table-body"></tbody>
</table>
<div class="standard-reference" id="standard-reference">
<!-- Content will be populated by JS -->
</div>
</div>
</div>

<!-- START: NEW 800+ WORD EDUCATIONAL CONTENT -->
<div class="tool-container" style="margin-top: 40px;">
<h2>The Fire Within: An Industrial Guide to Furnace Performance</h2>

<h3 style="color: var(--primary-color); margin-top: 25px;">Why the Fired Heater is the Heart of the Plant</h3>
<p>In any refinery, petrochemical plant, or large-scale chemical facility, the fired heater (or furnace) is the heart of the process. It is almost always the single largest consumer of energy, responsible for 50-80% of a plant's total fuel bill. Its primary job is to safely and efficiently transfer an immense amount of thermal energy, liberated from burning fuel, into a process fluid (like crude oil, water, or a chemical feedstock) flowing inside its tubes. </p>
<p>Because its fuel consumption is so massive, furnace efficiency is not just an academic number—it's a primary driver of plant profitability and environmental emissions. A mere 1% increase in efficiency on a large furnace can save millions of dollars and thousands of tons of CO2 per year. This calculator is designed to execute the two primary methods for evaluating this critical performance, just as an engineer would in the field.</p>

<h3 style="color: var(--primary-color); margin-top: 25px;">The "Rulebooks": Applicable International Standards</h3>
<p>Furnace performance testing is not guesswork. It's a rigorous engineering discipline governed by globally recognized standards. This tool's logic is based on the principles from these key documents:</p>
<ul>
<li><strong>API 560 (Fired Heaters for General Refinery Service):</strong> This is the "bible" for the *design, construction, and materials* of new heaters. It specifies everything from tube metallurgy and refractory thickness to burner safety systems and stack design. It also sets the default values for expected losses (e.g., casing/radiant loss).</li>
<li><strong>ASME PTC 4 (Fired Steam Generators):</strong> This is the "Performance Test Code." It is the gold standard *procedure* for how to conduct a furnace efficiency test. It champions the **Indirect Method (or Heat Loss Method)** as the most accurate and reliable way to determine efficiency, as it relies on measuring losses (which are small) rather than the massive inputs and outputs (which are large and prone to instrument error).</li>
<li><strong>ISO 13705:</strong> The international (ISO) equivalent of API 560, codifying these principles for global use.</li>
</ul>

<h3 style="color: var(--primary-color); margin-top: 25px;">The Two Methods: Why One Isn't Enough (Direct vs. Indirect)</h3>
<p>A plant engineer never trusts a single calculation. They always use two independent methods and check if they "close the loop." This tool allows you to do the same.</p>

<h4>1. The Direct Method (Input-Output)</h4>
<p>This is the most intuitive method. It answers the question: "Of all the heat I put *in* the process fluid, how much came *out*?"
<br><strong>Efficiency ($\small \eta_{direct}$) = Heat Absorbed by Fluid ($\small Q_{out}$) / Heat from Fuel ($\small Q_{in}$)</strong>
<ul>
<li><strong>Why it's used:</strong> It's a quick and simple measure of the "black box" performance.</li>
<li><strong>Its Weakness:</strong> It is *extremely* sensitive to instrument error. Measuring the mass flow of a hot, flashing crude oil stream is difficult. A small error in a temperature or enthalpy reading is magnified into a large error in the final `Q_out`.</li>
</ul>
</p>

<h4>2. The Indirect Method (Heat Loss)</h4>
<p>This is the method required by ASME PTC 4. It answers the question: "I know how much heat I put in, so I'll find out where it *left* without doing its job."
<br><strong>Efficiency ($\small \eta_{indirect}$) = (Heat from Fuel - Heat Losses) / Heat from Fuel</strong>
<ul>
<li><strong>Why it's the "Gold Standard":</strong> It is often *far more accurate* to measure the losses. The two most important measurements in the entire plant are the **Flue Gas O2%** and the **Stack Temperature**. These are measured with high-precision analyzers. By calculating the major losses (L1, L2, L3), we can determine the "available heat" with high confidence.</li>
<li><strong>Its Power:</strong> This method tells you *why* your efficiency is low. The Direct Method just says "85%". The Indirect Method says "85%, and that's because you're losing 10% up the stack (L1) and 5% from bad insulation (L3)."</li>
</ul>
</p>

<h3 style="color: var(--primary-color); margin-top: 25px;">The "Big Three" Losses: Where Your Money Is Going</h3>
<p>This calculator now quantifies the three most important heat losses:</p>
<ol>
<li><strong>L1: Dry Flue Gas Loss (The #1 Killer):</strong> This is the sensible heat of the *non-water* components of your flue gas (CO2, N2, and especially your excess O2) going up the stack. This is the single largest, and most *controllable*, loss. It is directly proportional to two things:
    <ul>
        <li><strong>Excess O2 (or Excess Air):</strong> You must add extra air to ensure complete combustion, but every extra molecule of O2 (and its accompanying N2) that *doesn't* burn just gets heated from ambient to stack temperature for no reason. This is like paying to heat up the sky. (Typical target: 2-3% O2).</li>
        <li><strong>Stack Temperature:</strong> The final exit temperature of the gas. The higher it is, the more heat you're wasting. (Target: As low as possible without causing acid dew point corrosion).</li>
    </ul>
</li>
<li><strong>L2: Latent Heat Loss (Water):</strong> This is the "cost" of burning hydrogen. When hydrogen (H) in the fuel burns, it creates H2O (water). This water gets heated into steam, and it carries its massive latent heat of vaporization up the stack. This also includes any water that was *already in* the fuel or combustion air. This loss is largely unavoidable but *must* be calculated for an accurate balance.</li>
<li><strong>L3: Casing Losses (Radiation/Convection):</strong> This is the heat you feel when you stand next to the furnace. It's the heat escaping from the furnace's "box" (casing, peepholes, headers) to the atmosphere. This is a direct measure of your insulation's quality and integrity. It's typically estimated (as in this tool) or measured with infrared thermal imaging.</li>
</ol>

<h3 style="color: var(--primary-color); margin-top: 25px;">Important Checks, Quality, & The Future</h3>
<p>When an engineer "walks down" a furnace, they are performing critical checks:</p>
<ul>
<li><strong>Flame Shape & Impingement:</strong> Are the flames long, bushy, and stable? Or are they "impinging" (directly touching) the tubes? Flame impingement creates a localized hot spot (coking) that will lead to a tube rupture—the most dangerous failure mode.</li>
<li><strong>Stack Temperature:</strong> Is it stable? A *rising* stack temperature over months can indicate "fouling" (coke or soot) building up on the *outside* of the tubes, insulating them and forcing the heat to go up the stack instead of into the process.</li>
<li><strong>Acid Dew Point:</strong> If the fuel contains sulfur (S), it creates SO2 and SO3. This mixes with the water (H2O) in the flue gas to create sulfuric acid (H2SO4). If the stack metal temperature drops *below* the dew point of this acid (typically 120-140°C), the acid condenses and rapidly corrodes the stack from the inside out. This dictates the *minimum* allowable stack temperature.</li>
</ul>

<h4>Innovations: Squeezing Every Last Degree</h4>
<p>The entire goal of modern furnace design is to get the stack temperature as low as possible. This is done through advanced heat recovery:</p>
<ul>
<li><strong>Air Preheaters (APH):</strong> Using the hot flue gas (e.g., at 350°C) to heat up the cold incoming combustion air (at 25°C). This "recycles" waste heat back into the furnace, dramatically boosting efficiency.</li>
<li><strong>Waste Heat Recovery Units (WHRU):</strong> Using the hot flue gas in a separate boiler to generate steam, which can be used elsewhere in the plant (a "cogeneration" system).</li>
<li><strong>Digital Twins & CFD:</strong> Engineers now use Computational Fluid Dynamics (CFD) to build a complete 3D simulation of the furnace *before* it's built. They can model the exact flame shape, heat flux on every tube, and gas flow to optimize burner placement, eliminate hot spots, and ensure complete combustion.</li>
<li><strong>Alternative Fuels:</strong> The newest challenge is retrofitting furnaces to burn waste gas or "green" hydrogen. These fuels have vastly different properties (flame speed, heating value) and require completely new burner designs and safety systems.</li>
</ul>
</div>
<!-- END: NEW 800+ WORD EDUCATIONAL CONTENT -->

</main>

<!-- FOOTER (Replaced) -->
<footer>
<div class="container">
<div class="footer-content">
<div class="footer-col">
<h4>Design Calculators</h4>
<p style="font-size: 0.9rem; line-height: 1.6; margin-bottom: 15px;">Inspired by standards such as IEC, IEEE, ISA, ASME, and API.</p>
<div class="social-buttons">
<a href="https://www.linkedin.com/shareArticle?mini=true&url=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn linkedin"><i class="fab fa-linkedin-in"></i></a>
<a href="https://www.youtube.com/@designcalculators" target="_blank" rel="noopener noreferrer" class="social-btn youtube"><i class="fab fa-youtube"></i></a>
<a href="https://twitter.com/intent/tweet?url=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn twitter"><i class="fab fa-twitter"></i></a>
<a href="https://www.facebook.com/sharer/sharer.php?u=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn facebook"><i class="fab fa-facebook-f"></i></a>
<a href="https://api.whatsapp.com/send?text=Check%20out%20this%20amazing%20engineering%20resource:%20https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn whatsapp"><i class="fab fa-whatsapp"></i></a>
</div>
</div>
<div class="footer-col">
<h4>Quick Links</h4>
<ul>
<li><a href="/">Home</a></li>
<li><a href='/indexele.html'>Electrical</a></li>
<li><a href='/indexmech.html'>Mechanical</a></li>
<li><a href='/indexinst.html'>Instrumentation</a></li>
</ul>
</div>
<div class="footer-col">
<h4>Resources</h4>
<ul>
<li><a href='/about.html'>About Us</a></li>
<li><a href='/contact.html'>Contact</a></li>
<li><a href='/faq.html'>FAQ</a></li>
<li><a href='/privacy-policy.html'>Privacy Policy</a></li>
<li><a href='/terms-of-service.html'>Terms of Service</a></li>
</ul>
</div>
<div class="footer-col">
<h4>More</h4>
<ul>
<li><a href='/articles.html'>Articles & Blog</a></li>
<li><a href='/sitemap2.html'>Sitemap</a></li>
<li><a href="https://www.youtube.com/@designcalculators" target="_blank" rel="noopener noreferrer">YouTube Channel</a></li>
</ul>
</div>
</div>

<div class="footer-disclaimer">
<!-- Updated Disclaimer to match the Spring Tool -->
<p>This tool offers general guidance. Results should be reviewed for accuracy and compliance with relevant project standards and regulations before use.</p>
</div>

<div class="footer-bottom">
<p>&copy; 2025 Design Calculators. Created by <span class="creator-name">A Sharma</span>. All rights reserved.</p>
</div>
</div>
</footer>

<div id="custom-message-box"></div>

<script>
document.addEventListener('DOMContentLoaded', function() {
// --- Get references to DOM elements ---
const calculateBtn = document.getElementById('calculate-furnace-btn');
const resultContainer = document.getElementById('result-container');
const resultTableBody = document.getElementById('result-table-body');
const standardReference = document.getElementById('standard-reference');
const calculationDetailsDiv = document.getElementById('calculation-details');

// Input fields
const unitSystemSelect = document.getElementById('unit-system');
const fuelInputRateInput = document.getElementById('fuel-input-rate');
const fuelHHVInput = document.getElementById('fuel-hhv');
const fluidMassFlowInput = document.getElementById('fluid-mass-flow');

// Process fluid input type selectors
const fluidInputTypeRadios = document.querySelectorAll('input[name="fluid-input-type"]');
const enthalpyInputsDiv = document.getElementById('enthalpy-inputs');
const temperatureCpInputsDiv = document.getElementById('temperature-cp-inputs');

// Enthalpy-specific inputs
const enthalpyInInput = document.getElementById('enthalpy-in');
const enthalpyOutInput = document.getElementById('enthalpy-out');

// Temperature/Cp specific inputs
const temperatureInInput = document.getElementById('temperature-in');
const temperatureOutInput = document.getElementById('temperature-out');
const specificHeatInput = document.getElementById('specific-heat');

const radiantLossPctInput = document.getElementById('radiant-loss-pct');

// NEW Industrial Analysis Inputs
const flueGasO2Input = document.getElementById('flue-gas-o2');
const stackTempInput = document.getElementById('stack-temp');
const ambientTempInput = document.getElementById('ambient-temp');
const fuelCInput = document.getElementById('fuel-c');
const fuelHInput = document.getElementById('fuel-h');
const fuelSInput = document.getElementById('fuel-s');
const fuelOInput = document.getElementById('fuel-o');
const fuelNInput = document.getElementById('fuel-n');
const fuelWaterInput = document.getElementById('fuel-water');
const fuelCompTotalDiv = document.getElementById('fuel-comp-total');
const fuelCompInputs = document.querySelectorAll('.fuel-comp');

// Labels that change text
const fuelRateUnitLabel = document.querySelector('.fuel-rate-unit');
const hhvUnitLabel = document.querySelector('.hhv-unit');
const fluidRateUnitLabel = document.querySelector('.fluid-rate-unit');
const enthalpyUnitLabels = document.querySelectorAll('.enthalpy-unit');
const tempUnitLabels = document.querySelectorAll('.temp-unit');
const cpUnitLabel = document.querySelector('.cp-unit');

/**
* Displays a custom message box at the top of the screen.
* @param {string} message - The message to display.
* @param {string} type - The type of message ('info', 'error', 'warning').
*/
function displayMessage(message, type = "info") {
let messageBox = document.getElementById('custom-message-box');
if (!messageBox) {
messageBox = document.createElement('div');
messageBox.id = 'custom-message-box';
document.body.appendChild(messageBox);
}
messageBox.textContent = message;
messageBox.className = 'show'; // Clear previous classes
messageBox.classList.add(type); // Add type class for styling

setTimeout(() => {
messageBox.style.opacity = 0;
messageBox.classList.remove('show');
}, 5000);
}

/**
* Converts an energy rate value from kJ/hr or BTU/hr to MW.
* 1 MW = 3,600,000 kJ/hr
* 1 MW = 3,412,142 BTU/hr
* @param {number} value - The energy value in kJ/hr or BTU/hr.
* @param {string} unitSystem - 'metric' or 'imperial'.
* @returns {number} The energy value in MW.
*/
function convertToMW(value, unitSystem) {
if (unitSystem === 'metric') {
return value / 3600000; // kJ/hr to MW (Note: 1 kJ/s = 1 kW, 1000 kW = 1 MW. 1 kJ/hr = 1/3600 kJ/s)
} else {
return value / 3412142; // BTU/hr to MW
}
}

/**
* Updates unit labels and input defaults based on selected unit system.
*/
function updateUnitLabelsAndDefaults() {
const unitSystem = unitSystemSelect.value;
const isMetric = unitSystem === 'metric';

// Update common units
fuelRateUnitLabel.textContent = isMetric ? '(kg/hr)' : '(lb/hr)';
fluidRateUnitLabel.textContent = isMetric ? '(kg/hr)' : '(lb/hr)';
hhvUnitLabel.textContent = isMetric ? '(kJ/kg)' : '(BTU/lb)';
enthalpyUnitLabels.forEach(label => label.textContent = isMetric ? '(kJ/kg)' : '(BTU/lb)');
tempUnitLabels.forEach(label => label.textContent = isMetric ? '(°C)' : '(°F)');
cpUnitLabel.textContent = isMetric ? '(kJ/kg·°C)' : '(BTU/lb·°F)';

// Set default values based on unit system
if (isMetric) {
fuelInputRateInput.value = "500";
fuelHHVInput.value = "45000";
fluidMassFlowInput.value = "10000";
enthalpyInInput.value = "200";
enthalpyOutInput.value = "1500";
temperatureInInput.value = "30";
temperatureOutInput.value = "300";
specificHeatInput.value = "2.0";
stackTempInput.value = "150";
ambientTempInput.value = "25";
} else { // Imperial
fuelInputRateInput.value = "1100"; // approx 500 kg/hr
fuelHHVInput.value = "19350"; // approx 45000 kJ/kg
fluidMassFlowInput.value = "22000"; // approx 10000 kg/hr
enthalpyInInput.value = "86"; // approx 200 kJ/kg
enthalpyOutInput.value = "645"; // approx 1500 kJ/kg
temperatureInInput.value = "86"; // approx 30°C
temperatureOutInput.value = "572"; // approx 300°C
specificHeatInput.value = "0.48"; // approx 2.0 kJ/kgC
stackTempInput.value = "302"; // 150C
ambientTempInput.value = "77"; // 25C
}
radiantLossPctInput.value = "2.5";
flueGasO2Input.value = "3.0";
// Fuel composition is mass-based, no change needed
fuelCInput.value = "85.0";
fuelHInput.value = "12.0";
fuelSInput.value = "0.5";
fuelOInput.value = "1.0";
fuelNInput.value = "1.0";
fuelWaterInput.value = "0.5";
updateFuelCompTotal();
toggleFluidInputType(); // Adjust input fields based on default type
}

/**
* Toggles visibility and required status of process fluid input fields.
*/
function toggleFluidInputType() {
const selectedType = document.querySelector('input[name="fluid-input-type"]:checked').value;

if (selectedType === 'enthalpy') {
enthalpyInputsDiv.style.display = 'flex';
temperatureCpInputsDiv.style.display = 'none';

enthalpyInInput.setAttribute('required', 'true');
enthalpyOutInput.setAttribute('required', 'true');
temperatureInInput.removeAttribute('required');
temperatureOutInput.removeAttribute('required');
specificHeatInput.removeAttribute('required');
} else {
enthalpyInputsDiv.style.display = 'none';
temperatureCpInputsDiv.style.display = 'flex';

enthalpyInInput.removeAttribute('required');
enthalpyOutInput.removeAttribute('required');
temperatureInInput.setAttribute('required', 'true');
temperatureOutInput.setAttribute('required', 'true');
specificHeatInput.setAttribute('required', 'true');
}
}

/**
* Updates the total percentage for fuel composition inputs.
*/
function updateFuelCompTotal() {
let total = 0;
fuelCompInputs.forEach(input => {
total += parseFloat(input.value) || 0;
});
fuelCompTotalDiv.textContent = `Total: ${total.toFixed(1)}%`;
if (Math.abs(total - 100.0) > 0.1) {
fuelCompTotalDiv.style.color = 'var(--fail-color)';
} else {
fuelCompTotalDiv.style.color = 'var(--success-color)';
}
}

// Event listeners
unitSystemSelect.addEventListener('change', updateUnitLabelsAndDefaults);
fluidInputTypeRadios.forEach(radio => {
radio.addEventListener('change', toggleFluidInputType);
});
fuelCompInputs.forEach(input => {
input.addEventListener('input', updateFuelCompTotal);
});

// Initial UI setup on load
updateUnitLabelsAndDefaults();

/**
* Adds a row to the result table.
* @param {string} parameterHtml - The HTML content for the parameter column.
* @param {string} valueHtml - The HTML content for the value column.
* @param {string} rowClass - Optional CSS class for the row.
*/
function addResultRow(parameterHtml, valueHtml, rowClass = "") {
const row = resultTableBody.insertRow();
if (rowClass) {
row.className = rowClass;
}
const paramCell = row.insertCell();
const valueCell = row.insertCell();
paramCell.innerHTML = parameterHtml;
valueCell.innerHTML = valueHtml;
}

// --- Main Calculation Logic ---
calculateBtn.addEventListener('click', function() {
const form = document.getElementById('furnace-calculator-form');
if (!form.checkValidity()) {
displayMessage("Please fill in all required fields correctly.", "error");
form.reportValidity(); // Show native browser validation messages
return;
}

// --- 1. Get All Inputs ---
const unitSystem = unitSystemSelect.value;
const fuelInputRate = parseFloat(fuelInputRateInput.value);
const fuelHHV = parseFloat(fuelHHVInput.value);
const fluidMassFlow = parseFloat(fluidMassFlowInput.value);
const radiantLossPct = parseFloat(radiantLossPctInput.value);
const selectedFluidInputType = document.querySelector('input[name="fluid-input-type"]:checked').value;

// Industrial Inputs
const flueGasO2 = parseFloat(flueGasO2Input.value);
const tStack = parseFloat(stackTempInput.value);
const tAmbient = parseFloat(ambientTempInput.value);
const fuelC = parseFloat(fuelCInput.value);
const fuelH = parseFloat(fuelHInput.value);
const fuelS = parseFloat(fuelSInput.value);
const fuelO = parseFloat(fuelOInput.value);
const fuelN = parseFloat(fuelNInput.value);
const fuelWater = parseFloat(fuelWaterInput.value);

let enthalpyIn, enthalpyOut, temperatureIn, temperatureOut, specificHeat;
if (selectedFluidInputType === 'enthalpy') {
enthalpyIn = parseFloat(enthalpyInInput.value);
enthalpyOut = parseFloat(enthalpyOutInput.value);
} else {
temperatureIn = parseFloat(temperatureInInput.value);
temperatureOut = parseFloat(temperatureOutInput.value);
specificHeat = parseFloat(specificHeatInput.value);
}

// --- 2. Validation ---
let validationError = false;
const fuelCompSum = fuelC + fuelH + fuelS + fuelO + fuelN + fuelWater;
if (Math.abs(fuelCompSum - 100.0) > 0.1) {
displayMessage("Fuel composition must sum to 100%.", "error");
validationError = true;
}
if (tStack <= tAmbient) {
displayMessage("Stack Temperature must be greater than Ambient Temperature.", "error");
validationError = true;
}
if (selectedFluidInputType === 'enthalpy' && (enthalpyOut <= enthalpyIn)) {
displayMessage("Outlet enthalpy must be greater than inlet enthalpy.", "error");
validationError = true;
}
if (selectedFluidInputType === 'temperature-cp' && (temperatureOut <= temperatureIn)) {
displayMessage("Outlet temperature must be greater than inlet temperature.", "error");
validationError = true;
}
if (validationError) return;

let calculationHtml = '<h4>Detailed Calculation Steps:</h4>';

// --- 3. Define Constants based on Unit System ---
const isMetric = unitSystem === 'metric';
const massRateUnit = isMetric ? 'kg/hr' : 'lb/hr';
const energyPerMassUnit = isMetric ? 'kJ/kg' : 'BTU/lb';
const tempUnit = isMetric ? '°C' : '°F';
const cpUnit = isMetric ? 'kJ/kg·°C' : 'BTU/lb·°F';
const totalEnergyUnit = isMetric ? 'kJ/hr' : 'BTU/hr';
// Latent heat of vaporization for water at standard conditions
const h_fg_water = isMetric ? 2442 : 1050; // kJ/kg or BTU/lb
// Approx. specific heat of flue gas
const cp_flue_gas = isMetric ? 1.05 : 0.25; // kJ/kg·K or BTU/lb·R
// Note: A delta-C is a delta-K, and a delta-F is a delta-R, so Cp units are fine.

// --- 4. Direct Method Calculations ---

// 4.1. Heat Input from Fuel (Q_input)
const Q_input_fuel = fuelInputRate * fuelHHV;
const Q_input_fuel_MW = convertToMW(Q_input_fuel, unitSystem);
calculationHtml += `<p><strong>1. Calculate Total Heat Input from Fuel (Q<sub>input, fuel</sub>):</strong></p>
<p class="formula">$$ Q_{input, fuel} = M_{fuel} \\times HHV $$</p>
<p class="calculation-step">
\\( Q_{input, fuel} \\) = ${fuelInputRate.toFixed(2)} ${massRateUnit} \\( \\times \\) ${fuelHHV.toFixed(2)} ${energyPerMassUnit} = ${Q_input_fuel.toFixed(2)} ${totalEnergyUnit}
</p>`;

// 4.2. Heat Absorbed by Process Fluid (Q_output, direct)
let Q_output_direct;
if (selectedFluidInputType === 'enthalpy') {
Q_output_direct = fluidMassFlow * (enthalpyOut - enthalpyIn);
calculationHtml += `<p><strong>2. Calculate Direct Heat Duty (Q<sub>output, direct</sub>) (from Fluid):</strong></p>
<p class="formula">$$ Q_{output, direct} = M_{fluid} \\times (h_{out} - h_{in}) $$</p>
<p class="calculation-step">
\\( Q_{output, direct} \\) = ${fluidMassFlow.toFixed(2)} ${massRateUnit} \\( \\times \\) (${enthalpyOut.toFixed(2)} - ${enthalpyIn.toFixed(2)}) ${energyPerMassUnit} = ${Q_output_direct.toFixed(2)} ${totalEnergyUnit}
</p>`;
} else { // temperature-cp
Q_output_direct = fluidMassFlow * specificHeat * (temperatureOut - temperatureIn);
calculationHtml += `<p><strong>2. Calculate Direct Heat Duty (Q<sub>output, direct</sub>) (from Fluid):</strong></p>
<p class="formula">$$ Q_{output, direct} = M_{fluid} \\times C_p \\times (T_{out} - T_{in}) $$</p>
<p class="calculation-step">
\\( Q_{output, direct} \\) = ${fluidMassFlow.toFixed(2)} ${massRateUnit} \\( \\times \\) ${specificHeat.toFixed(2)} ${cpUnit} \\( \\times \\) (${temperatureOut.toFixed(2)} - ${temperatureIn.toFixed(2)}) ${tempUnit} = ${Q_output_direct.toFixed(2)} ${totalEnergyUnit}
</p>`;
}
const Q_output_direct_MW = convertToMW(Q_output_direct, unitSystem);

// 4.3. Direct Efficiency
const Efficiency_direct = (Q_output_direct / Q_input_fuel) * 100;
calculationHtml += `<p><strong>3. Calculate Direct Thermal Efficiency (\\(\\eta_{direct}\\)):</strong></p>
<p class="formula">$$ \\eta_{direct} = \\frac{Q_{output, direct}}{Q_{input, fuel}} \\times 100 \\% $$</p>
<p class="calculation-step">
\\( \\eta_{direct} \\) = (${Q_output_direct.toFixed(2)} / ${Q_input_fuel.toFixed(2)}) \\( \\times \\) 100 % = ${Efficiency_direct.toFixed(2)} %
</p>`;

// --- 5. Indirect Method Calculations ---
calculationHtml += `<hr style="border: 1px solid var(--border-color); margin: 20px 0;"><h4>Indirect (Heat Loss) Method Analysis:</h4>`;

// 5.1. Combustion Calculation
// All calculations are mass-based (e.g., kg/kg fuel) and unit-system independent
const C = fuelC / 100;
const H = fuelH / 100;
const S = fuelS / 100;
const O = fuelO / 100;
const N = fuelN / 100;
const W = fuelWater / 100; // Water/Inerts

// Theoretical Air (kg_air / kg_fuel)
const TA = 11.53 * C + 34.3 * H + 4.3 * S - 4.3 * O;
// Excess Air (%)
const EA_pct = (flueGasO2 / (21 - flueGasO2)) * 100;
// Actual Air (kg_air / kg_fuel)
const AA = TA * (1 + EA_pct / 100);
// Mass of Flue Gas (kg_flue / kg_fuel)
const M_flue_total = AA + 1.0 - (W - fuelWater/100); // Actual Air + 1kg Fuel - Ash (assuming inerts are ash)
// Let's use a simpler M_flue_total = AA + 1.0 (assuming inerts are not ash and go up stack)
// A more accurate way: M_flue = 1 (fuel) + AA (air) - Ash. Assuming inerts = ash. Ash = W.
const M_flue = 1 + AA; // This is kg flue gas / kg fuel. (Close enough, ash is usually part of inerts)

calculationHtml += `<p><strong>4. Combustion Calculation (per ${isMetric ? 'kg' : 'lb'} of fuel):</strong></p>
<p class="formula">$$ TA = 11.53C + 34.3H + 4.3S - 4.3O $$
$$ EA\\% = \\frac{O_2\\%}{21 - O_2\\%} \\times 100 $$
$$ AA = TA \\times (1 + EA\\%/100) $$
$$ M_{flue} = AA + 1 $$</p>
<p class="calculation-step">
Theoretical Air (TA) = ${TA.toFixed(3)} ${isMetric ? 'kg' : 'lb'} air / ${isMetric ? 'kg' : 'lb'} fuel<br>
Excess Air (EA) = (${flueGasO2.toFixed(1)} / (21 - ${flueGasO2.toFixed(1)})) * 100 = ${EA_pct.toFixed(2)} %<br>
Actual Air (AA) = ${TA.toFixed(3)} * (1 + ${EA_pct.toFixed(2)}/100) = ${AA.toFixed(3)} ${isMetric ? 'kg' : 'lb'} air / ${isMetric ? 'kg' : 'lb'} fuel<br>
Total Flue Gas (M<sub>flue</sub>) = ${AA.toFixed(3)} + 1.0 = ${M_flue.toFixed(3)} ${isMetric ? 'kg' : 'lb'} flue / ${isMetric ? 'kg' : 'lb'} fuel
</p>`;

// 5.2. Stack Loss Calculation (L1 + L2)
const delta_T_stack = tStack - tAmbient;
// L1: Dry Gas Loss (Sensible Heat of Flue Gas)
// This is a simplification, a more rigorous calc would sum Cp*M*dT for each component.
// Using an average Cp is standard for this level.
const q_loss_sensible = M_flue * cp_flue_gas * delta_T_stack; // (kJ / kg fuel) or (BTU / lb fuel)
// L2: Latent Heat Loss (from H2O)
const M_H2O_total = (H * 8.94) + W; // (kg H2O / kg fuel) (8.94 = 18.02/2.016)
const q_loss_latent = M_H2O_total * h_fg_water; // (kJ / kg fuel) or (BTU / lb fuel)

const q_loss_stack_total = q_loss_sensible + q_loss_latent; // (kJ / kg fuel)
const Q_loss_stack_total = q_loss_stack_total * fuelInputRate; // (kJ/hr)
const Q_loss_stack_total_MW = convertToMW(Q_loss_stack_total, unitSystem);

calculationHtml += `<p><strong>5. Calculate Stack Losses (L1 + L2):</strong></p>
<p class="formula">$$ \\Delta T = T_{stack} - T_{ambient} $$
$$ q_{sensible} (L1) = M_{flue} \\times C_{p,flue} \\times \\Delta T $$
$$ M_{H2O} = (H \\times 8.94) + W $$
$$ q_{latent} (L2) = M_{H2O} \\times h_{fg,water} $$</p>
<p class="calculation-step">
Stack $\\Delta T$ = ${tStack.toFixed(1)} - ${tAmbient.toFixed(1)} = ${delta_T_stack.toFixed(1)} ${isMetric ? '°C' : '°F'}<br>
Sensible Loss (q<sub>L1</sub>) = ${M_flue.toFixed(3)} * ${cp_flue_gas} * ${delta_T_stack.toFixed(1)} = ${q_loss_sensible.toFixed(2)} ${energyPerMassUnit}<br>
Mass of Water (M<sub>H2O</sub>) = (${H.toFixed(3)} * 8.94) + ${W.toFixed(3)} = ${M_H2O_total.toFixed(3)} ${isMetric ? 'kg' : 'lb'} H2O / ${isMetric ? 'kg' : 'lb'} fuel<br>
Latent Loss (q<sub>L2</sub>) = ${M_H2O_total.toFixed(3)} * ${h_fg_water} = ${q_loss_latent.toFixed(2)} ${energyPerMassUnit}<br>
Total Stack Loss (Q<sub>stack</sub>) = (q<sub>L1</sub> + q<sub>L2</sub>) * M<sub>fuel</sub> = ${q_loss_stack_total.toFixed(2)} * ${fuelInputRate.toFixed(2)} = ${Q_loss_stack_total.toFixed(2)} ${totalEnergyUnit}
</p>`;

// 5.3. Casing Loss (L3)
const Q_loss_rad = Q_input_fuel * (radiantLossPct / 100);
const Q_loss_rad_MW = convertToMW(Q_loss_rad, unitSystem);
calculationHtml += `<p><strong>6. Calculate Casing (Radiant) Loss (L3):</strong></p>
<p class="formula">$$ Q_{loss, rad} = Q_{input, fuel} \\times \\frac{\\text{Casing Loss %}}{100} $$</p>
<p class="calculation-step">
\\( Q_{loss, rad} \\) = ${Q_input_fuel.toFixed(2)} ${totalEnergyUnit} \\( \\times \\) ${radiantLossPct.toFixed(1)}% = ${Q_loss_rad.toFixed(2)} ${totalEnergyUnit}
</p>`;

// 5.4. Total Losses & Indirect Duty
const Q_loss_total = Q_loss_stack_total + Q_loss_rad;
const Q_loss_total_MW = convertToMW(Q_loss_total, unitSystem);
const Q_output_indirect = Q_input_fuel - Q_loss_total;
const Q_output_indirect_MW = convertToMW(Q_output_indirect, unitSystem);
const Efficiency_indirect = (Q_output_indirect / Q_input_fuel) * 100;

calculationHtml += `<p><strong>7. Calculate Indirect Duty & Efficiency (\\(\\eta_{indirect}\\)):</strong></p>
<p class="formula">$$ Q_{loss, total} = Q_{stack} + Q_{rad} $$
$$ Q_{output, indirect} = Q_{input, fuel} - Q_{loss, total} $$
$$ \\eta_{indirect} = \\frac{Q_{output, indirect}}{Q_{input, fuel}} \\times 100 \\% $$</p>
<p class="calculation-step">
Total Loss (Q<sub>loss, total</sub>) = ${Q_loss_stack_total.toFixed(2)} + ${Q_loss_rad.toFixed(2)} = ${Q_loss_total.toFixed(2)} ${totalEnergyUnit}<br>
Indirect Duty (Q<sub>output, indirect</sub>) = ${Q_input_fuel.toFixed(2)} - ${Q_loss_total.toFixed(2)} = ${Q_output_indirect.toFixed(2)} ${totalEnergyUnit}<br>
Indirect Efficiency (\\(\\eta_{indirect}\\)) = (${Q_output_indirect.toFixed(2)} / ${Q_input_fuel.toFixed(2)}) * 100 = ${Efficiency_indirect.toFixed(2)} %
</p>`;

// 5.5. Reconciliation
const Q_unaccounted = Q_output_indirect - Q_output_direct;
const Q_unaccounted_MW = convertToMW(Q_unaccounted, unitSystem);
const Q_unaccounted_pct = (Q_unaccounted / Q_input_fuel) * 100;

calculationHtml += `<p><strong>8. Reconciliation & Discrepancy Analysis:</strong></p>
<p class="formula">$$ Q_{unaccounted} = Q_{output, indirect} - Q_{output, direct} $$</p>
<p class="calculation-step">
Discrepancy (Q<sub>unaccounted</sub>) = ${Q_output_indirect.toFixed(2)} - ${Q_output_direct.toFixed(2)} = ${Q_unaccounted.toFixed(2)} ${totalEnergyUnit}<br>
Discrepancy as % of Input = ${Q_unaccounted_pct.toFixed(2)} %
</p>
<p style="font-size: 0.9em; margin-top: 10px;"><em>A large discrepancy (e.g., > 2-3%) suggests instrumentation errors on the process side (flow/temp), significant air ingress (leakage), or other unmeasured losses (e.g., incomplete combustion, soot).</em></p>`;

// --- 6. Populate Results Table ---
calculationDetailsDiv.innerHTML = calculationHtml; // <-- FIX: Re-inserted the missing line to display calculations
resultTableBody.innerHTML = '';
addResultRow("Unit System", unitSystem === 'imperial' ? 'Imperial' : 'Metric');
addResultRow("<strong>1. Fuel Heat Input (Q<sub>input, fuel</sub>)</strong>", `<strong>${Q_input_fuel.toFixed(2)} ${totalEnergyUnit} (${Q_input_fuel_MW.toFixed(3)} MW)</strong>`);
addResultRow("<strong>2. Direct Heat Duty (Q<sub>output, direct</sub>)</strong> <br> (from Process Fluid)", `<strong>${Q_output_direct.toFixed(2)} ${totalEnergyUnit} (${Q_output_direct_MW.toFixed(3)} MW)</strong>`);
addResultRow("<strong>3. Indirect Heat Duty (Q<sub>output, indirect</sub>)</strong> <br> (from Heat Loss Method)", `<strong>${Q_output_indirect.toFixed(2)} ${totalEnergyUnit} (${Q_output_indirect_MW.toFixed(3)} MW)</strong>`);
addResultRow("Total Calculated Losses (Q<sub>loss, total</sub>)", `${Q_loss_total.toFixed(2)} ${totalEnergyUnit} (${Q_loss_total_MW.toFixed(3)} MW)`);
addResultRow("... Stack Loss (L1+L2)", `... ${Q_loss_stack_total.toFixed(2)} ${totalEnergyUnit}`);
addResultRow("... Casing Loss (L3)", `... ${Q_loss_rad.toFixed(2)} ${totalEnergyUnit}`);
addResultRow("<strong>Direct Efficiency (\\(\\eta_{direct}\\))</strong>", `<strong>${Efficiency_direct.toFixed(2)} %</strong>`, "highlight-row");
addResultRow("<strong>Indirect Efficiency (\\(\\eta_{indirect}\\))</strong>", `<strong>${Efficiency_indirect.toFixed(2)} %</strong>`, "highlight-row");
addResultRow("<strong>Discrepancy (Unaccounted Loss)</strong> <br> (Indirect Duty - Direct Duty)", `<strong>${Q_unaccounted.toFixed(2)} ${totalEnergyUnit} (${Q_unaccounted_MW.toFixed(3)} MW)</strong>`, "discrepancy-row");
addResultRow("Discrepancy as % of Heat Input", `<strong>${Q_unaccounted_pct.toFixed(2)} %</strong>`, "discrepancy-row");

// --- 7. Finalize and Show ---
if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
window.MathJax.typesetPromise([calculationDetailsDiv, resultTableBody]).catch(err => console.error("MathJax error: ", err));
}

// Populate the standard reference box
standardReference.innerHTML = `<h4>Key Considerations & Standards (API 560 / ASME PTC 4)</h4>
<ul>
<li><strong>Direct Method (\\(\\eta_{direct}\\)):</strong> This value is highly dependent on the accuracy of process flow, temperature, and enthalpy data. It represents the heat *absorbed*.</li>
<li><strong>Indirect Method (\\(\\eta_{indirect}\\)):</strong> This value is dependent on flue gas analysis (O2, Temp) and fuel composition. It represents the heat *available* after losses. It is often considered the more accurate measure of true thermal efficiency.</li>
<li><strong>Discrepancy:</strong> The difference between the two methods (ideally < 2-3%) is the most critical diagnostic tool.
<ul>
<li><strong>Large Positive (Indirect > Direct):</strong> May indicate process fluid flow is *over-reported*, or fluid $\\Delta T$/$\\Delta h$ is *under-reported*.</li>
<li><strong>Large Negative (Direct > Indirect):</strong> May indicate process fluid flow is *under-reported*, or fuel flow is *under-reported*, or major unmeasured losses (e.g., severe casing leaks, air ingress, high incomplete combustion).</li>
</ul>
</li>
<li><strong>Stack Losses:</strong> The total stack loss (L1+L2) is the primary target for efficiency improvements (e.g., via air preheaters or reducing excess O2).</li>
</ul>
<p><strong>Disclaimer:</strong> This tool is for educational and estimation purposes. All results must be verified by a qualified engineer using certified plant data and rigorous adherence to standards like ASME PTC 4 for any contractual or regulatory reporting.</p>`;

resultContainer.classList.add('show');
resultContainer.scrollIntoView({ behavior: 'smooth' });
displayMessage("Furnace performance analysis completed!", "info");

});

// --- Theme switch functionality ---
const themeSwitch = document.getElementById('theme-switch');
if (themeSwitch) {
// Set initial theme based on local storage
const currentTheme = localStorage.getItem('theme');
if (currentTheme === 'dark-mode') {
document.body.classList.add('dark-mode');
themeSwitch.checked = true;
} else {
document.body.classList.remove('dark-mode');
themeSwitch.checked = false;
}
// Add listener for theme change
themeSwitch.addEventListener('change', function() {
if (this.checked) {
document.body.classList.add('dark-mode');
localStorage.setItem('theme', 'dark-mode');
} else {
document.body.classList.remove('dark-mode');
localStorage.setItem('theme', 'light-mode');
}
});
}
});
</script>
</body>
</html>

