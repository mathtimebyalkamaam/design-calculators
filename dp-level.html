<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-23Y1V450SR"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-23Y1V450SR');
</script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5936527763614780"
     crossorigin="anonymous"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DP Level Measurement Calculator - Instrumentation</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="icon" href="/favicon.ico" type="image/x-icon">

    <style>
        /* Basic CSS Variables for a consistent theme */
        :root {
            --primary-color: #4CAF50; /* Green */
            --secondary-color: #45a049; /* Darker Green */
            --accent-color: #FFC107; /* Amber */
            --bg-color: #f4f7f6; /* Light Greyish Green */
            --card-bg: #ffffff; /* White */
            --text-color: #333333; /* Dark Grey */
            --header-bg: #2C3E50; /* Dark Blue Grey */
            --footer-bg: #34495E; /* Slightly Lighter Dark Blue Grey */
            --border-color: #cccccc;
            --card-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            --hover-color: #e2e6ea;
            --button-gradient: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            --button-hover-gradient: linear-gradient(45deg, var(--secondary-color), #3b8e3e);
            --reset-button-bg: #FFC107; /* Yellow for reset */
            --reset-button-hover-bg: #E0A800; /* Darker yellow */
            --clear-button-bg: #007bff; /* Blue for clear */
            --clear-button-hover-bg: #0056b3; /* Darker blue */
            --liquid-color: #3498db; /* Blue for liquid */
            --liquid-color-dark: #2980b9; /* Darker blue for liquid */
        }

        /* Dark Mode Variables */
        body.dark-mode {
            --bg-color: #2c3e50;
            --card-bg: #34495e;
            --text-color: #ecf0f1;
            --header-bg: #2c3e50;
            --footer-bg: #2c3e50;
            --border-color: #555555;
            --card-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            --hover-color: #446688;
            --button-gradient: linear-gradient(45deg, #3b8e3e, #4CAF50);
            --button-hover-gradient: linear-gradient(45deg, #4CAF50, #5cb85c);
            --reset-button-bg: #FFD700; /* Gold/Yellow for dark mode reset */
            --reset-button-hover-bg: #DAA520; /* Darker gold/yellow */
            --clear-button-bg: #17a2b8; /* Cyan for dark mode clear */
            --clear-button-hover-bg: #138496;
            --liquid-color: #6dd5ed; /* Lighter blue for dark mode liquid */
            --liquid-color-dark: #2193b0; /* Darker blue for dark mode liquid */
        }

        /* General Body Styling */
        body {
            font-family: 'Inter', sans-serif; /* Using Inter as specified */
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, var(--bg-color), #e0e0e0);
            color: var(--text-color);
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 960px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: var(--header-bg);
            color: white;
            padding: 20px 0;
            text-align: center;
            box-shadow: var(--card-shadow);
            position: relative; /* For theme toggle positioning */
        }

        header h1 {
            margin: 0;
            font-size: 2.5em;
            color: var(--primary-color);
        }

        header .subtitle {
            margin: 5px 0 0;
            font-size: 1em;
            color: #bdc3c7;
        }

        main {
            padding: 20px 0;
        }

        .tool-container {
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 20px;
            box-shadow: var(--card-shadow);
            margin-bottom: 20px;
            transition: transform 0.3s ease-in-out;
        }

        .tool-container:hover {
            transform: translateY(-5px);
        }

        .tool-container h2 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            margin-top: 0;
            margin-bottom: 20px;
        }

        .tool-description {
            margin-bottom: 20px;
            color: var(--text-color);
        }

        .back-button {
            display: inline-block;
            background-color: var(--primary-color);
            color: white;
            padding: 10px 15px;
            border-radius: 4px;
            text-decoration: none;
            margin-bottom: 20px;
            transition: background-color 0.3s, transform 0.3s;
            width: fit-content; 
        }

        .back-button:hover {
            background-color: var(--secondary-color);
            transform: translateY(-3px);
        }

        /* Theme Toggle */
        .theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
        }

        .theme-toggle .light-icon,
        .theme-toggle .dark-icon {
            color: white;
            margin: 0 5px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
        }

        input:checked + .slider {
            background-color: var(--primary-color);
        }

        input:focus + .slider {
            box-shadow: 0 0 1px var(--primary-color);
        }

        input:checked + .slider:before {
            -webkit-transform: translateX(26px);
            -ms-transform: translateX(26px);
            transform: translateX(26px);
        }

        /* Rounded sliders */
        .slider.round {
            border-radius: 34px;
        }

        .slider.round:before {
            border-radius: 50%;
        }

        /* Footer Styling */
        footer {
            background-color: var(--footer-bg);
            color: white;
            padding: 20px 0;
            text-align: center;
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1);
            margin-top: 30px;
        }

        footer .disclaimer h3,
        footer .social-share h3 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        footer .disclaimer p {
            font-size: 0.9em;
            color: #bdc3c7;
        }

        .social-buttons {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .social-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            color: white;
            text-decoration: none;
            font-size: 1.2em;
            transition: transform 0.3s ease-in-out;
        }

        .social-btn:hover {
            transform: translateY(-3px);
        }

        .social-btn.linkedin { background-color: #0A66C2; }
        .social-btn.facebook { background-color: #1877F2; }
        .social-btn.twitter { background-color: #1DA1F2; }
        .social-btn.whatsapp { background-color: #25D366; }
        .social-btn.reddit { background-color: #FF4500; }

        /* Styles for Calculator Forms and Results */
        .calculator-form {
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: var(--card-shadow);
        }
        
        .form-section {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 25px; /* Space between sections */
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
            opacity: 0; /* Initial state for fade-in animation */
            transform: translateY(10px); /* Initial state for slide-up animation */
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }

        .form-section.fade-in {
            opacity: 1;
            transform: translateY(0);
        }

        .form-section h3 {
            color: var(--secondary-color);
            margin-top: 0;
            margin-bottom: 15px;
            border-bottom: 1px dashed var(--border-color);
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px; /* Default margin for form groups */
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--text-color);
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--card-bg); /* Use card-bg for input background */
            color: var(--text-color);
            box-sizing: border-box; /* Ensure padding doesn't increase width */
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Responsive grid */
            gap: 20px; /* Gap between grid items */
            margin-bottom: 0; /* Handled by form-group margin */
        }
        
        .calculate-btn {
            background: var(--button-gradient);
            color: white;
            border: none;
            padding: 12px 30px; /* Increased padding for better appearance */
            border-radius: 25px; /* More rounded */
            cursor: pointer;
            font-size: 1.1em; /* Slightly larger font */
            font-weight: bold;
            margin-top: 25px; /* More space above button */
            transition: background 0.3s ease-in-out, transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            width: auto; /* Allow button to size based on content and padding */
            min-width: 220px; /* Ensure a minimum width for consistency */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); /* More pronounced shadow */
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }
        
        .calculate-btn:hover {
            background: var(--button-hover-gradient);
            transform: translateY(-5px) scale(1.02); /* Lift and slightly scale */
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3); /* Deeper shadow on hover */
        }

        .reset-btn {
            background-color: var(--reset-button-bg);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            margin-top: 25px;
            margin-left: 15px; /* Space from calculate button */
            transition: background-color 0.3s ease-in-out, transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            width: auto;
            min-width: 150px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .reset-btn:hover {
            background-color: var(--reset-button-hover-bg);
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .clear-results-btn {
            background-color: var(--clear-button-bg);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
            margin-top: 15px;
            transition: background-color 0.3s ease-in-out, transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .clear-results-btn:hover {
            background-color: var(--clear-button-hover-bg);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .result-container {
            margin-top: 30px;
            padding: 20px;
            border-radius: 8px;
            background-color: var(--card-bg);
            box-shadow: var(--card-shadow);
            display: none; /* Hidden by default */
            opacity: 0; /* For animation */
            transform: translateY(20px); /* Initial state for animation */
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }
        
        .result-container.show {
            opacity: 1;
            transform: translateY(0);
        }

        .result-container h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            text-align: center;
        }
        
        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            border-radius: 8px;
            overflow: hidden; /* Ensures rounded corners apply to table content */
        }
        
        .result-table th, .result-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.3s;
        }
        
        .result-table th {
            background-color: var(--hover-color);
            font-weight: bold;
            color: var(--secondary-color);
        }

        .result-table tr:last-child td {
            border-bottom: none; /* No border for the last row */
        }

        .result-table tbody tr:hover {
            background-color: var(--hover-color); /* Highlight row on hover */
        }
        
        .standard-reference {
            margin-top: 20px;
            font-style: italic;
            font-size: 0.9rem;
            color: var(--text-color);
            padding: 10px;
            border-left: 4px solid var(--primary-color);
            background-color: var(--hover-color);
            border-radius: 4px;
        }
        
        .info-icon {
            color: var(--primary-color);
            margin-left: 5px;
            cursor: help;
            transition: color 0.3s;
        }

        .info-icon:hover {
            color: var(--accent-color);
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px; /* Increased padding */
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            transform: translateY(10px); /* Initial state for tooltip animation */
            font-size: 0.85em;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
            transform: translateY(0);
        }

        /* Custom message box style */
        #custom-message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            font-weight: bold;
            color: white;
            opacity: 0;
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            display: flex; /* Use flex for centering text */
            align-items: center;
            justify-content: center;
            min-width: 250px; /* Ensure it's wide enough */
        }

        /* Styles for calculation details */
        #calculation-details {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px; /* More rounded */
            padding: 20px; /* Increased padding */
            margin-bottom: 25px; /* More space */
            font-size: 0.95em;
            color: var(--text-color);
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05); /* Subtle inner shadow */
        }
        #calculation-details h4 {
            color: var(--secondary-color);
            margin-top: 0;
            margin-bottom: 15px; /* More space */
            text-align: center;
            font-size: 1.2em;
        }
        #calculation-details p.formula {
            font-family: 'Times New Roman', serif; /* A font suitable for mathematical formulas */
            font-style: italic;
            font-size: 1.1em;
            text-align: center;
            padding: 12px 10px; /* Increased padding */
            background-color: var(--hover-color);
            border-radius: 6px; /* More rounded */
            margin: 15px 0; /* More space */
            overflow-x: auto; /* Allow horizontal scrolling for long formulas */
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        #calculation-details p.calculation-step {
            font-family: 'Courier New', monospace; /* Monospace for steps */
            background-color: var(--hover-color);
            padding: 8px 15px; /* Increased padding */
            border-radius: 4px; /* More rounded */
            margin-bottom: 8px; /* More space */
            color: var(--text-color);
            white-space: pre-wrap; /* Preserve whitespace and wrap text */
            word-break: break-word; /* Break long words */
        }
        #calculation-details ul {
            list-style-type: disc;
            margin-left: 25px; /* Increased margin */
            padding-left: 0;
            margin-top: 15px;
        }
        #calculation-details ul li {
            margin-bottom: 8px; /* More space */
            color: var(--text-color);
        }

        /* Style for centering the button */
        .button-wrapper {
            display: flex;
            justify-content: center; /* Center the button horizontally */
            width: 100%; /* Ensure it takes full width to center effectively */
            padding-top: 20px; /* Add more spacing above the button */
        }

        /* Animation for input fields on focus */
        .form-group input:focus, .form-group select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(76, 175, 80, 0.4); /* Green glow, slightly more pronounced */
            outline: none;
            animation: pulse 0.8s infinite alternate;
        }

        @keyframes pulse {
            from {
                box-shadow: 0 0 0 4px rgba(76, 175, 80, 0.4);
            }
            to {
                box-shadow: 0 0 0 8px rgba(76, 175, 80, 0.2); /* Softer pulse */
            }
        }

        /* Specific styles for DP Level Calculator */
        .unit-system-selector, .tank-type-selector, .reference-leg-selector, .density-input-selector {
            margin-bottom: 20px;
            background-color: var(--hover-color);
            border-radius: 8px;
            padding: 10px;
            display: flex;
            align-items: center;
            justify-content: space-around;
        }
        .unit-system-selector label, .tank-type-selector label, .reference-leg-selector label, .density-input-selector label {
            font-weight: bold;
            color: var(--text-color);
        }
        .tank-type-selector input[type="radio"], .reference-leg-selector input[type="radio"], .density-input-selector input[type="radio"] {
            margin-right: 8px;
            transform: scale(1.2);
        }

        #closed-tank-options, #wet-leg-options, #density-input-group, #specific-gravity-input-group {
            display: none; /* Hidden by default */
            margin-top: 15px;
            border-top: 1px dashed var(--border-color);
            padding-top: 15px;
        }
        #closed-tank-options.active, #wet-leg-options.active, #density-input-group.active, #specific-gravity-input-group.active {
            display: block;
        }

        /* Tank Visualization */
        .tank-visualization-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 30px;
            margin-bottom: 20px;
            padding: 20px;
            background-color: var(--bg-color);
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            flex-direction: column;
        }

        .tank-svg {
            width: 150px;
            height: 250px;
            border: 2px solid var(--primary-color);
            border-radius: 10px;
            position: relative;
            overflow: hidden; /* Ensure liquid doesn't overflow */
            background-color: #f0f0f0; /* Empty tank background */
        }

        .tank-liquid {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(to top, var(--liquid-color-dark), var(--liquid-color));
            transition: height 1.5s ease-out; /* Smooth animation for liquid level */
            border-top-left-radius: 5px;
            border-top-right-radius: 5px;
        }

        .tank-level-label {
            margin-top: 10px;
            font-weight: bold;
            color: var(--text-color);
            font-size: 1.1em;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>Design Calculators - Instrumentation</h1>
            <p class="subtitle">Smart Tools for Modern Instrumentation Engineers</p>
            <div class="theme-toggle">
                <span class="light-icon"><i class="fas fa-sun"></i></span>
                <label class="switch">
                    <input type="checkbox" id="theme-switch">
                    <span class="slider round"></span>
                </label>
                <span class="dark-icon"><i class="fas fa-moon"></i></span>
            </div>
        </div>
    </header>

    <main class="container">
        <div style="display: flex; justify-content: center; margin-bottom: 20px;">
            <a href="indexInst.html" class="back-button"><i class="fas fa-arrow-left"></i> Back to Tools</a>
        </div>
        
        <div class="tool-container">
            <h2>DP Level Measurement Calculator</h2>
            
            <div class="tool-description">
                <p>This professional tool accurately determines the liquid level in a tank using differential pressure (DP) measurement. It supports both open and closed tank configurations, including wet and dry reference legs, and provides calculations in both Metric and Imperial units. Essential for process control, inventory management, and safety in all industrial sectors worldwide.</p>
            </div>
        
            <div class="calculator-form">
                <form id="dp-level-form">
                    <!-- Unit System Selection -->
                    <div class="form-section unit-system-selector">
                        <label for="unit-system">Select Unit System:</label>
                        <select id="unit-system" required>
                            <option value="metric">Metric (m, Pa, kg/m³)</option>
                            <option value="imperial">Imperial (ft, psi, lb/ft³)</option>
                        </select>
                    </div>

                    <!-- Tank Type Selection -->
                    <div class="form-section tank-type-selector">
                        <h3>Tank Configuration</h3>
                        <label>
                            <input type="radio" name="tank-type" value="open" checked> Open Tank
                        </label>
                        <label>
                            <input type="radio" name="tank-type" value="closed"> Closed Tank
                        </label>
                    </div>

                    <!-- Input Parameters -->
                    <div class="form-section">
                        <h3>Measurement Parameters</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="differential-pressure" id="label-differential-pressure">Differential Pressure (ΔP) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext" id="tooltip-differential-pressure">The measured differential pressure from the DP transmitter.</span></span></label>
                                <input type="number" id="differential-pressure" step="0.01" value="9806.65" required>
                            </div>
                            <div class="form-group">
                                <label for="span-level" id="label-span-level">Tank Span (Max Level) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext" id="tooltip-span-level">The maximum measurable liquid level in the tank, corresponding to the transmitter's upper range value (URV).</span></span></label>
                                <input type="number" id="span-level" step="0.01" value="1.0" required>
                            </div>
                            <div class="form-group">
                                <label for="zero-level" id="label-zero-level">Tank Zero (Min Level) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext" id="tooltip-zero-level">The minimum measurable liquid level in the tank, corresponding to the transmitter's lower range value (LRV). Typically 0, but can be offset.</span></span></label>
                                <input type="number" id="zero-level" step="0.01" value="0.0" required>
                            </div>
                            <div class="form-group">
                                <label for="fluid-temperature" id="label-fluid-temperature">Fluid Temperature <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext" id="tooltip-fluid-temperature">The operating temperature of the fluid. Important for accurate density.</span></span></label>
                                <input type="number" id="fluid-temperature" step="0.1" value="25.0" required>
                            </div>
                        </div>
                    </div>

                    <!-- Fluid Density Input Method -->
                    <div class="form-section density-input-selector">
                        <h3>Fluid Density Input Method</h3>
                        <label>
                            <input type="radio" name="density-input-method" value="density" checked> Direct Density
                        </label>
                        <label>
                            <input type="radio" name="density-input-method" value="specific-gravity"> Specific Gravity (SG)
                        </label>
                    </div>

                    <div class="form-section">
                        <div class="form-row">
                            <div class="form-group" id="density-input-group" class="active">
                                <label for="fluid-density" id="label-fluid-density-actual">Fluid Density (ρ<sub>fluid</sub>) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext" id="tooltip-fluid-density-actual">The density of the liquid in the tank at operating conditions.</span></span></label>
                                <input type="number" id="fluid-density" step="0.01" value="1000.0" required>
                            </div>
                            <div class="form-group" id="specific-gravity-input-group">
                                <label for="specific-gravity" id="label-specific-gravity">Specific Gravity (SG) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext" id="tooltip-specific-gravity">The ratio of the fluid's density to the density of a reference fluid (usually water at 4°C for liquids).</span></span></label>
                                <input type="number" id="specific-gravity" step="0.001" value="1.0" required>
                            </div>
                        </div>
                    </div>


                    <!-- Closed Tank Specific Options -->
                    <div id="closed-tank-options" class="form-section">
                        <h3>Closed Tank Reference Leg</h3>
                        <div class="reference-leg-selector">
                            <label>
                                <input type="radio" name="reference-leg-type" value="dry-leg" checked> Dry Leg
                            </label>
                            <label>
                                <input type="radio" name="reference-leg-type" value="wet-leg"> Wet Leg
                            </label>
                        </div>

                        <!-- Wet Leg Specific Properties -->
                        <div id="wet-leg-options" class="form-row">
                            <div class="form-group">
                                <label for="reference-leg-density" id="label-reference-leg-density">Reference Leg Fluid Density (ρ<sub>ref</sub>) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext" id="tooltip-reference-leg-density">The density of the fluid filling the reference leg.</span></span></label>
                                <input type="number" id="reference-leg-density" step="0.01" value="1000.0" required>
                            </div>
                            <div class="form-group">
                                <label for="reference-leg-height" id="label-reference-leg-height">Reference Leg Height (H<sub>ref</sub>) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext" id="tooltip-reference-leg-height">The height of the reference leg from the lower tap to the upper tap.</span></span></label>
                                <input type="number" id="reference-leg-height" step="0.01" value="1.0" required>
                            </div>
                        </div>
                    </div>

                    <!-- Transmitter Output Parameters -->
                    <div class="form-section">
                        <h3>Transmitter Output Parameters</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="transmitter-4ma-value">Transmitter 4mA Value (mA) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The current output corresponding to the transmitter's Lower Range Value (LRV). Typically 4 mA.</span></span></label>
                                <input type="number" id="transmitter-4ma-value" step="0.01" value="4.0" required>
                            </div>
                            <div class="form-group">
                                <label for="transmitter-20ma-value">Transmitter 20mA Value (mA) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The current output corresponding to the transmitter's Upper Range Value (URV). Typically 20 mA.</span></span></label>
                                <input type="number" id="transmitter-20ma-value" step="0.01" value="20.0" required>
                            </div>
                        </div>
                    </div>

                    <div class="button-wrapper">
                        <button type="button" id="calculate-level-btn" class="calculate-btn">Calculate Level</button>
                        <button type="button" id="reset-form-btn" class="reset-btn"><i class="fas fa-sync-alt"></i> Reset Form</button>
                    </div>
                </form>
            </div>
            
            <div id="result-container" class="result-container">
                <h3>Level Calculation Results</h3>
                <div class="tank-visualization-container">
                    <div class="tank-svg">
                        <div class="tank-liquid" style="height: 0%;"></div>
                    </div>
                    <p class="tank-level-label">Current Level: <span id="current-level-display">0.00</span></p>
                </div>
                <div id="calculation-details">
                    <!-- Calculation steps will be inserted here -->
                </div>
                <table class="result-table">
                    <thead>
                        <tr>
                            <th>Parameter</th>
                            <th>Value</th>
                        </tr>
                    </thead>
                    <tbody id="result-table-body">
                        <!-- Results will be dynamically inserted here -->
                    </tbody>
                </table>
                <div style="display: flex; justify-content: center; margin-top: 20px;">
                    <button type="button" id="clear-results-btn" class="clear-results-btn"><i class="fas fa-times-circle"></i> Clear Results</button>
                </div>
                <div class="standard-reference" id="standard-reference">
                    <!-- Standard reference text will be inserted here -->
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <div class="disclaimer">
                <h3>Disclaimer</h3>
                <p>To ensure accuracy and reliability, always verify the results obtained from these tools against the relevant engineering standards and guidelines.</p>
            </div>
            <div class="credit">
                <p>Created by A Sharma</p>
            </div>
            <div class="social-share">
                <h3>Share This Site</h3>
                <div class="social-buttons">
                    <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://designcalculators.co.in&title=Design Calculators - Instrumentation" target="_blank" class="social-btn linkedin">
                        <i class="fab fa-linkedin"></i>
                    </a>
                    <a href="https://www.facebook.com/sharer/sharer.php?u=https://designcalculators.co.in" target="_blank" class="social-btn facebook">
                        <i class="fab fa-facebook"></i>
                    </a>
                    <a href="https://twitter.com/intent/tweet?text=Check out this amazing Design Calculators - Instrumentation!&url=https://designcalculators.co.in" target="_blank" class="social-btn twitter">
                        <i class="fab fa-twitter"></i>
                    </a>
                    <a href="https://api.whatsapp.com/send?text=Check out this amazing Design Calculators - Instrumentation! https://designcalculators.co.in" target="_blank" class="social-btn whatsapp">
                        <i class="fab fa-whatsapp"></i>
                    </a>
                    <a href="https://www.reddit.com/submit?url=https://designcalculators.co.in&title=Design Calculators - Instrumentation" target="_blank" class="social-btn reddit">
                        <i class="fab fa-reddit"></i>
                    </a>
                </div>
            </div>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const unitSystemSelect = document.getElementById('unit-system');
            const tankTypeRadios = document.querySelectorAll('input[name="tank-type"]');
            const referenceLegTypeRadios = document.querySelectorAll('input[name="reference-leg-type"]');
            const densityInputMethodRadios = document.querySelectorAll('input[name="density-input-method"]');

            const fluidDensityInput = document.getElementById('fluid-density');
            const specificGravityInput = document.getElementById('specific-gravity');
            const differentialPressureInput = document.getElementById('differential-pressure');
            const spanLevelInput = document.getElementById('span-level');
            const zeroLevelInput = document.getElementById('zero-level');
            const fluidTemperatureInput = document.getElementById('fluid-temperature');
            const referenceLegDensityInput = document.getElementById('reference-leg-density');
            const referenceLegHeightInput = document.getElementById('reference-leg-height');
            const transmitter4mAValueInput = document.getElementById('transmitter-4ma-value');
            const transmitter20mAValueInput = document.getElementById('transmitter-20ma-value');

            const closedTankOptionsDiv = document.getElementById('closed-tank-options');
            const wetLegOptionsDiv = document.getElementById('wet-leg-options');
            const densityInputGroup = document.getElementById('density-input-group');
            const specificGravityInputGroup = document.getElementById('specific-gravity-input-group');

            const labelFluidDensityActual = document.getElementById('label-fluid-density-actual');
            const labelSpecificGravity = document.getElementById('label-specific-gravity');
            const labelDifferentialPressure = document.getElementById('label-differential-pressure');
            const labelSpanLevel = document.getElementById('label-span-level');
            const labelZeroLevel = document.getElementById('label-zero-level');
            const labelFluidTemperature = document.getElementById('label-fluid-temperature');
            const labelReferenceLegDensity = document.getElementById('label-reference-leg-density');
            const labelReferenceLegHeight = document.getElementById('label-reference-leg-height');

            const calculateLevelBtn = document.getElementById('calculate-level-btn');
            const resetFormBtn = document.getElementById('reset-form-btn');
            const clearResultsBtn = document.getElementById('clear-results-btn');
            const resultContainer = document.getElementById('result-container');
            const resultTableBody = document.getElementById('result-table-body');
            const standardReference = document.getElementById('standard-reference');
            const calculationDetailsDiv = document.getElementById('calculation-details');

            const tankLiquid = document.querySelector('.tank-liquid');
            const currentLevelDisplay = document.getElementById('current-level-display');

            // Constants
            const GRAVITY_SI = 9.80665; // m/s²
            const GRAVITY_IMPERIAL = 32.174; // ft/s²
            const WATER_DENSITY_SI_REF = 1000; // kg/m³ (water at 4°C)
            const WATER_DENSITY_IMPERIAL_REF = 62.43; // lb/ft³ (water at 4°C)

            // Default values for resetting form (Metric, Open Tank)
            const defaultValues = {
                'unit-system': 'metric',
                'tank-type': 'open',
                'density-input-method': 'density',
                'fluid-density': 1000.0, // kg/m³
                'specific-gravity': 1.0,
                'differential-pressure': 9806.65, // Pa (for 1m water)
                'span-level': 1.0, // m
                'zero-level': 0.0, // m
                'fluid-temperature': 25.0, // °C
                'reference-leg-type': 'dry-leg',
                'reference-leg-density': 1000.0, // kg/m³
                'reference-leg-height': 1.0, // m
                'transmitter-4ma-value': 4.0,
                'transmitter-20ma-value': 20.0
            };

            // Unit configurations
            const unitsConfig = {
                'metric': {
                    length: { label: 'm', tooltip: 'meters', toSI: 1 },
                    pressure: { label: 'Pa', tooltip: 'Pascals', toSI: 1 },
                    density: { label: 'kg/m³', tooltip: 'kilograms per cubic meter', toSI: 1 },
                    temperature: { label: '°C', tooltip: 'Celsius' },
                    gravity: GRAVITY_SI,
                    waterDensityRef: WATER_DENSITY_SI_REF,
                    levelPrecision: 3,
                    dpPrecision: 2,
                    densityPrecision: 2,
                    heightPrecision: 2,
                    tempPrecision: 1
                },
                'imperial': {
                    length: { label: 'ft', tooltip: 'feet', toSI: 0.3048 }, // ft to meters
                    pressure: { label: 'psi', tooltip: 'pounds per square inch', toSI: 6894.76 }, // psi to Pa
                    density: { label: 'lb/ft³', tooltip: 'pounds per cubic foot', toSI: 16.0185 }, // lb/ft³ to kg/m³
                    temperature: { label: '°F', tooltip: 'Fahrenheit' },
                    gravity: GRAVITY_IMPERIAL, // ft/s²
                    waterDensityRef: WATER_DENSITY_IMPERIAL_REF,
                    levelPrecision: 2,
                    dpPrecision: 2,
                    densityPrecision: 2,
                    heightPrecision: 2,
                    tempPrecision: 1
                }
            };

            // Helper function to add rows to the result table
            function addResultRow(parameter, value) {
                const row = resultTableBody.insertRow();
                const paramCell = row.insertCell();
                const valueCell = row.insertCell();
                paramCell.innerHTML = parameter;
                valueCell.innerHTML = value;
            }

            // Event Listeners
            unitSystemSelect.addEventListener('change', updateUnitLabelsAndTooltips);
            tankTypeRadios.forEach(radio => radio.addEventListener('change', updateTankTypeVisibility));
            referenceLegTypeRadios.forEach(radio => radio.addEventListener('change', updateReferenceLegVisibility));
            densityInputMethodRadios.forEach(radio => radio.addEventListener('change', updateDensityInputMethodVisibility));
            calculateLevelBtn.addEventListener('click', calculateLevel);
            resetFormBtn.addEventListener('click', resetForm);
            clearResultsBtn.addEventListener('click', clearResults);

            // Initial setup
            updateUnitLabelsAndTooltips(); // Update labels based on initial system
            updateTankTypeVisibility(); // Show/hide tank type options
            updateDensityInputMethodVisibility(); // Show/hide density/SG input fields
            
            // Initial fade-in for form sections
            const formSections = document.querySelectorAll('.form-section');
            formSections.forEach((section, index) => {
                setTimeout(() => {
                    section.classList.add('fade-in');
                }, 100 * index); // Staggered fade-in
            });

            function updateUnitLabelsAndTooltips() {
                const selectedSystem = unitSystemSelect.value;
                const config = unitsConfig[selectedSystem];
                const tankType = document.querySelector('input[name="tank-type"]:checked').value;
                const refLegType = document.querySelector('input[name="reference-leg-type"]:checked').value;
                const densityInputMethod = document.querySelector('input[name="density-input-method"]:checked').value;

                labelDifferentialPressure.innerHTML = `Differential Pressure (ΔP) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The measured differential pressure from the DP transmitter. Unit: ${config.pressure.tooltip}.</span></span>`;
                labelSpanLevel.innerHTML = `Tank Span (Max Level) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The maximum measurable liquid level in the tank, corresponding to the transmitter's upper range value (URV). Unit: ${config.length.tooltip}.</span></span>`;
                labelZeroLevel.innerHTML = `Tank Zero (Min Level) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The minimum measurable liquid level in the tank, corresponding to the transmitter's lower range value (LRV). Typically 0, but can be offset. Unit: ${config.length.tooltip}.</span></span>`;
                labelFluidTemperature.innerHTML = `Fluid Temperature <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The operating temperature of the fluid. Important for accurate density. Unit: ${config.temperature.tooltip}.</span></span>`;

                if (densityInputMethod === 'density') {
                    labelFluidDensityActual.innerHTML = `Fluid Density (ρ<sub>fluid</sub>) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The density of the liquid in the tank at operating conditions. Unit: ${config.density.tooltip}.</span></span>`;
                } else {
                    labelSpecificGravity.innerHTML = `Specific Gravity (SG) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The ratio of the fluid's density to the density of a reference fluid (usually water at 4°C for liquids). Unit: Dimensionless.</span></span>`;
                }
                
                if (tankType === 'closed' && refLegType === 'wet-leg') {
                    labelReferenceLegDensity.innerHTML = `Reference Leg Fluid Density (ρ<sub>ref</sub>) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The density of the fluid filling the reference leg. Unit: ${config.density.tooltip}.</span></span>`;
                    labelReferenceLegHeight.innerHTML = `Reference Leg Height (H<sub>ref</sub>) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext" id="tooltip-reference-leg-height">The height of the reference leg from the lower tap to the upper tap. Unit: ${config.length.tooltip}.</span></span>`;
                }

                // Update input placeholders
                differentialPressureInput.placeholder = `e.g., 9806.65 ${config.pressure.label}`;
                spanLevelInput.placeholder = `e.g., 1.0 ${config.length.label}`;
                zeroLevelInput.placeholder = `e.g., 0.0 ${config.length.label}`;
                fluidTemperatureInput.placeholder = `e.g., 25.0 ${config.temperature.label}`;
                fluidDensityInput.placeholder = `e.g., 1000 ${config.density.label}`;
                specificGravityInput.placeholder = `e.g., 1.0`;
                referenceLegDensityInput.placeholder = `e.g., 1000 ${config.density.label}`;
                referenceLegHeightInput.placeholder = `e.g., 1.0 ${config.length.label}`;
            }

            function updateTankTypeVisibility() {
                const selectedTankType = document.querySelector('input[name="tank-type"]:checked').value;
                if (selectedTankType === 'open') {
                    closedTankOptionsDiv.classList.remove('active');
                    // Remove required attributes for closed tank inputs
                    referenceLegDensityInput.removeAttribute('required');
                    referenceLegHeightInput.removeAttribute('required');
                } else { // closed
                    closedTankOptionsDiv.classList.add('active');
                    updateReferenceLegVisibility(); // Also update wet/dry leg visibility
                }
                updateUnitLabelsAndTooltips(); // Update labels after visibility change
                clearResults(); // Clear results when tank type changes
            }

            function updateReferenceLegVisibility() {
                const selectedTankType = document.querySelector('input[name="tank-type"]:checked').value;
                const selectedRefLegType = document.querySelector('input[name="reference-leg-type"]:checked').value;

                if (selectedTankType === 'closed' && selectedRefLegType === 'wet-leg') {
                    wetLegOptionsDiv.classList.add('active');
                    // Set required attributes for wet leg inputs
                    referenceLegDensityInput.setAttribute('required', 'required');
                    referenceLegHeightInput.setAttribute('required', 'required');
                } else {
                    wetLegOptionsDiv.classList.remove('active');
                    // Remove required attributes for wet leg inputs
                    referenceLegDensityInput.removeAttribute('required');
                    referenceLegHeightInput.removeAttribute('required');
                }
                updateUnitLabelsAndTooltips(); // Update labels after visibility change
                clearResults(); // Clear results when reference leg type changes
            }

            function updateDensityInputMethodVisibility() {
                const selectedMethod = document.querySelector('input[name="density-input-method"]:checked').value;
                if (selectedMethod === 'density') {
                    densityInputGroup.classList.add('active');
                    specificGravityInputGroup.classList.remove('active');
                    fluidDensityInput.setAttribute('required', 'required');
                    specificGravityInput.removeAttribute('required');
                } else {
                    densityInputGroup.classList.remove('active');
                    specificGravityInputGroup.classList.add('active');
                    fluidDensityInput.removeAttribute('required');
                    specificGravityInput.setAttribute('required', 'required');
                }
                updateUnitLabelsAndTooltips(); // Update labels after visibility change
                clearResults(); // Clear results when input method changes
            }

            function clearResults() {
                resultContainer.classList.remove('show');
                resultTableBody.innerHTML = '';
                calculationDetailsDiv.innerHTML = '';
                standardReference.innerHTML = '';
                tankLiquid.style.height = '0%'; // Reset liquid animation
                currentLevelDisplay.textContent = '0.00'; // Reset displayed level
                displayMessage("Results cleared.", "info");
            }

            function resetForm() {
                unitSystemSelect.value = defaultValues['unit-system'];
                
                // Reset radio buttons and trigger their change events
                document.querySelector(`input[name="tank-type"][value="${defaultValues['tank-type']}"]`).checked = true;
                updateTankTypeVisibility(); 

                document.querySelector(`input[name="reference-leg-type"][value="${defaultValues['reference-leg-type']}"]`).checked = true;
                updateReferenceLegVisibility();

                document.querySelector(`input[name="density-input-method"][value="${defaultValues['density-input-method']}"]`).checked = true;
                updateDensityInputMethodVisibility();

                fluidDensityInput.value = defaultValues['fluid-density'];
                specificGravityInput.value = defaultValues['specific-gravity'];
                differentialPressureInput.value = defaultValues['differential-pressure'];
                spanLevelInput.value = defaultValues['span-level'];
                zeroLevelInput.value = defaultValues['zero-level'];
                fluidTemperatureInput.value = defaultValues['fluid-temperature'];
                referenceLegDensityInput.value = defaultValues['reference-leg-density'];
                referenceLegHeightInput.value = defaultValues['reference-leg-height'];
                transmitter4mAValueInput.value = defaultValues['transmitter-4ma-value'];
                transmitter20mAValueInput.value = defaultValues['transmitter-20ma-value'];
                
                clearResults(); // Clear results again after inputs are reset
                displayMessage("Form reset to default values (Metric, Open Tank).", "info");
            }

            // Function to display messages (replaces alert())
            function displayMessage(message, type = "info") {
                let messageBox = document.getElementById('custom-message-box');
                if (!messageBox) {
                    messageBox = document.createElement('div');
                    messageBox.id = 'custom-message-box';
                    messageBox.style.cssText = `
                        position: fixed;
                        top: 20px;
                        left: 50%;
                        transform: translateX(-50%);
                        padding: 15px 25px;
                        border-radius: 8px;
                        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
                        z-index: 1000;
                        font-weight: bold;
                        color: white;
                        opacity: 0;
                        transition: opacity 0.5s ease-in-out, transform 0.3s ease-out;
                        display: flex; /* Use flex for centering text */
                        align-items: center;
                        justify-content: center;
                        min-width: 250px; /* Ensure it's wide enough */
                    `;
                    document.body.appendChild(messageBox);
                }

                messageBox.textContent = message;
                if (type === "error") {
                    messageBox.style.backgroundColor = '#dc3545'; /* Red */
                } else if (type === "warning") {
                    messageBox.style.backgroundColor = '#ffc107'; /* Amber */
                    messageBox.style.color = '#333';
                } else {
                    messageBox.style.backgroundColor = '#28a745'; /* Green */
                }
                messageBox.style.opacity = 1;
                messageBox.style.transform = 'translateX(-50%) translateY(0)'; // Bring to position

                // Hide after 5 seconds
                setTimeout(() => {
                    messageBox.style.opacity = 0;
                    messageBox.style.transform = 'translateX(-50%) translateY(-20px)'; // Fade out and move up
                }, 5000);
            }

            function calculateLevel() {
                clearResults(); // Clear previous results
                const selectedSystem = unitSystemSelect.value;
                const config = unitsConfig[selectedSystem];

                let fluidDensity_input = parseFloat(fluidDensityInput.value);
                let specificGravity_input = parseFloat(specificGravityInput.value);
                let differentialPressure = parseFloat(differentialPressureInput.value);
                let spanLevel = parseFloat(spanLevelInput.value);
                let zeroLevel = parseFloat(zeroLevelInput.value);
                let fluidTemperature = parseFloat(fluidTemperatureInput.value); // For context/display
                let transmitter4mAValue = parseFloat(transmitter4mAValueInput.value);
                let transmitter20mAValue = parseFloat(transmitter20mAValueInput.value);

                const tankType = document.querySelector('input[name="tank-type"]:checked').value;
                const referenceLegType = document.querySelector('input[name="reference-leg-type"]:checked').value;
                const densityInputMethod = document.querySelector('input[name="density-input-method"]:checked').value;

                let referenceLegDensity_input = 0;
                let referenceLegHeight_input = 0;

                // Input Validation
                if (densityInputMethod === 'density' && (isNaN(fluidDensity_input) || fluidDensity_input <= 0)) {
                    displayMessage("Please enter a valid positive Fluid Density.", "error");
                    return;
                }
                if (densityInputMethod === 'specific-gravity' && (isNaN(specificGravity_input) || specificGravity_input <= 0)) {
                    displayMessage("Please enter a valid positive Specific Gravity.", "error");
                    return;
                }
                if (isNaN(differentialPressure)) {
                    displayMessage("Please enter a valid Differential Pressure.", "error");
                    return;
                }
                if (isNaN(spanLevel) || spanLevel <= 0) {
                    displayMessage("Please enter a valid positive Tank Span (Max Level).", "error");
                    return;
                }
                if (isNaN(zeroLevel)) {
                    displayMessage("Please enter a valid Tank Zero (Min Level).", "error");
                    return;
                }
                if (zeroLevel >= spanLevel) {
                    displayMessage("Tank Zero (Min Level) must be less than Tank Span (Max Level).", "error");
                    return;
                }
                if (isNaN(fluidTemperature)) {
                    displayMessage("Please enter a valid Fluid Temperature.", "error");
                    return;
                }
                if (isNaN(transmitter4mAValue) || isNaN(transmitter20mAValue) || transmitter4mAValue === transmitter20mAValue) {
                    displayMessage("Please enter valid and different 4mA and 20mA transmitter values.", "error");
                    return;
                }

                // Determine fluid density in SI units
                let fluidDensity_si;
                let fluidDensity_display_val; // Value in selected unit system
                let fluidDensity_display_unit; // Unit in selected unit system

                if (densityInputMethod === 'density') {
                    fluidDensity_si = fluidDensity_input * config.density.toSI;
                    fluidDensity_display_val = fluidDensity_input.toFixed(config.densityPrecision);
                    fluidDensity_display_unit = config.density.label;
                } else {
                    fluidDensity_si = specificGravity_input * config.waterDensityRef * config.density.toSI;
                    fluidDensity_display_val = specificGravity_input.toFixed(3);
                    fluidDensity_display_unit = 'SG';
                }

                // Convert other inputs to SI units for calculation
                let differentialPressure_si = differentialPressure * config.pressure.toSI;
                let spanLevel_si = spanLevel * config.length.toSI;
                let zeroLevel_si = zeroLevel * config.length.toSI;
                let gravity = config.gravity; // Use appropriate gravity for the selected system's base length unit

                let calculationHtml = '<h4>Detailed Calculation Steps:</h4>';
                calculationHtml += `<p><strong>Unit System:</strong> ${selectedSystem.toUpperCase()}</p>`;
                calculationHtml += `<p><strong>Tank Configuration:</strong> ${tankType.charAt(0).toUpperCase() + tankType.slice(1)} Tank</p>`;
                
                calculationHtml += `<p><strong>1. Input Parameters and Unit Conversions:</strong></p>`;
                calculationHtml += `<p>All input values are first converted to the International System of Units (SI) for consistent calculation, then converted back for display.</p>`;
                calculationHtml += `<p class="calculation-step">Fluid Density (ρ<sub>fluid</sub>) = ${fluidDensity_display_val} ${fluidDensity_display_unit} = ${fluidDensity_si.toFixed(3)} kg/m³</p>`;
                calculationHtml += `<p class="calculation-step">Differential Pressure (ΔP) = ${differentialPressure.toFixed(config.dpPrecision)} ${config.pressure.label} = ${differentialPressure_si.toFixed(2)} Pa</p>`;
                calculationHtml += `<p class="calculation-step">Tank Span (H<sub>span</sub>) = ${spanLevel.toFixed(config.levelPrecision)} ${config.length.label} = ${spanLevel_si.toFixed(3)} m</p>`;
                calculationHtml += `<p class="calculation-step">Tank Zero (H<sub>zero</sub>) = ${zeroLevel.toFixed(config.levelPrecision)} ${config.length.label} = ${zeroLevel_si.toFixed(3)} m</p>`;
                calculationHtml += `<p class="calculation-step">Fluid Temperature = ${fluidTemperature.toFixed(config.tempPrecision)} ${config.temperature.label}</p>`;
                calculationHtml += `<p class="calculation-step">Acceleration due to Gravity (g) = ${gravity.toFixed(3)} ${selectedSystem === 'metric' ? 'm/s²' : 'ft/s²'}</p>`;

                let calculatedLevel_si; // Level in meters (SI base)
                let dp_lrv_si; // DP at zero level in Pa
                let dp_urv_si; // DP at span level in Pa

                if (tankType === 'open') {
                    // Formula for Open Tank: Level = DP / (Fluid Density * g)
                    calculatedLevel_si = differentialPressure_si / (fluidDensity_si * gravity);
                    
                    // DP for LRV and URV
                    dp_lrv_si = fluidDensity_si * gravity * zeroLevel_si;
                    dp_urv_si = fluidDensity_si * gravity * spanLevel_si;

                    calculationHtml += `<p><strong>2. Level Calculation for Open Tank:</strong></p>`;
                    calculationHtml += `<p>For an open tank, the differential pressure directly represents the hydrostatic head of the fluid above the lower tap. The formula is straightforward:</p>`;
                    calculationHtml += `<p class="formula">Level = ΔP / (ρ<sub>fluid</sub> &times; g)</p>`;
                    calculationHtml += `<p class="calculation-step">Level = ${differentialPressure_si.toFixed(2)} Pa / (${fluidDensity_si.toFixed(3)} kg/m³ &times; ${gravity.toFixed(3)} ${selectedSystem === 'metric' ? 'm/s²' : 'ft/s²'})</p>`;
                    calculationHtml += `<p class="calculation-step">Level = ${calculatedLevel_si.toFixed(3)} m</p>`;

                } else { // closed tank
                    if (referenceLegType === 'wet-leg') {
                        referenceLegDensity_input = parseFloat(referenceLegDensityInput.value);
                        referenceLegHeight_input = parseFloat(referenceLegHeightInput.value);

                        if (isNaN(referenceLegDensity_input) || referenceLegDensity_input <= 0) {
                            displayMessage("Please enter a valid positive Reference Leg Fluid Density.", "error");
                            return;
                        }
                        if (isNaN(referenceLegHeight_input) || referenceLegHeight_input <= 0) {
                            displayMessage("Please enter a valid positive Reference Leg Height.", "error");
                            return;
                        }

                        let referenceLegDensity_si = referenceLegDensity_input * config.density.toSI;
                        let referenceLegHeight_si = referenceLegHeight_input * config.length.toSI;

                        const refLegPressure_si = referenceLegDensity_si * gravity * referenceLegHeight_si;
                        calculatedLevel_si = (differentialPressure_si + refLegPressure_si) / (fluidDensity_si * gravity);

                        // DP for LRV and URV for Wet Leg
                        dp_lrv_si = (fluidDensity_si * gravity * zeroLevel_si) - refLegPressure_si;
                        dp_urv_si = (fluidDensity_si * gravity * spanLevel_si) - refLegPressure_si;


                        calculationHtml += `<p><strong>2. Level Calculation for Closed Tank with Wet Leg:</strong></p>`;
                        calculationHtml += `<p>For a closed tank with a wet leg, the reference leg exerts a constant hydrostatic pressure on the low-pressure side of the DP transmitter. This pressure must be compensated for in the calculation.</p>`;
                        calculationHtml += `<p class="calculation-step">Reference Leg Fluid Density (ρ<sub>ref</sub>) = ${referenceLegDensity_input.toFixed(config.densityPrecision)} ${config.density.label} = ${referenceLegDensity_si.toFixed(3)} kg/m³</p>`;
                        calculationHtml += `<p class="calculation-step">Reference Leg Height (H<sub>ref</sub>) = ${referenceLegHeight_input.toFixed(config.heightPrecision)} ${config.length.label} = ${referenceLegHeight_si.toFixed(3)} m</p>`;
                        calculationHtml += `<p class="calculation-step">Reference Leg Pressure (P<sub>ref</sub>) = ρ<sub>ref</sub> &times; g &times; H<sub>ref</sub></p>`;
                        calculationHtml += `<p class="calculation-step">P<sub>ref</sub> = ${referenceLegDensity_si.toFixed(3)} kg/m³ &times; ${gravity.toFixed(3)} ${selectedSystem === 'metric' ? 'm/s²' : 'ft/s²'} &times; ${referenceLegHeight_si.toFixed(3)} m = ${refLegPressure_si.toFixed(2)} Pa</p>`;
                        calculationHtml += `<p class="formula">Level = (ΔP + P<sub>ref</sub>) / (ρ<sub>fluid</sub> &times; g)</p>`;
                        calculationHtml += `<p class="calculation-step">Level = (${differentialPressure_si.toFixed(2)} Pa + ${refLegPressure_si.toFixed(2)} Pa) / (${fluidDensity_si.toFixed(3)} kg/m³ &times; ${gravity.toFixed(3)} ${selectedSystem === 'metric' ? 'm/s²' : 'ft/s²'})</p>`;
                        calculationHtml += `<p class="calculation-step">Level = ${calculatedLevel_si.toFixed(3)} m</p>`;

                    } else { // dry leg
                        // Formula for Closed Tank (Dry Leg): Level = DP / (Fluid Density * g) - same as open tank if vapor density is negligible
                        calculatedLevel_si = differentialPressure_si / (fluidDensity_si * gravity);

                        // DP for LRV and URV for Dry Leg (assuming vapor pressure cancels out)
                        dp_lrv_si = fluidDensity_si * gravity * zeroLevel_si;
                        dp_urv_si = fluidDensity_si * gravity * spanLevel_si;

                        calculationHtml += `<p><strong>2. Level Calculation for Closed Tank with Dry Leg:</strong></p>`;
                        calculationHtml += `<p>For a closed tank with a dry leg, the pressure on the high-pressure side is due to the liquid head, and the pressure on the low-pressure side is the vapor pressure. Assuming vapor density is negligible compared to liquid density, the calculation is similar to an open tank.</p>`;
                        calculationHtml += `<p class="formula">Level = ΔP / (ρ<sub>fluid</sub> &times; g)</p>`;
                        calculationHtml += `<p class="calculation-step">Level = ${differentialPressure_si.toFixed(2)} Pa / (${fluidDensity_si.toFixed(3)} kg/m³ &times; ${gravity.toFixed(3)} ${selectedSystem === 'metric' ? 'm/s²' : 'ft/s²'})</p>`;
                        calculationHtml += `<p class="calculation-step">Level = ${calculatedLevel_si.toFixed(3)} m</p>`;
                    }
                }

                // Adjust calculated level based on zero offset
                let finalLevel_si = calculatedLevel_si - zeroLevel_si;

                // Convert final level back to selected unit system for display
                let finalLevel_display = finalLevel_si / config.length.toSI;

                // Ensure level doesn't go below zero or above span (due to sensor range or physical limits)
                if (finalLevel_display < zeroLevel) {
                    finalLevel_display = zeroLevel;
                    displayMessage("Calculated level is below tank zero. Displaying minimum level.", "warning");
                } else if (finalLevel_display > spanLevel) {
                    finalLevel_display = spanLevel;
                    displayMessage("Calculated level is above tank span. Displaying maximum level.", "warning");
                }

                calculationHtml += `<p><strong>3. Adjust for Tank Zero and Final Result:</strong></p>`;
                calculationHtml += `<p>The calculated level is adjusted by the Tank Zero (minimum level) to provide the actual measured level within the tank's defined range.</p>`;
                calculationHtml += `<p class="formula">Adjusted Level (SI) = Calculated Level (SI) - H<sub>zero</sub> (SI)</p>`;
                calculationHtml += `<p class="calculation-step">Adjusted Level = ${calculatedLevel_si.toFixed(3)} m - ${zeroLevel_si.toFixed(3)} m = ${finalLevel_si.toFixed(3)} m</p>`;
                calculationHtml += `<p class="calculation-step">Final Level (${config.length.label}) = Adjusted Level (SI) / Conversion Factor</p>`;
                calculationHtml += `<p class="calculation-step">Final Level = ${finalLevel_si.toFixed(3)} m / ${config.length.toSI.toFixed(4)} = ${finalLevel_display.toFixed(config.levelPrecision)} ${config.length.label}</p>`;

                // Transmitter Output Calculation
                const mA_range = transmitter20mAValue - transmitter4mAValue;
                const level_range_si = spanLevel_si - zeroLevel_si;
                let current_mA_output = 0;
                let current_dp_at_level_si = 0; // DP corresponding to the current calculated level

                if (level_range_si > 0) {
                    // Calculate DP corresponding to the current level
                    if (tankType === 'open' || referenceLegType === 'dry-leg') {
                        current_dp_at_level_si = fluidDensity_si * gravity * finalLevel_si;
                    } else { // wet-leg
                        const refLegDensity_si = referenceLegDensity_input * config.density.toSI;
                        const refLegHeight_si = referenceLegHeight_input * config.length.toSI;
                        const refLegPressure_si = refLegDensity_si * gravity * refLegHeight_si;
                        current_dp_at_level_si = (fluidDensity_si * gravity * finalLevel_si) - refLegPressure_si;
                    }

                    // Calculate mA output
                    const level_percentage = (finalLevel_si - zeroLevel_si) / level_range_si;
                    current_mA_output = transmitter4mAValue + (mA_range * level_percentage);
                    // Clamp mA output to 4-20mA range
                    current_mA_output = Math.max(Math.min(current_mA_output, transmitter20mAValue), transmitter4mAValue);
                } else {
                    displayMessage("Tank span and zero level are the same, cannot calculate mA output.", "warning");
                }

                calculationHtml += `<p><strong>4. Transmitter Ranging and Output:</strong></p>`;
                calculationHtml += `<p>For proper transmitter configuration, it's essential to determine the differential pressure at the zero (LRV) and span (URV) levels, as well as the corresponding current output for the measured level.</p>`;
                calculationHtml += `<p class="formula">DP<sub>LRV</sub> = (ρ<sub>fluid</sub> &times; g &times; H<sub>zero</sub>) - P<sub>offset</sub></p>`;
                calculationHtml += `<p class="formula">DP<sub>URV</sub> = (ρ<sub>fluid</sub> &times; g &times; H<sub>span</sub>) - P<sub>offset</sub></p>`;
                if (tankType === 'closed' && referenceLegType === 'wet-leg') {
                    const refLegDensity_si = referenceLegDensity_input * config.density.toSI;
                    const refLegHeight_si = referenceLegHeight_input * config.length.toSI;
                    const refLegPressure_si = refLegDensity_si * gravity * refLegHeight_si;
                    calculationHtml += `<p class="calculation-step">Where P<sub>offset</sub> = ρ<sub>ref</sub> &times; g &times; H<sub>ref</sub> = ${refLegPressure_si.toFixed(2)} Pa (for wet leg)</p>`;
                } else {
                    calculationHtml += `<p class="calculation-step">Where P<sub>offset</sub> = 0 (for open tank or dry leg, assuming vapor pressure cancels)</p>`;
                }
                calculationHtml += `<p class="formula">mA Output = mA<sub>4mA</sub> + ( (mA<sub>20mA</sub> - mA<sub>4mA</sub>) &times; (Level - H<sub>zero</sub>) / (H<sub>span</sub> - H<sub>zero</sub>) )</p>`;
                calculationHtml += `<p class="calculation-step">DP at Zero Level (LRV) = ${dp_lrv_si.toFixed(2)} Pa (${(dp_lrv_si / config.pressure.toSI).toFixed(config.dpPrecision)} ${config.pressure.label})</p>`;
                calculationHtml += `<p class="calculation-step">DP at Span Level (URV) = ${dp_urv_si.toFixed(2)} Pa (${(dp_urv_si / config.pressure.toSI).toFixed(config.dpPrecision)} ${config.pressure.label})</p>`;
                calculationHtml += `<p class="calculation-step">Current DP at Calculated Level = ${current_dp_at_level_si.toFixed(2)} Pa (${(current_dp_at_level_si / config.pressure.toSI).toFixed(config.dpPrecision)} ${config.pressure.label})</p>`;
                calculationHtml += `<p class="calculation-step">Calculated mA Output = ${current_mA_output.toFixed(2)} mA</p>`;


                // Display Results in table
                resultTableBody.innerHTML = '';
                addResultRow("Fluid Density Input", `${fluidDensity_display_val} ${fluidDensity_display_unit}`);
                addResultRow("Fluid Density (Calculated)", `${fluidDensity_si.toFixed(3)} kg/m³`);
                addResultRow("Fluid Temperature", `${fluidTemperature.toFixed(config.tempPrecision)} ${config.temperature.label}`);
                addResultRow("Differential Pressure (ΔP)", `${differentialPressure.toFixed(config.dpPrecision)} ${config.pressure.label}`);
                addResultRow("Tank Span (Max Level)", `${spanLevel.toFixed(config.levelPrecision)} ${config.length.label}`);
                addResultRow("Tank Zero (Min Level)", `${zeroLevel.toFixed(config.levelPrecision)} ${config.length.label}`);
                addResultRow("Tank Type", tankType.charAt(0).toUpperCase() + tankType.slice(1));
                if (tankType === 'closed') {
                    addResultRow("Reference Leg Type", referenceLegType.charAt(0).toUpperCase() + referenceLegType.slice(1));
                    if (referenceLegType === 'wet-leg') {
                        addResultRow("Reference Leg Fluid Density (ρ<sub>ref</sub>)", `${referenceLegDensity_input.toFixed(config.densityPrecision)} ${config.density.label}`);
                        addResultRow("Reference Leg Height (H<sub>ref</sub>)", `${referenceLegHeight_input.toFixed(config.heightPrecision)} ${config.length.label}`);
                    }
                }
                addResultRow("Transmitter 4mA Value", `${transmitter4mAValue.toFixed(2)} mA`);
                addResultRow("Transmitter 20mA Value", `${transmitter20mAValue.toFixed(2)} mA`);
                addResultRow("<strong>Calculated Level</strong>", `<strong>${finalLevel_display.toFixed(config.levelPrecision)} ${config.length.label}</strong>`);
                addResultRow("DP at Zero Level (LRV)", `${(dp_lrv_si / config.pressure.toSI).toFixed(config.dpPrecision)} ${config.pressure.label}`);
                addResultRow("DP at Span Level (URV)", `${(dp_urv_si / config.pressure.toSI).toFixed(config.dpPrecision)} ${config.pressure.label}`);
                addResultRow("Current DP at Calculated Level", `${(current_dp_at_level_si / config.pressure.toSI).toFixed(config.dpPrecision)} ${config.pressure.label}`);
                addResultRow("<strong>Calculated mA Output</strong>", `<strong>${current_mA_output.toFixed(2)} mA</strong>`);
                
                // Update Tank Visualization
                const tankHeightPx = 250; // Max height of the SVG tank in pixels
                
                // Calculate the actual liquid height in pixels based on the finalLevel_si relative to the span
                let liquidHeightPx = ((finalLevel_si - zeroLevel_si) / (spanLevel_si - zeroLevel_si)) * tankHeightPx;
                liquidHeightPx = Math.max(0, Math.min(tankHeightPx, liquidHeightPx)); // Clamp between 0 and tankHeightPx

                tankLiquid.style.height = `${liquidHeightPx}px`;
                currentLevelDisplay.textContent = `${finalLevel_display.toFixed(config.levelPrecision)} ${config.length.label}`;


                standardRefText = `
                    <h4>International Standards Compliance:</h4>
                    <p>This calculator adheres to the fundamental principles of hydrostatic level measurement, which are widely recognized and applied in various international standards and recommended practices for instrumentation:</p>
                    <ul>
                        <li><strong>ISA-TR20.00.01: Specification Forms for Process Measurement and Control Instruments, Part 1: General Considerations.</strong> While not directly a calculation standard, ISA (International Society of Automation) provides widely accepted terminology and practices for specifying and documenting instrumentation, including level measurement devices.</li>
                        <li><strong>API MPMS (Manual of Petroleum Measurement Standards) Chapter 3: Tank Gauging.</strong> Specifically for the petroleum industry, this manual provides comprehensive guidelines for measuring liquid levels in tanks, including methods that utilize differential pressure, ensuring accurate inventory and custody transfer.</li>
                        <li><strong>ISO 4126: Safety devices for protection against excessive pressure.</strong> Although primarily for pressure relief, understanding hydrostatic pressure is fundamental to safe tank operation and design, which DP level measurement directly relates to.</li>
                        <li><strong>General Principles of Fluid Mechanics and Hydrostatics:</strong> The core calculations are based on fundamental principles such as Pascal's Law and the hydrostatic pressure equation (P = ρgh), which are universal in fluid mechanics and taught in engineering curricula worldwide.</li>
                        <li><strong>Industry Best Practices:</strong> The considerations for open vs. closed tanks, and dry vs. wet reference legs, are standard industry practices for accurate DP level measurement, compensating for varying process conditions and installation types. The inclusion of specific gravity and temperature inputs, along with transmitter ranging and output calculations, further enhances its utility for real-world industrial applications.</li>
                    </ul>
                    <p>This tool provides accurate calculations based on these widely accepted engineering principles and industry practices. For critical applications, always refer to the latest official standards documents, manufacturer's specifications for DP transmitters, and consult with a qualified instrumentation and control professional.</p>
                `;
                standardReference.innerHTML = standardRefText;

                resultContainer.style.display = 'block';
                setTimeout(() => {
                    resultContainer.classList.add('show');
                    calculationDetailsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' }); // Scroll to calculation details
                }, 10);
            }

            // Theme switch logic
            const themeSwitch = document.getElementById('theme-switch');
            if (themeSwitch) {
                if (localStorage.getItem('theme') === 'dark') {
                    document.body.classList.add('dark-mode');
                    themeSwitch.checked = true;
                }

                themeSwitch.addEventListener('change', function() {
                    if (this.checked) {
                        document.body.classList.add('dark-mode');
                        localStorage.setItem('theme', 'dark');
                    } else {
                        document.body.classList.remove('dark-mode');
                        localStorage.setItem('theme', 'light');
                    }
                });
            }
        });
    </script>
</body>
</html>


