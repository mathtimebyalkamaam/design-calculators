<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DP Level Measurement Calculator - Design Calculators - Instrumentation</title>
    <!-- SEO Meta Tags -->
    <meta name="description" content="Professional DP level measurement calculator for open and closed tanks (wet/dry leg). Calculate liquid level from differential pressure in metric/imperial units.">
    <meta name="keywords" content="dp level calculator, differential pressure, level measurement, instrumentation, wet leg, dry leg, open tank, closed tank, plc, dcs">
    <meta name="author" content="Design Calculators">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://designcalculators.co.in/dp-level.html" />
    <!-- AdSense & Analytics -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5936527763614780" crossorigin="anonymous"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-23Y1V450SR"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-23Y1V450SR');
    </script>
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Montserrat:wght@700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- MathJax for Formulas -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['\\(', '\\)'], ['$', '$']],
                displayMath: [['\\[', '\\]'], ['$$', '$$']]
            },
            svg: { fontCache: 'global' }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <!-- PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>
    <!-- Favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">

    <style>
        /* Base styles from 4-20mA Calculator */
        :root {
            --primary: #1E3A8A;
            --secondary: #2563EB;
            --accent: #F59E0B;
            --success: #10B981;
            --danger: #DC2626;
            --warning: #F59E0B;
            --bg: #F8FAFC;
            --card: #FFFFFF;
            --text: #4B5563;
            --heading: #111827;
            --footer-bg: #0F172A;
            --border: #E2E8F0;
            --grad: linear-gradient(135deg, var(--primary), var(--secondary));
            --grad-dark: linear-gradient(135deg, #0F172A, #1E293B);
            --shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.1);
            /* Liquid colors for tank visualization */
            --liquid-color: #3498db;
            --liquid-color-dark: #2980b9;
        }

        body.dark-mode {
            --primary: #10B981;
            --secondary: #34D399;
            --bg: #0F172A;
            --card: #1E293B;
            --text: #CBD5E1;
            --heading: #F1F5F9;
            --footer-bg: #020617;
            --border: #334155;
            /* Dark mode liquid colors */
            --liquid-color: #6dd5ed;
            --liquid-color-dark: #2193b0;
        }

        * { box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.7;
            margin: 0;
            padding: 0;
        }

        .container { max-width: 1280px; margin: 0 auto; padding: 0 24px; }

        /* Header & Nav */
        header {
            background: var(--grad);
            color: white;
            padding: 24px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo-container {
            display: flex;
            flex-direction: column;
            text-decoration: none;
            color: white;
        }
        .logo-text {
            font-size: 1.75rem;
            font-weight: 800;
            font-family: 'Montserrat', sans-serif;
        }
        .logo-subtitle {
            font-size: 0.8rem;
            margin: 4px 0 0 0;
            color: #E0E7FF;
            opacity: 0.9;
        }
        .nav-links {
            display: flex;
            gap: 24px;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        .nav-links a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }
        .nav-links a:hover { color: var(--accent); }
        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .switch {
            position: relative;
            width: 56px;
            height: 30px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.2);
            transition: .4s;
            border-radius: 30px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--accent);
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* Main Content & Cards */
        main { padding: 40px 0; }
        .card {
            background: var(--card);
            border-radius: 12px;
            padding: 30px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            border: 1px solid var(--border);
        }
        h2 {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
            padding-bottom: 15px;
            margin-top: 0;
            font-family: 'Montserrat', sans-serif;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        h3 {
            color: var(--heading);
            font-family: 'Montserrat', sans-serif;
            font-size: 1.5rem;
            margin-top: 25px;
            margin-bottom: 20px;
        }
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--heading);
        }
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 6px;
            background-color: var(--bg);
            color: var(--text);
            font-size: 1rem;
        }
        .form-group input:focus,
        .form-group select:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
        }
        body.dark-mode .form-group input:focus {
             box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .btn {
            background: var(--grad);
            color: white;
            border: none;
            padding: 16px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(30, 58, 138, 0.3);
            transition: all 0.3s;
            width: 100%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(30, 58, 138, 0.4);
        }
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .btn-group .btn {
            flex: 1;
            min-width: 150px;
        }
        .btn.secondary {
            background: var(--secondary);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }
        .btn.accent {
            background: var(--accent);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }
        
        /* Results Table */
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-radius: 8px;
            overflow: hidden;
        }
        .results-table th,
        .results-table td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        .results-table th {
            background: var(--grad);
            color: white;
            font-weight: 700;
        }
        .results-table tr:nth-child(even) {
            background-color: var(--bg);
        }
        .results-table td:first-child {
            font-weight: 600;
            color: var(--heading);
        }
        .results-table .highlight {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--success);
        }

        /* Educational Section */
        .education-section {
            margin-top: 60px;
        }
        .education-section p, .education-section ul {
            font-size: 1.1rem;
            line-height: 1.8;
        }
        .education-section li {
            margin-bottom: 10px;
        }

        /* Message Box */
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 16px 28px;
            border-radius: 8px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.25);
            z-index: 10000;
            font-weight: 600;
            color: white;
            opacity: 0;
            transition: all 0.4s;
            display: none;
        }
        .message-box.show {
            display: block;
            opacity: 1;
            top: 30px;
        }

        /* Footer */
        footer {
            background: var(--grad-dark);
            color: #CBD5E1;
            padding: 50px 0 20px 0;
            margin-top: 60px;
        }
        .footer-content {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 40px;
            margin-bottom: 30px;
        }
        .footer-col {
            flex: 1;
            min-width: 200px;
        }
        .footer-col h4 {
            color: white;
            margin-bottom: 15px;
            font-weight: 700;
        }
        .footer-col ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .footer-col a {
            color: #CBD5E1;
            text-decoration: none;
            transition: color 0.3s;
        }
        .footer-col a:hover {
            color: var(--accent);
        }
        .social-buttons {
            display: flex;
            gap: 12px;
            margin-top: 15px;
        }
        .social-btn {
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            border-radius: 50%;
            font-size: 1.1rem;
            transition: transform 0.3s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .social-btn:hover {
            transform: translateY(-4px);
        }
        .social-btn.linkedin { background-color: #0A66C2; }
        .social-btn.youtube { background-color: #FF0000; }
        .social-btn.twitter { background-color: #1DA1F2; }
        .social-btn.facebook { background-color: #1877F2; }
        .social-btn.whatsapp { background-color: #25D366; }
        .footer-disclaimer {
            text-align: center;
            padding-top: 25px;
            border-top: 1px solid #334155;
            max-width: 800px;
            margin: 0 auto;
            font-size: 0.9rem;
        }
        .footer-bottom {
            text-align: center;
            padding-top: 20px;
            font-size: 0.9rem;
            color: #94A3B8;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container { padding: 0 15px; }
            .navbar { flex-direction: column; gap: 20px; }
            .nav-links { flex-direction: column; gap: 12px; text-align: center; }
            .form-row { grid-template-columns: 1fr; }
            .card { padding: 20px; }
            .footer-content { flex-direction: column; gap: 25px; }
            .btn-group { flex-direction: column; }
        }
        .hidden { display: none; }

        /* Tooltip */
        .info-icon {
            color: var(--primary);
            margin-left: 5px;
            cursor: help;
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 10;
            bottom: 125%;
            left: 50%;
            margin-left: -125px;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            transform: translateY(10px);
            font-family: 'Inter', sans-serif;
            font-size: 0.85rem;
            line-height: 1.4;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
            transform: translateY(0);
        }

        /* --- DP LEVEL CALC SPECIFIC STYLES --- */
        .tool-description {
            margin-bottom: 25px;
            font-size: 1.1rem;
            line-height: 1.7;
        }

        .form-section {
            background-color: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 25px; /* Space between sections */
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }
        .form-section h3 {
            color: var(--secondary);
            margin-top: 0;
            margin-bottom: 15px;
            border-bottom: 1px dashed var(--border);
            padding-bottom: 10px;
        }
        body.dark-mode .form-section h3 {
            color: var(--primary);
        }
        
        .clear-results-btn {
            background-color: var(--danger);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
            margin-top: 15px;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .clear-results-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            background-color: #b91c1c;
        }

        /* Styles for calculation details */
        #calculation-details {
            background-color: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
            font-size: 1rem;
            color: var(--text);
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
        }
        #calculation-details h4 {
            color: var(--secondary);
            margin-top: 0;
            margin-bottom: 15px;
            text-align: left;
            font-size: 1.2em;
        }
        body.dark-mode #calculation-details h4 {
             color: var(--primary);
        }
        #calculation-details p.formula {
            font-family: 'Times New Roman', serif;
            font-style: italic;
            font-size: 1.1em;
            text-align: center;
            padding: 12px 10px;
            background-color: var(--bg);
            border: 1px solid var(--border);
            border-left: 3px solid var(--accent);
            border-radius: 6px;
            margin: 15px 0;
            overflow-x: auto;
        }
        #calculation-details p.calculation-step {
            font-family: 'Courier New', monospace;
            background-color: var(--bg);
            border: 1px solid var(--border);
            padding: 8px 15px;
            border-radius: 4px;
            margin-bottom: 8px;
            color: var(--text);
            white-space: pre-wrap;
            word-break: break-word;
        }
        #calculation-details ul {
            list-style-type: disc;
            margin-left: 25px;
            padding-left: 0;
            margin-top: 15px;
        }
        #calculation-details ul li {
            margin-bottom: 8px;
            color: var(--text);
        }

        /* Specific styles for DP Level Calculator */
        .unit-system-selector, .tank-type-selector, .reference-leg-selector, .density-input-selector {
            margin-bottom: 20px;
            background-color: var(--bg);
            border-radius: 8px;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 15px;
        }
        .unit-system-selector label, .tank-type-selector label, .reference-leg-selector label, .density-input-selector label {
            font-weight: bold;
            color: var(--heading);
            cursor: pointer;
        }
        .tank-type-selector input[type="radio"], .reference-leg-selector input[type="radio"], .density-input-selector input[type="radio"] {
            margin-right: 8px;
            transform: scale(1.2);
            cursor: pointer;
        }

        #closed-tank-options, #wet-leg-options, #density-input-group, #specific-gravity-input-group {
            display: none; /* Hidden by default */
        }
        #closed-tank-options.active, #wet-leg-options.active, #density-input-group.active, #specific-gravity-input-group.active {
            display: grid; /* Use grid to match form-row */
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 15px;
            border-top: 1px dashed var(--border);
            padding-top: 15px;
        }
        
        /* #wet-leg-options is already a .form-row, so it just needs to be shown/hidden */
        #wet-leg-options {
            display: none;
            margin-top: 15px;
            border-top: 1px dashed var(--border);
            padding-top: 15px;
        }
        #wet-leg-options.active {
            display: grid; /* Use grid to match other form-rows */
        }
        /* Need to override the display:grid for the single-input groups */
         #density-input-group.active, #specific-gravity-input-group.active {
            display: block; 
            margin-top: 0;
            border-top: none;
            padding-top: 0;
         }


        /* Tank Visualization */
        .tank-visualization-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 30px;
            margin-bottom: 20px;
            padding: 20px;
            background-color: var(--bg);
            border-radius: 8px;
            box-shadow: var(--shadow);
            flex-direction: column;
            border: 1px solid var(--border);
        }
        .tank-svg {
            width: 150px;
            height: 250px;
            border: 3px solid var(--primary);
            border-radius: 10px;
            position: relative;
            overflow: hidden;
            background-color: var(--card);
        }
        .tank-liquid {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(to top, var(--liquid-color-dark), var(--liquid-color));
            transition: height 1.5s ease-out;
            border-top-left-radius: 5px;
            border-top-right-radius: 5px;
        }
        .tank-level-label {
            margin-top: 10px;
            font-weight: bold;
            color: var(--heading);
            font-size: 1.1em;
        }
    </style>
</head>
<body>
    <div id="message-box" class="message-box"></div>

    <header>
        <div class="container">
            <nav class="navbar">
                <a class='logo-container' href='/'>
                    <span class="logo-text">Design Calculators</span>
                    <p class="logo-subtitle">Inspired by standards such as IEC, IEEE, ISA, ASME, and API.</p>
                </a>
                <ul class="nav-links">
                    <li><a href='/'>Home</a></li>
                    <li><a href="articles.html">Articles</a></li>
                    <li><a href="indexmech.html">Mechanical</a></li>
                    <li><a href="indexele.html">Electrical</a></li>
                    <li><a href="indexinst.html">Instrumentation</a></li>
                </ul>
                <div class="theme-toggle">
                    <i class="fas fa-sun"></i>
                    <label class="switch">
                        <input type="checkbox" id="theme-switch">
                        <span class="slider"></span>
                    </label>
                    <i class="fas fa-moon"></i>
                </div>
            </nav>
        </div>
    </header>

    <main class="container">
        <div class="card">
            <h2><i class="fas fa-layer-group"></i> DP Level Measurement Calculator</h2>
            <div class="tool-description">
                <p>This professional tool accurately determines the liquid level in a tank using differential pressure (DP) measurement. It supports both open and closed tank configurations, including wet and dry reference legs, and provides calculations in both Metric and Imperial units. Essential for process control, inventory management, and safety in all industrial sectors worldwide.</p>
            </div>

            <div class="calculator-form">
                <form id="dp-level-form">
                    <!-- Unit System Selection -->
                    <div class="form-section unit-system-selector">
                        <label for="unit-system">Select Unit System:</label>
                        <select id="unit-system" required>
                            <option value="metric">Metric (m, Pa, kg/m³)</option>
                            <option value="imperial">Imperial (ft, psi, lb/ft³)</option>
                        </select>
                    </div>

                    <!-- Tank Type Selection -->
                    <div class="form-section tank-type-selector">
                        <h3>Tank Configuration</h3>
                        <label>
                            <input type="radio" name="tank-type" value="open" checked> Open Tank
                        </label>
                        <label>
                            <input type="radio" name="tank-type" value="closed"> Closed Tank
                        </label>
                    </div>

                    <!-- Input Parameters -->
                    <div class="form-section">
                        <h3>Measurement Parameters</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="differential-pressure" id="label-differential-pressure">Differential Pressure (ΔP) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext" id="tooltip-differential-pressure">The measured differential pressure from the DP transmitter.</span></span></label>
                                <input type="number" id="differential-pressure" step="0.01" value="9806.65" required>
                            </div>
                            <div class="form-group">
                                <label for="span-level" id="label-span-level">Tank Span (Max Level) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext" id="tooltip-span-level">The maximum measurable liquid level in the tank.</span></span></label>
                                <input type="number" id="span-level" step="0.01" value="1.0" required>
                            </div>
                            <div class="form-group">
                                <label for="zero-level" id="label-zero-level">Tank Zero (Min Level) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext" id="tooltip-zero-level">The minimum measurable liquid level in the tank. Typically 0.</span></span></label>
                                <input type="number" id="zero-level" step="0.01" value="0.0" required>
                            </div>
                            <div class="form-group">
                                <label for="fluid-temperature" id="label-fluid-temperature">Fluid Temperature <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext" id="tooltip-fluid-temperature">The operating temperature of the fluid.</span></span></label>
                                <input type="number" id="fluid-temperature" step="0.1" value="25.0" required>
                            </div>
                        </div>
                    </div>

                    <!-- Fluid Density Input Method -->
                    <div class="form-section density-input-selector">
                        <h3>Fluid Density Input Method</h3>
                        <label>
                            <input type="radio" name="density-input-method" value="density" checked> Direct Density
                        </label>
                        <label>
                            <input type="radio" name="density-input-method" value="specific-gravity"> Specific Gravity (SG)
                        </label>
                    </div>
                    
                    <div class="form-section">
                        <div class="form-row">
                            <div class="form-group" id="density-input-group">
                                <label for="fluid-density" id="label-fluid-density-actual">Fluid Density (ρ<sub>fluid</sub>) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext" id="tooltip-fluid-density-actual">The density of the liquid in the tank.</span></span></label>
                                <input type="number" id="fluid-density" step="0.01" value="1000.0" required>
                            </div>
                            <div class="form-group" id="specific-gravity-input-group">
                                <label for="specific-gravity" id="label-specific-gravity">Specific Gravity (SG) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext" id="tooltip-specific-gravity">The ratio of the fluid's density to water's density.</span></span></label>
                                <input type="number" id="specific-gravity" step="0.001" value="1.0" required>
                            </div>
                        </div>
                    </div>

                    <!-- Closed Tank Specific Options -->
                    <div id="closed-tank-options" class="form-section">
                        <h3>Closed Tank Reference Leg</h3>
                        <div class="reference-leg-selector">
                            <label>
                                <input type="radio" name="reference-leg-type" value="dry-leg" checked> Dry Leg
                            </label>
                            <label>
                                <input type="radio" name="reference-leg-type" value="wet-leg"> Wet Leg
                            </label>
                        </div>

                        <!-- Wet Leg Specific Properties -->
                        <div id="wet-leg-options" class="form-row">
                            <div class="form-group">
                                <label for="reference-leg-density" id="label-reference-leg-density">Reference Leg Fluid Density (ρ<sub>ref</sub>) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext" id="tooltip-reference-leg-density">The density of the fluid filling the reference leg.</span></span></label>
                                <input type="number" id="reference-leg-density" step="0.01" value="1000.0" required>
                            </div>
                            <div class="form-group">
                                <label for="reference-leg-height" id="label-reference-leg-height">Reference Leg Height (H<sub>ref</sub>) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext" id="tooltip-reference-leg-height">The height of the reference leg from the lower tap to the upper tap.</span></span></label>
                                <input type="number" id="reference-leg-height" step="0.01" value="1.0" required>
                            </div>
                        </div>
                    </div>

                    <!-- Transmitter Output Parameters -->
                    <div class="form-section">
                        <h3>Transmitter Output Parameters</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="transmitter-4ma-value">Transmitter 4mA Value (mA) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The current output corresponding to the transmitter's Lower Range Value (LRV).</span></span></label>
                                <input type="number" id="transmitter-4ma-value" step="0.01" value="4.0" required>
                            </div>
                            <div class="form-group">
                                <label for="transmitter-20ma-value">Transmitter 20mA Value (mA) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The current output corresponding to the transmitter's Upper Range Value (URV).</span></span></label>
                                <input type="number" id="transmitter-20ma-value" step="0.01" value="20.0" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="btn-group" style="margin-top: 25px;">
                        <button type="button" id="calculate-level-btn" class="btn"><i class="fas fa-calculator"></i> Calculate Level</button>
                        <button type="button" id="reset-form-btn" class="btn accent"><i class="fas fa-sync-alt"></i> Reset Form</button>
                        <button type="button" id="pdf-btn" class="btn secondary" style="display: none;"><i class="fas fa-file-pdf"></i> Download PDF</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Results Section (moved outside main card) -->
        <div id="results-section" class="card hidden">
            <h3><i class="fas fa-clipboard-check"></i> Level Calculation Results</h3>
            
            <div class="tank-visualization-container">
                <div class="tank-svg">
                    <div class="tank-liquid" style="height: 0%;"></div>
                </div>
                <p class="tank-level-label">Current Level: <span id="current-level-display">0.00</span></p>
            </div>
            
            <div id="calculation-details" class="math-content">
                <!-- Calculation steps will be inserted here -->
            </div>
            
            <table class="results-table">
                <thead>
                    <tr>
                        <th>Parameter</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody id="result-table-body">
                    <!-- Results will be dynamically inserted here -->
                </tbody>
            </table>
            
            <div style="display: flex; justify-content: center; margin-top: 20px;">
                <button type="button" id="clear-results-btn" class="clear-results-btn"><i class="fas fa-times-circle"></i> Clear Results</button>
            </div>
        </div>

        <!-- Education/Standards Section -->
        <div id="education-section" class="education-section card">
            <h2><i class="fas fa-lightbulb"></i> Standards & Principles</h2>
            <div id="standard-reference">
                 <!-- Standard reference text will be inserted here by JS -->
            </div>
        </div>

    </main>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-col">
                    <h4>Design Calculators</h4>
                    <p style="font-size: 0.9rem; line-height: 1.6; margin-bottom: 15px;">If you find this tool helpful, please consider sharing it with your colleagues!</p>
                    <div class="social-buttons">
                        <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn linkedin" title="LinkedIn"><i class="fab fa-linkedin-in"></i></a>
                        <a href="https://www.youtube.com/@designcalculators" target="_blank" rel="noopener noreferrer" class="social-btn youtube" title="YouTube"><i class="fab fa-youtube"></i></a>
                        <a href="https://twitter.com/intent/tweet?url=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn twitter" title="Twitter"><i class="fab fa-twitter"></i></a>
                        <a href="https://www.facebook.com/sharer/sharer.php?u=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn facebook" title="Facebook"><i class="fab fa-facebook-f"></i></a>
                        <a href="https://api.whatsapp.com/send?text=Check%20out%20this%20amazing%20engineering%20resource%20https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn whatsapp" title="WhatsApp"><i class="fab fa-whatsapp"></i></a>
                    </div>
                </div>
                <div class="footer-col">
                    <h4>Quick Links</h4>
                    <ul>
                        <li><a href='/'>Home</a></li>
                        <li><a href="indexele.html">Electrical</a></li>
                        <li><a href="indexmech.html">Mechanical</a></li>
                        <li><a href="indexinst.html">Instrumentation</a></li>
                        <li><a href="articles.html">Articles</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>Resources</h4>
                    <ul>
                        <li><a href="about.html">About Us</a></li>
                        <li><a href="contact.html">Contact</a></li>
                        <li><a href="faq.html">FAQ</a></li>
                        <li><a href="privacy-policy.html">Privacy Policy</a></li>
                        <li><a href="terms-of-service.html">Terms of Service</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>More</h4>
                    <ul>
                        <li><a href='/articles.html'>Articles & Whitepapers</a></li>
                        <li><a href="sitemap2.html">Sitemap</a></li>
                        <li><a href="https://www.youtube.com/@designcalculators" target="_blank" rel="noopener noreferrer">YouTube Channel</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-disclaimer">
                <p>This calculator is for educational and preliminary design purposes. Always verify calculations against instrument datasheets and process conditions. Comply with standards like ISA-TR20.00.01 and API MPMS. Consult a qualified instrumentation engineer for critical applications.</p>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Design Calculators. Created by <span style="color: var(--secondary); font-weight: bold;">A Sharma</span>. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- Element Cache ---
            const unitSystemSelect = document.getElementById('unit-system');
            const tankTypeRadios = document.querySelectorAll('input[name="tank-type"]');
            const referenceLegTypeRadios = document.querySelectorAll('input[name="reference-leg-type"]');
            const densityInputMethodRadios = document.querySelectorAll('input[name="density-input-method"]');
            
            const fluidDensityInput = document.getElementById('fluid-density');
            const specificGravityInput = document.getElementById('specific-gravity');
            const differentialPressureInput = document.getElementById('differential-pressure');
            const spanLevelInput = document.getElementById('span-level');
            const zeroLevelInput = document.getElementById('zero-level');
            const fluidTemperatureInput = document.getElementById('fluid-temperature');
            const referenceLegDensityInput = document.getElementById('reference-leg-density');
            const referenceLegHeightInput = document.getElementById('reference-leg-height');
            const transmitter4mAValueInput = document.getElementById('transmitter-4ma-value');
            const transmitter20mAValueInput = document.getElementById('transmitter-20ma-value');

            const closedTankOptionsDiv = document.getElementById('closed-tank-options');
            const wetLegOptionsDiv = document.getElementById('wet-leg-options');
            const densityInputGroup = document.getElementById('density-input-group');
            const specificGravityInputGroup = document.getElementById('specific-gravity-input-group');

            const labelFluidDensityActual = document.getElementById('label-fluid-density-actual');
            const labelSpecificGravity = document.getElementById('label-specific-gravity');
            const labelDifferentialPressure = document.getElementById('label-differential-pressure');
            const labelSpanLevel = document.getElementById('label-span-level');
            const labelZeroLevel = document.getElementById('label-zero-level');
            const labelFluidTemperature = document.getElementById('label-fluid-temperature');
            const labelReferenceLegDensity = document.getElementById('label-reference-leg-density');
            const labelReferenceLegHeight = document.getElementById('label-reference-leg-height');

            const calculateLevelBtn = document.getElementById('calculate-level-btn');
            const resetFormBtn = document.getElementById('reset-form-btn');
            const clearResultsBtn = document.getElementById('clear-results-btn');
            const pdfBtn = document.getElementById('pdf-btn');
            
            const resultsSection = document.getElementById('results-section');
            const resultTableBody = document.getElementById('result-table-body');
            const standardReference = document.getElementById('standard-reference');
            const calculationDetailsDiv = document.getElementById('calculation-details');
            
            const tankLiquid = document.querySelector('.tank-liquid');
            const currentLevelDisplay = document.getElementById('current-level-display');
            const messageBox = document.getElementById('message-box');
            const themeSwitch = document.getElementById('theme-switch');

            let lastInputs = null; // For PDF generation

            // --- Constants ---
            const GRAVITY_SI = 9.80665; // m/s²
            const GRAVITY_IMPERIAL = 32.174; // ft/s²
            const WATER_DENSITY_SI_REF = 1000; // kg/m³ (water at 4°C)
            const WATER_DENSITY_IMPERIAL_REF = 62.43; // lb/ft³ (water at 4°C)

            // Default values for resetting form (Metric, Open Tank)
            const defaultValues = {
                'unit-system': 'metric',
                'tank-type': 'open',
                'density-input-method': 'density',
                'fluid-density': 1000.0, // kg/m³
                'specific-gravity': 1.0,
                'differential-pressure': 9806.65, // Pa (for 1m water)
                'span-level': 1.0, // m
                'zero-level': 0.0, // m
                'fluid-temperature': 25.0, // °C
                'reference-leg-type': 'dry-leg',
                'reference-leg-density': 1000.0, // kg/m³
                'reference-leg-height': 1.0, // m
                'transmitter-4ma-value': 4.0,
                'transmitter-20ma-value': 20.0
            };

            // Unit configurations
            const unitsConfig = {
                'metric': {
                    length: { label: 'm', tooltip: 'meters', toSI: 1 },
                    pressure: { label: 'Pa', tooltip: 'Pascals', toSI: 1 },
                    density: { label: 'kg/m³', tooltip: 'kilograms per cubic meter', toSI: 1 },
                    temperature: { label: '°C', tooltip: 'Celsius' },
                    gravity: GRAVITY_SI,
                    waterDensityRef: WATER_DENSITY_SI_REF,
                    levelPrecision: 3,
                    dpPrecision: 2,
                    densityPrecision: 2,
                    heightPrecision: 3,
                    tempPrecision: 1
                },
                'imperial': {
                    length: { label: 'ft', tooltip: 'feet', toSI: 0.3048 }, // ft to meters
                    pressure: { label: 'psi', tooltip: 'pounds per square inch', toSI: 6894.76 }, // psi to Pa
                    density: { label: 'lb/ft³', tooltip: 'pounds per cubic foot', toSI: 16.0185 }, // lb/ft³ to kg/m³
                    temperature: { label: '°F', tooltip: 'Fahrenheit' },
                    gravity: GRAVITY_IMPERIAL, // ft/s² (Using Imperial gravity for Imperial units)
                    waterDensityRef: WATER_DENSITY_IMPERIAL_REF,
                    levelPrecision: 3,
                    dpPrecision: 3,
                    densityPrecision: 3,
                    heightPrecision: 3,
                    tempPrecision: 1
                }
            };

            // --- Event Listeners ---
            unitSystemSelect.addEventListener('change', updateUnitLabelsAndTooltips);
            tankTypeRadios.forEach(radio => radio.addEventListener('change', updateTankTypeVisibility));
            referenceLegTypeRadios.forEach(radio => radio.addEventListener('change', updateReferenceLegVisibility));
            densityInputMethodRadios.forEach(radio => radio.addEventListener('change', updateDensityInputMethodVisibility));
            calculateLevelBtn.addEventListener('click', calculateLevel);
            resetFormBtn.addEventListener('click', resetForm);
            clearResultsBtn.addEventListener('click', clearResults);
            pdfBtn.addEventListener('click', generatePDF);

            // Theme Toggle
            if (localStorage.getItem('theme') === 'dark') {
                document.body.classList.add('dark-mode');
                themeSwitch.checked = true;
            }
            themeSwitch.addEventListener('change', function() {
                if (this.checked) {
                    document.body.classList.add('dark-mode');
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.body.classList.remove('dark-mode');
                    localStorage.setItem('theme', 'light');
                }
            });

            // --- Initial Setup ---
            updateUnitLabelsAndTooltips();
            updateTankTypeVisibility();
            updateDensityInputMethodVisibility();

            // --- Utility Functions ---
            function showMessage(msg, type = 'success') {
                messageBox.textContent = msg;
                messageBox.style.color = 'white'; // Default
                if (type === 'error') {
                    messageBox.style.backgroundColor = 'var(--danger)';
                } else if (type === 'warning') {
                     messageBox.style.backgroundColor = 'var(--warning)';
                     messageBox.style.color = '#333'; // Dark text for yellow bg
                } else {
                    messageBox.style.backgroundColor = 'var(--success)';
                }
                messageBox.classList.add('show');
                setTimeout(() => messageBox.classList.remove('show'), 4000);
            }

            function format(num, decimals = 3) {
                return parseFloat(num.toFixed(decimals)).toString();
            }
            
            function addResultRow(parameter, value) {
                const row = resultTableBody.insertRow();
                const paramCell = row.insertCell();
                const valueCell = row.insertCell();
                paramCell.innerHTML = parameter;
                valueCell.innerHTML = value;
            }

            // --- UI Update Functions ---
            function updateUnitLabelsAndTooltips() {
                const selectedSystem = unitSystemSelect.value;
                const config = unitsConfig[selectedSystem];
                const tankType = document.querySelector('input[name="tank-type"]:checked').value;
                const refLegType = document.querySelector('input[name="reference-leg-type"]:checked').value;
                const densityInputMethod = document.querySelector('input[name="density-input-method"]:checked').value;

                labelDifferentialPressure.innerHTML = `Differential Pressure (ΔP) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The measured differential pressure from the DP transmitter. Unit: ${config.pressure.tooltip}.</span></span>`;
                labelSpanLevel.innerHTML = `Tank Span (Max Level) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The maximum measurable liquid level in the tank. Unit: ${config.length.tooltip}.</span></span>`;
                labelZeroLevel.innerHTML = `Tank Zero (Min Level) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The minimum measurable liquid level in the tank. Unit: ${config.length.tooltip}.</span></span>`;
                labelFluidTemperature.innerHTML = `Fluid Temperature <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The operating temperature of the fluid. Unit: ${config.temperature.tooltip}.</span></span>`;

                if (densityInputMethod === 'density') {
                    labelFluidDensityActual.innerHTML = `Fluid Density (ρ<sub>fluid</sub>) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The density of the liquid in the tank. Unit: ${config.density.tooltip}.</span></span>`;
                } else {
                    labelSpecificGravity.innerHTML = `Specific Gravity (SG) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The ratio of the fluid's density to water's density. Unit: Dimensionless.</span></span>`;
                }

                if (tankType === 'closed' && refLegType === 'wet-leg') {
                    labelReferenceLegDensity.innerHTML = `Reference Leg Fluid Density (ρ<sub>ref</sub>) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The density of the fluid filling the reference leg. Unit: ${config.density.tooltip}.</span></span>`;
                    labelReferenceLegHeight.innerHTML = `Reference Leg Height (H<sub>ref</sub>) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The height of the reference leg from the lower tap to the upper tap. Unit: ${config.length.tooltip}.</span></span>`;
                }

                // Update input placeholders
                differentialPressureInput.placeholder = `e.g., ${config.pressure.label}`;
                spanLevelInput.placeholder = `e.g., ${config.length.label}`;
                zeroLevelInput.placeholder = `e.g., ${config.length.label}`;
                fluidTemperatureInput.placeholder = `e.g., ${config.temperature.label}`;
                fluidDensityInput.placeholder = `e.g., ${config.density.label}`;
                specificGravityInput.placeholder = `e.g., 1.0`;
                referenceLegDensityInput.placeholder = `e.g., ${config.density.label}`;
                referenceLegHeightInput.placeholder = `e.g., ${config.length.label}`;
            }

            function updateTankTypeVisibility() {
                const selectedTankType = document.querySelector('input[name="tank-type"]:checked').value;
                if (selectedTankType === 'open') {
                    closedTankOptionsDiv.classList.remove('active');
                    referenceLegDensityInput.removeAttribute('required');
                    referenceLegHeightInput.removeAttribute('required');
                } else { // closed
                    closedTankOptionsDiv.classList.add('active');
                    updateReferenceLegVisibility();
                }
                updateUnitLabelsAndTooltips();
                clearResults();
            }

            function updateReferenceLegVisibility() {
                const selectedTankType = document.querySelector('input[name="tank-type"]:checked').value;
                const selectedRefLegType = document.querySelector('input[name="reference-leg-type"]:checked').value;

                if (selectedTankType === 'closed' && selectedRefLegType === 'wet-leg') {
                    wetLegOptionsDiv.classList.add('active');
                    referenceLegDensityInput.setAttribute('required', 'required');
                    referenceLegHeightInput.setAttribute('required', 'required');
                } else {
                    wetLegOptionsDiv.classList.remove('active');
                    referenceLegDensityInput.removeAttribute('required');
                    referenceLegHeightInput.removeAttribute('required');
                }
                updateUnitLabelsAndTooltips();
                clearResults();
            }

            function updateDensityInputMethodVisibility() {
                const selectedMethod = document.querySelector('input[name="density-input-method"]:checked').value;
                if (selectedMethod === 'density') {
                    densityInputGroup.classList.add('active');
                    specificGravityInputGroup.classList.remove('active');
                    fluidDensityInput.setAttribute('required', 'required');
                    specificGravityInput.removeAttribute('required');
                } else {
                    densityInputGroup.classList.remove('active');
                    specificGravityInputGroup.classList.add('active');
                    fluidDensityInput.removeAttribute('required');
                    specificGravityInput.setAttribute('required', 'required');
                }
                updateUnitLabelsAndTooltips();
                clearResults();
            }

            // --- Form & Calculation Logic ---
            function clearResults() {
                resultsSection.classList.add('hidden');
                resultTableBody.innerHTML = '';
                calculationDetailsDiv.innerHTML = '';
                standardReference.innerHTML = '';
                tankLiquid.style.height = '0%';
                currentLevelDisplay.textContent = '0.00';
                pdfBtn.style.display = 'none';
                lastInputs = null;
            }

            function resetForm() {
                unitSystemSelect.value = defaultValues['unit-system'];
                document.querySelector(`input[name="tank-type"][value="${defaultValues['tank-type']}"]`).checked = true;
                document.querySelector(`input[name="reference-leg-type"][value="${defaultValues['reference-leg-type']}"]`).checked = true;
                document.querySelector(`input[name="density-input-method"][value="${defaultValues['density-input-method']}"]`).checked = true;
                
                fluidDensityInput.value = defaultValues['fluid-density'];
                specificGravityInput.value = defaultValues['specific-gravity'];
                differentialPressureInput.value = defaultValues['differential-pressure'];
                spanLevelInput.value = defaultValues['span-level'];
                zeroLevelInput.value = defaultValues['zero-level'];
                fluidTemperatureInput.value = defaultValues['fluid-temperature'];
                referenceLegDensityInput.value = defaultValues['reference-leg-density'];
                referenceLegHeightInput.value = defaultValues['reference-leg-height'];
                transmitter4mAValueInput.value = defaultValues['transmitter-4ma-value'];
                transmitter20mAValueInput.value = defaultValues['transmitter-20ma-value'];
                
                updateTankTypeVisibility();
                updateDensityInputMethodVisibility();
                clearResults();
                showMessage("Form reset to default values (Metric, Open Tank).", "success");
            }

            function calculateLevel() {
                clearResults();
                
                try {
                    const selectedSystem = unitSystemSelect.value;
                    const config = unitsConfig[selectedSystem];

                    let fluidDensity_input = parseFloat(fluidDensityInput.value);
                    let specificGravity_input = parseFloat(specificGravityInput.value);
                    let differentialPressure = parseFloat(differentialPressureInput.value);
                    let spanLevel = parseFloat(spanLevelInput.value);
                    let zeroLevel = parseFloat(zeroLevelInput.value);
                    let fluidTemperature = parseFloat(fluidTemperatureInput.value);
                    let transmitter4mAValue = parseFloat(transmitter4mAValueInput.value);
                    let transmitter20mAValue = parseFloat(transmitter20mAValueInput.value);

                    const tankType = document.querySelector('input[name="tank-type"]:checked').value;
                    const referenceLegType = document.querySelector('input[name="reference-leg-type"]:checked').value;
                    const densityInputMethod = document.querySelector('input[name="density-input-method"]:checked').value;

                    let referenceLegDensity_input = 0;
                    let referenceLegHeight_input = 0;

                    // Input Validation
                    if (densityInputMethod === 'density' && (isNaN(fluidDensity_input) || fluidDensity_input <= 0)) throw new Error("Please enter a valid positive Fluid Density.");
                    if (densityInputMethod === 'specific-gravity' && (isNaN(specificGravity_input) || specificGravity_input <= 0)) throw new Error("Please enter a valid positive Specific Gravity.");
                    if (isNaN(differentialPressure)) throw new Error("Please enter a valid Differential Pressure.");
                    if (isNaN(spanLevel) || spanLevel <= 0) throw new Error("Please enter a valid positive Tank Span (Max Level).");
                    if (isNaN(zeroLevel)) throw new Error("Please enter a valid Tank Zero (Min Level).");
                    if (zeroLevel >= spanLevel) throw new Error("Tank Zero (Min Level) must be less than Tank Span (Max Level).");
                    if (isNaN(fluidTemperature)) throw new Error("Please enter a valid Fluid Temperature.");
                    if (isNaN(transmitter4mAValue) || isNaN(transmitter20mAValue) || transmitter4mAValue === transmitter20mAValue) throw new Error("Please enter valid and different 4mA and 20mA transmitter values.");

                    let fluidDensity_display_val, fluidDensity_display_unit;
                    
                    // --- Use SI units for all internal calculations ---
                    let fluidDensity_si;
                    if (densityInputMethod === 'density') {
                        fluidDensity_si = fluidDensity_input * config.density.toSI;
                        fluidDensity_display_val = format(fluidDensity_input, config.densityPrecision);
                        fluidDensity_display_unit = config.density.label;
                    } else {
                        // When using SG, reference density is in native units, then convert product to SI
                        fluidDensity_si = (specificGravity_input * config.waterDensityRef) * config.density.toSI; 
                        fluidDensity_display_val = format(specificGravity_input, 3);
                        fluidDensity_display_unit = 'SG';
                    }

                    let differentialPressure_si = differentialPressure * config.pressure.toSI;
                    let spanLevel_si = spanLevel * config.length.toSI;
                    let zeroLevel_si = zeroLevel * config.length.toSI;
                    let gravity = GRAVITY_SI; // Always use SI gravity for SI-based calculations

                    let calculationHtml = '<h4>Detailed Calculation Steps:</h4>';
                    calculationHtml += `<p><strong>Unit System:</strong> ${selectedSystem.toUpperCase()}</p>`;
                    calculationHtml += `<p><strong>Tank Configuration:</strong> ${tankType.charAt(0).toUpperCase() + tankType.slice(1)} Tank</p>`;
                    calculationHtml += `<p><strong>1. Input Parameters (Converted to SI for calculation):</strong></p>`;
                    calculationHtml += `<p class="calculation-step">Fluid Density (ρ<sub>fluid</sub>) = ${fluidDensity_display_val} ${fluidDensity_display_unit} = ${format(fluidDensity_si, 3)} kg/m³</p>`;
                    calculationHtml += `<p class="calculation-step">Differential Pressure (ΔP) = ${format(differentialPressure, config.dpPrecision)} ${config.pressure.label} = ${format(differentialPressure_si, 2)} Pa</p>`;
                    calculationHtml += `<p class="calculation-step">Tank Span (H<sub>span</sub>) = ${format(spanLevel, config.levelPrecision)} ${config.length.label} = ${format(spanLevel_si, 3)} m</p>`;
                    calculationHtml += `<p class="calculation-step">Tank Zero (H<sub>zero</sub>) = ${format(zeroLevel, config.levelPrecision)} ${config.length.label} = ${format(zeroLevel_si, 3)} m</p>`;
                    calculationHtml += `<p class="calculation-step">Gravity (g) = ${format(gravity, 5)} m/s²</p>`;

                    let calculatedLevel_si;
                    let dp_lrv_si;
                    let dp_urv_si;

                    if (tankType === 'open') {
                        calculatedLevel_si = differentialPressure_si / (fluidDensity_si * gravity);
                        dp_lrv_si = (fluidDensity_si * gravity * zeroLevel_si);
                        dp_urv_si = (fluidDensity_si * gravity * spanLevel_si);

                        calculationHtml += `<p><strong>2. Level Calculation for Open Tank:</strong></p>`;
                        calculationHtml += `<p class="formula">Level (m) = ΔP / (ρ<sub>fluid</sub> &times; g)</p>`;
                        calculationHtml += `<p class="calculation-step">Level = ${format(differentialPressure_si, 2)} Pa / (${format(fluidDensity_si, 3)} kg/m³ &times; ${format(gravity, 5)} m/s²)</p>`;
                        calculationHtml += `<p class="calculation-step">Calculated Level (SI) = ${format(calculatedLevel_si, 3)} m</p>`;
                    
                    } else { // closed tank
                        if (referenceLegType === 'wet-leg') {
                            referenceLegDensity_input = parseFloat(referenceLegDensityInput.value);
                            referenceLegHeight_input = parseFloat(referenceLegHeightInput.value);

                            if (isNaN(referenceLegDensity_input) || referenceLegDensity_input <= 0) throw new Error("Please enter a valid positive Reference Leg Fluid Density.");
                            if (isNaN(referenceLegHeight_input) || referenceLegHeight_input <= 0) throw new Error("Please enter a valid positive Reference Leg Height.");

                            let referenceLegDensity_si = referenceLegDensity_input * config.density.toSI;
                            let referenceLegHeight_si = referenceLegHeight_input * config.length.toSI;
                            const refLegPressure_si = referenceLegDensity_si * gravity * referenceLegHeight_si;

                            // Level (SI) = (P_high - P_low) / (rho_fluid * g) = ( (P_vapor + P_fluid) - (P_vapor + P_ref) ) / (rho_fluid * g)
                            // This simplifies, but DP is measured as (P_high - P_low)
                            // P_high = P_vapor + (rho_fluid * g * H_level)
                            // P_low = P_vapor + (rho_ref * g * H_ref)
                            // DP = P_high - P_low = (rho_fluid * g * H_level) - (rho_ref * g * H_ref)
                            // So: (rho_fluid * g * H_level) = DP + (rho_ref * g * H_ref)
                            // H_level = (DP + P_ref) / (rho_fluid * g)
                            calculatedLevel_si = (differentialPressure_si + refLegPressure_si) / (fluidDensity_si * gravity);
                            
                            dp_lrv_si = (fluidDensity_si * gravity * zeroLevel_si) - refLegPressure_si;
                            dp_urv_si = (fluidDensity_si * gravity * spanLevel_si) - refLegPressure_si;

                            calculationHtml += `<p><strong>2. Level Calculation for Closed Tank with Wet Leg:</strong></p>`;
                            calculationHtml += `<p class="calculation-step">Ref. Leg Density (ρ<sub>ref</sub>) = ${format(referenceLegDensity_input, config.densityPrecision)} ${config.density.label} = ${format(referenceLegDensity_si, 3)} kg/m³</p>`;
                            calculationHtml += `<p class="calculation-step">Ref. Leg Height (H<sub>ref</sub>) = ${format(referenceLegHeight_input, config.heightPrecision)} ${config.length.label} = ${format(referenceLegHeight_si, 3)} m</p>`;
                            calculationHtml += `<p class="calculation-step">Ref. Leg Pressure (P<sub>ref</sub>) = ρ<sub>ref</sub> &times; g &times; H<sub>ref</sub> = ${format(refLegPressure_si, 2)} Pa</p>`;
                            calculationHtml += `<p class="formula">Level (m) = (ΔP + P<sub>ref</sub>) / (ρ<sub>fluid</sub> &times; g)</p>`;
                            calculationHtml += `<p class="calculation-step">Level = (${format(differentialPressure_si, 2)} Pa + ${format(refLegPressure_si, 2)} Pa) / (${format(fluidDensity_si, 3)} kg/m³ &times; ${format(gravity, 5)} m/s²)</p>`;
                            calculationHtml += `<p class="calculation-step">Calculated Level (SI) = ${format(calculatedLevel_si, 3)} m</p>`;

                        } else { // dry leg
                            // P_high = P_vapor + (rho_fluid * g * H_level)
                            // P_low = P_vapor
                            // DP = P_high - P_low = rho_fluid * g * H_level
                            // H_level = DP / (rho_fluid * g)
                            calculatedLevel_si = differentialPressure_si / (fluidDensity_si * gravity);
                            
                            dp_lrv_si = (fluidDensity_si * gravity * zeroLevel_si);
                            dp_urv_si = (fluidDensity_si * gravity * spanLevel_si);
                            
                            calculationHtml += `<p><strong>2. Level Calculation for Closed Tank with Dry Leg:</strong></p>`;
                            calculationHtml += `<p>(Assuming vapor pressure is equal on both taps and vapor density is negligible)</p>`;
                            calculationHtml += `<p class="formula">Level (m) = ΔP / (ρ<sub>fluid</sub> &times; g)</p>`;
                            calculationHtml += `<p class="calculation-step">Level = ${format(differentialPressure_si, 2)} Pa / (${format(fluidDensity_si, 3)} kg/m³ &times; ${format(gravity, 5)} m/s²)</p>`;
                            calculationHtml += `<p class="calculation-step">Calculated Level (SI) = ${format(calculatedLevel_si, 3)} m</p>`;
                        }
                    }

                    // This `calculatedLevel_si` is the height from the *lower tap*.
                    // The "Final Level" should be this value, or this value relative to the zeroLevel if zeroLevel is not 0.
                    // The prompt defines "Tank Zero (Min Level)" and "Tank Span (Max Level)".
                    // A DP transmitter is typically ranged from 0% at `zeroLevel` to 100% at `spanLevel`.
                    
                    // Convert level from SI back to display units
                    let finalLevel_display = calculatedLevel_si / config.length.toSI;
                    let level_percentage = 0;
                    const level_range_display = spanLevel - zeroLevel;

                    if (level_range_display > 0) {
                        level_percentage = (finalLevel_display - zeroLevel) / level_range_display;
                    }

                    // Clamp level for display and animation
                    let clamped_level_display = Math.max(zeroLevel, Math.min(spanLevel, finalLevel_display));
                    let clamped_level_percentage = Math.max(0, Math.min(1, level_percentage));
                    
                    if (finalLevel_display < zeroLevel) {
                        showMessage("Calculated level is below tank zero. Clamping to minimum level.", "warning");
                    } else if (finalLevel_display > spanLevel) {
                        showMessage("Calculated level is above tank span. Clamping to maximum level.", "warning");
                    }

                    // Transmitter Output Calculation
                    const mA_range = transmitter20mAValue - transmitter4mAValue;
                    let current_mA_output = transmitter4mAValue + (mA_range * level_percentage);
                    let clamped_mA_output = Math.max(transmitter4mAValue, Math.min(transmitter20mAValue, current_mA_output));

                    // Convert DP LRV/URV back to display units
                    let dp_lrv_display = dp_lrv_si / config.pressure.toSI;
                    let dp_urv_display = dp_urv_si / config.pressure.toSI;

                    calculationHtml += `<p><strong>3. Final Level and Transmitter Output:</strong></p>`;
                    calculationHtml += `<p>The calculated level is converted back to display units and used to determine the transmitter's mA output based on its range.</p>`;
                    calculationHtml += `<p class="calculation-step">Final Level (${config.length.label}) = ${format(calculatedLevel_si, 3)} m / ${format(config.length.toSI, 4)} = ${format(finalLevel_display, config.levelPrecision)} ${config.length.label}</p>`;
                    calculationHtml += `<p class="calculation-step">Level % = (Level - Zero) / (Span - Zero) = ${format(level_percentage * 100, 2)}%</p>`;
                    calculationHtml += `<p class="formula">mA Output = mA<sub>LRV</sub> + ( (mA<sub>URV</sub> - mA<sub>LRV</sub>) &times; Level % )</p>`;
                    calculationHtml += `<p class="calculation-step">mA Output = ${format(transmitter4mAValue, 1)}mA + (${format(mA_range, 1)}mA &times; ${format(level_percentage, 3)}) = ${format(current_mA_output, 2)} mA</p>`;
                    
                    calculationHtml += `<p><strong>4. Transmitter Ranging (Calibration):</strong></p>`;
                    calculationHtml += `<p class="calculation-step">DP at Zero Level (LRV) = ${format(dp_lrv_display, config.dpPrecision)} ${config.pressure.label}</p>`;
                    calculationHtml += `<p class="calculation-step">DP at Span Level (URV) = ${format(dp_urv_display, config.dpPrecision)} ${config.pressure.label}</p>`;

                    calculationDetailsDiv.innerHTML = calculationHtml;

                    // Display Results in table
                    resultTableBody.innerHTML = '';
                    addResultRow("Fluid Density Input", `${fluidDensity_display_val} ${fluidDensity_display_unit}`);
                    addResultRow("Fluid Temperature", `${format(fluidTemperature, config.tempPrecision)} ${config.temperature.label}`);
                    addResultRow("Differential Pressure (ΔP)", `${format(differentialPressure, config.dpPrecision)} ${config.pressure.label}`);
                    addResultRow("Tank Span (Max Level)", `${format(spanLevel, config.levelPrecision)} ${config.length.label}`);
                    addResultRow("Tank Zero (Min Level)", `${format(zeroLevel, config.levelPrecision)} ${config.length.label}`);
                    addResultRow("Tank Type", tankType.charAt(0).toUpperCase() + tankType.slice(1));
                    if (tankType === 'closed') {
                        addResultRow("Reference Leg Type", referenceLegType.charAt(0).toUpperCase() + referenceLegType.slice(1));
                        if (referenceLegType === 'wet-leg') {
                            addResultRow("Reference Leg Fluid Density (ρ<sub>ref</sub>)", `${format(referenceLegDensity_input, config.densityPrecision)} ${config.density.label}`);
                            addResultRow("Reference Leg Height (H<sub>ref</sub>)", `${format(referenceLegHeight_input, config.heightPrecision)} ${config.length.label}`);
                        }
                    }
                    addResultRow("<strong>Calculated Level</strong>", `<strong class="highlight">${format(finalLevel_display, config.levelPrecision)} ${config.length.label}</strong>`);
                    addResultRow("Level Percentage", `${format(level_percentage * 100, 2)} %`);
                    addResultRow("<strong>Calculated mA Output</strong>", `<strong class="highlight">${format(current_mA_output, 2)} mA</strong>`);
                    addResultRow("DP at Zero Level (LRV)", `${format(dp_lrv_display, config.dpPrecision)} ${config.pressure.label}`);
                    addResultRow("DP at Span Level (URV)", `${format(dp_urv_display, config.dpPrecision)} ${config.pressure.label}`);

                    // Update Tank Visualization
                    tankLiquid.style.height = `${clamped_level_percentage * 100}%`;
                    currentLevelDisplay.textContent = `${format(clamped_level_display, config.levelPrecision)} ${config.length.label}`;

                    // Populate Standards
                    standardReference.innerHTML = `
                        <h4>International Standards Compliance:</h4>
                        <p>This calculator adheres to the fundamental principles of hydrostatic level measurement, which are widely recognized in international standards and recommended practices:</p>
                        <ul>
                            <li><strong>ISA-TR20.00.01:</strong> Specification Forms for Process Measurement and Control Instruments.</li>
                            <li><strong>API MPMS (Manual of Petroleum Measurement Standards) Chapter 3:</strong> Tank Gauging, which provides comprehensive guidelines for measuring liquid levels, including methods utilizing differential pressure.</li>
                            <li><strong>Fundamental Principles of Fluid Mechanics:</strong> The core calculations are based on the universal hydrostatic pressure equation ($P = \\rho g h$), which is the foundation of all fluid mechanics.</li>
                        </ul>
                        <p>This tool provides accurate calculations based on these accepted engineering principles. For critical applications, always refer to the latest official standards documents and manufacturer's specifications.</p>
                    `;

                    // Store for PDF
                    lastInputs = {
                        config,
                        fluidDensity_display_val, fluidDensity_display_unit,
                        fluidTemperature, differentialPressure,
                        spanLevel, zeroLevel,
                        tankType, referenceLegType,
                        referenceLegDensity_input, referenceLegHeight_input,
                        finalLevel_display, level_percentage,
                        current_mA_output,
                        dp_lrv_display, dp_urv_display
                    };

                    // Show Results
                    resultsSection.classList.remove('hidden');
                    pdfBtn.style.display = 'inline-flex';

                    // Typeset MathJax
                    if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
                        setTimeout(() => {
                            window.MathJax.typesetPromise([calculationDetailsDiv, standardReference]);
                        }, 50);
                    }
                    
                    setTimeout(() => {
                        resultsSection.scrollIntoView({ behavior: 'smooth' });
                    }, 100);
                    showMessage("Calculation successful!", "success");

                } catch (e) {
                    showMessage(e.message, "error");
                    clearResults();
                }
            }

            // --- PDF Generation ---
            function generatePDF() {
                if (!lastInputs) {
                    showMessage('Please run a calculation first.', 'error');
                    return;
                }

                try {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    let y = 15;
                    const { config, ...inputs } = lastInputs;

                    pdf.setFont('helvetica', 'bold');
                    pdf.setFontSize(16);
                    pdf.text('DP Level Measurement Report', 105, y, { align: 'center' });
                    y += 8;

                    pdf.setFont('helvetica', 'normal');
                    pdf.setFontSize(9);
                    pdf.text(`Generated by Design Calculators | ${new Date().toLocaleString()}`, 105, y, { align: 'center' });
                    y += 10;

                    pdf.setFont('helvetica', 'bold');
                    pdf.setFontSize(12);
                    pdf.text('Input Parameters', 14, y);
                    y += 2;

                    let inputRows = [
                        ["Unit System", unitSystemSelect.value],
                        ["Fluid Density Input", `${inputs.fluidDensity_display_val} ${inputs.fluidDensity_display_unit}`],
                        ["Fluid Temperature", `${format(inputs.fluidTemperature, config.tempPrecision)} ${config.temperature.label}`],
                        ["Differential Pressure (ΔP)", `${format(inputs.differentialPressure, config.dpPrecision)} ${config.pressure.label}`],
                        ["Tank Span (Max Level)", `${format(inputs.spanLevel, config.levelPrecision)} ${config.length.label}`],
                        ["Tank Zero (Min Level)", `${format(inputs.zeroLevel, config.levelPrecision)} ${config.length.label}`],
                        ["Tank Type", inputs.tankType.charAt(0).toUpperCase() + inputs.tankType.slice(1)]
                    ];
                    
                    if (inputs.tankType === 'closed') {
                        inputRows.push(["Reference Leg Type", inputs.referenceLegType.charAt(0).toUpperCase() + inputs.referenceLegType.slice(1)]);
                        if (inputs.referenceLegType === 'wet-leg') {
                            inputRows.push(["Ref. Leg Density", `${format(inputs.referenceLegDensity_input, config.densityPrecision)} ${config.density.label}`]);
                            inputRows.push(["Ref. Leg Height", `${format(inputs.referenceLegHeight_input, config.heightPrecision)} ${config.length.label}`]);
                        }
                    }

                    pdf.autoTable({
                        startY: y,
                        head: [['Parameter', 'Value']],
                        body: inputRows,
                        margin: { left: 14, right: 14 },
                        theme: 'grid',
                        headStyles: { fillColor: [30, 58, 138] }
                    });
                    y = pdf.autoTable.previous.finalY + 10;

                    // Add Results
                    pdf.setFont('helvetica', 'bold');
                    pdf.setFontSize(12);
                    pdf.text('Calculation Summary', 14, y);
                    y += 2;

                    const resultRows = Array.from(resultTableBody.querySelectorAll('tr')).map(tr => [
                        tr.cells[0].textContent,
                        tr.cells[1].textContent
                    ]);

                    pdf.autoTable({
                        startY: y,
                        head: [['Parameter', 'Value']],
                        body: resultRows,
                        margin: { left: 14, right: 14 },
                        theme: 'grid',
                        headStyles: { fillColor: [30, 58, 138] },
                        didParseCell: function (data) {
                            if (data.cell.text[0].includes('Calculated Level') || data.cell.text[0].includes('Calculated mA Output')) {
                                data.cell.styles.textColor = [16, 185, 129]; // Green
                                data.cell.styles.fontStyle = 'bold';
                                data.row.cells[1].styles.textColor = [16, 185, 129];
                                data.row.cells[1].styles.fontStyle = 'bold';
                            }
                        }
                    });
                    y = pdf.autoTable.previous.finalY + 15;

                    // Add footer
                    pdf.setFont('helvetica', 'normal');
                    pdf.setFontSize(10);
                    pdf.setTextColor(40, 40, 40);
                    pdf.text('For more calculators and information, visit http://designcalculators.co.in', 105, y, { align: 'center' });
                    y += 5;
                    pdf.setFontSize(8);
                    pdf.setTextColor(100, 100, 100);
                    pdf.text('This report is for guidance only. Always verify scaling and calibration in your PLC/DCS.', 105, y, { align: 'center' });

                    pdf.save('DP-Level-Calculation-Report.pdf');
                    showMessage('PDF downloaded successfully');

                } catch (e) {
                    showMessage(`Error generating PDF: ${e.message}`, 'error');
                }
            }

        });
    </script>
</body>
</html>


