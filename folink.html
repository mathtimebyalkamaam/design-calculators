<!DOCTYPE html>
<html lang="en">
<head>
    <!-- AdSense & Analytics -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5936527763614780" crossorigin="anonymous"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-23Y1V450SR"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-23Y1V450SR');
    </script>
    
    <!-- SEO Meta Tags -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Commercial Fiber Optic Link Budget Calculator (PON/P2P) - Industrial Grade</title>
    <meta name="description" content="Calculate Fiber Optic Link Loss Budgets for P2P and FTTH/PON networks. Compliant with TIA-568.3-D & ISO 11801. Analyze splitter loss, connector loss, and SFP transceiver headroom.">
    <meta name="keywords" content="Fiber Loss Calculator, Optical Power Budget, GPON Calculator, TIA-568, ISO 11801, 10GBASE-LR, Splitter Loss, OTDR Simulation, WDM Loss, Fiber Optic Attenuation">
    <meta name="author" content="Design Calculators">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://designcalculators.co.in/folink" />

    <!-- Schema.org Structured Data -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@graph": [
        {
          "@type": "SoftwareApplication",
          "name": "Fiber Optic Link Budget Calculator",
          "applicationCategory": "UtilitiesApplication",
          "operatingSystem": "Any",
          "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "USD"
          },
          "description": "Calculates optical loss budgets for single-mode and multimode fiber links, including PON splitters and WDM components."
        },
        {
          "@type": "FAQPage",
          "mainEntity": [
            {
              "@type": "Question",
              "name": "What is an Optical Link Budget?",
              "acceptedAnswer": {
                "@type": "Answer",
                "text": "An optical link budget is the calculation of all potential losses in a fiber optic link (cable attenuation, connectors, splices, splitters) to ensure the total loss is less than the power budget (Transmitter Power - Receiver Sensitivity) of the network equipment."
              }
            },
            {
              "@type": "Question",
              "name": "What is the standard loss for a fiber connector?",
              "acceptedAnswer": {
                "@type": "Answer",
                "text": "According to TIA-568.3-D, the maximum allowable loss per mated connector pair is 0.75 dB. However, in modern high-quality deployments, typical loss is often between 0.3 dB and 0.5 dB."
              }
            },
            {
              "@type": "Question",
              "name": "How much loss does a 1:32 optical splitter add?",
              "acceptedAnswer": {
                "@type": "Answer",
                "text": "A theoretical 1:32 split divides the light 32 ways, resulting in 15 dB of loss (10*log(32)). In practice, due to manufacturing imperfections and internal connectors, the insertion loss is typically between 17.0 dB and 17.5 dB."
              }
            },
            {
              "@type": "Question",
              "name": "Why is 1550nm loss lower than 1310nm?",
              "acceptedAnswer": {
                "@type": "Answer",
                "text": "This is due to Rayleigh Scattering, which decreases as wavelength increases. In standard Single Mode fiber (OS2), attenuation is typically ~0.35 dB/km at 1310nm and ~0.22 dB/km at 1550nm."
              }
            }
          ]
        }
      ]
    }
    </script>

    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Montserrat:wght@700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>

    <!-- Chart.js for Visuals -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1/dist/chartjs-plugin-annotation.min.js"></script>

    <!-- MathJax for Formulas -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['\\(', '\\)'], ['$', '$']],
                displayMath: [['\\[', '\\]'], ['$$', '$$']]
            },
            svg: { fontCache: 'global' }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <!-- Favicon Links -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">

    <style>
        /* --- CORE THEME (Blue Industrial) --- */
        :root {
            --primary: #1E3A8A; /* Dark Blue */
            --secondary: #2563EB; /* Bright Blue */
            --accent: #F59E0B; /* Amber */
            --success: #10B981;
            --danger: #DC2626;
            --warning: #F59E0B;
            --bg: #F8FAFC;
            --card: #FFFFFF;
            --text: #4B5563;
            --heading: #111827;
            --footer-bg: #0F172A;
            --border: #E2E8F0;
            --grad: linear-gradient(135deg, var(--primary), var(--secondary));
            --grad-dark: linear-gradient(135deg, #0F172A, #1E293B);
            --shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.1);
            --input-bg: #FFFFFF;
        }

        body.dark-mode {
            --primary: #10B981;
            --secondary: #34D399;
            --bg: #0F172A;
            --card: #1E293B;
            --text: #CBD5E1;
            --heading: #F1F5F9;
            --footer-bg: #020617;
            --border: #334155;
            --accent: #F59E0B;
            --input-bg: #334155;
        }

        * { box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.6;
            margin: 0;
            padding: 0;
        }

        .container { max-width: 1400px; margin: 0 auto; padding: 0 24px; } /* Wider container for heavy app */

        /* Header & Nav */
        header {
            background: var(--grad);
            color: white;
            padding: 24px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo-container {
            display: flex;
            flex-direction: column;
            text-decoration: none;
            color: white;
        }
        .logo-text {
            font-size: 1.75rem;
            font-weight: 800;
            font-family: 'Montserrat', sans-serif;
        }
        .logo-subtitle {
            font-size: 0.8rem;
            margin: 4px 0 0 0;
            color: #E0E7FF;
            opacity: 0.9;
        }
        .nav-links {
            display: flex;
            gap: 24px;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        .nav-links a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }
        .nav-links a:hover { color: var(--accent); }
        
        /* Theme Toggle */
        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
            color: white;
        }
        .switch {
            position: relative;
            width: 56px;
            height: 30px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0,0,0,0.2);
            transition: .4s;
            border-radius: 30px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 22px; width: 22px;
            left: 4px; bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(26px); }

        /* Main Content & Cards */
        main { padding: 30px 0; }
        .card {
            background: var(--card);
            border-radius: 12px;
            padding: 25px;
            box-shadow: var(--shadow);
            margin-bottom: 25px;
            border: 1px solid var(--border);
            animation: fadeIn 0.6s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* SEO Ranking: Use H1 for main title but keep H2 style */
        .card h1.tool-title {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
            padding-bottom: 15px;
            margin-top: 0;
            font-family: 'Montserrat', sans-serif;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        h2 {
            color: var(--primary);
            font-family: 'Montserrat', sans-serif;
            font-size: 1.6rem;
            margin-top: 0;
            border-bottom: 2px solid var(--border);
            padding-bottom: 15px;
        }
        h3 {
            color: var(--heading);
            font-family: 'Montserrat', sans-serif;
            font-size: 1.4rem;
            margin-top: 10px;
            margin-bottom: 15px;
        }
        h4 {
            color: var(--heading);
            font-size: 1.1rem;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 8px;
        }

        /* Commercial Grid Layout */
        .app-layout {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 25px;
        }
        @media (max-width: 1024px) {
            .app-layout { grid-template-columns: 1fr; }
        }

        /* Forms & Inputs */
        .input-panel {
            background: var(--bg);
            border-radius: 8px;
            border: 1px solid var(--border);
            padding: 20px;
        }
        .form-section { margin-bottom: 25px; }
        .form-group { margin-bottom: 15px; }
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--heading);
            display: flex;
            justify-content: space-between;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--border);
            border-radius: 6px;
            background-color: var(--card);
            color: var(--text);
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }
        .form-group input:focus, .form-group select:focus {
            border-color: var(--primary);
            outline: none;
        }
        
        .compact-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        /* Buttons */
        .btn {
            background: var(--grad);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 700;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.2s;
            width: 100%;
            text-align: center;
        }
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        .btn-outline {
            background: transparent;
            border: 2px solid var(--secondary);
            color: var(--secondary);
            margin-top: 10px;
        }
        .btn-outline:hover {
            background: var(--secondary);
            color: white;
        }
        
        .preset-badge {
            display: inline-block;
            padding: 4px 10px;
            font-size: 0.75rem;
            border-radius: 12px;
            background: #E0E7FF;
            color: var(--primary);
            margin-right: 5px;
            margin-bottom: 5px;
            cursor: pointer;
            border: 1px solid var(--border);
        }
        .preset-badge:hover { background: var(--secondary); color: white; }

        /* Results Display */
        .results-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .kpi-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .kpi-card {
            background: var(--bg);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border);
            text-align: center;
        }
        .kpi-title { font-size: 0.85rem; color: var(--text); margin-bottom: 5px; font-weight: 600; }
        .kpi-value { font-size: 1.6rem; font-weight: 800; color: var(--primary); font-family: 'Montserrat', sans-serif; }
        .kpi-sub { font-size: 0.8rem; color: var(--text); }
        .kpi-pass { color: var(--success); }
        .kpi-fail { color: var(--danger); }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        .data-table th, .data-table td {
            padding: 10px;
            border-bottom: 1px solid var(--border);
            text-align: left;
        }
        .data-table th { background: var(--bg); font-weight: 700; }
        .data-table tr:last-child td { border-bottom: none; }

        /* Step by Step */
        .calculation-step {
            font-family: 'Courier New', monospace;
            background-color: rgba(0,0,0,0.03);
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            border-left: 4px solid var(--success);
            font-size: 0.95rem;
            line-height: 1.6;
        }
        body.dark-mode .calculation-step { background-color: rgba(255,255,255,0.05); }

        /* Educational Content */
        .education-section { margin-top: 40px; }
        .insight-card {
            background: linear-gradient(135deg, var(--card), rgba(37,99,235,0.03));
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            border-left: 5px solid var(--secondary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: all 0.3s;
        }
        .insight-card:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .insight-card h4 {
            color: var(--secondary);
            font-size: 1.3rem;
            margin: 0 0 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: 'Montserrat', sans-serif;
        }
        .insight-card p, .insight-card ul {
            margin: 10px 0;
            line-height: 1.8;
            color: var(--text);
        }
        .insight-card ul { padding-left: 20px; }
        .insight-card li { margin-bottom: 8px; }

        /* FAQ Section */
        .faq-section { margin-top: 40px; }
        .faq-item {
            margin-bottom: 15px;
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            background: var(--input-bg);
        }
        .faq-item summary {
            padding: 15px 20px;
            cursor: pointer;
            font-weight: 600;
            color: var(--heading);
            background: var(--bg);
            list-style: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }
        .faq-item summary:hover {
            background: rgba(37, 99, 235, 0.05);
            color: var(--secondary);
        }
        .faq-item summary::-webkit-details-marker { display: none; }
        .faq-item summary::after {
            content: '+';
            font-size: 1.2rem;
            font-weight: bold;
        }
        .faq-item[open] summary::after { content: '-'; }
        .faq-answer {
            padding: 15px 20px;
            border-top: 1px solid var(--border);
            font-size: 0.95rem;
            line-height: 1.6;
            color: var(--text);
        }

        /* Charts */
        .chart-wrapper {
            height: 300px;
            width: 100%;
            position: relative;
        }

        /* Tooltip */
        .info-icon { color: var(--secondary); margin-left: 5px; cursor: help; font-size: 0.9em; }
        .tooltip { position: relative; display: inline-block; }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 240px;
            background-color: #1E293B;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 100;
            bottom: 130%;
            left: 50%;
            margin-left: -120px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.8rem;
            font-weight: 400;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            line-height: 1.4;
        }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
        .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #1E293B transparent transparent transparent;
        }

        /* Message Box */
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 6px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.25);
            z-index: 10000;
            font-weight: 600;
            color: white;
            display: none;
            animation: slideDown 0.3s ease-out;
        }
        @keyframes slideDown { from { transform: translate(-50%, -20px); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
        
        /* Footer */
        footer {
            background: var(--grad-dark);
            color: #CBD5E1;
            padding: 50px 0 20px 0;
            margin-top: 60px;
        }
        .footer-content {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 40px;
            margin-bottom: 30px;
        }
        .footer-col { flex: 1; min-width: 200px; }
        .footer-col h4 { color: white; margin-bottom: 15px; font-weight: 700; }
        .footer-col ul { list-style: none; padding: 0; margin: 0; }
        .footer-col a { color: #CBD5E1; text-decoration: none; transition: color 0.3s; }
        .footer-col a:hover { color: var(--accent); }
        .social-buttons { display: flex; gap: 12px; margin-top: 15px; }
        .social-btn {
            width: 40px; height: 40px;
            display: flex; justify-content: center; align-items: center;
            color: white; border-radius: 50%;
            font-size: 1.1rem; transition: transform 0.3s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .social-btn:hover { transform: translateY(-4px); }
        .social-btn.linkedin { background-color: #0A66C2; }
        .social-btn.youtube { background-color: #FF0000; }
        .social-btn.twitter { background-color: #1DA1F2; }
        .social-btn.facebook { background-color: #1877F2; }
        .social-btn.whatsapp { background-color: #25D366; }
        .footer-disclaimer {
            text-align: center; padding-top: 25px;
            border-top: 1px solid #334155;
            max-width: 800px; margin: 0 auto;
            font-size: 0.9rem;
        }
        .footer-bottom {
            text-align: center; padding-top: 20px;
            font-size: 0.9rem; color: #94A3B8;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container { padding: 0 15px; }
            .navbar { flex-direction: column; gap: 20px; }
            .nav-links { flex-direction: column; gap: 12px; text-align: center; }
            .footer-content { flex-direction: column; gap: 25px; }
        }
    </style>
</head>
<body>
    <div id="message-box" class="message-box"></div>
    <header>
        <div class="container">
            <nav class="navbar">
                <a href="#" class="logo-container">
                    <span class="logo-text">Design Calculators</span>
                    <p class="logo-subtitle">Inspired by standards such as IEC, IEEE, ISA, ASME, and API.</p>
                </a>
                <ul class="nav-links">
                    <li><a href='/'>Home</a></li>
                    <li><a href='/articles'>Articles</a></li>
                    <li><a href='/indexmech'>Mechanical</a></li>
                    <li><a href='/indexele'>Electrical</a></li>
                    <li><a href='/indexinst'>Instrumentation</a></li>
                </ul>
                <div class="theme-toggle">
                    <i class="fas fa-sun"></i>
                    <label class="switch">
                        <input type="checkbox" id="theme-switch">
                        <span class="slider"></span>
                    </label>
                    <i class="fas fa-moon"></i>
                </div>
            </nav>
        </div>
    </header>

    <main class="container">
        <div class="card">
            <h1 class="tool-title"><i class="fas fa-network-wired"></i> Commercial Fiber Optic Link Budget Calculator</h1>
            <div class="tool-description">
                <p>This industrial-grade tool calculates <strong>Optical Link Loss Budget</strong> for P2P and PON networks. It performs simultaneous <strong>dual-wavelength analysis</strong>, validates against TIA-568.3-D / ISO 11801 standards, and checks power budgets for standard IEEE/ITU-T transceiver applications.</p>
            </div>
        </div>

        <div class="app-layout">
            <!-- LEFT PANEL: INPUTS -->
            <div class="input-panel">
                <form id="loss-form">
                    <!-- Standard Selection -->
                    <div class="form-section">
                        <h4><i class="fas fa-book"></i> Design Standard</h4>
                        <div class="form-group">
                            <label>Design Standard</label>
                            <select id="standard-select" onchange="updateStandardDefaults()">
                                <option value="tia" selected>TIA-568.3-D (USA/Global)</option>
                                <option value="iso">ISO/IEC 11801 (International)</option>
                                <option value="custom">Custom Parameters</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Network Topology <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">P2P: Point-to-Point (Standard Link). PON: Passive Optical Network (Splitters).</span></span></label>
                            <select id="topology-select" onchange="togglePonFields()">
                                <option value="p2p" selected>Point-to-Point (P2P)</option>
                                <option value="pon">PON (FTTH/POL)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Fiber Cable -->
                    <div class="form-section">
                        <h4><i class="fas fa-ethernet"></i> Cable Plant</h4>
                        <div class="form-group">
                            <label>Fiber Type</label>
                            <select id="fiber-type" onchange="updateWavelengths()">
                                <option value="OS2" selected>Single-mode (OS2)</option>
                                <option value="OM3">Multimode (OM3)</option>
                                <option value="OM4">Multimode (OM4)</option>
                                <option value="OM5">Multimode (OM5)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Length (km)</label>
                            <input type="number" id="distance" value="10.0" step="0.1" min="0">
                        </div>
                        
                        <!-- Dynamic Wavelength Inputs -->
                        <div class="compact-row">
                            <div class="form-group">
                                <label id="wl1-label">Atten @1310</label>
                                <input type="number" id="att-wl1" value="0.4" step="0.01">
                            </div>
                            <div class="form-group">
                                <label id="wl2-label">Atten @1550</label>
                                <input type="number" id="att-wl2" value="0.3" step="0.01">
                            </div>
                        </div>
                    </div>

                    <!-- Connectivity -->
                    <div class="form-section">
                        <h4><i class="fas fa-plug"></i> Connectivity</h4>
                        <div class="compact-row">
                            <div class="form-group">
                                <label>Pairs</label>
                                <input type="number" id="conn-count" value="4" step="1">
                            </div>
                            <div class="form-group">
                                <label>Loss (dB)</label>
                                <input type="number" id="conn-loss" value="0.75" step="0.05">
                            </div>
                        </div>
                        <div class="compact-row">
                            <div class="form-group">
                                <label>Splices</label>
                                <input type="number" id="splice-count" value="2" step="1">
                            </div>
                            <div class="form-group">
                                <label>Loss (dB)</label>
                                <input type="number" id="splice-loss" value="0.3" step="0.01">
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Passives -->
                    <div class="form-section">
                        <h4><i class="fas fa-random"></i> Advanced Passives</h4>
                        <div id="pon-section" style="display:none;">
                            <div class="form-group">
                                <label>Splitter Configuration <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Select primary splitter ratio. Tool adds typical theoretical loss.</span></span></label>
                                <select id="splitter-select" onchange="updateSplitterLoss()">
                                    <option value="0">None</option>
                                    <option value="3.5">1:2 (3.5 dB)</option>
                                    <option value="7.2">1:4 (7.2 dB)</option>
                                    <option value="10.5">1:8 (10.5 dB)</option>
                                    <option value="13.5">1:16 (13.5 dB)</option>
                                    <option value="17.0">1:32 (17.0 dB)</option>
                                    <option value="20.5">1:64 (20.5 dB)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Splitter Loss (dB)</label>
                                <input type="number" id="splitter-loss" value="0" step="0.1">
                            </div>
                        </div>
                        <div class="compact-row">
                            <div class="form-group">
                                <label>WDM/Mux <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Loss for WDM filters or AWGs in the path.</span></span></label>
                                <input type="number" id="wdm-loss" value="0" step="0.1">
                            </div>
                            <div class="form-group">
                                <label>Other (dB)</label>
                                <input type="number" id="other-loss" value="0" step="0.1">
                            </div>
                        </div>
                    </div>

                    <!-- Margin & Application -->
                    <div class="form-section">
                        <h4><i class="fas fa-check-circle"></i> Validation</h4>
                        <div class="form-group">
                            <label>Repair Margin (dB)</label>
                            <input type="number" id="safety-margin" value="3.0" step="0.1">
                        </div>
                        <div class="form-group">
                            <label>Target Application</label>
                            <select id="app-select" onchange="updateAppSpec()">
                                <option value="custom">Custom Power Budget</option>
                                <optgroup label="Single-mode (OS2)">
                                    <option value="sm_1g_lx" selected>1000BASE-LX (10km)</option>
                                    <option value="sm_10g_lr">10GBASE-LR (10km)</option>
                                    <option value="sm_10g_er">10GBASE-ER (40km)</option>
                                    <option value="sm_gpon_b">GPON Class B+ (20km)</option>
                                    <option value="sm_gpon_c">GPON Class C+ (20km)</option>
                                </optgroup>
                                <optgroup label="Multimode (OM3/4)">
                                    <option value="mm_1g_sx">1000BASE-SX</option>
                                    <option value="mm_10g_sr">10GBASE-SR</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="compact-row">
                            <div class="form-group">
                                <label>Tx Min (dBm)</label>
                                <input type="number" id="tx-power" value="-9.5" step="0.1">
                            </div>
                            <div class="form-group">
                                <label>Rx Sens (dBm)</label>
                                <input type="number" id="rx-sens" value="-20.0" step="0.1">
                            </div>
                        </div>
                    </div>

                    <div class="preset-container">
                        <span class="preset-badge" onclick="loadPreset('campus')">Campus Backbone</span>
                        <span class="preset-badge" onclick="loadPreset('ftth')">FTTH (GPON)</span>
                        <span class="preset-badge" onclick="loadPreset('dc')">Data Center (MM)</span>
                    </div>

                    <button type="button" onclick="calculate()" class="btn">Calculate Link Budget</button>
                    <button type="button" onclick="generatePDF()" class="btn btn-outline">Generate Certification Report</button>
                </form>
            </div>

            <!-- RIGHT PANEL: RESULTS -->
            <div class="results-panel" id="results-area" style="opacity: 0.5; pointer-events: none;">
                
                <!-- KPI Cards -->
                <div class="kpi-row">
                    <div class="kpi-card">
                        <div class="kpi-title" id="res-wl1-title">Loss @ 1310nm</div>
                        <div class="kpi-value" id="res-loss-wl1">-- dB</div>
                        <div class="kpi-sub" id="res-headroom-wl1">Headroom: --</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title" id="res-wl2-title">Loss @ 1550nm</div>
                        <div class="kpi-value" id="res-loss-wl2">-- dB</div>
                        <div class="kpi-sub" id="res-headroom-wl2">Headroom: --</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">Result</div>
                        <div class="kpi-value" id="res-status">--</div>
                        <div class="kpi-sub">Based on <span id="res-app-name">Custom</span></div>
                    </div>
                </div>

                <!-- Detailed Analysis & Event Table -->
                <div class="card">
                    <h4>Detailed Analysis</h4>
                    <div class="chart-wrapper">
                        <canvas id="lossChart"></canvas>
                    </div>
                    
                    <h4 style="margin-top:20px;">Step-by-Step Calculation</h4>
                    <div id="step-by-step-container">
                        <!-- Dynamic Calculation Text -->
                    </div>
                </div>

                <!-- Insights -->
                <div class="card" style="border-left: 4px solid var(--secondary);">
                    <h4><i class="fas fa-lightbulb"></i> Engineering Assessment</h4>
                    <p id="assessment-text" style="font-size: 0.95rem; line-height: 1.6;">
                        Run a calculation to view the engineering assessment.
                    </p>
                </div>
            </div>
        </div>

        <!-- NEW: Tool Overview Section -->
        <div class="card education-section" style="margin-bottom: 0;">
            <h2><i class="fas fa-info-circle"></i> Tool Overview & Capabilities</h2>
            
            <div class="insight-card">
                <h4>What this Tool Does</h4>
                <p>This calculator provides a precision <strong>Loss Budget Analysis</strong> for fiber optic networks. It simulates the total optical attenuation of a fiber link by summing the losses from the fiber cable itself, mated connector pairs, fusion/mechanical splices, and passive components (like PON splitters or WDM muxes). It calculates this for two wavelengths simultaneously (e.g., 1310nm/1550nm for Single-mode or 850nm/1300nm for Multimode) and compares the total loss against the available "Power Budget" of your selected transceivers (Tx Power minus Rx Sensitivity).</p>
            </div>

            <div class="insight-card">
                <h4>Why it is Useful</h4>
                <ul>
                    <li><strong>Pre-Deployment Validation:</strong> Prevents costly mistakes by ensuring your planned cable run will support the desired application (e.g., 10GBASE-LR) before you buy the hardware.</li>
                    <li><strong>Troubleshooting:</strong> If a link is down, you can calculate the <em>expected</em> loss. If your OTDR or Light Source measurement is significantly higher than this calculated value, you know you have a fault (dirty connector, macropbend, or bad splice).</li>
                    <li><strong>PON Design:</strong> Essential for FTTH designers to verify if a 1:32 or 1:64 split ratio is feasible over a given distance.</li>
                </ul>
            </div>

            <div class="insight-card">
                <h4>Standards Compliance</h4>
                <p>This tool is designed to support compliance with major international standards:</p>
                <ul>
                    <li><strong>TIA-568.3-D:</strong> The North American standard for optical fiber cabling components. Default loss values (0.75dB/connector, 0.3dB/splice) are derived from this standard.</li>
                    <li><strong>ISO/IEC 11801:</strong> The international standard for generic cabling, essential for global projects.</li>
                    <li><strong>ITU-T G.984 (GPON):</strong> Supports Class B+ and Class C+ optical budgets for Passive Optical Networks.</li>
                    <li><strong>IEEE 802.3:</strong> Includes power budget presets for standard Ethernet applications like 1000BASE-SX/LX, 10GBASE-SR/LR/ER.</li>
                </ul>
            </div>
        </div>

        <!-- EDUCATIONAL CONTENT (Reference Guide) -->
        <div class="education-section card" style="margin-top: 25px;">
            <h2><i class="fas fa-book-open"></i> Optical Engineering Reference Guide</h2>
            
            <div class="insight-card">
                <h4>1. Physics of Optical Attenuation</h4>
                <p>Optical attenuation is the reduction in power of the light signal as it travels through the fiber. It is measured in decibels (dB) per kilometer. The two primary mechanisms causing attenuation in optical fibers are:</p>
                <ul>
                    <li><strong>Rayleigh Scattering:</strong> This is the dominant loss mechanism in the window of interest. It is caused by microscopic fluctuations in the refractive index of the glass. Light hits these irregularities and scatters in all directions. Scattering is inversely proportional to the fourth power of the wavelength ($\lambda^4$), which is why 1550nm (longer wavelength) has lower loss than 1310nm or 850nm.</li>
                    <li><strong>Absorption:</strong> This is caused by impurities in the glass, such as hydroxyl ions (water peaks) and transition metals, which absorb light energy and convert it to heat. Modern manufacturing has largely eliminated these impurities, but a "water peak" can still be observed around 1383nm in standard fibers (Low Water Peak fibers alleviate this).</li>
                    <li><strong>Bending Losses:</strong>
                        <ul>
                            <li><strong>Macrobending:</strong> Visible bends in the cable (tight radii) causing light to leak out of the core into the cladding.</li>
                            <li><strong>Microbending:</strong> Microscopic deviations in the fiber geometry caused by coating stress or manufacturing defects.</li>
                        </ul>
                    </li>
                </ul>
            </div>

            <div class="insight-card">
                <h4>2. TIA/EIA-568 vs. ISO/IEC 11801 Standards</h4>
                <p>Designing a fiber network requires adherence to recognized standards to ensure interoperability and certification reliability. The two dominant bodies are TIA (Telecommunications Industry Association), primarily in North America, and ISO/IEC (International Organization for Standardization), used globally.</p>
                
                <strong>TIA-568.3-D (Optical Fiber Cabling Components Standard)</strong>
                <p>This standard specifies the component performance requirements. It is often considered the "baseline" for certification.</p>
                <ul>
                    <li><strong>Connector Loss:</strong> Max 0.75 dB per mated pair. (Note: High-quality polished connectors often achieve 0.3 dB or better).</li>
                    <li><strong>Splice Loss:</strong> Max 0.3 dB per splice (Fusion or Mechanical).</li>
                    <li><strong>Fiber Attenuation (OS2):</strong> 0.5 dB/km @ 1310nm, 0.5 dB/km @ 1550nm (Inside Plant). Outside plant cable may be rated lower (0.4/0.3).</li>
                </ul>

                <strong>ISO/IEC 11801 (Generic Cabling for Customer Premises)</strong>
                <p>Often stricter and defines "Classes" of links (OF-300, OF-500, OF-2000) based on channel length.</p>
                <ul>
                    <li><strong>Connector Loss:</strong> Also 0.75 dB limit, but defines "Reference Grade" connectors for testing (0.1 dB limit).</li>
                    <li><strong>Multimode (OM3/OM4):</strong> Has specific requirements for bandwidth (EMB) to support 10GbE/40GbE/100GbE applications.</li>
                </ul>
                <p><strong>Engineering Best Practice:</strong> While TIA allows 0.75 dB per connector, modern designs usually budget for 0.5 dB to ensure headroom for 40G/100G upgrades. This calculator defaults to TIA limits but allows custom values for "Best Practice" designs.</p>
            </div>

            <div class="insight-card">
                <h4>3. PON (Passive Optical Network) Design Logic</h4>
                <p>Passive Optical Networks (PON), such as GPON (Gigabit PON) and XGS-PON, utilize Point-to-Multipoint (P2MP) topology. The most critical component in a PON loss budget is the <strong>Optical Splitter</strong>.</p>
                
                <strong>Splitter Physics</strong>
                <p>An optical splitter divides the optical power. A 1:2 splitter theoretically splits power by 50% (3 dB loss). However, excess loss and uniformity issues add to this.</p>
                <ul>
                    <li><strong>1:2 Splitter:</strong> ~3.5 dB Loss</li>
                    <li><strong>1:4 Splitter:</strong> ~7.2 dB Loss (Essentially two 1:2 splits: 3.5 + 3.5)</li>
                    <li><strong>1:32 Splitter:</strong> ~17.0 dB Loss. This single component often consumes 60-70% of the entire power budget.</li>
                </ul>
                
                <strong>Class B+ vs Class C+ Optics</strong>
                <p>Because splitters introduce such high loss, PON optics must transmit at higher power and receive at lower sensitivities than standard Ethernet optics.</p>
                <ul>
                    <li><strong>Class B+ (Standard):</strong> Budget ~28 dB. Supports up to 1:32 splitters over 20km.</li>
                    <li><strong>Class C+ (High Power):</strong> Budget ~32 dB. Required for 1:64 splits or longer reaches.</li>
                </ul>
            </div>

            <div class="insight-card">
                <h4>4. Wavelength Division Multiplexing (WDM)</h4>
                <p>WDM increases bandwidth by transmitting multiple signals at different wavelengths simultaneously over a single fiber.</p>
                <ul>
                    <li><strong>CWDM (Coarse WDM):</strong> Channels spaced 20nm apart (e.g., 1470, 1490, 1510... 1610nm). Cheaper lasers, uncooled. Passive Mux/Demux loss is typically 2-3 dB per end.</li>
                    <li><strong>DWDM (Dense WDM):</strong> Channels spaced very closely (0.8nm or 100GHz). Requires cooled lasers. Used for long-haul and high-capacity metro rings.</li>
                </ul>
                <p>When calculating a WDM budget, you must account for the <strong>Insertion Loss</strong> of the Mux (Multiplexer) at the Tx end and the Demux (Demultiplexer) at the Rx end. A standard 8-channel CWDM Mux might add 2.5 dB of loss at each end, totaling 5.0 dB of "passive" penalty before the light even enters the fiber.</p>
            </div>

            <div class="insight-card">
                <h4>5. Testing & Certification: Tier 1 vs Tier 2</h4>
                <p>Once a link is built, it must be tested to ensure the loss budget is met.</p>
                
                <strong>Tier 1: Basic Certification (LSPM)</strong>
                <p>Uses a Light Source and Power Meter (LSPM) or Optical Loss Test Set (OLTS). It measures the <strong>absolute total loss</strong> of the link. This is the mandatory test for warranty certification.</p>
                
                <strong>Tier 2: Extended Certification (OTDR)</strong>
                <p>Uses an Optical Time Domain Reflectometer (OTDR). It creates a "trace" or graphical signature of the fiber. It does not measure absolute power but calculates loss based on backscatter.</p>
                <ul>
                    <li><strong>Why use OTDR?</strong> It identifies <em>where</em> the loss is occurring. It can pinpoint a bad splice at 3.2km or a macrobend at 5.1km. It is also the only way to measure individual connector reflectance (ORL).</li>
                    <li><strong>The "Dead Zone":</strong> OTDRs are blind for a few meters after a reflective event. Launch cables (500m-1km dummy fiber coils) are required to measure the first connector of the link.</li>
                </ul>
            </div>

             <div class="insight-card">
                <h4>6. Connector Types and Polish (UPC vs APC)</h4>
                <p>The return loss (reflectance) is as important as insertion loss, especially for RF video or high-speed data.</p>
                <ul>
                    <li><strong>PC (Physical Contact) - Blue:</strong> Older standard. Rounded ferrule. ~ -30dB Return Loss.</li>
                    <li><strong>UPC (Ultra Physical Contact) - Blue:</strong> Flatter polish. ~ -50dB Return Loss. Standard for Ethernet.</li>
                    <li><strong>APC (Angled Physical Contact) - Green:</strong> Ferrule polished at an 8-degree angle. Reflections are directed into the cladding rather than back to the source. ~ -65dB Return Loss. Mandatory for GPON, RF Overlay, and Sensing applications.</li>
                </ul>
                <p><strong>Warning:</strong> Never mate an APC connector with a UPC connector. The air gap created will cause massive insertion loss (>5 dB) and permanently damage the fiber end-faces.</p>
            </div>
        </div>

        <!-- NEW FAQ SECTION -->
        <div class="card faq-section">
            <h2><i class="fas fa-question-circle"></i> Frequently Asked Questions</h2>
            
            <details class="faq-item" itemscope itemprop="mainEntity" itemtype="https://schema.org/Question">
                <summary itemprop="name">What is the difference between Single-mode and Multimode fiber?</summary>
                <div class="faq-answer" itemscope itemprop="acceptedAnswer" itemtype="https://schema.org/Answer">
                    <span itemprop="text"><strong>Single-mode (OS2)</strong> has a tiny core (9µm) allowing one path for light. It has very low loss and infinite bandwidth, making it ideal for long distances (>500m to 100km+). <strong>Multimode (OM3/OM4)</strong> has a larger core (50µm) allowing multiple light paths. It is cheaper for electronics but distance-limited (typically <500m) due to modal dispersion.</span>
                </div>
            </details>

            <details class="faq-item" itemscope itemprop="mainEntity" itemtype="https://schema.org/Question">
                <summary itemprop="name">How do I calculate splitter loss for a PON network?</summary>
                <div class="faq-answer" itemscope itemprop="acceptedAnswer" itemtype="https://schema.org/Answer">
                    <span itemprop="text">The theoretical loss is $10 \times \log_{10}(N)$, where N is the split ratio. For example, a 1:32 splitter is $10 \times \log(32) \approx 15$ dB. However, real-world devices have excess loss. A safe planning value is <strong>17.5 dB</strong> for a 1:32 splitter and <strong>20.5 dB</strong> for a 1:64 splitter.</span>
                </div>
            </details>

            <details class="faq-item" itemscope itemprop="mainEntity" itemtype="https://schema.org/Question">
                <summary itemprop="name">What is "Headroom" or "System Margin"?</summary>
                <div class="faq-answer" itemscope itemprop="acceptedAnswer" itemtype="https://schema.org/Answer">
                    <span itemprop="text">Headroom is the difference between your calculated Total Link Loss and the Transceiver Power Budget. If your budget is 28dB and your loss is 22dB, you have 6dB of headroom. A design should always have positive headroom (typically >3dB) to account for repairs (new splices), aging components, and dirty connectors over time.</span>
                </div>
            </details>

            <details class="faq-item" itemscope itemprop="mainEntity" itemtype="https://schema.org/Question">
                <summary itemprop="name">Why are 1310nm and 1550nm losses different?</summary>
                <div class="faq-answer" itemscope itemprop="acceptedAnswer" itemtype="https://schema.org/Answer">
                    <span itemprop="text">Fiber attenuation is governed by Rayleigh Scattering, which decreases as wavelength increases. Therefore, 1550nm light scatters less and travels further (typical loss 0.22 dB/km) than 1310nm light (typical loss 0.35 dB/km). However, 1310nm has zero chromatic dispersion, making it better for uncompensated signals.</span>
                </div>
            </details>

            <details class="faq-item" itemscope itemprop="mainEntity" itemtype="https://schema.org/Question">
                <summary itemprop="name">Does this calculator support WDM/CWDM?</summary>
                <div class="faq-answer" itemscope itemprop="acceptedAnswer" itemtype="https://schema.org/Answer">
                    <span itemprop="text">Yes. You can input loss for WDM components in the "Advanced Passives" section. Remember that a WDM link has passive mux/demux units at both ends. If a standard 8-channel Mux has 2.5 dB insertion loss, you should enter 5.0 dB (2.5 + 2.5) in the "WDM/Mux" field to account for the complete passive channel path.</span>
                </div>
            </details>

            <details class="faq-item" itemscope itemprop="mainEntity" itemtype="https://schema.org/Question">
                <summary itemprop="name">What happens if my optical power is too high?</summary>
                <div class="faq-answer" itemscope itemprop="acceptedAnswer" itemtype="https://schema.org/Answer">
                    <span itemprop="text">If the received power is higher than the receiver's saturation point (overload), it will cause bit errors or permanently burn out the receiver. This often happens on short Single-mode links (e.g., <1km) using ER/ZR optics. You must use an <strong>Optical Attenuator</strong> to reduce the power to a safe level (typically -5 to -10 dBm).</span>
                </div>
            </details>
        </div>
    </main>

    <!-- FOOTER -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-col">
                    <h4>Design Calculators</h4>
                    <p style="font-size: 0.9rem; line-height: 1.6; margin-bottom: 15px;">If you find this tool helpful, please consider sharing it with your colleagues!</p>
                    <div class="social-buttons">
                        <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn linkedin" title="LinkedIn"><i class="fab fa-linkedin-in"></i></a>
                        <a href="https://www.youtube.com/@designcalculators" target="_blank" rel="noopener noreferrer" class="social-btn youtube" title="YouTube"><i class="fab fa-youtube"></i></a>
                        <a href="https://twitter.com/intent/tweet?url=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn twitter" title="Twitter"><i class="fab fa-twitter"></i></a>
                        <a href="https://www.facebook.com/sharer/sharer.php?u=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn facebook" title="Facebook"><i class="fab fa-facebook-f"></i></a>
                        <a href="https://api.whatsapp.com/send?text=Check%20out%20this%20amazing%20engineering%20resource%20https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn whatsapp" title="WhatsApp"><i class="fab fa-whatsapp"></i></a>
                    </div>
                </div>
                <div class="footer-col">
                    <h4>Quick Links</h4>
                    <ul>
                        <li><a href='/'>Home</a></li>
                        <li><a href='/indexele'>Electrical</a></li>
                        <li><a href='/indexmech'>Mechanical</a></li>
                        <li><a href='/indexinst'>Instrumentation</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>Resources</h4>
                    <ul>
                        <li><a href='/about'>About Us</a></li>
                        <li><a href='/contact'>Contact</a></li>                       
                        <li><a href='/privacy-policy'>Privacy Policy</a></li>
                        <li><a href='/terms-of-service'>Terms of Service</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>More</h4>
                    <ul>
                        <li><a href='/articles'>Articles & Whitepapers</a></li>
                        <li><a href='/sitemap2'>Sitemap</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-disclaimer">
                <p>This tool offers general guidance. Results should be reviewed for accuracy and compliance with relevant project standards and regulations before use.</p>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Design Calculators. Created by <span style="color: var(--secondary); font-weight: bold;">A Sharma</span>. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        // --- CONSTANTS & DATA ---
        
        // Attenuation Defaults (dB/km) [Wavelength 1, Wavelength 2]
        const FIBER_SPECS = {
            'OS2': { 
                wl: [1310, 1550], 
                tia: [0.4, 0.3], // TIA-568.3-D (Inside Plant generic safe values)
                iso: [0.4, 0.3]  // ISO 11801
            },
            'OM3': { 
                wl: [850, 1300], 
                tia: [3.0, 1.5], 
                iso: [3.5, 1.5] 
            },
            'OM4': { 
                wl: [850, 1300], 
                tia: [3.0, 1.5], 
                iso: [3.5, 1.5] 
            },
            'OM5': { 
                wl: [850, 1300], 
                tia: [3.0, 1.5], 
                iso: [3.0, 1.5] 
            }
        };

        // Component Loss Defaults (dB)
        const COMP_SPECS = {
            'tia': { conn: 0.75, splice: 0.3 },
            'iso': { conn: 0.75, splice: 0.3 } // ISO matches TIA for worst case usually
        };

        // Transceiver Database (Approximate Power Budgets)
        const APPS = {
            'sm_1g_lx': { tx: -9.5, rx: -20.0, name: "1000BASE-LX" }, // -9.5 to -3 Tx, -20 Rx (min budget ~10.5)
            'sm_10g_lr': { tx: -8.2, rx: -14.4, name: "10GBASE-LR" }, // ~6.2dB budget IEEE 802.3ae
            'sm_10g_er': { tx: -4.7, rx: -15.8, name: "10GBASE-ER" }, // ~11dB budget
            'sm_gpon_b': { tx: 1.5, rx: -28.0, name: "GPON Class B+" }, // ~28dB budget (OLT->ONT)
            'sm_gpon_c': { tx: 3.0, rx: -30.0, name: "GPON Class C+" }, // ~32dB budget
            'mm_1g_sx': { tx: -9.5, rx: -17.0, name: "1000BASE-SX" }, // ~7.5dB budget (very distance limited)
            'mm_10g_sr': { tx: -7.3, rx: -9.9, name: "10GBASE-SR" }   // ~2.6dB budget
        };

        let myChart = null;
        let lastResult = null;

        // --- UI LOGIC ---

        function updateStandardDefaults() {
            const std = document.getElementById('standard-select').value;
            if (std === 'custom') return;

            const fType = document.getElementById('fiber-type').value;
            const specs = FIBER_SPECS[fType][std];
            
            document.getElementById('att-wl1').value = specs[0];
            document.getElementById('att-wl2').value = specs[1];
            document.getElementById('conn-loss').value = COMP_SPECS[std].conn;
            document.getElementById('splice-loss').value = COMP_SPECS[std].splice;
            
            showMessage(`Defaults updated to ${std.toUpperCase()} standard.`);
        }

        function updateWavelengths() {
            const fType = document.getElementById('fiber-type').value;
            const specs = FIBER_SPECS[fType];
            
            document.getElementById('wl1-label').innerText = `Atten @${specs.wl[0]}nm`;
            document.getElementById('wl2-label').innerText = `Atten @${specs.wl[1]}nm`;
            
            updateStandardDefaults();
            
            // Show/Hide relevant apps
            const appSelect = document.getElementById('app-select');
            const smGroup = appSelect.getElementsByTagName('optgroup')[0];
            const mmGroup = appSelect.getElementsByTagName('optgroup')[1];
            
            if (fType === 'OS2') {
                smGroup.style.display = '';
                mmGroup.style.display = 'none';
                appSelect.value = 'sm_1g_lx';
            } else {
                smGroup.style.display = 'none';
                mmGroup.style.display = '';
                appSelect.value = 'mm_1g_sx';
            }
            updateAppSpec();
        }

        function togglePonFields() {
            const topo = document.getElementById('topology-select').value;
            const ponDiv = document.getElementById('pon-section');
            ponDiv.style.display = topo === 'pon' ? 'block' : 'none';
        }

        function updateSplitterLoss() {
            const val = document.getElementById('splitter-select').value;
            document.getElementById('splitter-loss').value = val;
        }

        function updateAppSpec() {
            const app = document.getElementById('app-select').value;
            if (app === 'custom') return;
            
            const spec = APPS[app];
            document.getElementById('tx-power').value = spec.tx;
            document.getElementById('rx-sens').value = spec.rx;
        }

        function loadPreset(type) {
            if (type === 'campus') {
                document.getElementById('standard-select').value = 'tia';
                document.getElementById('topology-select').value = 'p2p';
                document.getElementById('fiber-type').value = 'OS2';
                document.getElementById('distance').value = '2.0';
                document.getElementById('conn-count').value = '4';
                document.getElementById('splice-count').value = '2';
                document.getElementById('app-select').value = 'sm_1g_lx';
                togglePonFields();
                updateWavelengths();
            } else if (type === 'ftth') {
                document.getElementById('standard-select').value = 'tia';
                document.getElementById('topology-select').value = 'pon';
                document.getElementById('fiber-type').value = 'OS2';
                document.getElementById('distance').value = '15.0';
                document.getElementById('conn-count').value = '4';
                document.getElementById('splice-count').value = '4';
                document.getElementById('splitter-select').value = '17.0'; // 1:32
                document.getElementById('splitter-loss').value = '17.0';
                document.getElementById('app-select').value = 'sm_gpon_b';
                togglePonFields();
                updateWavelengths();
            } else if (type === 'dc') {
                document.getElementById('standard-select').value = 'iso';
                document.getElementById('topology-select').value = 'p2p';
                document.getElementById('fiber-type').value = 'OM4';
                document.getElementById('distance').value = '0.3';
                document.getElementById('conn-count').value = '6';
                document.getElementById('splice-count').value = '0';
                document.getElementById('app-select').value = 'mm_10g_sr';
                togglePonFields();
                updateWavelengths();
            }
            showMessage('Scenario Loaded');
        }

        function showMessage(msg) {
            const box = document.getElementById('message-box');
            box.innerText = msg;
            box.style.background = 'var(--secondary)';
            box.style.display = 'block';
            setTimeout(() => { box.style.display = 'none'; }, 3000);
        }

        // --- CALCULATION ENGINE ---

        function calculate() {
            // Inputs
            const dist = parseFloat(document.getElementById('distance').value);
            const att1 = parseFloat(document.getElementById('att-wl1').value);
            const att2 = parseFloat(document.getElementById('att-wl2').value);
            
            const nConn = parseFloat(document.getElementById('conn-count').value);
            const lConn = parseFloat(document.getElementById('conn-loss').value);
            
            const nSplice = parseFloat(document.getElementById('splice-count').value);
            const lSplice = parseFloat(document.getElementById('splice-loss').value);
            
            const lSplitter = parseFloat(document.getElementById('splitter-loss').value);
            const lWdm = parseFloat(document.getElementById('wdm-loss').value);
            const lOther = parseFloat(document.getElementById('other-loss').value);
            const margin = parseFloat(document.getElementById('safety-margin').value);
            
            const tx = parseFloat(document.getElementById('tx-power').value);
            const rx = parseFloat(document.getElementById('rx-sens').value);
            
            // Logic
            const fiberLoss1 = dist * att1;
            const fiberLoss2 = dist * att2;
            const connLossTotal = nConn * lConn;
            const spliceLossTotal = nSplice * lSplice;
            const passiveLoss = lSplitter + lWdm + lOther;
            
            const totalLoss1 = fiberLoss1 + connLossTotal + spliceLossTotal + passiveLoss + margin;
            const totalLoss2 = fiberLoss2 + connLossTotal + spliceLossTotal + passiveLoss + margin;
            
            const powerBudget = tx - rx;
            const headroom1 = powerBudget - totalLoss1;
            const headroom2 = powerBudget - totalLoss2;
            
            const fType = document.getElementById('fiber-type').value;
            const wlNames = FIBER_SPECS[fType].wl;

            // Store Results
            lastResult = {
                dist, fType, wlNames, 
                att1, att2, 
                nConn, lConn, nSplice, lSplice, lSplitter, lWdm, lOther, margin,
                totalLoss1, totalLoss2, powerBudget, headroom1, headroom2,
                fiberLoss1, connLossTotal, spliceLossTotal, passiveLoss
            };

            // Display Results
            document.getElementById('results-area').style.opacity = '1';
            document.getElementById('results-area').style.pointerEvents = 'all';

            // KPI Cards
            document.getElementById('res-wl1-title').innerText = `Loss @ ${wlNames[0]}nm`;
            document.getElementById('res-loss-wl1').innerText = totalLoss1.toFixed(2) + " dB";
            document.getElementById('res-headroom-wl1').innerHTML = `Headroom: <span style="font-weight:bold; color:${headroom1>=0?'var(--success)':'var(--danger)'}">${headroom1.toFixed(2)} dB</span>`;

            document.getElementById('res-wl2-title').innerText = `Loss @ ${wlNames[1]}nm`;
            document.getElementById('res-loss-wl2').innerText = totalLoss2.toFixed(2) + " dB";
            document.getElementById('res-headroom-wl2').innerHTML = `Headroom: <span style="font-weight:bold; color:${headroom2>=0?'var(--success)':'var(--danger)'}">${headroom2.toFixed(2)} dB</span>`;

            const passed = headroom1 >= 0 && headroom2 >= 0;
            const statusEl = document.getElementById('res-status');
            statusEl.innerText = passed ? "PASS" : "FAIL";
            statusEl.className = "kpi-value " + (passed ? "kpi-pass" : "kpi-fail");
            
            const appSel = document.getElementById('app-select');
            document.getElementById('res-app-name').innerText = appSel.options[appSel.selectedIndex].text;

            // Generate Step-by-Step HTML
            let steps = `<h5>Primary Wavelength (${wlNames[0]} nm) Breakdown:</h5>`;
            
            steps += `<div class="calculation-step">`;
            steps += `<strong>1. Fiber Loss:</strong><br>`;
            steps += `Length (${dist} km) × Attenuation (${att1} dB/km) = <strong>${fiberLoss1.toFixed(2)} dB</strong>`;
            steps += `</div>`;
            
            steps += `<div class="calculation-step">`;
            steps += `<strong>2. Connector Loss:</strong><br>`;
            steps += `Pairs (${nConn}) × Loss/Pair (${lConn} dB) = <strong>${connLossTotal.toFixed(2)} dB</strong>`;
            steps += `</div>`;
            
            steps += `<div class="calculation-step">`;
            steps += `<strong>3. Splice Loss:</strong><br>`;
            steps += `Splices (${nSplice}) × Loss/Splice (${lSplice} dB) = <strong>${spliceLossTotal.toFixed(2)} dB</strong>`;
            steps += `</div>`;
            
            if (passiveLoss > 0) {
                steps += `<div class="calculation-step">`;
                steps += `<strong>4. Passive Elements:</strong><br>`;
                steps += `Splitter (${lSplitter}) + WDM (${lWdm}) + Other (${lOther}) = <strong>${passiveLoss.toFixed(2)} dB</strong>`;
                steps += `</div>`;
            }

            steps += `<div class="calculation-step">`;
            steps += `<strong>5. Total Budget:</strong><br>`;
            steps += `Fiber + Conn + Splice + Passive + Margin (${margin})<br>`;
            steps += `${fiberLoss1.toFixed(2)} + ${connLossTotal.toFixed(2)} + ${spliceLossTotal.toFixed(2)} + ${passiveLoss.toFixed(2)} + ${margin.toFixed(2)} = <strong>${totalLoss1.toFixed(2)} dB</strong>`;
            steps += `</div>`;

            steps += `<div class="calculation-step" style="border-left-color: var(--primary);">`;
            steps += `<strong>6. Power Margin (Headroom):</strong><br>`;
            steps += `Budget (Tx - Rx) = ${tx} - (${rx}) = ${powerBudget.toFixed(2)} dB<br>`;
            steps += `Headroom = ${powerBudget.toFixed(2)} - ${totalLoss1.toFixed(2)} = <strong>${headroom1.toFixed(2)} dB</strong>`;
            steps += `</div>`;
            
            document.getElementById('step-by-step-container').innerHTML = steps;

            // Assessment
            let assessHTML = `<strong>System Evaluation:</strong><br>`;
            if (passed) {
                assessHTML += `The link design is robust. The worst-case loss of <strong>${Math.max(totalLoss1, totalLoss2).toFixed(2)} dB</strong> is within the <strong>${powerBudget.toFixed(1)} dB</strong> power budget of the selected application.`;
                if (Math.min(headroom1, headroom2) < 2.0) {
                    assessHTML += ` <br><em style="color:var(--warning)">Warning:</em> Headroom is low (<2dB). Ensure high-quality cleaning of connector end-faces.`;
                }
            } else {
                assessHTML += `The link fails to meet the power budget. You are exceeding the limit by <strong>${Math.abs(Math.min(headroom1, headroom2)).toFixed(2)} dB</strong>. Consider reducing connector count, improving splice quality, or using higher-power transceivers (e.g., ER/ZR optics).`;
            }
            document.getElementById('assessment-text').innerHTML = assessHTML;

            drawChart();
            
            document.getElementById('results-area').scrollIntoView({ behavior: 'smooth' });
        }

        function drawChart() {
            const ctx = document.getElementById('lossChart').getContext('2d');
            if (myChart) myChart.destroy();

            const r = lastResult;
            
            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Fiber', 'Connectors', 'Splices', 'Passives', 'Margin', 'TOTAL'],
                    datasets: [
                        {
                            label: `${r.wlNames[0]}nm Loss (dB)`,
                            data: [r.fiberLoss1, r.connLossTotal, r.spliceLossTotal, r.passiveLoss, r.margin, r.totalLoss1],
                            backgroundColor: 'rgba(37, 99, 235, 0.7)',
                            borderColor: 'rgba(37, 99, 235, 1)',
                            borderWidth: 1
                        },
                        {
                            label: `${r.wlNames[1]}nm Loss (dB)`,
                            data: [r.fiberLoss2, r.connLossTotal, r.spliceLossTotal, r.passiveLoss, r.margin, r.totalLoss2],
                            backgroundColor: 'rgba(245, 158, 11, 0.7)',
                            borderColor: 'rgba(245, 158, 11, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, title: {display:true, text:'Loss (dB)'} }
                    },
                    plugins: {
                        annotation: {
                            annotations: {
                                line1: {
                                    type: 'line',
                                    yMin: r.powerBudget,
                                    yMax: r.powerBudget,
                                    borderColor: 'rgb(220, 38, 38)',
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    label: { content: `Limit: ${r.powerBudget.toFixed(1)} dB`, enabled: true, position: 'end' }
                                }
                            }
                        }
                    }
                }
            });
        }

        function generatePDF() {
            if (!lastResult) { alert("Calculate first!"); return; }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const r = lastResult;
            
            // Header
            doc.setFillColor(30, 58, 138);
            doc.rect(0, 0, 210, 20, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(16);
            doc.text("Optical Link Budget Certification", 105, 13, { align: 'center' });
            
            // Info
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(10);
            doc.text(`Date: ${new Date().toLocaleString()}`, 14, 30);
            doc.text(`Standard: ${document.getElementById('standard-select').options[document.getElementById('standard-select').selectedIndex].text}`, 14, 35);
            doc.text(`Application: ${document.getElementById('app-select').options[document.getElementById('app-select').selectedIndex].text}`, 14, 40);
            
            // Summary Table
            doc.autoTable({
                startY: 45,
                head: [['Parameter', 'Primary λ', 'Secondary λ']],
                body: [
                    ['Wavelength', `${r.wlNames[0]} nm`, `${r.wlNames[1]} nm`],
                    ['Total Loss', `${r.totalLoss1.toFixed(2)} dB`, `${r.totalLoss2.toFixed(2)} dB`],
                    ['Power Budget', `${r.powerBudget.toFixed(2)} dB`, `${r.powerBudget.toFixed(2)} dB`],
                    ['HEADROOM', `${r.headroom1.toFixed(2)} dB`, `${r.headroom2.toFixed(2)} dB`]
                ],
                theme: 'grid',
                headStyles: { fillColor: [30, 58, 138] }
            });
            
            // BoM Table
            doc.text("Bill of Materials & Loss Breakdown", 14, doc.lastAutoTable.finalY + 10);
            doc.autoTable({
                startY: doc.lastAutoTable.finalY + 15,
                head: [['Item', 'Qty/Len', 'Unit Loss', 'Total Loss']],
                body: [
                    [`Fiber Cable (${r.fType})`, `${r.dist} km`, `${r.att1} dB/km`, `${r.fiberLoss1.toFixed(2)} dB`],
                    ['Connector Pairs', `${r.nConn}`, `${r.lConn} dB`, `${r.connLossTotal.toFixed(2)} dB`],
                    ['Splices', `${r.nSplice}`, `${r.lSplice} dB`, `${r.spliceLossTotal.toFixed(2)} dB`],
                    ['Passive Splitter', r.lSplitter > 0 ? '1' : '0', `${r.lSplitter} dB`, `${r.lSplitter.toFixed(2)} dB`],
                    ['WDM/Mux', r.lWdm > 0 ? '1' : '0', `${r.lWdm} dB`, `${r.lWdm.toFixed(2)} dB`],
                    ['Safety Margin', '-', '-', `${r.margin.toFixed(2)} dB`]
                ],
                theme: 'striped'
            });

            // Signature
            const ySig = 250;
            doc.line(14, ySig, 80, ySig);
            doc.text("Engineer Signature", 14, ySig + 5);
            
            doc.line(120, ySig, 180, ySig);
            doc.text("Date", 120, ySig + 5);

            doc.save("Fiber_Link_Budget_Report.pdf");
        }
        
        // Theme Toggle Logic
        const themeSwitch = document.getElementById('theme-switch');
        if (themeSwitch) {
            // Check local storage on load
            if (localStorage.getItem('theme') === 'dark') {
                document.body.classList.add('dark-mode');
                themeSwitch.checked = true;
            }
            
            // Handle switch change
            themeSwitch.addEventListener('change', function() {
                if(this.checked) {
                    document.body.classList.add('dark-mode');
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.body.classList.remove('dark-mode');
                    localStorage.setItem('theme', 'light');
                }
            });
        }
        
        // Initialize
        updateWavelengths();
    </script>
</body>
</html>
