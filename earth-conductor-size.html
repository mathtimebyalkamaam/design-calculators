<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Earthing Cable Sizing Calculator (IEC 60364) | Design Calculators</title>
    <meta name="description" content="Professional earthing (grounding) cable sizing calculator per IEC 60364-5-54 & IEEE 80. Calculates adiabatic equation for fault current withstand.">
    <meta name="keywords" content="earthing calculator, grounding cable sizing, iec 60364, adiabatic equation, fault current, protective earth, k factor">
    <meta name="author" content="Design Calculators">
    <meta name="robots" content="index, follow">

    <!-- AdSense & Google Analytics -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5936527763614780" crossorigin="anonymous"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-23Y1V450SR"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-23Y1V450SR');
    </script>
    
    <!-- Fonts and Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Montserrat:wght@700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- MathJax for formula rendering -->
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
            svg: { fontCache: 'global' },
            options: { processHtmlClass: 'math-content', ignoreHtmlClass: 'no-mathjax' }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Favicons -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    
    <!-- New CSS Block (from pipe_flow_calculator.html) -->
    <style>
        :root {
            --primary-color: #1E3A8A;
            --secondary-color: #2563EB;
            --accent-color: #F59E0B;
            --success-color: #10B981;
            --bg-color: #F8FAFC;
            --card-bg: #FFFFFF;
            --text-color: #4B5563;
            --heading-color: #111827;
            --footer-bg: #0F172A;
            --border-color: #E2E8F0;
            --gradient-primary: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            --gradient-dark: linear-gradient(135deg, #0F172A, #1E293B);
            --card-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            --hover-color: #e2e6ea;
            --input-focus-shadow: 0 0 0 3px rgba(30, 58, 138, 0.25);
        }

        body.dark-mode {
            --primary-color: #10B981;
            --secondary-color: #34D399;
            --bg-color: #0F172A;
            --card-bg: #1E293B;
            --text-color: #CBD5E1;
            --heading-color: #F1F5F9;
            --footer-bg: #020617;
            --border-color: #334155;
            --hover-color: #1E293B;
            --input-focus-shadow: 0 0 0 3px rgba(16, 185, 129, 0.5);
        }

        * { box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.8;
            transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 24px;
        }

        /* HEADER */
        .header {
            background: var(--gradient-primary);
            color: white;
            padding: 24px 0;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo-container {
            display: flex;
            align-items: center;
            gap: 16px;
            text-decoration: none;
            color: white;
        }
        .logo-text {
            font-size: 1.75rem;
            font-weight: 800;
            font-family: 'Montserrat', sans-serif;
        }
        .nav-links {
            display: flex;
            gap: 24px;
            align-items: center;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        .nav-links a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }
        .nav-links a:hover { color: var(--accent-color); }

        /* Theme Toggle */
        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .theme-toggle .icon {
            color: white;
            font-size: 1.2rem;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 56px;
            height: 30px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.2);
            transition: .4s;
            border-radius: 30px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--accent-color); }
        input:checked + .slider:before { transform: translateX(26px); }

        /* Main Content */
        main { padding: 40px 0; }
        .tool-container {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 30px;
            box-shadow: var(--card-shadow);
            margin-bottom: 30px;
        }
        .tool-container h2 {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            padding-bottom: 15px;
            margin-top: 0;
            margin-bottom: 25px;
            font-family: 'Montserrat', sans-serif;
            font-size: 1.8rem;
        }
         .tool-container h3 {
            color: var(--heading-color);
            font-family: 'Montserrat', sans-serif;
            font-size: 1.5rem;
            margin-top: 25px;
            margin-bottom: 20px;
        }
        .tool-description {
            margin-bottom: 25px;
            color: var(--text-color);
            font-size: 1rem;
            line-height: 1.8;
        }
        .tool-description a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
        }
        .tool-description a:hover {
            text-decoration: underline;
        }

        /* Form Styles */
        .calculator-form {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 25px;
            margin-top: 25px;
        }
        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--heading-color);
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--bg-color);
            color: var(--text-color);
            box-sizing: border-box;
            transition: all 0.3s;
            font-size: 1rem;
        }
        .form-group input:focus, .form-group select:focus {
            border-color: var(--primary-color);
            box-shadow: var(--input-focus-shadow);
            outline: none;
        }
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        /* Button Styles */
        .calculate-btn {
            background: var(--gradient-primary);
            color: white;
            border: none;
            padding: 16px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 700;
            transition: all 0.3s;
            width: 100%;
            box-shadow: 0 4px 12px rgba(30, 58, 138, 0.3);
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .calculate-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(30, 58, 138, 0.4);
        }
        .calculate-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .calculate-btn:disabled {
            background: #9ca3af; /* Grey */
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .calculate-btn .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-left-color: #ffffff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Result Styles */
        .result-container {
            margin-top: 40px;
            padding: 30px;
            border-radius: 12px;
            background-color: var(--card-bg);
            box-shadow: var(--card-shadow);
            display: none;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }
        .result-container.show {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }
        .result-container h3 {
            color: var(--primary-color);
            margin-bottom: 25px;
            font-family: 'Montserrat', sans-serif;
            font-size: 1.6rem;
        }

        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-radius: 8px;
            overflow: hidden;
        }
        .result-table th, .result-table td {
            padding: 14px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        .result-table th {
            background: var(--gradient-primary);
            color: white;
            font-weight: 700;
        }
        .result-table tr:nth-child(even) {
            background-color: rgba(0,0,0,0.02);
        }
        .result-table td strong {
            color: var(--heading-color);
        }
        body.dark-mode .result-table td strong {
             color: var(--primary-color);
        }
        
        /* Calculation Details & Standard Ref */
        #calculation-details {
            background-color: var(--bg-color);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
            font-size: 0.95rem;
        }
        #calculation-details h4 {
            color: var(--secondary-color);
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }
        #calculation-details p.formula {
            font-family: 'Times New Roman', serif;
            font-size: 1.1rem;
            text-align: center;
            padding: 15px;
            background-color: var(--hover-color);
            border-radius: 6px;
            margin: 15px 0;
            overflow-x: auto;
        }
        #calculation-details p.calculation-step {
            font-family: 'Courier New', monospace;
            background-color: var(--hover-color);
            padding: 8px 12px;
            border-radius: 4px;
            margin-bottom: 8px;
            line-height: 1.6;
        }
        #calculation-details ul {
            list-style-type: disc;
            margin-left: 25px;
            padding-left: 0;
        }
        #calculation-details ul li {
            margin-bottom: 8px;
            line-height: 1.7;
        }

        .standard-reference {
            margin-top: 25px;
            font-style: italic;
            font-size: 0.95rem;
            padding: 15px;
            background: linear-gradient(135deg, rgba(245,158,11,0.1), rgba(245,158,11,0.05));
            border-left: 4px solid var(--accent-color);
            border-radius: 6px;
            line-height: 1.7;
        }
         .standard-reference a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
        }
        .standard-reference a:hover {
            text-decoration: underline;
        }

        /* Tooltip */
        .info-icon {
            color: var(--primary-color);
            margin-left: 6px;
            cursor: help;
            font-size: 0.9rem;
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 280px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1000;
            bottom: 130%;
            left: 50%;
            margin-left: -140px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.85rem;
            line-height: 1.5;
            white-space: normal;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* Custom Message Box */
        #custom-message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 16px 28px;
            border-radius: 8px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.25);
            z-index: 10000;
            font-weight: 600;
            color: white;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        #custom-message-box.show { opacity: 1; }

        /* New Content Block Styles */
        .content-block {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 30px;
            box-shadow: var(--card-shadow);
            margin-bottom: 30px;
            margin-top: 30px;
        }
        .content-block h2 {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            padding-bottom: 15px;
            margin-top: 0;
            margin-bottom: 25px;
            font-family: 'Montserrat', sans-serif;
            font-size: 1.8rem;
        }
        .content-block h3 {
            color: var(--heading-color);
            font-family: 'Montserrat', sans-serif;
            font-size: 1.4rem;
            margin-top: 25px;
            margin-bottom: 15px;
        }
         .content-block h4 {
            color: var(--secondary-color);
            font-family: 'Montserrat', sans-serif;
            font-size: 1.2rem;
            margin-top: 20px;
            margin-bottom: 10px;
        }
        .content-block p, .content-block li {
            font-size: 1rem;
            line-height: 1.8;
            color: var(--text-color);
        }
        .content-block ul, .content-block ol {
            list-style-type: disc;
            margin-left: 20px;
            padding-left: 5px;
            margin-bottom: 15px;
        }
        .content-block ol {
            list-style-type: decimal;
        }
        .content-block li {
            margin-bottom: 10px;
        }
        .content-block strong {
            color: var(--heading-color);
        }
        .content-block code {
            background-color: var(--hover-color);
            padding: 2px 5px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            color: var(--primary-color);
        }
        body.dark-mode .content-block code {
            color: var(--secondary-color);
        }
        .content-block .formula-block {
            font-family: 'Times New Roman', serif;
            font-size: 1.1rem;
            text-align: center;
            padding: 15px;
            background-color: var(--hover-color);
            border-radius: 6px;
            margin: 20px 0;
            overflow-x: auto;
            border: 1px dashed var(--primary-color);
        }
        .content-block table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-radius: 8px;
            overflow: hidden;
        }
        .content-block th, .content-block td {
            padding: 14px;
            text-align: left;
            border: 1px solid var(--border-color);
        }
        .content-block th {
            background-color: var(--hover-color);
            font-weight: 600;
        }
        
        /* FOOTER */
        footer {
            background: var(--gradient-dark);
            color: #CBD5E1;
            padding: 50px 0 20px 0;
        }
        .footer-content {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 40px;
            margin-bottom: 30px;
        }
        .footer-col {
            flex: 1;
            min-width: 200px;
        }
        .footer-col h4 {
            font-size: 1.1rem;
            color: white;
            margin-bottom: 15px;
            font-weight: 700;
        }
        .footer-col ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .footer-col ul li { margin-bottom: 10px; }
        .footer-col a {
            color: #CBD5E1;
            text-decoration: none;
            transition: color 0.3s;
            font-size: 0.95rem;
        }
        .footer-col a:hover { color: var(--accent-color); }
        .footer-disclaimer {
            text-align: center;
            margin: 30px auto;
            padding-top: 25px;
            border-top: 1px solid #334155;
            max-width: 800px;
            font-size: 0.9rem;
            line-height: 1.6;
        }
        .footer-bottom {
            text-align: center;
            padding-top: 20px;
            font-size: 0.9rem;
            color: #94A3B8;
        }
        .creator-name {
            color: var(--secondary-color);
            font-weight: bold;
        }
        .social-buttons {
            display: flex;
            gap: 12px;
            margin-top: 15px;
        }
        .social-btn {
            width: 40px;
            height: 40px;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            color: white;
            border-radius: 50%;
            text-decoration: none;
            font-size: 1.1rem;
            transition: transform 0.3s, box-shadow 0.3s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .social-btn:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
        }
        .social-btn.linkedin { background-color: #0A66C2; }
        .social-btn.youtube { background-color: #FF0000; }
        .social-btn.twitter { background-color: #1DA1F2; }
        .social-btn.facebook { background-color: #1877F2; }
        .social-btn.whatsapp { background-color: #25D366; }

        /* Responsive */
        @media (max-width: 768px) {
            .container { padding: 0 15px; }
            .navbar { flex-direction: column; gap: 20px; }
            .nav-links { flex-direction: column; gap: 12px; text-align: center; }
            .form-row { grid-template-columns: 1fr; }
            .tool-container, .content-block { padding: 20px; }
            .footer-content { flex-direction: column; gap: 25px; }
            .theme-toggle {
                position: relative;
                top: 0;
                right: 0;
                margin-top: 15px;
            }
            .content-block table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
        }
        .hidden { display: none; }
    </style>
</head>
<body>
    
    <!-- NEW HEADER -->
    <header class="header">
        <div class="container">
            <nav class="navbar">
                <a href="/" class="logo-container">
                    <span class="logo-text">Design Calculators</span>
                </a>
                <ul class="nav-links">
                    <li><a href="/">Home</a></li>
                    <li><a href='/articles'>Articles</a></li>
                    <li><a href='/indexmech'>Mechanical</a></li>
                    <li><a href='/indexele'>Electrical</a></li>
                    <li><a href='/indexinst'>Instrumentation</a></li>
                </ul>
                <div class="theme-toggle">
                    <i class="fas fa-sun icon"></i>
                    <label class="switch">
                        <input type="checkbox" id="theme-switch">
                        <span class="slider"></span>
                    </label>
                    <i class="fas fa-moon icon"></i>
                </div>
            </nav>
        </div>
    </header>

    <!-- MAIN CONTENT - Refactored with new CSS -->
    <main class="container">
        <!-- Back button removed -->
        <div class="tool-container">
            <h2>Earthing Cable Sizing Calculator (IEC/IEEE)</h2>
            <div class="tool-description">
                <p>This calculator determines the minimum required cross-sectional area for protective earthing (grounding) conductors based on fault current, fault duration, and conductor material properties. It applies the adiabatic equation as per international standards like <a href="https://webstore.iec.ch/publication/4207" target="_blank" rel="noopener">IEC 60364-5-54</a> and principles from <a href="https://standards.ieee.org/standard/80-2013.html" target="_blank" rel="noopener">IEEE Std 80</a>.</p>
            </div>
            
            <div class="calculator-form">
                <form id="earthing-sizing-form">
                    
                    <div class="form-group">
                        <label for="unit-system">Select Units:</label>
                        <select id="unit-system" required>
                            <option value="metric">Metric (kA, s, °C, mm²)</option>
                            <option value="imperial">Imperial (kA, s, °F, kcmil)</option>
                        </select>
                    </div>

                    <!-- Fault Current Parameters -->
                    <h3>Fault Current Parameters</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="fault-current-ka" id="label-fault-current-ka">Fault Current (kA)</label>
                            <input type="number" id="fault-current-ka" min="0.01" step="0.01" value="10" required>
                        </div>
                        <div class="form-group">
                            <label for="fault-duration-s" id="label-fault-duration-s">Fault Duration (s)</label>
                            <input type="number" id="fault-duration-s" min="0.01" step="0.01" value="0.5" required>
                        </div>
                    </div>

                    <!-- Conductor Material & Temperature Properties -->
                    <h3>Conductor Material & Temperature</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="conductor-material" id="label-conductor-material">Conductor Material</label>
                            <select id="conductor-material" required>
                                <option value="copper">Copper</option>
                                <option value="aluminum">Aluminum</option>
                                <option value="steel">Steel (Galvanized)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="initial-temp-c" id="label-initial-temp-c">Initial Conductor Temp (°C)</label>
                            <input type="number" id="initial-temp-c" value="30" step="0.1" required>
                        </div>
                        <div class="form-group">
                            <label for="final-temp-c" id="label-final-temp-c">Final Conductor Temp (°C)</label>
                            <input type="number" id="final-temp-c" value="200" step="0.1" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="conductor-type" id="label-conductor-type">Conductor Type</label>
                            <select id="conductor-type" required>
                                <option value="cable">Cable (Round)</option>
                                <option value="flat-bar">Flat Bar/Strip</option>
                            </select>
                        </div>
                         <div class="form-group">
                            <label for="safety-factor">Safety Factor (%)</label>
                            <input type="number" id="safety-factor" min="0" step="1" value="15" required>
                        </div>
                    </div>
                    
                    <!-- Hidden fields for Flat Bar -->
                    <div id="flat-bar-fields" class="conductor-type-fields hidden">
                        <h3>Flat Bar Dimensions</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="preferred-bar-width" id="label-preferred-bar-width">Preferred Bar Width (mm)</label>
                                <input type="number" id="preferred-bar-width" min="1" step="1" placeholder="e.g., 50">
                            </div>
                        </div>
                    </div>

                    <!-- NEW Button Group -->
                    <div class="form-row" style="gap: 10px; margin-top: 25px;">
                        <button type="button" id="calculate-earthing-btn" class="calculate-btn" style="flex: 2;">
                            <i class="fas fa-calculator" style="margin-right: 8px;"></i>Calculate
                            <span class="spinner" id="calculate-spinner" style="display:none;"></span>
                        </button>
                        <button type="button" id="reset-calculations-btn" class="calculate-btn" style="flex: 1; background: var(--accent-color); box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);">
                            <i class="fas fa-sync-alt" style="margin-right: 8px;"></i>Reset
                        </button>
                        <button type="button" id="download-pdf-btn" class="calculate-btn" style="flex: 1; background: var(--secondary-color); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);">
                            <i class="fas fa-file-pdf" style="margin-right: 8px;"></i>Download PDF
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- Result Container - Refactored -->
            <div id="result-container" class="result-container">
                <h3>Earthing Cable Sizing Results</h3>
                <div id="calculation-details" class="math-content">
                    <!-- Calculation steps will be inserted here -->
                </div>
                <table class="result-table">
                    <thead>
                        <tr>
                            <th>Parameter</th>
                            <th>Value</th>
                        </tr>
                    </thead>
                    <tbody id="result-table-body">
                        <!-- Results will be dynamically inserted here -->
                    </tbody>
                </table>
                <div class="standard-reference" id="standard-reference">
                    <!-- Standard reference text will be inserted here -->
                </div>
            </div>
        </div>
    </main>

    <!-- NEW CONTENT BLOCK for AdSense -->
    <div class="container">
        <div class="content-block">
            <h2 class="math-content">A Comprehensive Guide to Earthing (Grounding) System Design</h2>
            <p>Properly sizing a Protective Earth (PE) conductor, or "earthing cable," is one of the most critical aspects of electrical safety design. Its sole purpose is to provide a low-impedance path for fault current to flow back to the source, allowing a protective device (like a circuit breaker or fuse) to operate almost instantly, de-energizing the circuit and preventing electric shock or fire. An undersized earthing conductor can act like a fuse itself—vaporizing during a fault and leaving the system dangerously live and ungrounded.</p>
            <p>This calculator uses the <strong>adiabatic equation</strong>, the internationally accepted method described in standards like <strong>IEC 60364-5-54</strong> and <strong>IEEE Std 80</strong>, to determine the minimum required size. This guide explains the principles behind the calculation.</p>

            <h3>1. The Core Principle: The Adiabatic Equation</h3>
            <p>The term "adiabatic" assumes that during the very short duration of a fault (e.g., 0.1 to 1 second), all the heat generated by the fault current (I²R losses) is absorbed by the conductor itself, with no time to dissipate into the surrounding environment. This is a worst-case scenario calculation.</p>
            <p>The formula is:</p>
            <div class="formula-block math-content">
                $$ S = \frac{I \times \sqrt{t}}{k} $$
            </div>
            <ul>
                <li>$S$ = Minimum Cross-sectional Area (in mm²).</li>
                <li>$I$ = RMS value of the prospective fault current (in Amperes).</li>
                <li>$t$ = Fault duration (in seconds), the time it takes for the protective device to clear the fault.</li>
                <li>$k$ = A material-specific factor that accounts for the conductor's resistivity, heat capacity, and temperature limits.</li>
            </ul>

            <h3>2. Deep Dive: The All-Important 'k' Factor</h3>
            <p>The '$k$' factor is not just a simple constant; it is calculated from the fundamental thermal and electrical properties of the conductor material. The calculator derives this value for you using the full formula:</p>
            <div class="formula-block math-content">
                $$ k = \sqrt{ \frac{Q_c \times \ln \left( \frac{\beta + T_f}{\beta + T_i} \right)}{\rho_{20} \times (\beta + T_i)} } $$
            </div>
            <ul>
                <li>$Q_c$ = <strong>Volumetric Heat Capacity (J/m³K):</strong> How much energy the material can store per unit volume per degree of temperature rise.</li>
                <li>$\rho_{20}$ = <strong>Resistivity at 20°C (Ω·m):</strong> The material's inherent resistance to current flow.</li>
                <li>$\beta$ = <strong>Material Constant (°C):</strong> The reciprocal of the temperature coefficient of resistance (alpha) at 0°C. For copper, this is 234.5°C; for aluminum, 228.1°C.</li>
                <li>$T_i$ = <strong>Initial Temperature (°C):</strong> The conductor's temperature *before* the fault (e.g., ambient temp).</li>
                <li>$T_f$ = <strong>Final Temperature (°C):</strong> The maximum allowable temperature the conductor can reach *without* damage.</li>
            </ul>
            <p>This formula precisely calculates how much current a conductor can withstand before its temperature rises from $T_i$ to $T_f$ in one second.</p>
            
            <h4>Typical 'k' Values (from IEC 60364-5-54)</h4>
            <p>While the calculator computes the exact '$k$' value, standards provide tables for common scenarios. These values are what you would use for a quick manual calculation.</p>
            <table>
                <thead>
                    <tr>
                        <th>Material</th>
                        <th>Insulation / Condition</th>
                        <th>Initial Temp ($T_i$)</th>
                        <th>Final Temp ($T_f$)</th>
                        <th>'$k$' Factor</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Copper</td>
                        <td>PVC Insulation</td>
                        <td>30°C</td>
                        <td>160°C</td>
                        <td>143</td>
                    </tr>
                    <tr>
                        <td>Copper</td>
                        <td>XLPE/EPR Insulation</td>
                        <td>30°C</td>
                        <td>250°C</td>
                        <td>176</td>
                    </tr>
                    <tr>
                        <td>Copper</td>
                        <td>Bare (Bolted joints, limit 300°C)</td>
                        <td>30°C</td>
                        <td>300°C</td>
                        <td>192</td>
                    </tr>
                    <tr>
                        <td>Aluminum</td>
                        <td>PVC Insulation</td>
                        <td>30°C</td>
                        <td>160°C</td>
                        <td>95</td>
                    </tr>
                     <tr>
                        <td>Aluminum</td>
                        <td>XLPE/EPR Insulation</td>
                        <td>30°C</td>
                        <td>250°C</td>
                        <td>116</td>
                    </tr>
                    <tr>
                        <td>Steel</td>
                        <td>Bare (Bolted joints, limit 300°C)</td>
                        <td>30°C</td>
                        <td>300°C</td>
                        <td>~58</td>
                    </tr>
                </tbody>
            </table>

            <h3>3. Key Parameters Explained</h3>
            
            <h4>Prospective Fault Current ($I$)</h4>
            <p>This is the <strong>maximum root mean square (RMS)</strong> current that would flow in the event of a "bolted" short circuit (a solid, zero-impedance connection) at the point of installation. This value is critical and must be accurate. It is typically determined by:</p>
            <ul>
                <li><strong>Utility Company:** For the service entrance, the utility provides the "Available Fault Current."</li>
                <li><strong>Transformer Impedance:** The primary source of fault current in a facility is the transformer. A transformer with a low impedance (e.g., 4%) will deliver a much higher fault current than one with a high impedance (e.g., 6%).</li>
                <li><strong>Short-Circuit Study:** For large facilities, engineers perform a study using software to calculate the fault current at every panelboard and piece of equipment.</li>
            </ul>

            <h4>Fault Duration ($t$)</h4>
            <p>This is the <strong>total clearing time</strong> of the upstream protective device (circuit breaker or fuse). A common misconception is to use the device's instantaneous trip time (e.g., 0.02s). However, many breakers have a "short-time" delay to ensure coordination, so a time of <strong>0.1s, 0.2s, or even 0.5s</strong> is often more realistic and conservative. As you can see from the $\sqrt{t}$ in the formula, a longer duration significantly increases the required cable size.</p>

            <h4>Initial ($T_i$) and Final ($T_f$) Temperatures</h4>
            <ul>
                <li><strong>Initial ($T_i$):</strong> This is not always ambient temperature. If the PE conductor is part of a multi-core cable, its initial temperature is assumed to be the cable's maximum operating temperature (e.g., 70°C or 90°C). For a separate, bare earthing conductor, ambient temperature (e.g., 30°C) is a safe assumption.</li>
                <li><strong>Final ($T_f$):</strong> This is the critical limit. It is <strong>NOT</strong> the melting point of the metal. It is the temperature at which the conductor's *insulation* is permanently damaged. For PVC, this is 160°C. For XLPE, it's 250°C. For bare conductors, the limit is often set by the jointing method (e.g., bolted joints may fail above 300°C).</li>
            </ul>

            <h3>4. Practical Considerations & Conductor Types</h3>
            <p>The formula gives a minimum size based on thermal withstand. Codes often add further requirements:</p>
            
            <h4>Mechanical Strength</h4>
            <p>Many standards (like IEC 60364) mandate a <strong>minimum size for mechanical robustness</strong>, regardless of the calculation. For example, a PE conductor may be required to be at least 2.5 mm² (if mechanically protected) or 4 mm² (if unprotected) simply so it doesn't break easily, even if the formula calculates a smaller size.</p>
            
            <h4>Corrosion</h4>
            <p>An earthing conductor buried in soil must resist corrosion for decades. This influences material choice. Bare copper is excellent but expensive. Galvanized steel is common for earth grids (like in substations) but is less conductive. Copper-clad steel offers a balance of conductivity and corrosion resistance.</p>

            <h4>Cable vs. Flat Bar/Strip</h4>
            <p>Choosing between a round cable and a flat bar (busbar) depends on the application:</p>
            <ul>
                <li><strong>Cables (Round):</strong> Highly flexible and easy to install in conduits and trays. They are the standard choice for equipment grounding and PE conductors within circuits.</li>
                <li><strong>Flat Bars/Strips:</strong> Offer a larger surface area for their cross-section, which is excellent for heat dissipation. They are mechanically very strong and are the preferred choice for main earthing busbars (MEBs), substation earth grids, and carrying very high fault currents (e.g., > 50kA).</li>
            </ul>

            <h3>5. IEEE Std 80 vs. IEC 60364</h3>
            <p>While this calculator uses the same fundamental adiabatic equation found in both standards, it's important to know their primary focus:</p>
            <ul>
                <li><strong>IEC 60364:</strong> Primarily focuses on low-voltage (LV) and medium-voltage (MV) electrical installations *within buildings and facilities*. Its goal is the safety of personnel and property from shock and fire.</li>
                <li><strong>IEEE Std 80:</strong> Primarily focuses on high-voltage (HV) *AC substation grounding*. While it uses the same formula for conductor sizing, its main concern is the design of the entire earth grid to manage dangerous "step" and "touch" potentials during a fault.</li>
            </ul>
            <p>For sizing a PE conductor for a motor, panel, or transformer within a commercial or industrial building, the IEC 60364 approach (as used by this tool) is the standard method.</p>
        </div>
    </div>

    <!-- NEW FOOTER -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-col">
                    <h4>Design Calculators</h4>
                    <p style="font-size: 0.9rem; line-height: 1.6; margin-bottom: 15px;">Tools and calculators inspired by internationally recognized engineering standards such as IEC, IEEE, ISA, ASME, and API.</p>
                    <div class="social-buttons">
                        <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn linkedin" aria-label="LinkedIn"><i class="fab fa-linkedin-in"></i></a>
                        <a href="https://www.youtube.com/@designcalculators" target="_blank" rel="noopener noreferrer" class="social-btn youtube" aria-label="YouTube"><i class="fab fa-youtube"></i></a>
                        <a href="https://twitter.com/intent/tweet?url=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn twitter" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
                        <a href="https://www.facebook.com/sharer/sharer.php?u=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn facebook" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
                        <a href="https://api.whatsapp.com/send?text=Check%20out%20this%20amazing%20engineering%20resource:%20https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn whatsapp" aria-label="WhatsApp"><i class="fab fa-whatsapp"></i></a>
                    </div>
                </div>
                <div class="footer-col">
                    <h4>Quick Links</h4>
                    <ul>
                        <li><a href="/">Home</a></li>
                        <li><a href='/indexele'>Electrical</a></li>
                        <li><a href='/indexmech'>Mechanical</a></li>
                        <li><a href='/indexinst'>Instrumentation</a></li>
                        <li><a href='/articles'>Articles</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>Resources</h4>
                    <ul>
                        <li><a href='/about'>About Us</a></li>
                        <li><a href='/contact'>Contact</a></li>
                        <li><a href='/faq'>FAQ</a></li>
                        <li><a href='/privacy-policy'>Privacy Policy</a></li>
                        <li><a href='/terms-of-service'>Terms of Service</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>More</h4>
                    <ul>
                        <li><a href="/articles.html">Articles</a></li>
                        <li><a href='/sitemap2'>Sitemap</a></li>
                        <li><a href="https://www.youtube.com/@designcalculators" target="_blank" rel="noopener noreferrer">YouTube Channel</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-disclaimer">
                <p>All calculations are for preliminary design guidance. Always verify results against relevant engineering standards (ISO, ASME, IEC, NEC) and manufacturer specifications. Final designs require professional engineering verification considering site-specific conditions.</p>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Design Calculators. Created by <span class="creator-name">A Sharma</span>. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Custom Message Box for JS -->
    <div id="custom-message-box"></div>
    
    <!-- UPDATED SCRIPT -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Get all buttons
            const calculateEarthingBtn = document.getElementById('calculate-earthing-btn');
            const resetFormBtn = document.getElementById('reset-calculations-btn'); // Renamed ID
            const downloadPdfBtn = document.getElementById('download-pdf-btn'); // New button
            const calculationSpinner = document.getElementById('calculate-spinner');
            
            // Get containers
            const resultContainer = document.getElementById('result-container');
            const resultTableBody = document.getElementById('result-table-body');
            const standardReference = document.getElementById('standard-reference');
            const calculationDetailsDiv = document.getElementById('calculation-details');
            
            // Get form inputs
            const unitSystemSelect = document.getElementById('unit-system');
            const conductorTypeSelect = document.getElementById('conductor-type');
            const flatBarFields = document.getElementById('flat-bar-fields');
            
            // *** START FIX: Added displayMessage function ***
            function displayMessage(message, type = "info") {
                let messageBox = document.getElementById('custom-message-box');
                
                messageBox.textContent = message;
                if (type === "error") {
                    messageBox.style.backgroundColor = '#dc3545'; // Red
                    messageBox.style.color = 'white';
                } else if (type === "warning") {
                    messageBox.style.backgroundColor = '#ffc107'; // Yellow
                    messageBox.style.color = '#333';
                } else { // info
                    messageBox.style.backgroundColor = '#28a745'; // Green
                    messageBox.style.color = 'white';
                }
                messageBox.classList.add('show');

                // Hide after 5 seconds
                setTimeout(() => {
                    messageBox.classList.remove('show');
                }, 5000);
            }
            // *** END FIX ***

            // Default values for resetting form
            const defaultValues = {
                'fault-current-ka': 10,
                'fault-duration-s': 0.5,
                'conductor-material': 'copper',
                'initial-temp-c': 30,
                'final-temp-c': 200,
                'safety-factor': 15,
                'conductor-type': 'cable',
                'preferred-bar-width': '',
            };

            // Conductor material properties (Metric values)
            const materialProperties = {
                'copper': { rho_20: 1.724e-8, beta: 234.5, Q_c: 3.45e6, default_final_temp_c: 200 },
                'aluminum': { rho_20: 2.826e-8, beta: 228.1, Q_c: 2.42e6, default_final_temp_c: 150 },
                'steel': { rho_20: 13.8e-8, beta: 200, Q_c: 3.9e6, default_final_temp_c: 300 }
            };

            // Standard cable sizes for recommendation (mm^2)
            const standardMetricSizes = [1.5, 2.5, 4, 6, 10, 16, 25, 35, 50, 70, 95, 120, 150, 185, 240, 300, 400, 500, 630, 800, 1000];
            const metricToImperialSizes = {
                1.5: '16 AWG', 2.5: '14 AWG', 4: '12 AWG', 6: '10 AWG', 16: '6 AWG',
                25: '4 AWG', 35: '2 AWG', 50: '1/0 AWG', 70: '2/0 AWG', 95: '3/0 AWG', 120: '4/0 AWG',
                150: '300 kcmil', 185: '350 kcmil', 240: '500 kcmil', 300: '600 kcmil',
                400: '800 kcmil', 500: '1000 kcmil', 630: '1250 kcmil', 800: '1500 kcmil', 1000: '2000 kcmil'
            };

            // Conversion Factors
            const CONVERSION_FACTORS = {
                C_to_F_val: (c) => (c * 9/5) + 32,
                F_to_C_val: (f) => (f - 32) * 5/9,
                mm2_to_kcmil: 1.9735,
                kcmil_to_mm2: 0.5067,
                mm_to_inch: 0.0393701,
                inch_to_mm: 25.4
            };

            // Labels and Tooltips for dynamic updating
            const unitSensitiveElements = {
                labels: {
                    'fault-current-ka': { metric: 'Fault Current (kA)', imperial: 'Fault Current (kA)' },
                    'fault-duration-s': { metric: 'Fault Duration (s)', imperial: 'Fault Duration (s)' },
                    'initial-temp-c': { metric: 'Initial Conductor Temperature (°C)', imperial: 'Initial Conductor Temperature (°F)' },
                    'final-temp-c': { metric: 'Final Conductor Temperature (°C)', imperial: 'Final Conductor Temperature (°F)' },
                    'preferred-bar-width': { metric: 'Preferred Bar Width (mm)', imperial: 'Preferred Bar Width (inch)' }
                },
                tooltips: {
                    'fault-current-ka': 'The RMS symmetrical fault current expected to flow through the earthing conductor during a short circuit. This is typically obtained from a short-circuit study.',
                    'fault-duration-s': 'The maximum time (in seconds) for which the fault current is expected to flow before being cleared by the upstream protective device (e.g., circuit breaker, fuse). Typical values range from 0.1s to 5s.',
                    'initial-temp-c': 'The maximum normal operating temperature of the earthing conductor just before a fault occurs. This value is $T_1$ in the adiabatic equation.',
                    'final-temp-c': 'The maximum allowable temperature the conductor can reach during a short-circuit fault without sustaining damage. This value is $T_2$ in the adiabatic equation.',
                    'conductor-type': 'Select whether the earthing conductor is a round cable or a flat bar/strip.',
                    'preferred-bar-width': {
                        metric: 'Enter a standard width for the flat bar (e.g., 25, 50, 75mm). The calculator will determine the required thickness. Leave blank for default (50mm).',
                        imperial: 'Enter a standard width for the flat bar (e.g., 1, 2, 3 inches). The calculator will determine the required thickness. Leave blank for default (2 inches).'
                    }
                }
            };
            
            // Add tooltips to labels
            function addTooltips() {
                 Object.keys(unitSensitiveElements.labels).forEach(id => {
                    const labelElement = document.getElementById(`label-${id}`);
                    if(labelElement) {
                        let tooltipText = '';
                        if (typeof unitSensitiveElements.tooltips[id] === 'string') {
                            tooltipText = unitSensitiveElements.tooltips[id];
                        } else {
                            // Default to metric if no unit system is selected yet, or use current
                            tooltipText = unitSensitiveElements.tooltips[id][unitSystemSelect.value || 'metric'];
                        }
                        
                        labelElement.innerHTML = `${labelElement.textContent} <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext no-mathjax" id="tooltip-${id}">${tooltipText}</span></span>`;
                    }
                 });
                 // Add tooltips for non-unit-sensitive elements
                 document.querySelector('label[for="conductor-material"]').innerHTML += ' <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext no-mathjax">The material of the earthing conductor (e.g., Copper, Aluminum, Steel). Different materials have distinct thermal and electrical properties.</span></span>';
                 document.querySelector('label[for="safety-factor"]').innerHTML += ' <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext no-mathjax">An additional percentage applied to the calculated area to account for uncertainties, future expansions, or conservative design practices. Typical values are 10-25%.</span></span>';
                 document.querySelector('label[for="unit-system"]').innerHTML += ' <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext no-mathjax">Select Metric (mm², °C) or Imperial (kcmil, °F) units for inputs and results.</span></span>';
            }
            

            // Function to update all labels and tooltips based on selected unit system
            function updateUnitLabelsAndTooltips(unitSystem) {
                // Update general labels and tooltips
                for (const id in unitSensitiveElements.labels) {
                    const labelElement = document.getElementById(`label-${id}`);
                    if (labelElement) {
                        let labelText = unitSensitiveElements.labels[id][unitSystem];
                        let tooltipText = '';
                        if (typeof unitSensitiveElements.tooltips[id] === 'string') {
                            tooltipText = unitSensitiveElements.tooltips[id];
                        } else {
                            tooltipText = unitSensitiveElements.tooltips[id][unitSystem];
                        }
                        
                        // Re-create the HTML content
                        labelElement.innerHTML = `${labelText} <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext no-mathjax" id="tooltip-${id}">${tooltipText}</span></span>`;
                        
                        // *** START FIX: Check if typesetPromise function exists ***
                        // Trigger MathJax typesetting if the tooltip contains math
                        if (window.MathJax && typeof window.MathJax.typesetPromise === 'function' && (tooltipText.includes('$') || tooltipText.includes('\\('))) {
                        // *** END FIX ***
                            const tooltipSpan = document.getElementById(`tooltip-${id}`);
                            tooltipSpan.classList.remove('no-mathjax'); // Allow MathJax to process
                            window.MathJax.typesetPromise([tooltipSpan]).catch(err => console.error(err));
                        }
                    }
                }

                // Update input values for temperature conversion
                const initialTempInput = document.getElementById('initial-temp-c');
                const finalTempInput = document.getElementById('final-temp-c');
                let currentInitialTemp = parseFloat(initialTempInput.value);
                let currentFinalTemp = parseFloat(finalTempInput.value);

                if (unitSystem === 'imperial') {
                    if (!initialTempInput.dataset.isFahrenheit) {
                        initialTempInput.value = CONVERSION_FACTORS.C_to_F_val(currentInitialTemp).toFixed(1);
                        finalTempInput.value = CONVERSION_FACTORS.C_to_F_val(currentFinalTemp).toFixed(1);
                        initialTempInput.dataset.isFahrenheit = "true";
                    }
                } else { // metric
                    if (initialTempInput.dataset.isFahrenheit) {
                        initialTempInput.value = CONVERSION_FACTORS.F_to_C_val(currentInitialTemp).toFixed(1);
                        finalTempInput.value = CONVERSION_FACTORS.F_to_C_val(currentFinalTemp).toFixed(1);
                        initialTempInput.dataset.isFahrenheit = "";
                    }
                }
                
                // Update bar dimensions placeholder
                const preferredBarWidthInput = document.getElementById('preferred-bar-width');
                if (unitSystem === 'imperial') {
                    preferredBarWidthInput.placeholder = 'e.g., 2';
                    preferredBarWidthInput.step = '0.1';
                } else {
                    preferredBarWidthInput.placeholder = 'e.g., 50';
                    preferredBarWidthInput.step = '1';
                }
            }

            // Event listener for conductor material change
            document.getElementById('conductor-material').addEventListener('change', function() {
                const material = this.value;
                const finalTempInput = document.getElementById('final-temp-c');
                let newDefaultFinalTempC = materialProperties[material].default_final_temp_c;

                if (unitSystemSelect.value === 'imperial') {
                    finalTempInput.value = CONVERSION_FACTORS.C_to_F_val(newDefaultFinalTempC).toFixed(1);
                } else {
                    finalTempInput.value = newDefaultFinalTempC.toFixed(1);
                }
            });

            // Event listener for conductor type change
            conductorTypeSelect.addEventListener('change', function() {
                if (this.value === 'flat-bar') {
                    flatBarFields.classList.remove('hidden');
                } else {
                    flatBarFields.classList.add('hidden');
                }
                // No need to update labels here, unitSystemSelect event will handle it
            });

            // Main Calculation Function
            function calculateEarthingSize() {
                calculationSpinner.style.display = 'inline-block';
                calculateEarthingBtn.disabled = true;

                // Use setTimeout to simulate processing and allow UI to update
                setTimeout(() => {
                    try {
                        const currentUnitSystem = unitSystemSelect.value;
                        
                        // 1. Get inputs
                        let faultCurrentKA = parseFloat(document.getElementById('fault-current-ka').value);
                        const faultDurationS = parseFloat(document.getElementById('fault-duration-s').value);
                        const conductorMaterial = document.getElementById('conductor-material').value;
                        let initialTemp = parseFloat(document.getElementById('initial-temp-c').value);
                        let finalTemp = parseFloat(document.getElementById('final-temp-c').value);
                        const safetyFactor = parseFloat(document.getElementById('safety-factor').value);
                        const conductorType = document.getElementById('conductor-type').value;
                        let preferredBarWidthInputVal = document.getElementById('preferred-bar-width').value;
                        
                        // 2. Validate inputs
                        if (isNaN(faultCurrentKA) || faultCurrentKA <= 0) throw new Error("Please enter a valid positive Fault Current.");
                        if (isNaN(faultDurationS) || faultDurationS <= 0) throw new Error("Please enter a valid positive Fault Duration.");
                        if (isNaN(safetyFactor) || safetyFactor < 0) throw new Error("Please enter a valid non-negative Safety Factor.");

                        // 3. Convert to Metric (Celsius) for calculation
                        let initialTempC, finalTempC;
                        if (currentUnitSystem === 'imperial') {
                            initialTempC = CONVERSION_FACTORS.F_to_C_val(initialTemp);
                            finalTempC = CONVERSION_FACTORS.F_to_C_val(finalTemp);
                        } else {
                            initialTempC = initialTemp;
                            finalTempC = finalTemp;
                        }

                        if (isNaN(initialTempC) || isNaN(finalTempC) || initialTempC >= finalTempC) {
                            throw new Error("Final temperature must be greater than initial temperature.");
                        }

                        // 4. Get material properties
                        const materialProps = materialProperties[conductorMaterial];
                        if (!materialProps) throw new Error("Selected conductor material properties not found.");
                        
                        const rho_20 = materialProps.rho_20, beta = materialProps.beta, Q_c = materialProps.Q_c;
                        const faultCurrentA = faultCurrentKA * 1000;

                        // 5. Perform Calculations
                        let calculationHtml = '<h4>Detailed Calculation Steps:</h4>';
                        
                        // Step 1: Calculate 'k' Factor
                        const k_factor_numerator = Q_c * Math.log((beta + finalTempC) / (beta + initialTempC));
                        const k_factor_denominator = rho_20 * (beta + initialTempC);
                        const k_factor = Math.sqrt(k_factor_numerator / k_factor_denominator);
                        
                        calculationHtml += `<p><strong>1. Calculate 'k' Factor (Material Constant):</strong></p>`;
                        calculationHtml += `<p class="formula">$$k = \\sqrt{\\frac{Q_c \\ln\\left(\\frac{\\beta + T_f}{\\beta + T_i}\\right)}{\\rho_{20}(\\beta + T_i)}}$$</p>`;
                        calculationHtml += `<ul>
                            <li>$Q_c$ (Volumetric Heat Capacity) = ${Q_c.toExponential(3)} J/m³K</li>
                            <li>$\\beta$ (Material Constant) = ${beta.toFixed(1)} °C</li>
                            <li>$\\rho_{20}$ (Resistivity at 20°C) = ${rho_20.toExponential(3)} Ω·m</li>
                            <li>$T_i$ (Initial Temp) = ${initialTempC.toFixed(1)} °C</li>
                            <li>$T_f$ (Final Temp) = ${finalTempC.toFixed(1)} °C</li>
                        </ul>`;
                        calculationHtml += `<p class="calculation-step">k = ${k_factor.toFixed(2)}</p>`;

                        // Step 2: Calculate Minimum Area (S)
                        const minAreaMM2 = (faultCurrentA * Math.sqrt(faultDurationS)) / k_factor;
                        calculationHtml += `<p><strong>2. Calculate Minimum Cross-sectional Area (S):</strong></p>`;
                        calculationHtml += `<p class="formula">$$S_{min} = \\frac{I \\times \\sqrt{t}}{k}$$</p>`;
                        calculationHtml += `<ul>
                            <li>$I$ (Fault Current) = ${faultCurrentA.toFixed(0)} A</li>
                            <li>$t$ (Fault Duration) = ${faultDurationS.toFixed(2)} s</li>
                        </ul>`;
                        calculationHtml += `<p class="calculation-step">S_min = (${faultCurrentA.toFixed(0)} × √${faultDurationS.toFixed(2)}) / ${k_factor.toFixed(2)} = ${minAreaMM2.toFixed(2)} mm²</p>`;

                        // Step 3: Apply Safety Factor
                        const finalAreaMM2 = minAreaMM2 * (1 + safetyFactor / 100);
                        calculationHtml += `<p><strong>3. Apply Safety Factor:</strong></p>`;
                        calculationHtml += `<p class="formula">$$S_{final} = S_{min} \\times (1 + \\frac{\\text{Safety Factor}}{100})$$</p>`;
                        calculationHtml += `<p class="calculation-step">S_final = ${minAreaMM2.toFixed(2)} mm² × (1 + ${safetyFactor}%) = ${finalAreaMM2.toFixed(2)} mm²</p>`;

                        // 6. Format Results
                        resultTableBody.innerHTML = ''; // Clear previous results
                        
                        // Helper function to add rows
                        function addResultRow(parameter, value) {
                            const row = resultTableBody.insertRow();
                            const paramCell = row.insertCell();
                            const valueCell = row.insertCell();
                            paramCell.innerHTML = parameter; // Use innerHTML to allow strong tags
                            valueCell.innerHTML = value;
                        }

                        addResultRow("Calculated 'k' Factor", `${k_factor.toFixed(2)}`);
                        addResultRow("Minimum Required Area", `${minAreaMM2.toFixed(2)} mm²`);
                        
                        let recommendedSizeDisplay = '';
                        if (conductorType === 'cable') {
                            // Recommend Standard Cable Size
                            let recommendedSizeMM2 = standardMetricSizes.find(size => size >= finalAreaMM2);
                            if (!recommendedSizeMM2) {
                                recommendedSizeMM2 = standardMetricSizes[standardMetricSizes.length - 1];
                                displayMessage("Calculated size exceeds standard values. Using largest in list.", "warning");
                            }
                            
                            if (currentUnitSystem === 'imperial') {
                                const finalAreakcmil = finalAreaMM2 * CONVERSION_FACTORS.mm2_to_kcmil;
                                const recommendedSizeImperial = metricToImperialSizes[recommendedSizeMM2] || (recommendedSizeMM2 * CONVERSION_FACTORS.mm2_to_kcmil).toFixed(0) + ' kcmil';
                                addResultRow("Final Area (Imperial)", `<strong>${finalAreakcmil.toFixed(2)} kcmil</strong>`);
                                recommendedSizeDisplay = `<strong>${recommendedSizeImperial}</strong> (Standard size >= ${finalAreakcmil.toFixed(2)} kcmil)`;
                            } else {
                                addResultRow("Final Area (Metric)", `<strong>${finalAreaMM2.toFixed(2)} mm²</strong>`);
                                recommendedSizeDisplay = `<strong>${recommendedSizeMM2} mm²</strong> (Standard size >= ${finalAreaMM2.toFixed(2)} mm²)`;
                            }
                            addResultRow("<strong>Recommended Cable Size</strong>", recommendedSizeDisplay);
                        
                        } else { // flat-bar
                            let preferredBarWidthMM = 50; // Default metric
                            if (currentUnitSystem === 'imperial') preferredBarWidthMM = 2 * CONVERSION_FACTORS.inch_to_mm; // Default imperial in mm
                            
                            if (preferredBarWidthInputVal) {
                                preferredBarWidthMM = parseFloat(preferredBarWidthInputVal);
                                if (currentUnitSystem === 'imperial') {
                                    preferredBarWidthMM *= CONVERSION_FACTORS.inch_to_mm;
                                }
                            }
                            
                            const calculatedThicknessMM = finalAreaMM2 / preferredBarWidthMM;
                            
                            if (currentUnitSystem === 'imperial') {
                                const finalAreaInch2 = finalAreaMM2 * CONVERSION_FACTORS.mm_to_inch * CONVERSION_FACTORS.mm_to_inch;
                                addResultRow("Final Area (Imperial)", `<strong>${finalAreaInch2.toFixed(4)} in²</strong>`);
                                recommendedSizeDisplay = `<strong>Width:</strong> ${(preferredBarWidthMM * CONVERSION_FACTORS.mm_to_inch).toFixed(2)} in, <strong>Min. Thickness:</strong> ${(calculatedThicknessMM * CONVERSION_FACTORS.mm_to_inch).toFixed(4)} in`;
                            } else {
                                addResultRow("Final Area (Metric)", `<strong>${finalAreaMM2.toFixed(2)} mm²</strong>`);
                                recommendedSizeDisplay = `<strong>Width:</strong> ${preferredBarWidthMM.toFixed(0)} mm, <strong>Min. Thickness:</strong> ${calculatedThicknessMM.toFixed(3)} mm`;
                            }
                            addResultRow("<strong>Recommended Bar Dimensions</strong>", recommendedSizeDisplay);
                        }

                        // 7. Display Results
                        calculationDetailsDiv.innerHTML = calculationHtml;
                        // *** START FIX: Check if typesetPromise function exists ***
                        if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
                        // *** END FIX ***
                            window.MathJax.typesetPromise([calculationDetailsDiv]).catch(err => console.error(err));
                        }
                        
                        standardReference.innerHTML = `<strong>Standard Reference:</strong> Sizing based on the adiabatic equation per <strong>IEC 60364-5-54</strong> and <strong>IEEE Std 80</strong>. This calculation determines the thermal withstand capability of the conductor. Always consult local codes for minimum required sizes based on mechanical strength (e.g., 2.5mm² protected, 4mm² unprotected for copper) and corrosion resistance. Final design must be verified by a qualified engineer.`;
                        
                        resultContainer.style.display = 'block';
                        setTimeout(() => resultContainer.classList.add('show'), 10);
                        resultContainer.scrollIntoView({ behavior: 'smooth' });

                    } catch (error) {
                        displayMessage(error.message, "error");
                    } finally {
                        // Re-enable button and hide spinner
                        calculationSpinner.style.display = 'none';
                        calculateEarthingBtn.disabled = false;
                    }
                }, 500); // 500ms delay
            }

            // Reset Form Function
            function resetForm() {
                for (const id in defaultValues) {
                    const input = document.getElementById(id);
                    if (input) input.value = defaultValues[id];
                }
                unitSystemSelect.value = 'metric';
                document.getElementById('initial-temp-c').dataset.isFahrenheit = "";
                updateUnitLabelsAndTooltips('metric');
                conductorTypeSelect.dispatchEvent(new Event('change'));
                document.getElementById('conductor-material').dispatchEvent(new Event('change'));
                clearResults();
                displayMessage("Form reset to default values.", "info");
            }
            
            // Clear Results Function
            function clearResults() {
                resultContainer.classList.remove('show');
                setTimeout(() => {
                    resultTableBody.innerHTML = '';
                    calculationDetailsDiv.innerHTML = '';
                    standardReference.innerHTML = '';
                    resultContainer.style.display = 'none';
                }, 500); // Wait for fade out
            }

            // Download PDF Function
            function downloadPDF() {
                if (!resultContainer.classList.contains('show')) {
                    displayMessage("Please run a calculation first to generate a report.", "error");
                    return;
                }
                
                displayMessage("Generating PDF... Please wait.", "info");

                // Use html2canvas to capture the result container
                const pdfTarget = document.getElementById('result-container');
                const { jsPDF } = window.jspdf;

                html2canvas(pdfTarget, {
                    scale: 2, // Improve resolution
                    useCORS: true,
                    onclone: (doc) => {
                        // Ensure dark mode text is visible on PDF
                        if (document.body.classList.contains('dark-mode')) {
                           let elements = doc.querySelectorAll('.result-container, .result-table td, #calculation-details, .standard-reference, .result-container h3, #calculation-details h4, .result-table td strong');
                           elements.forEach(el => {
                                el.style.color = '#000000'; // Set text to black
                           });
                           doc.querySelector('.result-container').style.background = '#FFFFFF';
                           doc.querySelector('#calculation-details').style.background = '#F8FAFC';
                           doc.querySelectorAll('.result-table tr:nth-child(even)').forEach(el => {
                                el.style.backgroundColor = '#F8FAFC';
                           });
                           doc.querySelectorAll('.result-table th').forEach(el => {
                                el.style.background = '#1E3A8A'; // Use light-mode header
                                el.style.color = '#FFFFFF';
                           });
                        }
                    }
                }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    
                    const canvasWidth = canvas.width;
                    const canvasHeight = canvas.height;
                    const ratio = canvasHeight / canvasWidth;
                    
                    const imgWidth = pdfWidth - 20; // A4 width with 10mm margin each side
                    const imgHeight = imgWidth * ratio;
                    
                    let heightLeft = imgHeight;
                    let position = 10; // Top margin 10mm

                    // Add title
                    pdf.setFont("helvetica", "bold");
                    pdf.setFontSize(18);
                    pdf.setTextColor(30, 58, 138); // #1E3A8A
                    pdf.text("Earthing Cable Sizing Calculation Report", pdfWidth / 2, 15, { align: 'center' });

                    // Add generated date
                    pdf.setFont("helvetica", "normal");
                    pdf.setFontSize(10);
                    pdf.setTextColor(100, 100, 100);
                    pdf.text(`Generated on: ${new Date().toLocaleString()}`, pdfWidth / 2, 22, { align: 'center' });
                    
                    position = 30; // Reset position after title

                    if (imgHeight < pdfHeight - position - 10) {
                        // Content fits on one page
                        pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                    } else {
                        // Content needs multiple pages
                        let page = 1;
                        while (heightLeft > 0) {
                            pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight, undefined, 'FAST');
                            heightLeft -= (pdfHeight - position - 10);
                            if (heightLeft > 0) {
                                pdf.addPage();
                                position = -imgHeight * page + 10; // Calculate new Y position
                                page++;
                            }
                        }
                    }

                    // Add footer to all pages
                    const pageCount = pdf.internal.getNumberOfPages();
                    for(let i = 1; i <= pageCount; i++) {
                        pdf.setPage(i);
                        pdf.setFontSize(8);
                        pdf.setTextColor(150, 150, 150);
                        pdf.text(`Page ${i} of ${pageCount} | www.designcalculators.co.in`, pdfWidth / 2, pdfHeight - 10, { align: 'center' });
                    }

                    pdf.save('Earthing-Calculation-Report.pdf');
                }).catch(err => {
                    displayMessage("Error generating PDF. See console for details.", "error");
                    console.error(err);
                });
            }

            // Add Event Listeners
            calculateEarthingBtn.addEventListener('click', calculateEarthingSize);
            resetFormBtn.addEventListener('click', resetForm);
            downloadPdfBtn.addEventListener('click', downloadPDF);
            unitSystemSelect.addEventListener('change', (event) => {
                updateUnitLabelsAndTooltips(event.target.value);
            });

            // Theme switch logic
            const themeSwitch = document.getElementById('theme-switch');
            if (themeSwitch) {
                if (localStorage.getItem('theme') === 'dark') {
                    document.body.classList.add('dark-mode');
                    themeSwitch.checked = true;
                }
                themeSwitch.addEventListener('change', function() {
                    if (this.checked) {
                        document.body.classList.add('dark-mode');
                        localStorage.setItem('theme', 'dark');
                    } else {
                        document.body.classList.remove('dark-mode');
                        localStorage.setItem('theme', 'light');
                    }
                });
            }
            
            // Initial setup
            addTooltips();
            updateUnitLabelsAndTooltips(unitSystemSelect.value);
            conductorTypeSelect.dispatchEvent(new Event('change'));
            document.getElementById('conductor-material').dispatchEvent(new Event('change'));

        });
    </script>
</body>
</html>

