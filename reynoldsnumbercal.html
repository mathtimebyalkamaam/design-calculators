<!DOCTYPE html>
<html lang="en">
<head>
    <!-- AdSense & Analytics -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5936527763614780" crossorigin="anonymous"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-23Y1V450SR"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-23Y1V450SR');
    </script>
    
    <!-- SEO Meta Tags -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reynolds Number, Friction & Head Loss Calculator - Ultimate Edition</title>
    <meta name="description" content="Advanced Reynolds Number Calculator with Colebrook-White iteration. Calculates Flow Regime, Darcy Friction Factor, Head Loss, and Pump Power for circular and non-circular conduits.">
    <meta name="keywords" content="reynolds number, colebrook-white, darcy-weisbach, head loss calculator, pump power, hydraulic diameter, flow regime, fluid dynamics, moody chart, chemical engineering">
    <meta name="author" content="Design Calculators">
    <meta name="robots" content="index, follow">

    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Montserrat:wght@700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>

    <!-- Chart.js for Visuals -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1/dist/chartjs-plugin-annotation.min.js"></script>

    <!-- MathJax for Formulas -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['\\(', '\\)'], ['$', '$']],
                displayMath: [['\\[', '\\]'], ['$$', '$$']]
            },
            svg: { fontCache: 'global' }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <!-- Favicon Links -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">

    <style>
        /* --- CORE THEME (Blue Industrial - Matches Symmetrical Components) --- */
        :root {
            --primary: #1E3A8A; /* Dark Blue */
            --secondary: #2563EB; /* Bright Blue */
            --accent: #F59E0B; /* Amber */
            --success: #10B981;
            --danger: #DC2626;
            --warning: #F59E0B;
            --bg: #F8FAFC;
            --card: #FFFFFF;
            --text: #4B5563;
            --heading: #111827;
            --footer-bg: #0F172A;
            --border: #E2E8F0;
            --grad: linear-gradient(135deg, var(--primary), var(--secondary));
            --grad-dark: linear-gradient(135deg, #0F172A, #1E293B);
            --shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        body.dark-mode {
            --primary: #10B981;
            --secondary: #34D399;
            --bg: #0F172A;
            --card: #1E293B;
            --text: #CBD5E1;
            --heading: #F1F5F9;
            --footer-bg: #020617;
            --border: #334155;
            --accent: #F59E0B;
        }

        * { box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.7;
            margin: 0;
            padding: 0;
        }

        .container { max-width: 1280px; margin: 0 auto; padding: 0 24px; }

        /* Header & Nav */
        header {
            background: var(--grad);
            color: white;
            padding: 24px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo-container {
            display: flex;
            flex-direction: column;
            text-decoration: none;
            color: white;
        }
        .logo-text {
            font-size: 1.75rem;
            font-weight: 800;
            font-family: 'Montserrat', sans-serif;
        }
        .logo-subtitle {
            font-size: 0.8rem;
            margin: 4px 0 0 0;
            color: #E0E7FF;
            opacity: 0.9;
        }
        .nav-links {
            display: flex;
            gap: 24px;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        .nav-links a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }
        .nav-links a:hover { color: var(--accent); }
        
        /* Theme Toggle */
        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
            color: white;
        }
        .switch {
            position: relative;
            width: 56px;
            height: 30px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0,0,0,0.2);
            transition: .4s;
            border-radius: 30px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 22px; width: 22px;
            left: 4px; bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(26px); }

        /* Main Content & Cards */
        main { padding: 40px 0; }
        .card {
            background: var(--card);
            border-radius: 12px;
            padding: 30px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            border: 1px solid var(--border);
            animation: fadeIn 0.6s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .card h2 {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
            padding-bottom: 15px;
            margin-top: 0;
            font-family: 'Montserrat', sans-serif;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        h3 {
            color: var(--heading);
            font-family: 'Montserrat', sans-serif;
            font-size: 1.5rem;
            margin-top: 25px;
            margin-bottom: 20px;
        }

        /* Forms */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .form-group { margin-bottom: 0; }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--heading);
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 6px;
            background-color: var(--bg);
            color: var(--text);
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        .form-group input:focus, .form-group select:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
        }
        body.dark-mode .form-group input:focus { 
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        /* Buttons */
        .btn {
            background: var(--grad);
            color: white;
            border: none;
            padding: 16px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(30, 58, 138, 0.3);
            transition: all 0.3s;
            width: 100%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(30, 58, 138, 0.4);
        }
        .btn-outline {
            background: transparent;
            border: 2px solid var(--secondary);
            color: var(--secondary);
            font-size: 0.9rem;
            padding: 8px 16px;
        }
        .btn-outline:hover {
            background: var(--secondary);
            color: white;
        }
        .button-wrapper {
            display: flex;
            justify-content: center;
            width: 100%;
            padding-top: 15px;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        /* Quick Load Buttons */
        .preset-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        .preset-btn {
            padding: 8px 12px;
            font-size: 0.85rem;
            border: 1px solid var(--border);
            background: var(--card);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .preset-btn:hover {
            background: var(--bg);
            border-color: var(--secondary);
            color: var(--secondary);
        }

        /* Results Layout */
        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            align-items: start;
        }
        @media (max-width: 1024px) {
            .results-grid { grid-template-columns: 1fr; }
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-radius: 8px;
            overflow: hidden;
        }
        .results-table th, .results-table td {
            padding: 14px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        .results-table th {
            background: var(--grad);
            color: white;
            font-weight: 700;
        }
        .results-table tr:nth-child(even) { background-color: var(--bg); }
        .results-table td:first-child {
            font-weight: 600;
            color: var(--heading);
        }
        .highlight { color: var(--success); font-weight: 700; }
        .danger-text { color: var(--danger); font-weight: 700; }

        /* Canvas Container */
        .chart-container {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            position: relative;
            height: 400px;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        canvas {
            max-width: 100%;
            max-height: 100%;
        }

        /* Educational Section Styling */
        .insight-card {
            background: linear-gradient(135deg, var(--card), rgba(37,99,235,0.03));
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            border-left: 5px solid var(--secondary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: all 0.3s;
        }
        .insight-card:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .insight-card h4 {
            color: var(--secondary);
            font-size: 1.3rem;
            margin: 0 0 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: 'Montserrat', sans-serif;
        }
        .insight-card p, .insight-card ul {
            margin: 10px 0;
            line-height: 1.8;
            color: var(--text);
        }
        .insight-card ul { padding-left: 20px; }
        .insight-card li { margin-bottom: 8px; }

        /* Formulas & Steps */
        .formula {
            background: var(--bg);
            border-left: 3px solid var(--accent);
            padding: 15px;
            margin: 12px 0;
            font-size: 1.1rem;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
            color: var(--heading);
        }
        .calculation-step {
            font-family: 'Courier New', monospace;
            background-color: rgba(0,0,0,0.03);
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            border-left: 4px solid var(--success);
            font-size: 0.95rem;
            line-height: 1.6;
        }
        body.dark-mode .calculation-step { background-color: rgba(255,255,255,0.05); }

        /* Vector Input Group Styling (Reused) */
        .vector-input-group {
            background: var(--bg);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border);
            position: relative;
        }
        .vector-input-header {
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Flow Animation */
        .flow-animation-container {
            width: 100%;
            height: 40px;
            background: #e2e8f0;
            border-radius: 20px;
            position: relative;
            overflow: hidden;
            margin-top: 10px;
            border: 1px solid var(--border);
        }
        .flow-particle {
            position: absolute;
            top: 50%;
            left: -20px;
            width: 10px;
            height: 10px;
            background: var(--secondary);
            border-radius: 50%;
            transform: translateY(-50%);
            animation: flowMove linear infinite;
        }
        @keyframes flowMove {
            0% { left: -20px; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { left: 100%; opacity: 0; }
        }
        
        /* Print Styling */
        @media print {
            header, footer, .education-section, .theme-toggle, .button-wrapper, .preset-container { display: none !important; }
            .card { border: none; shadow: none; padding: 0; }
            .container { width: 100%; max-width: 100%; padding: 0; }
            .results-grid { grid-template-columns: 1fr 1fr; }
            .chart-container { height: 300px; page-break-inside: avoid; }
        }

        /* Message Box */
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 16px 28px;
            border-radius: 8px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.25);
            z-index: 10000;
            font-weight: 600;
            color: white;
            opacity: 0;
            transition: all 0.4s;
            display: none;
        }
        .message-box.show { display: block; opacity: 1; top: 30px; }
        .hidden { display: none; }

        /* Tooltip */
        .info-icon { color: var(--secondary); margin-left: 5px; cursor: help; }
        .tooltip { position: relative; display: inline-block; }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 220px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -110px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.85rem;
            font-weight: 400;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }

        /* Footer */
        footer {
            background: var(--grad-dark);
            color: #CBD5E1;
            padding: 50px 0 20px 0;
            margin-top: 60px;
        }
        .footer-content {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 40px;
            margin-bottom: 30px;
        }
        .footer-col { flex: 1; min-width: 200px; }
        .footer-col h4 { color: white; margin-bottom: 15px; font-weight: 700; }
        .footer-col ul { list-style: none; padding: 0; margin: 0; }
        .footer-col a { color: #CBD5E1; text-decoration: none; transition: color 0.3s; }
        .footer-col a:hover { color: var(--accent); }
        .social-buttons { display: flex; gap: 12px; margin-top: 15px; }
        .social-btn {
            width: 40px; height: 40px;
            display: flex; justify-content: center; align-items: center;
            color: white; border-radius: 50%;
            font-size: 1.1rem; transition: transform 0.3s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .social-btn:hover { transform: translateY(-4px); }
        .social-btn.linkedin { background-color: #0A66C2; }
        .social-btn.youtube { background-color: #FF0000; }
        .social-btn.twitter { background-color: #1DA1F2; }
        .social-btn.facebook { background-color: #1877F2; }
        .social-btn.whatsapp { background-color: #25D366; }
        .footer-disclaimer {
            text-align: center; padding-top: 25px;
            border-top: 1px solid #334155;
            max-width: 800px; margin: 0 auto;
            font-size: 0.9rem;
        }
        .footer-bottom {
            text-align: center; padding-top: 20px;
            font-size: 0.9rem; color: #94A3B8;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container { padding: 0 15px; }
            .navbar { flex-direction: column; gap: 20px; }
            .nav-links { flex-direction: column; gap: 12px; text-align: center; }
            .form-row { grid-template-columns: 1fr; }
            .card { padding: 20px; }
            .footer-content { flex-direction: column; gap: 25px; }
        }
    </style>
</head>
<body>
    <div id="message-box" class="message-box"></div>
    <header>
        <div class="container">
            <nav class="navbar">
                <a href="#" class="logo-container">
                    <span class="logo-text">Design Calculators</span>
                    <p class="logo-subtitle">Inspired by standards such as IEC, IEEE, ISA, ASME, and API.</p>
                </a>
                <ul class="nav-links">
                    <li><a href='/'>Home</a></li>
                    <li><a href="articles">Articles</a></li>
                    <li><a href="indexmech">Mechanical</a></li>
                    <li><a href="indexele">Electrical</a></li>
                    <li><a href="indexinst">Instrumentation</a></li>
                </ul>
                <div class="theme-toggle">
                    <i class="fas fa-sun"></i>
                    <label class="switch">
                        <input type="checkbox" id="theme-switch">
                        <span class="slider"></span>
                    </label>
                    <i class="fas fa-moon"></i>
                </div>
            </nav>
        </div>
    </header>

    <main class="container">
        <div class="card">
            <h2><i class="fas fa-water"></i> Reynolds Number & Flow Regime Calculator</h2>
            
            <div class="tool-description">
                <p>This industrial-grade calculator determines the <strong>Reynolds Number ($Re$)</strong> to identify flow regimes (Laminar, Transient, Turbulent). It features an advanced <strong>Hydraulic Diameter ($D_h$)</strong> engine for non-circular pipes and solves the implicit <strong>Colebrook-White</strong> equation (iterative) for the exact Darcy Friction Factor ($f$). It also calculates <strong>Head Loss ($h_f$)</strong> and <strong>Hydraulic Power</strong> requirements.</p>
            </div>

            <div class="calculator-form">
                <form id="re-form">
                    <!-- Controls Row -->
                    <div class="form-row" style="align-items: end;">
                        <div class="form-group">
                            <label>Quick Load Scenarios:</label>
                            <div class="preset-container" style="margin-bottom: 0;">
                                <button type="button" class="preset-btn" onclick="loadPreset('water_turb')"><i class="fas fa-water"></i> Turbulent Water</button>
                                <button type="button" class="preset-btn" onclick="loadPreset('oil_lam')"><i class="fas fa-tint"></i> Laminar Heavy Oil</button>
                                <button type="button" class="preset-btn" onclick="loadPreset('duct_air')"><i class="fas fa-wind"></i> Air Duct (HVAC)</button>
                            </div>
                        </div>
                    </div>

                    <!-- Fluid Properties -->
                    <h4 style="color: var(--primary); margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 5px;">1. Fluid Properties</h4>
                    <div class="form-row">
                        <div class="vector-input-group">
                            <div class="vector-input-header"><i class="fas fa-flask"></i> Fluid</div>
                            <div class="form-group">
                                <label for="fluid-type">Common Fluids</label>
                                <select id="fluid-type" onchange="updateFluid()">
                                    <option value="custom">Custom Input</option>
                                    <option value="water" selected>Water (20°C)</option>
                                    <option value="air">Air (20°C, 1 atm)</option>
                                    <option value="oil_light">Light Oil (Hydraulic)</option>
                                    <option value="oil_heavy">Heavy Crude Oil</option>
                                    <option value="steam">Saturated Steam (10 bar)</option>
                                </select>
                            </div>
                        </div>
                        <div class="vector-input-group">
                            <div class="vector-input-header"><i class="fas fa-weight-hanging"></i> Density & Viscosity</div>
                            <div class="form-group">
                                <label for="density">Density ($\rho$) [kg/m³]</label>
                                <input type="number" id="density" value="998" step="1">
                            </div>
                            <div class="form-group" style="margin-top:10px;">
                                <label for="viscosity">Dynamic Viscosity ($\mu$) [cP] <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">1 cP = 0.001 Pa.s (Water ~ 1 cP)</span></span></label>
                                <input type="number" id="viscosity" value="1.002" step="0.001">
                            </div>
                        </div>
                    </div>

                    <!-- Geometry & Flow -->
                    <h4 style="color: var(--primary); margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 5px; margin-top: 20px;">2. Geometry & Flow Conditions</h4>
                    <div class="form-row">
                        <div class="vector-input-group">
                            <div class="vector-input-header"><i class="fas fa-ruler-combined"></i> Geometry</div>
                            <div class="form-group">
                                <label for="geo-type">Conduit Shape</label>
                                <select id="geo-type" onchange="toggleGeometry()">
                                    <option value="pipe" selected>Circular Pipe</option>
                                    <option value="rect">Rectangular Duct</option>
                                    <option value="annulus">Annulus (Double Pipe)</option>
                                </select>
                            </div>
                            
                            <!-- Pipe Inputs -->
                            <div id="geo-pipe" class="form-group" style="margin-top:10px;">
                                <label for="pipe-dia">Pipe ID [mm]</label>
                                <input type="number" id="pipe-dia" value="100" step="1">
                            </div>

                            <!-- Rect Inputs -->
                            <div id="geo-rect" class="hidden">
                                <div class="form-group" style="margin-top:10px;">
                                    <label for="rect-w">Width [mm]</label>
                                    <input type="number" id="rect-w" value="300" step="1">
                                </div>
                                <div class="form-group" style="margin-top:10px;">
                                    <label for="rect-h">Height [mm]</label>
                                    <input type="number" id="rect-h" value="200" step="1">
                                </div>
                            </div>

                            <!-- Annulus Inputs -->
                            <div id="geo-annulus" class="hidden">
                                <div class="form-group" style="margin-top:10px;">
                                    <label for="ann-od">Outer ID [mm]</label>
                                    <input type="number" id="ann-od" value="100" step="1">
                                </div>
                                <div class="form-group" style="margin-top:10px;">
                                    <label for="ann-id">Inner OD [mm]</label>
                                    <input type="number" id="ann-id" value="50" step="1">
                                </div>
                            </div>
                            
                            <div class="form-group" style="margin-top:10px;">
                                <label for="pipe-len">Pipe Length ($L$) [m] <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Length for calculating total pressure drop.</span></span></label>
                                <input type="number" id="pipe-len" value="50" step="1">
                            </div>

                            <div class="form-group" style="margin-top:10px;">
                                <label for="roughness">Roughness ($\epsilon$) [mm] <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Steel: 0.045, PVC: 0.0015, Concrete: 0.3</span></span></label>
                                <input type="number" id="roughness" value="0.045" step="0.001">
                            </div>
                        </div>

                        <div class="vector-input-group">
                            <div class="vector-input-header"><i class="fas fa-tachometer-alt"></i> Flow Rate</div>
                            <div class="form-group">
                                <label for="flow-type">Input Type</label>
                                <select id="flow-type" onchange="toggleFlowInput()">
                                    <option value="velocity" selected>Velocity (m/s)</option>
                                    <option value="vol_m3h">Volumetric (m³/h)</option>
                                    <option value="mass_kgh">Mass Flow (kg/h)</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-top:10px;">
                                <label for="flow-val">Flow Value</label>
                                <input type="number" id="flow-val" value="2.5" step="0.1">
                            </div>
                        </div>
                    </div>

                    <div class="button-wrapper">
                        <button type="button" id="calculate-btn" class="btn"><i class="fas fa-calculator"></i> Calculate Fluid Dynamics</button>
                        <button type="button" id="pdf-btn" class="btn btn-outline"><i class="fas fa-file-pdf"></i> Download PDF Report</button>
                    </div>
                </form>
            </div>

            <!-- Results Section -->
            <div id="result-container" class="card hidden" style="margin-top: 40px;">
                <h3><i class="fas fa-poll"></i> Fluid Dynamics Analysis</h3>
                
                <div class="results-grid">
                    <!-- Left Col: Table -->
                    <div>
                        <h4 style="margin-top: 0; color: var(--primary); margin-bottom: 15px;">Key Parameters</h4>
                        <table class="results-table">
                            <thead>
                                <tr>
                                    <th>Parameter</th>
                                    <th>Value</th>
                                    <th>Unit</th>
                                </tr>
                            </thead>
                            <tbody id="result-table-body">
                                <!-- Dynamic rows -->
                            </tbody>
                        </table>
                        
                        <div style="margin-top: 20px; background: var(--bg); padding: 15px; border-radius: 6px; border: 1px solid var(--border);">
                            <strong><i class="fas fa-info-circle"></i> Flow Visualization:</strong>
                            <div id="flow-visual-container" class="flow-animation-container">
                                <!-- Animated particles injected here -->
                            </div>
                            <div id="interpretation-text" style="margin-top: 10px; font-size: 0.95rem;"></div>
                        </div>
                    </div>

                    <!-- Right Col: Visual Chart -->
                    <div>
                        <h4 style="margin-top: 0; color: var(--primary); margin-bottom: 15px;">Moody Chart Position</h4>
                        <div class="chart-container">
                            <canvas id="moodyChart"></canvas>
                        </div>
                        <div style="text-align: center; margin-top: 10px; font-size: 0.85rem; color: var(--text);">
                            <span style="color: #10B981;">● Laminar (64/Re)</span> &nbsp;
                            <span style="color: #3B82F6;">● Turbulent (Smooth)</span> &nbsp;
                            <span style="color: #EF4444; font-weight:bold; font-size: 1.1em;">● Operating Point</span>
                        </div>
                    </div>
                </div>

                <h4 style="margin-top: 30px; border-top: 1px solid var(--border); padding-top: 20px;">Step-by-Step Engineering Calculation</h4>
                <div id="calculation-details">
                    <!-- Dynamic math steps -->
                </div>

                <div class="standard-reference" style="margin-top: 20px; font-style: italic; color: var(--text);">
                     Friction Factor calculated using iterative Newton-Raphson on Colebrook-White equation. Head Loss per Darcy-Weisbach.
                </div>
            </div>
        </div>

        <!-- EDUCATIONAL CONTENT SECTION (MASSIVE) -->
        <div class="education-section card">
            <h2><i class="fas fa-lightbulb"></i> Engineering Insights: Fluid Dynamics Masterclass</h2>
            
            <!-- Insight 1: Reynolds Number -->
            <div class="insight-card">
                <h4><i class="fas fa-water"></i> 1. The Reynolds Number ($Re$): The Ratio of Forces</h4>
                <p>The Reynolds number is arguably the most important dimensionless number in fluid mechanics. It quantifies the ratio of <strong>Inertial Forces</strong> (momentum, driving the fluid forward) to <strong>Viscous Forces</strong> (friction, trying to stick the fluid together).</p>
                <div class="formula">$$ Re = \frac{\rho v D}{\mu} = \frac{\text{Inertial Forces}}{\text{Viscous Forces}} $$</div>
                <p><strong>The Physics of Regimes:</strong></p>
                <ul>
                    <li><strong>Laminar ($Re < 2300$):</strong> Viscous forces are dominant. Imagine honey pouring. The fluid moves in smooth, parallel layers (laminae) sliding over each other. There is no cross-current mixing. The velocity profile is parabolic (zero at walls, max at center). Friction factor $f$ is independent of roughness because the boundary layer covers all surface imperfections.</li>
                    <li><strong>Transition ($2300 < Re < 4000$):</strong> A chaotic zone where flow can snap back and forth between laminar and turbulent. It is unstable and difficult to predict. Engineering designs usually avoid this zone.</li>
                    <li><strong>Turbulent ($Re > 4000$):</strong> Inertial forces dominate. Imagine water rushing from a fire hose. The flow is chaotic with eddies, vortices, and random fluctuations. Mixing is excellent (good for heat transfer, bad for pressure drop). The velocity profile is flatter (plug flow). Friction depends heavily on wall roughness because the laminar sub-layer becomes very thin, exposing surface peaks to the main flow.</li>
                </ul>
            </div>

            <!-- Insight 2: Friction Factor & Colebrook-White -->
            <div class="insight-card">
                <h4><i class="fas fa-calculator"></i> 2. Solving the Unsolvable: Colebrook-White</h4>
                <p>For turbulent flow, the friction factor ($f$) is determined by the Colebrook-White equation. It combines the data for smooth pipes (Prandtl-Karman) and rough pipes.</p>
                <div class="formula">$$ \frac{1}{\sqrt{f}} = -2 \log_{10} \left( \frac{\varepsilon/D}{3.7} + \frac{2.51}{Re \sqrt{f}} \right) $$</div>
                <p><strong>The Problem:</strong> This equation is <em>implicit</em>. The variable we want ($f$) appears on both sides of the equals sign inside a logarithm and a square root. You cannot isolate $f$ algebraically. </p>
                <p><strong>The Solution:</strong>
                <ul>
                    <li><strong>Iterative Solver (Newton-Raphson):</strong> This calculator uses a numerical method. We guess a value for $f$, check the error, refine the guess, and repeat until the error is zero. This provides 100% mathematical correctness.</li>
                    <li><strong>Swamee-Jain Approximation:</strong> Many simpler tools use this explicit formula. It is accurate to within 1-2% for most ranges but fails at very low/high extremes. We use this only as the "initial guess" for our iterative solver.</li>
                </ul>
                </p>
            </div>

            <!-- Insight 3: Hydraulic Diameter -->
            <div class="insight-card">
                <h4><i class="fas fa-shapes"></i> 3. Non-Circular Ducts: Hydraulic Diameter ($D_h$)</h4>
                <p>Most fluid equations assume a round pipe. But what about a square HVAC duct or the annulus of a double-pipe heat exchanger? We use the <strong>Hydraulic Diameter ($D_h$)</strong> to create an "equivalent" circular pipe model.</p>
                <div class="formula">$$ D_h = \frac{4 \times \text{Cross Sectional Area}}{\text{Wetted Perimeter}} $$</div>
                <ul>
                    <li><strong>Rectangular Duct ($W \times H$):</strong> $D_h = \frac{2WH}{W+H}$. Note: For a very wide, flat duct (infinite parallel plates), $D_h \approx 2H$.</li>
                    <li><strong>Annulus ($D_{outer}, D_{inner}$):</strong> Flowing between two tubes. $D_h = D_{outer} - D_{inner}$. This is counter-intuitive but mathematically derived for shear stress equivalence.</li>
                </ul>
                <p>Using $D_h$ allows us to use standard Moody Charts and friction equations for complex geometries with surprising accuracy.</p>
            </div>

            <!-- Insight 4: Head Loss & Energy -->
            <div class="insight-card">
                <h4><i class="fas fa-bolt"></i> 4. From Friction to Power: The Cost of Pumping</h4>
                <p>Friction factor alone is just a coefficient. To be useful, we convert it to <strong>Head Loss ($h_f$)</strong> using the Darcy-Weisbach equation:</p>
                <div class="formula">$$ h_f = f \cdot \frac{L}{D} \cdot \frac{v^2}{2g} $$</div>
                <p>This tells us how many meters of fluid column height are lost to friction. To replace this energy, we need a pump. The theoretical <strong>Hydraulic Power ($P_{hyd}$)</strong> required is:</p>
                <div class="formula">$$ P_{hyd} = \rho \cdot g \cdot Q \cdot h_f $$</div>
                <p>Where $Q$ is volumetric flow rate. This calculation is vital for sizing pumps. If you double the flow rate, velocity doubles, but Head Loss quadruples ($v^2$), and Power requirements increase by a factor of 8 ($Q \cdot h_f \propto v^3$)! This is why variable speed drives (VFDs) save so much energy.</p>
            </div>

            <!-- Insight 5: Boundary Layers -->
            <div class="insight-card">
                <h4><i class="fas fa-layer-group"></i> 5. The Laminar Sub-Layer</h4>
                <p>Even in highly turbulent flow, the fluid molecules touching the pipe wall have zero velocity (no-slip condition). There is a very thin layer near the wall that remains laminar, called the <strong>Laminar Sub-Layer</strong>.</p>
                <p>The interaction between this sub-layer and the pipe's roughness ($\varepsilon$) determines the friction behavior.
                <ul>
                    <li><strong>Hydraulically Smooth:</strong> If the roughness peaks are smaller than the sub-layer thickness, they are "buried" in the laminar stream and don't cause drag. Friction depends only on $Re$.</li>
                    <li><strong>Fully Rough:</strong> If the roughness peaks poke through the sub-layer into the turbulent core, they create form drag (eddies behind each bump). Friction becomes independent of $Re$ and depends only on roughness. This corresponds to the horizontal lines on the right side of the Moody Chart.</li>
                </ul>
                </p>
            </div>
        </div>
    </main>    <!-- FOOTER -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-col">
                    <h4>Design Calculators</h4>
                    <p style="font-size: 0.9rem; line-height: 1.6; margin-bottom: 15px;">If you find this tool helpful, please consider sharing it with your colleagues!</p>
                    <div class="social-buttons">
                        <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn linkedin" title="LinkedIn"><i class="fab fa-linkedin-in"></i></a>
                        <a href="https://www.youtube.com/@designcalculators" target="_blank" rel="noopener noreferrer" class="social-btn youtube" title="YouTube"><i class="fab fa-youtube"></i></a>
                        <a href="https://twitter.com/intent/tweet?url=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn twitter" title="Twitter"><i class="fab fa-twitter"></i></a>
                        <a href="https://www.facebook.com/sharer/sharer.php?u=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn facebook" title="Facebook"><i class="fab fa-facebook-f"></i></a>
                        <a href="https://api.whatsapp.com/send?text=Check%20out%20this%20amazing%20engineering%20resource%20https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn whatsapp" title="WhatsApp"><i class="fab fa-whatsapp"></i></a>
                    </div>
                </div>
                <div class="footer-col">
                    <h4>Quick Links</h4>
                    <ul>
                        <li><a href='/'>Home</a></li>
                        <li><a href="indexele">Electrical</a></li>
                        <li><a href="indexmech">Mechanical</a></li>
                        <li><a href="indexinst">Instrumentation</a></li>                        
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>Resources</h4>
                    <ul>
                        <li><a href="about">About Us</a></li>
                        <li><a href="contact">Contact</a></li>
                        <li><a href="faq">FAQ</a></li>
                        <li><a href="privacy-policy">Privacy Policy</a></li>
                        <li><a href="terms-of-service">Terms of Service</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>More</h4>
                    <ul>
                        <li><a href='/articles'>Articles & Whitepapers</a></li>
                        <li><a href='/sitemap2'>Sitemap</a></li>                        
                    </ul>
                </div>
            </div>
            <div class="footer-disclaimer">
                <p>This tool offers general guidance. Results should be reviewed for accuracy and compliance with relevant project standards and regulations before use.</p>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Design Calculators. Created by <span style="color: var(--secondary); font-weight: bold;">A Sharma</span>. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        // Global State
        let moodyChart = null;
        let lastResult = null;

        // Fluid Data (Density kg/m3, Viscosity cP)
        const fluidDB = {
            'water': { rho: 998, mu: 1.002, name: 'Water (20°C)' },
            'air': { rho: 1.204, mu: 0.018, name: 'Air (20°C)' },
            'oil_light': { rho: 850, mu: 20, name: 'Light Oil' },
            'oil_heavy': { rho: 950, mu: 500, name: 'Heavy Crude' },
            'steam': { rho: 5.1, mu: 0.013, name: 'Sat. Steam (10 bar)' }
        };

        function updateFluid() {
            const type = document.getElementById('fluid-type').value;
            if(type !== 'custom') {
                document.getElementById('density').value = fluidDB[type].rho;
                document.getElementById('viscosity').value = fluidDB[type].mu;
            }
        }

        function toggleGeometry() {
            const geo = document.getElementById('geo-type').value;
            document.getElementById('geo-pipe').classList.add('hidden');
            document.getElementById('geo-rect').classList.add('hidden');
            document.getElementById('geo-annulus').classList.add('hidden');

            if(geo === 'pipe') document.getElementById('geo-pipe').classList.remove('hidden');
            else if(geo === 'rect') document.getElementById('geo-rect').classList.remove('hidden');
            else if(geo === 'annulus') document.getElementById('geo-annulus').classList.remove('hidden');
        }

        function toggleFlowInput() {
            // Logic handled in calculation
        }

        function loadPreset(type) {
            if (type === 'water_turb') {
                document.getElementById('fluid-type').value = 'water';
                updateFluid();
                document.getElementById('geo-type').value = 'pipe';
                toggleGeometry();
                document.getElementById('pipe-dia').value = '100';
                document.getElementById('flow-type').value = 'velocity';
                document.getElementById('flow-val').value = '2.5';
                document.getElementById('roughness').value = '0.045';
                document.getElementById('pipe-len').value = '50';
            } else if (type === 'oil_lam') {
                document.getElementById('fluid-type').value = 'oil_heavy';
                updateFluid();
                document.getElementById('geo-type').value = 'pipe';
                toggleGeometry();
                document.getElementById('pipe-dia').value = '150';
                document.getElementById('flow-type').value = 'velocity';
                document.getElementById('flow-val').value = '0.5';
                document.getElementById('pipe-len').value = '100';
            } else if (type === 'duct_air') {
                document.getElementById('fluid-type').value = 'air';
                updateFluid();
                document.getElementById('geo-type').value = 'rect';
                toggleGeometry();
                document.getElementById('rect-w').value = '400';
                document.getElementById('rect-h').value = '250';
                document.getElementById('flow-type').value = 'velocity';
                document.getElementById('flow-val').value = '5.0';
                document.getElementById('roughness').value = '0.15'; 
                document.getElementById('pipe-len').value = '30';
            }
            displayMessage(`${type.toUpperCase()} scenario loaded.`, "success");
        }

        function displayMessage(message, type = "info") {
            let messageBox = document.getElementById('message-box');
            messageBox.textContent = message;
            if (type === "error") messageBox.style.backgroundColor = 'var(--danger)';
            else if (type === "success") messageBox.style.backgroundColor = 'var(--success)';
            else messageBox.style.backgroundColor = 'var(--primary)';
            messageBox.classList.add('show');
            setTimeout(() => messageBox.classList.remove('show'), 4000);
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Theme handling
            const themeSwitch = document.getElementById('theme-switch');
            if (themeSwitch && localStorage.getItem('theme') === 'dark') {
                document.body.classList.add('dark-mode');
                themeSwitch.checked = true;
            }
            if(themeSwitch) {
                themeSwitch.addEventListener('change', function() {
                    document.body.classList.toggle('dark-mode');
                    localStorage.setItem('theme', this.checked ? 'dark' : 'light');
                });
            }

            document.getElementById('calculate-btn').addEventListener('click', performCalculation);
            document.getElementById('pdf-btn').addEventListener('click', generatePDF);
        });

        // Colebrook-White Iterative Solver (Newton-Raphson)
        // 1/sqrt(f) = -2 log10( e/3.7D + 2.51/(Re * sqrt(f)) )
        function solveColebrook(Re, relRough) {
            // Initial guess using Swamee-Jain
            let f = 0.25 / Math.pow(Math.log10((relRough/3.7) + (5.74/Math.pow(Re, 0.9))), 2);
            
            // Newton-Raphson iteration
            // F(x) = x + 2*log10(A + B*x) = 0, where x = 1/sqrt(f)
            // A = relRough/3.7, B = 2.51/Re
            
            const A = relRough / 3.7;
            const B = 2.51 / Re;
            
            for(let i=0; i<10; i++) { // 10 iterations usually sufficient
                let x = 1.0 / Math.sqrt(f);
                let F = x + 2.0 * Math.log10(A + B * x);
                let F_prime = 1.0 + (2.0 / Math.log(10)) * (B / (A + B * x));
                
                let x_new = x - F / F_prime;
                if(Math.abs(x_new - x) < 0.000001) {
                    f = 1.0 / (x_new * x_new);
                    break;
                }
                f = 1.0 / (x_new * x_new);
            }
            return f;
        }

        function performCalculation() {
            // 1. Get Inputs
            const rho = parseFloat(document.getElementById('density').value);
            const mu_cP = parseFloat(document.getElementById('viscosity').value);
            const flowType = document.getElementById('flow-type').value;
            const flowVal = parseFloat(document.getElementById('flow-val').value);
            const geo = document.getElementById('geo-type').value;
            const eps_mm = parseFloat(document.getElementById('roughness').value);
            const L_m = parseFloat(document.getElementById('pipe-len').value);

            // Geometry Inputs
            const d_pipe_mm = parseFloat(document.getElementById('pipe-dia').value);
            const w_mm = parseFloat(document.getElementById('rect-w').value);
            const h_mm = parseFloat(document.getElementById('rect-h').value);
            const od_mm = parseFloat(document.getElementById('ann-od').value);
            const id_mm = parseFloat(document.getElementById('ann-id').value);

            if (isNaN(rho) || isNaN(mu_cP) || isNaN(flowVal)) {
                displayMessage("Please enter valid fluid properties and flow.", "error");
                return;
            }

            // 2. Geometry Engine (Calc Dh and Area)
            let Dh_mm = 0;
            let Area_m2 = 0;
            let geoText = "";

            if (geo === 'pipe') {
                Dh_mm = d_pipe_mm;
                const d_m = d_pipe_mm / 1000;
                Area_m2 = (Math.PI / 4) * Math.pow(d_m, 2);
                geoText = `Circular Pipe (ID: ${d_pipe_mm} mm)`;
            } else if (geo === 'rect') {
                Dh_mm = (2 * w_mm * h_mm) / (w_mm + h_mm);
                Area_m2 = (w_mm/1000) * (h_mm/1000);
                geoText = `Rectangular Duct (${w_mm}x${h_mm} mm)`;
            } else if (geo === 'annulus') {
                Dh_mm = od_mm - id_mm;
                const od_m = od_mm/1000;
                const id_m = id_mm/1000;
                Area_m2 = (Math.PI / 4) * (Math.pow(od_m, 2) - Math.pow(id_m, 2));
                geoText = `Annulus (OD: ${od_mm}, ID: ${id_mm})`;
            }

            const Dh_m = Dh_mm / 1000;

            // 3. Flow Engine (Convert to Velocity m/s)
            let v_ms = 0;
            let Q_m3s = 0;

            if (flowType === 'velocity') {
                v_ms = flowVal;
                Q_m3s = v_ms * Area_m2;
            } else if (flowType === 'vol_m3h') {
                Q_m3s = flowVal / 3600;
                v_ms = Q_m3s / Area_m2;
            } else if (flowType === 'mass_kgh') {
                const m_dot = flowVal / 3600;
                Q_m3s = m_dot / rho;
                v_ms = Q_m3s / Area_m2;
            }

            // 4. Reynolds Calculation
            const mu_SI = mu_cP * 0.001;
            const Re = (rho * v_ms * Dh_m) / mu_SI;

            // 5. Friction Factor (Newton-Raphson Colebrook)
            let f = 0;
            let regime = "";
            let f_formula = "";
            let rel_rough = 0;

            if (Re < 2300) {
                regime = "Laminar";
                f = 64 / Re;
                f_formula = "Poiseuille Law (f = 64 / Re)";
            } else if (Re < 4000) {
                regime = "Transient";
                // Interpolation for transition zone
                const f_lam = 64 / 2300;
                rel_rough = (eps_mm / 1000) / Dh_m;
                const f_turb_4000 = solveColebrook(4000, rel_rough);
                const ratio = (Re - 2300) / (4000 - 2300);
                f = f_lam + ratio * (f_turb_4000 - f_lam);
                f_formula = "Transition Interpolation";
            } else {
                regime = "Turbulent";
                rel_rough = (eps_mm / 1000) / Dh_m;
                // Use iterative solver
                f = solveColebrook(Re, rel_rough);
                f_formula = "Colebrook-White (Iterative)";
            }

            // 6. Hydraulic Energy (Head & Power)
            // Head Loss (Darcy-Weisbach) hf = f * (L/D) * (v^2 / 2g)
            const g = 9.81;
            const hf_m = f * (L_m / Dh_m) * (Math.pow(v_ms, 2) / (2 * g));
            
            // Pressure Drop dP = rho * g * hf
            const dP_Pa = rho * g * hf_m;
            const dP_bar = dP_Pa / 100000;

            // Hydraulic Power P = rho * g * Q * hf = Q * dP
            const P_watts = Q_m3s * dP_Pa;

            lastResult = { Re, v_ms, Dh_mm, regime, f, dP_Pa, dP_bar, hf_m, P_watts, rho, mu_SI, geoText, flowVal, flowType, L_m, rel_rough, Area_m2 };

            // 7. Render Step-by-Step (Detailed)
            let html = `<h4>Step 1: Geometry & Velocity Conversion</h4>`;
            html += `<div class="calculation-step">`;
            html += `<strong>Geometry:</strong> ${geoText}.<br>`;
            html += `$$ D_h = \\mathbf{${Dh_mm.toFixed(1)} \\text{ mm}} = ${Dh_m.toFixed(4)} \\text{ m} $$<br>`;
            html += `$$ \\text{Flow Area} = ${Area_m2.toExponential(4)} \\text{ m}^2 $$<br>`;
            html += `<strong>Flow Conversion:</strong><br>`;
            if (flowType !== 'velocity') {
                html += `$$ Q = ${Q_m3s.toExponential(4)} \\text{ m}^3/\\text{s} $$<br>`;
                html += `$$ v = Q / A = \\mathbf{${v_ms.toFixed(2)} \\text{ m/s}} $$`;
            } else {
                html += `$$ v = \\mathbf{${v_ms.toFixed(2)} \\text{ m/s}} $$ (Direct Input)`;
            }
            html += `</div>`;

            html += `<h4>Step 2: Reynolds Number ($Re$)</h4>`;
            html += `<div class="calculation-step">`;
            html += `$$ \\mu = ${mu_cP} \\text{ cP} = ${mu_SI} \\text{ Pa}\\cdot\\text{s} $$<br>`;
            html += `$$ Re = \\frac{\\rho v D_h}{\\mu} = \\frac{${rho} \\cdot ${v_ms.toFixed(2)} \\cdot ${Dh_m.toFixed(4)}}{${mu_SI}} $$<br>`;
            html += `$$ Re = \\mathbf{${Re.toExponential(3)}} $$<br>`;
            html += `<strong>Regime: ${regime.toUpperCase()}</strong>`;
            html += `</div>`;

            html += `<h4>Step 3: Friction Factor ($f$)</h4>`;
            html += `<div class="calculation-step">`;
            if (Re > 4000) {
                html += `Relative Roughness $\\epsilon/D = ${(eps_mm/1000).toExponential(4)} / ${Dh_m.toFixed(4)} = ${rel_rough.toExponential(4)}$<br>`;
                html += `Solving Colebrook-White iteratively:<br>`;
                html += `$$ \\frac{1}{\\sqrt{f}} = -2 \\log_{10} \\left( \\frac{\\epsilon/D}{3.7} + \\frac{2.51}{Re \\sqrt{f}} \\right) $$<br>`;
            }
            html += `$$ f = \\mathbf{${f.toFixed(5)}} \\quad (${f_formula}) $$`;
            html += `</div>`;

            html += `<h4>Step 4: Hydraulic Energy Loss</h4>`;
            html += `<div class="calculation-step">`;
            html += `<strong>Head Loss (Darcy):</strong><br>`;
            html += `$$ h_f = f \\frac{L}{D} \\frac{v^2}{2g} = ${f.toFixed(5)} \\cdot \\frac{${L_m}}{${Dh_m.toFixed(4)}} \\cdot \\frac{${v_ms.toFixed(2)}^2}{2\\cdot 9.81} = \\mathbf{${hf_m.toFixed(2)} \\text{ m}} $$<br>`;
            html += `<strong>Total Pressure Drop:</strong><br>`;
            html += `$$ \\Delta P = \\rho g h_f = \\mathbf{${dP_bar.toFixed(3)} \\text{ bar}} $$<br>`;
            html += `<strong>Hydraulic Power:</strong><br>`;
            html += `$$ P_{hyd} = Q \\cdot \\Delta P = \\mathbf{${P_watts.toFixed(1)} \\text{ Watts}} $$`;
            html += `</div>`;

            document.getElementById('calculation-details').innerHTML = html;

            // 8. Update Table
            const tbody = document.getElementById('result-table-body');
            tbody.innerHTML = '';
            
            let regColor = '';
            if(regime === 'Laminar') regColor = '#10B981';
            else if(regime === 'Turbulent') regColor = '#3B82F6';
            else regColor = '#F59E0B';

            const addRow = (n, v, u, c="") => {
                tbody.innerHTML += `<tr style="${c ? 'color:'+c : ''}"><td><strong>${n}</strong></td><td>${v}</td><td>${u}</td></tr>`;
            };

            addRow("Reynolds Number", Re.toLocaleString(undefined, {maximumFractionDigits:0}), "-", regColor);
            addRow("Flow Regime", regime, "-", regColor);
            addRow("Friction Factor (f)", f.toFixed(5), "Darcy");
            addRow("Head Loss", hf_m.toFixed(2), "m fluid");
            addRow("Pressure Drop", dP_bar.toFixed(3), "bar");
            addRow("Pump Power (Theoretical)", P_watts.toFixed(1), "Watts");

            const interpEl = document.getElementById('interpretation-text');
            interpEl.innerHTML = `<span style="color:${regColor}; font-weight:bold;">${regime} Flow.</span> ${Re > 4000 ? "High turbulence energy loss." : "Viscosity dominated."}`;

            // Update Animation Speed
            updateAnimation(Re);

            // 9. Draw Chart
            drawChart(Re, f);

            // 10. Show
            document.getElementById('result-container').classList.remove('hidden');
            if(window.MathJax) window.MathJax.typesetPromise([document.getElementById('calculation-details')]);
            document.getElementById('result-container').scrollIntoView({ behavior: 'smooth' });
        }

        function updateAnimation(Re) {
            const container = document.getElementById('flow-visual-container');
            container.innerHTML = ''; // Clear
            
            // Speed factor
            let duration = '2s';
            let turbulence = false;
            let count = 10;

            if(Re < 2300) {
                duration = '4s'; // Slow laminar
                count = 5;
            } else if (Re > 4000) {
                duration = '0.8s'; // Fast turbulent
                turbulence = true;
                count = 20;
            } else {
                duration = '1.5s';
            }

            for(let i=0; i<count; i++) {
                const p = document.createElement('div');
                p.className = 'flow-particle';
                p.style.animationDuration = duration;
                p.style.animationDelay = (Math.random() * 2) + 's';
                
                // Laminar: Organized lines. Turbulent: Random Y
                let topPos = 50;
                if(turbulence) {
                    topPos = Math.random() * 100;
                } else {
                    // Parabolic profile approx (fastest in middle)
                    // Visual trick: just scatter slightly
                     topPos = 10 + Math.random() * 80;
                }
                p.style.top = topPos + '%';
                
                container.appendChild(p);
            }
        }

        function drawChart(Re_point, f_point) {
            const ctx = document.getElementById('moodyChart').getContext('2d');
            if (moodyChart) moodyChart.destroy();

            // Generate Curves
            const lamData = [];
            for(let i=100; i<=2300; i+=100) {
                lamData.push({x: i, y: 64/i});
            }

            const turbData = [];
            for(let i=4000; i<=10000000; i*=1.5) {
                // Smooth pipe approximation f = 0.316 / Re^0.25 (Blasius)
                // Better: simple Swamee Jain with eps=0
                const f_turb = 0.25 / Math.pow(Math.log10(5.74/Math.pow(i, 0.9)), 2);
                turbData.push({x: i, y: f_turb});
            }

            moodyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'Laminar (64/Re)',
                            data: lamData,
                            borderColor: '#10B981',
                            borderWidth: 2,
                            pointRadius: 0
                        },
                        {
                            label: 'Turbulent (Smooth Pipe)',
                            data: turbData,
                            borderColor: '#3B82F6',
                            borderWidth: 2,
                            pointRadius: 0
                        },
                        {
                            label: 'Operating Point',
                            data: [{x: Re_point, y: f_point}],
                            backgroundColor: '#EF4444',
                            borderColor: '#EF4444',
                            pointRadius: 8,
                            type: 'scatter'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { 
                            type: 'logarithmic', 
                            title: { display: true, text: 'Reynolds Number (Re)' },
                            min: 100, max: 10000000 
                        },
                        y: { 
                            title: { display: true, text: 'Friction Factor (f)' },
                            // min: 0.008, max: 0.1 
                        }
                    }
                }
            });
        }

        function generatePDF() {
            if (!lastResult) {
                displayMessage("Calculate first.", "error");
                return;
            }
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            let y = 15;

            pdf.setFont('helvetica', 'bold');
            pdf.setFontSize(16);
            pdf.setTextColor(30, 58, 138); 
            pdf.text('Fluid Dynamics Analysis Report', 105, y, { align: 'center' });
            y += 10;

            pdf.setFontSize(10);
            pdf.setTextColor(100);
            pdf.text(`Date: ${new Date().toLocaleString()}`, 105, y, { align: 'center' });
            y += 15;

            // Inputs
            pdf.setFontSize(12);
            pdf.setTextColor(0);
            pdf.text('1. Process Data', 14, y);
            y += 5;

            const inputData = [
                ['Geometry', lastResult.geoText],
                ['Hydraulic Dia', `${lastResult.Dh_mm.toFixed(1)} mm`],
                ['Flow Rate', `${lastResult.flowVal} (${lastResult.flowType})`],
                ['Pipe Length', `${lastResult.L_m} m`],
                ['Density', `${lastResult.rho} kg/m³`],
                ['Viscosity', `${(lastResult.mu_SI*1000).toFixed(3)} cP`]
            ];

            pdf.autoTable({
                startY: y,
                head: [['Parameter', 'Value']],
                body: inputData,
                margin: { left: 14, right: 14 },
                theme: 'grid',
                headStyles: { fillColor: [30, 58, 138] }
            });
            y = pdf.lastAutoTable.finalY + 15;

            // Results
            pdf.text('2. Calculations', 14, y);
            y += 5;

            const resData = [
                ['Reynolds Number', lastResult.Re.toExponential(3)],
                ['Regime', lastResult.regime],
                ['Velocity', `${lastResult.v_ms.toFixed(2)} m/s`],
                ['Friction Factor (f)', lastResult.f.toFixed(5)],
                ['Head Loss', `${lastResult.hf_m.toFixed(2)} m`],
                ['Total Pressure Drop', `${lastResult.dP_bar.toFixed(3)} bar`],
                ['Hydraulic Power', `${lastResult.P_watts.toFixed(1)} W`]
            ];

            pdf.autoTable({
                startY: y,
                head: [['Metric', 'Result']],
                body: resData,
                margin: { left: 14, right: 14 },
                theme: 'grid',
                headStyles: { fillColor: [30, 58, 138] },
                didParseCell: function(data) {
                    if(data.row.index === 0) {
                        data.cell.styles.fontStyle = 'bold';
                    }
                }
            });

            // Footer
            y = pdf.lastAutoTable.finalY + 20;
            pdf.setFontSize(8);
            pdf.setTextColor(150);
            pdf.text('Calculated using Newton-Raphson iteration on Colebrook-White equation.', 105, y, { align: 'center' });

            pdf.save('Reynolds_Report.pdf');
            displayMessage("PDF Downloaded", "success");
        }

        function displayMessage(message, type = "info") {
            let messageBox = document.getElementById('message-box');
            messageBox.textContent = message;
            if (type === "error") messageBox.style.backgroundColor = 'var(--danger)';
            else if (type === "success") messageBox.style.backgroundColor = 'var(--success)';
            else messageBox.style.backgroundColor = 'var(--primary)';
            messageBox.classList.add('show');
            setTimeout(() => messageBox.classList.remove('show'), 4000);
        }
    </script>
</body>
</html>
