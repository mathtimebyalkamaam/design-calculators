<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Harmonic Distortion Calculator - Design Calculators - Electrical</title>
    <!-- SEO Meta Tags -->
    <meta name="description" content="Advanced harmonic distortion calculator. Calculates THD, TDD, and evaluates against IEEE 519 standards for industrial power quality.">
    <meta name="keywords" content="harmonic distortion, thd calculator, tdd calculator, ieee 519, power quality, harmonic filter, electrical engineering">
    <meta name="author" content="Design Calculators">
    <meta name="robots" content="index, follow">
    <!-- AdSense & Analytics -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5936527763614780" crossorigin="anonymous"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-23Y1V450SR"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-23Y1V450SR');
    </script>
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Montserrat:wght@700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- MathJax for Formulas -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['\\(', '\\)'], ['$', '$']],
                displayMath: [['\\[', '\\]'], ['$$', '$$']]
            },
            svg: { fontCache: 'global' },
            options: {
                processHtmlClass: 'math-content', // Process elements with this class
                ignoreHtmlClass: 'no-mathjax'     // Ignore elements with this class
            }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <!-- PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>
    <!-- D3.js for charts -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <style>
        :root {
            --primary: #1E3A8A;
            --secondary: #2563EB;
            --accent: #F59E0B;
            --success: #10B981;
            --danger: #DC2626;
            --warning: #F59E0B;
            --bg: #F8FAFC;
            --card: #FFFFFF;
            --text: #4B5563;
            --heading: #111827;
            --footer-bg: #0F172A;
            --border: #E2E8F0;
            --grad: linear-gradient(135deg, var(--primary), var(--secondary));
            --grad-dark: linear-gradient(135deg, #0F172A, #1E293B);
            --shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        body.dark-mode {
            --primary: #10B981;
            --secondary: #34D399;
            --bg: #0F172A;
            --card: #1E293B;
            --text: #CBD5E1;
            --heading: #F1F5F9;
            --footer-bg: #020617;
            --border: #334155;
        }

        * { box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.7;
            margin: 0;
            padding: 0;
        }

        .container { max-width: 1280px; margin: 0 auto; padding: 0 24px; }

        /* Header & Nav */
        header {
            background: var(--grad);
            color: white;
            padding: 24px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo-container {
            display: flex;
            flex-direction: column;
            text-decoration: none;
            color: white;
        }
        .logo-text {
            font-size: 1.75rem;
            font-weight: 800;
            font-family: 'Montserrat', sans-serif;
        }
        .logo-subtitle {
            font-size: 0.8rem;
            margin: 4px 0 0 0;
            color: #E0E7FF;
            opacity: 0.9;
        }
        .nav-links {
            display: flex;
            gap: 24px;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        .nav-links a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }
        .nav-links a:hover { color: var(--accent); }
        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .switch {
            position: relative;
            width: 56px;
            height: 30px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.2);
            transition: .4s;
            border-radius: 30px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--accent);
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        /* Main Content & Cards */
        main { padding: 40px 0; }
        .card {
            background: var(--card);
            border-radius: 12px;
            padding: 30px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            border: 1px solid var(--border);
        }
        h2 {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
            padding-bottom: 15px;
            margin-top: 0;
            font-family: 'Montserrat', sans-serif;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        h3 {
            color: var(--heading);
            font-family: 'Montserrat', sans-serif;
            font-size: 1.5rem;
            margin-top: 25px;
            margin-bottom: 20px;
        }
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--heading);
        }
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 6px;
            background-color: var(--bg);
            color: var(--text);
            font-size: 1rem;
        }
        .form-group input:focus,
        .form-group select:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
        }
        body.dark-mode .form-group input:focus {
             box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }
        
        .btn {
            background: var(--grad);
            color: white;
            border: none;
            padding: 16px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(30, 58, 138, 0.3);
            transition: all 0.3s;
            width: 100%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(30, 58, 138, 0.4);
        }
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .btn-group .btn {
            flex: 1;
            min-width: 150px;
        }
        .btn.secondary {
            background: var(--secondary);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }
        .btn.accent {
            background: var(--accent);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }
        .btn.danger {
            background: var(--danger);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
        }
        .btn.danger:hover {
            background: #B91C1C; /* Darker red */
            box-shadow: 0 8px 20px rgba(220, 38, 38, 0.4);
        }

        /* Results */
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-radius: 8px;
            overflow: hidden;
        }
        .results-table th,
        .results-table td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        .results-table th {
            background: var(--grad);
            color: white;
            font-weight: 700;
        }
        .results-table tr:nth-child(even) {
            background-color: var(--bg);
        }
        .results-table td:first-child {
            font-weight: 600;
            color: var(--heading);
        }
        .results-table .highlight {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--success);
        }
        .results-table .highlight.fail {
            color: var(--danger);
        }

        /* Educational Section */
        .education-section {
            margin-top: 60px;
        }
        .insight-card {
            background: linear-gradient(135deg, var(--card), rgba(37,99,235,0.03));
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            border-left: 5px solid var(--secondary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: all 0.3s;
        }
        .insight-card:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .insight-card h4 {
            color: var(--secondary);
            font-size: 1.3rem;
            margin: 0 0 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .insight-card h4 i {
            font-size: 1.5rem;
        }
        .insight-card p {
            margin: 10px 0;
            line-height: 1.8;
        }
        .insight-card ul {
            padding-left: 20px;
            margin: 10px 0;
        }
        .insight-card li {
            margin-bottom: 10px;
        }

        /* Message Box */
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 16px 28px;
            border-radius: 8px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.25);
            z-index: 10000;
            font-weight: 600;
            color: white;
            opacity: 0;
            transition: all 0.4s;
            display: none;
        }
        .message-box.show {
            display: block;
            opacity: 1;
            top: 30px;
        }

        /* Footer */
        footer {
            background: var(--grad-dark);
            color: #CBD5E1;
            padding: 50px 0 20px 0;
            margin-top: 60px;
        }
        .footer-content {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 40px;
            margin-bottom: 30px;
        }
        .footer-col {
            flex: 1;
            min-width: 200px;
        }
        .footer-col h4 {
            color: white;
            margin-bottom: 15px;
            font-weight: 700;
        }
        .footer-col ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .footer-col a {
            color: #CBD5E1;
            text-decoration: none;
            transition: color 0.3s;
        }
        .footer-col a:hover {
            color: var(--accent);
        }
        .social-buttons {
            display: flex;
            gap: 12px;
            margin-top: 15px;
        }
        .social-btn {
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            border-radius: 50%;
            font-size: 1.1rem;
            transition: transform 0.3s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .social-btn:hover {
            transform: translateY(-4px);
        }
        .social-btn.linkedin { background-color: #0A66C2; }
        .social-btn.youtube { background-color: #FF0000; }
        .social-btn.twitter { background-color: #1DA1F2; }
        .social-btn.facebook { background-color: #1877F2; }
        .social-btn.whatsapp { background-color: #25D366; }
        .footer-disclaimer {
            text-align: center;
            padding-top: 25px;
            border-top: 1px solid #334155;
            max-width: 800px;
            margin: 0 auto;
            font-size: 0.9rem;
        }
        .footer-bottom {
            text-align: center;
            padding-top: 20px;
            font-size: 0.9rem;
            color: #94A3B8;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container { padding: 0 15px; }
            .navbar { flex-direction: column; gap: 20px; }
            .nav-links { flex-direction: column; gap: 12px; text-align: center; }
            .form-row { grid-template-columns: 1fr; }
            .card { padding: 20px; }
            .footer-content { flex-direction: column; gap: 25px; }
            .btn-group { flex-direction: column; }
        }
        .hidden { display: none; }
        
        /* Styles from old file to be merged */
        .harmonic-input-row {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            margin-bottom: 15px;
            opacity: 0; /* For animation */
            transform: translateY(20px); /* For animation */
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }
        .harmonic-input-row.show {
            opacity: 1;
            transform: translateY(0);
        }
        .harmonic-input-row .form-group {
            flex: 1;
            margin-bottom: 0; /* Adjust margin for row alignment */
        }
        
        .info-icon {
            color: var(--primary);
            margin-left: 5px;
            cursor: help;
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        /* Loading Spinner */
        .loading-spinner {
            display: none; /* Hidden by default */
            border: 4px solid var(--border);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Chart Styles */
        .bar {
            fill: var(--primary);
            transition: fill 0.3s ease-in-out;
        }
        .bar:hover {
            fill: var(--secondary);
        }
        .chart-text {
            fill: var(--text);
            font-size: 10px;
        }
        
        /* Compliance text styling */
        .compliance-fail {
            color: var(--danger);
            font-weight: 700;
        }
        .compliance-pass {
            color: var(--success);
            font-weight: 700;
        }

    </style>
</head>
<body>
    <div id="message-box" class="message-box"></div>

    <header>
        <div class="container">
            <nav class="navbar">
                <a href="index.html" class="logo-container">
                    <span class="logo-text">Design Calculators</span>
                    <p class="logo-subtitle">Inspired by standards such as IEC, IEEE, ISA, ASME, and API.</p>
                </a>
                <ul class="nav-links">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="articles">Articles</a></li>
                    <li><a href="indexmech">Mechanical</a></li>
                    <li><a href="indexele">Electrical</a></li>
                    <li><a href="indexinst">Instrumentation</a></li>
                </ul>
                <div class="theme-toggle">
                    <i class="fas fa-sun"></i>
                    <label class="switch">
                        <input type="checkbox" id="theme-switch">
                        <span class="slider"></span>
                    </label>
                    <i class="fas fa-moon"></i>
                </div>
            </nav>
        </div>
    </header>

    <main class="container">
        <div class="card">
            <h2><i class="fas fa-wave-square"></i> Advanced Harmonic Distortion Calculator</h2>
            
            <p>This calculator estimates the Total Harmonic Distortion (THD) for both current and voltage, along with Individual Harmonic Distortion (IHD/VHD), based on user-defined harmonic orders and magnitudes. This is crucial for power quality assessment in accordance with international standards like <strong>IEEE 519</strong> and <strong>IEC 61000 series</strong>. It also provides a visual representation of the harmonic spectrum.</p>
            
            <div class="calculator-form">
                <form id="harmonic-distortion-form">
                    <h3>System & Load Parameters</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="fundamental-current">Fundamental Current (I1) (A) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The RMS current at the fundamental frequency (e.g., 50 Hz or 60 Hz).</span></span></label>
                            <input type="number" id="fundamental-current" min="0.01" step="0.01" value="100" required>
                        </div>
                        <div class="form-group">
                            <label for="fundamental-voltage">Fundamental Voltage (V1) (V) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The RMS voltage at the fundamental frequency.</span></span></label>
                            <input type="number" id="fundamental-voltage" min="0.01" step="0.01" value="240" required>
                        </div>
                    </div>
                    
                    <h3>Individual Harmonic Components (Current)</h3>
                    <div id="current-harmonics-container">
                        <!-- Dynamic current harmonic inputs will be appended here -->
                        <div class="harmonic-input-row show">
                            <div class="form-group">
                                <label>Order (h)</label>
                                <input type="number" class="harmonic-order-current" min="2" step="1" value="3" required>
                            </div>
                            <div class="form-group">
                                <label>Magnitude (Ih) (A)</label>
                                <input type="number" class="harmonic-magnitude-current" min="0" step="0.01" value="10" required>
                            </div>
                            <button type="button" class="remove-harmonic-btn btn danger" style="padding: 12px; margin-bottom: 0; align-self: center;"><i class="fas fa-trash-alt"></i></button>
                        </div>
                        <div class="harmonic-input-row show">
                            <div class="form-group">
                                <label>Order (h)</label>
                                <input type="number" class="harmonic-order-current" min="2" step="1" value="5" required>
                            </div>
                            <div class="form-group">
                                <label>Magnitude (Ih) (A)</label>
                                <input type="number" class="harmonic-magnitude-current" min="0" step="0.01" value="7" required>
                            </div>
                            <button type="button" class="remove-harmonic-btn btn danger" style="padding: 12px; margin-bottom: 0; align-self: center;"><i class="fas fa-trash-alt"></i></button>
                        </div>
                        <div class="harmonic-input-row show">
                            <div class="form-group">
                                <label>Order (h)</label>
                                <input type="number" class="harmonic-order-current" min="2" step="1" value="7" required>
                            </div>
                            <div class="form-group">
                                <label>Magnitude (Ih) (A)</label>
                                <input type="number" class="harmonic-magnitude-current" min="0" step="0.01" value="5" required>
                            </div>
                            <button type="button" class="remove-harmonic-btn btn danger" style="padding: 12px; margin-bottom: 0; align-self: center;"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>
                    <div class="btn-group" style="margin-top: 10px; justify-content: flex-start;">
                        <button type="button" id="add-current-harmonic-btn" class="btn secondary" style="flex: 0 1 auto; font-size: 1rem; padding: 10px 15px;"><i class="fas fa-plus"></i> Add Current Harmonic</button>
                    </div>

                    <h3 style="margin-top: 30px;">Individual Harmonic Components (Voltage)</h3>
                    <div id="voltage-harmonics-container">
                        <!-- Dynamic voltage harmonic inputs will be appended here -->
                        <div class="harmonic-input-row show">
                            <div class="form-group">
                                <label>Order (h)</label>
                                <input type="number" class="harmonic-order-voltage" min="2" step="1" value="3" required>
                            </div>
                            <div class="form-group">
                                <label>Magnitude (Vh) (V)</label>
                                <input type="number" class="harmonic-magnitude-voltage" min="0" step="0.01" value="5" required>
                            </div>
                            <button type="button" class="remove-harmonic-btn btn danger" style="padding: 12px; margin-bottom: 0; align-self: center;"><i class="fas fa-trash-alt"></i></button>
                        </div>
                        <div class="harmonic-input-row show">
                            <div class="form-group">
                                <label>Order (h)</label>
                                <input type="number" class="harmonic-order-voltage" min="2" step="1" value="5" required>
                            </div>
                            <div class="form-group">
                                <label>Magnitude (Vh) (V)</label>
                                <input type="number" class="harmonic-magnitude-voltage" min="0" step="0.01" value="3" required>
                            </div>
                            <button type="button" class="remove-harmonic-btn btn danger" style="padding: 12px; margin-bottom: 0; align-self: center;"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>
                    <div class="btn-group" style="margin-top: 10px; justify-content: flex-start;">
                        <button type="button" id="add-voltage-harmonic-btn" class="btn secondary" style="flex: 0 1 auto; font-size: 1rem; padding: 10px 15px;"><i class="fas fa-plus"></i> Add Voltage Harmonic</button>
                    </div>

                    <h3 style="margin-top: 30px;">IEEE 519 Standard Compliance Data</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="pcc-short-circuit-current">PCC Short Circuit Current ($I_{SC}$) (kA) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The maximum available symmetrical short-circuit current at the Point of Common Coupling (PCC). Usually in kiloamperes (kA).</span></span></label>
                            <input type="number" id="pcc-short-circuit-current" min="0.1" step="0.1" value="10" required>
                        </div>
                        <div class="form-group">
                            <label for="max-demand-load-current">Maximum Demand Load Current ($I_L$) (A) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The maximum demand load current at the PCC, for 15 or 30 minute average.</span></span></label>
                            <input type="number" id="max-demand-load-current" min="1" step="1" value="100" required>
                        </div>
                    </div>
                    
                    <button type="button" id="calculate-harmonic-btn" class="btn" style="margin-top: 25px;">Calculate Harmonic Distortion</button>
                    <div id="loading-spinner" class="loading-spinner"></div>
                </form>
            </div>
        </div>

        <!-- RESULTS TABLE -->
        <div id="results-section" class="card hidden" style="margin-top: 40px;">
            <h3><i class="fas fa-clipboard-check"></i> Calculation Summary</h3>
            <table class="results-table">
                <thead>
                    <tr>
                        <th>Parameter</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody id="results-tbody">
                    <!-- Results will be dynamically inserted here -->
                </tbody>
            </table>
        </div>

        <!-- Detailed calculations section -->
        <div id="detailed-steps" class="card hidden math-content">
            <h3><i class="fas fa-calculator"></i> Detailed Calculation Steps</h3>
            <div id="detailed-calculations-content">
                <!-- Detailed calculation steps will be dynamically inserted here -->
            </div>
        </div>

        <!-- Harmonic Spectrum Chart -->
        <div id="chart-card" class="card hidden">
            <h3><i class="fas fa-chart-bar"></i> Harmonic Spectrum Visualization</h3>
            <svg id="harmonic-bar-chart"></svg>
        </div>

        <!-- EDUCATIONAL INSIGHTS SECTION -->
        <div id="education-section" class="education-section card hidden">
            <h2><i class="fas fa-lightbulb"></i> Harmonic Mitigation & Standards</h2>

            <div class="insight-card">
                <h4><i class="fas fa-tools"></i> Tips for Reducing Harmonic Distortion</h4>
                <p>High levels of harmonic distortion can lead to increased energy losses, equipment overheating, premature aging of insulation, and interference with sensitive electronic devices. Here are some effective strategies to mitigate harmonics:</p>
                <ul>
                    <li>
                        <strong>Passive Harmonic Filters:</strong> These are combinations of inductors (reactors) and capacitors tuned to resonate at specific harmonic frequencies, providing a low-impedance path for harmonic currents, diverting them from the supply.
                    </li>
                    <li>
                        <strong>Active Harmonic Filters (AHF):</strong> These are advanced electronic devices that inject compensating currents into the system to cancel out harmonic currents generated by loads. AHFs are more flexible and can adapt to varying load conditions.
                    </li>
                    <li>
                        <strong>Line Reactors/Chokes:</strong> Installing line reactors (inductors) in series with non-linear loads (like VFDs) helps to increase the impedance, thereby reducing the amount of harmonic current drawn from the supply.
                    </li>
                    <li>
                        <strong>Multi-Pulse Rectifiers (e.g., 12-pulse, 18-pulse):</strong> For large VFDs, using rectifiers with a higher number of pulses significantly reduces characteristic harmonics (like 5th and 7th).
                    </li>
                    <li>
                        <strong>K-Rated Transformers:</strong> These are specially designed to handle harmonic currents without excessive heating, improving reliability and efficiency.
                    </li>
                </ul>
                <p style="margin-top: 15px; font-style: italic;">The choice of mitigation strategy depends on the magnitude of harmonics, the sensitivity of equipment, and economic considerations. A detailed power quality study is recommended.</p>
            </div>
            
            <div class="insight-card">
                <h4><i class="fas fa-book"></i> Standard References</h4>
                <p>Harmonic analysis and limits are typically addressed by standards such as:</p>
                <ul>
                    <li><strong>IEEE 519:</strong> Recommended Practices and Requirements for Harmonic Control in Electric Power Systems.</li>
                    <li><strong>IEC 61000 series:</strong> Electromagnetic Compatibility (EMC), particularly IEC 61000-3-2 and IEC 61000-3-12.</li>
                </ul>
            </div>
        </div>

    </main>

    <!-- FOOTER -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-col">
                    <h4>Design Calculators</h4>
                    <p style="font-size: 0.9rem; line-height: 1.6; margin-bottom: 15px;">If you find this tool helpful, please consider sharing it with your colleagues!</p>
                    <div class="social-buttons">
                        <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn linkedin" title="LinkedIn"><i class="fab fa-linkedin-in"></i></a>
                        <a href="https://www.youtube.com/@designcalculators" target="_blank" rel="noopener noreferrer" class="social-btn youtube" title="YouTube"><i class="fab fa-youtube"></i></a>
                        <a href="https://twitter.com/intent/tweet?url=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn twitter" title="Twitter"><i class="fab fa-twitter"></i></a>
                        <a href="https://www.facebook.com/sharer/sharer.php?u=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn facebook" title="Facebook"><i class="fab fa-facebook-f"></i></a>
                        <a href="https://api.whatsapp.com/send?text=Check%20out%20this%20amazing%20engineering%20resource%20https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn whatsapp" title="WhatsApp"><i class="fab fa-whatsapp"></i></a>
                    </div>
                </div>
                <div class="footer-col">
                    <h4>Quick Links</h4>
                    <ul>
                        <li><a href="index.html">Home</a></li>
                        <li><a href="indexele">Electrical</a></li>
                        <li><a href="indexmech">Mechanical</a></li>
                        <li><a href="indexinst">Instrumentation</a></li>
                        <li><a href="articles">Articles</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>Resources</h4>
                    <ul>
                        <li><a href="about">About Us</a></li>
                        <li><a href="contact">Contact</a></li>
                        <li><a href="faq">FAQ</a></li>
                        <li><a href="privacy-policy">Privacy Policy</a></li>
                        <li><a href="terms-of-service">Terms of Service</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>More</h4>
                    <ul>
                        <li><a href="articles.html">Articles & Whitepapers</a></li>
                        <li><a href="sitemap.html">Sitemap</a></li>
                        <li><a href="https://www.youtube.com/@designcalculators" target="_blank" rel="noopener noreferrer">YouTube Channel</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-disclaimer">
                <p>All calculations are for preliminary engineering design guidance. Final harmonic filter installation must comply with IEEE 519, IEC 61000, and local electrical codes. Always perform a detailed power quality study with calibrated equipment before specifying or installing mitigation equipment. Consult with a licensed professional engineer before implementation.</p>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Design Calculators. Created by <span style="color: var(--secondary); font-weight: bold;">A Sharma</span>. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- Elements from New File ---
            const calculateBtn = document.getElementById('calculate-harmonic-btn');
            const resultsSection = document.getElementById('results-section');
            const resultsTbody = document.getElementById('results-tbody');
            const detailedStepsDiv = document.getElementById('detailed-steps');
            const detailedCalculationsContent = document.getElementById('detailed-calculations-content');
            const educationSection = document.getElementById('education-section');
            const chartCard = document.getElementById('chart-card');
            const loadingSpinner = document.getElementById('loading-spinner');

            const currentHarmonicsContainer = document.getElementById('current-harmonics-container');
            const voltageHarmonicsContainer = document.getElementById('voltage-harmonics-container');
            const addCurrentHarmonicBtn = document.getElementById('add-current-harmonic-btn');
            const addVoltageHarmonicBtn = document.getElementById('add-voltage-harmonic-btn');

            // --- Logic from Template ---
            const themeSwitch = document.getElementById('theme-switch');
            const messageBox = document.getElementById('message-box');

            if (localStorage.getItem('theme') === 'dark') {
                document.body.classList.add('dark-mode');
                themeSwitch.checked = true;
            }
            themeSwitch.addEventListener('change', function() {
                if (this.checked) {
                    document.body.classList.add('dark-mode');
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.body.classList.remove('dark-mode');
                    localStorage.setItem('theme', 'light');
                }
            });

            function showMessage(msg, type = 'success') {
                messageBox.textContent = msg;
                if (type === 'error') {
                    messageBox.style.backgroundColor = 'var(--danger)';
                } else if (type === 'warning') {
                     messageBox.style.backgroundColor = 'var(--warning)';
                } else {
                    messageBox.style.backgroundColor = 'var(--success)';
                }
                messageBox.classList.add('show');
                setTimeout(() => messageBox.classList.remove('show'), 4000);
            }

            // --- Logic from New File (Adapted) ---

            // Function to add a new harmonic input row
            function addHarmonicInputRow(container, type, defaultOrder = '', defaultValue = '') {
                const newRow = document.createElement('div');
                newRow.classList.add('harmonic-input-row');
                newRow.innerHTML = `
                    <div class="form-group">
                        <label>Order (h)</label>
                        <input type="number" class="harmonic-order-${type}" min="2" step="1" value="${defaultOrder}" required>
                    </div>
                    <div class="form-group">
                        <label>Magnitude (${type === 'current' ? 'Ih' : 'Vh'}) (${type === 'current' ? 'A' : 'V'})</label>
                        <input type="number" class="harmonic-magnitude-${type}" min="0" step="0.01" value="${defaultValue}" required>
                    </div>
                    <button type="button" class="remove-harmonic-btn btn danger" style="padding: 12px; margin-bottom: 0; align-self: center;"><i class="fas fa-trash-alt"></i></button>
                `;
                container.appendChild(newRow);

                // Animate the new row
                setTimeout(() => {
                    newRow.classList.add('show');
                }, 10); // Small delay to trigger transition

                // Add event listener for remove button
                newRow.querySelector('.remove-harmonic-btn').addEventListener('click', function() {
                    newRow.classList.remove('show');
                    newRow.addEventListener('transitionend', () => newRow.remove());
                });
            }

            // Add initial default harmonic rows if not already present (from HTML)
            document.querySelectorAll('.remove-harmonic-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const row = this.closest('.harmonic-input-row');
                    row.classList.remove('show');
                    row.addEventListener('transitionend', () => row.remove());
                });
            });

            addCurrentHarmonicBtn.addEventListener('click', () => addHarmonicInputRow(currentHarmonicsContainer, 'current'));
            addVoltageHarmonicBtn.addEventListener('click', () => addHarmonicInputRow(voltageHarmonicsContainer, 'voltage'));

            calculateBtn.addEventListener('click', async function() {
                // Show loading spinner and hide previous results
                loadingSpinner.style.display = 'block';
                resultsSection.classList.add('hidden');
                detailedStepsDiv.classList.add('hidden');
                chartCard.classList.add('hidden');
                educationSection.classList.add('hidden');

                try {
                    // Get fundamental values
                    const fundamentalCurrent = parseFloat(document.getElementById('fundamental-current').value);
                    const fundamentalVoltage = parseFloat(document.getElementById('fundamental-voltage').value);
                    const pccShortCircuitCurrentKA = parseFloat(document.getElementById('pcc-short-circuit-current').value);
                    const maxDemandLoadCurrent = parseFloat(document.getElementById('max-demand-load-current').value);

                    // Input validation for fundamental values
                    if (isNaN(fundamentalCurrent) || isNaN(fundamentalVoltage) || isNaN(pccShortCircuitCurrentKA) || isNaN(maxDemandLoadCurrent)) {
                        throw new Error("Please enter valid numbers for all main input fields.");
                    }
                    if (fundamentalCurrent <= 0 && fundamentalVoltage <= 0) {
                        throw new Error("At least one fundamental magnitude (Current or Voltage) must be greater than zero for THD calculation.");
                    }
                    if (pccShortCircuitCurrentKA <= 0 || maxDemandLoadCurrent <= 0) {
                        throw new Error("PCC Short Circuit Current and Maximum Demand Load Current must be positive values for IEEE 519 compliance check.");
                    }

                    // Get harmonic current inputs
                    const currentHarmonics = [];
                    let invalidCurrentInput = false;
                    document.querySelectorAll('#current-harmonics-container .harmonic-input-row').forEach(row => {
                        const orderInput = row.querySelector('.harmonic-order-current');
                        const magnitudeInput = row.querySelector('.harmonic-magnitude-current');
                        const order = parseInt(orderInput.value);
                        const magnitude = parseFloat(magnitudeInput.value);

                        if (isNaN(order) || isNaN(magnitude) || order < 2 || magnitude < 0) {
                            invalidCurrentInput = true;
                        }
                        currentHarmonics.push({ order, magnitude });
                    });
                    if(invalidCurrentInput) throw new Error("Invalid input for current harmonics. Please use valid numbers (order >= 2, magnitude >= 0).");

                    // Get harmonic voltage inputs
                    const voltageHarmonics = [];
                    let invalidVoltageInput = false;
                    document.querySelectorAll('#voltage-harmonics-container .harmonic-input-row').forEach(row => {
                        const orderInput = row.querySelector('.harmonic-order-voltage');
                        const magnitudeInput = row.querySelector('.harmonic-magnitude-voltage');
                        const order = parseInt(orderInput.value);
                        const magnitude = parseFloat(magnitudeInput.value);
                        
                        if (isNaN(order) || isNaN(magnitude) || order < 2 || magnitude < 0) {
                            invalidVoltageInput = true;
                        }
                        voltageHarmonics.push({ order, magnitude });
                    });
                    if(invalidVoltageInput) throw new Error("Invalid input for voltage harmonics. Please use valid numbers (order >= 2, magnitude >= 0).");

                    // Clear previous results
                    resultsTbody.innerHTML = ''; 
                    detailedCalculationsContent.innerHTML = '';
                    document.getElementById('harmonic-bar-chart').innerHTML = ''; // Clear previous chart

                    let currentCalculations = '';
                    let voltageCalculations = '';
                    let thd_current_percent = 0;
                    let thd_voltage_percent = 0;
                    let total_rms_current = fundamentalCurrent;
                    let total_rms_voltage = fundamentalVoltage;
                    
                    // --- THD Current Calculation (THD_I) ---
                    const sumOfSquaresOfCurrentHarmonics = currentHarmonics.reduce((sum, h) => sum + Math.pow(h.magnitude, 2), 0);
                    const rmsOfCurrentHarmonics = Math.sqrt(sumOfSquaresOfCurrentHarmonics);

                    if (fundamentalCurrent > 0) {
                        thd_current_percent = (rmsOfCurrentHarmonics / fundamentalCurrent) * 100;
                    } else if (rmsOfCurrentHarmonics > 0) {
                        showMessage("Fundamental current is zero, but harmonic currents are present. THD-I will be undefined.", "warning");
                        thd_current_percent = Infinity; 
                    }
                    total_rms_current = Math.sqrt(Math.pow(fundamentalCurrent, 2) + sumOfSquaresOfCurrentHarmonics);

                    currentCalculations += `
                        <h4>Current THD Calculation:</h4>
                        <p><strong>Step 1.1:</strong> Sum of Squares of Harmonic Currents ($\Sigma I_{h}^{2}$)</p>
                        <p>$\\Sigma I_{h}^{2} = ${currentHarmonics.map(h => `${h.magnitude.toFixed(2)}^2`).join(' + ')} = ${sumOfSquaresOfCurrentHarmonics.toFixed(2)} A^2$</p>
                        <p><strong>Step 1.2:</strong> RMS Value of Harmonic Currents ($I_{rms,h}$)</p>
                        <p>$I_{rms,h} = \\sqrt{\\Sigma I_{h}^{2}} = \\sqrt{${sumOfSquaresOfCurrentHarmonics.toFixed(2)}} = ${rmsOfCurrentHarmonics.toFixed(2)} A$</p>
                        <p><strong>Step 1.3:</strong> Total Harmonic Distortion of Current (THD-I)</p>
                        <p>$\\text{THD}_{I} = \\left( \\frac{I_{rms,h}}{I_1} \\right) \\cdot 100\\% = \\left( \\frac{${rmsOfCurrentHarmonics.toFixed(2)} A}{${fundamentalCurrent.toFixed(2)} A} \\right) \\cdot 100\\% = ${thd_current_percent.toFixed(2)}\\%$</p>
                        <p><strong>Step 1.4:</strong> Total RMS Current ($I_{RMS,Total}$)</p>
                        <p>$I_{RMS,Total} = \\sqrt{I_1^2 + I_{rms,h}^2} = \\sqrt{${fundamentalCurrent.toFixed(2)}^2 + ${rmsOfCurrentHarmonics.toFixed(2)}^2} = ${total_rms_current.toFixed(2)} A$</p>
                    `;
                    
                    // --- THD Voltage Calculation (THD_V) ---
                    const sumOfSquaresOfVoltageHarmonics = voltageHarmonics.reduce((sum, h) => sum + Math.pow(h.magnitude, 2), 0);
                    const rmsOfVoltageHarmonics = Math.sqrt(sumOfSquaresOfVoltageHarmonics);

                    if (fundamentalVoltage > 0) {
                        thd_voltage_percent = (rmsOfVoltageHarmonics / fundamentalVoltage) * 100;
                    } else if (rmsOfVoltageHarmonics > 0) {
                        showMessage("Fundamental voltage is zero, but harmonic voltages are present. THD-V will be undefined.", "warning");
                        thd_voltage_percent = Infinity;
                    }
                    total_rms_voltage = Math.sqrt(Math.pow(fundamentalVoltage, 2) + sumOfSquaresOfVoltageHarmonics);

                    voltageCalculations += `
                        <h4 style="margin-top: 20px;">Voltage THD Calculation:</h4>
                        <p><strong>Step 2.1:</strong> Sum of Squares of Harmonic Voltages ($\Sigma V_{h}^{2}$)</p>
                        <p>$\\Sigma V_{h}^{2} = ${voltageHarmonics.map(h => `${h.magnitude.toFixed(2)}^2`).join(' + ')} = ${sumOfSquaresOfVoltageHarmonics.toFixed(2)} V^2$</p>
                        <p><strong>Step 2.2:</strong> RMS Value of Harmonic Voltages ($V_{rms,h}$)</p>
                        <p>$V_{rms,h} = \\sqrt{\\Sigma V_{h}^{2}} = \\sqrt{${sumOfSquaresOfVoltageHarmonics.toFixed(2)}} = ${rmsOfVoltageHarmonics.toFixed(2)} V$</p>
                        <p><strong>Step 2.3:</strong> Total Harmonic Distortion of Voltage (THD-V)</p>
                        <p>$\\text{THD}_{V} = \\left( \\frac{V_{rms,h}}{V_1} \\right) \\cdot 100\\% = \\left( \\frac{${rmsOfVoltageHarmonics.toFixed(2)} V}{${fundamentalVoltage.toFixed(2)} V} \\right) \\cdot 100\\% = ${thd_voltage_percent.toFixed(2)}\\%$</p>
                        <p><strong>Step 2.4:</strong> Total RMS Voltage ($V_{RMS,Total}$)</p>
                        <p>$V_{RMS,Total} = \\sqrt{V_1^2 + V_{rms,h}^2} = \\sqrt{${fundamentalVoltage.toFixed(2)}^2 + ${rmsOfVoltageHarmonics.toFixed(2)}^2} = ${total_rms_voltage.toFixed(2)} V$</p>
                    `;

                    // Display Individual Harmonic Distortion
                    let ihdCalculations = '<h4 style="margin-top: 20px;">Individual Harmonic Distortion (Current - IHD)</h4>';
                    if (fundamentalCurrent > 0) {
                        currentHarmonics.sort((a,b) => a.order - b.order).forEach(h => {
                            const ihd = (h.magnitude / fundamentalCurrent) * 100;
                            ihdCalculations += `<p>IHD at Order ${h.order}: $\\text{IHD}_{${h.order}} = \\left( \\frac{${h.magnitude.toFixed(2)} A}{${fundamentalCurrent.toFixed(2)} A} \\right) \\cdot 100\\% = ${ihd.toFixed(2)}\\%$</p>`;
                        });
                    } else {
                        ihdCalculations += `<p>Individual Harmonic Distortion for Current cannot be calculated as fundamental current is zero.</p>`;
                    }
                    
                    let vhdCalculations = '<h4 style="margin-top: 20px;">Individual Harmonic Distortion (Voltage - VHD)</h4>';
                    if (fundamentalVoltage > 0) {
                        voltageHarmonics.sort((a,b) => a.order - b.order).forEach(h => {
                            const vhd = (h.magnitude / fundamentalVoltage) * 100;
                            vhdCalculations += `<p>VHD at Order ${h.order}: $\\text{VHD}_{${h.order}} = \\left( \\frac{${h.magnitude.toFixed(2)} V}{${fundamentalVoltage.toFixed(2)} V} \\right) \\cdot 100\\% = ${vhd.toFixed(2)}\\%$</p>`;
                        });
                    } else {
                        vhdCalculations += `<p>Individual Harmonic Distortion for Voltage cannot be calculated as fundamental voltage is zero.</p>`;
                    }

                    // --- IEEE 519 Compliance Check ---
                    const isc_il_ratio = (pccShortCircuitCurrentKA * 1000) / maxDemandLoadCurrent;
                    let voltageLevelCategory = '';
                    let thdVLmt = 0;
                    let individualVLmt = 0;

                    if (fundamentalVoltage < 1000) { 
                        voltageLevelCategory = "Low Voltage (V < 1 kV)";
                        thdVLmt = 5.0; individualVLmt = 3.0;
                    } else if (fundamentalVoltage >= 1000 && fundamentalVoltage < 69000) {
                        voltageLevelCategory = "Medium Voltage (1 kV <= V < 69 kV)";
                        thdVLmt = 5.0; individualVLmt = 3.0;
                    } else if (fundamentalVoltage >= 69000 && fundamentalVoltage <= 161000) {
                        voltageLevelCategory = "High Voltage (69 kV <= V <= 161 kV)";
                        thdVLmt = 2.5; individualVLmt = 1.5;
                    } else { 
                        voltageLevelCategory = "Extra-High Voltage (V > 161 kV)";
                        thdVLmt = 1.5; individualVLmt = 1.0;
                    }

                    let thdILmt = 0, individualILmtOddNonTriple = 0, individualILmtOddTriple = 0, individualILmtEven = 0;
                    if (isc_il_ratio < 20) {
                        thdILmt = 20.0; individualILmtOddNonTriple = 20.0; individualILmtOddTriple = 15.0; individualILmtEven = 10.0;
                    } else if (isc_il_ratio < 50) {
                        thdILmt = 12.0; individualILmtOddNonTriple = 10.0; individualILmtOddTriple = 7.0; individualILmtEven = 5.0;
                    } else if (isc_il_ratio < 100) {
                        thdILmt = 8.0; individualILmtOddNonTriple = 7.0; individualILmtOddTriple = 5.0; individualILmtEven = 4.0;
                    } else if (isc_il_ratio < 1000) {
                        thdILmt = 5.0; individualILmtOddNonTriple = 4.0; individualILmtOddTriple = 3.0; individualILmtEven = 2.0;
                    } else { 
                        thdILmt = 5.0; individualILmtOddNonTriple = 4.0; individualILmtOddTriple = 3.0; individualILmtEven = 2.0;
                    }

                    let complianceText = `<h4 style="margin-top: 20px;">IEEE 519 (2014) Compliance Check:</h4>
                        <p><strong>PCC Short Circuit Current ($I_{SC}$):</strong> ${pccShortCircuitCurrentKA.toFixed(2)} kA</p>
                        <p><strong>Maximum Demand Load Current ($I_L$):</strong> ${maxDemandLoadCurrent.toFixed(2)} A</p>
                        <p><strong>$I_{SC}/I_L$ Ratio:</strong> ${isc_il_ratio.toFixed(2)}</p>
                        
                        <h5 style="margin-top: 15px;">Voltage Distortion Limits (IEEE 519 Table 1)</h5>
                        <p><strong>Voltage Level Category:</strong> ${voltageLevelCategory}</p>
                        <p>Calculated THD-V (<strong>${thd_voltage_percent.toFixed(2)}%</strong>) is ${thd_voltage_percent <= thdVLmt ? '<span class="compliance-pass">within</span>' : '<span class="compliance-fail">exceeding</span>'} the limit (<strong>${thdVLmt.toFixed(1)}%</strong>).</p>
                    `;

                    let individualVHDComplianceText = '';
                    if (fundamentalVoltage > 0) {
                        voltageHarmonics.sort((a,b) => a.order - b.order).forEach(h => {
                            const vhd = (h.magnitude / fundamentalVoltage) * 100;
                            const compliance = vhd <= individualVLmt ? '<span class="compliance-pass">within</span>' : '<span class="compliance-fail">exceeding</span>';
                            individualVHDComplianceText += `<p>VHD at Order ${h.order}: <strong>${vhd.toFixed(2)}%</strong> is ${compliance} the limit (<strong>${individualVLmt.toFixed(1)}%</strong>).</p>`;
                        });
                    }
                    complianceText += individualVHDComplianceText || '<p>No voltage harmonics entered for individual compliance check.</p>';

                    complianceText += `<h5 style="margin-top: 15px;">Current Distortion Limits (IEEE 519 Table 2)</h5>
                        <p>Based on $I_{SC}/I_L$ ratio of ${isc_il_ratio.toFixed(2)}, TDD Limit (THD-I) is <strong>${thdILmt.toFixed(1)}%</strong>.</p>
                        <p>Calculated THD-I (<strong>${thd_current_percent.toFixed(2)}%</strong>) is ${thd_current_percent <= thdILmt ? '<span class="compliance-pass">within</span>' : '<span class="compliance-fail">exceeding</span>'} the limit.</p>
                    `;

                    let individualIHDComplianceText = '';
                    if (fundamentalCurrent > 0) {
                        currentHarmonics.sort((a,b) => a.order - b.order).forEach(h => {
                            const ihd = (h.magnitude / fundamentalCurrent) * 100;
                            let limit = 0, type = '';
                            if (h.order % 2 === 0) { limit = individualILmtEven; type = 'Even'; }
                            else if (h.order % 3 === 0) { limit = individualILmtOddTriple; type = 'Odd (Triple)'; }
                            else { limit = individualILmtOddNonTriple; type = 'Odd (Non-Triple)'; }
                            const compliance = ihd <= limit ? '<span class="compliance-pass">within</span>' : '<span class="compliance-fail">exceeding</span>';
                            individualIHDComplianceText += `<p>IHD at Order ${h.order} (${type}): <strong>${ihd.toFixed(2)}%</strong> is ${compliance} the limit (<strong>${limit.toFixed(1)}%</strong>).</p>`;
                        });
                    }
                    complianceText += individualIHDComplianceText || '<p>No current harmonics entered for individual compliance check.</p>';
                    
                    // Add detailed calculation steps to the div
                    detailedCalculationsContent.innerHTML = currentCalculations + voltageCalculations + ihdCalculations + vhdCalculations + complianceText;

                    // Display Summary results
                    addResultRow("Fundamental Current (I1)", `${fundamentalCurrent.toFixed(2)} A`);
                    addResultRow("Total RMS Current (IRMS)", `${total_rms_current.toFixed(2)} A`);
                    addResultRow("THD - Current (THD-I)", `${thd_current_percent.toFixed(2)} %`, thd_current_percent > thdILmt);
                    addResultRow("Fundamental Voltage (V1)", `${fundamentalVoltage.toFixed(2)} V`);
                    addResultRow("Total RMS Voltage (VRMS)", `${total_rms_voltage.toFixed(2)} V`);
                    addResultRow("THD - Voltage (THD-V)", `${thd_voltage_percent.toFixed(2)} %`, thd_voltage_percent > thdVLmt);
                    addResultRow("ISC/IL Ratio", isc_il_ratio.toFixed(2));
                    addResultRow("THD-V Limit (IEEE 519)", `${thdVLmt.toFixed(1)} %`);
                    addResultRow("THD-I Limit (IEEE 519)", `${thdILmt.toFixed(1)} %`);

                    // Hide loading spinner and show results
                    loadingSpinner.style.display = 'none';
                    resultsSection.classList.remove('hidden');
                    detailedStepsDiv.classList.remove('hidden');
                    chartCard.classList.remove('hidden');
                    educationSection.classList.remove('hidden');

                    // Draw the harmonic spectrum chart
                    drawHarmonicChart(fundamentalCurrent, currentHarmonics, fundamentalVoltage, voltageHarmonics);

                    setTimeout(() => {
                        resultsSection.scrollIntoView({ behavior: 'smooth' });
                    }, 100); 

                    if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
                        setTimeout(() => {
                            window.MathJax.typesetPromise([detailedStepsDiv]);
                        }, 50); 
                    }
                    
                    showMessage("Calculation successful!", "success");

                } catch (e) {
                    showMessage(e.message, "error");
                    loadingSpinner.style.display = 'none';
                }
            });

            // Function to draw the harmonic spectrum bar chart
            function drawHarmonicChart(i1, currentHarms, v1, voltageHarms) {
                d3.select("#harmonic-bar-chart").selectAll("*").remove(); // Clear previous chart

                const margin = { top: 20, right: 30, bottom: 60, left: 60 },
                    width = Math.min(800, document.getElementById('chart-card').offsetWidth - margin.left - margin.right - 40), // Adjust for padding
                    height = 400 - margin.top - margin.bottom;

                const svg = d3.select("#harmonic-bar-chart")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                    .append("g")
                    .attr("transform", `translate(${margin.left},${margin.top})`);

                const chartData = [];
                if (i1 > 0) chartData.push({ order: 1, type: 'current', magnitude: i1 });
                currentHarms.forEach(h => {
                    if (h.magnitude > 0) chartData.push({ order: h.order, type: 'current', magnitude: h.magnitude });
                });
                if (v1 > 0) chartData.push({ order: 1, type: 'voltage', magnitude: v1 });
                voltageHarms.forEach(h => {
                    if (h.magnitude > 0) chartData.push({ order: h.order, type: 'voltage', magnitude: h.magnitude });
                });

                const allOrders = [...new Set(chartData.map(d => d.order))].sort((a,b) => a-b);
                
                if (allOrders.length === 0) {
                    chartCard.classList.add('hidden');
                    showMessage("No harmonic data (current or voltage) provided to generate a chart.", "warning");
                    return;
                }

                const x = d3.scaleBand()
                    .domain(allOrders)
                    .range([0, width])
                    .padding(0.2); // Increased padding

                const maxMagnitude = d3.max(chartData, d => d.magnitude) || 1;
                const y = d3.scaleLinear()
                    .domain([0, maxMagnitude * 1.1]) // 10% buffer
                    .range([height, 0]);

                svg.append("g")
                    .attr("transform", `translate(0,${height})`)
                    .call(d3.axisBottom(x).tickFormat(d => d === 1 ? "Fund." : d))
                    .selectAll("text")
                    .style("text-anchor", "end")
                    .attr("dx", "-.8em")
                    .attr("dy", ".15em")
                    .attr("transform", "rotate(-45)");

                svg.append("g").call(d3.axisLeft(y));

                svg.append("text")
                    .attr("text-anchor", "middle")
                    .attr("x", width / 2)
                    .attr("y", height + margin.bottom - 10)
                    .style("fill", "var(--text)")
                    .text("Harmonic Order");

                svg.append("text")
                    .attr("text-anchor", "middle")
                    .attr("transform", "rotate(-90)")
                    .attr("y", -margin.left + 20)
                    .attr("x", -height / 2)
                    .style("fill", "var(--text)")
                    .text("Magnitude (A or V)");

                const currentData = chartData.filter(d => d.type === 'current');
                const voltageData = chartData.filter(d => d.type === 'voltage');

                const barWidth = x.bandwidth();
                const barSpacing = 2; 
                const subBarWidth = (barWidth / 2) - (barSpacing / 2); 

                svg.selectAll(".bar-current")
                    .data(currentData)
                    .enter()
                    .append("rect")
                    .attr("class", "bar bar-current")
                    .attr("x", d => x(d.order) + barSpacing / 2) 
                    .attr("y", d => y(d.magnitude))
                    .attr("width", subBarWidth)
                    .attr("height", d => height - y(d.magnitude))
                    .attr("fill", "var(--primary)") 
                    .append("title") 
                    .text(d => `Current - Order ${d.order}: ${d.magnitude.toFixed(2)} A`);

                svg.selectAll(".bar-voltage")
                    .data(voltageData)
                    .enter()
                    .append("rect")
                    .attr("class", "bar bar-voltage")
                    .attr("x", d => x(d.order) + barWidth / 2 + barSpacing / 2) 
                    .attr("y", d => y(d.magnitude))
                    .attr("width", subBarWidth)
                    .attr("height", d => height - y(d.magnitude))
                    .attr("fill", "var(--accent)")
                    .append("title") 
                    .text(d => `Voltage - Order ${d.order}: ${d.magnitude.toFixed(2)} V`);

                const legend = svg.append("g")
                    .attr("class", "legend")
                    .attr("transform", `translate(${width - 150}, -10)`); // Position legend

                legend.append("rect")
                    .attr("x", 0)
                    .attr("y", 0)
                    .attr("width", 10)
                    .attr("height", 10)
                    .attr("fill", "var(--primary)");

                legend.append("text")
                    .attr("x", 20)
                    .attr("y", 9)
                    .style("fill", "var(--text)")
                    .style("font-size", "12px")
                    .text("Current Harmonics");

                legend.append("rect")
                    .attr("x", 0)
                    .attr("y", 20)
                    .attr("width", 10)
                    .attr("height", 10)
                    .attr("fill", "var(--accent)");

                legend.append("text")
                    .attr("x", 20)
                    .attr("y", 29)
                    .style("fill", "var(--text)")
                    .style("font-size", "12px")
                    .text("Voltage Harmonics");
            }

            // Helper function to add a row to the summary result table
            function addResultRow(parameter, value, isFail = false) {
                const row = document.createElement('tr');
                
                const paramCell = document.createElement('td');
                paramCell.textContent = parameter;
                
                const valueCell = document.createElement('td');
                valueCell.innerHTML = `<strong>${value}</strong>`;
                
                if (parameter.includes('THD-I') || parameter.includes('THD-V')) {
                    valueCell.classList.add('highlight');
                    if (isFail) {
                        valueCell.classList.add('fail');
                    }
                }
                
                row.appendChild(paramCell);
                row.appendChild(valueCell);
                
                resultsTbody.appendChild(row);
            }
        });
    </script>
</body>
</html>
