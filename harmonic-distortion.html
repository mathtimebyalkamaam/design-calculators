<!DOCTYPE html>
<html lang="en">
<head>
                <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-23Y1V450SR"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-23Y1V450SR');           
</script>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5936527763614780"
     crossorigin="anonymous"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Harmonic Distortion Calculator - Design Calculators - Electrical</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="icon" href="/favicon.ico" type="image/x-icon">

    <style>
        /* Basic CSS Variables for a consistent theme */
        :root {
            --primary-color: #4CAF50; /* Green */
            --secondary-color: #45a049; /* Darker Green */
            --accent-color: #FFC107; /* Amber */
            --bg-color: #f4f7f6; /* Light Greyish Green */
            --card-bg: #ffffff; /* White */
            --text-color: #333333; /* Dark Grey */
            --header-bg: #2C3E50; /* Dark Blue Grey */
            --footer-bg: #34495E; /* Slightly Lighter Dark Blue Grey */
            --border-color: #cccccc;
            --card-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            --hover-color: #e2e6ea;
            --input-focus-border: #4CAF50;
            --button-hover-bg: #45a049;
        }

        /* Dark Mode Variables */
        body.dark-mode {
            --bg-color: #2c3e50;
            --card-bg: #34495e;
            --text-color: #ecf0f1;
            --header-bg: #2c3e50;
            --footer-bg: #2c3e50;
            --border-color: #555555;
            --card-shadow: 0 4px 8px rgba(0,0,0,0.3);
            --hover-color: #446688;
            --input-focus-border: #8bc34a; /* Lighter green for dark mode focus */
            --button-hover-bg: #3e8e41; /* Darker green for dark mode button hover */
        }

        /* General Body Styling */
        body {
            font-family: 'Inter', sans-serif; /* Using Inter as specified */
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 960px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: var(--header-bg);
            color: white;
            padding: 20px 0;
            text-align: center;
            box-shadow: var(--card-shadow);
            position: relative; /* For theme toggle positioning */
        }

        header h1 {
            margin: 0;
            font-size: 2.5em;
            color: var(--primary-color);
        }

        header .subtitle {
            margin: 5px 0 0;
            font-size: 1em;
            color: #bdc3c7;
        }

        main {
            padding: 20px 0;
        }

        .tool-container {
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 20px;
            box-shadow: var(--card-shadow);
            margin-bottom: 20px;
        }

        .tool-container h2 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            margin-top: 0;
            margin-bottom: 20px;
        }
        /* Ensure H2 is visible in dark mode */
        body.dark-mode .tool-container h2 {
            color: white; /* Explicitly set to white for visibility */
            border-bottom-color: white;
        }

        .tool-description {
            margin-bottom: 20px;
            color: var(--text-color);
        }

        .back-button {
            display: inline-block;
            background-color: var(--primary-color);
            color: white;
            padding: 10px 15px;
            border-radius: 4px;
            text-decoration: none;
            margin-bottom: 20px;
            transition: background-color 0.3s;
        }

        .back-button:hover {
            background-color: var(--secondary-color);
        }

        /* Theme Toggle */
        .theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
        }

        .theme-toggle .light-icon,
        .theme-toggle .dark-icon {
            color: white;
            margin: 0 5px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
        }

        input:checked + .slider {
            background-color: var(--primary-color);
        }

        input:focus + .slider {
            box-shadow: 0 0 1px var(--primary-color);
        }

        input:checked + .slider:before {
            -webkit-transform: translateX(26px);
            -ms-transform: translateX(26px);
            transform: translateX(26px);
        }

        /* Rounded sliders */
        .slider.round {
            border-radius: 34px;
        }

        .slider.round:before {
            border-radius: 50%;
        }

        /* Footer Styling */
        footer {
            background-color: var(--footer-bg);
            color: white;
            padding: 20px 0;
            text-align: center;
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1);
            margin-top: 30px;
        }

        footer .disclaimer h3,
        footer .social-share h3 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        footer .disclaimer p {
            font-size: 0.9em;
            color: #bdc3c7;
        }

        .social-buttons {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .social-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            color: white;
            text-decoration: none;
            font-size: 1.2em;
            transition: transform 0.3s ease-in-out;
        }

        .social-btn:hover {
            transform: translateY(-3px);
        }

        .social-btn.linkedin { background-color: #0A66C2; }
        .social-btn.facebook { background-color: #1877F2; }
        .social-btn.twitter { background-color: #1DA1F2; }
        .social-btn.whatsapp { background-color: #25D366; }
        .social-btn.reddit { background-color: #FF4500; }

        /* Styles for Calculator Forms and Results */
        .calculator-form {
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: var(--card-shadow);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--text-color); /* Ensure label text is visible */
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: border-color 0.3s, box-shadow 0.3s; /* Add transition for input focus */
        }

        .form-group input:focus, .form-group select:focus {
            border-color: var(--input-focus-border);
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.3); /* Green shadow */
            outline: none;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .form-row .form-group {
            flex: 1 1 200px;
        }
        
        .calculate-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin-top: 10px;
            transition: background-color 0.3s, transform 0.1s ease-in-out;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .calculate-btn:hover {
            background-color: var(--button-hover-bg);
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0,0,0,0.15);
        }

        .calculate-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .add-harmonic-btn {
            background-color: #3B82F6; /* Blue */
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            margin-top: 10px;
            transition: background-color 0.3s, transform 0.1s ease-in-out;
        }

        .add-harmonic-btn:hover {
            background-color: #2563EB; /* Darker Blue */
            transform: translateY(-1px);
        }

        .remove-harmonic-btn {
            background-color: #EF4444; /* Red */
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
            transition: background-color 0.3s, transform 0.1s ease-in-out;
        }

        .remove-harmonic-btn:hover {
            background-color: #DC2626; /* Darker Red */
            transform: translateY(-1px);
        }

        .harmonic-input-row {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            margin-bottom: 15px;
            opacity: 0; /* For animation */
            transform: translateY(20px); /* For animation */
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }

        .harmonic-input-row.show {
            opacity: 1;
            transform: translateY(0);
        }

        .harmonic-input-row .form-group {
            flex: 1;
            margin-bottom: 0; /* Adjust margin for row alignment */
        }

        .result-container {
            margin-top: 30px;
            padding: 20px;
            border-radius: 8px;
            background-color: var(--card-bg);
            box-shadow: var(--card-shadow);
            display: none; /* Hidden by default */
            opacity: 0; /* For fade-in animation */
            transition: opacity 0.5s ease-in-out;
        }
        
        .result-container.show {
            opacity: 1;
        }

        .result-container h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        /* Ensure H3 is visible in dark mode */
        body.dark-mode .result-container h3 {
            color: white; /* Explicitly set to white for visibility */
        }

        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .result-table th, .result-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        .result-table th {
            background-color: var(--hover-color);
        }
        
        .standard-reference {
            margin-top: 20px;
            font-style: italic;
            font-size: 0.9rem;
            color: var(--text-color); /* Ensure visibility in dark mode */
        }
        
        .info-icon {
            color: var(--primary-color);
            margin-left: 5px;
            cursor: help;
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* Custom message box style */
        #custom-message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            font-weight: bold;
            color: white;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        /* Loading Spinner */
        .loading-spinner {
            display: none; /* Hidden by default */
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid var(--primary-color); /* Green */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Styles for detailed calculation steps */
        .detailed-calculations, .harmonic-reduction-tips {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--hover-color); /* A lighter background for contrast */
            color: var(--text-color); /* Ensure text visibility */
        }

        body.dark-mode .detailed-calculations, body.dark-mode .harmonic-reduction-tips {
            background-color: #3a475a; /* Darker background for contrast in dark mode */
            border-color: #6a7a8f;
        }

        .detailed-calculations h4, .harmonic-reduction-tips h4 {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 10px;
            color: var(--primary-color); /* Highlight heading */
        }
        body.dark-mode .detailed-calculations h4, body.dark-mode .harmonic-reduction-tips h4 {
            color: var(--primary-color); /* Use lighter primary color in dark mode */
        }

        .detailed-calculations p, .harmonic-reduction-tips p, .harmonic-reduction-tips ul {
            margin-bottom: 5px;
            font-size: 0.95rem;
            line-height: 1.4;
        }
        .harmonic-reduction-tips ul {
            list-style-type: disc;
            padding-left: 20px;
        }

        .detailed-calculations strong, .harmonic-reduction-tips strong {
            color: var(--secondary-color); /* Highlight key terms in formulas */
        }
        body.dark-mode .detailed-calculations strong, body.dark-mode .harmonic-reduction-tips strong {
            color: var(--primary-color); /* Use lighter primary color for highlights in dark mode */
        }

        /* MathJax rendered formulas will have the desired styling */
        .formula {
            font-family: 'Courier New', Courier, monospace; /* Not strictly needed with MathJax, but good for raw */
            background-color: rgba(0,0,0,0.05); /* Light tint for formula background */
            padding: 2px 5px;
            border-radius: 3px;
            display: inline-block; /* Helps with MathJax inline rendering */
            margin-top: 5px;
            font-size: 0.9em;
        }
        body.dark-mode .formula {
            background-color: rgba(255,255,255,0.05);
        }

        .calculation-step {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px dashed var(--border-color);
        }

        .detailed-calculations .calculation-step:last-child {
            border-bottom: none; /* No border after the last step */
        }

        /* Chart Styles */
        .chart-container {
            margin-top: 30px;
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 20px;
            box-shadow: var(--card-shadow);
            display: none; /* Hidden by default */
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        .chart-container.show {
            opacity: 1;
        }

        .chart-container h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        body.dark-mode .chart-container h3 {
            color: white;
        }

        .bar {
            fill: var(--primary-color);
            transition: fill 0.3s ease-in-out;
        }
        .bar:hover {
            fill: var(--secondary-color);
        }
        .chart-text {
            fill: var(--text-color);
            font-size: 10px;
        }
    </style>
    <!-- MathJax configuration and loading -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
            },
            svg: {
                fontCache: 'global'
            },
            options: {
                processHtmlClass: 'math-content', // Process elements with this class
                ignoreHtmlClass: 'no-mathjax'      // Ignore elements with this class
            }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <!-- D3.js library for charting -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
    <header>
        <div class="container">
            <h1>Design Calculators - Electrical</h1>
            <p class="subtitle">Electrical Calculations Made Easy — Learn with Every Step</p>
            <div class="theme-toggle">
                <span class="light-icon"><i class="fas fa-sun"></i></span>
                <label class="switch">
                    <input type="checkbox" id="theme-switch">
                    <span class="slider round"></span>
                </label>
                <span class="dark-icon"><i class="fas fa-moon"></i></span>
            </div>
        </div>
    </header>

    <main class="container">
        <a href="indexEle.html" class="back-button"><i class="fas fa-arrow-left"></i> Back to Tools</a>
        
        <div class="tool-container">
            <h2>Advanced Harmonic Distortion Calculator</h2>
            
            <div class="tool-description">
                <p>This calculator estimates the Total Harmonic Distortion (THD) for both current and voltage, along with Individual Harmonic Distortion (IHD/VHD), based on user-defined harmonic orders and magnitudes. This is crucial for power quality assessment in accordance with international standards like <strong>IEEE 519</strong> and <strong>IEC 61000 series</strong>. It also provides a visual representation of the harmonic spectrum.</p>
            </div>
        
            <div class="calculator-form">
                <form id="harmonic-distortion-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="fundamental-current">Fundamental Current (I1) (A) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The RMS current at the fundamental frequency (e.g., 50 Hz or 60 Hz).</span></span></label>
                            <input type="number" id="fundamental-current" min="0.01" step="0.01" value="100" required>
                        </div>
                        <div class="form-group">
                            <label for="fundamental-voltage">Fundamental Voltage (V1) (V) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The RMS voltage at the fundamental frequency.</span></span></label>
                            <input type="number" id="fundamental-voltage" min="0.01" step="0.01" value="240" required>
                        </div>
                    </div>
                    
                    <h3>Individual Harmonic Components (Current)</h3>
                    <div id="current-harmonics-container">
                        <!-- Dynamic current harmonic inputs will be appended here -->
                        <div class="harmonic-input-row show">
                            <div class="form-group">
                                <label>Order (h)</label>
                                <input type="number" class="harmonic-order-current" min="2" step="1" value="3" required>
                            </div>
                            <div class="form-group">
                                <label>Magnitude (Ih) (A)</label>
                                <input type="number" class="harmonic-magnitude-current" min="0" step="0.01" value="10" required>
                            </div>
                            <button type="button" class="remove-harmonic-btn"><i class="fas fa-trash-alt"></i></button>
                        </div>
                        <div class="harmonic-input-row show">
                            <div class="form-group">
                                <label>Order (h)</label>
                                <input type="number" class="harmonic-order-current" min="2" step="1" value="5" required>
                            </div>
                            <div class="form-group">
                                <label>Magnitude (Ih) (A)</label>
                                <input type="number" class="harmonic-magnitude-current" min="0" step="0.01" value="7" required>
                            </div>
                            <button type="button" class="remove-harmonic-btn"><i class="fas fa-trash-alt"></i></button>
                        </div>
                        <div class="harmonic-input-row show">
                            <div class="form-group">
                                <label>Order (h)</label>
                                <input type="number" class="harmonic-order-current" min="2" step="1" value="7" required>
                            </div>
                            <div class="form-group">
                                <label>Magnitude (Ih) (A)</label>
                                <input type="number" class="harmonic-magnitude-current" min="0" step="0.01" value="5" required>
                            </div>
                            <button type="button" class="remove-harmonic-btn"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>
                    <button type="button" id="add-current-harmonic-btn" class="add-harmonic-btn"><i class="fas fa-plus"></i> Add Current Harmonic</button>

                    <h3 class="mt-8">Individual Harmonic Components (Voltage)</h3>
                    <div id="voltage-harmonics-container">
                        <!-- Dynamic voltage harmonic inputs will be appended here -->
                        <div class="harmonic-input-row show">
                            <div class="form-group">
                                <label>Order (h)</label>
                                <input type="number" class="harmonic-order-voltage" min="2" step="1" value="3" required>
                            </div>
                            <div class="form-group">
                                <label>Magnitude (Vh) (V)</label>
                                <input type="number" class="harmonic-magnitude-voltage" min="0" step="0.01" value="5" required>
                            </div>
                            <button type="button" class="remove-harmonic-btn"><i class="fas fa-trash-alt"></i></button>
                        </div>
                        <div class="harmonic-input-row show">
                            <div class="form-group">
                                <label>Order (h)</label>
                                <input type="number" class="harmonic-order-voltage" min="2" step="1" value="5" required>
                            </div>
                            <div class="form-group">
                                <label>Magnitude (Vh) (V)</label>
                                <input type="number" class="harmonic-magnitude-voltage" min="0" step="0.01" value="3" required>
                            </div>
                            <button type="button" class="remove-harmonic-btn"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>
                    <button type="button" id="add-voltage-harmonic-btn" class="add-harmonic-btn"><i class="fas fa-plus"></i> Add Voltage Harmonic</button>

                    <h3 class="mt-8">IEEE 519 Standard Compliance Data</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="pcc-short-circuit-current">PCC Short Circuit Current ($I_{SC}$) (kA) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The maximum available symmetrical short-circuit current at the Point of Common Coupling (PCC). Usually in kiloamperes (kA).</span></span></label>
                            <input type="number" id="pcc-short-circuit-current" min="0.1" step="0.1" value="10" required>
                        </div>
                        <div class="form-group">
                            <label for="max-demand-load-current">Maximum Demand Load Current ($I_L$) (A) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The maximum demand load current at the PCC, for 15 or 30 minute average.</span></span></label>
                            <input type="number" id="max-demand-load-current" min="1" step="1" value="100" required>
                        </div>
                    </div>
                    
                    <button type="button" id="calculate-harmonic-btn" class="calculate-btn mt-8">Calculate Harmonic Distortion</button>
                    <div id="loading-spinner" class="loading-spinner"></div>
                </form>
            </div>
            
            <div id="result-container" class="result-container">
                <h3>Calculation Summary</h3>
                <table class="result-table">
                    <thead>
                        <tr>
                            <th>Parameter</th>
                            <th>Value</th>
                        </tr>
                    </thead>
                    <tbody id="result-table-body">
                        <!-- Results will be dynamically inserted here -->
                    </tbody>
                </table>
                <!-- Detailed calculations section -->
                <div id="detailed-calculations" class="detailed-calculations mt-6 math-content">
                    <h3>Detailed Calculation Steps</h3>
                    <!-- Detailed calculation steps will be dynamically inserted here -->
                </div>
            </div>

            <!-- Harmonic Spectrum Chart -->
            <div id="harmonic-chart-container" class="chart-container">
                <h3>Harmonic Spectrum Visualization</h3>
                <svg id="harmonic-bar-chart"></svg>
            </div>

            <!-- Harmonic Reduction Tips Section -->
            <div id="harmonic-reduction-tips" class="harmonic-reduction-tips mt-6">
                <h3>Tips for Reducing Harmonic Distortion</h3>
                <p>High levels of harmonic distortion can lead to increased energy losses, equipment overheating, premature aging of insulation, and interference with sensitive electronic devices. Here are some effective strategies to mitigate harmonics:</p>
                <ul>
                    <li>
                        <strong>Passive Harmonic Filters:</strong> These are combinations of inductors (reactors) and capacitors tuned to resonate at specific harmonic frequencies, providing a low-impedance path for harmonic currents, diverting them from the supply. They are relatively inexpensive but can be bulky and their effectiveness depends on the stability of system impedance.
                    </li>
                    <li>
                        <strong>Active Harmonic Filters (AHF):</strong> These are advanced electronic devices that inject compensating currents into the system to cancel out harmonic currents generated by loads. AHFs are more flexible, can adapt to varying load conditions, and are generally more effective than passive filters, especially for dynamic loads and multiple harmonic orders.
                    </li>
                    <li>
                        <strong>Line Reactors/Chokes:</strong> Installing line reactors (inductors) in series with non-linear loads (like VFDs, rectifiers) helps to increase the impedance seen by harmonic currents, thereby reducing the amount of harmonic current drawn from the supply. This is a simple and cost-effective first step for many applications.
                    </li>
                    <li>
                        <strong>Multi-Pulse Rectifiers (e.g., 12-pulse, 18-pulse drives):</strong> For large variable frequency drives (VFDs) and other high-power non-linear loads, using rectifiers with a higher number of pulses (e.g., 12-pulse or 18-pulse instead of 6-pulse) significantly reduces characteristic harmonics (like 5th and 7th).
                    </li>
                    <li>
                        <strong>K-Rated Transformers:</strong> In systems with high harmonic content, standard transformers can overheat due to additional eddy current losses. K-rated transformers are specially designed to handle harmonic currents without excessive heating, improving reliability and efficiency.
                    </li>
                    <li>
                        <strong>Proper Sizing and Wiring:</strong> Ensuring conductors are adequately sized for RMS currents (which are higher with harmonics) and proper grounding can help prevent overheating and minimize harmonic-related issues. Avoiding parallel neutral conductors for 3rd harmonics in 4-wire systems is also critical.
                    </li>
                </ul>
                <p class="mt-4 text-sm text-gray-600 dark:text-gray-400"><em>The choice of harmonic mitigation strategy depends on the magnitude and nature of the harmonics, the sensitivity of the connected equipment, and economic considerations. A detailed power quality study by a qualified engineer is recommended for complex systems.</em></p>
            </div>

            <div class="standard-reference" id="standard-reference">
                <p>Harmonic analysis and limits are typically addressed by standards such as: <br>
                - <strong>IEEE 519:</strong> Recommended Practices and Requirements for Harmonic Control in Electric Power Systems. <br>
                - <strong>IEC 61000 series:</strong> Electromagnetic Compatibility - EMC, particularly IEC 61000-3-2 (limits for harmonic current emissions for equipment with input current ＋ 16 A per phase) and IEC 61000-3-12 (limits for harmonic currents produced by equipment connected to public low-voltage systems with input current > 16 A and ＋ 75 A per phase).</p>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <div class="disclaimer">
                <p>Disclaimer: Always verify calculation results against applicable engineering standards and guidelines.</p>
            </div>
            <div class="credit">
                <p>Created by A Sharma</p>
                <p>&copy; 2025 Design Calculators</p>
            </div>
            <div class="social-share">
                <h3>Share This Site</h3>
                <div class="social-buttons">
                    <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://designcalculators.co.in&title=Design Calculators - Electrical" target="_blank" class="social-btn linkedin">
                        <i class="fab fa-linkedin"></i>
                    </a>
                    <a href="https://www.facebook.com/sharer/sharer.php?u=https://designcalculators.co.in" target="_blank" class="social-btn facebook">
                        <i class="fab fa-facebook"></i>
                    </a>
                    <a href="https://twitter.com/intent/tweet?text=Check out this amazing Design Calculators - Electrical!&url=https://designcalculators.co.in" target="_blank" class="social-btn twitter">
                        <i class="fab fa-twitter"></i>
                    </a>
                    <a href="https://api.whatsapp.com/send?text=Check out this amazing Design Calculators - Electrical! https://designcalculators.co.in" target="_blank" class="social-btn whatsapp">
                        <i class="fab fa-whatsapp"></i>
                    </a>
                    <a href="https://www.reddit.com/submit?url=https://designcalculators.co.in&title=Design Calculators - Electrical" target="_blank" class="social-btn reddit">
                        <i class="fab fa-reddit"></i>
                    </a>
                </div>
            </div>
        </div>
    </footer>

    <!-- Custom Message Box -->
    <div id="custom-message-box"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const calculateBtn = document.getElementById('calculate-harmonic-btn');
            const resultContainer = document.getElementById('result-container');
            const resultTableBody = document.getElementById('result-table-body');
            const detailedCalculationsDiv = document.getElementById('detailed-calculations');
            const harmonicReductionTipsDiv = document.getElementById('harmonic-reduction-tips');
            const harmonicChartContainer = document.getElementById('harmonic-chart-container');
            const loadingSpinner = document.getElementById('loading-spinner');

            const currentHarmonicsContainer = document.getElementById('current-harmonics-container');
            const voltageHarmonicsContainer = document.getElementById('voltage-harmonics-container');
            const addCurrentHarmonicBtn = document.getElementById('add-current-harmonic-btn');
            const addVoltageHarmonicBtn = document.getElementById('add-voltage-harmonic-btn');

            // Set default values for fundamental inputs
            document.getElementById('fundamental-current').value = 100;
            document.getElementById('fundamental-voltage').value = 240;
            document.getElementById('pcc-short-circuit-current').value = 10; // Default kA
            document.getElementById('max-demand-load-current').value = 100; // Default A

            // Theme switch logic (copied from previous calculator, ensuring consistency)
            const themeSwitch = document.getElementById('theme-switch');
            if (themeSwitch) {
                if (localStorage.getItem('theme') === 'dark') {
                    document.body.classList.add('dark-mode');
                    themeSwitch.checked = true;
                }
                themeSwitch.addEventListener('change', function() {
                    if (this.checked) {
                        document.body.classList.add('dark-mode');
                        localStorage.setItem('theme', 'dark');
                    } else {
                        document.body.classList.remove('dark-mode');
                        localStorage.setItem('theme', 'light');
                    }
                });
            }

            // Function to add a new harmonic input row
            function addHarmonicInputRow(container, type, defaultOrder = '', defaultValue = '') {
                const newRow = document.createElement('div');
                newRow.classList.add('harmonic-input-row');
                newRow.innerHTML = `
                    <div class="form-group">
                        <label>Order (h)</label>
                        <input type="number" class="harmonic-order-${type}" min="2" step="1" value="${defaultOrder}" required>
                    </div>
                    <div class="form-group">
                        <label>Magnitude (${type === 'current' ? 'Ih' : 'Vh'}) (${type === 'current' ? 'A' : 'V'})</label>
                        <input type="number" class="harmonic-magnitude-${type}" min="0" step="0.01" value="${defaultValue}" required>
                    </div>
                    <button type="button" class="remove-harmonic-btn"><i class="fas fa-trash-alt"></i></button>
                `;
                container.appendChild(newRow);

                // Animate the new row
                setTimeout(() => {
                    newRow.classList.add('show');
                }, 10); // Small delay to trigger transition

                // Add event listener for remove button
                newRow.querySelector('.remove-harmonic-btn').addEventListener('click', function() {
                    newRow.classList.remove('show');
                    newRow.addEventListener('transitionend', () => newRow.remove());
                });
            }

            // Add initial default harmonic rows if not already present (from HTML)
            document.querySelectorAll('.remove-harmonic-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const row = this.closest('.harmonic-input-row');
                    row.classList.remove('show');
                    row.addEventListener('transitionend', () => row.remove());
                });
            });

            addCurrentHarmonicBtn.addEventListener('click', () => addHarmonicInputRow(currentHarmonicsContainer, 'current'));
            addVoltageHarmonicBtn.addEventListener('click', () => addHarmonicInputRow(voltageHarmonicsContainer, 'voltage'));

            calculateBtn.addEventListener('click', async function() {
                // Show loading spinner and hide previous results
                loadingSpinner.style.display = 'block';
                resultContainer.classList.remove('show');
                harmonicChartContainer.classList.remove('show');

                // Get fundamental values
                const fundamentalCurrent = parseFloat(document.getElementById('fundamental-current').value);
                const fundamentalVoltage = parseFloat(document.getElementById('fundamental-voltage').value);
                const pccShortCircuitCurrentKA = parseFloat(document.getElementById('pcc-short-circuit-current').value);
                const maxDemandLoadCurrent = parseFloat(document.getElementById('max-demand-load-current').value);

                // Input validation for fundamental values
                if (isNaN(fundamentalCurrent) || isNaN(fundamentalVoltage) || isNaN(pccShortCircuitCurrentKA) || isNaN(maxDemandLoadCurrent)) {
                    displayMessage("Please enter valid numbers for all main input fields.", "error");
                    loadingSpinner.style.display = 'none';
                    return;
                }
                if (fundamentalCurrent <= 0 && fundamentalVoltage <= 0) {
                    displayMessage("At least one fundamental magnitude (Current or Voltage) must be greater than zero for THD calculation.", "error");
                    loadingSpinner.style.display = 'none';
                    return;
                }
                if (pccShortCircuitCurrentKA <= 0 || maxDemandLoadCurrent <= 0) {
                    displayMessage("PCC Short Circuit Current and Maximum Demand Load Current must be positive values for IEEE 519 compliance check.", "error");
                    loadingSpinner.style.display = 'none';
                    return;
                }

                // Get harmonic current inputs
                const currentHarmonics = [];
                document.querySelectorAll('#current-harmonics-container .harmonic-input-row').forEach(row => {
                    const orderInput = row.querySelector('.harmonic-order-current');
                    const magnitudeInput = row.querySelector('.harmonic-magnitude-current');
                    const order = parseInt(orderInput.value);
                    const magnitude = parseFloat(magnitudeInput.value);

                    if (isNaN(order) || isNaN(magnitude) || order < 2 || magnitude < 0) {
                        displayMessage(`Invalid input for current harmonic: Order '${orderInput.value}' or Magnitude '${magnitudeInput.value}'. Please use valid numbers (order >= 2, magnitude >= 0).`, "error");
                        loadingSpinner.style.display = 'none';
                        return;
                    }
                    currentHarmonics.push({ order, magnitude });
                });

                // Get harmonic voltage inputs
                const voltageHarmonics = [];
                document.querySelectorAll('#voltage-harmonics-container .harmonic-input-row').forEach(row => {
                    const orderInput = row.querySelector('.harmonic-order-voltage');
                    const magnitudeInput = row.querySelector('.harmonic-magnitude-voltage');
                    const order = parseInt(orderInput.value);
                    const magnitude = parseFloat(magnitudeInput.value);
                    
                    if (isNaN(order) || isNaN(magnitude) || order < 2 || magnitude < 0) {
                        displayMessage(`Invalid input for voltage harmonic: Order '${orderInput.value}' or Magnitude '${magnitudeInput.value}'. Please use valid numbers (order >= 2, magnitude >= 0).`, "error");
                        loadingSpinner.style.display = 'none';
                        return;
                    }
                    voltageHarmonics.push({ order, magnitude });
                });


                // Clear previous results and detailed calculations/tips
                resultTableBody.innerHTML = ''; 
                detailedCalculationsDiv.innerHTML = '<h3 class="text-xl font-semibold mb-3 text-gray-700 dark:text-white">Detailed Calculation Steps</h3>';
                harmonicReductionTipsDiv.style.display = 'none';
                harmonicChartContainer.style.display = 'none';
                document.getElementById('harmonic-bar-chart').innerHTML = ''; // Clear previous chart

                let currentCalculations = '';
                let voltageCalculations = '';
                let thd_current_percent = 0;
                let thd_voltage_percent = 0;
                let total_rms_current = fundamentalCurrent;
                let total_rms_voltage = fundamentalVoltage;
                
                // --- THD Current Calculation (THD_I) ---
                const sumOfSquaresOfCurrentHarmonics = currentHarmonics.reduce((sum, h) => sum + Math.pow(h.magnitude, 2), 0);
                const rmsOfCurrentHarmonics = Math.sqrt(sumOfSquaresOfCurrentHarmonics);

                if (fundamentalCurrent > 0) {
                    thd_current_percent = (rmsOfCurrentHarmonics / fundamentalCurrent) * 100;
                } else if (rmsOfCurrentHarmonics > 0) {
                    displayMessage("Fundamental current is zero, but harmonic currents are present. THD-I will be undefined.", "warning");
                    thd_current_percent = Infinity; // Represent as infinite if fundamental is zero but harmonics exist
                } else {
                    thd_current_percent = 0; // No harmonics, no fundamental, consider THD as 0 (or N/A)
                }

                total_rms_current = Math.sqrt(Math.pow(fundamentalCurrent, 2) + sumOfSquaresOfCurrentHarmonics);

                currentCalculations += `
                    <h4>Current THD Calculation:</h4>
                    <p><strong>Step 1.1:</strong> Sum of Squares of Harmonic Currents ($\Sigma I_{h}^{2}$)</p>
                    Formula: $\\Sigma I_{h}^{2} = I_{h1}^{2} + I_{h2}^{2} + \\dots + I_{hn}^{2}$<br>
                    Calculation: ${currentHarmonics.map(h => `(${h.magnitude.toFixed(2)} A)^2`).join(' + ')} = ${sumOfSquaresOfCurrentHarmonics.toFixed(2)} A^2$
                `;
                currentCalculations += `
                    <p><strong>Step 1.2:</strong> RMS Value of Harmonic Currents ($I_{rms,h}$)</p>
                    Formula: $I_{rms,h} = \\sqrt{\\Sigma I_{h}^{2}}$<br>
                    Calculation: $\\sqrt{${sumOfSquaresOfCurrentHarmonics.toFixed(2)} A^2} = ${rmsOfCurrentHarmonics.toFixed(2)} A$
                `;
                currentCalculations += `
                    <p><strong>Step 1.3:</strong> Total Harmonic Distortion of Current (THD-I)</p>
                    Formula: $\\text{THD}_{I} = \\left( \\frac{I_{rms,h}}{I_1} \\right) \\cdot 100\\%$<br>
                    Calculation: $\\left( \\frac{${rmsOfCurrentHarmonics.toFixed(2)} A}{${fundamentalCurrent.toFixed(2)} A} \\right) \\cdot 100\\% = ${thd_current_percent.toFixed(2)}\\%$
                `;
                currentCalculations += `
                    <p><strong>Step 1.4:</strong> Total RMS Current ($I_{RMS,Total}$)</p>
                    Formula: $I_{RMS,Total} = \\sqrt{I_1^2 + I_{rms,h}^2}$<br>
                    Calculation: $\\sqrt{(${fundamentalCurrent.toFixed(2)} A)^2 + (${rmsOfCurrentHarmonics.toFixed(2)} A)^2} = ${total_rms_current.toFixed(2)} A$
                `;
                
                // --- THD Voltage Calculation (THD_V) ---
                const sumOfSquaresOfVoltageHarmonics = voltageHarmonics.reduce((sum, h) => sum + Math.pow(h.magnitude, 2), 0);
                const rmsOfVoltageHarmonics = Math.sqrt(sumOfSquaresOfVoltageHarmonics);

                if (fundamentalVoltage > 0) {
                    thd_voltage_percent = (rmsOfVoltageHarmonics / fundamentalVoltage) * 100;
                } else if (rmsOfVoltageHarmonics > 0) {
                    displayMessage("Fundamental voltage is zero, but harmonic voltages are present. THD-V will be undefined.", "warning");
                    thd_voltage_percent = Infinity;
                } else {
                    thd_voltage_percent = 0;
                }

                total_rms_voltage = Math.sqrt(Math.pow(fundamentalVoltage, 2) + sumOfSquaresOfVoltageHarmonics);

                voltageCalculations += `
                    <h4 class="mt-4">Voltage THD Calculation:</h4>
                    <p><strong>Step 2.1:</strong> Sum of Squares of Harmonic Voltages ($\Sigma V_{h}^{2}$)</p>
                    Formula: $\\Sigma V_{h}^{2} = V_{h1}^{2} + V_{h2}^{2} + \\dots + V_{hn}^{2}$<br>
                    Calculation: ${voltageHarmonics.map(h => `(${h.magnitude.toFixed(2)} V)^2`).join(' + ')} = ${sumOfSquaresOfVoltageHarmonics.toFixed(2)} V^2$
                `;
                voltageCalculations += `
                    <p><strong>Step 2.2:</strong> RMS Value of Harmonic Voltages ($V_{rms,h}$)</p>
                    Formula: $V_{rms,h} = \\sqrt{\\Sigma V_{h}^{2}}$<br>
                    Calculation: $\\sqrt{${sumOfSquaresOfVoltageHarmonics.toFixed(2)} V^2} = ${rmsOfVoltageHarmonics.toFixed(2)} V$
                `;
                voltageCalculations += `
                    <p><strong>Step 2.3:</strong> Total Harmonic Distortion of Voltage (THD-V)</p>
                    Formula: $\\text{THD}_{V} = \\left( \\frac{V_{rms,h}}{V_1} \\right) \\cdot 100\\%$<br>
                    Calculation: $\\left( \\frac{${rmsOfVoltageHarmonics.toFixed(2)} V}{${fundamentalVoltage.toFixed(2)} V} \\right) \\cdot 100\\% = ${thd_voltage_percent.toFixed(2)}\\%$
                `;
                voltageCalculations += `
                    <p><strong>Step 2.4:</strong> Total RMS Voltage ($V_{RMS,Total}$)</p>
                    Formula: $V_{RMS,Total} = \\sqrt{V_1^2 + V_{rms,h}^2}$<br>
                    Calculation: $\\sqrt{(${fundamentalVoltage.toFixed(2)} V)^2 + (${rmsOfVoltageHarmonics.toFixed(2)} V)^2} = ${total_rms_voltage.toFixed(2)} V$
                `;

                // Display Individual Harmonic Distortion
                let ihdCalculations = '<h4 class="mt-4">Individual Harmonic Distortion (Current - IHD)</h4>';
                if (fundamentalCurrent > 0) {
                    currentHarmonics.sort((a,b) => a.order - b.order).forEach(h => {
                        const ihd = (h.magnitude / fundamentalCurrent) * 100;
                        ihdCalculations += `<p>IHD at Order ${h.order}: $\\text{IHD}_{${h.order}} = \\left( \\frac{I_{${h.order}}}{I_1} \\right) \\cdot 100\\% = \\left( \\frac{${h.magnitude.toFixed(2)} A}{${fundamentalCurrent.toFixed(2)} A} \\right) \\cdot 100\\% = ${ihd.toFixed(2)}\\%$</p>`;
                    });
                } else {
                    ihdCalculations += `<p>Individual Harmonic Distortion for Current cannot be calculated as fundamental current is zero.</p>`;
                }
                
                let vhdCalculations = '<h4 class="mt-4">Individual Harmonic Distortion (Voltage - VHD)</h4>';
                if (fundamentalVoltage > 0) {
                    voltageHarmonics.sort((a,b) => a.order - b.order).forEach(h => {
                        const vhd = (h.magnitude / fundamentalVoltage) * 100;
                        vhdCalculations += `<p>VHD at Order ${h.order}: $\\text{VHD}_{${h.order}} = \\left( \\frac{V_{${h.order}}}{V_1} \\right) \\cdot 100\\% = \\left( \\frac{${h.magnitude.toFixed(2)} V}{${fundamentalVoltage.toFixed(2)} V} \\right) \\cdot 100\\% = ${vhd.toFixed(2)}\\%$</p>`;
                    });
                } else {
                    vhdCalculations += `<p>Individual Harmonic Distortion for Voltage cannot be calculated as fundamental voltage is zero.</p>`;
                }


                // --- IEEE 519 Compliance Check ---
                const isc_il_ratio = (pccShortCircuitCurrentKA * 1000) / maxDemandLoadCurrent;
                let voltageLevelCategory = '';
                let thdVLmt = 0;
                let individualVLmt = 0;

                // Determine voltage level category for THD-V limits (IEEE 519-2014 Table 1)
                if (fundamentalVoltage < 1000) { // V < 1kV (LV system)
                    voltageLevelCategory = "Low Voltage (V < 1 kV)";
                    thdVLmt = 5.0; // %
                    individualVLmt = 3.0; // %
                } else if (fundamentalVoltage >= 1000 && fundamentalVoltage < 69000) { // 1kV <= V < 69kV (MV system)
                    voltageLevelCategory = "Medium Voltage (1 kV <= V < 69 kV)";
                    thdVLmt = 5.0; // %
                    individualVLmt = 3.0; // %
                } else if (fundamentalVoltage >= 69000 && fundamentalVoltage <= 161000) { // 69kV <= V <= 161kV (HV system)
                    voltageLevelCategory = "High Voltage (69 kV <= V <= 161 kV)";
                    thdVLmt = 2.5; // %
                    individualVLmt = 1.5; // %
                } else { // V > 161kV (EHV system)
                    voltageLevelCategory = "Extra-High Voltage (V > 161 kV)";
                    thdVLmt = 1.5; // %
                    individualVLmt = 1.0; // %
                }

                // Determine current distortion limits for THD-I (IEEE 519-2014 Table 2)
                let thdILmt = 0;
                let individualILmtOddNonTriple = 0;
                let individualILmtOddTriple = 0;
                let individualILmtEven = 0;

                // Simplified limits for current based on Isc/IL ratio (Table 2, typical PCC)
                if (isc_il_ratio < 20) {
                    thdILmt = 20.0; individualILmtOddNonTriple = 20.0; individualILmtOddTriple = 15.0; individualILmtEven = 10.0;
                } else if (isc_il_ratio >= 20 && isc_il_ratio < 50) {
                    thdILmt = 12.0; individualILmtOddNonTriple = 10.0; individualILmtOddTriple = 7.0; individualILmtEven = 5.0;
                } else if (isc_il_ratio >= 50 && isc_il_ratio < 100) {
                    thdILmt = 8.0; individualILmtOddNonTriple = 7.0; individualILmtOddTriple = 5.0; individualILmtEven = 4.0;
                } else if (isc_il_ratio >= 100 && isc_il_ratio < 1000) {
                    thdILmt = 5.0; individualILmtOddNonTriple = 4.0; individualILmtOddTriple = 3.0; individualILmtEven = 2.0;
                } else { // isc_il_ratio >= 1000
                    thdILmt = 5.0; individualILmtOddNonTriple = 4.0; individualILmtOddTriple = 3.0; individualILmtEven = 2.0; // Same as >100 for simplicity
                }

                let complianceText = `
                    <h4 class="mt-4">IEEE 519 (2014) Compliance Check:</h4>
                    <p><strong>PCC Short Circuit Current ($I_{SC}$):</strong> ${pccShortCircuitCurrentKA.toFixed(2)} kA</p>
                    <p><strong>Maximum Demand Load Current ($I_L$):</strong> ${maxDemandLoadCurrent.toFixed(2)} A</p>
                    <p><strong>$I_{SC}/I_L$ Ratio:</strong> ${isc_il_ratio.toFixed(2)}</p>
                    
                    <h5 class="mt-3">Voltage Distortion Limits (IEEE 519 Table 1)</h5>
                    <p><strong>Voltage Level Category:</strong> ${voltageLevelCategory}</p>
                    <p><strong>THD-V Limit:</strong> ${thdVLmt.toFixed(1)}%</p>
                    <p><strong>Individual VHD Limit:</strong> ${individualVLmt.toFixed(1)}% (for $h \\le 100$)</p>
                    <p>Calculated THD-V (${thd_voltage_percent.toFixed(2)}%) is ${thd_voltage_percent <= thdVLmt ? 'within' : '<strong class="text-red-600 dark:text-red-400">exceeding</strong>'} the limit.</p>
                    `;
                
                let thdICompliance = thd_current_percent <= thdILmt ? 'within' : '<strong class="text-red-600 dark:text-red-400">exceeding</strong>';

                complianceText += `
                    <h5 class="mt-3">Current Distortion Limits (IEEE 519 Table 2)</h5>
                    <p><strong>Based on $I_{SC}/I_L$ ratio of ${isc_il_ratio.toFixed(2)}:</strong></p>
                    <ul>
                        <li><strong>THD-I Limit:</strong> ${thdILmt.toFixed(1)}%</li>
                        <li><strong>Individual IHD Limit (Odd, Non-triple):</strong> ${individualILmtOddNonTriple.toFixed(1)}%</li>
                        <li><strong>Individual IHD Limit (Odd, Triple):</strong> ${individualILmtOddTriple.toFixed(1)}%</li>
                        <li><strong>Individual IHD Limit (Even):</strong> ${individualILmtEven.toFixed(1)}%</li>
                    </ul>
                    <p>Calculated THD-I (${thd_current_percent.toFixed(2)}%) is ${thdICompliance} the limit.</p>
                `;

                // Check individual current harmonic compliance
                let individualIHDComplianceText = '';
                if (fundamentalCurrent > 0) {
                    currentHarmonics.sort((a,b) => a.order - b.order).forEach(h => {
                        const ihd = (h.magnitude / fundamentalCurrent) * 100;
                        let limit = 0;
                        let type = '';
                        if (h.order % 2 === 0) { // Even
                            limit = individualILmtEven;
                            type = 'Even';
                        } else if (h.order % 3 === 0) { // Odd, Triple
                            limit = individualILmtOddTriple;
                            type = 'Odd (Triple)';
                        } else { // Odd, Non-Triple
                            limit = individualILmtOddNonTriple;
                            type = 'Odd (Non-Triple)';
                        }
                        const compliance = ihd <= limit ? 'within' : '<strong class="text-red-600 dark:text-red-400">exceeding</strong>';
                        individualIHDComplianceText += `<p>IHD at Order ${h.order} (${type}): ${ihd.toFixed(2)}% is ${compliance} the limit (${limit.toFixed(1)}%).</p>`;
                    });
                }
                complianceText += `<h5 class="mt-3">Individual Current Harmonic Compliance:</h5> ${individualIHDComplianceText || '<p>No current harmonics entered or fundamental current is zero.</p>'}`;

                // Check individual voltage harmonic compliance
                let individualVHDComplianceText = '';
                if (fundamentalVoltage > 0) {
                    voltageHarmonics.sort((a,b) => a.order - b.order).forEach(h => {
                        const vhd = (h.magnitude / fundamentalVoltage) * 100;
                        const compliance = vhd <= individualVLmt ? 'within' : '<strong class="text-red-600 dark:text-red-400">exceeding</strong>';
                        individualVHDComplianceText += `<p>VHD at Order ${h.order}: ${vhd.toFixed(2)}% is ${compliance} the limit (${individualVLmt.toFixed(1)}%).</p>`;
                    });
                }
                complianceText += `<h5 class="mt-3">Individual Voltage Harmonic Compliance:</h5> ${individualVHDComplianceText || '<p>No voltage harmonics entered or fundamental voltage is zero.</p>'}`;
                
                // Add detailed calculation steps to the div
                addDetailedCalculationStep("Full Calculation Steps", currentCalculations + voltageCalculations + ihdCalculations + vhdCalculations + complianceText, "");


                // Display Summary results
                addResultRow("Fundamental Current (I1)", fundamentalCurrent.toFixed(2) + " A");
                addResultRow("Total RMS Current (IRMS)", total_rms_current.toFixed(2) + " A");
                addResultRow("Total Harmonic Distortion - Current (THD-I)", thd_current_percent.toFixed(2) + " %");
                addResultRow("Fundamental Voltage (V1)", fundamentalVoltage.toFixed(2) + " V");
                addResultRow("Total RMS Voltage (VRMS)", total_rms_voltage.toFixed(2) + " V");
                addResultRow("Total Harmonic Distortion - Voltage (THD-V)", thd_voltage_percent.toFixed(2) + " %");
                addResultRow("PCC Short Circuit Current (ISC)", pccShortCircuitCurrentKA.toFixed(2) + " kA");
                addResultRow("Maximum Demand Load Current (IL)", maxDemandLoadCurrent.toFixed(2) + " A");
                addResultRow("ISC/IL Ratio", isc_il_ratio.toFixed(2));
                addResultRow("THD-V Limit (IEEE 519)", `${thdVLmt.toFixed(1)} % (Individual: ${individualVLmt.toFixed(1)} %)`);
                addResultRow("THD-I Limit (IEEE 519)", `${thdILmt.toFixed(1)} % (Based on Isc/IL)`);


                // Hide loading spinner and show results with animation
                loadingSpinner.style.display = 'none';
                resultContainer.style.display = 'block';
                resultContainer.classList.add('show');
                harmonicReductionTipsDiv.style.display = 'block'; // Show tips

                // Draw the harmonic spectrum chart
                drawHarmonicChart(fundamentalCurrent, currentHarmonics, fundamentalVoltage, voltageHarmonics);

                harmonicChartContainer.style.display = 'block'; // Show chart container
                setTimeout(() => {
                    harmonicChartContainer.classList.add('show');
                    resultContainer.scrollIntoView({ behavior: 'smooth' }); // Scroll to results
                }, 100); // Slight delay for chart to become visible

                // IMPORTANT: Tell MathJax to re-render the newly added content after a small delay
                if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
                    setTimeout(() => {
                        window.MathJax.typesetPromise([detailedCalculationsDiv]);
                    }, 50); 
                }
            });

            // Function to draw the harmonic spectrum bar chart
            function drawHarmonicChart(i1, currentHarms, v1, voltageHarms) {
                d3.select("#harmonic-bar-chart").selectAll("*").remove(); // Clear previous chart

                const margin = { top: 20, right: 30, bottom: 60, left: 60 },
                    width = Math.min(800, document.getElementById('harmonic-chart-container').offsetWidth - margin.left - margin.right),
                    height = 400 - margin.top - margin.bottom;

                const svg = d3.select("#harmonic-bar-chart")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                    .append("g")
                    .attr("transform", `translate(${margin.left},${margin.top})`);

                // Combine and sort all harmonics for charting, include fundamental
                const chartData = [];
                // Add fundamental components only if their magnitude is positive
                if (i1 > 0) chartData.push({ order: 1, type: 'current', magnitude: i1 });
                currentHarms.forEach(h => {
                    if (h.magnitude > 0) chartData.push({ order: h.order, type: 'current', magnitude: h.magnitude });
                });
                if (v1 > 0) chartData.push({ order: 1, type: 'voltage', magnitude: v1 });
                voltageHarms.forEach(h => {
                    if (h.magnitude > 0) chartData.push({ order: h.order, type: 'voltage', magnitude: h.magnitude });
                });

                // Get all unique orders present in the data, including 1 for fundamental
                const allOrders = [...new Set(chartData.map(d => d.order))].sort((a,b) => a-b);
                
                if (allOrders.length === 0) {
                     // No data to chart. Hide chart container and display a message.
                    harmonicChartContainer.style.display = 'none';
                    displayMessage("No harmonic data (current or voltage) provided to generate a chart.", "info");
                    return;
                }

                // Create x-scale (harmonic orders)
                const x = d3.scaleBand()
                    .domain(allOrders)
                    .range([0, width])
                    .padding(0.1);

                // Create y-scale (magnitudes)
                const maxMagnitude = d3.max(chartData, d => d.magnitude) || 1; // Default to 1 if no magnitudes > 0
                const y = d3.scaleLinear()
                    .domain([0, maxMagnitude * 1.1]) // 10% buffer
                    .range([height, 0]);

                // Add X axis
                svg.append("g")
                    .attr("transform", `translate(0,${height})`)
                    .call(d3.axisBottom(x).tickFormat(d => d === 1 ? "Fund." : d)) // Shorten "Fundamental"
                    .selectAll("text")
                    .style("text-anchor", "end")
                    .attr("dx", "-.8em")
                    .attr("dy", ".15em")
                    .attr("transform", "rotate(-45)");

                // Add Y axis
                svg.append("g")
                    .call(d3.axisLeft(y));

                // Add X axis label
                svg.append("text")
                    .attr("text-anchor", "middle")
                    .attr("x", width / 2)
                    .attr("y", height + margin.bottom - 10)
                    .style("fill", "var(--text-color)")
                    .text("Harmonic Order");

                // Add Y axis label
                svg.append("text")
                    .attr("text-anchor", "middle")
                    .attr("transform", "rotate(-90)")
                    .attr("y", -margin.left + 20)
                    .attr("x", -height / 2)
                    .style("fill", "var(--text-color)")
                    .text("Magnitude (A or V)");

                // Separate current and voltage data for bars
                const currentData = chartData.filter(d => d.type === 'current');
                const voltageData = chartData.filter(d => d.type === 'voltage');

                const barWidth = x.bandwidth();
                const barSpacing = 2; // Space between current and voltage bars
                const subBarWidth = (barWidth / 2) - (barSpacing / 2); // Width for each individual bar

                // Draw bars for Current Harmonics
                svg.selectAll(".bar-current")
                    .data(currentData)
                    .enter()
                    .append("rect")
                    .attr("class", "bar bar-current")
                    .attr("x", d => x(d.order) + barSpacing / 2) // Position for current bar
                    .attr("y", d => y(d.magnitude))
                    .attr("width", subBarWidth)
                    .attr("height", d => height - y(d.magnitude))
                    .attr("fill", "var(--primary-color)") // Green for current
                    .append("title") // Tooltip on hover
                    .text(d => `Current - Order ${d.order}: ${d.magnitude.toFixed(2)} A`);

                // Draw bars for Voltage Harmonics
                svg.selectAll(".bar-voltage")
                    .data(voltageData)
                    .enter()
                    .append("rect")
                    .attr("class", "bar bar-voltage")
                    .attr("x", d => x(d.order) + barWidth / 2 + barSpacing / 2) // Position for voltage bar
                    .attr("y", d => y(d.magnitude))
                    .attr("width", subBarWidth)
                    .attr("height", d => height - y(d.magnitude))
                    .attr("fill", "var(--accent-color)") // Amber for voltage
                    .append("title") // Tooltip on hover
                    .text(d => `Voltage - Order ${d.order}: ${d.magnitude.toFixed(2)} V`);

                // Add a legend
                const legend = svg.append("g")
                    .attr("class", "legend")
                    .attr("transform", `translate(${width - 100}, 10)`);

                legend.append("rect")
                    .attr("x", 0)
                    .attr("y", 0)
                    .attr("width", 10)
                    .attr("height", 10)
                    .attr("fill", "var(--primary-color)");

                legend.append("text")
                    .attr("x", 20)
                    .attr("y", 9)
                    .style("fill", "var(--text-color)")
                    .style("font-size", "12px")
                    .text("Current Harmonics");

                legend.append("rect")
                    .attr("x", 0)
                    .attr("y", 20)
                    .attr("width", 10)
                    .attr("height", 10)
                    .attr("fill", "var(--accent-color)");

                legend.append("text")
                    .attr("x", 20)
                    .attr("y", 29)
                    .style("fill", "var(--text-color)")
                    .style("font-size", "12px")
                    .text("Voltage Harmonics");
            }


            // Function to display messages (replaces alert())
            function displayMessage(message, type = "info") {
                let messageBox = document.getElementById('custom-message-box');
                if (!messageBox) {
                    messageBox = document.createElement('div');
                    messageBox.id = 'custom-message-box';
                    document.body.appendChild(messageBox);
                }

                messageBox.textContent = message;
                if (type === "error") {
                    messageBox.style.backgroundColor = '#dc3545'; /* Red */
                } else if (type === "warning") {
                    messageBox.style.backgroundColor = '#ffc107'; /* Amber */
                    messageBox.style.color = '#333';
                } else {
                    messageBox.style.backgroundColor = '#28a745'; /* Green */
                }
                messageBox.style.opacity = 1;

                // Hide after 5 seconds
                setTimeout(() => {
                    messageBox.style.opacity = 0;
                }, 5000);
            }

            // Helper function to add a row to the summary result table
            function addResultRow(parameter, value) {
                const row = document.createElement('tr');
                
                const paramCell = document.createElement('td');
                paramCell.textContent = parameter;
                paramCell.classList.add('font-medium');
                
                const valueCell = document.createElement('td');
                valueCell.textContent = value;
                
                row.appendChild(paramCell);
                row.appendChild(valueCell);
                
                resultTableBody.appendChild(row);
            }

            // Helper function to add a detailed calculation step
            function addDetailedCalculationStep(stepTitle, formulaText, calculationText) {
                const stepDiv = document.createElement('div');
                stepDiv.classList.add('calculation-step');

                const titleElem = document.createElement('h4');
                titleElem.textContent = stepTitle;
                stepDiv.appendChild(titleElem);

                if (formulaText) {
                    const formulaElem = document.createElement('p');
                    formulaElem.innerHTML = formulaText; 
                    stepDiv.appendChild(formulaElem);
                }

                if (calculationText) {
                    const calcElem = document.createElement('p');
                    calcElem.innerHTML = calculationText; // Use innerHTML to allow MathJax to process
                    stepDiv.appendChild(calcElem);
                }
                detailedCalculationsDiv.appendChild(stepDiv);
            }
        });
    </script>
</body>
</html>


