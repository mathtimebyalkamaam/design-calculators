<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Harmonic Distortion Calculator - Design Calculators - Electrical</title>
    <!-- SEO Meta Tags -->
    <meta name="description" content="Advanced harmonic distortion calculator. Calculates THD, TDD, and evaluates against IEEE 519 standards for industrial power quality.">
    <meta name="keywords" content="harmonic distortion, thd calculator, tdd calculator, ieee 519, power quality, harmonic filter, electrical engineering">
    <meta name="author" content="Design Calculators">
    <meta name="robots" content="index, follow">
    <!-- AdSense & Analytics -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5936527763614780" crossorigin="anonymous"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-23Y1V450SR"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-23Y1V450SR');
    </script>
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link ="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Montserrat:wght@700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" ="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- MathJax for Formulas -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['\\(', '\\)'], ['$', '$']],
                displayMath: [['\\[', '\\]'], ['$$', '$$']]
            },
            svg: { fontCache: 'global' },
            options: {
                processHtmlClass: 'math-content', // Process elements with this class
                ignoreHtmlClass: 'no-mathjax'     // Ignore elements with this class
            }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <!-- PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>
    <!-- D3.js for charts -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <style>
        :root {
            --primary: #1E3A8A;
            --secondary: #2563EB;
            --accent: #F59E0B;
            --success: #10B981;
            --danger: #DC2626;
            --warning: #F59E0B;
            --bg: #F8FAFC;
            --card: #FFFFFF;
            --text: #4B5563;
            --heading: #111827;
            --footer-bg: #0F172A;
            --border: #E2E8F0;
            --grad: linear-gradient(135deg, var(--primary), var(--secondary));
            --grad-dark: linear-gradient(135deg, #0F172A, #1E293B);
            --shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        body.dark-mode {
            --primary: #10B981;
            --secondary: #34D399;
            --bg: #0F172A;
            --card: #1E293B;
            --text: #CBD5E1;
            --heading: #F1F5F9;
            --footer-bg: #020617;
            --border: #334155;
        }

        * { box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.7;
            margin: 0;
            padding: 0;
        }

        .container { max-width: 1280px; margin: 0 auto; padding: 0 24px; }

        /* Header & Nav */
        header {
            background: var(--grad);
            color: white;
            padding: 24px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo-container {
            display: flex;
            flex-direction: column;
            text-decoration: none;
            color: white;
        }
        .logo-text {
            font-size: 1.75rem;
            font-weight: 800;
            font-family: 'Montserrat', sans-serif;
        }
        .logo-subtitle {
            font-size: 0.8rem;
            margin: 4px 0 0 0;
            color: #E0E7FF;
            opacity: 0.9;
        }
        .nav-links {
            display: flex;
            gap: 24px;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        .nav-links a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }
        .nav-links a:hover { color: var(--accent); }
        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .switch {
            position: relative;
            width: 56px;
            height: 30px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.2);
            transition: .4s;
            border-radius: 30px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--accent);
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        /* Main Content & Cards */
        main { padding: 40px 0; }
        .card {
            background: var(--card);
            border-radius: 12px;
            padding: 30px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            border: 1px solid var(--border);
        }
        h2 {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
            padding-bottom: 15px;
            margin-top: 0;
            font-family: 'Montserrat', sans-serif;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        h3 {
            color: var(--heading);
            font-family: 'Montserrat', sans-serif;
            font-size: 1.5rem;
            margin-top: 25px;
            margin-bottom: 20px;
        }
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--heading);
        }
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 6px;
            background-color: var(--bg);
            color: var(--text);
            font-size: 1rem;
        }
        .form-group input:focus,
        .form-group select:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
        }
        body.dark-mode .form-group input:focus {
             box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }
        
        .btn {
            background: var(--grad);
            color: white;
            border: none;
            padding: 16px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(30, 58, 138, 0.3);
            transition: all 0.3s;
            width: 100%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(30, 58, 138, 0.4);
        }
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .btn-group .btn {
            flex: 1;
            min-width: 150px;
        }
        .btn.secondary {
            background: var(--secondary);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }
        .btn.accent {
            background: var(--accent);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }
        .btn.danger {
            background: var(--danger);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
        }
        .btn.danger:hover {
            background: #B91C1C; /* Darker red */
            box-shadow: 0 8px 20px rgba(220, 38, 38, 0.4);
        }

        /* NEW STEP-BY-STEP STYLES */
        .steps-container {
            display: none;
            margin-top: 30px;
        }
        .steps-container.active {
            display: block;
        }
        .step-card {
            background: var(--card);
            border-radius: 12px;
            padding: 25px 30px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            animation: slideIn 0.6s ease-out;
            transition: all 0.3s;
            margin-bottom: 25px; /* Spacing between cards */
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .step-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }
        .step-card h4 {
            color: var(--primary);
            margin: 0 0 20px 0;
            font-size: 1.4rem;
            font-family: 'Montserrat', sans-serif;
            display: flex;
            align-items: center;
        }
        .step-card .number {
            display: inline-block;
            width: 40px;
            height: 40px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 40px;
            font-weight: 700;
            margin-right: 15px;
            font-size: 1.3rem;
            flex-shrink: 0;
        }
        .step-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            align-items: start;
        }
        @media (max-width: 768px) {
            .step-content {
                grid-template-columns: 1fr;
            }
        }
        .step-content .formula-block {
            background: var(--bg);
            border-radius: 8px;
            padding: 20px;
            font-size: 1rem;
            border: 1px solid var(--border);
        }
        .step-content .formula-block p {
            margin-top: 0;
        }
        .step-content .formula {
            background: var(--bg);
            border-left: 3px solid var(--accent);
            padding: 15px;
            margin: 12px 0;
            font-size: 1rem;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
        }


        /* Results */
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-radius: 8px;
            overflow: hidden;
        }
        .results-table th,
        .results-table td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        .results-table th {
            background: var(--grad);
            color: white;
            font-weight: 700;
        }
        .results-table tr:nth-child(even) {
            background-color: var(--bg);
        }
        .results-table td:first-child {
            font-weight: 600;
            color: var(--heading);
        }
        .results-table .highlight {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--success);
        }
        .results-table .highlight.fail {
            color: var(--danger);
        }

        /* Educational Section */
        .education-section {
            margin-top: 60px;
        }
        .insight-card {
            background: linear-gradient(135deg, var(--card), rgba(37,99,235,0.03));
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            border-left: 5px solid var(--secondary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: all 0.3s;
        }
        .insight-card:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .insight-card h4 {
            color: var(--secondary);
            font-size: 1.3rem;
            margin: 0 0 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .insight-card h4 i {
            font-size: 1.5rem;
        }
        .insight-card p {
            margin: 10px 0;
            line-height: 1.8;
        }
        .insight-card ul {
            padding-left: 20px;
            margin: 10px 0;
        }
        .insight-card li {
            margin-bottom: 10px;
        }
        .stat-highlight {
            display: inline-block;
            background: var(--accent);
            color: #333;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 700;
            margin: 0 4px;
        }
        .danger-box {
            background: linear-gradient(135deg, rgba(220,38,38,0.1), rgba(220,38,38,0.05));
            border-left: 5px solid var(--danger);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }
        .danger-box h4 {
            color: var(--danger);
            margin-top: 0;
        }
        .success-box {
            background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(16,185,129,0.05));
            border-left: 5px solid var(--success);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }
        .success-box h4 {
            color: var(--success);
            margin-top: 0;
        }


        /* Message Box */
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 16px 28px;
            border-radius: 8px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.25);
            z-index: 10000;
            font-weight: 600;
            color: white;
            opacity: 0;
            transition: all 0.4s;
            display: none;
        }
        .message-box.show {
            display: block;
            opacity: 1;
            top: 30px;
        }

        /* Footer */
        footer {
            background: var(--grad-dark);
            color: #CBD5E1;
            padding: 50px 0 20px 0;
            margin-top: 60px;
        }
        .footer-content {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 40px;
            margin-bottom: 30px;
        }
        .footer-col {
            flex: 1;
            min-width: 200px;
        }
        .footer-col h4 {
            color: white;
            margin-bottom: 15px;
            font-weight: 700;
        }
        .footer-col ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .footer-col a {
            color: #CBD5E1;
            text-decoration: none;
            transition: color 0.3s;
        }
        .footer-col a:hover {
            color: var(--accent);
        }
        .social-buttons {
            display: flex;
            gap: 12px;
            margin-top: 15px;
        }
        .social-btn {
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            border-radius: 50%;
            font-size: 1.1rem;
            transition: transform 0.3s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .social-btn:hover {
            transform: translateY(-4px);
        }
        .social-btn.linkedin { background-color: #0A66C2; }
        .social-btn.youtube { background-color: #FF0000; }
        .social-btn.twitter { background-color: #1DA1F2; }
        .social-btn.facebook { background-color: #1877F2; }
        .social-btn.whatsapp { background-color: #25D366; }
        .footer-disclaimer {
            text-align: center;
            padding-top: 25px;
            border-top: 1px solid #334155;
            max-width: 800px;
            margin: 0 auto;
            font-size: 0.9rem;
        }
        .footer-bottom {
            text-align: center;
            padding-top: 20px;
            font-size: 0.9rem;
            color: #94A3B8;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container { padding: 0 15px; }
            .navbar { flex-direction: column; gap: 20px; }
            .nav-links { flex-direction: column; gap: 12px; text-align: center; }
            .form-row { grid-template-columns: 1fr; }
            .card { padding: 20px; }
            .footer-content { flex-direction: column; gap: 25px; }
            .btn-group { flex-direction: column; }
        }
        .hidden { display: none; }
        
        /* Styles from old file to be merged */
        .harmonic-input-row {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            margin-bottom: 15px;
            opacity: 0; /* For animation */
            transform: translateY(20px); /* For animation */
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }
        .harmonic-input-row.show {
            opacity: 1;
            transform: translateY(0);
        }
        .harmonic-input-row .form-group {
            flex: 1;
            margin-bottom: 0; /* Adjust margin for row alignment */
        }
        
        .info-icon {
            color: var(--primary);
            margin-left: 5px;
            cursor: help;
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        /* Loading Spinner */
        .loading-spinner {
            display: none; /* Hidden by default */
            border: 4px solid var(--border);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Chart Styles */
        .bar {
            fill: var(--primary);
            transition: fill 0.3s ease-in-out;
        }
        .bar:hover {
            fill: var(--secondary);
        }
        .chart-text {
            fill: var(--text);
            font-size: 10px;
        }
        
        /* Compliance text styling */
        .compliance-fail {
            color: var(--danger);
            font-weight: 700;
        }
        .compliance-pass {
            color: var(--success);
            font-weight: 700;
        }

    </style>
</head>
<body>
    <div id="message-box" class="message-box"></div>

    <header>
        <div class="container">
            <nav class="navbar">
                <a ="index.html" class="logo-container">
                    <span class="logo-text">Design Calculators</span>
                    <p class="logo-subtitle">Inspired by standards such as IEC, IEEE, ISA, ASME, and API.</p>
                </a>
                <ul class="nav-links">
                    <li><a ="#">Home</a></li>
                    <li><a ="articles.html">Articles</a></li>
                    <li><a href="indexmech.html">Mechanical</a></li>
                    <li><a href="indexele.html">Electrical</a></li>
                    <li><a href="indexinst.html">Instrumentation</a></li>
                </ul>
                <div class="theme-toggle">
                    <i class="fas fa-sun"></i>
                    <label class="switch">
                        <input type="checkbox" id="theme-switch">
                        <span class="slider"></span>
                    </label>
                    <i class="fas fa-moon"></i>
                </div>
            </nav>
        </div>
    </header>

    <main class="container">
        <div class="card">
            <h2><i class="fas fa-wave-square"></i> Advanced Harmonic Distortion Calculator</h2>
            
            <p>This calculator estimates the Total Harmonic Distortion (THD) for both current and voltage, along with Individual Harmonic Distortion (IHD/VHD), based on user-defined harmonic orders and magnitudes. This is crucial for power quality assessment in accordance with international standards like <strong>IEEE 519</strong> and <strong>IEC 61000 series</strong>. It also provides a visual representation of the harmonic spectrum.</p>
            
            <div class="calculator-form">
                <form id="harmonic-distortion-form">
                    <h3>System & Load Parameters</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="fundamental-current">Fundamental Current (I1) (A) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The RMS current at the fundamental frequency (e.g., 50 Hz or 60 Hz).</span></span></label>
                            <input type="number" id="fundamental-current" min="0.01" step="0.01" value="100" required>
                        </div>
                        <div class="form-group">
                            <label for="fundamental-voltage">Fundamental Voltage (V1) (V) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The RMS voltage at the fundamental frequency.</span></span></label>
                            <input type="number" id="fundamental-voltage" min="0.01" step="0.01" value="240" required>
                        </div>
                    </div>
                    
                    <h3>Individual Harmonic Components (Current)</h3>
                    <div id="current-harmonics-container">
                        <!-- Dynamic current harmonic inputs will be appended here -->
                        <div class="harmonic-input-row show">
                            <div class="form-group">
                                <label>Order (h)</label>
                                <input type="number" class="harmonic-order-current" min="2" step="1" value="3" required>
                            </div>
                            <div class="form-group">
                                <label>Magnitude (Ih) (A)</label>
                                <input type="number" class="harmonic-magnitude-current" min="0" step="0.01" value="10" required>
                            </div>
                            <button type="button" class="remove-harmonic-btn btn danger" style="padding: 12px; margin-bottom: 0; align-self: center;"><i class="fas fa-trash-alt"></i></button>
                        </div>
                        <div class="harmonic-input-row show">
                            <div class="form-group">
                                <label>Order (h)</label>
                                <input type="number" class="harmonic-order-current" min="2" step="1" value="5" required>
                            </div>
                            <div class="form-group">
                                <label>Magnitude (Ih) (A)</label>
                                <input type="number" class="harmonic-magnitude-current" min="0" step="0.01" value="7" required>
                            </div>
                            <button type="button" class="remove-harmonic-btn btn danger" style="padding: 12px; margin-bottom: 0; align-self: center;"><i class="fas fa-trash-alt"></i></button>
                        </div>
                        <div class="harmonic-input-row show">
                            <div class="form-group">
                                <label>Order (h)</label>
                                <input type="number" class="harmonic-order-current" min="2" step="1" value="7" required>
                            </div>
                            <div class="form-group">
                                <label>Magnitude (Ih) (A)</label>
                                <input type="number" class="harmonic-magnitude-current" min="0" step="0.01" value="5" required>
                            </div>
                            <button type="button" class="remove-harmonic-btn btn danger" style="padding: 12px; margin-bottom: 0; align-self: center;"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>
                    <div class="btn-group" style="margin-top: 10px; justify-content: flex-start;">
                        <button type="button" id="add-current-harmonic-btn" class="btn secondary" style="flex: 0 1 auto; font-size: 1rem; padding: 10px 15px;"><i class="fas fa-plus"></i> Add Current Harmonic</button>
                    </div>

                    <h3 style="margin-top: 30px;">Individual Harmonic Components (Voltage)</h3>
                    <div id="voltage-harmonics-container">
                        <!-- Dynamic voltage harmonic inputs will be appended here -->
                        <div class="harmonic-input-row show">
                            <div class="form-group">
                                <label>Order (h)</label>
                                <input type="number" class="harmonic-order-voltage" min="2" step="1" value="3" required>
                            </div>
                            <div class="form-group">
                                <label>Magnitude (Vh) (V)</label>
                                <input type="number" class="harmonic-magnitude-voltage" min="0" step="0.01" value="5" required>
                            </div>
                            <button type="button" class="remove-harmonic-btn btn danger" style="padding: 12px; margin-bottom: 0; align-self: center;"><i class="fas fa-trash-alt"></i></button>
                        </div>
                        <div class="harmonic-input-row show">
                            <div class="form-group">
                                <label>Order (h)</label>
                                <input type="number" class="harmonic-order-voltage" min="2" step="1" value="5" required>
                            </div>
                            <div class="form-group">
                                <label>Magnitude (Vh) (V)</label>
                                <input type="number" class="harmonic-magnitude-voltage" min="0" step="0.01" value="3" required>
                            </div>
                            <button type="button" class="remove-harmonic-btn btn danger" style="padding: 12px; margin-bottom: 0; align-self: center;"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>
                    <div class="btn-group" style="margin-top: 10px; justify-content: flex-start;">
                        <button type="button" id="add-voltage-harmonic-btn" class="btn secondary" style="flex: 0 1 auto; font-size: 1rem; padding: 10px 15px;"><i class="fas fa-plus"></i> Add Voltage Harmonic</button>
                    </div>

                    <h3 style="margin-top: 30px;">IEEE 519 Standard Compliance Data</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="pcc-short-circuit-current">PCC Short Circuit Current ($I_{SC}$) (kA) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The maximum available symmetrical short-circuit current at the Point of Common Coupling (PCC). Usually in kiloamperes (kA).</span></span></label>
                            <input type="number" id="pcc-short-circuit-current" min="0.1" step="0.1" value="10" required>
                        </div>
                        <div class="form-group">
                            <label for="max-demand-load-current">Maximum Demand Load Current ($I_L$) (A) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The maximum demand load current at the PCC, for 15 or 30 minute average.</span></span></label>
                            <input type="number" id="max-demand-load-current" min="1" step="1" value="100" required>
                        </div>
                    </div>
                    
                    <div class="btn-group" style="margin-top: 25px;">
                        <button type="button" id="calculate-harmonic-btn" class="btn"><i class="fas fa-calculator"></i> Calculate Distortion</button>
                        <button type="button" id="reset-btn" class="btn accent"><i class="fas fa-sync-alt"></i> Reset</button>
                        <button type="button" id="pdf-btn" class="btn secondary" style="display: none;"><i class="fas fa-file-pdf"></i> Download PDF</button>
                    </div>
                    
                    <div id="loading-spinner" class="loading-spinner"></div>
                </form>
            </div>
        </div>

        <!-- RESULTS TABLE -->
        <div id="results-section" class="card hidden" style="margin-top: 40px;">
            <h3><i class="fas fa-clipboard-check"></i> Calculation Summary</h3>
            <table class="results-table">
                <thead>
                    <tr>
                        <th>Parameter</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody id="results-tbody">
                    <!-- Results will be dynamically inserted here -->
                </tbody>
            </table>
        </div>

        <!-- NEW Detailed calculations section -->
        <div id="steps-container" class="steps-container math-content">
            <!-- Step cards will be dynamically inserted here -->
        </div>

        <!-- Harmonic Spectrum Chart -->
        <div id="chart-card" class="card hidden">
            <h3><i class="fas fa-chart-bar"></i> Harmonic Spectrum Visualization</h3>
            <svg id="harmonic-bar-chart"></svg>
        </div>

        <!-- NEW/EXPANDED EDUCATIONAL INSIGHTS SECTION -->
        <div id="education-section" class="education-section card">
            <h2><i class="fas fa-lightbulb"></i> Professional Insights: Understanding Power Quality</h2>

            <div class="insight-card">
                <h4><i class="fas fa-exclamation-triangle"></i> What Are Harmonics? The "Dirty Power" Problem</h4>
                <p>Think of your electrical supply as a pure, clean sine wave (the "fundamental" 50 or 60 Hz). This is the "clean power" that all equipment is designed to use. Harmonics are additional, unwanted frequencies that are multiples of this fundamental (e.g., 3rd harmonic = 150 Hz, 5th = 250 Hz, 7th = 350 Hz, etc.).</p>
                <p>These extra frequencies distort the clean sine wave, creating "dirty power." This distortion is measured by <strong>Total Harmonic Distortion (THD)</strong>. A high THD is like trying to run a performance car on contaminated fuel—it causes inefficiency, stress, and eventual failure.</p>
                <p><strong>Current Harmonics (THD-I)</strong> are the *cause* of the problem, created by non-linear loads. <strong>Voltage Harmonics (THD-V)</strong> are the *effect* of those harmonic currents flowing through your system's impedance (wires, transformers). High THD-V is what ultimately damages other equipment on the same circuit.</p>
            </div>

            <div class="insight-card">
                <h4><i class="fas fa-industry"></i> Where Do Harmonics Come From? (Non-Linear Loads)</h4>
                <p>Harmonics are not generated by the utility. They are generated *inside* your facility by any equipment that doesn't draw current in a smooth, linear way. These are called <strong>non-linear loads</strong>, and they are everywhere in modern industry:</p>
                <ul>
                    <li><strong>Variable Frequency Drives (VFDs):</strong> The #1 source. Standard 6-pulse VFDs create large 5th, 7th, 11th, and 13th harmonics.</li>
                    <li><strong>Rectifiers & DC Power Supplies:</strong> Used in battery chargers, UPS systems, and welding machines.</li>
                    <li><strong>Electronics with Switch-Mode Power Supplies (SMPS):</strong> Every computer, server, and modern piece of office equipment.</li>
                    <li><strong>LED & Fluorescent Lighting:</strong> The electronic ballasts and drivers in modern lighting are non-linear loads, primarily creating 3rd harmonics.</li>
                </ul>
            </div>

            <div class="danger-box">
                <h4><i class="fas fa-fire"></i> Why Harmonics Are So Damaging</h4>
                <p>Ignoring harmonics is not an option. The long-term costs of "dirty power" are severe:</p>
                <ul>
                    <li><strong>Overheating Neutrals:</strong> "Triplen" harmonics (3rd, 9th, 15th) from single-phase loads add up in the neutral wire. A neutral wire designed for 100A might be forced to carry 150-200A of harmonic current, creating a major fire hazard.</li>
                    <li><strong>Transformer Failure:</strong> Harmonics cause extra eddy current and hysteresis losses in a transformer's core, leading to massive overheating (known as "K-factor" loading). A transformer running at 70% load can fail prematurely if that load is rich in harmonics.</li>
                    <li><strong>Nuisance Tripping:</strong> Breakers and fuses are designed to trip on high RMS current. Harmonics increase the RMS current without doing any useful work, leading to breakers tripping even when the "real" load seems fine.</li>
                    <li><strong>Capacitor Explosions:</strong> This is the most catastrophic failure. Capacitors have low impedance at high frequencies. They act like a "sink" for harmonics, drawing in massive harmonic currents they weren't designed for, causing them to overheat and fail violently. This is why standard PFC capacitors cannot be used in a harmonic environment.</li>
                    <li><strong>Equipment Malfunction:</strong> Sensitive electronics, PLCs, and control systems can misread the distorted voltage waveform, leading to random reboots, data corruption, and production downtime.</li>
                </ul>
            </div>
            
            <div class="insight-card">
                <h4><i class="fas fa-balance-scale"></i> THD vs. TDD: The Most Important Metric You're Not Tracking</h4>
                <p>This is a critical distinction in IEEE 519. Both are percentages, but they measure different things:</p>
                <p><strong>Total Harmonic Distortion (THD):</strong><br>
                $THD_I = \frac{\sqrt{\sum_{h=2}^{\infty} I_h^2}}{I_1}$</p>
                <p>THD measures the harmonic current *right now* as a percentage of the fundamental current *right now*. This number can be misleading. Imagine a large factory at 3 AM. The only thing running is one VFD at 10% speed. The fundamental current ($I_1$) is tiny, but the harmonic current is still present. This can result in a scary-looking THD of 80%, which isn't a problem because the *total* current is negligible.</p>
                <p><strong>Total Demand Distortion (TDD):</strong><br>
                $TDD = \frac{\sqrt{\sum_{h=2}^{\infty} I_h^2}}{I_L}$</p>
                <p>This is what IEEE 519 actually limits. TDD measures the harmonic current *right now* as a percentage of the <strong>Maximum Demand Load Current ($I_L$)</strong>—the peak current your facility draws over a 15- or 30-minute period. This is a much more stable and meaningful number. It measures your *actual* harmonic pollution against your facility's "size" on the grid. This calculator helps you check this critical TDD value.</p>
            </div>

            <div class="insight-card">
                <h4><i class="fas fa-book"></i> A Practical Guide to IEEE 519</h4>
                <p>The entire purpose of the IEEE 519 standard is to be a "good neighbor" on the electrical grid. It sets limits on how much harmonic "pollution" (current distortion) you can dump onto the grid at the <strong>Point of Common Coupling (PCC)</strong>—the spot where your facility connects to the utility or another customer.</p>
                <p>The standard has two parts:</p>
                <ol>
                    <li><strong>Your Responsibility (Current Harmonics):</strong> You must limit the harmonic *currents* you inject into the grid. The standard sets TDD limits based on your "stiffness."</li>
                    <li><strong>The Utility's Responsibility (Voltage Harmonics):</strong> The utility must provide you with "clean" power, limiting the *voltage* distortion (THD-V) at your connection point.</li>
                </ol>
                <p><strong>The $I_{SC} / I_L$ Ratio:</strong> This is the most important factor in IEEE 519.
                <ul>
                    <li><strong>$I_{SC}$ (Short Circuit Current):</strong> A measure of the utility's "stiffness" or power. A "strong" grid has a high $I_{SC}$.</li>
                    <li><strong>$I_L$ (Max Demand Current):</strong> A measure of your facility's "size" or maximum load.</li>
                </ul>
                The ratio $I_{SC} / I_L$ determines your limits. A small load on a very strong grid (high ratio) has very strict TDD limits because it's expected to be "cleaner." A very large load that makes up most of the grid's capacity (low ratio) is given more relaxed limits.</p>
            </div>

            <div class="insight-card">
                <h4><i class="fas fa-tools"></i> Tips for Reducing Harmonic Distortion (Mitigation)</h4>
                <p>If your TDD or THD-V is over the limit, you must install harmonic mitigation equipment. Here are the most common solutions, from simplest to most advanced:</p>
                <ul>
                    <li>
                        <strong>Line Reactors/Chokes:</strong> An inductor (coil) placed in front of a VFD. This is the simplest, cheapest solution. It "chokes" the harmonic currents, often reducing THD-I from ~80% down to ~35-40%. It also protects the VFD from voltage spikes.
                    </li>
                    <li>
                        <strong>Passive Harmonic Filters:</strong> A "filter trap" made of inductors and capacitors that is precisely tuned to "short-circuit" a specific harmonic (e.g., a 5th harmonic filter). They are effective and lower-cost but are tuned for a specific load. If the load changes, they can be less effective.
                    </li>
                    <li>
                        <strong>Multi-Pulse Rectifiers (12-pulse or 18-pulse):</strong> By using special transformers and more rectifiers, these high-end drives naturally cancel out the most damaging harmonics (5th, 7th, 11th, 13th). An 18-pulse drive can have a THD-I of less than 5% all by itself.
                    </li>
                    <li>
                        <strong>Active Harmonic Filters (AHF):</strong> The ultimate solution. An AHF is a high-speed computer that constantly measures the harmonic "noise" on your system. It then injects an exact *opposite* "anti-noise" waveform to perfectly cancel the harmonics, resulting in a clean sine wave. They are the most expensive solution but are incredibly effective and adapt to any load.
                    </li>
                </ul>
            </div>

        </div>

    </main>

    <!-- FOOTER -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-col">
                    <h4>Design Calculators</h4>
                    <p style="font-size: 0.9rem; line-height: 1.6; margin-bottom: 15px;">If you find this tool helpful, please consider sharing it with your colleagues!</p>
                    <div class="social-buttons">
                        <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn linkedin" title="LinkedIn"><i class="fab fa-linkedin-in"></i></a>
                        <a href="https://www.youtube.com/@designcalculators" target="_blank" rel="noopener noreferrer" class="social-btn youtube" title="YouTube"><i class="fab fa-youtube"></i></a>
                        <a href="https://twitter.com/intent/tweet?url=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn twitter" title="Twitter"><i class="fab fa-twitter"></i></a>
                        <a href="https://www.facebook.com/sharer/sharer.php?u=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn facebook" title="Facebook"><i class="fab fa-facebook-f"></i></a>
                        <a href="https://api.whatsapp.com/send?text=Check%20out%20this%20amazing%20engineering%20resource%20https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn whatsapp" title="WhatsApp"><i class="fab fa-whatsapp"></i></a>
                    </div>
                </div>
                <div class="footer-col">
                    <h4>Quick Links</h4>
                    <ul>
                        <li><a href="index.html">Home</a></li>
                        <li><a href="indexele.html">Electrical</a></li>
                        <li><a href="indexmech.html">Mechanical</a></li>
                        <li><a href="indexinst.html">Instrumentation</a></li>                   
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>Resources</h4>
                    <ul>
                        <li><a href="about.html">About Us</a></li>
                        <li><a href="contact.html">Contact</a></li>
                        <li><a href="faq.html">FAQ</a></li>
                        <li><a href="privacy-policy.html">Privacy Policy</a></li>
                        <li><a href="terms-of-service.html">Terms of Service</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>More</h4>
                    <ul>
                        <li><a href="articles.html">Articles & Whitepapers</a></li>
                        <li><a href="sitemap2.html">Sitemap</a></li>
                        <li><a href="https://www.youtube.com/@designcalculators" target="_blank" rel="noopener noreferrer">YouTube Channel</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-disclaimer">
                <p>All calculations are for preliminary engineering design guidance. Final harmonic filter installation must comply with IEEE 519, IEC 61000, and local electrical codes. Always perform a detailed power quality study with calibrated equipment before specifying or installing mitigation equipment. Consult with a licensed professional engineer before implementation.</p>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Design Calculators. Created by <span style="color: var(--secondary); font-weight: bold;">A Sharma</span>. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- Elements ---
            const form = document.getElementById('harmonic-distortion-form');
            const calculateBtn = document.getElementById('calculate-harmonic-btn');
            const resetBtn = document.getElementById('reset-btn');
            const pdfBtn = document.getElementById('pdf-btn');
            
            const resultsSection = document.getElementById('results-section');
            const resultsTbody = document.getElementById('results-tbody');
            const stepsContainer = document.getElementById('steps-container'); // New steps container
            const educationSection = document.getElementById('education-section');
            const chartCard = document.getElementById('chart-card');
            const loadingSpinner = document.getElementById('loading-spinner');

            const currentHarmonicsContainer = document.getElementById('current-harmonics-container');
            const voltageHarmonicsContainer = document.getElementById('voltage-harmonics-container');
            const addCurrentHarmonicBtn = document.getElementById('add-current-harmonic-btn');
            const addVoltageHarmonicBtn = document.getElementById('add-voltage-harmonic-btn');

            const themeSwitch = document.getElementById('theme-switch');
            const messageBox = document.getElementById('message-box');
            
            let lastInputs = null; // For PDF generation

            // --- Theme & Message Box Logic ---
            if (localStorage.getItem('theme') === 'dark') {
                document.body.classList.add('dark-mode');
                themeSwitch.checked = true;
            }
            themeSwitch.addEventListener('change', function() {
                if (this.checked) {
                    document.body.classList.add('dark-mode');
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.body.classList.remove('dark-mode');
                    localStorage.setItem('theme', 'light');
                }
            });

            function showMessage(msg, type = 'success') {
                messageBox.textContent = msg;
                if (type === 'error') {
                    messageBox.style.backgroundColor = 'var(--danger)';
                } else if (type === 'warning') {
                     messageBox.style.backgroundColor = 'var(--warning)';
                } else {
                    messageBox.style.backgroundColor = 'var(--success)';
                }
                messageBox.classList.add('show');
                setTimeout(() => messageBox.classList.remove('show'), 4000);
            }

            // --- Form Logic ---

            function addHarmonicInputRow(container, type, defaultOrder = '', defaultValue = '') {
                const newRow = document.createElement('div');
                newRow.classList.add('harmonic-input-row');
                newRow.innerHTML = `
                    <div class="form-group">
                        <label>Order (h)</label>
                        <input type="number" class="harmonic-order-${type}" min="2" step="1" value="${defaultOrder}" required>
                    </div>
                    <div class="form-group">
                        <label>Magnitude (${type === 'current' ? 'Ih' : 'Vh'}) (${type === 'current' ? 'A' : 'V'})</label>
                        <input type="number" class="harmonic-magnitude-${type}" min="0" step="0.01" value="${defaultValue}" required>
                    </div>
                    <button type="button" class="remove-harmonic-btn btn danger" style="padding: 12px; margin-bottom: 0; align-self: center;"><i class="fas fa-trash-alt"></i></button>
                `;
                container.appendChild(newRow);
                setTimeout(() => newRow.classList.add('show'), 10);
                newRow.querySelector('.remove-harmonic-btn').addEventListener('click', function() {
                    newRow.classList.remove('show');
                    newRow.addEventListener('transitionend', () => newRow.remove());
                });
            }

            document.querySelectorAll('.remove-harmonic-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const row = this.closest('.harmonic-input-row');
                    row.classList.remove('show');
                    row.addEventListener('transitionend', () => row.remove());
                });
            });

            addCurrentHarmonicBtn.addEventListener('click', () => addHarmonicInputRow(currentHarmonicsContainer, 'current'));
            addVoltageHarmonicBtn.addEventListener('click', () => addHarmonicInputRow(voltageHarmonicsContainer, 'voltage'));

            // --- Reset Logic ---
            resetBtn.addEventListener('click', function() {
                form.reset();
                // Remove dynamic rows
                document.querySelectorAll('#current-harmonics-container .harmonic-input-row, #voltage-harmonics-container .harmonic-input-row').forEach(row => {
                    row.classList.remove('show');
                    row.addEventListener('transitionend', () => row.remove());
                });
                
                // Hide all output sections
                resultsSection.classList.add('hidden');
                stepsContainer.classList.add('hidden');
                stepsContainer.innerHTML = ''; // Clear steps
                chartCard.classList.add('hidden');
                educationSection.classList.remove('hidden'); // Keep education visible
                pdfBtn.style.display = 'none';
                
                lastInputs = null;
                
                showMessage('Form reset', 'success');
            });
            
            // --- PDF Generation Logic ---
            pdfBtn.addEventListener('click', function() {
                if (!lastInputs) {
                    showMessage('Please run a calculation first.', 'error');
                    return;
                }
                
                try {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    let y = 15;
                    const { inputs, results } = lastInputs;

                    pdf.setFont('helvetica', 'bold');
                    pdf.setFontSize(16);
                    pdf.text('Harmonic Distortion Report', 105, y, { align: 'center' });
                    y += 8;

                    pdf.setFont('helvetica', 'normal');
                    pdf.setFontSize(9);
                    pdf.text(`Generated by Design Calculators | ${new Date().toLocaleString()}`, 105, y, { align: 'center' });
                    y += 10;
                    
                    pdf.setFont('helvetica', 'bold');
                    pdf.setFontSize(12);
                    pdf.text('Input Parameters', 14, y);
                    y += 2;
                    
                    const inputRows = [
                        ["Fundamental Current (I1)", `${inputs.fundamentalCurrent.toFixed(2)} A`],
                        ["Fundamental Voltage (V1)", `${inputs.fundamentalVoltage.toFixed(2)} V`],
                        ["PCC Short Circuit Current (ISC)", `${inputs.pccShortCircuitCurrentKA.toFixed(2)} kA`],
                        ["Maximum Demand Load (IL)", `${inputs.maxDemandLoadCurrent.toFixed(2)} A`]
                    ];
                    
                    pdf.autoTable({
                        startY: y,
                        head: [['Parameter', 'Value']],
                        body: inputRows,
                        margin: { left: 14, right: 14 },
                        theme: 'grid',
                        headStyles: { fillColor: [30, 58, 138] },
                    });
                    y = pdf.autoTable.previous.finalY + 10;

                    // Add Harmonic Inputs tables
                    if (inputs.currentHarmonics.length > 0) {
                        pdf.setFont('helvetica', 'bold');
                        pdf.setFontSize(12);
                        pdf.text('Input Current Harmonics', 14, y);
                        y += 2;
                        pdf.autoTable({
                            startY: y,
                            head: [['Order (h)', 'Magnitude (A)']],
                            body: inputs.currentHarmonics.map(h => [h.order, h.magnitude.toFixed(2)]),
                            margin: { left: 14, right: 14 },
                            theme: 'grid',
                            headStyles: { fillColor: [30, 58, 138] },
                        });
                        y = pdf.autoTable.previous.finalY + 10;
                    }

                    if (inputs.voltageHarmonics.length > 0) {
                        pdf.setFont('helvetica', 'bold');
                        pdf.setFontSize(12);
                        pdf.text('Input Voltage Harmonics', 14, y);
                        y += 2;
                        pdf.autoTable({
                            startY: y,
                            head: [['Order (h)', 'Magnitude (V)']],
                            body: inputs.voltageHarmonics.map(h => [h.order, h.magnitude.toFixed(2)]),
                            margin: { left: 14, right: 14 },
                            theme: 'grid',
                            headStyles: { fillColor: [30, 58, 138] },
                        });
                        y = pdf.autoTable.previous.finalY + 10;
                    }

                    // Add Results
                    pdf.setFont('helvetica', 'bold');
                    pdf.setFontSize(12);
                    pdf.text('Calculation Summary', 14, y);
                    y += 2;
                    
                    const resultRows = Array.from(resultsTbody.querySelectorAll('tr')).map(tr => [
                        tr.cells[0].textContent,
                        tr.cells[1].textContent
                    ]);
                    
                    pdf.autoTable({
                        startY: y,
                        head: [['Parameter', 'Value']],
                        body: resultRows,
                        margin: { left: 14, right: 14 },
                        theme: 'grid',
                        headStyles: { fillColor: [30, 58, 138] },
                        didParseCell: function (data) {
                            if (data.cell.text[0] && data.cell.text[0].includes('%')) {
                                const isFail = results[data.row.index] && results[data.row.index].isFail;
                                if(isFail) {
                                    data.cell.styles.textColor = [220, 38, 38]; // Red
                                } else {
                                    data.cell.styles.textColor = [16, 185, 129]; // Green
                                }
                                data.cell.styles.fontStyle = 'bold';
                            }
                        }
                    });
                    y = pdf.autoTable.previous.finalY + 15;

                    // Add footer
                    pdf.setFont('helvetica', 'normal');
                    pdf.setFontSize(10);
                    pdf.text('For more calculators and information, visit http://designcalculators.co.in', 105, y, { align: 'center' });
                    
                    pdf.save('Harmonic-Distortion-Report.pdf');
                    showMessage('PDF downloaded successfully');

                } catch (e) {
                    showMessage(`Error generating PDF: ${e.message}`, 'error');
                }
            });

            // --- Calculation Logic ---
            calculateBtn.addEventListener('click', async function() {
                loadingSpinner.style.display = 'block';
                resultsSection.classList.add('hidden');
                stepsContainer.classList.add('hidden');
                chartCard.classList.add('hidden');
                pdfBtn.style.display = 'none';
                stepsContainer.innerHTML = ''; // Clear old steps
                lastInputs = null; // Clear last inputs

                try {
                    // 1. Get Inputs
                    const fundamentalCurrent = parseFloat(document.getElementById('fundamental-current').value);
                    const fundamentalVoltage = parseFloat(document.getElementById('fundamental-voltage').value);
                    const pccShortCircuitCurrentKA = parseFloat(document.getElementById('pcc-short-circuit-current').value);
                    const maxDemandLoadCurrent = parseFloat(document.getElementById('max-demand-load-current').value);

                    if (isNaN(fundamentalCurrent) || isNaN(fundamentalVoltage) || isNaN(pccShortCircuitCurrentKA) || isNaN(maxDemandLoadCurrent)) {
                        throw new Error("Please enter valid numbers for all main input fields.");
                    }
                    if (fundamentalCurrent <= 0 && fundamentalVoltage <= 0) {
                        throw new Error("At least one fundamental magnitude (Current or Voltage) must be greater than zero.");
                    }
                    if (pccShortCircuitCurrentKA <= 0 || maxDemandLoadCurrent <= 0) {
                        throw new Error("PCC Short Circuit Current and Maximum Demand Load Current must be positive values.");
                    }

                    const currentHarmonics = [];
                    let invalidCurrentInput = false;
                    document.querySelectorAll('#current-harmonics-container .harmonic-input-row').forEach(row => {
                        const order = parseInt(row.querySelector('.harmonic-order-current').value);
                        const magnitude = parseFloat(row.querySelector('.harmonic-magnitude-current').value);
                        if (isNaN(order) || isNaN(magnitude) || order < 2 || magnitude < 0) invalidCurrentInput = true;
                        if(magnitude > 0) currentHarmonics.push({ order, magnitude });
                    });
                    if(invalidCurrentInput) throw new Error("Invalid input for current harmonics.");

                    const voltageHarmonics = [];
                    let invalidVoltageInput = false;
                    document.querySelectorAll('#voltage-harmonics-container .harmonic-input-row').forEach(row => {
                        const order = parseInt(row.querySelector('.harmonic-order-voltage').value);
                        const magnitude = parseFloat(row.querySelector('.harmonic-magnitude-voltage').value);
                        if (isNaN(order) || isNaN(magnitude) || order < 2 || magnitude < 0) invalidVoltageInput = true;
                        if(magnitude > 0) voltageHarmonics.push({ order, magnitude });
                    });
                    if(invalidVoltageInput) throw new Error("Invalid input for voltage harmonics.");
                    
                    // Store inputs for PDF
                    lastInputs = {
                        inputs: {
                            fundamentalCurrent, fundamentalVoltage, pccShortCircuitCurrentKA, maxDemandLoadCurrent,
                            currentHarmonics: currentHarmonics.sort((a,b) => a.order - b.order),
                            voltageHarmonics: voltageHarmonics.sort((a,b) => a.order - b.order)
                        },
                        results: [] // Will be populated
                    };

                    // 2. Calculations
                    const sumOfSquaresOfCurrentHarmonics = currentHarmonics.reduce((sum, h) => sum + Math.pow(h.magnitude, 2), 0);
                    const rmsOfCurrentHarmonics = Math.sqrt(sumOfSquaresOfCurrentHarmonics);
                    let thd_current_percent = (fundamentalCurrent > 0) ? (rmsOfCurrentHarmonics / fundamentalCurrent) * 100 : Infinity;
                    const total_rms_current = Math.sqrt(Math.pow(fundamentalCurrent, 2) + sumOfSquaresOfCurrentHarmonics);
                    
                    const sumOfSquaresOfVoltageHarmonics = voltageHarmonics.reduce((sum, h) => sum + Math.pow(h.magnitude, 2), 0);
                    const rmsOfVoltageHarmonics = Math.sqrt(sumOfSquaresOfVoltageHarmonics);
                    let thd_voltage_percent = (fundamentalVoltage > 0) ? (rmsOfVoltageHarmonics / fundamentalVoltage) * 100 : Infinity;
                    const total_rms_voltage = Math.sqrt(Math.pow(fundamentalVoltage, 2) + sumOfSquaresOfVoltageHarmonics);
                    
                    const isc_il_ratio = (pccShortCircuitCurrentKA * 1000) / maxDemandLoadCurrent;
                    
                    let voltageLevelCategory = '', thdVLmt = 0, individualVLmt = 0;
                    if (fundamentalVoltage < 1000) { voltageLevelCategory = "Low Voltage (V < 1 kV)"; thdVLmt = 5.0; individualVLmt = 3.0; }
                    else if (fundamentalVoltage < 69000) { voltageLevelCategory = "Medium Voltage (1 kV <= V < 69 kV)"; thdVLmt = 5.0; individualVLmt = 3.0; }
                    else if (fundamentalVoltage <= 161000) { voltageLevelCategory = "High Voltage (69 kV <= V <= 161 kV)"; thdVLmt = 2.5; individualVLmt = 1.5; }
                    else { voltageLevelCategory = "Extra-High Voltage (V > 161 kV)"; thdVLmt = 1.5; individualVLmt = 1.0; }

                    let thdILmt = 0, individualILmtOddNonTriple = 0, individualILmtOddTriple = 0, individualILmtEven = 0;
                    if (isc_il_ratio < 20) { thdILmt = 20.0; individualILmtOddNonTriple = 20.0; individualILmtOddTriple = 15.0; individualILmtEven = 10.0; }
                    else if (isc_il_ratio < 50) { thdILmt = 12.0; individualILmtOddNonTriple = 10.0; individualILmtOddTriple = 7.0; individualILmtEven = 5.0; }
                    else if (isc_il_ratio < 100) { thdILmt = 8.0; individualILmtOddNonTriple = 7.0; individualILmtOddTriple = 5.0; individualILmtEven = 4.0; }
                    else if (isc_il_ratio < 1000) { thdILmt = 5.0; individualILmtOddNonTriple = 4.0; individualILmtOddTriple = 3.0; individualILmtEven = 2.0; }
                    else { thdILmt = 5.0; individualILmtOddNonTriple = 4.0; individualILmtOddTriple = 3.0; individualILmtEven = 2.0; }

                    // 3. Populate Summary Table
                    resultsTbody.innerHTML = '';
                    lastInputs.results = []; // Reset PDF results
                    addResultRow("Fundamental Current (I1)", `${fundamentalCurrent.toFixed(2)} A`);
                    addResultRow("Total RMS Current (IRMS)", `${total_rms_current.toFixed(2)} A`);
                    addResultRow("THD - Current (THD-I)", `${thd_current_percent.toFixed(2)} %`, thd_current_percent > thdILmt);
                    addResultRow("Fundamental Voltage (V1)", `${fundamentalVoltage.toFixed(2)} V`);
                    addResultRow("Total RMS Voltage (VRMS)", `${total_rms_voltage.toFixed(2)} V`);
                    addResultRow("THD - Voltage (THD-V)", `${thd_voltage_percent.toFixed(2)} %`, thd_voltage_percent > thdVLmt);
                    addResultRow("ISC/IL Ratio", isc_il_ratio.toFixed(2));
                    addResultRow("THD-V Limit (IEEE 519)", `${thdVLmt.toFixed(1)} %`);
                    addResultRow("THD-I (TDD) Limit (IEEE 519)", `${thdILmt.toFixed(1)} %`);
                    
                    // --- Populate NEW Step-by-Step Cards ---
                    
                    // Step 1: Current Analysis
                    let step1Html = `
                        <div class="step-card">
                            <h4><span class="number">1</span>Current Distortion Analysis (THD-I)</h4>
                            <div class="step-content">
                                <div>
                                    <p>First, we calculate the <strong>Total Harmonic Distortion for Current (THD-I)</strong>. This measures the total "dirty" current from harmonics relative to the fundamental current.</p>
                                    <p>A high THD-I indicates that non-linear loads (like VFDs) are drawing heavily distorted current, which can lead to overheating and inefficiency.</p>
                                </div>
                                <div class="formula-block math-content">
                                    <p><strong>RMS of Harmonics ($I_{rms,h}$):</strong><br>
                                    $I_{rms,h} = \\sqrt{\\sum I_{h}^{2}}$<br>
                                    $I_{rms,h} = \\sqrt{${sumOfSquaresOfCurrentHarmonics.toFixed(2)}} = ${rmsOfCurrentHarmonics.toFixed(2)} A$</p>
                                    <p><strong>THD-I Calculation:</strong><br>
                                    $\\text{THD}_{I} = (I_{rms,h} / I_1) \\cdot 100\\%$<br>
                                    $\\text{THD}_{I} = (${rmsOfCurrentHarmonics.toFixed(2)} / ${fundamentalCurrent.toFixed(2)}) \\cdot 100\\% = $ <strong style="font-size: 1.2rem; color: var(${thd_current_percent > thdILmt ? '--danger' : '--success'});">${thd_current_percent.toFixed(2)}%</strong></p>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Step 2: Voltage Analysis
                    let step2Html = `
                        <div class="step-card">
                            <h4><span class="number">2</span>Voltage Distortion Analysis (THD-V)</h4>
                            <div class="step-content">
                                <div>
                                    <p>Next, we calculate the <strong>Total Harmonic Distortion for Voltage (THD-V)</strong>. This is the *result* of the harmonic currents (from Step 1) flowing through your system's impedance (wires, transformers).</p>
                                    <p>High THD-V is what damages other sensitive equipment connected to the same power bus. IEEE 519 sets strict limits on THD-V to protect all users on the grid.</p>
                                </div>
                                <div class="formula-block math-content">
                                    <p><strong>RMS of Harmonics ($V_{rms,h}$):</strong><br>
                                    $V_{rms,h} = \\sqrt{\\sum V_{h}^{2}}$<br>
                                    $V_{rms,h} = \\sqrt{${sumOfSquaresOfVoltageHarmonics.toFixed(2)}} = ${rmsOfVoltageHarmonics.toFixed(2)} V$</p>
                                    <p><strong>THD-V Calculation:</strong><br>
                                    $\\text{THD}_{V} = (V_{rms,h} / V_1) \\cdot 100\\%$<br>
                                    $\\text{THD}_{V} = (${rmsOfVoltageHarmonics.toFixed(2)} / ${fundamentalVoltage.toFixed(2)}) \\cdot 100\\% = $ <strong style="font-size: 1.2rem; color: var(${thd_voltage_percent > thdVLmt ? '--danger' : '--success'});">${thd_voltage_percent.toFixed(2)}%</strong></p>
                                </div>
                            </div>
                        </div>
                    `;

                    // Step 3: IEEE 519 Compliance
                    let step3Html = `
                        <div class="step-card">
                            <h4><span class="number">3</span>IEEE 519 Compliance Check</h4>
                            <div class="step-content">
                                <div>
                                    <p>Finally, we check your system against the <strong>IEEE 519 standard</strong>. The limits you must meet depend on your "stiffness" ratio ($I_{SC} / I_L$).</p>
                                    <p>This ratio compares the grid's strength ($I_{SC}$) to your maximum load ($I_L$). A low ratio means you are a "large" customer and have slightly looser limits, while a high ratio means you are a "small" customer and must be "cleaner".</p>
                                </div>
                                <div class="formula-block math-content">
                                    <p><strong>Stiffness Ratio ($I_{SC} / I_L$):</strong><br>
                                    $Ratio = (${pccShortCircuitCurrentKA.toFixed(2)} kA \\cdot 1000) / ${maxDemandLoadCurrent.toFixed(2)} A = $ <strong style="font-size: 1.2rem; color: var(--heading);">${isc_il_ratio.toFixed(2)}</strong></p>
                                    
                                    <p style="margin-top: 15px;"><strong>Voltage Compliance (THD-V):</strong><br>
                                    Your Limit: <strong>${thdVLmt.toFixed(1)}%</strong><br>
                                    Your Value: <strong class="${thd_voltage_percent <= thdVLmt ? 'compliance-pass' : 'compliance-fail'}">${thd_voltage_percent.toFixed(2)}%</strong></p>
                                    
                                    <p style="margin-top: 15px;"><strong>Current Compliance (TDD/THD-I):</strong><br>
                                    Your Limit: <strong>${thdILmt.toFixed(1)}%</strong><br>
                                    Your Value: <strong class="${thd_current_percent <= thdILmt ? 'compliance-pass' : 'compliance-fail'}">${thd_current_percent.toFixed(2)}%</strong></p>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    stepsContainer.innerHTML = step1Html + step2Html + step3Html;
                    
                    // 4. Draw Chart
                    drawHarmonicChart(fundamentalCurrent, currentHarmonics, fundamentalVoltage, voltageHarmonics);

                    // 5. Show sections
                    loadingSpinner.style.display = 'none';
                    resultsSection.classList.remove('hidden');
                    stepsContainer.classList.add('active'); // Show new steps
                    chartCard.classList.remove('hidden');
                    educationSection.classList.remove('hidden');
                    pdfBtn.style.display = 'inline-flex';

                    setTimeout(() => {
                        resultsSection.scrollIntoView({ behavior: 'smooth' });
                    }, 100); 

                    // 6. Typeset MathJax
                    if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
                        setTimeout(() => {
                            window.MathJax.typesetPromise([stepsContainer]);
                        }, 50); 
                    }
                    
                    showMessage("Calculation successful!", "success");

                } catch (e) {
                    showMessage(e.message, "error");
                    loadingSpinner.style.display = 'none';
                }
            });
            
            // Helper function to add a row to the summary result table
            function addResultRow(parameter, value, isFail = false) {
                const row = document.createElement('tr');
                const paramCell = document.createElement('td');
                paramCell.textContent = parameter;
                const valueCell = document.createElement('td');
                valueCell.innerHTML = `<strong>${value}</strong>`;
                
                if (parameter.includes('THD-I') || parameter.includes('THD-V')) {
                    valueCell.classList.add('highlight');
                    if (isFail) {
                        valueCell.classList.add('fail');
                    }
                    // Store for PDF
                    lastInputs.results.push({ parameter, value, isFail });
                } else {
                    lastInputs.results.push({ parameter, value, isFail: false });
                }
                
                row.appendChild(paramCell);
                row.appendChild(valueCell);
                resultsTbody.appendChild(row);
            }

            // Function to draw the harmonic spectrum bar chart
            function drawHarmonicChart(i1, currentHarms, v1, voltageHarms) {
                d3.select("#harmonic-bar-chart").selectAll("*").remove(); // Clear previous chart

                const margin = { top: 20, right: 30, bottom: 60, left: 60 },
                    containerWidth = document.getElementById('chart-card').offsetWidth,
                    width = Math.max(300, containerWidth - margin.left - margin.right - 40), // Adjust for padding
                    height = 400 - margin.top - margin.bottom;

                const svg = d3.select("#harmonic-bar-chart")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                    .append("g")
                    .attr("transform", `translate(${margin.left},${margin.top})`);

                const chartData = [];
                if (i1 > 0) chartData.push({ order: 1, type: 'current', magnitude: i1 });
                currentHarms.forEach(h => {
                    if (h.magnitude > 0) chartData.push({ order: h.order, type: 'current', magnitude: h.magnitude });
                });
                if (v1 > 0) chartData.push({ order: 1, type: 'voltage', magnitude: v1 });
                voltageHarms.forEach(h => {
                    if (h.magnitude > 0) chartData.push({ order: h.order, type: 'voltage', magnitude: h.magnitude });
                });

                const allOrders = [...new Set(chartData.map(d => d.order))].sort((a,b) => a-b);
                
                if (allOrders.length === 0) {
                    chartCard.classList.add('hidden');
                    showMessage("No harmonic data (current or voltage) provided to generate a chart.", "warning");
                    return;
                }

                const x = d3.scaleBand()
                    .domain(allOrders)
                    .range([0, width])
                    .padding(0.2); 

                const maxMagnitude = d3.max(chartData, d => d.magnitude) || 1;
                const y = d3.scaleLinear()
                    .domain([0, maxMagnitude * 1.1]) 
                    .range([height, 0]);

                svg.append("g")
                    .attr("transform", `translate(0,${height})`)
                    .call(d3.axisBottom(x).tickFormat(d => d === 1 ? "Fund." : d))
                    .selectAll("text")
                    .style("text-anchor", "end")
                    .attr("dx", "-.8em")
                    .attr("dy", ".15em")
                    .attr("transform", "rotate(-45)");

                svg.append("g").call(d3.axisLeft(y));

                svg.append("text")
                    .attr("text-anchor", "middle")
                    .attr("x", width / 2)
                    .attr("y", height + margin.bottom - 5)
                    .style("fill", "var(--text)")
                    .text("Harmonic Order");

                svg.append("text")
                    .attr("text-anchor", "middle")
                    .attr("transform", "rotate(-90)")
                    .attr("y", -margin.left + 20)
                    .attr("x", -height / 2)
                    .style("fill", "var(--text)")
                    .text("Magnitude (A or V)");

                const currentData = chartData.filter(d => d.type === 'current');
                const voltageData = chartData.filter(d => d.type === 'voltage');

                const barWidth = x.bandwidth();
                const barSpacing = 2; 
                const subBarWidth = (barWidth / 2) - (barSpacing / 2); 

                svg.selectAll(".bar-current")
                    .data(currentData)
                    .enter()
                    .append("rect")
                    .attr("class", "bar bar-current")
                    .attr("x", d => x(d.order) + barSpacing / 2) 
                    .attr("y", d => y(d.magnitude))
                    .attr("width", subBarWidth)
                    .attr("height", d => height - y(d.magnitude))
                    .attr("fill", "var(--primary)") 
                    .append("title") 
                    .text(d => `Current - Order ${d.order}: ${d.magnitude.toFixed(2)} A`);

                svg.selectAll(".bar-voltage")
                    .data(voltageData)
                    .enter()
                    .append("rect")
                    .attr("class", "bar bar-voltage")
                    .attr("x", d => x(d.order) + barWidth / 2 + barSpacing / 2) 
                    .attr("y", d => y(d.magnitude))
                    .attr("width", subBarWidth)
                    .attr("height", d => height - y(d.magnitude))
                    .attr("fill", "var(--accent)")
                    .append("title") 
                    .text(d => `Voltage - Order ${d.order}: ${d.magnitude.toFixed(2)} V`);

                const legend = svg.append("g")
                    .attr("class", "legend")
                    .attr("transform", `translate(${Math.max(0, width - 150)}, -10)`); 

                legend.append("rect")
                    .attr("x", 0)
                    .attr("y", 0)
                    .attr("width", 10)
                    .attr("height", 10)
                    .attr("fill", "var(--primary)");

                legend.append("text")
                    .attr("x", 20)
                    .attr("y", 9)
                    .style("fill", "var(--text)")
                    .style("font-size", "12px")
                    .text("Current Harmonics");

                legend.append("rect")
                    .attr("x", 0)
                    .attr("y", 20)
                    .attr("width", 10)
                    .attr("height", 10)
                    .attr("fill", "var(--accent)");

                legend.append("text")
                    .attr("x", 20)
                    .attr("y", 29)
                    .style("fill", "var(--text)")
                    .style("font-size", "12px")
                    .text("Voltage Harmonics");
            }
        });
    </script>
</body>
</html>

