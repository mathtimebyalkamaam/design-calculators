<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script> <!-- Placeholder for G-tag ID -->
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-XXXXXXXXXX'); // Placeholder for G-tag ID
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Valve Cv Calculator - Design Calculators - Instrumentation</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Basic CSS Variables for a consistent theme (Blue Only) */
        :root {
            --primary-color: #0056b3; /* A strong, professional blue */
            --secondary-color: #003f80; /* A darker shade of blue */
            --accent-color: #FFC107; /* Amber for warnings/highlights */
            --bg-color: #e6f2ff; /* Very light blue background */
            --card-bg: #ffffff; /* White card background */
            --text-color: #333333; /* Dark grey text */
            --header-bg: #ffffff; /* White for header */
            --footer-bg: #ffffff; /* White for footer */
            --border-color: #a0c3e6; /* Lighter blue border */
            --card-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            --hover-color: #d0e6ff; /* Lighter blue for hover states */
            --button-gradient: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            --button-hover-gradient: linear-gradient(45deg, var(--secondary-color), #00224d);
            --reset-button-bg: #FFC107; /* Amber for reset */
            --reset-button-hover-bg: #E0A800; /* Darker amber */
            --clear-button-bg: #6c757d; /* Grey for clear */
            --clear-button-hover-bg: #5a6268; /* Darker grey */
            --ok-color: #28a745; /* Green for OK status */
            --error-color: #dc3545; /* Red for error status */
            --warning-color: #ffc107; /* Amber for warnings */
        }

        /* Dark Mode Variables (Blue Only) */
        body.dark-mode {
            --bg-color: #1a2a40; /* Dark blue background */
            --card-bg: #2a3d54; /* Slightly lighter dark blue for cards */
            --text-color: #e0f2ff; /* Light blue text */
            --header-bg: #1a2a40; /* Keep dark for dark mode header */
            --footer-bg: #1a2a40; /* Keep dark for dark mode footer */
            --border-color: #3b506b;
            --card-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            --hover-color: #3b506b; /* Darker blue for hover */
            --button-gradient: linear-gradient(45deg, #003f80, #0056b3);
            --button-hover-gradient: linear-gradient(45deg, #0056b3, #006bb3);
            --reset-button-bg: #FFD700; /* Gold/Yellow for dark mode reset */
            --reset-button-hover-bg: #DAA520; /* Darker gold/yellow */
            --clear-button-bg: #5a6268; /* Darker grey for dark mode clear */
            --clear-button-hover-bg: #495057;
            --ok-color: #5cb85c;
            --error-color: #e74c3c;
            --warning-color: #DAA520;
        }

        /* General Body Styling */
        body {
            font-family: 'Inter', sans-serif; /* Using Inter as specified */
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, var(--bg-color), #c0d9ed); /* Gradient for depth */
            color: var(--text-color);
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 960px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: var(--header-bg);
            color: var(--text-color); /* Text color changes with background */
            padding: 20px 0;
            text-align: center;
            box-shadow: var(--card-shadow);
            position: relative; /* For theme toggle positioning */
        }

        header h1 {
            margin: 0;
            font-size: 2.5em;
            color: var(--primary-color); /* Maintain primary color for emphasis */
        }

        header .subtitle {
            margin: 5px 0 0;
            font-size: 1em;
            color: var(--text-color); /* Text color changes with background */
        }

        main {
            padding: 20px 0;
        }

        .tool-container {
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 20px;
            box-shadow: var(--card-shadow);
            margin-bottom: 20px;
            transition: transform 0.3s ease-in-out;
        }

        .tool-container:hover {
            transform: translateY(-5px);
        }

        .tool-container h2 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            margin-top: 0;
            margin-bottom: 20px;
        }

        .tool-description {
            margin-bottom: 20px;
            color: var(--text-color);
        }

        .back-button {
            display: inline-block;
            background-color: var(--primary-color);
            color: white;
            padding: 10px 15px;
            border-radius: 4px;
            text-decoration: none;
            margin-bottom: 20px;
            transition: background-color 0.3s, transform 0.3s;
            width: fit-content;
        }

        .back-button:hover {
            background-color: var(--secondary-color);
            transform: translateY(-3px);
        }

        /* Theme Toggle */
        .theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
        }

        .theme-toggle .light-icon,
        .theme-toggle .dark-icon {
            color: var(--text-color); /* Adjust icon color for white header */
            margin: 0 5px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
        }

        input:checked + .slider {
            background-color: var(--primary-color);
        }

        input:focus + .slider {
            box-shadow: 0 0 1px var(--primary-color);
        }

        input:checked + .slider:before {
            -webkit-transform: translateX(26px);
            -ms-transform: translateX(26px);
            transform: translateX(26px);
        }

        /* Rounded sliders */
        .slider.round {
            border-radius: 34px;
        }

        .slider.round:before {
            border-radius: 50%;
        }

        /* Footer Styling */
        footer {
            background-color: var(--footer-bg);
            color: var(--text-color); /* Text color changes with background */
            padding: 20px 0;
            text-align: center;
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1);
            margin-top: 30px;
        }

        footer .disclaimer h3,
        footer .social-share h3 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        footer .disclaimer p {
            font-size: 0.9em;
            color: var(--text-color); /* Text color changes with background */
        }

        .social-buttons {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .social-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            color: white;
            text-decoration: none;
            font-size: 1.2em;
            transition: transform 0.3s ease-in-out;
        }

        .social-btn:hover {
            transform: translateY(-3px);
        }

        .social-btn.linkedin { background-color: #0A66C2; }
        .social-btn.facebook { background-color: #1877F2; }
        .social-btn.twitter { background-color: #1DA1F2; }
        .social-btn.whatsapp { background-color: #25D366; }
        .social-btn.reddit { background-color: #FF4500; }

        /* Styles for Calculator Forms and Results */
        .calculator-form {
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: var(--card-shadow);
        }
        
        .form-section {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 25px; /* Space between sections */
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
            opacity: 0; /* Initial state for fade-in animation */
            transform: translateY(10px); /* Initial state for slide-up animation */
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }

        .form-section.fade-in {
            opacity: 1;
            transform: translateY(0);
        }

        .form-section h3 {
            color: var(--secondary-color);
            margin-top: 0;
            margin-bottom: 15px;
            border-bottom: 1px dashed var(--border-color);
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px; /* Default margin for form groups */
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--text-color);
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--card-bg); /* Use card-bg for input background */
            color: var(--text-color);
            box-sizing: border-box; /* Ensure padding doesn't increase width */
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Responsive grid */
            gap: 20px; /* Gap between grid items */
            margin-bottom: 0; /* Handled by form-group margin */
        }
        
        .calculate-btn {
            background: var(--button-gradient);
            color: white;
            border: none;
            padding: 12px 30px; /* Increased padding for better appearance */
            border-radius: 25px; /* More rounded */
            cursor: pointer;
            font-size: 1.1em; /* Slightly larger font */
            font-weight: bold;
            margin-top: 25px; /* More space above button */
            transition: background 0.3s ease-in-out, transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            width: auto; /* Allow button to size based on content and padding */
            min-width: 220px; /* Ensure a minimum width for consistency */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); /* More pronounced shadow */
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }
        
        .calculate-btn:hover {
            background: var(--button-hover-gradient);
            transform: translateY(-5px) scale(1.02); /* Lift and slightly scale */
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3); /* Deeper shadow on hover */
        }

        .reset-btn {
            background-color: var(--reset-button-bg);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            margin-top: 25px;
            margin-left: 15px; /* Space from calculate button */
            transition: background-color 0.3s ease-in-out, transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            width: auto;
            min-width: 150px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .reset-btn:hover {
            background-color: var(--reset-button-hover-bg);
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .clear-results-btn {
            background-color: var(--clear-button-bg);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
            margin-top: 15px;
            transition: background-color 0.3s ease-in-out, transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .clear-results-btn:hover {
            background-color: var(--clear-button-hover-bg);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .result-container {
            margin-top: 30px;
            padding: 20px;
            border-radius: 8px;
            background-color: var(--card-bg);
            box-shadow: var(--card-shadow);
            display: none; /* Hidden by default */
            opacity: 0; /* For animation */
            transform: translateY(20px); /* Initial state for animation */
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }
        
        .result-container.show {
            opacity: 1;
            transform: translateY(0);
        }

        .result-container h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            text-align: center;
        }
        
        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            border-radius: 8px;
            overflow: hidden; /* Ensures rounded corners apply to table content */
        }
        
        .result-table th, .result-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.3s;
        }
        
        .result-table th {
            background-color: var(--hover-color);
            font-weight: bold;
            color: var(--secondary-color);
        }

        .result-table tr:last-child td {
            border-bottom: none; /* No border for the last row */
        }

        .result-table tbody tr:hover {
            background-color: var(--hover-color); /* Highlight row on hover */
        }
        
        .standard-reference {
            margin-top: 20px;
            font-style: italic;
            font-size: 0.9rem;
            color: var(--text-color);
            padding: 10px;
            border-left: 4px solid var(--primary-color);
            background-color: var(--hover-color);
            border-radius: 4px;
        }
        
        .info-icon {
            color: var(--primary-color);
            margin-left: 5px;
            cursor: help;
            transition: color 0.3s;
        }

        .info-icon:hover {
            color: var(--accent-color);
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px; /* Increased padding */
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            transform: translateY(10px); /* Initial state for tooltip animation */
            font-size: 0.85em;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
            transform: translateY(0);
        }

        /* Custom message box style */
        #custom-message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            font-weight: bold;
            color: white;
            opacity: 0;
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            display: flex; /* Use flex for centering text */
            align-items: center;
            justify-content: center;
            min-width: 250px; /* Ensure it's wide enough */
        }

        /* Styles for calculation details */
        #calculation-details {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px; /* More rounded */
            padding: 20px; /* Increased padding */
            margin-bottom: 25px; /* More space */
            font-size: 0.95em;
            color: var(--text-color);
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05); /* Subtle inner shadow */
        }
        #calculation-details h4 {
            color: var(--secondary-color);
            margin-top: 0;
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.2em;
        }
        #calculation-details p.formula {
            font-family: 'Times New Roman', serif; /* A font suitable for mathematical formulas */
            font-style: italic;
            font-size: 1.1em;
            text-align: center;
            padding: 12px 10px; /* Increased padding */
            background-color: var(--hover-color);
            border-radius: 6px; /* More rounded */
            margin: 15px 0; /* More space */
            overflow-x: auto; /* Allow horizontal scrolling for long formulas */
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        #calculation-details p.calculation-step {
            font-family: 'Courier New', monospace; /* Monospace for steps */
            background-color: var(--hover-color);
            padding: 8px 15px; /* Increased padding */
            border-radius: 4px; /* More rounded */
            margin-bottom: 8px; /* More space */
            color: var(--text-color);
            white-space: pre-wrap; /* Preserve whitespace and wrap text */
            word-break: break-word; /* Break long words */
        }
        #calculation-details ul {
            list-style-type: disc;
            margin-left: 25px; /* Increased margin */
            padding-left: 0;
            margin-top: 15px;
        }
        #calculation-details ul li {
            margin-bottom: 8px; /* More space */
            color: var(--text-color);
        }

        /* Style for centering the button */
        .button-wrapper {
            display: flex;
            justify-content: center; /* Center the button horizontally */
            width: 100%; /* Ensure it takes full width to center effectively */
            padding-top: 20px; /* Add more spacing above the button */
        }

        /* Animation for input fields on focus */
        .form-group input:focus, .form-group select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(0, 86, 179, 0.4); /* Blue glow */
            outline: none;
            animation: pulse 0.8s infinite alternate;
        }

        @keyframes pulse {
            from {
                box-shadow: 0 0 0 4px rgba(0, 86, 179, 0.4);
            }
            to {
                box-shadow: 0 0 0 8px rgba(0, 86, 179, 0.2); /* Softer pulse */
            }
        }

        /* Status Display */
        .status-display {
            font-weight: bold;
            font-size: 1.1em;
            margin-top: 15px;
            padding: 10px 20px;
            border-radius: 5px;
            transition: background-color 0.5s, color 0.5s;
            text-align: center;
            width: 100%;
        }
        .status-display.optimal {
            background-color: var(--ok-color);
            color: white;
        }
        .status-display.sufficient {
            background-color: #66bb6a; /* Lighter green */
            color: white;
        }
        .status-display.adequate {
            background-color: #add8e6; /* Light blue */
            color: var(--text-color);
        }
        .status-display.marginal {
            background-color: var(--warning-color);
            color: var(--text-color);
        }
        .status-display.insufficient {
            background-color: var(--error-color);
            color: white;
        }

        /* Practical Recommendations Section */
        #practical-recommendations {
            margin-top: 20px;
            padding: 20px;
            border-radius: 8px;
            background-color: var(--bg-color);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }
        #practical-recommendations h4 {
            color: var(--secondary-color);
            margin-top: 0;
            margin-bottom: 15px;
            border-bottom: 1px dashed var(--border-color);
            padding-bottom: 10px;
        }
        #practical-recommendations ul {
            list-style-type: disc;
            margin-left: 25px;
            padding-left: 0;
        }
        #practical-recommendations ul li {
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>Design Calculators - Instrumentation</h1>
            <p class="subtitle">Smart Tools for Modern Instrumentation Engineers</p>
            <div class="theme-toggle">
                <span class="light-icon"><i class="fas fa-sun"></i></span>
                <label class="switch">
                    <input type="checkbox" id="theme-switch">
                    <span class="slider round"></span>
                </label>
                <span class="dark-icon"><i class="fas fa-moon"></i></span>
            </div>
        </div>
    </header>

    <main class="container">
        <div style="display: flex; justify-content: center; margin-bottom: 20px;">
            <a href="indexInst.html" class="back-button"><i class="fas fa-arrow-left"></i> Back to Tools</a>
        </div>
        
        <div class="tool-container">
            <h2>Control Valve Cv Calculator</h2>
            
            <div class="tool-description">
                <p>This calculator determines the flow coefficient (Cv) required for sizing control valves, ensuring optimal fluid control and system performance. It supports calculations for both liquid and gas/vapor applications under various operating conditions.</p>
            </div>
        
            <div class="calculator-form">
                <form id="cv-calculator-form">
                    <!-- Fluid Type Selection -->
                    <div class="form-section">
                        <h3>Fluid Type</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="fluid-type">Select Fluid Type</label>
                                <select id="fluid-type" required>
                                    <option value="liquid">Liquid</option>
                                    <option value="gas">Gas / Vapor</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Liquid Parameters Section (initially visible) -->
                    <div class="form-section" id="liquid-parameters">
                        <h3>Liquid Parameters</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="liquid-flow-rate">Flow Rate (Q)</label>
                                <input type="number" id="liquid-flow-rate" step="any" min="0" value="100" required>
                                <select id="liquid-flow-rate-unit">
                                    <option value="GPM">GPM</option>
                                    <option value="m3/hr">m³/hr</option>
                                    <option value="l/min">L/min</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="liquid-sg">Specific Gravity (G<sub>f</sub>) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Ratio of fluid density to water density at standard conditions. Water = 1.0.</span></span></label>
                                <input type="number" id="liquid-sg" step="0.01" min="0.01" value="1.0" required>
                            </div>
                            <div class="form-group">
                                <label for="liquid-inlet-pressure">Inlet Pressure (P<sub>1</sub>) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Absolute pressure upstream of the valve. Required for cavitation analysis.</span></span></label>
                                <input type="number" id="liquid-inlet-pressure" step="any" min="0.01" value="50" required>
                                <select id="liquid-inlet-pressure-unit">
                                    <option value="psia">psia</option>
                                    <option value="bara">bara</option>
                                    <option value="kPaa">kPaa</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="liquid-outlet-pressure">Outlet Pressure (P<sub>2</sub>) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Absolute pressure downstream of the valve. Required for cavitation analysis.</span></span></label>
                                <input type="number" id="liquid-outlet-pressure" step="any" min="0" value="40" required>
                                <select id="liquid-outlet-pressure-unit">
                                    <option value="psia">psia</option>
                                    <option value="bara">bara</option>
                                    <option value="kPaa">kPaa</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="liquid-vapor-pressure">Vapor Pressure (P<sub>v</sub>) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Absolute vapor pressure of the liquid at inlet temperature. Important for cavitation.</span></span></label>
                                <input type="number" id="liquid-vapor-pressure" step="any" min="0" value="0.5" required>
                                <select id="liquid-vapor-pressure-unit">
                                    <option value="psia">psia</option>
                                    <option value="bara">bara</option>
                                    <option value="kPaa">kPaa</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="liquid-critical-pressure">Critical Pressure (P<sub>c</sub>) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Absolute thermodynamic critical pressure of the liquid.</span></span></label>
                                <input type="number" id="liquid-critical-pressure" step="any" min="0" value="3200" required>
                                <select id="liquid-critical-pressure-unit">
                                    <option value="psia">psia</option>
                                    <option value="bara">bara</option>
                                    <option value="kPaa">kPaa</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="liquid-fl">Liquid Pressure Recovery Factor (F<sub>L</sub>) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Accounts for pressure recovery in the valve. Typically 0.6 to 0.95. For water, often 0.9.</span></span></label>
                                <input type="number" id="liquid-fl" step="0.01" min="0.1" max="1.0" value="0.9" required>
                            </div>
                            <div class="form-group">
                                <label for="liquid-ff">Liquid Critical Pressure Ratio Factor (F<sub>F</sub>) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Accounts for liquid critical pressure ratio. Often approximated as 0.96 for water.</span></span></label>
                                <input type="number" id="liquid-ff" step="0.01" min="0.1" max="1.0" value="0.96" required>
                            </div>
                            <div class="form-group">
                                <label for="liquid-viscosity">Viscosity (μ) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Dynamic viscosity of the liquid (e.g., in Centipoise, cP). Primarily affects very low flow Cv.</span></span></label>
                                <input type="number" id="liquid-viscosity" step="0.01" min="0" value="1.0" required>
                                <span class="unit">cP</span>
                            </div>
                        </div>
                    </div>

                    <!-- Gas/Vapor Parameters Section (initially hidden) -->
                    <div class="form-section" id="gas-parameters" style="display: none;">
                        <h3>Gas / Vapor Parameters</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="gas-flow-rate">Flow Rate (Q)</label>
                                <input type="number" id="gas-flow-rate" step="any" min="0" value="1000" required>
                                <select id="gas-flow-rate-unit">
                                    <option value="SCFH">SCFH</option>
                                    <option value="Nm3/hr">Nm³/hr</option>
                                    <option value="kg/hr">kg/hr</option>
                                    <option value="lb/hr">lb/hr</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="gas-inlet-pressure">Inlet Pressure (P<sub>1</sub>)</label>
                                <input type="number" id="gas-inlet-pressure" step="any" min="0.01" value="100" required>
                                <select id="gas-pressure-unit">
                                    <option value="psia">psia</option>
                                    <option value="bara">bara</option>
                                    <option value="kPaa">kPaa</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="gas-outlet-pressure">Outlet Pressure (P<sub>2</sub>)</label>
                                <input type="number" id="gas-outlet-pressure" step="any" min="0" value="90" required>
                                <select id="gas-pressure-unit-2">
                                    <option value="psia">psia</option>
                                    <option value="bara">bara</option>
                                    <option value="kPaa">kPaa</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="gas-temperature">Temperature (T)</label>
                                <input type="number" id="gas-temperature" step="any" value="60" required>
                                <select id="gas-temperature-unit">
                                    <option value="F">°F</option>
                                    <option value="C">°C</option>
                                    <option value="K">K</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="gas-mw">Molecular Weight (M<sub>w</sub>) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Average molecular weight of the gas. Air ≈ 29.</span></span></label>
                                <input type="number" id="gas-mw" step="0.1" min="1" value="29" required>
                            </div>
                            <div class="form-group">
                                <label for="gas-cf">Critical Flow Factor (C<sub>f</sub>) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Accounts for pressure recovery in the valve. Typically 0.85 to 0.95.</span></span></label>
                                <input type="number" id="gas-cf" step="0.01" min="0.1" max="1.0" value="0.87" required>
                            </div>
                            <div class="form-group">
                                <label for="gas-k">Ratio of Specific Heats (k) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Adiabatic index. For air, k ≈ 1.4.</span></span></label>
                                <input type="number" id="gas-k" step="0.01" min="1.0" value="1.4" required>
                            </div>
                            <div class="form-group">
                                <label for="gas-z">Compressibility Factor (Z) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Accounts for deviation from ideal gas behavior. Z=1 for ideal gases.</span></span></label>
                                <input type="number" id="gas-z" step="0.01" min="0.1" value="1.0" required>
                            </div>
                        </div>
                    </div>

                    <div class="button-wrapper">
                        <button type="button" id="calculate-btn" class="calculate-btn">Calculate Cv</button>
                        <button type="button" id="reset-form-btn" class="reset-btn"><i class="fas fa-sync-alt"></i> Reset Form</button>
                    </div>
                </form>
            </div>

            <div id="result-container" class="result-container">
                <h3>Calculation Results</h3>
                <p class="status-display" id="cv-status-display">Cv Calculation Status: N/A</p>

                <div id="calculation-details">
                    <h4>Step-by-Step Calculation</h4>
                    <p class="formula" id="cv-formula">
                        <!-- Formula will be dynamically inserted here -->
                    </p>
                    <div id="steps-list">
                        <!-- Calculation steps will be inserted here -->
                    </div>
                </div>

                <table class="result-table">
                    <thead>
                        <tr>
                            <th>Parameter</th>
                            <th>Value</th>
                        </tr>
                    </thead>
                    <tbody id="result-table-body">
                        <!-- Results will be dynamically inserted here -->
                    </tbody>
                </table>

                <div id="practical-recommendations" style="display: none;">
                    <h4>Practical Considerations & Recommendations</h4>
                    <ul id="recommendations-list">
                        <!-- Recommendations will be dynamically inserted here -->
                    </ul>
                </div>

                <div style="display: flex; justify-content: center; margin-top: 20px;">
                    <button type="button" id="clear-results-btn" class="clear-results-btn"><i class="fas fa-times-circle"></i> Clear Results</button>
                </div>
                <div class="standard-reference">
                    <p><strong>Applicable Standards and Guidelines:</strong> Control valve sizing is a critical aspect of process control design. Key standards and considerations include:</p>
                    <ul>
                        <li><strong>ISA-75.01.01 (IEC 60534-2-1):</strong> Industrial-Process Control Valves - Part 2-1: Flow Capacity - Sizing Equations for Liquid Flow Under Installed Conditions.</li>
                        <li><strong>ISA-75.01.01 (IEC 60534-2-1):</strong> Industrial-Process Control Valves - Part 2-1: Flow Capacity - Sizing Equations for Gaseous Fluids.</li>
                        <li><strong>ISA-75.01.01 (IEC 60534-2-1):</strong> Industrial-Process Control Valves - Part 2-1: Flow Capacity - Sizing Equations for Vapors.</li>
                        <li><strong>Valve Type and Characteristics:</strong> Different valve types (e.g., globe, ball, butterfly) have different inherent flow characteristics.</li>
                        <li><strong>Fluid Properties:</strong> Viscosity, flashing, and cavitation for liquids; compressibility and choked flow for gases.</li>
                        <li><strong>Noise and Cavitation Prediction:</strong> Sizing should also consider potential noise levels and the risk of cavitation, especially for liquids.</li>
                        <li><strong>Rangeability:</strong> The ratio of maximum to minimum controllable flow.</li>
                        <li><strong>Turn-down Ratio:</strong> The ratio of maximum to minimum flow required by the process.</li>
                        <li><strong>Pressure Recovery Factor (F<sub>L</sub> or C<sub>f</sub>):</strong> Important for predicting choked flow and cavitation.</li>
                    </ul>
                    <p>This tool provides an initial estimate for Cv. A detailed valve selection should always involve consulting manufacturer's data, specific application requirements, and adherence to relevant industry standards.</p>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <div class="disclaimer">
                <h3>Disclaimer</h3>
                <p>To ensure accuracy and reliability, always verify the results obtained from these tools against the relevant engineering standards and guidelines.</p>
            </div>
            <div class="credit">
                <p>Created by A Sharma</p>
            </div>
            <div class="social-share">
                <h3>Share This Site</h3>
                <div class="social-buttons">
                    <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://designcalculators.co.in&title=Design Calculators" target="_blank" class="social-btn linkedin">
                        <i class="fab fa-linkedin"></i>
                    </a>
                    <a href="https://www.facebook.com/sharer/sharer.php?u=https://designcalculators.co.in" target="_blank" class="social-btn facebook">
                        <i class="fab fa-facebook"></i>
                    </a>
                    <a href="https://twitter.com/intent/tweet?text=Check out this amazing Design Calculators!&url=https://designcalculators.co.in" target="_blank" class="social-btn twitter">
                        <i class="fab fa-twitter"></i>
                    </a>
                    <a href="https://api.whatsapp.com/send?text=Check out this amazing Design Calculators! https://designcalculators.co.in" target="_blank" class="social-btn whatsapp">
                        <i class="fab fa-whatsapp"></i>
                    </a>
                    <a href="https://www.reddit.com/submit?url=https://designcalculators.co.in&title=Design Calculators" target="_blank" class="social-btn reddit">
                        <i class="fab fa-reddit"></i>
                    </a>
                </div>
            </div>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Input elements
            const fluidTypeSelect = document.getElementById('fluid-type');
            const liquidParametersSection = document.getElementById('liquid-parameters');
            const gasParametersSection = document.getElementById('gas-parameters');

            // Liquid Inputs
            const liquidFlowRateInput = document.getElementById('liquid-flow-rate');
            const liquidFlowRateUnit = document.getElementById('liquid-flow-rate-unit');
            const liquidSGInput = document.getElementById('liquid-sg');
            const liquidInletPressureInput = document.getElementById('liquid-inlet-pressure'); // New
            const liquidInletPressureUnit = document.getElementById('liquid-inlet-pressure-unit'); // New
            const liquidOutletPressureInput = document.getElementById('liquid-outlet-pressure'); // New
            const liquidOutletPressureUnit = document.getElementById('liquid-outlet-pressure-unit'); // New
            const liquidVaporPressureInput = document.getElementById('liquid-vapor-pressure');
            const liquidVaporPressureUnit = document.getElementById('liquid-vapor-pressure-unit');
            const liquidCriticalPressureInput = document.getElementById('liquid-critical-pressure');
            const liquidCriticalPressureUnit = document.getElementById('liquid-critical-pressure-unit');
            const liquidFLInput = document.getElementById('liquid-fl');
            const liquidFFInput = document.getElementById('liquid-ff');
            const liquidViscosityInput = document.getElementById('liquid-viscosity');

            // Gas Inputs
            const gasFlowRateInput = document.getElementById('gas-flow-rate');
            const gasFlowRateUnit = document.getElementById('gas-flow-rate-unit');
            const gasInletPressureInput = document.getElementById('gas-inlet-pressure');
            const gasPressureUnit = document.getElementById('gas-pressure-unit'); // For P1
            const gasOutletPressureInput = document.getElementById('gas-outlet-pressure');
            const gasPressureUnit2 = document.getElementById('gas-pressure-unit-2'); // For P2
            const gasTemperatureInput = document.getElementById('gas-temperature');
            const gasTemperatureUnit = document.getElementById('gas-temperature-unit');
            const gasMWInput = document.getElementById('gas-mw');
            const gasCfInput = document.getElementById('gas-cf');
            const gasKInput = document.getElementById('gas-k');
            const gasZInput = document.getElementById('gas-z'); // New (Compressibility Factor)

            // Buttons and result containers
            const calculateBtn = document.getElementById('calculate-btn');
            const resetFormBtn = document.getElementById('reset-form-btn');
            const clearResultsBtn = document.getElementById('clear-results-btn');
            const resultContainer = document.getElementById('result-container');
            const resultTableBody = document.getElementById('result-table-body');
            const cvStatusDisplay = document.getElementById('cv-status-display');
            const calculationDetailsDiv = document.getElementById('calculation-details');
            const cvFormula = document.getElementById('cv-formula');
            const stepsList = document.getElementById('steps-list');
            const practicalRecommendationsDiv = document.getElementById('practical-recommendations');
            const recommendationsList = document.getElementById('recommendations-list');

            // Default values for resetting form
            const defaultValues = {
                'fluid-type': 'liquid',
                'liquid-flow-rate': 100,
                'liquid-flow-rate-unit': 'GPM',
                'liquid-sg': 1.0,
                'liquid-inlet-pressure': 50, // New default
                'liquid-inlet-pressure-unit': 'psia', // New default
                'liquid-outlet-pressure': 40, // New default
                'liquid-outlet-pressure-unit': 'psia', // New default
                'liquid-vapor-pressure': 0.5,
                'liquid-vapor-pressure-unit': 'psia',
                'liquid-critical-pressure': 3200,
                'liquid-critical-pressure-unit': 'psia',
                'liquid-fl': 0.9,
                'liquid-ff': 0.96,
                'liquid-viscosity': 1.0,
                'gas-flow-rate': 1000,
                'gas-flow-rate-unit': 'SCFH',
                'gas-inlet-pressure': 100,
                'gas-outlet-pressure': 90,
                'gas-pressure-unit': 'psia',
                'gas-pressure-unit-2': 'psia', // Ensure this is also reset
                'gas-temperature': 60,
                'gas-temperature-unit': 'F',
                'gas-mw': 29,
                'gas-cf': 0.87,
                'gas-k': 1.4,
                'gas-z': 1.0
            };

            // Function to display custom messages
            function showCustomMessage(message, type = 'info') {
                let messageBox = document.getElementById('custom-message-box');
                if (!messageBox) {
                    messageBox = document.createElement('div');
                    messageBox.id = 'custom-message-box';
                    document.body.appendChild(messageBox);
                }
                messageBox.textContent = message;
                messageBox.className = ''; // Clear previous classes
                messageBox.classList.add(type); // Add type for styling (e.g., 'error', 'success', 'info')

                if (type === 'error') {
                    messageBox.style.backgroundColor = '#dc3545'; // Red
                } else if (type === 'success') {
                    messageBox.style.backgroundColor = '#28a745'; // Green
                } else {
                    messageBox.style.backgroundColor = 'var(--primary-color)'; // Blue (default info)
                }

                messageBox.style.opacity = '1';
                messageBox.style.transform = 'translateX(-50%) translateY(0)'; // Slide down animation

                setTimeout(() => {
                    messageBox.style.opacity = '0';
                    messageBox.style.transform = 'translateX(-50%) translateY(-20px)'; // Slide up animation
                }, 3000);
            }

            // Function to toggle parameter sections based on fluid type
            function toggleFluidParameters() {
                if (fluidTypeSelect.value === 'liquid') {
                    liquidParametersSection.style.display = 'block';
                    gasParametersSection.style.display = 'none';
                } else {
                    liquidParametersSection.style.display = 'none';
                    gasParametersSection.style.display = 'block';
                }
            }

            // Event listener for fluid type change
            fluidTypeSelect.addEventListener('change', toggleFluidParameters);

            // Unit Conversion Functions
            // Pressure: To psia
            function convertPressureToPsia(value, unit) {
                switch (unit) {
                    case 'psia': return value;
                    case 'bar': return value * 14.50377; // bar to psia
                    case 'bara': return value * 14.50377; // bara to psia (absolute pressure)
                    case 'kPa': return value * 0.1450377; // kPa to psia
                    case 'kPaa': return value * 0.1450377; // kPaa to psia (absolute pressure)
                    default: return value;
                }
            }

            // Temperature: To Rankine (R) for gas calculations
            function convertTemperatureToRankine(value, unit) {
                switch (unit) {
                    case 'F': return value + 459.67; // °F to °R
                    case 'C': return (value * 9/5) + 32 + 459.67; // °C to °R
                    case 'K': return value * 1.8; // K to °R
                    default: return value;
                }
            }

            // Flow Rate for Liquids: To GPM
            function convertLiquidFlowRateToGPM(value, unit) {
                switch (unit) {
                    case 'GPM': return value;
                    case 'm3/hr': return value * 4.40287; // m³/hr to GPM
                    case 'l/min': return value * 0.264172; // L/min to GPM
                    default: return value;
                }
            }

            // Flow Rate for Gases: To SCFH (Standard Cubic Feet per Hour)
            // Note: Standard conditions for SCFH are typically 60°F (519.67 R) and 14.7 psia
            function convertGasFlowRateToSCFH(value, unit, currentMW = 29) {
                const stdTempR = 519.67; // 60°F in Rankine
                const stdPressPsia = 14.7; // psia

                switch (unit) {
                    case 'SCFH': return value;
                    case 'Nm3/hr': return value * 37.326; // Nm³/hr (0°C, 1.01325 bar) to SCFH
                    case 'kg/hr':
                        // Convert kg/hr to lb/hr, then to SCFH using ideal gas law
                        // 1 kmol = MW kg, 1 lbmol = MW lb
                        // 1 lbmol of ideal gas at STP (32°F, 1 atm) occupies 359.05 ft³
                        // 1 lbmol of ideal gas at 60°F, 14.7 psia occupies 379.48 ft³
                        const lbPerHour = value * 2.20462; // kg/hr to lb/hr
                        return (lbPerHour / currentMW) * 379.48; // lb/hr to lbmol/hr, then to SCFH
                    case 'lb/hr':
                        return (value / currentMW) * 379.48; // lb/hr to lbmol/hr, then to SCFH
                    default: return value;
                }
            }

            // Calculation Logic
            calculateBtn.addEventListener('click', function() {
                resultTableBody.innerHTML = ''; // Clear previous results
                stepsList.innerHTML = ''; // Clear previous steps
                recommendationsList.innerHTML = ''; // Clear previous recommendations
                practicalRecommendationsDiv.style.display = 'none'; // Hide recommendations initially
                cvStatusDisplay.textContent = 'Cv Calculation Status: Calculating...';
                cvStatusDisplay.className = 'status-display'; // Reset class

                let calculationSteps = [];
                let calculatedCv = 0;
                let validationError = false;
                let flowRegime = ''; // 'Subcritical', 'Critical (Choked)', or 'Cavitation/Flashing'

                const fluidType = fluidTypeSelect.value;

                calculationSteps.push(`<strong>1. Selected Fluid Type: ${fluidType.toUpperCase()}</strong>`);

                if (fluidType === 'liquid') {
                    const Q_liquid = parseFloat(liquidFlowRateInput.value);
                    const Q_liquid_unit = liquidFlowRateUnit.value;
                    const Gf = parseFloat(liquidSGInput.value);
                    const P1_liquid = parseFloat(liquidInletPressureInput.value); // New
                    const P1_liquid_unit = liquidInletPressureUnit.value; // New
                    const P2_liquid = parseFloat(liquidOutletPressureInput.value); // New
                    const P2_liquid_unit = liquidOutletPressureUnit.value; // New
                    const Pv_liquid = parseFloat(liquidVaporPressureInput.value);
                    const Pv_liquid_unit = liquidVaporPressureUnit.value;
                    const Pc_liquid = parseFloat(liquidCriticalPressureInput.value);
                    const Pc_liquid_unit = liquidCriticalPressureUnit.value;
                    const FL = parseFloat(liquidFLInput.value);
                    const FF = parseFloat(liquidFFInput.value);
                    const liquidViscosity = parseFloat(liquidViscosityInput.value);

                    // Input Validation
                    if (isNaN(Q_liquid) || Q_liquid <= 0) {
                        showCustomMessage('Liquid Flow Rate must be a positive number.', 'error');
                        validationError = true;
                    }
                    if (isNaN(Gf) || Gf <= 0) {
                        showCustomMessage('Liquid Specific Gravity must be a positive number.', 'error');
                        validationError = true;
                    }
                    if (isNaN(P1_liquid) || P1_liquid <= 0) {
                        showCustomMessage('Liquid Inlet Pressure (P1) must be a positive number.', 'error');
                        validationError = true;
                    }
                    if (isNaN(P2_liquid) || P2_liquid < 0) {
                        showCustomMessage('Liquid Outlet Pressure (P2) must be a non-negative number.', 'error');
                        validationError = true;
                    }
                    if (P2_liquid >= P1_liquid) {
                        showCustomMessage('Liquid Outlet Pressure (P2) must be less than Inlet Pressure (P1).', 'error');
                        validationError = true;
                    }
                    if (isNaN(Pv_liquid) || Pv_liquid < 0) {
                        showCustomMessage('Liquid Vapor Pressure must be a non-negative number.', 'error');
                        validationError = true;
                    }
                    if (isNaN(Pc_liquid) || Pc_liquid <= 0) {
                        showCustomMessage('Liquid Critical Pressure must be a positive number.', 'error');
                        validationError = true;
                    }
                    if (isNaN(FL) || FL <= 0 || FL > 1) {
                        showCustomMessage('Liquid Pressure Recovery Factor (F_L) must be between 0 and 1.', 'error');
                        validationError = true;
                    }
                    if (isNaN(FF) || FF <= 0 || FF > 1) {
                        showCustomMessage('Liquid Critical Pressure Ratio Factor (F_F) must be between 0 and 1.', 'error');
                        validationError = true;
                    }
                    if (isNaN(liquidViscosity) || liquidViscosity < 0) {
                        showCustomMessage('Liquid Viscosity must be a non-negative number.', 'error');
                        validationError = true;
                    }

                    if (validationError) {
                        resultContainer.style.display = 'none';
                        resultContainer.classList.remove('show');
                        return;
                    }

                    // Convert inputs to standard units for calculation (GPM, psia)
                    const Q_gpm = convertLiquidFlowRateToGPM(Q_liquid, Q_liquid_unit);
                    const P1_psia = convertPressureToPsia(P1_liquid, P1_liquid_unit);
                    const P2_psia = convertPressureToPsia(P2_liquid, liquidOutletPressureUnit.value);
                    const Pv_psia = convertPressureToPsia(Pv_liquid, Pv_liquid_unit);
                    const Pc_psia = convertPressureToPsia(Pc_liquid, Pc_liquid_unit);
                    
                    const dP_liquid_actual = P1_psia - P2_psia;

                    calculationSteps.push(`<strong>2. Input Parameters:</strong>`);
                    calculationSteps.push(`Flow Rate (Q): ${Q_liquid.toFixed(2)} ${Q_liquid_unit} (Converted to: ${Q_gpm.toFixed(2)} GPM)`);
                    calculationSteps.push(`Specific Gravity (G<sub>f</sub>): ${Gf.toFixed(2)}`);
                    calculationSteps.push(`Inlet Pressure (P<sub>1</sub>): ${P1_liquid.toFixed(2)} ${P1_liquid_unit} (Converted to: ${P1_psia.toFixed(2)} psia)`);
                    calculationSteps.push(`Outlet Pressure (P<sub>2</sub>): ${P2_liquid.toFixed(2)} ${P2_liquid_unit} (Converted to: ${P2_psia.toFixed(2)} psia)`);
                    calculationSteps.push(`Vapor Pressure (P<sub>v</sub>): ${Pv_liquid.toFixed(2)} ${Pv_liquid_unit} (Converted to: ${Pv_psia.toFixed(2)} psia)`);
                    calculationSteps.push(`Critical Pressure (P<sub>c</sub>): ${Pc_liquid.toFixed(2)} ${Pc_liquid_unit} (Converted to: ${Pc_psia.toFixed(2)} psia)`);
                    calculationSteps.push(`Liquid Pressure Recovery Factor (F<sub>L</sub>): ${FL.toFixed(2)}`);
                    calculationSteps.push(`Liquid Critical Pressure Ratio Factor (F<sub>F</sub>): ${FF.toFixed(2)}`);
                    calculationSteps.push(`Viscosity (μ): ${liquidViscosity.toFixed(2)} cP`);
                    calculationSteps.push(`Calculated Pressure Drop (ΔP) = P<sub>1</sub> - P<sub>2</sub> = ${P1_psia.toFixed(2)} - ${P2_psia.toFixed(2)} = ${dP_liquid_actual.toFixed(2)} psi`);

                    // ISA S75.01.01 Liquid Choked Flow Check
                    const dP_choked = Math.pow(FL, 2) * (P1_psia - FF * Pv_psia);
                    calculationSteps.push(`<strong>3. Determine Flow Regime:</strong>`);
                    calculationSteps.push(`Calculated Choked Pressure Drop (ΔP<sub>choked</sub>) = F<sub>L</sub>² &times; (P<sub>1</sub> - F<sub>F</sub> &times; P<sub>v</sub>)`);
                    calculationSteps.push(`ΔP<sub>choked</sub> = ${FL.toFixed(2)}² &times; (${P1_psia.toFixed(2)} - ${FF.toFixed(2)} &times; ${Pv_psia.toFixed(2)}) = ${dP_choked.toFixed(2)} psi`);

                    let dP_effective = dP_liquid_actual;
                    if (dP_liquid_actual >= dP_choked) {
                        flowRegime = 'Liquid Critical (Choked) Flow / Cavitation';
                        dP_effective = dP_choked;
                        recommendations.push("<strong>Warning: Cavitation or Flashing Predicted!</strong> The pressure drop across the valve is at or above the choked flow limit. This can lead to noise, vibration, and severe valve damage. Consider increasing the outlet pressure, using a larger valve, or selecting anti-cavitation trim.");
                    } else {
                        flowRegime = 'Liquid Subcritical Flow';
                    }
                    calculationSteps.push(`Effective Pressure Drop (ΔP<sub>effective</sub>) = min(ΔP, ΔP<sub>choked</sub>) = ${dP_effective.toFixed(2)} psi`);

                    // Liquid Cv Formula: Cv = Q * sqrt(Gf / dP_effective)
                    calculatedCv = Q_gpm * Math.sqrt(Gf / dP_effective);

                    cvFormula.innerHTML = `C<sub>v</sub> = Q &times; &radic;<span style="text-decoration:overline;">(G<sub>f</sub> / &Delta;P<sub>effective</sub>)</span>`;
                    calculationSteps.push(`<strong>4. Calculation:</strong>`);
                    calculationSteps.push(`C<sub>v</sub> = ${Q_gpm.toFixed(2)} GPM &times; &radic;<span style="text-decoration:overline;">(${Gf.toFixed(2)} / ${dP_effective.toFixed(2)} psi)</span>`);
                    calculationSteps.push(`C<sub>v</sub> = ${Q_gpm.toFixed(2)} &times; ${Math.sqrt(Gf / dP_effective).toFixed(4)} = <strong>${calculatedCv.toFixed(2)}</strong>`);

                } else { // Gas/Vapor
                    const Q_gas = parseFloat(gasFlowRateInput.value);
                    const Q_gas_unit = gasFlowRateUnit.value;
                    const P1_gas = parseFloat(gasInletPressureInput.value);
                    const P1_gas_unit = gasPressureUnit.value;
                    const P2_gas = parseFloat(gasOutletPressureInput.value);
                    const P2_gas_unit = gasPressureUnit2.value; // Use P2's unit
                    const T_gas = parseFloat(gasTemperatureInput.value);
                    const T_gas_unit = gasTemperatureUnit.value;
                    const MW = parseFloat(gasMWInput.value);
                    const Cf = parseFloat(gasCfInput.value);
                    const k = parseFloat(gasKInput.value);
                    const Z = parseFloat(gasZInput.value);

                    // Input Validation
                    if (isNaN(Q_gas) || Q_gas <= 0) {
                        showCustomMessage('Gas Flow Rate must be a positive number.', 'error');
                        validationError = true;
                    }
                    if (isNaN(P1_gas) || P1_gas <= 0) {
                        showCustomMessage('Gas Inlet Pressure (P1) must be a positive number.', 'error');
                        validationError = true;
                    }
                    if (isNaN(P2_gas) || P2_gas < 0) {
                        showCustomMessage('Gas Outlet Pressure (P2) must be a non-negative number.', 'error');
                        validationError = true;
                    }
                    if (P2_gas >= P1_gas) {
                        showCustomMessage('Outlet Pressure (P2) must be less than Inlet Pressure (P1).', 'error');
                        validationError = true;
                    }
                    if (isNaN(T_gas)) {
                        showCustomMessage('Gas Temperature must be a number.', 'error');
                        validationError = true;
                    }
                    if (isNaN(MW) || MW <= 0) {
                        showCustomMessage('Gas Molecular Weight must be a positive number.', 'error');
                        validationError = true;
                    }
                    if (isNaN(Cf) || Cf <= 0 || Cf > 1) {
                        showCustomMessage('Critical Flow Factor (Cf) must be between 0 and 1.', 'error');
                        validationError = true;
                    }
                    if (isNaN(k) || k <= 0) {
                        showCustomMessage('Ratio of Specific Heats (k) must be a positive number.', 'error');
                        validationError = true;
                    }
                    if (isNaN(Z) || Z <= 0) {
                        showCustomMessage('Compressibility Factor (Z) must be a positive number.', 'error');
                        validationError = true;
                    }

                    if (validationError) {
                        resultContainer.style.display = 'none';
                        resultContainer.classList.remove('show');
                        return;
                    }

                    // Convert inputs to standard units for calculation (psia, Rankine, SCFH)
                    const P1_psia = convertPressureToPsia(P1_gas, P1_gas_unit);
                    const P2_psia = convertPressureToPsia(P2_gas, gasPressureUnit2.value);
                    const T_rankine = convertTemperatureToRankine(T_gas, T_gas_unit);
                    const Gg = MW / 29; // Specific Gravity of Gas relative to Air (MW of Air ~ 29)
                    const Q_scfh = convertGasFlowRateToSCFH(Q_gas, Q_gas_unit, MW);

                    calculationSteps.push(`<strong>2. Input Parameters:</strong>`);
                    calculationSteps.push(`Flow Rate (Q): ${Q_gas.toFixed(2)} ${Q_gas_unit} (Converted to: ${Q_scfh.toFixed(2)} SCFH)`);
                    calculationSteps.push(`Inlet Pressure (P<sub>1</sub>): ${P1_gas.toFixed(2)} ${P1_gas_unit} (Converted to: ${P1_psia.toFixed(2)} psia)`);
                    calculationSteps.push(`Outlet Pressure (P<sub>2</sub>): ${P2_gas.toFixed(2)} ${P2_gas_unit} (Converted to: ${P2_psia.toFixed(2)} psia)`);
                    calculationSteps.push(`Temperature (T): ${T_gas.toFixed(2)} ${T_gas_unit} (Converted to: ${T_rankine.toFixed(2)} °R)`);
                    calculationSteps.push(`Molecular Weight (M<sub>w</sub>): ${MW.toFixed(2)} (Derived Specific Gravity (G<sub>g</sub>): ${Gg.toFixed(2)})`);
                    calculationSteps.push(`Critical Flow Factor (C<sub>f</sub>): ${Cf.toFixed(2)}`);
                    calculationSteps.push(`Ratio of Specific Heats (k): ${k.toFixed(2)}`);
                    calculationSteps.push(`Compressibility Factor (Z): ${Z.toFixed(2)}`);

                    // Calculate Pressure Drop
                    const dP_gas = P1_psia - P2_psia;
                    calculationSteps.push(`Pressure Drop (ΔP) = P<sub>1</sub> - P<sub>2</sub> = ${P1_psia.toFixed(2)} - ${P2_psia.toFixed(2)} = ${dP_gas.toFixed(2)} psi`);

                    // Critical Pressure Ratio (x_T)
                    const xT = k / (1.4 * Math.pow(Cf, 2)); // ISA S75.01 formula for x_T
                    const P_critical = P1_psia * xT;
                    calculationSteps.push(`<strong>3. Determine Flow Regime:</strong>`);
                    calculationSteps.push(`Critical Pressure Ratio (x<sub>T</sub>) = k / (1.4 &times; C<sub>f</sub>²) = ${k.toFixed(2)} / (1.4 &times; ${Cf.toFixed(2)}²) = ${xT.toFixed(4)}`);
                    calculationSteps.push(`Calculated Critical Pressure (P<sub>critical</sub>) = P<sub>1</sub> &times; x<sub>T</sub> = ${P1_psia.toFixed(2)} psia &times; ${xT.toFixed(4)} = ${P_critical.toFixed(2)} psia`);

                    if (P2_psia <= P_critical) {
                        // Critical Flow (Choked Flow)
                        flowRegime = 'Critical (Choked) Flow';
                        // Cv = Q / (1360 * Cf * P1 * sqrt(Gg / (T * Z)))
                        calculatedCv = Q_scfh / (1360 * Cf * P1_psia * Math.sqrt(Gg / (T_rankine * Z)));
                        cvFormula.innerHTML = `C<sub>v</sub> = Q / (1360 &times; C<sub>f</sub> &times; P<sub>1</sub> &times; &radic;<span style="text-decoration:overline;">(G<sub>g</sub> / (T &times; Z))</span>)`;
                        calculationSteps.push(`Since P<sub>2</sub> (${P2_psia.toFixed(2)} psia) &le; P<sub>critical</sub> (${P_critical.toFixed(2)} psia), the flow is <strong>Critical (Choked)</strong>.`);
                        calculationSteps.push(`<strong>4. Calculation for Critical Flow:</strong>`);
                        calculationSteps.push(`C<sub>v</sub> = ${Q_scfh.toFixed(2)} / (1360 &times; ${Cf.toFixed(2)} &times; ${P1_psia.toFixed(2)} &times; &radic;<span style="text-decoration:overline;">(${Gg.toFixed(2)} / (${T_rankine.toFixed(2)} &times; ${Z.toFixed(2)}))</span>)`);
                        calculationSteps.push(`C<sub>v</sub> = ${Q_scfh.toFixed(2)} / (1360 &times; ${Cf.toFixed(2)} &times; ${P1_psia.toFixed(2)} &times; ${Math.sqrt(Gg / (T_rankine * Z)).toFixed(4)})`);
                        calculationSteps.push(`C<sub>v</sub> = <strong>${calculatedCv.toFixed(2)}</strong>`);
                    } else {
                        // Subcritical Flow
                        flowRegime = 'Subcritical Flow';
                        // Cv = Q / (1360 * sqrt((dP * P1) / (Gg * T * Z)))
                        calculatedCv = Q_scfh / (1360 * Math.sqrt((dP_gas * P1_psia) / (Gg * T_rankine * Z)));
                        cvFormula.innerHTML = `C<sub>v</sub> = Q / (1360 &times; &radic;<span style="text-decoration:overline;">((P<sub>1</sub> - P<sub>2</sub>) &times; P<sub>1</sub> / (G<sub>g</sub> &times; T &times; Z))</span>)`;
                        calculationSteps.push(`Since P<sub>2</sub> (${P2_psia.toFixed(2)} psia) > P<sub>critical</sub> (${P_critical.toFixed(2)} psia), the flow is <strong>Subcritical</strong>.`);
                        calculationSteps.push(`<strong>4. Calculation for Subcritical Flow:</strong>`);
                        calculationSteps.push(`C<sub>v</sub> = ${Q_scfh.toFixed(2)} / (1360 &times; &radic;<span style="text-decoration:overline;">((${P1_psia.toFixed(2)} - ${P2_psia.toFixed(2)}) &times; ${P1_psia.toFixed(2)} / (${Gg.toFixed(2)} &times; ${T_rankine.toFixed(2)} &times; ${Z.toFixed(2)}))</span>)`);
                        calculationSteps.push(`C<sub>v</sub> = ${Q_scfh.toFixed(2)} / (1360 &times; ${Math.sqrt((dP_gas * P1_psia) / (Gg * T_rankine * Z)).toFixed(4)})`);
                        calculationSteps.push(`C<sub>v</sub> = <strong>${calculatedCv.toFixed(2)}</strong>`);
                    }
                }

                // Display Results in table
                const results = [
                    { param: 'Fluid Type', value: fluidType.charAt(0).toUpperCase() + fluidType.slice(1) },
                    { param: 'Flow Regime', value: flowRegime },
                    { param: '<strong>Calculated Cv Value</strong>', value: `<strong>${calculatedCv.toFixed(2)}</strong>` }
                ];

                results.forEach(res => {
                    const row = resultTableBody.insertRow();
                    const paramCell = row.insertCell(0);
                    const valueCell = row.insertCell(1);
                    paramCell.innerHTML = res.param;
                    valueCell.innerHTML = res.value;
                });

                // Populate step-by-step calculations
                stepsList.innerHTML = '';
                calculationSteps.forEach(step => {
                    const p = document.createElement('p');
                    p.className = 'calculation-step';
                    p.innerHTML = step;
                    stepsList.appendChild(p);
                });

                // Update Status Display and Recommendations
                let statusText = 'Cv Calculation Status: ';
                let statusClass = 'status-display ';
                let recommendations = [];

                if (calculatedCv < 0.1) {
                    statusText += 'Very Small Cv';
                    statusClass += 'optimal';
                    recommendations.push("A very small Cv value suggests a low flow requirement or high pressure drop. Consider if a smaller trim or a needle valve might be more appropriate.");
                } else if (calculatedCv < 10) {
                    statusText += 'Small Cv';
                    statusClass += 'sufficient';
                    recommendations.push("This Cv value is typical for fine control of low flow rates. Ensure the valve selected has good turndown and resolution at this Cv.");
                } else if (calculatedCv < 100) {
                    statusText += 'Medium Cv';
                    statusClass += 'adequate';
                    recommendations.push("This is a common Cv range for many industrial applications. Select a valve size that allows the calculated Cv to fall within 60-80% of the valve's maximum Cv for good control.");
                } else if (calculatedCv < 500) {
                    statusText += 'Large Cv';
                    statusClass += 'marginal';
                    recommendations.push("A large Cv value indicates a high flow rate. Verify all input parameters, especially flow rate and pressure drop. Consider if multiple smaller valves in parallel or a larger line size might be more suitable.");
                } else {
                    statusText += 'Very Large Cv';
                    statusClass += 'insufficient';
                    recommendations.push("A very large Cv value suggests extremely high flow or very low pressure drop. Double-check all inputs. This might indicate a need for a much larger valve, a different valve type, or a review of process conditions.");
                    recommendations.push("For gas/vapor, ensure the flow regime (subcritical/critical) is correctly identified, as this significantly impacts Cv calculation.");
                }

                recommendationsList.innerHTML = '';
                recommendations.forEach(rec => {
                    const li = document.createElement('li');
                    li.textContent = rec;
                    recommendationsList.appendChild(li);
                });
                practicalRecommendationsDiv.style.display = 'block'; // Show recommendations

                cvStatusDisplay.textContent = statusText;
                cvStatusDisplay.className = statusClass;

                resultContainer.style.display = 'block';
                // Trigger fade-in animation
                setTimeout(() => {
                    resultContainer.classList.add('show');
                    showCustomMessage('Calculation successful!', 'success');
                }, 100);

            });

            // Reset Form Logic
            resetFormBtn.addEventListener('click', function() {
                fluidTypeSelect.value = defaultValues['fluid-type'];
                liquidFlowRateInput.value = defaultValues['liquid-flow-rate'];
                liquidFlowRateUnit.value = defaultValues['liquid-flow-rate-unit'];
                liquidSGInput.value = defaultValues['liquid-sg'];
                liquidInletPressureInput.value = defaultValues['liquid-inlet-pressure']; // Reset new
                liquidInletPressureUnit.value = defaultValues['liquid-inlet-pressure-unit']; // Reset new
                liquidOutletPressureInput.value = defaultValues['liquid-outlet-pressure']; // Reset new
                liquidOutletPressureUnit.value = defaultValues['liquid-outlet-pressure-unit']; // Reset new
                liquidVaporPressureInput.value = defaultValues['liquid-vapor-pressure'];
                liquidVaporPressureUnit.value = defaultValues['liquid-vapor-pressure-unit'];
                liquidCriticalPressureInput.value = defaultValues['liquid-critical-pressure'];
                liquidCriticalPressureUnit.value = defaultValues['liquid-critical-pressure-unit'];
                liquidFLInput.value = defaultValues['liquid-fl'];
                liquidFFInput.value = defaultValues['liquid-ff'];
                liquidViscosityInput.value = defaultValues['liquid-viscosity'];

                gasFlowRateInput.value = defaultValues['gas-flow-rate'];
                gasFlowRateUnit.value = defaultValues['gas-flow-rate-unit'];
                gasInletPressureInput.value = defaultValues['gas-inlet-pressure'];
                gasOutletPressureInput.value = defaultValues['gas-outlet-pressure'];
                gasPressureUnit.value = defaultValues['gas-pressure-unit'];
                gasPressureUnit2.value = defaultValues['gas-pressure-unit-2'];
                gasTemperatureInput.value = defaultValues['gas-temperature'];
                gasTemperatureUnit.value = defaultValues['gas-temperature-unit'];
                gasMWInput.value = defaultValues['gas-mw'];
                gasCfInput.value = defaultValues['gas-cf'];
                gasKInput.value = defaultValues['gas-k'];
                gasZInput.value = defaultValues['gas-z'];

                toggleFluidParameters(); // Apply visibility based on reset mode

                showCustomMessage('Form reset to default values.', 'info');
            });

            // Clear Results Logic
            clearResultsBtn.addEventListener('click', function() {
                resultContainer.classList.remove('show');
                setTimeout(() => {
                    resultContainer.style.display = 'none';
                    resultTableBody.innerHTML = '';
                    stepsList.innerHTML = '';
                    cvFormula.innerHTML = '';
                    recommendationsList.innerHTML = '';
                    practicalRecommendationsDiv.style.display = 'none';
                    cvStatusDisplay.textContent = 'Cv Calculation Status: N/A';
                    cvStatusDisplay.className = 'status-display';
                }, 500); // Wait for fade-out transition
                showCustomMessage('Results cleared.', 'info');
            });

            // Initial fade-in for form sections
            const formSections = document.querySelectorAll('.form-section');
            formSections.forEach((section, index) => {
                setTimeout(() => {
                    section.classList.add('fade-in');
                }, 100 * index); // Staggered fade-in
            });

            // Theme switch logic
            const themeSwitch = document.getElementById('theme-switch');
            if (themeSwitch) {
                if (localStorage.getItem('theme') === 'dark') {
                    document.body.classList.add('dark-mode');
                    themeSwitch.checked = true;
                }

                themeSwitch.addEventListener('change', function() {
                    if (this.checked) {
                        document.body.classList.add('dark-mode');
                        localStorage.setItem('theme', 'dark');
                    } else {
                        document.body.classList.remove('dark-mode');
                        localStorage.setItem('theme', 'light');
                    }
                });
            }
            // Initial call to set visibility based on default/saved values
            toggleFluidParameters();
        });
    </script>
</body>
</html>