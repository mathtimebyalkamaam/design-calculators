<!DOCTYPE html>
<html lang="en">
<head>
    <!-- AdSense and Analytics -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5936527763614780" crossorigin="anonymous"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-23Y1V450SR"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-23Y1V450SR');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fuel Combustion & Flue Gas Analysis Calculator - Design Calculators - Mechanical</title>
    <!-- Fonts and Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Montserrat:wght@700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- MathJax for LaTeX rendering -->
    <script type="text/javascript" id="MathJax-script" async
            src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
    </script>
    <!-- Favicons -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <script>
        // MathJax configuration to support inline and display LaTeX
        MathJax = {
            tex: {
                inlineMath: [['\\(', '\\)'], ['$', '$']],
                displayMath: [['\\[', '\\]']],
                processEscapes: true
            },
            svg: {fontCache: 'global'}
        };
    </script>
    <style>
        /* === START: NEW THEME VARIABLES === */
        :root {
            --primary-color: #1E3A8A; /* Professional Dark Blue */
            --secondary-color: #2563EB; /* Bright Blue */
            --accent-color: #F59E0B; /* Warm Amber */
            --bg-color: #F8FAFC;
            --card-bg: #FFFFFF;
            --text-color: #4B5563;
            --heading-color: #111827;
            --footer-bg: #0F172A;
            --border-color: #E2E8F0;
            --gradient-primary: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            --gradient-dark: linear-gradient(135deg, #0F172A, #1E293B);
            --card-shadow: 0 10px 25px rgba(0, 0, 0, 0.1), 0 5px 10px rgba(0, 0, 0, 0.04);
            --hover-color: #eef2ff;
            --button-hover-shadow: 0 7px 20px rgba(37, 99, 235, 0.4);
            --highlight-bg: rgba(245, 158, 11, 0.15);
            --success-color: #10B981;
            --fail-color: #EF4444;
            --warning-color: #F59E0B;
            --primary-color-rgb: 30, 58, 138; /* Added for form focus */
        }

        /* Dark mode overrides */
        body.dark-mode {
            --primary-color: #10B981;
            --secondary-color: #34D399;
            --bg-color: #0F172A;
            --card-bg: #1E293B;
            --text-color: #CBD5E1;
            --heading-color: #F1F5F9;
            --footer-bg: #020617;
            --border-color: #334155;
            --highlight-bg: rgba(16, 185, 129, 0.2);
            --hover-color: #334155;
            --button-hover-shadow: 0 7px 20px rgba(16, 185, 129, 0.3);
            --primary-color-rgb: 16, 185, 129; /* Added for form focus */
            --success-color: #10B981;
            --fail-color: #EF4444;
        }
        /* === END: NEW THEME VARIABLES === */

        /* Base body styling */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.8; /* Updated line height */
            transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden; /* Added */
        }

        /* Container for content width limitation and centering */
        .container {
            max-width: 1280px; /* Updated from 960px */
            margin: 0 auto;
            padding: 0 24px; /* Updated from 20px */
        }
        .content-container {
            max-width: 1100px; /* Specific container for tool content */
            margin: 0 auto;
            padding: 20px;
        }

        /* === START: NEW HEADER STYLES === */
        .header {
            background: var(--gradient-primary);
            color: white;
            padding: 24px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 16px;
            text-decoration: none;
            color: white;
        }

        .logo-text {
            font-size: 1.75rem;
            font-weight: 800;
            font-family: 'Montserrat', sans-serif;
        }

        .nav-links {
            display: flex;
            gap: 24px;
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .nav-links a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s;
        }

        .nav-links a:hover {
            color: var(--accent-color);
            transform: translateY(-2px);
        }

        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .theme-toggle .icon {
            color: white;
            font-size: 1.2rem;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 56px;
            height: 30px;
        }

        .switch input { opacity: 0; width: 0; height: 0; }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.2);
            transition: .4s;
            border-radius: 30px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider { background-color: var(--accent-color); }
        input:checked + .slider:before { transform: translateX(26px); }
        /* === END: NEW HEADER STYLES === */


        /* Main content area styling */
        main {
            padding: 40px 0; /* Updated padding */
        }

        /* Tool container styling */
        .tool-container {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 30px;
            box-shadow: var(--card-shadow);
            margin-bottom: 30px; /* Updated margin */
            transition: transform 0.3s ease-in-out;
        }
        .tool-container:hover {
            transform: translateY(-5px);
        }
        .tool-container h2 {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color); /* Updated border */
            padding-bottom: 15px; /* Updated padding */
            margin-top: 0;
            margin-bottom: 25px;
            font-size: 1.8rem; /* Updated font size */
            font-family: 'Montserrat', sans-serif; /* Added font */
        }
        
        /* Added styles for new educational content */
        .tool-container h3 {
            color: var(--primary-color);
            margin-top: 25px;
            font-family: 'Montserrat', sans-serif;
        }
        .tool-container p {
            margin-bottom: 15px;
            line-height: 1.8; /* Added */
        }
        .tool-container ul {
            padding-left: 20px;
            margin-bottom: 15px;
        }
        .tool-container li {
            margin-bottom: 10px;
        }
        .tool-container h4 {
            color: var(--secondary-color);
            margin-top: 20px;
            font-family: 'Montserrat', sans-serif;
        }
        /* End of added styles */

        .tool-description {
            margin-bottom: 25px;
            color: var(--text-color);
            font-size: 1.05em;
        }
        .tool-description ul {
            list-style-type: disc;
            margin-left: 25px;
            padding-left: 0;
            margin-top: 15px;
        }
        .tool-description ul li {
            margin-bottom: 8px;
        }
        .tool-description strong {
            color: var(--primary-color);
            font-weight: 600; /* Ensure strong tags are bold */
        }

        /* Back button styling (REMOVED) */
        
        /* === START: NEW FOOTER STYLES === */
        footer {
            background: var(--gradient-dark);
            color: #CBD5E1;
            padding: 50px 0 20px 0;
        }

        .footer-content {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 40px;
            margin-bottom: 30px;
        }

        .footer-col {
            flex: 1;
            min-width: 200px;
        }

        .footer-col h4 {
            color: white;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .footer-col ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .footer-col ul li {
            margin-bottom: 10px;
        }

        .footer-col a {
            color: #CBD5E1;
            text-decoration: none;
            transition: all 0.3s;
        }

        .footer-col a:hover {
            color: var(--accent-color);
            transform: translateX(3px);
        }

        .footer-disclaimer {
            text-align: center;
            margin: 30px auto;
            padding-top: 25px;
            border-top: 1px solid #334155;
            max-width: 800px;
            font-size: 0.9rem;
            line-height: 1.6;
        }
        /* Added for disclaimer content */
        .footer-disclaimer h3, .footer-disclaimer p, .footer-disclaimer ul, .footer-disclaimer li {
            color: #CBD5E1;
            font-size: 0.9rem;
            text-align: left;
        }
        .footer-disclaimer h3 {
            text-align: center;
            color: white;
            font-size: 1.1rem;
            margin-bottom: 10px;
        }
        .footer-disclaimer ul {
            padding-left: 20px;
            margin-top: 10px;
        }
        .footer-disclaimer p {
            text-align: center;
            margin-bottom: 10px;
        }
        .footer-disclaimer strong { /* Style for strong tags in footer */
            font-weight: 600;
            color: var(--accent-color);
        }


        .footer-bottom {
            text-align: center;
            padding-top: 20px;
            font-size: 0.9rem;
            color: #94A3B8;
        }

        .creator-name {
            color: var(--secondary-color);
            font-weight: bold;
        }

        .social-buttons {
            display: flex;
            justify-content: center; /* Center buttons in footer */
            gap: 12px;
            margin-top: 15px;
        }

        .social-btn {
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            border-radius: 50%;
            text-decoration: none;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .social-btn:hover {
            transform: translateY(-4px) scale(1.1);
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
        }

        .social-btn.linkedin { background-color: #0A66C2; }
        .social-btn.youtube { background-color: #FF0000; }
        .social-btn.twitter { background-color: #1DA1F2; }
        .social-btn.facebook { background-color: #1877F2; }
        .social-btn.whatsapp { background-color: #25D366; }
        /* === END: NEW FOOTER STYLES === */
        
        /* Calculator form styling */
        .calculator-form {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 30px;
            margin-top: 25px;
            box-shadow: var(--card-shadow);
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            font-size: 1.05em;
            color: var(--heading-color); /* Use heading color */
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px; /* Rounded corners */
            background-color: var(--bg-color);
            color: var(--text-color);
            box-sizing: border-box;
            font-size: 1em;
            transition: border-color 0.3s, box-shadow 0.3s;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.08);
        }
        .form-group input:focus, .form-group select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(var(--primary-color-rgb), 0.3);
            outline: none;
        }

        /* Responsive form row layout */
        .form-row {
            display: grid; /* Switched to grid for better column control */
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); /* Responsive columns */
            gap: 20px;
        }
       
        /* Calculate button styling */
        .calculate-btn {
            background: var(--gradient-primary); /* Use new gradient */
            color: white;
            border: none;
            padding: 15px 25px; /* Updated padding */
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2rem; /* Updated font size */
            font-weight: 700;
            font-family: 'Montserrat', sans-serif; /* Added font */
            margin-top: 25px; /* Updated margin */
            transition: transform 0.2s, box-shadow 0.3s; /* Updated transition */
            box-shadow: var(--card-shadow);
            width: 100%; /* Full width button */
            position: relative; /* Added for ripple */
            overflow: hidden; /* Added for ripple */
        }
        .calculate-btn:hover {
            transform: translateY(-3px);
            box-shadow: var(--button-hover-shadow);
        }

        /* Result container styling */
        .result-container {
            margin-top: 40px;
            padding: 30px;
            border-radius: 12px;
            background-color: var(--card-bg);
            box-shadow: var(--card-shadow);
            display: block; /* Always block, but opacity controls visibility */
            opacity: 0;
            transition: opacity 0.6s ease-out;
            pointer-events: none; /* Prevents interaction when hidden */
        }
        .result-container.show {
            opacity: 1;
            pointer-events: auto; /* Allows interaction when shown */
        }
        .result-container h3 { /* Added for consistency */
            color: var(--primary-color);
            margin-bottom: 25px;
            font-family: 'Montserrat', sans-serif;
            font-size: 1.8rem;
            text-align: center;
        }

        /* Result table styling */
        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .result-table th, .result-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        .result-table th {
            background-color: var(--hover-color);
            font-weight: 600; /* Updated weight */
            font-size: 1.1em;
            color: var(--heading-color); /* Added */
        }
        .result-table tr:last-child td {
            border-bottom: none;
        }
        /* Added for section headers in table */
        .result-table .section-header td {
            background-color: var(--hover-color);
            color: var(--primary-color);
            font-weight: 700;
            font-size: 1.1em;
        }

        /* Standard reference text styling */
        .standard-reference {
            margin-top: 25px;
            font-style: italic;
            font-size: 0.95rem;
            line-height: 1.5;
            padding: 15px; /* Updated padding */
            background-color: var(--bg-color);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            color: var(--text-color); /* Added */
        }
         .standard-reference strong { /* Style for strong tags in results */
             font-weight: 600;
             color: var(--heading-color);
        }


        /* Tooltip styling */
        .info-icon {
            color: var(--secondary-color); /* Updated color */
            margin-left: 8px;
            cursor: help;
            font-size: 0.9em; /* Updated size */
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 280px; /* Updated width */
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px; /* Updated radius */
            padding: 10px; /* Updated padding */
            position: absolute;
            z-index: 10; /* Increased z-index */
            bottom: 135%; /* Updated position */
            left: 50%;
            margin-left: -140px; /* Center the tooltip */
            opacity: 0;
            transition: opacity 0.3s;
            font-weight: normal; /* Added */
            font-size: 0.9rem; /* Added */
        }
        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%; /* Arrow at the bottom */
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* Custom message box for alerts */
        #custom-message-box {
            position: fixed;
            top: 20px; /* Updated position */
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 25px; /* Updated padding */
            border-radius: 8px; /* Updated radius */
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); /* Updated shadow */
            z-index: 1000;
            font-weight: bold;
            color: white;
            opacity: 0;
            visibility: hidden; /* Added */
            transition: opacity 0.5s ease-in-out, visibility 0.5s, background-color 0.3s; /* Added visibility */
            font-size: 1.1em;
        }
        #custom-message-box.show { /* Added show class */
            opacity: 1;
            visibility: visible;
        }
        #custom-message-box.info {
            background-color: var(--success-color);
        }
        #custom-message-box.error {
            background-color: var(--fail-color);
        }
        #custom-message-box.warning {
            background-color: var(--accent-color);
            color: #333;
        }

        /* Calculation details section styling */
        #calculation-details {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
            font-size: 0.98em;
            overflow-x: auto; /* Allow horizontal scrolling for formulas if needed */
        }
        #calculation-details h4 {
            color: var(--secondary-color);
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        #calculation-details p.formula {
            font-family: 'Times New Roman', serif;
            font-style: italic;
            font-size: 1.2em;
            text-align: center;
            padding: 12px; /* Updated padding */
            background-color: var(--hover-color);
            border-radius: 6px;
            margin: 15px 0;
            border: 1px dashed var(--border-color);
            white-space: nowrap; /* Prevent formula from wrapping */
            overflow-x: auto; /* Added for smaller screens */
        }
        #calculation-details p.calculation-step {
            font-family: 'Courier New', monospace;
            background-color: var(--hover-color);
            padding: 8px 12px;
            border-radius: 5px;
            margin-bottom: 8px;
            font-size: 0.95em;
            white-space: nowrap; /* Prevent calculation steps from wrapping */
            overflow-x: auto; /* Added for smaller screens */
            color: var(--text-color); /* Added */
        }
        #calculation-details ul {
            list-style-type: disc;
            margin-left: 25px;
            padding-left: 0;
        }
        #calculation-details ul li {
            margin-bottom: 5px;
        }

        /* Specific styling for required inputs to highlight visually */
        input:required:invalid {
            border-color: var(--fail-color); /* Use theme color */
        }
        input:required:valid {
            border-color: var(--success-color); /* Use theme color */
        }

        /* Responsive Media Queries */
        @media (max-width: 768px) {
            .navbar { flex-direction: column; gap: 24px; }
            .nav-links { flex-direction: column; gap: 12px; text-align: center; }
            .container, .content-container { padding: 0 15px; }
            .tool-container { padding: 20px; }
            .footer-content { flex-direction: column; }
            .theme-toggle { position: static; margin-top: 20px; } /* Adjust theme toggle on mobile */
        }
        @media (max-width: 600px) {
            .form-row {
                grid-template-columns: 1fr; /* Single column on small screens */
            }
        }
    </style>
</head>
<body>
    <!-- === START: NEW HEADER === -->
    <header class="header">
    <div class="container">
    <nav class="navbar">
    <a href="/" class="logo-container">
    <span class="logo-text">Design Calculators</span>
    </a>
    <ul class="nav-links">
    <li><a href="/">Home</a></li>
    <li><a href='/articles.html'>Articles</a></li>
    <li><a href='/indexmech.html'>Mechanical</a></li>
    <li><a href='/indexele.html'>Electrical</a></li>
    <li><a href='/indexinst.html'>Instrumentation</a></li>
    </ul>
    <div class="theme-toggle">
    <i class="fas fa-sun icon"></i>
    <label class="switch">
    <input type="checkbox" id="theme-switch">
    <span class="slider"></span>
    </label>
    <i class="fas fa-moon icon"></i>
    </div>
    </nav>
    </div>
    </header>
    <!-- === END: NEW HEADER === -->

    <main class="content-container">
        <!-- Back to Tools button removed as requested -->

        <div class="tool-container">
            <h2>Fuel Combustion & Flue Gas Analysis Calculator</h2>
            <div class="tool-description">
                <p>This calculator determines the <strong>theoretical (stoichiometric) air</strong> requirement for complete combustion based on a fuel's elemental composition. It then calculates the <strong>Actual Air & Flue Gas flow rates and compositions</strong> by incorporating an engineer-defined excess air percentage. This is crucial for sizing fans, ducts, and stack gas treatment systems, as well as for efficiency calculations and emissions monitoring.</p>
                <p><strong>Key Inputs:</strong></p>
                <ul>
                    <li><strong>Fuel Composition (% by mass):</strong> Enter the mass percentages of Carbon (C), Hydrogen (H), Sulfur (S), Oxygen (O), and Nitrogen (N) in your fuel (from an Ultimate Analysis).</li>
                    <li><strong>Fuel Flow Rate:</strong> The total mass flow rate of the fuel being burned (e.g., kg/hr or lb/hr).</li>
                    <li><strong>Excess Air (%):</strong> The percentage of air supplied in excess of the stoichiometric requirement. This is essential for ensuring complete combustion in real-world burners.</li>
                </ul>
                <p><strong>Calculated Outputs:</strong></p>
                <ul>
                    <li><strong>Air/Fuel Ratios:</strong> Stoichiometric and Actual air-fuel ratios (by mass).</li>
                    <li><strong>Mass Flow Rates:</strong> Actual Air Flow and Total Flue Gas Flow (e.g., kg/hr or lb/hr).</li>
                    <li><strong>Flue Gas Composition (Mass %):</strong> The mass-based percentage of CO₂, H₂O, SO₂, N₂, and excess O₂ in the exhaust.</li>
                    <li><strong>Flue Gas Composition (Volume/Mole %):</strong> The molar-based percentage, which is what stack gas analyzers typically measure.</li>
                    <li><strong>Flue Gas Properties:</strong> The Average Molecular Weight of the flue gas.</li>
                    <li><strong>Volumetric Flow Rate:</strong> The total flue gas flow in <strong>Normal Cubic Meters per Hour (Nm³/hr)</strong> or Standard Cubic Feet per Hour (SCFH), calculated at Standard Temperature and Pressure (0°C, 1 atm or 60°F, 1 atm).</li>
                </ul>
            </div>

            <div class="calculator-form">
                <form id="combustion-calculator-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="unit-system">Unit System: <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Select units for flow rates and outputs.</span></span></label>
                            <select id="unit-system" required>
                                <option value="metric">Metric (kg/hr, Nm³/hr)</option>
                                <option value="imperial">Imperial (lb/hr, SCFH)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="fuel-flow-rate">Fuel Flow Rate <span class="fuel-flow-unit">(kg/hr)</span>: <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Total mass flow rate of the fuel being combusted.</span></span></label>
                            <input type="number" id="fuel-flow-rate" step="any" value="1000" required min="0.01">
                        </div>
                        <div class="form-group">
                            <label for="excess-air">Excess Air (%): <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Percentage of air supplied over stoichiometric. Typically 10-50% for industrial burners.</span></span></label>
                            <input type="number" id="excess-air" step="0.1" value="20" required min="0" max="1000">
                        </div>
                    </div>

                    <h3>Fuel Elemental Composition (% by Mass)</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="carbon">Carbon (C) %: <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Mass percentage of Carbon in the fuel.</span></span></label>
                            <input type="number" id="carbon" step="0.01" value="85" required min="0" max="100">
                        </div>
                        <div class="form-group">
                            <label for="hydrogen">Hydrogen (H) %: <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Mass percentage of Hydrogen in the fuel.</span></span></label>
                            <input type="number" id="hydrogen" step="0.01" value="12" required min="0" max="100">
                        </div>
                        <div class="form-group">
                            <label for="sulfur">Sulfur (S) %: <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Mass percentage of Sulfur in the fuel.</span></span></label>
                            <input type="number" id="sulfur" step="0.01" value="2" required min="0" max="100">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="oxygen">Oxygen (O) %: <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Mass percentage of Oxygen in the fuel.</span></span></label>
                            <input type="number" id="oxygen" step="0.01" value="0" required min="0" max="100">
                        </div>
                        <div class="form-group">
                            <label for="nitrogen">Nitrogen (N) %: <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Mass percentage of Nitrogen in the fuel (does not contribute to oxygen demand).</span></span></label>
                            <input type="number" id="nitrogen" step="0.01" value="1" required min="0" max="100">
                        </div>
                        <div class="form-group">
                            <label for="sum-composition">Sum of Composition (%):</label>
                            <input type="text" id="sum-composition" value="0" readonly style="font-weight: bold;">
                        </div>
                    </div>
                    <button type="button" id="calculate-combustion-btn" class="calculate-btn">Calculate Air & Flue Gas</button>
                </form>
            </div>

            <div id="result-container" class="result-container">
                <h3>Calculation Results</h3>
                <div id="calculation-details"></div>
                <table class="result-table">
                    <thead>
                        <tr>
                            <th>Parameter</th>
                            <th>Value</th>
                        </tr>
                    </thead>
                    <tbody id="result-table-body"></tbody>
                </table>
                <div class="standard-reference" id="standard-reference"></div>
            </div>
        </div>

        <!-- === START: NEW 800+ WORD EDUCATIONAL CONTENT === -->
        <div class="tool-container" style="margin-top: 40px; animation: fadeInSlideUp 0.8s ease;">
            <h2>The Fire Within: An Industrial Guide to Combustion & Stoichiometry</h2>
        
            <h3>Why Combustion Calculation is Critical</h3>
            <p>Combustion is far more than just "burning fuel"; it is the engine of modern industry. From massive power plant boilers generating steam for turbines, to refinery furnaces heating crude oil, to gas engines driving compressors, controlled combustion is the process that releases the chemical energy stored in fuel and converts it into useful work and heat. This calculation is the absolute starting point for all combustion engineering.</p>
            <p>Why is it so important?
            <ul>
                <li><strong>Efficiency & Cost:</strong> If you supply too little air (a "rich" mixture), you waste fuel as unburnt carbon monoxide (CO) and soot, pouring money up the chimney. If you supply too much air (a "lean" mixture), you waste energy heating up useless nitrogen that just carries heat away, killing your efficiency. This calculation finds the precise starting point.</li>
                <li><strong>Safety:</strong> A rich mixture can lead to explosive conditions in a furnace or stack. Calculating the correct air-fuel ratio is the first step in ensuring a safe, stable flame.</li>
                <li><strong>Emissions & Environment:</strong> Combustion is the primary source of industrial air pollutants. Too little air creates CO and soot. Too much air at high temperatures creates excessive Nitrogen Oxides (NOx), a major component of smog. This calculation is the basis for all emissions control strategies.</li>
            </ul>
            </p>

            <h3>The Science: Stoichiometry & "Excess Air"</h3>
            <p>This calculator is built on the fundamental principle of <strong>Stoichiometry</strong> (from the Greek words *stoicheion*, meaning "element," and *metron*, meaning "measure"). This is the chemical bookkeeping that balances the reactants (fuel and oxygen) with the products (exhaust gas).</p>
            
            <h4>Step 1: The Ideal World (Stoichiometric Air)</h4>
            <p>The "Stoichiometric Air-Fuel Ratio" (AFR) is the chemically perfect, theoretical amount of air needed to burn every single fuel molecule with zero oxygen left over. This calculator solves the core combustion equations based on mass:</p>
            <ul>
                <li><strong>C + O₂ → CO₂:</strong> 12 kg of Carbon needs 32 kg of Oxygen. (Ratio: 32/12 = 2.667)</li>
                <li><strong>2H₂ + O₂ → 2H₂O:</strong> 4 kg of Hydrogen needs 32 kg of Oxygen. (Ratio: 32/4 = 8.0)</li>
                <li><strong>S + O₂ → SO₂:</strong> 32 kg of Sulfur needs 32 kg of Oxygen. (Ratio: 32/32 = 1.0)</li>
            </ul>
            <p>The tool sums up the oxygen needed for all the Carbon, Hydrogen, and Sulfur in your fuel. It then *subtracts* any oxygen already present in the fuel (like in biofuels), as this oxygen doesn't need to be supplied. Finally, since air is only 23.2% oxygen by mass (the rest is mostly nitrogen), it divides by 0.232 to find the total mass of *air* required. This is the <strong>Stoichiometric AFR</strong>.</p>
            
            <h4>Step 2: The Real World (Excess Air)</h4>
            <p>In a real industrial burner, you can't perfectly mix every fuel molecule with an oxygen molecule. To ensure no fuel goes unburnt (which is expensive and dangerous), engineers *always* supply more air than the theoretical minimum. This is <strong>"Excess Air."</strong></p>
            <p>This calculator's "Actual AFR" is the practical number an engineer uses to set up a boiler or furnace. A typical natural gas burner might run at 10-15% excess air, while a coal-fired boiler might need 20-25% to account for the solid fuel's slower, less efficient mixing. This excess air ensures complete combustion, maximizing energy release and minimizing harmful CO emissions.</p>

            <h3>Applicable Standards & Quality Checks</h3>
            <p>The inputs for this tool are governed by rigorous international standards, and its outputs are verified by critical quality checks.</p>
            <ul>
                <li><strong>Fuel Analysis (ASTM):</strong> The C, H, S, O, and N percentages you enter are determined by a lab procedure called an "Ultimate Analysis." Standards like <strong>ASTM D5373</strong> (for C, H, N) and <strong>ASTM D4239</strong> (for Sulfur) are the standard methods for testing coal, petroleum coke, and other solid/liquid fuels.</li>
                <li><strong>Boiler Performance (ASME PTC 4):</strong> For large power plants, the <strong>ASME Performance Test Code 4</strong> provides the industrial standard for testing a boiler's efficiency. A core part of this test is calculating the stoichiometric air (what this tool does) and comparing it to the actual measured airflow and flue gas composition to find the *true* excess air and efficiency.</li>
                <li><strong>The Critical Quality Check: Flue Gas Analysis:</strong> This calculation tells you what *should* happen. A flue gas analyzer (or "stack gas analyzer") tells you what *is* happening. This device is the "speedometer" for combustion. By measuring the O₂ and CO in the exhaust, an engineer can verify the combustion process in real-time.
                    <ul>
                        <li><strong>High O₂ (e.g., 6%):</strong> You are running with too much excess air. Your Actual AFR is too high. You are wasting fuel heating this extra air.</li>
                        <li><strong>High CO (e.g., > 200 ppm):</strong> You have too little excess air. Your Actual AFR is too low. You are not burning all your fuel, which is dangerous, wasteful, and polluting.</li>
                    </ul>
                    The goal is to run at the "sweet spot"—the lowest possible excess air (low O₂) while maintaining near-zero CO.</li>
            </ul>

            <h3>Latest Trends & Innovations in Combustion</h3>
            <p>Combustion is an old science, but it's at the heart of the modern energy transition.</p>
            <ul>
                <li><strong>Hydrogen Blending & Co-firing:</strong> To reduce carbon emissions, industries are blending fuels like natural gas (CH₄) with "green" hydrogen (H₂). This drastically changes the calculation! Hydrogen has a *much* higher stoichiometric AFR (34.3 kg air / kg H₂) than natural gas (17.2). This means burners and air systems must be modified to supply more air for the same energy output.</li>
                <li><strong>Emissions Modeling (CFD):</strong> This tool calculates the *products* of perfect combustion (CO₂, H₂O, SO₂). But environmental agencies regulate *pollutants* like NOx. Engineers now use Computational Fluid Dynamics (CFD) to create a 3D model of the flame inside a furnace. This model simulates temperature, mixing, and chemical reactions to predict where NOx will form, allowing them to design "Low-NOx Burners."</li>
                <li><strong>Digital Twins for Combustion:</strong> The most advanced plants now run a "Digital Twin"—a real-time software model of their boiler. This model takes live fuel composition data and live flue gas analyzer data (O₂, CO) and uses stoichiometric calculations (like this tool) *every second* to continuously optimize the Actual AFR. This saves millions in fuel and ensures constant compliance with environmental limits.</li>
            </ul>
        </div>
        <!-- === END: NEW EDUCATIONAL CONTENT === -->

    </main>

    <!-- === START: NEW FOOTER === -->
    <footer>
    <div class="container">
    <div class="footer-content">
    <div class="footer-col">
    <h4>Design Calculators</h4>
    <p style="font-size: 0.9rem; line-height: 1.6; margin-bottom: 15px;">Inspired by standards such as IEC, IEEE, ISA, ASME, and API.</p>
    <div class="social-buttons">
    <a href="https.www.linkedin.com/shareArticle?mini=true&url=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn linkedin"><i class="fab fa-linkedin-in"></i></a>
    <a href="https://www.youtube.com/@designcalculators" target="_blank" rel="noopener noreferrer" class="social-btn youtube"><i class="fab fa-youtube"></i></a>
    <a href="https://twitter.com/intent/tweet?url=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn twitter"><i class="fab fa-twitter"></i></a>
    <a href="https://www.facebook.com/sharer/sharer.php?u=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn facebook"><i class="fab fa-facebook-f"></i></a>
    <a href="https://api.whatsapp.com/send?text=Check%20out%20this%20amazing%20engineering%20resource:%20https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn whatsapp"><i class="fab fa-whatsapp"></i></a>
    </div>
    </div>
    <div class="footer-col">
    <h4>Quick Links</h4>
    <ul>
    <li><a href="/">Home</a></li>
    <li><a href='/indexele.html'>Electrical</a></li>
    <li><a href='/indexmech.html'>Mechanical</a></li>
    <li><a href='/indexinst.html'>Instrumentation</a></li>
    </ul>
    </div>
    <div class="footer-col">
    <h4>Resources</h4>
    <ul>
    <li><a href='/about.html'>About Us</a></li>
    <li><a href='/contact.html'>Contact</a></li>
    <li><a href='/faq.html'>FAQ</a></li>
    <li><a href='/privacy-policy.html'>Privacy Policy</a></li>
    <li><a href='/terms-of-service.html'>Terms of Service</a></li>
    </ul>
    </div>
    <div class="footer-col">
    <h4>More</h4>
    <ul>
    <li><a href='/articles.html'>Articles & Blog</a></li>
    <li><a href='/sitemap2.html'>Sitemap</a></li>
    <li><a href="https://www.youtube.com/@designcalculators" target="_blank" rel="noopener noreferrer">YouTube Channel</a></li>
    </ul>
    </div>
    </div>
    
    <div class="footer-disclaimer">
        <!-- Kept the original disclaimer from the combustion calculator -->
        <h3>Disclaimer</h3>
        <p>This calculator provides the <strong>theoretical minimum (stoichiometric) air requirement by mass for complete combustion</strong>, based on the elemental composition of the fuel. It then calculates the <strong>Actual Air Requirement</strong> by incorporating an engineer-defined excess air percentage. This is an essential theoretical starting point and a practical estimate for combustion system design and analysis.</p>
        <p><strong>This calculator operates on fundamental chemical principles and does NOT replace detailed engineering analysis for:</strong></p>
        <ul>
            <li><strong>Comprehensive Fuel Analysis:</strong> Actual fuel properties (including ash, moisture, and heating values) require detailed laboratory analysis (e.g., proximate and ultimate analysis via ASTM D3176, D5291, D4239). This tool assumes input percentages for combustible elements only.</li>
            <li><strong>Complex Combustion Products & Emissions:</strong> Assumes complete combustion to CO₂, H₂O, and SO₂. Real combustion systems can produce varying amounts of incomplete combustion products (CO, unburnt hydrocarbons) and pollutants like NOx, influenced by burner design, flame temperature, and operating conditions. These require specialized emission modeling and measurement.</li>
            <li><strong>Operating Conditions & System Design:</strong> Factors like air preheat temperature, fuel atomization, mixing efficiency, combustion chamber geometry, and pressure significantly influence actual combustion performance, flame stability, and NOx formation.</li>
            <li><strong>Specific Industrial Codes & Standards:</strong> Adherence to industrial combustion and boiler codes (e.g., ASME PTC 4 for Fired Steam Generators, NFPA standards for fuel handling and safety, API standards for fired heaters) is critical for safe and compliant operation. This tool provides a foundational calculation, not full compliance.</li>
        </ul>
        <p>For accurate, safe, and optimized design, operation, and troubleshooting in critical industrial combustion applications, it is <strong>imperative</strong> to conduct comprehensive fuel analysis, consult relevant industry standards, utilize specialized combustion engineering software, and engage qualified chemical or mechanical engineers with expertise in combustion technology.</p>
    </div>
    
    <div class="footer-bottom">
    <p>&copy; 2025 Design Calculators. Created by <span class="creator-name">A Sharma</span>. All rights reserved.</p>
    </div>
    </div>
    </footer>
    <!-- === END: NEW FOOTER === -->

    <!-- Custom Message Box -->
    <div id="custom-message-box"></div>

    <!-- Original Calculator Script (Unchanged) -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Get references to DOM elements
            const calculateBtn = document.getElementById('calculate-combustion-btn');
            const resultContainer = document.getElementById('result-container');
            const resultTableBody = document.getElementById('result-table-body');
            const standardReference = document.getElementById('standard-reference');
            const calculationDetailsDiv = document.getElementById('calculation-details');

            // Input fields
            const unitSystemSelect = document.getElementById('unit-system');
            const fuelFlowRateInput = document.getElementById('fuel-flow-rate'); // NEW
            const carbonInput = document.getElementById('carbon');
            const hydrogenInput = document.getElementById('hydrogen');
            const sulfurInput = document.getElementById('sulfur');
            const oxygenInput = document.getElementById('oxygen');
            const nitrogenInput = document.getElementById('nitrogen');
            const excessAirInput = document.getElementById('excess-air'); 
            const sumCompositionInput = document.getElementById('sum-composition');
            const fuelFlowUnitLabel = document.querySelector('.fuel-flow-unit'); // NEW

            /**
             * Displays a custom message box at the top of the screen.
             * @param {string} message - The message to display.
             * @param {string} type - The type of message ('info', 'error', 'warning').
             */
            function displayMessage(message, type = "info") {
                let messageBox = document.getElementById('custom-message-box');
                if (!messageBox) {
                    messageBox = document.createElement('div');
                    messageBox.id = 'custom-message-box';
                    document.body.appendChild(messageBox);
                }
                messageBox.textContent = message;
                messageBox.className = ''; // Clear previous classes
                messageBox.classList.add(type); // Add type class for styling
                messageBox.classList.add('show'); // Add show class to make it visible

                // Hide message after 5 seconds
                setTimeout(() => {
                    messageBox.classList.remove('show');
                }, 5000);
            }

            /**
             * Calculates and updates the sum of fuel composition percentages.
             */
            function updateSumComposition() {
                const C = parseFloat(carbonInput.value) || 0;
                const H = parseFloat(hydrogenInput.value) || 0;
                const S = parseFloat(sulfurInput.value) || 0;
                const O = parseFloat(oxygenInput.value) || 0;
                const N = parseFloat(nitrogenInput.value) || 0;
                const sum = C + H + S + O + N;
                sumCompositionInput.value = sum.toFixed(2);

                if (sum > 100.01 || sum < 99.99) {
                    sumCompositionInput.style.backgroundColor = 'var(--fail-color)';
                    sumCompositionInput.style.color = 'white';
                } else {
                    sumCompositionInput.style.backgroundColor = 'var(--bg-color)';
                    sumCompositionInput.style.color = 'var(--text-color)';
                }
            }

            /**
             * Updates unit labels based on selected unit system.
             */
            function updateUnitLabels() {
                const isMetric = unitSystemSelect.value === 'metric';
                fuelFlowUnitLabel.textContent = isMetric ? '(kg/hr)' : '(lb/hr)';
                // Update default values if needed
                if (isMetric) {
                    fuelFlowRateInput.value = "1000";
                } else {
                    fuelFlowRateInput.value = "2204.62"; // ~1000 kg
                }
            }


            // Add event listeners
            unitSystemSelect.addEventListener('change', updateUnitLabels);
            carbonInput.addEventListener('input', updateSumComposition);
            hydrogenInput.addEventListener('input', updateSumComposition);
            sulfurInput.addEventListener('input', updateSumComposition);
            oxygenInput.addEventListener('input', updateSumComposition);
            nitrogenInput.addEventListener('input', updateSumComposition);

            // Initial setup on load
            updateSumComposition();
            updateUnitLabels();

            /**
             * Adds a row to the result table.
             * @param {string} parameterHtml - The HTML content for the parameter column.
             * @param {string} valueHtml - The HTML content for the value column.
             * @param {string} className - Optional CSS class for the row.
             */
            function addResultRow(parameterHtml, valueHtml, className = '') {
                const row = resultTableBody.insertRow();
                if (className) {
                    row.className = className;
                }
                const paramCell = row.insertCell();
                const valueCell = row.insertCell();
                paramCell.innerHTML = parameterHtml;
                valueCell.innerHTML = valueHtml;
            }

            // Main Calculation Logic
            calculateBtn.addEventListener('click', function() {
                const form = document.getElementById('combustion-calculator-form');
                if (!form.checkValidity()) {
                    displayMessage("Please fill in all required fields correctly.", "error");
                    form.reportValidity(); // Show native browser validation messages
                    return;
                }

                const C_mass = parseFloat(carbonInput.value) / 100; // mass fraction
                const H_mass = parseFloat(hydrogenInput.value) / 100;
                const S_mass = parseFloat(sulfurInput.value) / 100;
                const O_mass = parseFloat(oxygenInput.value) / 100;
                const N_mass = parseFloat(nitrogenInput.value) / 100;
                const excessAirPct = parseFloat(excessAirInput.value); 
                const unitSystem = unitSystemSelect.value;
                const fuelFlowRate = parseFloat(fuelFlowRateInput.value);

                // Validate sum of composition
                const sumOfElements = C_mass + H_mass + S_mass + O_mass + N_mass;
                if (sumOfElements < 0.999 || sumOfElements > 1.001) { 
                    displayMessage("Sum of fuel composition percentages must be close to 100%. Please check your inputs.", "error");
                    return;
                }
                if (excessAirPct < 0) {
                     displayMessage("Excess Air percentage cannot be negative.", "error");
                     return;
                }
                 if (fuelFlowRate <= 0) {
                     displayMessage("Fuel Flow Rate must be a positive number.", "error");
                     return;
                }

                let calculationHtml = '<h4>Detailed Calculation Steps (Per kg/lb of Fuel):</h4>';

                // --- 1. Stoichiometric Oxygen Calculation (Mass Basis) ---
                
                // Precise Molecular weights
                const MW_C = 12.011;
                const MW_H = 1.008; 
                const MW_S = 32.06;
                const MW_O2 = 31.998;
                const MW_N2 = 28.014;
                const MW_CO2 = 44.009;
                const MW_H2O = 18.015;
                const MW_SO2 = 64.06;

                // Mass of O2 required per unit mass of element
                const O2_per_C = MW_O2 / MW_C; // C + O2 -> CO2
                const O2_per_H = MW_O2 / (4 * MW_H); // 4H + O2 -> 2H2O
                const O2_per_S = MW_O2 / MW_S; // S + O2 -> SO2
                
                calculationHtml += `<p><strong>Formulas for Oxygen Required (mass O₂ per mass element):</strong></p>
                                    <ul>
                                        <li>Carbon (C): \\( O_{2,C} = ${MW_O2.toFixed(3)} / ${MW_C.toFixed(3)} = ${O2_per_C.toFixed(3)} \\)</li>
                                        <li>Hydrogen (H): \\( O_{2,H} = ${MW_O2.toFixed(3)} / (4 \times ${MW_H.toFixed(3)}) = ${O2_per_H.toFixed(3)} \\)</li>
                                        <li>Sulfur (S): \\( O_{2,S} = ${MW_O2.toFixed(3)} / ${MW_S.toFixed(3)} = ${O2_per_S.toFixed(3)} \\)</li>
                                    </ul>`;

                calculationHtml += `<p><strong>1. Oxygen Required for Each Combustible Element:</strong></p>`;
                const o2_for_c = C_mass * O2_per_C;
                calculationHtml += `<p class="calculation-step">Oxygen for Carbon = ${C_mass.toFixed(4)} \times ${O2_per_C.toFixed(3)} = ${o2_for_c.toFixed(4)} kg/lb O₂</p>`;
                const o2_for_h = H_mass * O2_per_H;
                calculationHtml += `<p class="calculation-step">Oxygen for Hydrogen = ${H_mass.toFixed(4)} \times ${O2_per_H.toFixed(3)} = ${o2_for_h.toFixed(4)} kg/lb O₂</p>`;
                const o2_for_s = S_mass * O2_per_S;
                calculationHtml += `<p class="calculation-step">Oxygen for Sulfur = ${S_mass.toFixed(4)} \times ${O2_per_S.toFixed(3)} = ${o2_for_s.toFixed(4)} kg/lb O₂</p>`;

                const theoreticalOxygenRequired = o2_for_c + o2_for_h + o2_for_s;
                calculationHtml += `<p><strong>2. Total Oxygen Theoretically Required (Gross):</strong></p>
                                    <p class="calculation-step">Total O₂ = ${o2_for_c.toFixed(4)} + ${o2_for_h.toFixed(4)} + ${o2_for_s.toFixed(4)} = ${theoreticalOxygenRequired.toFixed(4)} kg/lb O₂</p>`;

                // Subtract oxygen already present in the fuel
                const netOxygenRequired = theoreticalOxygenRequired - O_mass;
                calculationHtml += `<p><strong>3. Net Oxygen Required (Net):</strong></p>
                                    <p class="formula">\\[ O_{2,net} = O_{2,total} - O_{fuel} \\]</p>
                                    <p class="calculation-step">Net O₂ Required = ${theoreticalOxygenRequired.toFixed(4)} - ${O_mass.toFixed(4)} (in fuel) = ${netOxygenRequired.toFixed(4)} kg/lb O₂</p>`;

                // --- 2. Air-Fuel Ratio (AFR) Calculation ---
                const O2_in_Air_by_Mass = 0.232;
                const N2_in_Air_by_Mass = 0.768; // (1 - 0.232)
                const stoich_AFR = netOxygenRequired / O2_in_Air_by_Mass;

                calculationHtml += `<p><strong>4. Stoichiometric Air-Fuel Ratio (AFR):</strong></p>
                                    <p>Air is ${ (O2_in_Air_by_Mass * 100).toFixed(1) }% O₂ and ${ (N2_in_Air_by_Mass * 100).toFixed(1) }% N₂ by mass.</p>
                                    <p class="formula">\\[ AFR_{stoich} = \\frac{O_{2,net}}{${O2_in_Air_by_Mass}} \\]</p>
                                    <p class="calculation-step">AFR_stoich = ${netOxygenRequired.toFixed(4)} / ${O2_in_Air_by_Mass} = ${stoich_AFR.toFixed(3)} kg/lb Air / kg/lb Fuel</p>`;
            
                const actual_AFR = stoich_AFR * (1 + excessAirPct / 100);
                calculationHtml += `<p><strong>5. Actual Air-Fuel Ratio (AFR<sub>Actual</sub>):</strong></p>
                                    <p class="formula">\\[ AFR_{Actual} = AFR_{stoich} \times (1 + \frac{\\text{Excess Air %}}{100}) \\]</p>
                                    <p class="calculation-step">AFR_Actual = ${stoich_AFR.toFixed(3)} \times (1 + ${excessAirPct.toFixed(1)} / 100) = ${actual_AFR.toFixed(3)} kg/lb Air / kg/lb Fuel</p>`;

                // --- 3. Flue Gas Mass Calculation (per kg/lb of fuel) ---
                calculationHtml += `<p><strong>6. Flue Gas Product Mass (per kg/lb of fuel):</strong></p>`;
                const mass_CO2_per_kg_fuel = C_mass * (MW_CO2 / MW_C);
                calculationHtml += `<p class="calculation-step">Mass CO₂ = ${C_mass.toFixed(4)} \times (${MW_CO2.toFixed(3)} / ${MW_C.toFixed(3)}) = ${mass_CO2_per_kg_fuel.toFixed(4)} kg/lb</p>`;
                const mass_H2O_per_kg_fuel = H_mass * (MW_H2O / (2 * MW_H));
                calculationHtml += `<p class="calculation-step">Mass H₂O = ${H_mass.toFixed(4)} \times (${MW_H2O.toFixed(3)} / (2 \times ${MW_H.toFixed(3)})) = ${mass_H2O_per_kg_fuel.toFixed(4)} kg/lb</p>`;
                const mass_SO2_per_kg_fuel = S_mass * (MW_SO2 / MW_S);
                calculationHtml += `<p class="calculation-step">Mass SO₂ = ${S_mass.toFixed(4)} \times (${MW_SO2.toFixed(3)} / ${MW_S.toFixed(3)}) = ${mass_SO2_per_kg_fuel.toFixed(4)} kg/lb</p>`;
                const mass_N2_total_per_kg_fuel = (actual_AFR * N2_in_Air_by_Mass) + N_mass;
                calculationHtml += `<p class="calculation-step">Mass N₂ (total) = (Actual AFR \times ${N2_in_Air_by_Mass}) + N_fuel = (${actual_AFR.toFixed(3)} \times ${N2_in_Air_by_Mass}) + ${N_mass.toFixed(4)} = ${mass_N2_total_per_kg_fuel.toFixed(4)} kg/lb</p>`;
                const mass_O2_excess_per_kg_fuel = (actual_AFR - stoich_AFR) * O2_in_Air_by_Mass;
                calculationHtml += `<p class="calculation-step">Mass O₂ (excess) = (Actual AFR - Stoich AFR) \times ${O2_in_Air_by_Mass} = (${actual_AFR.toFixed(3)} - ${stoich_AFR.toFixed(3)}) \times ${O2_in_Air_by_Mass} = ${mass_O2_excess_per_kg_fuel.toFixed(4)} kg/lb</p>`;
                
                const total_flue_gas_mass_per_kg_fuel = 1 + actual_AFR; // By conservation of mass
                calculationHtml += `<p class="calculation-step"><strong>Total Flue Gas Mass (per kg/lb fuel) = 1 (Fuel) + Actual AFR = 1 + ${actual_AFR.toFixed(3)} = ${total_flue_gas_mass_per_kg_fuel.toFixed(4)} kg/lb</strong></p>`;
                
                // --- 4. Flue Gas Molar Calculation (per kg/lb of fuel) ---
                calculationHtml += `<p><strong>7. Flue Gas Product Moles (per kg/lb of fuel):</strong></p>`;
                const moles_CO2 = mass_CO2_per_kg_fuel / MW_CO2;
                calculationHtml += `<p class="calculation-step">Moles CO₂ = ${mass_CO2_per_kg_fuel.toFixed(4)} / ${MW_CO2.toFixed(3)} = ${moles_CO2.toFixed(5)} kmol/lbmol</p>`;
                const moles_H2O = mass_H2O_per_kg_fuel / MW_H2O;
                calculationHtml += `<p class="calculation-step">Moles H₂O = ${mass_H2O_per_kg_fuel.toFixed(4)} / ${MW_H2O.toFixed(3)} = ${moles_H2O.toFixed(5)} kmol/lbmol</p>`;
                const moles_SO2 = mass_SO2_per_kg_fuel / MW_SO2;
                calculationHtml += `<p class="calculation-step">Moles SO₂ = ${mass_SO2_per_kg_fuel.toFixed(4)} / ${MW_SO2.toFixed(3)} = ${moles_SO2.toFixed(5)} kmol/lbmol</p>`;
                const moles_N2 = mass_N2_total_per_kg_fuel / MW_N2;
                calculationHtml += `<p class="calculation-step">Moles N₂ = ${mass_N2_total_per_kg_fuel.toFixed(4)} / ${MW_N2.toFixed(3)} = ${moles_N2.toFixed(5)} kmol/lbmol</p>`;
                const moles_O2 = mass_O2_excess_per_kg_fuel / MW_O2;
                calculationHtml += `<p class="calculation-step">Moles O₂ = ${mass_O2_excess_per_kg_fuel.toFixed(4)} / ${MW_O2.toFixed(3)} = ${moles_O2.toFixed(5)} kmol/lbmol</p>`;
                
                const total_moles_per_kg_fuel = moles_CO2 + moles_H2O + moles_SO2 + moles_N2 + moles_O2;
                calculationHtml += `<p class="calculation-step"><strong>Total Moles (per kg/lb fuel) = ${total_moles_per_kg_fuel.toFixed(5)} kmol/lbmol</strong></p>`;

                // --- 5. Flue Gas Properties & Flow Rates ---
                calculationHtml += `<p><strong>8. Flue Gas Properties & Total Flow Rates:</strong></p>`;
                const avg_flue_gas_MW = total_flue_gas_mass_per_kg_fuel / total_moles_per_kg_fuel;
                calculationHtml += `<p class="calculation-step">Avg. Flue Gas MW = Total Mass / Total Moles = ${total_flue_gas_mass_per_kg_fuel.toFixed(4)} / ${total_moles_per_kg_fuel.toFixed(5)} = ${avg_flue_gas_MW.toFixed(3)} kg/kmol (or lb/lbmol)</p>`;

                const actual_air_flow_mass = actual_AFR * fuelFlowRate;
                const total_flue_gas_flow_mass = total_flue_gas_mass_per_kg_fuel * fuelFlowRate;
                const total_flue_gas_flow_molar = total_flue_gas_flow_mass / avg_flue_gas_MW; // (kg/hr) / (kg/kmol) = kmol/hr
                
                const isMetric = unitSystem === 'metric';
                const molar_volume_NTP = isMetric ? 22.414 : 379.5; // m³/kmol or scf/lbmol (at 60F, 1atm)
                const vol_unit = isMetric ? "Nm³/hr" : "SCFH";
                const temp_NTP = isMetric ? "0°C" : "60°F";

                const total_flue_gas_flow_volume_NTP = total_flue_gas_flow_molar * molar_volume_NTP;
                calculationHtml += `<p class="calculation-step">Total Flue Gas Vol. Flow (${vol_unit} @ ${temp_NTP}, 1 atm) = ${total_flue_gas_flow_molar.toFixed(4)} kmol/hr (or lbmol/hr) \times ${molar_volume_NTP} = ${total_flue_gas_flow_volume_NTP.toFixed(2)} ${vol_unit}</p>`;


                // --- 6. Final Compositions ---
                const mass_unit = isMetric ? "kg/hr" : "lb/hr";
                const percent_CO2_mass = (mass_CO2_per_kg_fuel / total_flue_gas_mass_per_kg_fuel) * 100;
                const percent_H2O_mass = (mass_H2O_per_kg_fuel / total_flue_gas_mass_per_kg_fuel) * 100;
                const percent_SO2_mass = (mass_SO2_per_kg_fuel / total_flue_gas_mass_per_kg_fuel) * 100;
                const percent_N2_mass = (mass_N2_total_per_kg_fuel / total_flue_gas_mass_per_kg_fuel) * 100;
                const percent_O2_mass = (mass_O2_excess_per_kg_fuel / total_flue_gas_mass_per_kg_fuel) * 100;

                const percent_CO2_vol = (moles_CO2 / total_moles_per_kg_fuel) * 100;
                const percent_H2O_vol = (moles_H2O / total_moles_per_kg_fuel) * 100;
                const percent_SO2_vol = (moles_SO2 / total_moles_per_kg_fuel) * 100;
                const percent_N2_vol = (moles_N2 / total_moles_per_kg_fuel) * 100;
                const percent_O2_vol = (moles_O2 / total_moles_per_kg_fuel) * 100;


                // Clear previous results
                resultTableBody.innerHTML = '';
                calculationDetailsDiv.innerHTML = calculationHtml;

                // Populate results table
                addResultRow("Fuel Flow Rate", `<strong>${fuelFlowRate.toFixed(2)} ${mass_unit}</strong>`);
                addResultRow("Excess Air", `<strong>${excessAirPct.toFixed(1)} %</strong>`);

                addResultRow("<strong>Air & Flow Rates</strong>", "", "section-header");
                addResultRow("Stoichiometric Air-Fuel Ratio (AFR)", `<strong>${stoich_AFR.toFixed(3)}</strong> ${mass_unit} Air / ${mass_unit} Fuel`);
                addResultRow("Actual Air-Fuel Ratio (AFR<sub>Actual</sub>)", `<strong>${actual_AFR.toFixed(3)}</strong> ${mass_unit} Air / ${mass_unit} Fuel`);
                addResultRow("Actual Air Flow Rate", `<strong>${actual_air_flow_mass.toFixed(2)} ${mass_unit}</strong>`);
                addResultRow("Total Flue Gas Mass Flow Rate", `<strong>${total_flue_gas_flow_mass.toFixed(2)} ${mass_unit}</strong>`);
                addResultRow("Total Flue Gas Vol. Flow Rate (@ ${temp_NTP}, 1 atm)", `<strong>${total_flue_gas_flow_volume_NTP.toFixed(2)} ${vol_unit}</strong>`);

                addResultRow("<strong>Flue Gas Composition (Mass %)</strong>", "", "section-header");
                addResultRow("CO₂ Mass %", `${percent_CO2_mass.toFixed(2)} %`);
                addResultRow("H₂O Mass %", `${percent_H2O_mass.toFixed(2)} %`);
                addResultRow("SO₂ Mass %", `${percent_SO2_mass.toFixed(2)} %`);
                addResultRow("N₂ (total) Mass %", `${percent_N2_mass.toFixed(2)} %`);
                addResultRow("O₂ (excess) Mass %", `${percent_O2_mass.toFixed(2)} %`);
                addResultRow("Total Mass %", `<strong>${(percent_CO2_mass + percent_H2O_mass + percent_SO2_mass + percent_N2_mass + percent_O2_mass).toFixed(2)} %</strong>`);

                addResultRow("<strong>Flue Gas Composition (Volume/Mole %)</strong>", "", "section-header");
                addResultRow("CO₂ Volume %", `${percent_CO2_vol.toFixed(2)} %`);
                addResultRow("H₂O Volume %", `${percent_H2O_vol.toFixed(2)} %`);
                addResultRow("SO₂ Volume %", `${percent_SO2_vol.toFixed(2)} %`);
                addResultRow("N₂ (total) Volume %", `${percent_N2_vol.toFixed(2)} %`);
                addResultRow("O₂ (excess) Volume %", `${percent_O2_vol.toFixed(2)} %`);
                addResultRow("Total Volume %", `<strong>${(percent_CO2_vol + percent_H2O_vol + percent_SO2_vol + percent_N2_vol + percent_O2_vol).toFixed(2)} %</strong>`);

                addResultRow("<strong>Flue Gas Properties</strong>", "", "section-header");
                addResultRow("Average Flue Gas Molecular Weight", `<strong>${avg_flue_gas_MW.toFixed(3)}</strong> ${isMetric ? "kg/kmol" : "lb/lbmol"}`);


                // Re-render MathJax equations - ensure MathJax is fully loaded
                if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
                    window.MathJax.typesetPromise([calculationDetailsDiv, resultTableBody]);
                }

                // Display standard reference
                standardReference.innerHTML = "<strong>Calculation based on stoichiometric combustion principles and conservation of mass.</strong> Flue gas volume is calculated at Normal (0°C, 1 atm) or Standard (60°F, 1 atm) conditions. Refer to the footer disclaimer for critical limitations and industrial use considerations.";
                
                // Ensure result container is visible and transitions smoothly
                resultContainer.style.display = 'block'; // Make element visible
                resultContainer.offsetHeight; // Force reflow to ensure display change is registered before transition
                resultContainer.classList.add('show'); // Apply class that sets opacity to 1 and allows interaction

                resultContainer.scrollIntoView({ behavior: 'smooth' });
                displayMessage("Full combustion and flue gas analysis complete!", "info");
            });

            // === START: NEW THEME TOGGLE SCRIPT ===
            // Theme switch functionality
            const themeSwitch = document.getElementById('theme-switch');
            const body = document.body;
            const currentTheme = localStorage.getItem('theme');
            
            if (currentTheme) {
                body.classList.add(currentTheme);
                if (currentTheme === 'dark-mode') {
                    themeSwitch.checked = true;
                }
            }
            
            themeSwitch.addEventListener('change', () => {
                if (themeSwitch.checked) {
                    body.classList.add('dark-mode');
                    localStorage.setItem('theme', 'dark-mode');
                } else {
                    body.classList.remove('dark-mode');
                    localStorage.setItem('theme', 'light-mode');
                }
            });
            // === END: NEW THEME TOGGLE SCRIPT ===
        });
    </script>
</body>
</html>

