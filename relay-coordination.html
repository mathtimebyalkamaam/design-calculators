<!DOCTYPE html>
<html lang="en">
<head>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5936527763614780"
     crossorigin="anonymous"></script>
                <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-23Y1V450SR"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-23Y1V450SR');   
</script>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5936527763614780"
     crossorigin="anonymous"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Protective Relay Coordination - Design Calculators - Electrical</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="icon" href="/favicon.ico" type="image/x-icon">

    <style>
        /* Basic CSS Variables for a consistent theme */
        :root {
            --primary-color: #4CAF50; /* Green */
            --secondary-color: #45a049; /* Darker Green */
            --accent-color: #FFC107; /* Amber */
            --bg-color: #f4f7f6; /* Light Greyish Green */
            --card-bg: #ffffff; /* White */
            --text-color: #333333; /* Dark Grey */
            --header-bg: #2C3E50; /* Dark Blue Grey */
            --footer-bg: #34495E; /* Slightly Lighter Dark Blue Grey */
            --border-color: #cccccc;
            --card-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            --hover-color: #e2e6ea;
            --canvas-bg: #f0f0f0; /* Light background for canvas */
            --input-bg: #ffffff;
            --input-border-focus: #4CAF50;
        }

        /* Dark Mode Variables */
        body.dark-mode {
            --bg-color: #2c3e50;
            --card-bg: #34495e;
            --text-color: #ecf0f1;
            --header-bg: #2c3e50;
            --footer-bg: #2c3e50;
            --border-color: #555555;
            --card-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            --hover-color: #446688;
            --canvas-bg: #444444; /* Dark background for canvas */
            --input-bg: #446688;
            --input-border-focus: #4CAF50;
        }

        /* General Body Styling */
        body {
            font-family: 'Inter', sans-serif; /* Using Inter as specified */
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 960px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: var(--header-bg);
            color: white;
            padding: 20px 0;
            text-align: center;
            box-shadow: var(--card-shadow);
            position: relative; /* For theme toggle positioning */
        }

        header h1 {
            margin: 0;
            font-size: 2.5em;
            color: var(--primary-color);
        }

        header .subtitle {
            margin: 5px 0 0;
            font-size: 1em;
            color: #bdc3c7;
        }

        main {
            padding: 20px 0;
        }

        .tool-container {
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 20px;
            box-shadow: var(--card-shadow);
            margin-bottom: 20px;
        }

        .tool-container h2 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            margin-top: 0;
            margin-bottom: 20px;
        }
        /* Ensure H2 is visible in dark mode */
        body.dark-mode .tool-container h2 {
            color: white; /* Explicitly set to white for visibility */
            border-bottom-color: white;
        }


        .tool-description {
            margin-bottom: 20px;
            color: var(--text-color);
        }

        .back-button {
            display: inline-block;
            background-color: var(--primary-color);
            color: white;
            padding: 10px 15px;
            border-radius: 4px;
            text-decoration: none;
            margin-bottom: 20px;
            transition: background-color 0.3s;
        }

        .back-button:hover {
            background-color: var(--secondary-color);
        }

        /* Theme Toggle */
        .theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
        }

        .theme-toggle .light-icon,
        .theme-toggle .dark-icon {
            color: white;
            margin: 0 5px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
        }

        input:checked + .slider {
            background-color: var(--primary-color);
        }

        input:focus + .slider {
            box-shadow: 0 0 1px var(--primary-color);
        }

        input:checked + .slider:before {
            -webkit-transform: translateX(26px);
            -ms-transform: translateX(26px);
            transform: translateX(26px);
        }

        /* Rounded sliders */
        .slider.round {
            border-radius: 34px;
        }

        .slider.round:before {
            border-radius: 50%;
        }

        /* Footer Styling */
        footer {
            background-color: var(--footer-bg);
            color: white;
            padding: 20px 0;
            text-align: center;
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1);
            margin-top: 30px;
        }

        footer .disclaimer h3,
        footer .social-share h3 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        footer .disclaimer p {
            font-size: 0.9em;
            color: #bdc3c7;
        }

        .social-buttons {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .social-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            color: white;
            text-decoration: none;
            font-size: 1.2em;
            transition: transform 0.3s ease-in-out;
        }

        .social-btn:hover {
            transform: translateY(-3px);
        }

        .social-btn.linkedin { background-color: #0A66C2; }
        .social-btn.facebook { background-color: #1877F2; }
        .social-btn.twitter { background-color: #1DA1F2; }
        .social-btn.whatsapp { background-color: #25D366; }
        .social-btn.reddit { background-color: #FF4500; }

        /* Styles for Calculator Form */
        .calculator-form {
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: var(--card-shadow);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--text-color); /* Ensure label text is visible */
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--input-bg);
            color: var(--text-color);
            transition: border-color 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--input-border-focus);
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.5); /* Primary color with transparency */
        }
        
        .form-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .form-row .form-group {
            flex: 1 1 200px;
        }
        
        .calculate-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin-top: 10px;
            transition: background-color 0.3s ease-in-out, transform 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .calculate-btn:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }

        .calculate-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .calculate-btn .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #fff;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: none; /* Hidden by default */
        }

        .calculate-btn.loading .spinner {
            display: inline-block;
        }

        .calculate-btn.loading {
            cursor: not-allowed;
            opacity: 0.8;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .result-container {
            margin-top: 30px;
            padding: 20px;
            border-radius: 8px;
            background-color: var(--card-bg);
            box-shadow: var(--card-shadow);
            display: none; /* Hidden by default */
            animation: fadeIn 0.8s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .result-container h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        /* Ensure H3 is visible in dark mode */
        body.dark-mode .result-container h3 {
            color: white; /* Explicitly set to white for visibility */
        }

        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .result-table th, .result-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-color); /* Ensure text color changes */
        }
        
        .result-table th {
            background-color: var(--hover-color);
            font-weight: bold;
        }
        
        .standard-reference {
            margin-top: 20px;
            font-style: italic;
            font-size: 0.9rem;
            color: var(--text-color); /* Ensure visibility in dark mode */
        }
        
        .info-icon {
            color: var(--primary-color);
            margin-left: 5px;
            cursor: help;
            transition: transform 0.2s ease-in-out;
        }
        .info-icon:hover {
            transform: scale(1.1);
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 250px; /* Increased width for more text */
            background-color: var(--header-bg); /* Use header-bg for tooltip background */
            color: white; /* Keep white text for tooltip */
            text-align: center;
            border-radius: 6px;
            padding: 8px 10px; /* Increased padding */
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -125px; /* Half of new width */
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.85rem;
            line-height: 1.3;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* Custom message box style */
        #custom-message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            font-weight: bold;
            color: white;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            min-width: 300px;
            text-align: center;
        }
        #custom-message-box.error { background-color: #dc3545; } /* Red */
        #custom-message-box.warning { background-color: #ffc107; color: #333; } /* Amber */
        #custom-message-box.info { background-color: #28a745; } /* Green */
        @keyframes shake {
            0%, 100% { transform: translateX(-50%); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(calc(-50% - 5px)); }
            20%, 40%, 60%, 80% { transform: translateX(calc(-50% + 5px)); }
        }

        .message-box-shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }


        /* Styles for detailed calculation steps */
        .detailed-calculations {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--hover-color); /* A lighter background for contrast */
            color: var(--text-color); /* Ensure text visibility */
            animation: fadeIn 0.8s ease-out; /* Add fade-in animation */
        }

        body.dark-mode .detailed-calculations {
            background-color: #3a475a; /* Darker background for contrast in dark mode */
            border-color: #6a7a8f;
        }

        .detailed-calculations h4 {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 10px;
            color: var(--primary-color); /* Highlight heading */
        }
        body.dark-mode .detailed-calculations h4 {
            color: var(--primary-color); /* Use lighter primary color in dark mode */
        }

        .detailed-calculations p {
            margin-bottom: 5px;
            font-size: 0.95rem;
            line-height: 1.4;
        }

        .detailed-calculations strong {
            color: var(--secondary-color); /* Highlight key terms in formulas */
        }
        body.dark-mode .detailed-calculations strong {
            color: var(--primary-color); /* Use lighter primary color for highlights in dark mode */
        }

        /* MathJax rendered formulas will have the desired styling */
        .formula {
            font-family: 'Courier New', Courier, monospace; /* Not strictly needed with MathJax, but good for raw */
            background-color: rgba(0,0,0,0.05); /* Light tint for formula background */
            padding: 2px 5px;
            border-radius: 3px;
            display: inline-block; /* Helps with MathJax inline rendering */
            margin-top: 5px;
            font-size: 0.9em;
        }
        body.dark-mode .formula {
            background-color: rgba(255,255,255,0.05);
        }

        .calculation-step {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px dashed var(--border-color);
        }

        .detailed-calculations .calculation-step:last-child {
            border-bottom: none; /* No border after the last step */
        }

        /* Relay input tabs */
        .tab-buttons {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
        }

        .tab-button {
            padding: 10px 15px;
            cursor: pointer;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            background-color: var(--hover-color);
            color: var(--text-color);
            border: 1px solid transparent;
            border-bottom: none;
            transition: background-color 0.3s, color 0.3s;
        }

        .tab-button.active {
            background-color: var(--card-bg);
            border-color: var(--border-color);
            border-bottom-color: var(--card-bg);
            font-weight: bold;
            color: var(--primary-color);
        }
        body.dark-mode .tab-button.active {
            border-bottom-color: var(--card-bg); /* Match background for seamless look */
            color: white;
        }

        .tab-button:hover:not(.active) {
            background-color: var(--hover-color);
            color: var(--primary-color);
        }
        body.dark-mode .tab-button:hover:not(.active) {
            color: white; /* Keep white on hover for dark mode */
        }

        .tab-content {
            display: none;
            padding-top: 10px;
        }

        .tab-content.active {
            display: block;
        }

        /* Canvas for TCC Plot */
        #tcc-plot-section {
            display: none; /* Hidden by default */
        }

        #relay-plot-canvas {
            border: 1px solid var(--border-color);
            background-color: var(--canvas-bg);
            border-radius: 8px;
            margin-top: 20px;
            width: 100%;
            height: 400px; /* Fixed height for plotting area */
        }
    </style>
    <!-- MathJax configuration and loading -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
            },
            svg: {
                fontCache: 'global'
            },
            options: {
                processHtmlClass: 'math-content', // Process elements with this class
                ignoreHtmlClass: 'no-mathjax'      // Ignore elements with this class
            }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>
    <header>
        <div class="container">
            <h1>Design Calculators - Electrical</h1>
            <p class="subtitle">Electrical Calculations Made Easy — Learn with Every Step</p>
            <div class="theme-toggle">
                <span class="light-icon"><i class="fas fa-sun"></i></span>
                <label class="switch">
                    <input type="checkbox" id="theme-switch">
                    <span class="slider round"></span>
                </label>
                <span class="dark-icon"><i class="fas fa-moon"></i></span>
            </div>
        </div>
    </header>

    <main class="container"> 
        <a href="indexEle.html" class="back-button"><i class="fas fa-arrow-left"></i> Back to Tools</a>
       
        
        <div class="tool-container">
            <h2>Protective Relay Coordination</h2>
            
            <div class="tool-description">
                <p>This tool provides a conceptual framework for protective relay coordination. You can input system parameters, configure overcurrent relays, and visualize their time-current characteristics (TCC) for coordination assessment. **Note: This is a simplified model for demonstration; full engineering analysis requires specialized software.**</p>
            </div>
        
            <div class="calculator-form">
                <form id="relay-coordination-form">
                    <!-- Section 1: System Configuration -->
                    <h3 class="text-xl font-semibold mb-4 text-primary-color border-b pb-2 border-primary-color">1. System Configuration</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="system-voltage">System Voltage (kV) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Nominal system line-to-line voltage.</span></span></label>
                            <input type="number" id="system-voltage" min="0.1" step="0.1" value="11" required class="input-focus-animation">
                        </div>
                        <div class="form-group">
                            <label for="source-mva">Source Short Circuit MVA (at PCC) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Short circuit capacity of the upstream source at the point of common coupling.</span></span></label>
                            <input type="number" id="source-mva" min="1" step="1" value="500" required class="input-focus-animation">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="line-impedance">Line Impedance (Ohms/phase) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Total impedance of the line section between relays.</span></span></label>
                            <input type="number" id="line-impedance" min="0.001" step="0.001" value="0.5" required class="input-focus-animation">
                        </div>
                         <div class="form-group">
                            <label for="normal-load-current">Normal Load Current (A) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Typical maximum load current through the protected feeder.</span></span></label>
                            <input type="number" id="normal-load-current" min="1" step="1" value="100" required class="input-focus-animation">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="cti">Coordination Time Interval (CTI) (s) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The minimum time difference between upstream and downstream relay operation for proper coordination. Typically 0.2 to 0.4 seconds.</span></span></label>
                            <input type="number" id="cti" min="0.05" max="1" step="0.01" value="0.3" required class="input-focus-animation">
                        </div>
                    </div>

                    <!-- Section 2: Relay Data -->
                    <h3 class="text-xl font-semibold mb-4 mt-8 text-primary-color border-b pb-2 border-primary-color">2. Relay Data</h3>

                    <div class="tab-buttons">
                        <div class="tab-button active" data-tab="overcurrent">Overcurrent (50/51)</div>
                        <div class="tab-button" data-tab="differential">Differential (87)</div>
                        <div class="tab-button" data-tab="distance">Distance (21)</div>
                    </div>

                    <!-- Overcurrent Relay Tab Content -->
                    <div id="overcurrent-tab" class="tab-content active">
                        <p class="mb-4">Configure two series overcurrent relays (downstream and upstream) for coordination.</p>
                        <!-- Downstream Relay -->
                        <h4 class="text-lg font-medium mb-2 text-secondary-color">Downstream Relay (e.g., Feeder Breaker)</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="oc-ct-ratio-down">CT Ratio (Primary/Secondary) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Current Transformer ratio for the downstream relay. Example: 200/5.</span></span></label>
                                <input type="text" id="oc-ct-ratio-down" value="200/5" placeholder="e.g., 200/5" required class="input-focus-animation">
                            </div>
                            <div class="form-group">
                                <label for="oc-curve-down">Characteristic Curve</label>
                                <select id="oc-curve-down" required class="input-focus-animation">
                                    <option value="IDMT-Normal Inverse">IDMT - Normal Inverse</option>
                                    <option value="IDMT-Very Inverse">IDMT - Very Inverse</option>
                                    <option value="IDMT-Extremely Inverse">IDMT - Extremely Inverse</option>
                                    <option value="Definite Time">Definite Time</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="oc-pickup-down">Pick-up Current (A) (Primary) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Desired primary pick-up current for the downstream relay.</span></span></label>
                                <input type="number" id="oc-pickup-down" min="1" step="1" value="150" required class="input-focus-animation">
                            </div>
                            <div class="form-group">
                                <label for="oc-tms-down">Time Multiplier Setting (TMS) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Desired Time Multiplier Setting for the downstream relay. Typically 0.05 to 1.0.</span></span></label>
                                <input type="number" id="oc-tms-down" min="0.05" max="1" step="0.01" value="0.1" required class="input-focus-animation">
                            </div>
                        </div>

                        <hr class="my-6 border-border-color">

                        <!-- Upstream Relay -->
                        <h4 class="text-lg font-medium mb-2 text-secondary-color">Upstream Relay (e.g., Substation Main)</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="oc-ct-ratio-up">CT Ratio (Primary/Secondary) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Current Transformer ratio for the upstream relay. Example: 600/5.</span></span></label>
                                <input type="text" id="oc-ct-ratio-up" value="600/5" placeholder="e.g., 600/5" required class="input-focus-animation">
                            </div>
                            <div class="form-group">
                                <label for="oc-curve-up">Characteristic Curve</label>
                                <select id="oc-curve-up" required class="input-focus-animation">
                                    <option value="IDMT-Normal Inverse">IDMT - Normal Inverse</option>
                                    <option value="IDMT-Very Inverse">IDMT - Very Inverse</option>
                                    <option value="IDMT-Extremely Inverse">IDMT - Extremely Inverse</option>
                                    <option value="Definite Time">Definite Time</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="oc-pickup-up">Pick-up Current (A) (Primary) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Desired primary pick-up current for the upstream relay.</span></span></label>
                                <input type="number" id="oc-pickup-up" min="1" step="1" value="300" required class="input-focus-animation">
                            </div>
                            <div class="form-group">
                                <label for="oc-tms-up">Time Multiplier Setting (TMS) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Desired Time Multiplier Setting for the upstream relay. Will be adjusted for coordination.</span></span></label>
                                <input type="number" id="oc-tms-up" min="0.05" max="1" step="0.01" value="0.2" required class="input-focus-animation">
                            </div>
                        </div>
                    </div>

                    <!-- Differential Relay Tab Content -->
                    <div id="differential-tab" class="tab-content">
                        <p class="mb-4">Differential relays are used for fast and sensitive protection of equipment like transformers, generators, and busbars. Configure parameters for two CTs on either side of the protected equipment (e.g., a transformer).</p>
                        
                        <!-- Differential Relay 1 -->
                        <h4 class="text-lg font-medium mb-2 text-secondary-color">CT 1 (e.g., Primary Side)</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="diff1-ct-ratio">CT Ratio (Primary/Secondary) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Current Transformer ratio for CT 1. Example: 500/5.</span></span></label>
                                <input type="text" id="diff1-ct-ratio" value="500/5" placeholder="e.g., 500/5" class="input-focus-animation">
                            </div>
                            <div class="form-group">
                                <label for="diff1-primary-current">Primary Current (A) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Actual primary current flowing through CT 1.</span></span></label>
                                <input type="number" id="diff1-primary-current" min="0.1" step="0.1" value="400" class="input-focus-animation">
                            </div>
                        </div>
                        <h4 class="text-lg font-medium mb-2 text-secondary-color">CT 2 (e.g., Secondary Side)</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="diff2-ct-ratio">CT Ratio (Primary/Secondary) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Current Transformer ratio for CT 2. Example: 1000/5.</span></span></label>
                                <input type="text" id="diff2-ct-ratio" value="1000/5" placeholder="e.g., 1000/5" class="input-focus-animation">
                            </div>
                            <div class="form-group">
                                <label for="diff2-primary-current">Primary Current (A) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Actual primary current flowing through CT 2.</span></span></label>
                                <input type="number" id="diff2-primary-current" min="0.1" step="0.1" value="400" class="input-focus-animation">
                            </div>
                        </div>
                        <hr class="my-6 border-border-color">
                        <h4 class="text-lg font-medium mb-2 text-secondary-color">Differential Relay Settings</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="diff-pickup">Differential Pick-up (A) (Secondary) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Minimum differential current (secondary) to operate the relay.</span></span></label>
                                <input type="number" id="diff-pickup" min="0.01" step="0.01" value="0.1" class="input-focus-animation">
                            </div>
                            <div class="form-group">
                                <label for="diff-bias-slope1">Bias Slope 1 (%) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Slope of the operating characteristic in the lower current range.</span></span></label>
                                <input type="number" id="diff-bias-slope1" min="1" max="100" step="1" value="10" class="input-focus-animation">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="diff-bias-slope2">Bias Slope 2 (%) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Slope of the operating characteristic in the higher current range.</span></span></label>
                                <input type="number" id="diff-bias-slope2" min="1" max="100" step="1" value="40" class="input-focus-animation">
                            </div>
                            <div class="form-group">
                                <label for="diff-slope-change-point">Slope Change Point (A) (Secondary) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Restraint current at which the bias slope changes.</span></span></label>
                                <input type="number" id="diff-slope-change-point" min="0.1" step="0.1" value="5" class="input-focus-animation">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="diff-ip-pickup">Instantaneous Pick-up (A) (Secondary) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Setting for very high differential fault currents, operates instantaneously.</span></span></label>
                                <input type="number" id="diff-ip-pickup" min="1" step="1" value="10" class="input-focus-animation">
                            </div>
                        </div>
                    </div>

                    <!-- Distance Relay Tab Content -->
                    <div id="distance-tab" class="tab-content">
                        <p class="mb-4">Distance relays provide primary and backup protection for transmission lines based on impedance. They have multiple zones with time delays. Input parameters for a single distance relay protecting a line section.</p>
                        
                        <!-- Distance Relay 1 -->
                        <h4 class="text-lg font-medium mb-2 text-secondary-color">Distance Relay Settings</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="dist-system-voltage">System Voltage (kV) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The nominal system voltage at the relay location.</span></span></label>
                                <input type="number" id="dist-system-voltage" min="0.1" step="0.1" value="132" class="input-focus-animation">
                            </div>
                            <div class="form-group">
                                <label for="dist-vt-ratio">VT Ratio (Primary/Secondary) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Voltage Transformer ratio for the relay. Example: 132000/110.</span></span></label>
                                <input type="text" id="dist-vt-ratio" value="132000/110" placeholder="e.g., 132000/110" class="input-focus-animation">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="dist-ct-ratio">CT Ratio (Primary/Secondary) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Current Transformer ratio for the relay. Example: 400/5.</span></span></label>
                                <input type="text" id="dist-ct-ratio" value="400/5" placeholder="e.g., 400/5" class="input-focus-animation">
                            </div>
                            <div class="form-group">
                                <label for="dist-line-impedance">Protected Line Impedance (Ohms Primary) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The total primary impedance of the line section being protected by this relay.</span></span></label>
                                <input type="number" id="dist-line-impedance" min="0.01" step="0.01" value="20" class="input-focus-animation">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="dist-zone1-percent">Zone 1 Reach (% of Line Impedance) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Primary protection zone, typically 80-90% of protected line impedance.</span></span></label>
                                <input type="number" id="dist-zone1-percent" min="1" max="100" step="1" value="85" class="input-focus-animation">
                            </div>
                            <div class="form-group">
                                <label for="dist-zone2-percent">Zone 2 Reach (% of Line Impedance) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Backup protection zone for the entire line and typically 20-50% of the shortest adjacent line. Enter as percentage of *this* line's impedance for simplification.</span></span></label>
                                <input type="number" id="dist-zone2-percent" min="1" max="200" step="1" value="120" class="input-focus-animation">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="dist-zone2-time">Zone 2 Time Delay (s) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Time delay for Zone 2 operation. Typically 0.2 to 0.4 seconds.</span></span></label>
                                <input type="number" id="dist-zone2-time" min="0.05" step="0.01" value="0.3" class="input-focus-animation">
                            </div>
                            <div class="form-group">
                                <label for="dist-zone3-percent">Zone 3 Reach (% of Line Impedance) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Remote backup protection zone. Enter as percentage of *this* line's impedance for simplification.</span></span></label>
                                <input type="number" id="dist-zone3-percent" min="1" max="300" step="1" value="180" class="input-focus-animation">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="dist-zone3-time">Zone 3 Time Delay (s) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Time delay for Zone 3 operation. Typically 0.8 to 1.5 seconds.</span></span></label>
                                <input type="number" id="dist-zone3-time" min="0.05" step="0.01" value="0.8" class="input-focus-animation">
                            </div>
                            <div class="form-group">
                                <label for="dist-fault-impedance-sim">Simulated Fault Impedance (Ohms Primary) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Enter a primary impedance value to simulate a fault at that location. The relay will determine which zone this fault falls into.</span></span></label>
                                <input type="number" id="dist-fault-impedance-sim" min="0.01" step="0.01" value="15" class="input-focus-animation">
                            </div>
                        </div>
                    </div>
                    
                    <button type="button" id="coordinate-relays-btn" class="calculate-btn">
                        Analyze Coordination <span class="spinner"></span>
                    </button>
                </form>
            </div>
            
            <div id="result-container" class="result-container">
                <h3>Coordination Analysis Summary</h3>
                <table class="result-table">
                    <thead>
                        <tr>
                            <th>Parameter</th>
                            <th>Value</th>
                        </tr>
                    </thead>
                    <tbody id="result-table-body">
                        <!-- Results will be dynamically inserted here -->
                    </tbody>
                </table>
                
                <!-- TCC Plot Canvas -->
                <div id="tcc-plot-section">
                    <h3 class="text-xl font-semibold mb-4 mt-8 text-primary-color">Time-Current Characteristic (TCC) Plot</h3>
                    <canvas id="relay-plot-canvas"></canvas>
                    <p class="text-sm italic text-gray-600 dark:text-gray-400 mt-2">**Note:** This plot is a simplified illustration. Actual TCC curves require precise logarithmic scaling and plotting based on specific relay models and standards. For detailed analysis, specialized software is recommended.</p>
                </div>

                <!-- Detailed calculations section -->
                <div id="detailed-calculations" class="detailed-calculations mt-6 math-content">
                    <!-- Dynamic heading will be inserted here -->
                    <!-- Detailed calculation steps will be dynamically inserted here -->
                </div>
                <div class="standard-reference" id="standard-reference">
                    <p>Protective relay coordination adheres to principles and standards set by organizations such as: <br>
                    - <strong>IEEE (Institute of Electrical and Electronics Engineers):</strong> E.g., IEEE Std 242 (Buff Book) for Industrial and Commercial Power Systems Protection, and various guides for specific relay types. <br>
                    - <strong>IEC (International Electrotechnical Commission):</strong> E.g., IEC 60255 series for Measuring Relays and Protection Equipment. <br>
                    - <strong>ANSI (American National Standards Institute):</strong> Relevant standards for device numbers and relay functions.</p>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <div class="disclaimer">
                
                <p>Disclaimer: Always verify calculation results against applicable engineering standards and guidelines.</p>
            </div>
            <div class="credit">
                <p>Created by A Sharma</p>
                <p>&copy; 2025 Design Calculators</p>
            </div>
            <div class="social-share">
                <h3>Share This Site</h3>
                <div class="social-buttons">
                    <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://designcalculators.co.in&title=Design Calculators - Electrical" target="_blank" class="social-btn linkedin">
                        <i class="fab fa-linkedin"></i>
                    </a>
                    <a href="https://www.facebook.com/sharer/sharer.php?u=https://designcalculators.co.in" target="_blank" class="social-btn facebook">
                        <i class="fab fa-facebook"></i>
                    </a>
                    <a href="https://twitter.com/intent/tweet?text=Check out this amazing Design Calculators - Electrical!&url=https://designcalculators.co.in" target="_blank" class="social-btn twitter">
                        <i class="fab fa-twitter"></i>
                    </a>
                    <a href="https://api.whatsapp.com/send?text=Check out this amazing Design Calculators - Electrical! https://designcalculators.co.in" target="_blank" class="social-btn whatsapp">
                        <i class="fab fa-whatsapp"></i>
                    </a>
                    <a href="https://www.reddit.com/submit?url=https://designcalculators.co.in&title=Design Calculators - Electrical" target="_blank" class="social-btn reddit">
                        <i class="fab fa-reddit"></i>
                    </a>
                </div>
            </div>
        </div>
    </footer>

    <!-- Custom Message Box -->
    <div id="custom-message-box"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const coordinateRelaysBtn = document.getElementById('coordinate-relays-btn');
            const resultContainer = document.getElementById('result-container');
            const resultTableBody = document.getElementById('result-table-body');
            const detailedCalculationsDiv = document.getElementById('detailed-calculations');
            const tccPlotSection = document.getElementById('tcc-plot-section'); 
            const relayPlotCanvas = document.getElementById('relay-plot-canvas');
            const ctx = relayPlotCanvas.getContext('2d');
            
            // Variables to store the last calculated values for redraw on resize
            let lastFaultCurrentDownstream = 0;
            let lastDownstreamRelayOpTime = 0;
            let lastOcPickupDown = 0;
            let lastOcTmsDown = 0;
            let lastOcCTRDown = 0;
            let lastOcPickupUp = 0;
            let lastAdjustedOcTmsUp = 0;
            let lastOcCTRUP = 0;
            
            // Constants for IDMT curves (IEEE C37.112 Standard)
            const IDMT_CONSTANTS = {
                'IDMT-Normal Inverse': { A: 0.14, B: 0.02 },
                'IDMT-Very Inverse': { A: 13.5, B: 1.0 },
                'IDMT-Extremely Inverse': { A: 80.0, B: 2.0 },
                'Definite Time': { A: null, B: null } // Handled separately
            };


            // Theme switch logic
            const themeSwitch = document.getElementById('theme-switch');
            if (themeSwitch) {
                // Check for saved theme preference
                if (localStorage.getItem('theme') === 'dark') {
                    document.body.classList.add('dark-mode');
                    themeSwitch.checked = true;
                }

                themeSwitch.addEventListener('change', function() {
                    if (this.checked) {
                        document.body.classList.add('dark-mode');
                        localStorage.setItem('theme', 'dark');
                    } else {
                        document.body.classList.remove('dark-mode');
                        localStorage.setItem('theme', 'light');
                    }
                });
            }

            // Tab functionality
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // Hide plot section when switching tabs
                    tccPlotSection.style.display = 'none';
                    resultContainer.style.display = 'none'; // Hide results when switching tabs until new calculation

                    button.classList.add('active');
                    document.getElementById(`${button.dataset.tab}-tab`).classList.add('active');
                });
            });

            coordinateRelaysBtn.addEventListener('click', function() {
                // Show spinner and disable button
                coordinateRelaysBtn.classList.add('loading');
                coordinateRelaysBtn.disabled = true;

                // Determine which tab is active
                const activeTab = document.querySelector('.tab-button.active').dataset.tab;

                // Hide plot section initially for all clicks, then conditionally show
                tccPlotSection.style.display = 'none';
                
                // Clear previous results regardless of tab
                resultTableBody.innerHTML = '';
                // Dynamically set the heading for detailed calculations based on active tab
                detailedCalculationsDiv.innerHTML = `<h3 class="text-xl font-semibold mb-3 text-gray-700 dark:text-white">Detailed Coordination Steps (${activeTab.charAt(0).toUpperCase() + activeTab.slice(1)})</h3>`; 

                if (activeTab === 'overcurrent') {
                    // Get System Configuration Inputs
                    const systemVoltage = parseFloat(document.getElementById('system-voltage').value);
                    const sourceMVA = parseFloat(document.getElementById('source-mva').value);
                    const lineImpedance = parseFloat(document.getElementById('line-impedance').value);
                    const normalLoadCurrent = parseFloat(document.getElementById('normal-load-current').value);
                    const cti = parseFloat(document.getElementById('cti').value);

                    // Get Overcurrent Relay Inputs
                    const ocCTRatioDownStr = document.getElementById('oc-ct-ratio-down').value;
                    const ocCurveDown = document.getElementById('oc-curve-down').value;
                    const ocPickupDown = parseFloat(document.getElementById('oc-pickup-down').value);
                    let ocTmsDown = parseFloat(document.getElementById('oc-tms-down').value); 

                    const ocCTRatioUpStr = document.getElementById('oc-ct-ratio-up').value;
                    const ocCurveUp = document.getElementById('oc-curve-up').value;
                    const ocPickupUp = parseFloat(document.getElementById('oc-pickup-up').value);
                    let ocTmsUp = parseFloat(document.getElementById('oc-tms-up').value); 

                    // Input Validation for Overcurrent
                    if (isNaN(systemVoltage) || systemVoltage <= 0 || isNaN(sourceMVA) || sourceMVA <= 0 || isNaN(lineImpedance) || lineImpedance <= 0 || isNaN(normalLoadCurrent) || normalLoadCurrent <= 0 || isNaN(cti) || cti <= 0 || cti > 1 ||
                        isNaN(ocPickupDown) || ocPickupDown <= 0 || isNaN(ocTmsDown) || ocTmsDown <= 0 || ocTmsDown > 1 || isNaN(ocPickupUp) || ocPickupUp <= 0 || isNaN(ocTmsUp) || ocTmsUp <= 0 || ocTmsUp > 1 ||
                        !ocCTRatioDownStr || !ocCTRatioUpStr) {
                        displayMessage("Please fill in all required fields for Overcurrent coordination with valid positive numbers. CTI and TMS should be between 0.05 and 1.0.", "error", true);
                        resultContainer.style.display = 'none'; 
                        coordinateRelaysBtn.classList.remove('loading');
                        coordinateRelaysBtn.disabled = false;
                        return;
                    }

                    // Parse CT Ratios
                    const parseCTRatio = (ctRatioStr) => {
                        const parts = ctRatioStr.split('/').map(Number);
                        if (parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1]) && parts[1] !== 0) {
                            return parts[0] / parts[1];
                        }
                        displayMessage(`Invalid CT Ratio format: ${ctRatioStr}. Use P/S (e.g., 200/5).`, "error", true);
                        return NaN;
                    };

                    const ocCTRDown = parseCTRatio(ocCTRatioDownStr);
                    const ocCTRUP = parseCTRatio(ocCTRatioUpStr);

                    if (isNaN(ocCTRDown) || isNaN(ocCTRUP)) {
                        resultContainer.style.display = 'none'; 
                        coordinateRelaysBtn.classList.remove('loading');
                        coordinateRelaysBtn.disabled = false;
                        return; 
                    }

                    // --- Simplified Short Circuit Calculation ---
                    const baseMVA = 100;
                    const baseKV = systemVoltage;
                    const baseOhms = (baseKV * baseKV) / baseMVA; 

                    const sourceImpedanceOhms = (baseKV * baseKV) / sourceMVA; 
                    addDetailedCalculationStep(
                        "Step 1: Calculate System Base Impedance and Source Impedance",
                        `Base Impedance ($Z_{\\text{base}}$) = $\\frac{(\\text{System Voltage (kV)})^2}{\\text{Base MVA}}$`,
                        `$Z_{\\text{base}} = \\frac{(${baseKV}\\text{ kV})^2}{${baseMVA}\\text{ MVA}} = ${baseOhms.toFixed(3)}\\text{ Ohms}$<br>` +
                        `Source Impedance ($Z_{\\text{source}}$) = $\\frac{(\\text{System Voltage (kV)})^2}{\\text{Source MVA}}$`,
                        `$Z_{\\text{source}} = \\frac{(${systemVoltage}\\text{ kV})^2}{${sourceMVA}\\text{ MVA}} = ${sourceImpedanceOhms.toFixed(3)}\\text{ Ohms}$`
                    );

                    const totalImpedanceDownstreamFault = sourceImpedanceOhms + lineImpedance;
                    const faultCurrentDownstream = (systemVoltage * 1000) / (Math.sqrt(3) * totalImpedanceDownstreamFault);
                    addDetailedCalculationStep(
                        "Step 2: Estimate Fault Current at Downstream Relay Location",
                        `Formula (Simplified 3-Phase Fault): $I_{\\text{fault,down}} \\approx \\frac{\\text{System Voltage (V)}}{\\sqrt{3} \\cdot (Z_{\\text{source}} + Z_{\\text{line}})}$`,
                        `$I_{\\text{fault,down}} \\approx \\frac{${systemVoltage * 1000}\\text{ V}}{\\sqrt{3} \\cdot (${totalImpedanceDownstreamFault.toFixed(3)})\\text{ Ohms}} = ${faultCurrentDownstream.toFixed(2)}\\text{ A}$`
                    );

                    const faultCurrentUpstream = (systemVoltage * 1000) / (Math.sqrt(3) * sourceImpedanceOhms);
                    addDetailedCalculationStep(
                        "Step 3: Estimate Fault Current at Upstream Relay Location",
                        `Formula (Simplified 3-Phase Fault): $I_{\\text{fault,up}} \\approx \\frac{\\text{System Voltage (V)}}{\\sqrt{3} \\cdot Z_{\\text{source}}}$`,
                        `$I_{\\text{fault,up}} \\approx \\frac{${systemVoltage * 1000}\\text{ V}}{\\sqrt{3} \\cdot ${sourceImpedanceOhms.toFixed(3)}\\text{ Ohms}} = ${faultCurrentUpstream.toFixed(2)}\\text{ A}$`
                    );
                    
                    // Function to calculate IDMT time based on curve type
                    const calculateIDMTTime = (faultCurrent, pickupCurrent, tms, curveType) => {
                        const psm = faultCurrent / pickupCurrent; 
                        if (psm <= 1) return Infinity; // Below pickup, relay doesn't operate
                        
                        const constants = IDMT_CONSTANTS[curveType];
                        if (curveType === 'Definite Time') {
                            return tms; // For definite time, TMS is directly the operating time
                        } else if (constants) {
                            return (constants.A * tms) / (Math.pow(psm, constants.B) - 1);
                        }
                        return Infinity; // Should not happen with valid curveType
                    };

                    const downstreamRelayOpTime = calculateIDMTTime(faultCurrentDownstream, ocPickupDown, ocTmsDown, ocCurveDown);
                    addDetailedCalculationStep(
                        "Step 4: Calculate Downstream Relay Operating Time ($t_{\\text{down}}$)",
                        `Formula for ${ocCurveDown} IDMT: $t = \\frac{A \\cdot \\text{TMS}}{(\\text{PSM})^B - 1}$ (Constants A, B vary by curve type)`,
                        `$t_{\\text{down}} = \\frac{${IDMT_CONSTANTS[ocCurveDown].A} \\cdot ${ocTmsDown}}{(${faultCurrentDownstream.toFixed(2)} / ${ocPickupDown.toFixed(2)})^${IDMT_CONSTANTS[ocCurveDown].B} - 1} = ${downstreamRelayOpTime.toFixed(3)}\\text{ s}$`
                    );
                    
                    const requiredUpstreamOpTime = downstreamRelayOpTime + cti;
                    addDetailedCalculationStep(
                        "Step 5: Determine Required Upstream Relay Operating Time ($t_{\\text{up,req}}$)",
                        `Formula: $t_{\\text{up,req}} = t_{\\text{down}} + \\text{CTI}$`,
                        `$t_{\\text{up,req}} = ${downstreamRelayOpTime.toFixed(3)}\\text{ s} + ${cti.toFixed(2)}\\text{ s} = ${requiredUpstreamOpTime.toFixed(3)}\\text{ s}$`
                    );

                    const psmUpstreamAtDownstreamFault = faultCurrentDownstream / ocPickupUp; 
                    let adjustedOcTmsUp = ocTmsUp; 
                    if (psmUpstreamAtDownstreamFault > 1) {
                         const constantsUp = IDMT_CONSTANTS[ocCurveUp];
                         if (ocCurveUp === 'Definite Time') {
                             adjustedOcTmsUp = requiredUpstreamOpTime; // For definite time, set TMS to required time
                         } else if (constantsUp) {
                             adjustedOcTmsUp = (requiredUpstreamOpTime * (Math.pow(psmUpstreamAtDownstreamFault, constantsUp.B) - 1)) / constantsUp.A;
                         }
                    } else {
                         displayMessage("Upstream relay pick-up is too high for coordination at downstream fault current. Cannot calculate TMS.", "warning", true);
                         // Set a default or indicate inability to coordinate
                         adjustedOcTmsUp = 1.0; 
                    }
                    
                    // Cap TMS between 0.05 and 1.0 as per typical relay limits
                    adjustedOcTmsUp = Math.max(0.05, Math.min(1.0, adjustedOcTmsUp));

                    addDetailedCalculationStep(
                        "Step 6: Calculate Adjusted Upstream Relay TMS ($TMS_{\\text{up,adj}}$)",
                        `Formula: $TMS_{\\text{up,adj}} = \\frac{t_{\\text{up,req}} \\cdot ((\\text{PSM}_{\\text{up}})^B - 1)}{A}$ (Rearranged IDMT formula)`,
                        `$TMS_{\\text{up,adj}} = \\frac{${requiredUpstreamOpTime.toFixed(3)} \\text{ s} \\cdot ((${psmUpstreamAtDownstreamFault.toFixed(2)})^${IDMT_CONSTANTS[ocCurveUp].B} - 1)}{${IDMT_CONSTANTS[ocCurveUp].A}} = ${adjustedOcTmsUp.toFixed(3)}$`
                    );

                    const upstreamRelayOpTimeAtUpstreamFault = calculateIDMTTime(faultCurrentUpstream, ocPickupUp, adjustedOcTmsUp, ocCurveUp);
                    addDetailedCalculationStep(
                        "Step 7: Verify Upstream Relay Operating Time at Upstream Fault",
                        `$t_{\\text{up,at up fault}} = \\frac{A \\cdot TMS_{\\text{up,adj}}}{(\\text{PSM}_{\\text{up, at up fault}})^B - 1}$`,
                        `$t_{\\text{up,at up fault}} = \\frac{${IDMT_CONSTANTS[ocCurveUp].A} \\cdot ${adjustedOcTmsUp.toFixed(3)}}{(${faultCurrentUpstream.toFixed(2)} / ${ocPickupUp.toFixed(2)})^${IDMT_CONSTANTS[ocCurveUp].B} - 1} = ${upstreamRelayOpTimeAtUpstreamFault.toFixed(3)}\\text{ s}$`
                    );

                    // Store calculated values for redraw on resize
                    lastFaultCurrentDownstream = faultCurrentDownstream;
                    lastDownstreamRelayOpTime = downstreamRelayOpTime;
                    lastOcPickupDown = ocPickupDown;
                    lastOcTmsDown = ocTmsDown;
                    lastOcCTRDown = ocCTRDown;
                    lastOcPickupUp = ocPickupUp;
                    lastAdjustedOcTmsUp = adjustedOcTmsUp;
                    lastOcCTRUP = ocCTRUP;


                    // Display Summary Results
                    addResultRow("System Voltage", systemVoltage.toFixed(1) + " kV");
                    addResultRow("Source MVA", sourceMVA.toFixed(0) + " MVA");
                    addResultRow("Line Impedance", lineImpedance.toFixed(3) + " Ohms");
                    addResultRow("Normal Load Current", normalLoadCurrent.toFixed(1) + " A");
                    addResultRow("Coordination Time Interval (CTI)", cti.toFixed(2) + " s");
                    addResultRow("---", "---");
                    addResultRow("Estimated Fault Current (Downstream)", faultCurrentDownstream.toFixed(2) + " A");
                    addResultRow("Estimated Fault Current (Upstream)", faultCurrentUpstream.toFixed(2) + " A");
                    addResultRow("---", "---");
                    addResultRow("Downstream Relay (Feeder)", "");
                    addResultRow("  CT Ratio", ocCTRatioDownStr);
                    addResultRow("  Characteristic", ocCurveDown);
                    addResultRow("  Pick-up Current", ocPickupDown.toFixed(1) + " A Primary");
                    addResultRow("  Time Multiplier Setting (TMS)", ocTmsDown.toFixed(2));
                    addResultRow("  Operating Time @ Downstream Fault", downstreamRelayOpTime.toFixed(3) + " s");
                    addResultRow("---", "---");
                    addResultRow("Upstream Relay (Main)", "");
                    addResultRow("  CT Ratio", ocCTRatioUpStr);
                    addResultRow("  Characteristic", ocCurveUp);
                    addResultRow("  Pick-up Current", ocPickupUp.toFixed(1) + " A Primary");
                    addResultRow("  **Calculated TMS (Adjusted)**", adjustedOcTmsUp.toFixed(3) + " (for coordination)");
                    addResultRow("  Required Op. Time @ Downstream Fault", requiredUpstreamOpTime.toFixed(3) + " s");
                    addResultRow("  Actual Op. Time @ Upstream Fault", upstreamRelayOpTimeAtUpstreamFault.toFixed(3) + " s");
                    
                    let coordinationStatus = "Coordinated";
                    if (adjustedOcTmsUp === 1.0 && requiredUpstreamOpTime > calculateIDMTTime(faultCurrentDownstream, ocPickupUp, 1.0, ocCurveUp)) {
                         coordinationStatus = "Potential Miscoordination (Upstream TMS capped at 1.0)";
                         displayMessage("Warning: Upstream TMS was capped at 1.0, coordination might be compromised. Consider adjusting pick-up or CTI.", "warning", true);
                    } else if (downstreamRelayOpTime >= requiredUpstreamOpTime - 0.01) { // Small tolerance for coordination
                        coordinationStatus = "Potential Miscoordination (Insufficient CTI)";
                        displayMessage("Warning: Coordination Time Interval (CTI) is too small or relay settings are not properly coordinated. Adjust CTI or relay settings.", "warning", true);
                    }

                    addResultRow("---", "---");
                    addResultRow("<strong>Coordination Status</strong>", `<strong>${coordinationStatus}</strong>`);

                    resultContainer.style.display = 'block';
                    tccPlotSection.style.display = 'block'; // Show plot section for overcurrent
                    resultContainer.scrollIntoView({ behavior: 'smooth' }); 

                    // Draw TCC Plot
                    drawTCCPlot(lastFaultCurrentDownstream, lastDownstreamRelayOpTime, lastOcPickupDown, lastOcTmsDown, lastOcCTRDown, lastOcPickupUp, lastAdjustedOcTmsUp, lastOcCTRUP, ocCurveDown, ocCurveUp);

                } else if (activeTab === 'differential') {
                    // Get Differential Relay Inputs
                    const diff1CTRatioStr = document.getElementById('diff1-ct-ratio').value;
                    const diff1PrimaryCurrent = parseFloat(document.getElementById('diff1-primary-current').value);
                    const diff2CTRatioStr = document.getElementById('diff2-ct-ratio').value;
                    const diff2PrimaryCurrent = parseFloat(document.getElementById('diff2-primary-current').value);
                    const diffPickup = parseFloat(document.getElementById('diff-pickup').value);
                    const diffBiasSlope1 = parseFloat(document.getElementById('diff-bias-slope1').value) / 100; // Convert to decimal
                    const diffBiasSlope2 = parseFloat(document.getElementById('diff-bias-slope2').value) / 100; // Convert to decimal
                    const diffSlopeChangePoint = parseFloat(document.getElementById('diff-slope-change-point').value);
                    const diffIpPickup = parseFloat(document.getElementById('diff-ip-pickup').value);

                    // Input Validation for Differential
                    if (isNaN(diff1PrimaryCurrent) || diff1PrimaryCurrent <= 0 || isNaN(diff2PrimaryCurrent) || diff2PrimaryCurrent <= 0 ||
                        isNaN(diffPickup) || diffPickup <= 0 || isNaN(diffBiasSlope1) || diffBiasSlope1 <= 0 || isNaN(diffBiasSlope2) || diffBiasSlope2 <= 0 ||
                        isNaN(diffSlopeChangePoint) || diffSlopeChangePoint <= 0 || isNaN(diffIpPickup) || diffIpPickup <= 0 ||
                        !diff1CTRatioStr || !diff2CTRatioStr) {
                        displayMessage("Please fill in all required fields for Differential relay with valid positive numbers.", "error", true);
                        resultContainer.style.display = 'none';
                        coordinateRelaysBtn.classList.remove('loading');
                        coordinateRelaysBtn.disabled = false;
                        return;
                    }

                    const parseCTRatio = (ctRatioStr) => {
                        const parts = ctRatioStr.split('/').map(Number);
                        if (parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1]) && parts[1] !== 0) {
                            return parts[0] / parts[1];
                        }
                        displayMessage(`Invalid CT Ratio format: ${ctRatioStr}. Use P/S (e.g., 500/5).`, "error", true);
                        return NaN;
                    };

                    const diff1CTR = parseCTRatio(diff1CTRatioStr);
                    const diff2CTR = parseCTRatio(diff2CTRatioStr);

                    if (isNaN(diff1CTR) || isNaN(diff2CTR)) {
                        resultContainer.style.display = 'none';
                        coordinateRelaysBtn.classList.remove('loading');
                        coordinateRelaysBtn.disabled = false;
                        return;
                    }

                    // Calculate Secondary Currents
                    const diff1SecondaryCurrent = diff1PrimaryCurrent / diff1CTR;
                    const diff2SecondaryCurrent = diff2PrimaryCurrent / diff2CTR;

                    addDetailedCalculationStep(
                        "Step 1: Calculate Secondary Currents",
                        `Formula: $I_{\\text{sec}} = \\frac{I_{\\text{prim}}}{CT_{\\text{ratio}}}$`,
                        `$I_{\\text{sec,1}} = \\frac{${diff1PrimaryCurrent}\\text{ A}}{${diff1CTR.toFixed(2)}} = ${diff1SecondaryCurrent.toFixed(3)}\\text{ A}$<br>` +
                        `$I_{\\text{sec,2}} = \\frac{${diff2PrimaryCurrent}\\text{ A}}{${diff2CTR.toFixed(2)}} = ${diff2SecondaryCurrent.toFixed(3)}\\text{ A}$`
                    );

                    // Calculate Differential Current
                    const differentialCurrent = Math.abs(diff1SecondaryCurrent - diff2SecondaryCurrent);
                    addDetailedCalculationStep(
                        "Step 2: Calculate Differential Current ($I_{\\text{diff}}$)",
                        `Formula: $I_{\\text{diff}} = |I_{\\text{sec,1}} - I_{\\text{sec,2}}|$`,
                        `$I_{\\text{diff}} = |${diff1SecondaryCurrent.toFixed(3)} - ${diff2SecondaryCurrent.toFixed(3)}| = ${differentialCurrent.toFixed(3)}\\text{ A}$`
                    );

                    // Calculate Restraint Current (using average restraint for simplicity)
                    const restraintCurrent = (diff1SecondaryCurrent + diff2SecondaryCurrent) / 2;
                    addDetailedCalculationStep(
                        "Step 3: Calculate Restraint Current ($I_{\\text{res}}$)",
                        `Formula (Average Restraint): $I_{\\text{res}} = \\frac{|I_{\\text{sec,1}}| + |I_{\\text{sec,2}}|}{2}$`,
                        `$I_{\\text{res}} = \\frac{${diff1SecondaryCurrent.toFixed(3)} + ${diff2SecondaryCurrent.toFixed(3)}}{2} = ${restraintCurrent.toFixed(3)}\\text{ A}$`
                    );

                    // Determine Operating Status
                    let operatingStatus = "No Trip (Stable)";
                    let requiredDifferentialCurrent = 0;

                    if (restraintCurrent < diffSlopeChangePoint) {
                        requiredDifferentialCurrent = diffPickup + (diffBiasSlope1 * restraintCurrent);
                        addDetailedCalculationStep(
                            "Step 4: Determine Required Differential Current (Slope 1)",
                            `Formula: $I_{\\text{diff,req}} = I_{\\text{pickup}} + (\\text{Slope}_1 \\cdot I_{\\text{res}})$`,
                            `$I_{\\text{diff,req}} = ${diffPickup.toFixed(3)} + (${diffBiasSlope1.toFixed(2)} \\cdot ${restraintCurrent.toFixed(3)}) = ${requiredDifferentialCurrent.toFixed(3)}\\text{ A}$`
                        );
                    } else {
                        requiredDifferentialCurrent = diffPickup + (diffBiasSlope1 * diffSlopeChangePoint) + (diffBiasSlope2 * (restraintCurrent - diffSlopeChangePoint));
                        addDetailedCalculationStep(
                            "Step 4: Determine Required Differential Current (Slope 2)",
                            `Formula: $I_{\\text{diff,req}} = I_{\\text{pickup}} + (\\text{Slope}_1 \\cdot I_{\\text{change}}) + (\\text{Slope}_2 \\cdot (I_{\\text{res}} - I_{\\text{change}}))$`,
                            `$I_{\\text{diff,req}} = ${diffPickup.toFixed(3)} + (${diffBiasSlope1.toFixed(2)} \\cdot ${diffSlopeChangePoint.toFixed(1)}) + (${diffBiasSlope2.toFixed(2)} \\cdot (${restraintCurrent.toFixed(3)} - ${diffSlopeChangePoint.toFixed(1)})) = ${requiredDifferentialCurrent.toFixed(3)}\\text{ A}$`
                        );
                    }

                    if (differentialCurrent >= diffIpPickup) {
                        operatingStatus = "Trip (Instantaneous)";
                        displayMessage("Differential relay tripped instantaneously due to high differential current!", "error", true);
                    } else if (differentialCurrent >= requiredDifferentialCurrent) {
                        operatingStatus = "Trip (Biased Differential)";
                        displayMessage("Differential relay tripped based on biased characteristic!", "error", true);
                    } else {
                        operatingStatus = "No Trip (Stable)";
                        displayMessage("Differential relay is stable. No trip detected.", "info");
                    }
                    addDetailedCalculationStep(
                        "Step 5: Determine Operating Status",
                        `Comparison: $I_{\\text{diff}}$ vs. $I_{\\text{diff,req}}$ and $I_{\\text{IP pick-up}}$`,
                        `Differential Current: ${differentialCurrent.toFixed(3)} A<br>` +
                        `Required Differential Current: ${requiredDifferentialCurrent.toFixed(3)} A<br>` +
                        `Instantaneous Pick-up: ${diffIpPickup.toFixed(3)} A<br>` +
                        `Status: ${operatingStatus}`
                    );


                    // Display Summary Results
                    addResultRow("Relay Type", "Differential (87)");
                    addResultRow("---", "---");
                    addResultRow("CT 1 Ratio", diff1CTRatioStr);
                    addResultRow("CT 1 Primary Current", diff1PrimaryCurrent.toFixed(2) + " A");
                    addResultRow("CT 1 Secondary Current", diff1SecondaryCurrent.toFixed(3) + " A");
                    addResultRow("---", "---");
                    addResultRow("CT 2 Ratio", diff2CTRatioStr);
                    addResultRow("CT 2 Primary Current", diff2PrimaryCurrent.toFixed(2) + " A");
                    addResultRow("CT 2 Secondary Current", diff2SecondaryCurrent.toFixed(3) + " A");
                    addResultRow("---", "---");
                    addResultRow("Calculated Differential Current", differentialCurrent.toFixed(3) + " A");
                    addResultRow("Calculated Restraint Current", restraintCurrent.toFixed(3) + " A");
                    addResultRow("Required Differential Current (for trip)", requiredDifferentialCurrent.toFixed(3) + " A");
                    addResultRow("Instantaneous Pick-up", diffIpPickup.toFixed(3) + " A");
                    addResultRow("---", "---");
                    addResultRow("<strong>Operating Status</strong>", `<strong>${operatingStatus}</strong>`);

                    resultContainer.style.display = 'block';
                    resultContainer.scrollIntoView({ behavior: 'smooth' }); 
                    
                } else if (activeTab === 'distance') {
                    // Get Distance Relay Inputs
                    const distSystemVoltage = parseFloat(document.getElementById('dist-system-voltage').value);
                    const distVtRatioStr = document.getElementById('dist-vt-ratio').value;
                    const distCtRatioStr = document.getElementById('dist-ct-ratio').value;
                    const distLineImpedance = parseFloat(document.getElementById('dist-line-impedance').value);
                    const distZone1Percent = parseFloat(document.getElementById('dist-zone1-percent').value) / 100;
                    const distZone2Percent = parseFloat(document.getElementById('dist-zone2-percent').value) / 100;
                    const distZone2Time = parseFloat(document.getElementById('dist-zone2-time').value);
                    const distZone3Percent = parseFloat(document.getElementById('dist-zone3-percent').value) / 100;
                    const distZone3Time = parseFloat(document.getElementById('dist-zone3-time').value);
                    const distFaultImpedanceSim = parseFloat(document.getElementById('dist-fault-impedance-sim').value);

                    // Input Validation for Distance
                    if (isNaN(distSystemVoltage) || distSystemVoltage <= 0 || isNaN(distLineImpedance) || distLineImpedance <= 0 ||
                        isNaN(distZone1Percent) || distZone1Percent <= 0 || distZone1Percent > 1 ||
                        isNaN(distZone2Percent) || distZone2Percent <= 0 || isNaN(distZone2Time) || distZone2Time <= 0 ||
                        isNaN(distZone3Percent) || distZone3Percent <= 0 || isNaN(distZone3Time) || distZone3Time <= 0 ||
                        isNaN(distFaultImpedanceSim) || distFaultImpedanceSim <= 0 ||
                        !distVtRatioStr || !distCtRatioStr) {
                        displayMessage("Please fill in all required fields for Distance relay with valid positive numbers. Zone percentages should be between 1% and 300%.", "error", true);
                        resultContainer.style.display = 'none';
                        coordinateRelaysBtn.classList.remove('loading');
                        coordinateRelaysBtn.disabled = false;
                        return;
                    }

                    const parseRatio = (ratioStr) => {
                        const parts = ratioStr.split('/').map(Number);
                        if (parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1]) && parts[1] !== 0) {
                            return parts[0] / parts[1];
                        }
                        displayMessage(`Invalid Ratio format: ${ratioStr}. Use P/S (e.g., 132000/110).`, "error", true);
                        return NaN;
                    };

                    const distVTRatio = parseRatio(distVtRatioStr);
                    const distCTR = parseRatio(distCtRatioStr);

                    if (isNaN(distVTRatio) || isNaN(distCTR)) {
                        resultContainer.style.display = 'none';
                        coordinateRelaysBtn.classList.remove('loading');
                        coordinateRelaysBtn.disabled = false;
                        return;
                    }

                    // Calculate Secondary Line Impedance
                    const secondaryLineImpedance = distLineImpedance * (distCTR / distVTRatio);
                    addDetailedCalculationStep(
                        "Step 1: Calculate Secondary Line Impedance",
                        `Formula: $Z_{\\text{line,sec}} = Z_{\\text{line,prim}} \\cdot \\frac{CT_{\\text{ratio}}}{VT_{\\text{ratio}}}$`,
                        `$Z_{\\text{line,sec}} = ${distLineImpedance.toFixed(2)}\\text{ Ohms} \\cdot \\frac{${distCTR.toFixed(2)}}{${distVTRatio.toFixed(2)}} = ${secondaryLineImpedance.toFixed(3)}\\text{ Ohms}$`
                    );

                    // Calculate Zone Reaches (Primary Ohms)
                    const zone1Reach = distLineImpedance * distZone1Percent;
                    const zone2Reach = distLineImpedance * distZone2Percent;
                    const zone3Reach = distLineImpedance * distZone3Percent;

                    addDetailedCalculationStep(
                        "Step 2: Calculate Zone Reaches (Primary Ohms)",
                        `Formula: $Z_{\\text{zone}} = \\text{Line Impedance} \\cdot \\text{Zone Percentage}$`,
                        `Zone 1 Reach = ${distLineImpedance.toFixed(2)}\\text{ Ohms} \\cdot ${distZone1Percent * 100}\\% = ${zone1Reach.toFixed(3)}\\text{ Ohms}<br>` +
                        `Zone 2 Reach = ${distLineImpedance.toFixed(2)}\\text{ Ohms} \\cdot ${distZone2Percent * 100}\\% = ${zone2Reach.toFixed(3)}\\text{ Ohms}<br>` +
                        `Zone 3 Reach = ${distLineImpedance.toFixed(2)}\\text{ Ohms} \\cdot ${distZone3Percent * 100}\\% = ${zone3Reach.toFixed(3)}\\text{ Ohms}`
                    );

                    // Determine Operating Zone and Time for Simulated Fault
                    let operatingZone = "No Trip (Fault beyond Zone 3)";
                    let operatingTime = "N/A";

                    if (distFaultImpedanceSim <= zone1Reach) {
                        operatingZone = "Zone 1";
                        operatingTime = "Instantaneous (0.00 s)";
                        displayMessage("Distance relay tripped instantaneously in Zone 1!", "error", true);
                    } else if (distFaultImpedanceSim <= zone2Reach) {
                        operatingZone = "Zone 2";
                        operatingTime = distZone2Time.toFixed(2) + " s";
                        displayMessage(`Distance relay tripped in Zone 2 with a delay of ${distZone2Time.toFixed(2)} s.`, "warning", true);
                    } else if (distFaultImpedanceSim <= zone3Reach) {
                        operatingZone = "Zone 3";
                        operatingTime = distZone3Time.toFixed(2) + " s";
                        displayMessage(`Distance relay tripped in Zone 3 with a delay of ${distZone3Time.toFixed(2)} s.`, "warning", true);
                    } else {
                        displayMessage("Simulated fault is beyond Zone 3. No trip from this relay.", "info");
                    }

                    addDetailedCalculationStep(
                        "Step 3: Determine Operating Zone and Time for Simulated Fault",
                        `Comparison of Simulated Fault Impedance ($Z_{\\text{fault}}$) with Zone Reaches:`,
                        `If $Z_{\\text{fault}} \\le Z_{\\text{zone1}}$: Trip Instantaneous<br>` +
                        `If $Z_{\\text{zone1}} < Z_{\\text{fault}} \\le Z_{\\text{zone2}}$: Trip after $t_{\\text{zone2}}$<br>` +
                        `If $Z_{\\text{zone2}} < Z_{\\text{fault}} \\le Z_{\\text{zone3}}$: Trip after $t_{\\text{zone3}}$<br>` +
                        `Simulated Fault Impedance: ${distFaultImpedanceSim.toFixed(3)}\\text{ Ohms}<br>` +
                        `Operating Zone: ${operatingZone}<br>` +
                        `Operating Time: ${operatingTime}`
                    );

                    // Display Summary Results
                    addResultRow("Relay Type", "Distance (21)");
                    addResultRow("---", "---");
                    addResultRow("System Voltage", distSystemVoltage.toFixed(1) + " kV");
                    addResultRow("VT Ratio", distVtRatioStr);
                    addResultRow("CT Ratio", distCtRatioStr);
                    addResultRow("Protected Line Impedance", distLineImpedance.toFixed(3) + " Ohms Primary");
                    addResultRow("---", "---");
                    addResultRow("Zone 1 Reach", zone1Reach.toFixed(3) + " Ohms Primary (" + (distZone1Percent * 100).toFixed(0) + "%)");
                    addResultRow("Zone 2 Reach", zone2Reach.toFixed(3) + " Ohms Primary (" + (distZone2Percent * 100).toFixed(0) + "%)");
                    addResultRow("Zone 2 Time Delay", distZone2Time.toFixed(2) + " s");
                    addResultRow("Zone 3 Reach", zone3Reach.toFixed(3) + " Ohms Primary (" + (distZone3Percent * 100).toFixed(0) + "%)");
                    addResultRow("Zone 3 Time Delay", distZone3Time.toFixed(2) + " s");
                    addResultRow("---", "---");
                    addResultRow("Simulated Fault Impedance", distFaultImpedanceSim.toFixed(3) + " Ohms Primary");
                    addResultRow("<strong>Operating Zone</strong>", `<strong>${operatingZone}</strong>`);
                    addResultRow("<strong>Operating Time</strong>", `<strong>${operatingTime}</strong>`);

                    resultContainer.style.display = 'block';
                    resultContainer.scrollIntoView({ behavior: 'smooth' }); 
                }

                // IMPORTANT: Tell MathJax to re-render the new content after a small delay
                if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
                    // Set a small timeout to ensure the DOM is updated before MathJax processes
                    setTimeout(() => {
                        window.MathJax.typesetPromise([detailedCalculationsDiv])
                            .catch((err) => console.error('MathJax typesetting failed:', err));
                    }, 50); 
                }
                
                // Re-enable button and hide spinner immediately after calculations are done.
                coordinateRelaysBtn.classList.remove('loading');
                coordinateRelaysBtn.disabled = false;
            });

            // Function to display messages (replaces alert())
            function displayMessage(message, type = "info", animate = false) {
                let messageBox = document.getElementById('custom-message-box');
                if (!messageBox) {
                    messageBox = document.createElement('div');
                    messageBox.id = 'custom-message-box';
                    document.body.appendChild(messageBox);
                }

                messageBox.textContent = message;
                // Remove previous type classes
                messageBox.classList.remove('error', 'warning', 'info', 'message-box-shake');
                messageBox.classList.add(type);
                if (animate) {
                    messageBox.classList.add('message-box-shake');
                }
                messageBox.style.opacity = 1;

                // Hide after 5 seconds
                setTimeout(() => {
                    messageBox.style.opacity = 0;
                    messageBox.classList.remove('message-box-shake'); // Remove shake after animation
                }, 5000);
            }

            // Helper function to add a row to the summary result table
            function addResultRow(parameter, value) {
                const row = document.createElement('tr');
                
                const paramCell = document.createElement('td');
                paramCell.innerHTML = parameter; // Use innerHTML for bolding
                paramCell.classList.add('font-medium');
                
                const valueCell = document.createElement('td');
                valueCell.innerHTML = value; // Use innerHTML for bolding
                
                row.appendChild(paramCell);
                row.appendChild(valueCell);
                
                resultTableBody.appendChild(row);
            }

            // Helper function to add a detailed calculation step
            function addDetailedCalculationStep(stepTitle, formulaText, calculationText) {
                const stepDiv = document.createElement('div');
                stepDiv.classList.add('calculation-step');
                stepDiv.innerHTML = `
                    <h4>${stepTitle}</h4>
                    <p class="mb-1">${formulaText}</p>
                    <p class="formula math-content">${calculationText}</p>
                `;
                detailedCalculationsDiv.appendChild(stepDiv);
            }

            // Function to draw the TCC Plot (Simplified)
            function drawTCCPlot(faultCurrentDownstream, downstreamRelayOpTime, ocPickupDown, ocTmsDown, ocCTRDown, ocPickupUp, ocTmsUp, ocCTRUP, ocCurveDown, ocCurveUp) {
                const width = relayPlotCanvas.width = relayPlotCanvas.offsetWidth;
                const height = relayPlotCanvas.height = relayPlotCanvas.offsetHeight;
                
                ctx.clearRect(0, 0, width, height); // Clear previous drawings
                ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--canvas-bg');
                ctx.fillRect(0, 0, width, height); // Fill with canvas background color

                ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--text-color');
                ctx.lineWidth = 1;

                // Define plot ranges for log-log scale
                const minCurrent = 10; // Start current from 10A for better visual, adjust as needed
                const maxCurrent = 10000; // Max current for plot (A)
                const minTime = 0.01; // Min time for plot (s)
                const maxTime = 100; // Max time for plot (s)

                // Logarithmic scaling functions
                const getX = (current) => {
                    if (current <= 0) return 0; // Handle zero/negative current gracefully
                    return width * (Math.log10(current) - Math.log10(minCurrent)) / (Math.log10(maxCurrent) - Math.log10(minCurrent));
                };

                // Logarithmic scaling for time (y-axis) - Y-axis is inverted in canvas
                const getY = (time) => {
                    if (time <= 0) return height; // Handle zero/negative time gracefully
                    return height - (height * (Math.log10(time) - Math.log10(minTime)) / (Math.log10(maxTime) - Math.log10(minTime)));
                };

                // Draw Grid Lines and Labels
                ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--text-color');
                ctx.font = '10px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';

                // X-axis (Current) grid and labels
                for (let i = 0; i <= 4; i++) { // For decades (10, 100, 1000, 10000)
                    const currentDecade = Math.pow(10, 1 + i); // 10, 100, 1000, 10000
                    for (let j = 1; j <= 9; j++) { // For intermediate values within the decade
                        const current = currentDecade * j;
                        if (current >= minCurrent && current <= maxCurrent) {
                            const x = getX(current);
                            ctx.beginPath();
                            ctx.strokeStyle = '#e0e0e0'; // Lighter grid lines
                            if (j === 1) ctx.strokeStyle = '#cccccc'; // Darker for decade lines
                            ctx.moveTo(x, 0);
                            ctx.lineTo(x, height);
                            ctx.stroke();
                        }
                    }
                    if (currentDecade >= minCurrent && currentDecade <= maxCurrent) {
                        ctx.fillText(currentDecade + 'A', getX(currentDecade), height - 5);
                    }
                }
                ctx.fillText('Current (A) [Log Scale]', width / 2, height - 20);

                // Y-axis (Time) grid and labels
                for (let i = 0; i <= 3; i++) { // For decades (0.01, 0.1, 1, 10, 100)
                    const timeDecade = Math.pow(10, -2 + i); // 0.01, 0.1, 1, 10, 100
                    for (let j = 1; j <= 9; j++) { // For intermediate values within the decade
                        const time = timeDecade * j;
                        if (time >= minTime && time <= maxTime) {
                            const y = getY(time);
                            ctx.beginPath();
                            ctx.strokeStyle = '#e0e0e0'; // Lighter grid lines
                            if (j === 1) ctx.strokeStyle = '#cccccc'; // Darker for decade lines
                            ctx.moveTo(0, y);
                            ctx.lineTo(width, y);
                            ctx.stroke();
                        }
                    }
                    if (timeDecade >= minTime && timeDecade <= maxTime) {
                        ctx.fillText(timeDecade + 's', getX(minCurrent) - 15, getY(timeDecade));
                    }
                }
                ctx.save();
                ctx.translate(15, height / 2);
                ctx.rotate(-Math.PI / 2);
                ctx.fillText('Time (s) [Log Scale]', 0, 0);
                ctx.restore();


                // Function to draw an IDMT curve
                const drawIDMTCurve = (pickupCurrent, tms, ctr, color, label, curveType) => {
                    ctx.beginPath();
                    ctx.strokeStyle = color;
                    ctx.lineWidth = 2;

                    let firstPoint = true;
                    // Iterate through currents from slightly above pickup to maxCurrent
                    for (let current = pickupCurrent * 1.05; current <= maxCurrent; current += (maxCurrent - pickupCurrent * 1.05) / 500) { // More steps for smoother curve
                        let time;
                        if (curveType === 'Definite Time') {
                            time = tms;
                        } else {
                            const constants = IDMT_CONSTANTS[curveType];
                            if (!constants) continue; // Skip if curve type not found
                            const psm = current / pickupCurrent;
                            if (psm <= 1) { time = Infinity; } // Relay does not operate below pickup
                            else { time = (constants.A * tms) / (Math.pow(psm, constants.B) - 1); }
                        }
                        
                        if (time > 0 && time < maxTime * 1.5 && current >= minCurrent) { // Plot slightly beyond maxTime for smooth curve end
                            if (firstPoint) {
                                ctx.moveTo(getX(current), getY(time));
                                firstPoint = false;
                            } else {
                                ctx.lineTo(getX(current), getY(time));
                            }
                        }
                    }
                    ctx.stroke();

                    // Add label at the end of the curve (simplified positioning)
                    if (!firstPoint) {
                        ctx.fillStyle = color;
                        ctx.font = '12px Arial';
                        // Get point near the end of the curve for label
                        let labelCurrent = maxCurrent * 0.8;
                        let labelTime;
                        if (curveType === 'Definite Time') {
                            labelTime = tms;
                        } else {
                            const constants = IDMT_CONSTANTS[curveType];
                            const psm = labelCurrent / pickupCurrent;
                            labelTime = (constants.A * tms) / (Math.pow(psm, constants.B) - 1);
                        }

                        if (labelTime > minTime * 1.5 && labelTime < maxTime * 0.8) { 
                           ctx.fillText(label, getX(labelCurrent), getY(labelTime) - 10);
                        } else { // Try another point if the first is out of bounds
                            labelCurrent = maxCurrent * 0.5;
                            if (curveType === 'Definite Time') {
                                labelTime = tms;
                            } else {
                                const constants = IDMT_CONSTANTS[curveType];
                                const psm = labelCurrent / pickupCurrent;
                                labelTime = (constants.A * tms) / (Math.pow(psm, constants.B) - 1);
                            }
                            if (labelTime > minTime * 1.5 && labelTime < maxTime * 0.8) {
                                ctx.fillText(label, getX(labelCurrent), getY(labelTime) - 10);
                            }
                        }
                    }
                };
                
                // Draw Downstream Relay Curve
                drawIDMTCurve(ocPickupDown, ocTmsDown, ocCTRDown, 'red', 'Downstream Relay', ocCurveDown);

                // Draw Upstream Relay Curve
                drawIDMTCurve(ocPickupUp, ocTmsUp, ocCTRUP, 'blue', 'Upstream Relay (Adjusted)', ocCurveUp);

                // Mark the fault current point on the plot
                ctx.fillStyle = 'black';
                ctx.beginPath();
                ctx.arc(getX(faultCurrentDownstream), getY(downstreamRelayOpTime + 0.01), 5, 0, 2 * Math.PI); // Add small offset to see
                ctx.fill();
                ctx.fillText(`Fault @ ${faultCurrentDownstream.toFixed(0)}A`, getX(faultCurrentDownstream) + 30, getY(downstreamRelayOpTime + 0.01));
            }


            // Call MathJax initial render (for static content)
            if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
                window.MathJax.typesetPromise();
            }

            // Adjust canvas size on window resize
            window.addEventListener('resize', () => {
                // Redraw plot if results are visible AND the overcurrent tab is active
                const activeTab = document.querySelector('.tab-button.active').dataset.tab;
                if (resultContainer.style.display === 'block' && activeTab === 'overcurrent') {
                    drawTCCPlot(
                        lastFaultCurrentDownstream,
                        lastDownstreamRelayOpTime,
                        lastOcPickupDown,
                        lastOcTmsDown,
                        lastOcCTRDown,
                        lastOcPickupUp,
                        lastAdjustedOcTmsUp, 
                        lastOcCTRUP,
                        document.getElementById('oc-curve-down').value,
                        document.getElementById('oc-curve-up').value
                    );
                }
            });
        });
    </script>
</body>

</html>


