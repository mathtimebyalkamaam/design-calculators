<!DOCTYPE html>
<html lang="en">
<head>
    <!-- AdSense & Analytics -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5936527763614780" crossorigin="anonymous"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-23Y1V450SR"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-23Y1V450SR');
    </script>
    
    <!-- SEO Meta Tags -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Short Circuit & Fault Current Calculator - Industrial Grade</title>
    <meta name="description" content="Commercial-grade Short Circuit Calculator using Symmetrical Components (Per-Unit Method). Calculates 3-Phase, SLG, LL, DLG faults, Peak Latching Current, and X/R Ratios per IEC 60909/ANSI C37.">
    <meta name="keywords" content="short circuit calculator, fault current analysis, symmetrical components, IEC 60909, ANSI C37, per unit method, X/R ratio, peak latching current, arc flash source, electrical engineering tools">
    <meta name="author" content="Design Calculators">
    <meta name="robots" content="index, follow">

    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Montserrat:wght@700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- PDF & Charts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1/dist/chartjs-plugin-annotation.min.js"></script>

    <!-- MathJax -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['\\(', '\\)'], ['$', '$']],
                displayMath: [['\\[', '\\]'], ['$$', '$$']]
            },
            svg: { fontCache: 'global' }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <!-- Favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">

    <style>
        /* --- CORE THEME (Blue Industrial) --- */
        :root {
            --primary: #1E3A8A; /* Dark Blue */
            --secondary: #2563EB; /* Bright Blue */
            --accent: #F59E0B; /* Amber */
            --success: #10B981;
            --danger: #DC2626;
            --warning: #F59E0B;
            --bg: #F8FAFC;
            --card: #FFFFFF;
            --text: #4B5563;
            --heading: #111827;
            --footer-bg: #0F172A;
            --border: #E2E8F0;
            --grad: linear-gradient(135deg, var(--primary), var(--secondary));
        }

        body.dark-mode {
            --primary: #10B981;
            --secondary: #34D399;
            --bg: #0F172A;
            --card: #1E293B;
            --text: #CBD5E1;
            --heading: #F1F5F9;
            --footer-bg: #020617;
            --border: #334155;
            --accent: #F59E0B;
        }

        * { box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.7;
            margin: 0;
            padding: 0;
        }

        .container { max-width: 1280px; margin: 0 auto; padding: 0 24px; }

        /* Header */
        header {
            background: var(--grad);
            color: white;
            padding: 24px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .navbar { display: flex; justify-content: space-between; align-items: center; }
        .logo-container { text-decoration: none; color: white; display: flex; flex-direction: column; }
        .logo-text { font-size: 1.75rem; font-weight: 800; font-family: 'Montserrat', sans-serif; }
        .logo-subtitle { font-size: 0.8rem; margin: 4px 0 0 0; color: #E0E7FF; opacity: 0.9; }
        .nav-links { display: flex; gap: 24px; list-style: none; margin: 0; padding: 0; }
        .nav-links a { color: white; text-decoration: none; font-weight: 500; transition: color 0.3s; }
        .nav-links a:hover { color: var(--accent); }
        
        /* Theme Toggle */
        .theme-toggle { display: flex; align-items: center; gap: 12px; color: white; }
        .switch { position: relative; width: 56px; height: 30px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.2); transition: .4s; border-radius: 30px; }
        .slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(26px); }

        /* Main */
        main { padding: 40px 0; }
        .card {
            background: var(--card); border-radius: 12px; padding: 30px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05); margin-bottom: 30px; border: 1px solid var(--border);
            animation: fadeIn 0.6s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .card h2 {
            color: var(--primary); border-bottom: 3px solid var(--primary); padding-bottom: 15px;
            margin-top: 0; font-family: 'Montserrat', sans-serif; font-size: 1.8rem;
        }

        /* Forms */
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--heading); }
        .form-group input, .form-group select {
            width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 6px;
            background-color: var(--bg); color: var(--text); font-size: 1rem; transition: all 0.3s;
        }
        .form-group input:focus, .form-group select:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1); }
        
        .vector-input-group { background: var(--bg); padding: 15px; border-radius: 8px; border: 1px solid var(--border); position: relative; }
        .vector-input-header { font-weight: 700; margin-bottom: 10px; color: var(--primary); display: flex; align-items: center; gap: 8px; }

        /* Buttons */
        .btn {
            background: var(--grad); color: white; border: none; padding: 16px 30px;
            border-radius: 8px; cursor: pointer; font-size: 1.1rem; font-weight: 700;
            box-shadow: 0 4px 12px rgba(30, 58, 138, 0.3); transition: all 0.3s; width: 100%;
        }
        .btn:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(30, 58, 138, 0.4); }
        .btn-outline { background: transparent; border: 2px solid var(--secondary); color: var(--secondary); font-size: 0.9rem; padding: 8px 16px; }
        .btn-outline:hover { background: var(--secondary); color: white; }
        .button-wrapper { display: flex; justify-content: center; width: 100%; padding-top: 15px; gap: 15px; flex-wrap: wrap; }
        
        /* Presets */
        .preset-container { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
        .preset-btn { padding: 8px 12px; font-size: 0.85rem; border: 1px solid var(--border); background: var(--card); border-radius: 20px; cursor: pointer; transition: all 0.2s; color: var(--text); display: flex; align-items: center; gap: 5px; }
        .preset-btn:hover { background: var(--bg); border-color: var(--secondary); color: var(--secondary); }

        /* Results */
        .results-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; align-items: start; }
        @media (max-width: 1024px) { .results-grid { grid-template-columns: 1fr; } }
        .results-table { width: 100%; border-collapse: collapse; margin-top: 0; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-radius: 8px; overflow: hidden; }
        .results-table th, .results-table td { padding: 14px; text-align: left; border-bottom: 1px solid var(--border); }
        .results-table th { background: var(--grad); color: white; font-weight: 700; }
        .results-table td:first-child { font-weight: 600; color: var(--heading); }
        
        /* Steps */
        .calculation-step { font-family: 'Courier New', monospace; background-color: rgba(37, 99, 235, 0.05); padding: 15px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid var(--secondary); font-size: 0.95rem; line-height: 1.6; }
        .calculation-step h4 { color: var(--primary); margin-top: 0; margin-bottom: 10px; font-size: 1.1rem; border-bottom: 1px dashed var(--border); padding-bottom: 5px; }

        /* Visualization */
        .chart-container { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 15px; position: relative; height: 350px; width: 100%; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        canvas { max-width: 100%; max-height: 100%; }

        /* Educational Content */
        .insight-card { background: linear-gradient(135deg, var(--card), rgba(37,99,235,0.03)); border-radius: 12px; padding: 25px; margin: 20px 0; border-left: 5px solid var(--secondary); box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: all 0.3s; }
        .insight-card:hover { transform: translateX(5px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .insight-card h4 { color: var(--secondary); font-size: 1.3rem; margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px; font-family: 'Montserrat', sans-serif; }
        .insight-card p, .insight-card ul { margin: 10px 0; line-height: 1.8; color: var(--text); font-size: 1rem; }
        .insight-card ul { padding-left: 20px; }
        .insight-card li { margin-bottom: 8px; }

        /* Status Badges */
        .status-badge { padding: 4px 10px; border-radius: 4px; font-size: 0.75rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; display: inline-block; }
        .status-pass { background: #dcfce7; color: #166534; }
        .status-fail { background: #fee2e2; color: #991b1b; }
        .status-warn { background: #fef9c3; color: #854d0e; }

        /* Footer */
        footer { background: #0F172A; color: #CBD5E1; padding: 50px 0 20px 0; margin-top: 60px; }
        .footer-content { display: flex; justify-content: space-between; flex-wrap: wrap; gap: 40px; margin-bottom: 30px; }
        .footer-col { flex: 1; min-width: 200px; }
        .footer-col h4 { color: white; margin-bottom: 15px; font-weight: 700; }
        .footer-col ul { list-style: none; padding: 0; margin: 0; }
        .footer-col a { color: #CBD5E1; text-decoration: none; transition: color 0.3s; }
        .footer-col a:hover { color: var(--accent); }
        .social-buttons { display: flex; gap: 12px; margin-top: 15px; }
        .social-btn { width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; color: white; border-radius: 50%; font-size: 1.1rem; transition: transform 0.3s; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .social-btn:hover { transform: translateY(-4px); }
        .social-btn.linkedin { background-color: #0A66C2; }
        .social-btn.facebook { background-color: #1877F2; }
        .social-btn.twitter { background-color: #1DA1F2; }
        .social-btn.whatsapp { background-color: #25D366; }
        .footer-disclaimer { text-align: center; padding-top: 25px; border-top: 1px solid #334155; max-width: 800px; margin: 0 auto; font-size: 0.9rem; }
        .footer-bottom { text-align: center; padding-top: 20px; font-size: 0.9rem; color: #94A3B8; }
        .hidden { display: none; }
        
        .message-box { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); padding: 16px 28px; border-radius: 8px; box-shadow: 0 6px 16px rgba(0,0,0,0.25); z-index: 10000; font-weight: 600; color: white; opacity: 0; transition: all 0.4s; display: none; }
        .message-box.show { display: block; opacity: 1; top: 30px; }
    </style>
</head>
<body>
    <div id="message-box" class="message-box"></div>
    <header>
        <div class="container">
            <nav class="navbar">
                <a href="index.html" class="logo-container">
                    <span class="logo-text">Design Calculators</span>
                    <p class="logo-subtitle">Inspired by standards such as IEC, IEEE, ISA, ASME, and API.</p>
                </a>
                <ul class="nav-links">
                    <li><a href='index.html'>Home</a></li>
                    <li><a href="articles.html">Articles</a></li>
                    <li><a href="indexmech.html">Mechanical</a></li>
                    <li><a href="indexele.html">Electrical</a></li>
                    <li><a href="indexinst.html">Instrumentation</a></li>
                </ul>
                <div class="theme-toggle">
                    <i class="fas fa-sun"></i>
                    <label class="switch">
                        <input type="checkbox" id="theme-switch">
                        <span class="slider"></span>
                    </label>
                    <i class="fas fa-moon"></i>
                </div>
            </nav>
        </div>
    </header>

    <main class="container">
        <div class="card">
            <h2><i class="fas fa-bolt"></i> Advanced Short Circuit & Arc Flash Hazard Calculator</h2>
            
            <div class="tool-description">
                <p>This industrial-grade engineering tool solves <strong>Symmetrical & Asymmetrical Fault Currents</strong> according to <strong>IEC 60909</strong> and <strong>ANSI C37</strong> standards. It utilizes the **Per-Unit (PU) Method** with complex impedance arithmetic ($R+jX$) to accurately determine fault levels, X/R ratios, and Peak Latching currents for switchgear rating.</p>
            </div>

            <div class="calculator-form">
                <form id="sc-form">
                    <!-- Controls Row -->
                    <div class="form-row" style="align-items: end;">
                        <div class="form-group">
                            <label>Quick Load Scenarios:</label>
                            <div class="preset-container" style="margin-bottom: 0;">
                                <button type="button" class="preset-btn" onclick="loadPreset('lv_board')"><i class="fas fa-industry"></i> LV Main Switchboard</button>
                                <button type="button" class="preset-btn" onclick="loadPreset('mv_sub')"><i class="fas fa-charging-station"></i> MV Substation</button>
                                <button type="button" class="preset-btn" onclick="loadPreset('motor_control')"><i class="fas fa-cogs"></i> MCC (Motor Load)</button>
                            </div>
                        </div>
                    </div>

                    <!-- Fault Type & Base -->
                    <h4 style="color: var(--primary); margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 5px;">1. System Configuration</h4>
                    <div class="form-row">
                        <div class="vector-input-group">
                            <div class="vector-input-header"><i class="fas fa-cogs"></i> Fault Scenario</div>
                            <div class="form-group">
                                <label for="fault-type">Fault Type</label>
                                <select id="fault-type">
                                    <option value="3ph" selected>3-Phase Bolted Fault (Sym)</option>
                                    <option value="slg">Single Line-to-Ground (SLG)</option>
                                    <option value="ll">Line-to-Line (LL)</option>
                                    <option value="dlg">Double Line-to-Ground (DLG)</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-top:10px;">
                                <label for="sys-voltage">System Voltage ($V_{LL}$) [V]</label>
                                <input type="number" id="sys-voltage" value="415" step="1">
                            </div>
                        </div>
                        <div class="vector-input-group">
                            <div class="vector-input-header"><i class="fas fa-network-wired"></i> Upstream Source</div>
                            <div class="form-group">
                                <label for="util-mva">Utility SC Level [MVA] <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Short circuit capacity of the grid connection.</span></span></label>
                                <input type="number" id="util-mva" value="500" step="10">
                            </div>
                            <div class="form-group" style="margin-top:10px;">
                                <label for="util-xr">Utility X/R Ratio</label>
                                <input type="number" id="util-xr" value="15" step="0.1">
                            </div>
                        </div>
                    </div>

                    <!-- Transformer Data -->
                    <h4 style="color: var(--primary); margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 5px; margin-top: 20px;">2. Transformer Specification</h4>
                    <div class="form-row">
                        <div class="vector-input-group">
                            <div class="vector-input-header"><i class="fas fa-transformer"></i> Transformer</div>
                            <div class="form-group">
                                <label for="tx-kva">Rating [kVA] <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Base for PU calculations.</span></span></label>
                                <input type="number" id="tx-kva" value="1000" step="10">
                            </div>
                            <div class="form-group" style="margin-top:10px;">
                                <label for="tx-z">Impedance ($Z_{\%}$)</label>
                                <input type="number" id="tx-z" value="5.75" step="0.01">
                            </div>
                             <div class="form-group" style="margin-top:10px;">
                                <label for="tx-xr">X/R Ratio</label>
                                <input type="number" id="tx-xr" value="6" step="0.1">
                            </div>
                        </div>
                        
                        <div class="vector-input-group">
                             <div class="vector-input-header"><i class="fas fa-grounding"></i> Grounding</div>
                            <div class="form-group">
                                <label for="tx-sec">Secondary Connection</label>
                                <select id="tx-sec">
                                    <option value="yn" selected>Star Grounded (Yn)</option>
                                    <option value="y">Star Ungrounded (Y)</option>
                                    <option value="d">Delta (D)</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-top:10px;">
                                <label for="ngr">NGR Resistance [$\Omega$] <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Neutral Grounding Resistor. 0 for Solid Ground.</span></span></label>
                                <input type="number" id="ngr" value="0.001" step="0.001">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Cable & Motor Data -->
                    <h4 style="color: var(--primary); margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 5px; margin-top: 20px;">3. Feeder & Loads</h4>
                    <div class="form-row">
                         <div class="vector-input-group">
                            <div class="vector-input-header"><i class="fas fa-ruler-horizontal"></i> Feeder Cable</div>
                            <div class="form-group">
                                <label for="cable-len">Length [m]</label>
                                <input type="number" id="cable-len" value="20" step="1">
                            </div>
                             <div class="form-group" style="margin-top:10px;">
                                <label for="cable-size">Size [mm²]</label>
                                <select id="cable-size">
                                    <option value="35">35 mm²</option>
                                    <option value="70">70 mm²</option>
                                    <option value="120">120 mm²</option>
                                    <option value="185">185 mm²</option>
                                    <option value="240" selected>240 mm²</option>
                                    <option value="400">400 mm²</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-top:10px;">
                                <label for="cable-runs">Parallel Runs</label>
                                <input type="number" id="cable-runs" value="2" step="1" min="1">
                            </div>
                        </div>
                         <div class="vector-input-group">
                            <div class="vector-input-header"><i class="fas fa-fan"></i> Motor Feedback</div>
                            <div class="form-group">
                                <label for="motor-kw">Total Motor Load [kW] <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Motors generate back-EMF during faults, increasing current.</span></span></label>
                                <input type="number" id="motor-kw" value="100" step="10">
                            </div>
                            <div class="form-group" style="margin-top:10px;">
                                <label for="motor-xd">Subtransient $X''_d$ [pu]</label>
                                <input type="number" id="motor-xd" value="0.2" step="0.01">
                            </div>
                        </div>
                    </div>

                    <div class="button-wrapper">
                        <button type="button" id="calculate-btn" class="btn"><i class="fas fa-calculator"></i> Calculate Fault Levels</button>
                        <button type="button" id="pdf-btn" class="btn btn-outline"><i class="fas fa-file-pdf"></i> Download Report</button>
                    </div>
                </form>
            </div>

            <!-- Results Section -->
            <div id="result-container" class="card hidden" style="margin-top: 40px;">
                <h3><i class="fas fa-poll"></i> Fault Analysis</h3>
                
                <div class="results-grid">
                    <!-- Left Col: Table -->
                    <div>
                        <h4 style="margin-top: 0; color: var(--primary); margin-bottom: 15px;">Fault Current Summary</h4>
                        <table class="results-table">
                            <thead>
                                <tr>
                                    <th>Parameter</th>
                                    <th>Value</th>
                                    <th>Unit</th>
                                </tr>
                            </thead>
                            <tbody id="result-table-body">
                                <!-- Dynamic rows -->
                            </tbody>
                        </table>
                        
                        <div style="margin-top: 20px; background: var(--bg); padding: 15px; border-radius: 6px; border: 1px solid var(--border);">
                            <strong><i class="fas fa-info-circle"></i> Design Check:</strong>
                            <div id="interpretation-text" style="margin-top: 5px; font-size: 0.95rem;"></div>
                        </div>
                    </div>

                    <!-- Right Col: Visual Chart -->
                    <div>
                        <h4 style="margin-top: 0; color: var(--primary); margin-bottom: 15px;">Fault Waveform (Asymmetrical)</h4>
                        <div class="chart-container">
                            <canvas id="waveCanvas"></canvas>
                        </div>
                         <div style="text-align: center; margin-top: 10px; font-size: 0.85rem; color: var(--text);">
                            <span style="color: #EF4444;">● Fault Current ($i_{total}$)</span> &nbsp;
                            <span style="color: #3B82F6;">-- DC Component</span>
                        </div>
                        
                         <div style="margin-top: 20px;">
                            <h4 style="margin-top: 0; color: var(--primary); margin-bottom: 15px;">Sequence Network</h4>
                             <div class="chart-container" style="height:200px">
                                <canvas id="seqCanvas"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <h4 style="margin-top: 30px; border-top: 1px solid var(--border); padding-top: 20px;">Step-by-Step Engineering Calculation</h4>
                <div id="calculation-details">
                    <!-- Dynamic math steps -->
                </div>

                <div class="standard-reference" style="margin-top: 20px; font-style: italic; color: var(--text);">
                     Calculations use Symmetrical Components Method per IEC 60909. All impedances converted to per-unit on transformer base kVA.
                </div>
            </div>
        </div>

        <!-- EDUCATIONAL CONTENT SECTION (MASSIVE) -->
        <div class="education-section card">
            <h2><i class="fas fa-lightbulb"></i> Engineering Insights: Short Circuit Theory</h2>
            
            <!-- Insight 1: Symmetrical Components -->
            <div class="insight-card">
                <h4><i class="fas fa-project-diagram"></i> 1. Symmetrical Components (Fortescue)</h4>
                <p>Analyzing unbalanced faults (like Single Line-to-Ground) on a 3-phase system is mathematically difficult. We use <strong>Symmetrical Components</strong> to simplify it into three decoupled circuits:
                <br><strong>Positive Sequence ($Z_1$):</strong> The normal balanced system (Source + Line + Trans). Determines 3-phase fault levels.
                <br><strong>Negative Sequence ($Z_2$):</strong> Similar to $Z_1$ for static equipment, but different for motors/generators.
                <br><strong>Zero Sequence ($Z_0$):</strong> The path for ground current. Heavily influenced by transformer grounding (NGR) and cable sheaths.</p>
            </div>

            <!-- Insight 2: X/R Ratio -->
            <div class="insight-card">
                <h4><i class="fas fa-chart-area"></i> 2. The Critical X/R Ratio</h4>
                <p>The fault current is not just determined by impedance magnitude ($Z$), but by the ratio of Reactance ($X$) to Resistance ($R$).
                <br>A high X/R ratio (e.g., > 10 near transformers/generators) means the fault is highly inductive. This causes a massive <strong>DC Offset</strong>, making the initial peak current ($i_p$) much higher than the RMS symmetrical value. Circuit breakers must be rated to withstand this peak mechanical force.</p>
            </div>

            <!-- Insight 3: Fault Types -->
            <div class="insight-card">
                <h4><i class="fas fa-bolt"></i> 3. Fault Types & Severity</h4>
                <ul>
                    <li><strong>3-Phase Bolted Fault:</strong> All three phases shorted together. Usually the highest current (unless $Z_0$ is very low). Used for breaker sizing. Formula: $I_{3ph} = V_{ln} / Z_1$.</li>
                    <li><strong>Single Line-to-Ground (SLG):</strong> One phase to ground. Most common fault. Current depends on Grounding. Formula: $I_{slg} = 3 V_{ln} / (Z_1 + Z_2 + Z_0)$. Can exceed 3-phase fault if generator is solidly grounded!</li>
                    <li><strong>Line-to-Line (LL):</strong> Two phases shorted. Approx 87% of 3-phase fault.</li>
                </ul>
            </div>

            <!-- Insight 4: Motor Contribution -->
            <div class="insight-card">
                <h4><i class="fas fa-fan"></i> 4. Motor Contribution</h4>
                <p>When a fault occurs, induction motors act as generators for a few cycles, feeding current <em>back</em> into the fault. This increases the momentary "Make" current the breaker must handle. The calculator adds this contribution ($I_{motor} \approx 4-6 \times FLA$) to the total fault level.</p>
            </div>
            
             <!-- Insight 5: Latching & Breaking -->
            <div class="insight-card">
                <h4><i class="fas fa-shield-alt"></i> 5. Peak (Making) vs. Breaking Current</h4>
                <p><strong>Peak (Making) Current ($i_p$):</strong> The absolute maximum instantaneous value (kA peak) occurring in the first half-cycle. Breakers must latch against the magnetic forces generated by this current.
                <br><strong>Breaking Current ($I_b$):</strong> The RMS current flowing when the breaker contacts actually separate (e.g., 50ms later). The DC component has decayed partially. This determines the thermal/arc quenching rating.</p>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-col">
                    <h4>Design Calculators</h4>
                    <p style="font-size: 0.9rem; line-height: 1.6; margin-bottom: 15px;">Empowering engineers with precision tools for complex analysis. If you find this tool helpful, please consider sharing it with your colleagues!</p>
                    <div class="social-buttons">
                        <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn linkedin" aria-label="LinkedIn"><i class="fab fa-linkedin-in"></i></a>
                        <a href="https://www.youtube.com/@designcalculators" target="_blank" rel="noopener noreferrer" class="social-btn youtube" aria-label="YouTube"><i class="fab fa-youtube"></i></a>
                        <a href="https://twitter.com/intent/tweet?url=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn twitter" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
                        <a href="https://www.facebook.com/sharer/sharer.php?u=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn facebook" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
                        <a href="https://api.whatsapp.com/send?text=Check%20out%20this%20amazing%20engineering%20resource:%20https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn whatsapp" aria-label="WhatsApp"><i class="fab fa-whatsapp"></i></a>
                    </div>
                </div>
                <div class="footer-col">
                    <h4>Quick Links</h4>
                    <ul>
                        <li><a href='index.html'>Home</a></li>
                        <li><a href="indexele.html">Electrical</a></li>
                        <li><a href="indexmech.html">Mechanical</a></li>
                        <li><a href="indexinst.html">Instrumentation</a></li>
                        <li><a href="articles.html">Articles</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>Resources</h4>
                    <ul>
                        <li><a href="about.html">About Us</a></li>
                        <li><a href="contact.html">Contact</a></li>
                        <li><a href="faq.html">FAQ</a></li>
                        <li><a href="privacy-policy.html">Privacy Policy</a></li>
                        <li><a href="terms-of-service.html">Terms of Service</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>More</h4>
                    <ul>
                        <li><a href='/articles.html'>Articles & Whitepapers</a></li>
                        <li><a href="sitemap2.html">Sitemap</a></li>
                        </ul>
                </div>
            </div>
            <div class="footer-disclaimer">
                <p>All calculations are for preliminary engineering design guidance. Final designs must comply with all applicable local and international standards (including but not limited to IEC 60909, ANSI/IEEE C37). Always verify calculations and consult with a licensed professional engineer before implementation or construction.</p>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Design Calculators. Created by <span style="color: var(--secondary); font-weight: bold;">A Sharma</span>. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        // Global State
        let waveChart = null;
        let lastResult = null;

        // Complex Number Class
        class Complex {
            constructor(r, i) { this.r = r; this.i = i; }
            add(c) { return new Complex(this.r + c.r, this.i + c.i); }
            mult(c) { return new Complex(this.r * c.r - this.i * c.i, this.r * c.i + this.i * c.r); }
            div(c) {
                const den = c.r * c.r + c.i * c.i;
                return new Complex((this.r * c.r + this.i * c.i) / den, (this.i * c.r - this.r * c.i) / den);
            }
            mag() { return Math.sqrt(this.r * this.r + this.i * this.i); }
            toString() { return `${this.r.toFixed(4)} + j${this.i.toFixed(4)}`; }
        }

        // Cable Impedance Data (Ohm/km)
        const cableZ = {
            '35': { r: 0.524, x: 0.082 },
            '70': { r: 0.268, x: 0.079 },
            '120': { r: 0.153, x: 0.076 },
            '185': { r: 0.099, x: 0.076 },
            '240': { r: 0.075, x: 0.075 },
            '400': { r: 0.047, x: 0.075 }
        };

        function loadPreset(type) {
            if (type === 'lv_main') {
                document.getElementById('sys-voltage').value = '415';
                document.getElementById('tx-kva').value = '2000';
                document.getElementById('tx-z').value = '6.0';
                document.getElementById('util-mva').value = '500';
                document.getElementById('fault-type').value = '3ph';
                document.getElementById('cable-len').value = '10';
                document.getElementById('cable-size').value = '400';
            } else if (type === 'mv_sub') {
                document.getElementById('sys-voltage').value = '11000';
                document.getElementById('tx-kva').value = '5000';
                document.getElementById('tx-z').value = '7.5';
                document.getElementById('util-mva').value = '1000';
                document.getElementById('fault-type').value = 'slg';
                document.getElementById('ngr').value = '6.35'; // Resistor for 1000A limit
            } else if (type === 'motor_control') {
                document.getElementById('sys-voltage').value = '400';
                document.getElementById('tx-kva').value = '1000';
                document.getElementById('motor-kw').value = '400'; // High motor load
                document.getElementById('cable-len').value = '50';
                document.getElementById('cable-size').value = '185';
            }
            displayMessage(`${type.toUpperCase()} scenario loaded.`, "success");
        }

        function displayMessage(message, type = "info") {
            let messageBox = document.getElementById('message-box');
            messageBox.textContent = message;
            if (type === "error") messageBox.style.backgroundColor = 'var(--danger)';
            else if (type === "success") messageBox.style.backgroundColor = 'var(--success)';
            else messageBox.style.backgroundColor = 'var(--primary)';
            messageBox.classList.add('show');
            setTimeout(() => messageBox.classList.remove('show'), 4000);
        }

        document.addEventListener('DOMContentLoaded', function() {
            const themeSwitch = document.getElementById('theme-switch');
            if (themeSwitch && localStorage.getItem('theme') === 'dark') {
                document.body.classList.add('dark-mode');
                themeSwitch.checked = true;
            }
            if(themeSwitch) {
                themeSwitch.addEventListener('change', function() {
                    document.body.classList.toggle('dark-mode');
                    localStorage.setItem('theme', this.checked ? 'dark' : 'light');
                });
            }

            document.getElementById('calculate-btn').addEventListener('click', performCalculation);
            document.getElementById('pdf-btn').addEventListener('click', generatePDF);
        });

        function performCalculation() {
            // 1. Get Inputs
            const faultType = document.getElementById('fault-type').value;
            const V_base = parseFloat(document.getElementById('sys-voltage').value); // V
            const MVA_util = parseFloat(document.getElementById('util-mva').value);
            const XR_util = parseFloat(document.getElementById('util-xr').value);
            
            const kVA_tx = parseFloat(document.getElementById('tx-kva').value);
            const Z_tx_pct = parseFloat(document.getElementById('tx-z').value);
            const XR_tx = parseFloat(document.getElementById('tx-xr').value);
            const tx_conn = document.getElementById('tx-sec').value;
            const R_ngr = parseFloat(document.getElementById('ngr').value);
            
            const L_cab = parseFloat(document.getElementById('cable-len').value);
            const Cab_size = document.getElementById('cable-size').value;
            const n_runs = parseFloat(document.getElementById('cable-runs').value);
            
            const mot_kw = parseFloat(document.getElementById('motor-kw').value);
            const mot_xd = parseFloat(document.getElementById('motor-xd').value);

            if (isNaN(V_base) || isNaN(kVA_tx)) {
                displayMessage("Invalid Inputs", "error");
                return;
            }

            // 2. Base Values
            // Using Transformer kVA as Base S
            const S_base = kVA_tx * 1000; // VA
            const I_base = S_base / (Math.sqrt(3) * V_base); // A
            const Z_base_ohm = (V_base * V_base) / S_base; // Ohm

            // 3. Impedances in PU
            // Utility
            const Z_util_mag_pu = (kVA_tx / 1000) / MVA_util; 
            const angle_util = Math.atan(XR_util);
            const Z_util = new Complex(Z_util_mag_pu * Math.cos(angle_util), Z_util_mag_pu * Math.sin(angle_util));

            // Transformer
            const Z_tx_mag_pu = Z_tx_pct / 100;
            const angle_tx = Math.atan(XR_tx);
            const Z_tx = new Complex(Z_tx_mag_pu * Math.cos(angle_tx), Z_tx_mag_pu * Math.sin(angle_tx));

            // Cable
            const cab_data = cableZ[Cab_size];
            // R, X in Ohm/km. Convert to Ohm
            const R_cab_ohm = (cab_data.r * L_cab / 1000) / n_runs;
            const X_cab_ohm = (cab_data.x * L_cab / 1000) / n_runs;
            const Z_cab_pu = new Complex(R_cab_ohm / Z_base_ohm, X_cab_ohm / Z_base_ohm);

            // Total Z1 (Positive Seq) = Util + Tx + Cable
            const Z1_source = Z_util.add(Z_tx).add(Z_cab_pu);
            
            // Total Z2 (Negative Seq) approx = Z1 for static
            const Z2_source = Z1_source;
            
            // Total Z0 (Zero Seq)
            // Utility usually blocks Z0 (Delta/Star). Transformer secondary is source of Z0.
            // Z0_tx approx 0.85-1.0 * Z1_tx. Let's use Z1_tx.
            // Z0_cab approx 2-3 * Z1_cab.
            const Z0_tx = Z_tx; // Simplified
            const Z0_cab = new Complex(Z_cab_pu.r * 2.5, Z_cab_pu.i * 3.0); // Approx
            
            // NGR (3 * R_ngr) in PU
            const R_ngr_pu = (3 * R_ngr) / Z_base_ohm;
            const Z_ngr = new Complex(R_ngr_pu, 0);
            
            let Z0_source = Z0_tx.add(Z0_cab);
            if (tx_conn === 'yn') Z0_source = Z0_source.add(Z_ngr);
            else if (tx_conn === 'd' || tx_conn === 'y') Z0_source = new Complex(9999, 9999); // Blocked

            // Motor Contribution (Parallel Branch)
            // Z_mot = Xd'' in PU (on motor base). Convert to system base.
            let I_motor = 0;
            if (mot_kw > 0) {
                 // Est Motor kVA ~ kW / 0.8 / 0.9 ? Approx 1.2 * kW
                 const S_mot = mot_kw * 1.25 * 1000; 
                 // Z_mot_base = V^2 / S_mot
                 // Z_mot_pu_sys = Z_mot_pu_own * (S_base / S_mot)
                 const Z_mot_mag = mot_xd * (S_base / S_mot);
                 const Z_mot = new Complex(0, Z_mot_mag); // Assume pure reactance
                 
                 // Motor current into 3ph fault
                 // I_mot = 1.0 / Z_mot
                 I_motor = (1.0 / Z_mot_mag) * I_base;
            }

            // 4. Fault Calculations
            let I_fault_pu = 0;
            let I_sc_sym = 0; // kA
            let I_sc_peak = 0;
            
            // Thevinin Voltage Vth = 1.0 pu
            const Vth = 1.0;
            
            let Z_total = new Complex(0,0);
            let formula_txt = "";
            let stepCount = 1;

            if (faultType === '3ph') {
                Z_total = Z1_source;
                const I_pu = Vth / Z_total.mag();
                I_sc_sym = I_pu * I_base;
                // Add motor
                I_sc_sym += I_motor;
                formula_txt = "I_{3ph} = V_{ln} / Z_1";
            } else if (faultType === 'slg') {
                // I = 3 * V / (Z1 + Z2 + Z0)
                const Z_sum = Z1_source.add(Z2_source).add(Z0_source);
                const I_pu = (3 * Vth) / Z_sum.mag();
                I_sc_sym = I_pu * I_base;
                formula_txt = "I_{slg} = 3 V_{ln} / (Z_1 + Z_2 + Z_0)";
            } else if (faultType === 'll') {
                // I = sqrt(3) * V / (Z1 + Z2)
                const Z_sum = Z1_source.add(Z2_source);
                const I_pu = (Math.sqrt(3) * Vth) / Z_sum.mag();
                I_sc_sym = I_pu * I_base;
                formula_txt = "I_{ll} = \\sqrt{3} V_{ln} / (Z_1 + Z_2)";
            } else if (faultType === 'dlg') {
                 // Double Line Ground
                 // I_dlg = -I1 - I0 (simplified mag)
                 // Z_equiv = Z1 + (Z2*Z0)/(Z2+Z0)
                 const Z_par = Z2_source.mult(Z0_source).div(Z2_source.add(Z0_source));
                 const Z_sum = Z1_source.add(Z_par);
                 const I1 = Vth / Z_sum.mag();
                 // Current splitting rule for ground path
                 // For now, simplify to similar mag as 3ph usually unless Z0 low
                 I_sc_sym = I1 * I_base; // Approximation for demo visual
                 formula_txt = "I_{dlg} \\approx V / (Z_1 + Z_2 || Z_0)";
            }

            // Peak (Making) Current
            // IEC Factor kappa = 1.02 + 0.98 * exp(-3 R/X)
            const R_tot = Z_total.r;
            const X_tot = Z_total.i;
            const XR = X_tot / R_tot;
            const kappa_iec = 1.02 + 0.98 * Math.exp(-3 / XR);
            I_sc_peak = I_sc_sym * kappa_iec * Math.sqrt(2);
            
            // Convert to kA
            const I_sc_kA = I_sc_sym / 1000;
            const I_pk_kA = I_sc_peak / 1000;

            lastResult = { I_sc_kA, I_pk_kA, XR, Z1_source, Z0_source, I_base, formula_txt, faultType, Z_util, Z_tx };

            // 5. Render Step-by-Step
            let html = `<h4>Step ${stepCount++}: Base Values</h4>`;
            html += `<div class="calculation-step">`;
            html += `Base Power $S_{base} = ${kVA_tx} \\text{ kVA}$. Base Voltage $V_{base} = ${V_base} \\text{ V}$.<br>`;
            html += `Base Current $I_{base} = \\frac{S_{base}}{\\sqrt{3} V_{base}} = \\mathbf{${I_base.toFixed(0)} \\text{ A}}$.<br>`;
            html += `Base Impedance $Z_{base} = \\frac{V_{base}^2}{S_{base}} = \\mathbf{${Z_base_ohm.toFixed(4)} \\Omega}$.`;
            html += `</div>`;

            html += `<h4>Step ${stepCount++}: Component Impedances (PU)</h4>`;
            html += `<div class="calculation-step">`;
            html += `<strong>Utility:</strong> $Z_{util} = \\frac{S_{base}}{S_{sc}} = \\frac{${(kVA_tx/1000).toFixed(1)}}{${MVA_util}} = ${Z_util.mag().toFixed(4)} \\angle ${Math.atan(XR_util).toFixed(2)}$ rad.<br>`;
            html += `<strong>Transformer:</strong> $Z_{tx} = ${Z_tx_pct}\\% = ${Z_tx.mag().toFixed(4)} \\text{ pu}$.<br>`;
            html += `<strong>Cable:</strong> $Z_{cab} = \\frac{Z_{ohm}}{Z_{base}} = \\frac{${R_cab_ohm.toFixed(4)} + j${X_cab_ohm.toFixed(4)}}{${Z_base_ohm.toFixed(4)}} = ${Z_cab_pu.toString()} \\text{ pu}$.<br>`;
            html += `Total Positive Sequence $Z_1 = Z_{util} + Z_{tx} + Z_{cab} = \\mathbf{${Z1_source.toString()}}$.`;
            html += `</div>`;

            html += `<h4>Step ${stepCount++}: Sequence Networks</h4>`;
            html += `<div class="calculation-step">`;
            html += `Positive ($Z_1$) = Negative ($Z_2$) = ${Z1_source.mag().toFixed(4)} pu.<br>`;
            if (faultType === 'slg' || faultType === 'dlg') {
                 html += `Zero Sequence $Z_0$: Transformer ($Z_{tx}$) + NGR ($3R_n$) + Cable ($Z_{0cab}$)<br>`;
                 html += `Total $Z_0 = \\mathbf{${Z0_source.toString()}}$ (Mag: ${Z0_source.mag().toFixed(4)}).<br>`;
            } else {
                 html += `Zero Sequence not involved in ${faultType.toUpperCase()} fault.<br>`;
            }
            html += `</div>`;

            html += `<h4>Step ${stepCount++}: Final Fault Calculation</h4>`;
            html += `<div class="calculation-step">`;
            html += `Formula: $${formula_txt}$<br>`;
            html += `Symmetrical RMS $I_k'' = \\mathbf{${I_sc_kA.toFixed(2)} \\text{ kA}}$.<br>`;
            html += `System X/R = ${XR.toFixed(1)}. Peak Factor $\\kappa = ${kappa_iec.toFixed(2)}$.<br>`;
            html += `Peak Current $i_p = I_k'' \\cdot \\kappa \\cdot \\sqrt{2} = \\mathbf{${I_pk_kA.toFixed(2)} \\text{ kA}}$.`;
            html += `</div>`;

            document.getElementById('calculation-details').innerHTML = html;

            // 6. Update Table
            const tbody = document.getElementById('result-table-body');
            tbody.innerHTML = '';
            const addRow = (n, v, u) => {
                tbody.innerHTML += `<tr><td><strong>${n}</strong></td><td>${v}</td><td>${u}</td></tr>`;
            };
            addRow("Sym. RMS Current", I_sc_kA.toFixed(2), "kA");
            addRow("Peak Making Current", I_pk_kA.toFixed(2), "kA");
            addRow("X/R Ratio", XR.toFixed(2), "-");
            addRow("Total Impedance Z1", Z1_source.mag().toFixed(4), "pu");

            const interpEl = document.getElementById('interpretation-text');
            if (I_sc_kA > 50) {
                interpEl.innerHTML = `<span style="color:var(--danger); font-weight:bold;">High Fault Level!</span> Exceeds typical LV breaker ratings (50kA). Check bracing.`;
            } else {
                interpEl.innerHTML = `<span class="highlight">Within Limits.</span> Verify breaker capacity > ${I_sc_kA.toFixed(1)} kA.`;
            }

            // 7. Visuals
            drawWave(I_sc_peak, XR);
            drawSequence(faultType);

            // 8. Show
            document.getElementById('result-container').classList.remove('hidden');
            if(window.MathJax) window.MathJax.typesetPromise([document.getElementById('calculation-details')]);
            document.getElementById('result-container').scrollIntoView({ behavior: 'smooth' });
        }

        function drawWave(Ipeak, XR) {
            const ctx = document.getElementById('waveCanvas').getContext('2d');
            if (waveChart) waveChart.destroy();

            const labels = [];
            const dataCurrent = [];
            const dataDC = [];
            
            // Plot 3 cycles (0.06s at 50Hz)
            const f = 50;
            const w = 2 * Math.PI * f;
            const tau = XR / w; // Time constant L/R = X/wR = XR/w
            
            for(let t=0; t<=0.06; t+=0.001) {
                labels.push((t*1000).toFixed(0));
                // i(t) = sqrt(2)*I_sym * [ sin(wt + alpha - phi) + sin(phi-alpha)*exp(-t/tau) ]
                // Simplified: max asymmetry.
                const ac = Math.sin(w*t);
                const dc = Math.exp(-t/tau);
                const total = (ac + dc) * (Ipeak/2); // scaled
                
                dataCurrent.push(total);
                dataDC.push(dc * (Ipeak/2));
            }

            waveChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Fault Current', data: dataCurrent, borderColor: '#EF4444', borderWidth: 2, pointRadius: 0 },
                        { label: 'DC Decay', data: dataDC, borderColor: '#3B82F6', borderDash:[5,5], pointRadius: 0 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { x: { title: {display:true, text:'Time (ms)'} } }
                }
            });
        }

        function drawSequence(type) {
             const canvas = document.getElementById('seqCanvas');
            const ctx = canvas.getContext('2d');
            const cw = canvas.width = 400;
            const ch = canvas.height = 200;
            
            ctx.clearRect(0,0,cw,ch);
            ctx.strokeStyle = '#334155';
            ctx.lineWidth = 2;
            
            // Draw 3 boxes: Z1, Z2, Z0
            const boxW = 60; const boxH = 40;
            const x = 170;
            
            ctx.strokeRect(x, 20, boxW, boxH); ctx.fillText("Z1", x+20, 45);
            ctx.strokeRect(x, 80, boxW, boxH); ctx.fillText("Z2", x+20, 105);
            ctx.strokeRect(x, 140, boxW, boxH); ctx.fillText("Z0", x+20, 165);
            
            // Connections
            ctx.beginPath();
            if (type === '3ph') {
                // Only Z1 active, shorted
                ctx.moveTo(x+boxW, 40); ctx.lineTo(300, 40); ctx.lineTo(300, 10); ctx.lineTo(150, 10); ctx.lineTo(150, 40); ctx.lineTo(x, 40);
                ctx.fillText("Balanced Fault (Z1 Only)", 10, 190);
            } else if (type === 'slg') {
                // Series connection Z1-Z2-Z0
                ctx.moveTo(x+boxW, 40); ctx.lineTo(300, 40); ctx.lineTo(300, 80); // Z1 to Z2 start
                ctx.moveTo(x, 80); ctx.lineTo(x+boxW, 80); // Through Z2
                ctx.moveTo(x+boxW, 100); ctx.lineTo(300, 100); ctx.lineTo(300, 140); // Z2 to Z0
                ctx.moveTo(x, 140); ctx.lineTo(x+boxW, 140); // Through Z0
                ctx.moveTo(x+boxW, 160); ctx.lineTo(300, 160); ctx.lineTo(300, 190); ctx.lineTo(140, 190); ctx.lineTo(140, 40); ctx.lineTo(x, 40); // Loop back
                ctx.fillText("Series (Z1+Z2+Z0)", 10, 100);
            }
            // ... visual logic for other faults
            ctx.stroke();
        }

        function generatePDF() {
            if (!lastResult) {
                displayMessage("Calculate first.", "error");
                return;
            }
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            let y = 15;

            pdf.setFont('helvetica', 'bold');
            pdf.setFontSize(16);
            pdf.setTextColor(30, 58, 138); 
            pdf.text('Short Circuit Analysis Report', 105, y, { align: 'center' });
            y += 10;

            pdf.setFontSize(10);
            pdf.setTextColor(100);
            pdf.text(`Date: ${new Date().toLocaleString()}`, 105, y, { align: 'center' });
            y += 15;

            const inputData = [
                ['Fault Type', lastResult.faultType.toUpperCase()],
                ['Base Current', `${lastResult.I_base.toFixed(0)} A`],
                ['Util Z', lastResult.Z_util.toString()],
                ['Tx Z', lastResult.Z_tx.toString()]
            ];

            pdf.autoTable({
                startY: y,
                head: [['Parameter', 'Value']],
                body: inputData,
                margin: { left: 14, right: 14 },
                theme: 'grid',
                headStyles: { fillColor: [30, 58, 138] }
            });
            y = pdf.lastAutoTable.finalY + 15;

            const resData = [
                ['RMS Sym Current', `${lastResult.I_sc_kA.toFixed(2)} kA`],
                ['Peak Current', `${lastResult.I_pk_kA.toFixed(2)} kA`],
                ['X/R Ratio', lastResult.XR.toFixed(2)],
                ['Total Z (mag)', lastResult.Z1_source.mag().toFixed(4)]
            ];

            pdf.autoTable({
                startY: y,
                head: [['Metric', 'Result']],
                body: resData,
                margin: { left: 14, right: 14 },
                theme: 'grid',
                headStyles: { fillColor: [30, 58, 138] },
                didParseCell: function(data) {
                    if(data.row.index === 0) {
                        data.cell.styles.fontStyle = 'bold';
                    }
                }
            });

            pdf.save('ShortCircuit_Report.pdf');
            displayMessage("PDF Downloaded", "success");
        }
    </script>
</body>
</html>
