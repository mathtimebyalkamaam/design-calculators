<!DOCTYPE html>
<html lang="en">
<head> 
                <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-23Y1V450SR"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-23Y1V450SR');     
</script>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5936527763614780"
     crossorigin="anonymous"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Short Circuit Current - Design Calculators - Electrical</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="icon" href="/favicon.ico" type="image/x-icon">

    <style>
        /* Basic CSS Variables for a consistent theme */
        :root {
            --primary-color: #4CAF50; /* Green */
            --secondary-color: #45a049; /* Darker Green */
            --accent-color: #FFC107; /* Amber */
            --bg-color: #f4f7f6; /* Light Greyish Green */
            --card-bg: #ffffff; /* White */
            --text-color: #333333; /* Dark Grey */
            --header-bg: #2C3E50; /* Dark Blue Grey */
            --footer-bg: #34495E; /* Slightly Lighter Dark Blue Grey */
            --border-color: #cccccc;
            --card-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            --hover-color: #e2e6ea;
            --input-focus-border: #4CAF50;
            --button-hover-bg: #45a049;
        }

        /* Dark Mode Variables */
        body.dark-mode {
            --bg-color: #2c3e50;
            --card-bg: #34495e;
            --text-color: #ecf0f1;
            --header-bg: #2c3e50;
            --footer-bg: #2c3e50;
            --border-color: #555555;
            --card-shadow: 0 4px 8px rgba(0,0,0,0.3);
            --hover-color: #446688;
            --input-focus-border: #8bc34a; /* Lighter green for dark mode focus */
            --button-hover-bg: #3e8e41; /* Darker green for dark mode button hover */
        }

        /* General Body Styling */
        body {
            font-family: 'Inter', sans-serif; /* Using Inter as specified */
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 960px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: var(--header-bg);
            color: white;
            padding: 20px 0;
            text-align: center;
            box-shadow: var(--card-shadow);
            position: relative; /* For theme toggle positioning */
        }

        header h1 {
            margin: 0;
            font-size: 2.5em;
            color: var(--primary-color);
        }

        header .subtitle {
            margin: 5px 0 0;
            font-size: 1em;
            color: #bdc3c7;
        }

        main {
            padding: 20px 0;
        }

        .tool-container {
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 20px;
            box-shadow: var(--card-shadow);
            margin-bottom: 20px;
        }

        .tool-container h2 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            margin-top: 0;
            margin-bottom: 20px;
        }
        /* Ensure H2 is visible in dark mode */
        body.dark-mode .tool-container h2 {
            color: white; /* Explicitly set to white for visibility */
            border-bottom-color: white;
        }

        .tool-description {
            margin-bottom: 20px;
            color: var(--text-color);
        }

        .back-button {
            display: inline-block;
            background-color: var(--primary-color);
            color: white;
            padding: 10px 15px;
            border-radius: 4px;
            text-decoration: none;
            margin-bottom: 20px;
            transition: background-color 0.3s;
        }

        .back-button:hover {
            background-color: var(--secondary-color);
        }

        /* Theme Toggle */
        .theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
        }

        .theme-toggle .light-icon,
        .theme-toggle .dark-icon {
            color: white;
            margin: 0 5px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
        }

        input:checked + .slider {
            background-color: var(--primary-color);
        }

        input:focus + .slider {
            box-shadow: 0 0 1px var(--primary-color);
        }

        input:checked + .slider:before {
            -webkit-transform: translateX(26px);
            -ms-transform: translateX(26px);
            transform: translateX(26px);
        }

        /* Rounded sliders */
        .slider.round {
            border-radius: 34px;
        }

        .slider.round:before {
            border-radius: 50%;
        }

        /* Footer Styling */
        footer {
            background-color: var(--footer-bg);
            color: white;
            padding: 20px 0;
            text-align: center;
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1);
            margin-top: 30px;
        }

        footer .disclaimer h3,
        footer .social-share h3 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        footer .disclaimer p {
            font-size: 0.9em;
            color: #bdc3c7;
        }

        .social-buttons {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .social-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            color: white;
            text-decoration: none;
            font-size: 1.2em;
            transition: transform 0.3s ease-in-out;
        }

        .social-btn:hover {
            transform: translateY(-3px);
        }

        .social-btn.linkedin { background-color: #0A66C2; }
        .social-btn.facebook { background-color: #1877F2; }
        .social-btn.twitter { background-color: #1DA1F2; }
        .social-btn.whatsapp { background-color: #25D366; }
        .social-btn.reddit { background-color: #FF4500; }

        /* Styles for Calculator Forms and Results */
        .calculator-form {
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: var(--card-shadow);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--text-color); /* Ensure label text is visible */
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: border-color 0.3s, box-shadow 0.3s; /* Add transition for input focus */
        }

        .form-group input:focus, .form-group select:focus {
            border-color: var(--input-focus-border);
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.3); /* Green shadow */
            outline: none;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .form-row .form-group {
            flex: 1 1 200px;
        }
        
        .calculate-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin-top: 10px;
            transition: background-color 0.3s, transform 0.1s ease-in-out;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .calculate-btn:hover {
            background-color: var(--button-hover-bg);
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0,0,0,0.15);
        }

        .calculate-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .result-container {
            margin-top: 30px;
            padding: 20px;
            border-radius: 8px;
            background-color: var(--card-bg);
            box-shadow: var(--card-shadow);
            display: none; /* Hidden by default */
            opacity: 0; /* For fade-in animation */
            transition: opacity 0.5s ease-in-out;
        }
        
        .result-container.show {
            opacity: 1;
        }

        .result-container h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        /* Ensure H3 is visible in dark mode */
        body.dark-mode .result-container h3 {
            color: white; /* Explicitly set to white for visibility */
        }

        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .result-table th, .result-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        .result-table th {
            background-color: var(--hover-color);
        }
        
        .standard-reference {
            margin-top: 20px;
            font-style: italic;
            font-size: 0.9rem;
            color: var(--text-color); /* Ensure visibility in dark mode */
        }
        
        .info-icon {
            color: var(--primary-color);
            margin-left: 5px;
            cursor: help;
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* Custom message box style */
        #custom-message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            font-weight: bold;
            color: white;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        /* Loading Spinner */
        .loading-spinner {
            display: none; /* Hidden by default */
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid var(--primary-color); /* Green */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Styles for detailed calculation steps */
        .detailed-calculations, .short-circuit-reduction-tips {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--hover-color); /* A lighter background for contrast */
            color: var(--text-color); /* Ensure text visibility */
        }

        body.dark-mode .detailed-calculations, body.dark-mode .short-circuit-reduction-tips {
            background-color: #3a475a; /* Darker background for contrast in dark mode */
            border-color: #6a7a8f;
        }

        .detailed-calculations h4, .short-circuit-reduction-tips h4 {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 10px;
            color: var(--primary-color); /* Highlight heading */
        }
        body.dark-mode .detailed-calculations h4, body.dark-mode .short-circuit-reduction-tips h4 {
            color: var(--primary-color); /* Use lighter primary color in dark mode */
        }

        .detailed-calculations p, .short-circuit-reduction-tips p, .short-circuit-reduction-tips ul {
            margin-bottom: 5px;
            font-size: 0.95rem;
            line-height: 1.4;
        }
        .short-circuit-reduction-tips ul {
            list-style-type: disc;
            padding-left: 20px;
        }

        .detailed-calculations strong, .short-circuit-reduction-tips strong {
            color: var(--secondary-color); /* Highlight key terms in formulas */
        }
        body.dark-mode .detailed-calculations strong, body.dark-mode .short-circuit-reduction-tips strong {
            color: var(--primary-color); /* Use lighter primary color for highlights in dark mode */
        }

        /* MathJax rendered formulas will have the desired styling */
        .formula {
            font-family: 'Courier New', Courier, monospace; /* Not strictly needed with MathJax, but good for raw */
            background-color: rgba(0,0,0,0.05); /* Light tint for formula background */
            padding: 2px 5px;
            border-radius: 3px;
            display: inline-block; /* Helps with MathJax inline rendering */
            margin-top: 5px;
            font-size: 0.9em;
        }
        body.dark-mode .formula {
            background-color: rgba(255,255,255,0.05);
        }

        .calculation-step {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px dashed var(--border-color);
        }

        .detailed-calculations .calculation-step:last-child {
            border-bottom: none; /* No border after the last step */
        }
    </style>
    <!-- MathJax configuration and loading -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
            },
            svg: {
                fontCache: 'global'
            },
            options: {
                processHtmlClass: 'math-content', // Process elements with this class
                ignoreHtmlClass: 'no-mathjax'      // Ignore elements with this class
            }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>
    <header>
        <div class="container">
            <h1>Design Calculators - Electrical</h1>
            <p class="subtitle">Electrical Calculations Made Easy — Learn with Every Step</p>
            <div class="theme-toggle">
                <span class="light-icon"><i class="fas fa-sun"></i></span>
                <label class="switch">
                    <input type="checkbox" id="theme-switch">
                    <span class="slider round"></span>
                </label>
                <span class="dark-icon"><i class="fas fa-moon"></i></span>
            </div>
        </div>
    </header>

    <main class="container">
        <a href="indexEle.html" class="back-button"><i class="fas fa-arrow-left"></i> Back to Tools</a>
        
        <div class="tool-container">
            <h2>Advanced Short Circuit Current Calculator</h2>
            
            <div class="tool-description">
                <p>This calculator estimates various types of short-circuit currents, including symmetrical and asymmetrical three-phase, single-line-to-ground, line-to-line, and double-line-to-ground faults. It accounts for utility, transformer, cable, and motor contributions, which is crucial for sizing protective devices and ensuring equipment withstand capabilities. Calculations follow principles compatible with <strong>IEEE (e.g., C37 series, Std 141)</strong> and <strong>IEC (e.g., 60909)</strong> standards. For detailed and certified studies, specialized software and expert consultation are required.</p>
            </div>
        
            <div class="calculator-form">
                <form id="short-circuit-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="system-voltage">System Voltage (V - Line-to-Line) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The nominal line-to-line voltage of the electrical system at the point of interest.</span></span></label>
                            <input type="number" id="system-voltage" min="1" step="1" value="415" required>
                        </div>
                        <div class="form-group">
                            <label for="fault-type">Fault Type <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Select the type of short circuit fault to calculate.</span></span></label>
                            <select id="fault-type" required>
                                <option value="three-phase-symmetrical">Three-Phase Symmetrical (3PH)</option>
                                <option value="single-line-to-ground">Single-Line-to-Ground (SLG)</option>
                                <option value="line-to-line">Line-to-Line (LL)</option>
                                <option value="double-line-to-ground">Double-Line-to-Ground (DLG)</option>
                            </select>
                        </div>
                    </div>
                    
                    <h3>Source (Utility/Grid) Data</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="utility-fault-mva">Utility Fault Level (MVA) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The available fault level from the utility grid at the transformer's primary side (e.g., 500 MVA). Enter 0 for an infinite bus assumption (simplified, $Z_{utility}=0$).</span></span></label>
                            <input type="number" id="utility-fault-mva" min="0" step="1" value="500" required>
                        </div>
                        <div class="form-group">
                            <label for="utility-xr-ratio">Utility X/R Ratio <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The X/R ratio of the utility source impedance. Typical values are 5-20 for high voltage, lower for low voltage.</span></span></label>
                            <input type="number" id="utility-xr-ratio" min="1" step="0.1" value="10" required>
                        </div>
                    </div>

                    <h3>Transformer Data</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="transformer-kva">Transformer Rating (kVA) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The kVA rating of the upstream transformer.</span></span></label>
                            <input type="number" id="transformer-kva" min="1" step="1" value="1000" required>
                        </div>
                        <div class="form-group">
                            <label for="transformer-impedance">Transformer Impedance (%) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The percentage impedance of the transformer (typically found on the nameplate).</span></span></label>
                            <input type="number" id="transformer-impedance" min="0.1" max="20" step="0.1" value="5.75" required>
                        </div>
                    </div>
                    <div class="form-row">
                         <div class="form-group">
                            <label for="transformer-xr-ratio">Transformer X/R Ratio <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The X/R ratio of the transformer impedance. Typical values are 3-7.</span></span></label>
                            <input type="number" id="transformer-xr-ratio" min="0.5" step="0.1" value="5" required>
                        </div>
                        <div class="form-group">
                            <label for="transformer-connection-primary">Transformer Primary Connection <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Connection type of the transformer primary winding.</span></span></label>
                            <select id="transformer-connection-primary" required>
                                <option value="delta">Delta (Δ)</option>
                                <option value="wye-grounded">Wye Grounded (Yg)</option>
                                <option value="wye-ungrounded">Wye Ungrounded (Yu)</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="transformer-connection-secondary">Transformer Secondary Connection <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Connection type of the transformer secondary winding.</span></span></label>
                            <select id="transformer-connection-secondary" required>
                                <option value="wye-grounded">Wye Grounded (Yg)</option>
                                <option value="delta">Delta (Δ)</option>
                                <option value="wye-ungrounded">Wye Ungrounded (Yu)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="transformer-grounding-impedance">Transformer Grounding Impedance ($\Omega$) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">External impedance in transformer neutral grounding path (for Yg secondary). Enter 0 for solid grounding.</span></span></label>
                            <input type="number" id="transformer-grounding-impedance" min="0" step="0.001" value="0.001">
                        </div>
                    </div>

                    <h3>Cable Data (Transformer to Fault)</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="cable-length">Cable Length (m) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The length of the cable connecting the transformer's secondary to the fault location.</span></span></label>
                            <input type="number" id="cable-length" min="0" step="0.1" value="20" required>
                        </div>
                        <div class="form-group">
                            <label for="cable-size">Cable Cross-Sectional Area (mm<sup>2</sup>) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The cross-sectional area of the conductors in the cable.</span></span></label>
                            <input type="number" id="cable-size" min="1.5" step="0.5" value="185" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="cable-material">Cable Material <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Material of the cable conductors (Copper or Aluminum).</span></span></label>
                            <select id="cable-material" required>
                                <option value="copper">Copper</option>
                                <option value="aluminum">Aluminum</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="cable-xr-ratio">Cable X/R Ratio <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The X/R ratio of the cable impedance. Typical values are 0.5-3 for LV cables.</span></span></label>
                            <input type="number" id="cable-xr-ratio" min="0.1" step="0.1" value="1" required>
                        </div>
                    </div>
                    <div class="form-row">
                         <div class="form-group">
                            <label for="cable-temperature">Cable Operating Temperature (°C) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Operating temperature of the cable, affecting its resistance. Standard reference is 75°C or 90°C.</span></span></label>
                            <input type="number" id="cable-temperature" min="20" step="5" value="75" required>
                        </div>
                    </div>

                    <h3>Motor Contribution (Optional)</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="motor-hp">Total Motor Horsepower (HP) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Total aggregate horsepower of motors connected to the fault bus.</span></span></label>
                            <input type="number" id="motor-hp" min="0" step="1" value="0">
                        </div>
                        <div class="form-group">
                            <label for="motor-efficiency">Motor Efficiency (%) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Average efficiency of the motors.</span></span></label>
                            <input type="number" id="motor-efficiency" min="50" max="100" step="1" value="85">
                        </div>
                    </div>
                    <div class="form-row">
                         <div class="form-group">
                            <label for="motor-starting-pf">Motor Starting Power Factor <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Average starting power factor of the motors (typically low, e.g., 0.2-0.4).</span></span></label>
                            <input type="number" id="motor-starting-pf" min="0.1" max="0.99" step="0.01" value="0.3">
                        </div>
                        <div class="form-group">
                            <label for="motor-subtransient-reactance">Motor Sub-transient Reactance ($X''_{d}$) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Average sub-transient reactance of motors in per-unit (pu). Typical range: 0.15 - 0.25 pu.</span></span></label>
                            <input type="number" id="motor-subtransient-reactance" min="0.05" max="0.5" step="0.01" value="0.2">
                        </div>
                    </div>
                    
                    <button type="button" id="calculate-short-circuit-btn" class="calculate-btn">Calculate Short Circuit Current</button>
                    <div id="loading-spinner" class="loading-spinner"></div>
                </form>
            </div>
            
            <div id="result-container" class="result-container">
                <h3>Calculation Summary</h3>
                <table class="result-table">
                    <thead>
                        <tr>
                            <th>Parameter</th>
                            <th>Value</th>
                        </tr>
                    </thead>
                    <tbody id="result-table-body">
                        <!-- Results will be dynamically inserted here -->
                    </tbody>
                </table>
                <!-- Detailed calculations section -->
                <div id="detailed-calculations" class="detailed-calculations mt-6 math-content">
                    <h3>Detailed Calculation Steps</h3>
                    <!-- Detailed calculation steps will be dynamically inserted here -->
                </div>

                <!-- Short Circuit Current Reduction Tips Section -->
                <div id="short-circuit-reduction-tips" class="short-circuit-reduction-tips mt-6">
                    <h3>Tips for Reducing Short Circuit Current and Ensuring Safety</h3>
                    <p>Managing short-circuit currents is crucial for the safety and reliability of electrical systems. High fault currents can cause severe damage to equipment, fire hazards, and arc flash incidents. Here are common strategies:</p>
                    <ul>
                        <li>
                            <strong>Increase System Impedance:</strong> This is the most direct way to limit fault current. This can be achieved by:
                            <ul>
                                <li><strong>Using higher impedance transformers:</strong> Transformers with higher percentage impedance (Z%) naturally limit downstream fault currents.</li>
                                <li><strong>Adding Current Limiting Reactors:</strong> Series reactors can be installed to add impedance to the circuit, thereby reducing fault currents.</li>
                                <li><strong>Increasing Cable Length or Reducing Cable Size:</strong> While not always practical due to voltage drop and heating concerns, increasing conductor impedance will reduce fault current.</li>
                            </ul>
                        </li>
                        <li>
                            <strong>Bus Sectionalizing:</strong> Dividing a large bus into smaller sections using circuit breakers or switches can limit the fault current to a particular section, preventing a cascading failure of the entire system.
                        </li>
                        <li>
                            <strong>High Impedance Grounding:</strong> For grounded systems, introducing impedance in the neutral-to-ground path can limit ground fault currents, though this method is more about limiting ground fault damage than three-phase short circuits.
                        </li>
                        <li>
                            <strong>Properly Sized Protective Devices:</strong> Ensure circuit breakers, fuses, and other protective devices have an interrupting rating (AIC/breaking capacity) greater than or equal to the maximum available short-circuit current at their point of installation. This is critical for preventing device failure during a fault.
                        </li>
                        <li>
                            <strong>Selective Coordination:</strong> Design the protection system so that only the closest protective device to the fault operates, isolating the fault without affecting upstream devices. This minimizes outages and improves system reliability.
                        </li>
                        <li>
                            <strong>Arc Flash Mitigation:</strong> While not directly reducing fault current, strategies like Arc-Resistant Switchgear, Remote Racking, and Optical Relays can reduce the hazardous effects of arc flash incidents that are caused by high fault currents.
                        </li>
                    </ul>
                    <p class="mt-4 text-sm text-gray-600 dark:text-gray-400"><em>Short circuit analysis and protective device coordination are complex engineering tasks. Always consult with a qualified electrical engineer and adhere to local and international electrical codes and standards (e.g., NFPA 70E, IEEE 242) for proper design and implementation.</em></p>
                </div>
                <!-- END NEW: Short Circuit Current Reduction Tips Section -->

                <div class="standard-reference" id="standard-reference-text">
                    <p>Short circuit calculations typically adhere to international standards such as: <br>
                    - <strong>IEC 60909:</strong> Short-circuit currents in three-phase a.c. systems. <br>
                    - <strong>IEEE C37.010:</strong> Application Guide for AC High-Voltage Circuit Breakers Rated on a Symmetrical Current Basis. <br>
                    - <strong>ANSI/IEEE C37.13:</strong> Standard for Low-Voltage AC Power Circuit Breakers Used in Enclosures. <br>
                    - <strong>NFPA 70E:</strong> Standard for Electrical Safety in the Workplace (for arc flash considerations related to fault currents).</p>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <div class="disclaimer">
                
                <p>Disclaimer: Always verify calculation results against applicable engineering standards and guidelines.</p>
            </div>
            <div class="credit">
                <p>Created by A Sharma</p>
                <p>&copy; 2025 Design Calculators</p>
            </div>
            <div class="social-share">
                <h3>Share This Site</h3>
                <div class="social-buttons">
                    <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://designcalculators.co.in&title=Design Calculators" target="_blank" class="social-btn linkedin">
                        <i class="fab fa-linkedin"></i>
                    </a>
                    <a href="https://www.facebook.com/sharer/sharer.php?u=https://designcalculators.co.in" target="_blank" class="social-btn facebook">
                        <i class="fab fa-facebook"></i>
                    </a>
                    <a href="https://twitter.com/intent/tweet?text=Check out this amazing Design Calculators - Electrical!&url=https://designcalculators.co.in" target="_blank" class="social-btn twitter">
                        <i class="fab fa-twitter"></i>
                    </a>
                    <a href="https://api.whatsapp.com/send?text=Check out this amazing Design Calculators - Electrical! https://designcalculators.co.in" target="_blank" class="social-btn whatsapp">
                        <i class="fab fa-whatsapp"></i>
                    </a>
                    <a href="https://www.reddit.com/submit?url=https://designcalculators.co.in&title=Design Calculators - Electrical" target="_blank" class="social-btn reddit">
                        <i class="fab fa-reddit"></i>
                    </a>
                </div>
            </div>
        </div>
    </footer>

    <!-- Custom Message Box -->
    <div id="custom-message-box"></div>

    <script>
        // Complex number class for impedance calculations
        class Complex {
            constructor(real, imag) {
                this.re = real;
                this.im = imag;
            }

            add(other) {
                return new Complex(this.re + other.re, this.im + other.im);
            }

            subtract(other) {
                return new Complex(this.re - other.re, this.im - other.im);
            }

            multiply(other) {
                return new Complex(
                    this.re * other.re - this.im * other.im,
                    this.re * other.im + this.im * other.re
                );
            }

            divide(other) {
                const denominator = other.re * other.re + other.im * other.im;
                if (denominator === 0) {
                    // Handle division by zero or very small denominator, return a large number
                    // This mimics an open circuit or infinite impedance
                    return new Complex(1e12, 1e12); 
                }
                return new Complex(
                    (this.re * other.re + this.im * other.im) / denominator,
                    (this.im * other.re - this.re * other.im) / denominator
                );
            }

            magnitude() {
                return Math.sqrt(this.re * this.re + this.im * this.im);
            }

            angleRadians() {
                return Math.atan2(this.im, this.re);
            }

            angleDegrees() {
                return this.angleRadians() * 180 / Math.PI;
            }

            // Method to convert Complex to a string representation (e.g., "R + jX")
            toString(fixed = 4) {
                const sign = this.im >= 0 ? '+' : '-';
                return `${this.re.toFixed(fixed)} ${sign} j${Math.abs(this.im).toFixed(fixed)}`;
            }

            // Method to get X/R ratio
            getXRRatio() {
                if (this.re === 0) return this.im >= 0 ? Infinity : -Infinity;
                return this.im / this.re;
            }
        }


        document.addEventListener('DOMContentLoaded', function() {
            const calculateBtn = document.getElementById('calculate-short-circuit-btn');
            const resultContainer = document.getElementById('result-container');
            const resultTableBody = document.getElementById('result-table-body');
            const detailedCalculationsDiv = document.getElementById('detailed-calculations');
            const shortCircuitReductionTipsDiv = document.getElementById('short-circuit-reduction-tips');
            const standardReferenceTextDiv = document.getElementById('standard-reference-text');
            const loadingSpinner = document.getElementById('loading-spinner');

            // Set default values for inputs
            document.getElementById('system-voltage').value = 415;
            document.getElementById('transformer-kva').value = 1000;
            document.getElementById('transformer-impedance').value = 5.75;
            document.getElementById('utility-fault-mva').value = 500;
            document.getElementById('cable-length').value = 20;
            document.getElementById('cable-size').value = 185;
            document.getElementById('cable-material').value = 'copper';
            document.getElementById('fault-type').value = 'three-phase-symmetrical'; // New default for fault type
            document.getElementById('utility-xr-ratio').value = 10; // New default
            document.getElementById('transformer-xr-ratio').value = 5; // New default
            document.getElementById('transformer-connection-primary').value = 'delta'; // New default
            document.getElementById('transformer-connection-secondary').value = 'wye-grounded'; // New default
            document.getElementById('transformer-grounding-impedance').value = 0.001; // New default
            document.getElementById('cable-xr-ratio').value = 1; // New default
            document.getElementById('cable-temperature').value = 75; // New default
            document.getElementById('motor-hp').value = 0; // New default
            document.getElementById('motor-efficiency').value = 85; // New default
            document.getElementById('motor-starting-pf').value = 0.3; // New default
            document.getElementById('motor-subtransient-reactance').value = 0.2; // New default

            // Theme switch logic
            const themeSwitch = document.getElementById('theme-switch');
            if (themeSwitch) {
                // Check for saved theme preference
                if (localStorage.getItem('theme') === 'dark') {
                    document.body.classList.add('dark-mode');
                    themeSwitch.checked = true;
                }

                themeSwitch.addEventListener('change', function() {
                    if (this.checked) {
                        document.body.classList.add('dark-mode');
                        localStorage.setItem('theme', 'dark');
                    } else {
                        document.body.classList.remove('dark-mode');
                        localStorage.setItem('theme', 'light');
                    }
                });
            }

            calculateBtn.addEventListener('click', async function() {
                // Show loading spinner
                loadingSpinner.style.display = 'block';
                resultContainer.classList.remove('show'); // Hide results for animation

                // Get input values
                const systemVoltage = parseFloat(document.getElementById('system-voltage').value);
                const faultType = document.getElementById('fault-type').value;

                const utilityFaultMVA = parseFloat(document.getElementById('utility-fault-mva').value);
                const utilityXRRatio = parseFloat(document.getElementById('utility-xr-ratio').value);

                const transformerKVA = parseFloat(document.getElementById('transformer-kva').value);
                const transformerImpedance = parseFloat(document.getElementById('transformer-impedance').value); // %
                const transformerXRRatio = parseFloat(document.getElementById('transformer-xr-ratio').value);
                const transformerPrimaryConn = document.getElementById('transformer-connection-primary').value;
                const transformerSecondaryConn = document.getElementById('transformer-connection-secondary').value;
                const transformerGroundingImpedance = parseFloat(document.getElementById('transformer-grounding-impedance').value);


                const cableLength = parseFloat(document.getElementById('cable-length').value);
                const cableSize = parseFloat(document.getElementById('cable-size').value);
                const cableMaterial = document.getElementById('cable-material').value;
                const cableXRRatio = parseFloat(document.getElementById('cable-xr-ratio').value);
                const cableTemperature = parseFloat(document.getElementById('cable-temperature').value);

                const motorHP = parseFloat(document.getElementById('motor-hp').value);
                const motorEfficiency = parseFloat(document.getElementById('motor-efficiency').value) / 100; // to pu
                const motorStartingPF = parseFloat(document.getElementById('motor-starting-pf').value);
                const motorSubtransientReactance = parseFloat(document.getElementById('motor-subtransient-reactance').value); // pu


                // Input validation
                if (isNaN(systemVoltage) || isNaN(transformerKVA) || isNaN(transformerImpedance) || isNaN(utilityFaultMVA) || isNaN(cableLength) || isNaN(cableSize) || isNaN(utilityXRRatio) || isNaN(transformerXRRatio) || isNaN(cableXRRatio) || isNaN(cableTemperature) || isNaN(motorHP) || isNaN(motorEfficiency) || isNaN(motorStartingPF) || isNaN(motorSubtransientReactance)) {
                    displayMessage("Please fill in all required fields with valid numbers.", "error");
                    loadingSpinner.style.display = 'none';
                    return;
                }

                if (systemVoltage <= 0 || transformerKVA <= 0 || transformerImpedance <= 0 || transformerImpedance > 20 || cableLength < 0 || cableSize <= 0 || utilityXRRatio <= 0 || transformerXRRatio <= 0 || cableXRRatio <= 0 || cableTemperature < 20 || motorEfficiency <=0) {
                    displayMessage("Please ensure all inputs have valid positive values. Transformer impedance should be between 0.1 and 20.", "error");
                    loadingSpinner.style.display = 'none';
                    return;
                }

                // Clear previous results and detailed calculations/tips
                resultTableBody.innerHTML = '';
                detailedCalculationsDiv.innerHTML = '<h3 class="text-xl font-semibold mb-3 text-gray-700 dark:text-white">Detailed Calculation Steps</h3>'; // Clear and re-add heading
                shortCircuitReductionTipsDiv.style.display = 'none'; // Hide tips initially
                resultContainer.style.display = 'none'; // Hide result container initially


                // --- Per-Unit System Calculation ---
                const baseMVA = transformerKVA / 1000; // Convert transformer kVA to MVA as a system base
                const baseKV = systemVoltage / 1000; // Convert system voltage to kV as a system base
                
                // Step 1: Calculate System Base Impedance ($Z_{base}$)
                // For 3-Phase: $Z_{base} = kV_{LL}^2 / MVA_{base}$
                const Z_base_ohmic = Math.pow(baseKV, 2) / baseMVA;
                addDetailedCalculationStep(
                    "Step 1: Calculate Base Impedance ($Z_{base}$)",
                    `Formula: $Z_{\\text{base}} = \\frac{V_{\\text{base,kV}}^2}{\\text{MVA}_{\\text{base}}}$`,
                    `Calculation: $Z_{\\text{base}} = \\frac{${baseKV.toFixed(3)}^2 \\text{ kV}^2}{${baseMVA.toFixed(3)} \\text{ MVA}} = ${Z_base_ohmic.toExponential(3)} \\Omega$`
                );

                // Step 2: Calculate Utility Impedance in Per Unit (pu)
                let Z1_utility_pu = new Complex(0, 0); // Positive sequence impedance
                let Z0_utility_pu = new Complex(0, 0); // Zero sequence impedance
                let utilityCalcText = "(Assumed infinite bus, $Z_{utility}=0$ for utility fault level of 0 MVA)";

                if (utilityFaultMVA > 0) {
                    const X_utility_pu_mag = baseMVA / utilityFaultMVA; // X component is dominant for utility fault level
                    const R_utility_pu_mag = X_utility_pu_mag / utilityXRRatio;
                    
                    Z1_utility_pu = new Complex(R_utility_pu_mag, X_utility_pu_mag);
                    Z0_utility_pu = new Complex(R_utility_pu_mag, X_utility_pu_mag); // For utility, assume Z0 = Z1 for simplicity unless specific data
                    
                    utilityCalcText = `
                        $X_{\\text{utility,pu}} = \\frac{\\text{Base MVA}}{\\text{Utility Fault MVA}} = \\frac{${baseMVA.toFixed(3)}}{${utilityFaultMVA.toFixed(3)}} = ${X_utility_pu_mag.toFixed(4)}$<br>
                        $R_{\\text{utility,pu}} = \\frac{X_{\\text{utility,pu}}}{\\text{X/R Ratio}} = \\frac{${X_utility_pu_mag.toFixed(4)}}{${utilityXRRatio.toFixed(1)}} = ${R_utility_pu_mag.toFixed(4)}$<br>
                        $Z_{1,utility,pu} = ${Z1_utility_pu.toString(4)}$<br>
                        $Z_{0,utility,pu} \\approx Z_{1,utility,pu} = ${Z0_utility_pu.toString(4)}$
                    `;
                }
                addDetailedCalculationStep(
                    "Step 2: Calculate Utility Impedance in Per Unit ($Z_{utility,pu}$)",
                    `Formula: $X_{\\text{utility,pu}} = \\frac{\\text{Base MVA}}{\\text{Utility Fault MVA}}$, $R_{\\text{utility,pu}} = \\frac{X_{\\text{utility,pu}}}{\\text{X/R Ratio}}$, $Z_{1,utility,pu} = R_{\\text{utility,pu}} + jX_{\\text{utility,pu}}$. Assume $Z_{0,utility,pu} = Z_{1,utility,pu}$ for sources.`,
                    utilityCalcText
                );

                // Step 3: Calculate Transformer Impedance in Per Unit (pu)
                const Z_transformer_pu_mag = transformerImpedance / 100; // Magnitude of impedance
                const angle_rad = Math.atan(transformerXRRatio); // Angle from X/R ratio
                
                const X_transformer_pu = Z_transformer_pu_mag * Math.sin(angle_rad);
                const R_transformer_pu = Z_transformer_pu_mag * Math.cos(angle_rad);
                const Z1_transformer_pu = new Complex(R_transformer_pu, X_transformer_pu); // Positive sequence impedance

                let Z0_transformer_pu;
                let Zg_pu_complex = new Complex(0,0);

                // Transformer Zero Sequence Impedance (Z0) based on connection type
                // Simplified typical values (refer to IEEE/IEC for more exact figures)
                if (transformerPrimaryConn === 'delta' && transformerSecondaryConn === 'wye-grounded') {
                    Z0_transformer_pu = new Complex(R_transformer_pu, X_transformer_pu * 0.9); // Typically Z0 = 0.9*Z1 for Delta-Wye Grounded
                } else if (transformerPrimaryConn === 'wye-grounded' && transformerSecondaryConn === 'wye-grounded') {
                    Z0_transformer_pu = new Complex(R_transformer_pu, X_transformer_pu * 1.0); // Typically Z0 = Z1 for Wye-Wye Grounded
                } else if (transformerPrimaryConn === 'delta' || transformerSecondaryConn === 'delta') {
                    // For Delta connected winding, zero sequence current is trapped, effectively infinite impedance for external faults
                    Z0_transformer_pu = new Complex(1e9, 1e9); // Very high impedance
                } else { // Wye Ungrounded-Wye Ungrounded
                    Z0_transformer_pu = new Complex(1e9, 1e9); // Very high impedance for ungrounded connections without a delta
                }

                // Add external grounding impedance to Z0 if secondary is Wye grounded
                if (transformerSecondaryConn === 'wye-grounded' && transformerGroundingImpedance > 0) {
                    // Convert grounding impedance to per-unit: $Z_{g,pu} = Z_g / Z_{base\_ohmic}$
                    const Zg_ohmic = new Complex(transformerGroundingImpedance, 0); // Assuming pure resistance
                    Zg_pu_complex = Zg_ohmic.divide(new Complex(Z_base_ohmic, 0));
                    Z0_transformer_pu = Z0_transformer_pu.add(Zg_pu_complex.multiply(new Complex(3,0))); // Add 3*Zg for ground path
                }

                addDetailedCalculationStep(
                    "Step 3: Calculate Transformer Impedance in Per Unit ($Z_{transformer,pu}$)",
                    `Formula: $Z_{\\text{transformer,given,pu}} = \\frac{\\text{Transformer Impedance (\\%)}}{100}$<br>
                    $\\text{Angle} = \\arctan(\\text{X/R Ratio})$<br>
                    $R_{\\text{transformer,pu}} = Z_{\\text{transformer,given,pu}} \\cdot \\cos(\\text{Angle})$<br>
                    $X_{\\text{transformer,pu}} = Z_{\\text{transformer,given,pu}} \\cdot \\sin(\\text{Angle})$<br>
                    $Z_{1,transformer,pu} = R_{\\text{transformer,pu}} + jX_{\\text{transformer,pu}}$<br>
                    $Z_{0,transformer,pu}$ varies by connection type. If secondary Wye-grounded with external grounding: $Z_{0,transformer,pu} = Z_{0,transformer,pu} + 3 \\cdot Z_{g,pu}$`,
                    `Calculation: $Z_{\\text{transformer,given,pu}} = \\frac{${transformerImpedance.toFixed(2)}}{100} = ${Z_transformer_pu_mag.toFixed(4)}$<br>
                    Angle = $\\arctan(${transformerXRRatio.toFixed(1)}) = ${angle_rad.toFixed(4)}$ rad<br>
                    $R_{\\text{transformer,pu}} = ${R_transformer_pu.toFixed(4)}$<br>
                    $X_{\\text{transformer,pu}} = ${X_transformer_pu.toFixed(4)}$<br>
                    $Z_{1,transformer,pu} = ${Z1_transformer_pu.toString(4)}$<br>
                    Initial $Z_{0,transformer,pu} = ${Z0_transformer_pu.toString(4)}$ (based on connection)<br>
                    ${transformerGroundingImpedance > 0 ? `$Z_{g,pu} = ${Zg_pu_complex.toString(4)} \\Omega / ${Z_base_ohmic.toExponential(3)} \\Omega = ${Zg_pu_complex.toString(4)}$<br>
                    Final $Z_{0,transformer,pu} = ${Z0_transformer_pu.toString(4)}$ (after grounding consideration)` : ''}
                    `
                );

                // Step 4: Calculate Cable Impedance in Per Unit (pu)
                // Resistivity values (ohm-mm2/m) at 20°C
                const resistivity20C = {
                    copper: 0.0172,
                    aluminum: 0.0282
                };
                // Temperature correction factor for resistance
                const alpha = cableMaterial === 'copper' ? 0.00393 : 0.00403; // Temp coef for Cu and Al
                const R_cable_ohmic_20C = (resistivity20C[cableMaterial] * cableLength) / cableSize;
                const R_cable_ohmic = R_cable_ohmic_20C * (1 + alpha * (cableTemperature - 20));

                const X_cable_ohmic = R_cable_ohmic * cableXRRatio; // Simplified reactance
                
                const Z1_cable_ohmic = new Complex(R_cable_ohmic, X_cable_ohmic);
                const Z1_cable_pu = Z1_cable_ohmic.divide(new Complex(Z_base_ohmic, 0)); // Positive sequence impedance

                // For cables, typically Z0 > Z1 due to sheath/armor effects. Often 3-5 times X1.
                // For simplicity, we use Z0 = 3 * Z1 (common for multi-core cables in non-metallic conduits, etc.)
                // Resistance is also slightly higher for Z0. For simplicity, we assume R0 = R1.
                const Z0_cable_ohmic = new Complex(R_cable_ohmic, X_cable_ohmic * 3); // Z0 typically has higher X component
                const Z0_cable_pu = Z0_cable_ohmic.divide(new Complex(Z_base_ohmic, 0));


                addDetailedCalculationStep(
                    "Step 4: Calculate Cable Impedance in Per Unit ($Z_{cable,pu}$)",
                    `Formula: $R_{\\text{cable,20C}} = \\frac{\\rho_{20C} \\cdot \\text{Length}}{\\text{Area}}$<br>
                    $R_{\\text{cable}} = R_{\\text{cable,20C}} \\cdot (1 + \\alpha \\cdot (T - 20))$<br>
                    $X_{\\text{cable}} = R_{\\text{cable}} \\cdot \\text{X/R Ratio}$<br>
                    $Z_{1,cable,ohmic} = R_{\\text{cable}} + jX_{\\text{cable}}$<br>
                    $Z_{1,cable,pu} = \\frac{Z_{1,cable,ohmic}}{Z_{\\text{base}}}$, $Z_{0,cable,pu} \\approx \\frac{R_{\\text{cable}} + j(3 \\cdot X_{\\text{cable}})}{Z_{\\text{base}}}$ (simplified)`,
                    `Calculation: $R_{\\text{cable,20C}} = \\frac{${resistivity20C[cableMaterial].toFixed(4)} \\cdot ${cableLength.toFixed(1)} \\text{ m}}{${cableSize.toFixed(1)} \\text{ mm}^2} = ${R_cable_ohmic_20C.toFixed(4)} \\Omega$<br>
                    $R_{\\text{cable}} = ${R_cable_ohmic_20C.toFixed(4)} \\cdot (1 + ${alpha.toFixed(5)} \\cdot (${cableTemperature.toFixed(0)} - 20)) = ${R_cable_ohmic.toFixed(4)} \\Omega$<br>
                    $X_{\\text{cable}} = ${R_cable_ohmic.toFixed(4)} \\Omega \\cdot ${cableXRRatio.toFixed(1)} = ${X_cable_ohmic.toFixed(4)} \\Omega$<br>
                    $Z_{1,cable,ohmic} = ${Z1_cable_ohmic.toString(4)} \\Omega$<br>
                    $Z_{1,cable,pu} = ${Z1_cable_pu.toString(4)}$<br>
                    $Z_{0,cable,pu} = ${Z0_cable_pu.toString(4)}$`
                );

                // Step 5: Calculate Motor Contribution Impedance in Per Unit (pu)
                let Z1_motor_pu = new Complex(Infinity, Infinity); // Default to infinite impedance if no motor
                let Z2_motor_pu = new Complex(Infinity, Infinity); // Negative sequence for motors
                let Z0_motor_pu = new Complex(Infinity, Infinity); // Zero sequence for motors
                let motorCalcText = "(No motor contribution)";

                if (motorHP > 0) {
                    const motorKVA = (motorHP * 0.746) / motorEfficiency; // kW to kVA
                    const motorBaseMVA = motorKVA / 1000;

                    // Adjust motor per-unit reactance to system base
                    // X''d on system base: $X''_{d,sys\_base} = X''_{d,motor\_base} \cdot (MVA_{sys\_base} / MVA_{motor\_base})$
                    const Xd_motor_pu = motorSubtransientReactance * (baseMVA / motorBaseMVA);
                    
                    // Approximate motor resistance from starting power factor
                    const R_motor_pu = Xd_motor_pu * Math.tan(Math.acos(motorStartingPF));
                    
                    Z1_motor_pu = new Complex(R_motor_pu, Xd_motor_pu);
                    Z2_motor_pu = new Complex(R_motor_pu, Xd_motor_pu); // For induction motors, Z2 = Z1 (sub-transient)
                    Z0_motor_pu = new Complex(1e12, 1e12); // Induction motors do not contribute to zero sequence current for ground faults

                    motorCalcText = `
                        Motor kVA = ${motorHP.toFixed(0)} HP * 0.746 kW/HP / ${motorEfficiency.toFixed(2)} = ${motorKVA.toFixed(2)} kVA<br>
                        Motor Base MVA = ${motorKVA.toFixed(2)} kVA / 1000 = ${motorBaseMVA.toFixed(3)} MVA<br>
                        $X''_{\\text{d,motor,sys\_base}} = X''_{\\text{d,motor,pu}} \\cdot (\\text{MVA}_{\\text{sys\_base}} / \\text{MVA}_{\\text{motor\_base}}) = ${motorSubtransientReactance.toFixed(2)} \\cdot (${baseMVA.toFixed(3)} / ${motorBaseMVA.toFixed(3)}) = ${Xd_motor_pu.toFixed(4)}$<br>
                        $R_{\\text{motor,pu}} = X''_{\\text{d,motor,sys\_base}} \\cdot \\tan(\\cos^{-1}(\\text{Motor Starting PF})) = ${Xd_motor_pu.toFixed(4)} \\cdot \\tan(\\cos^{-1}(${motorStartingPF.toFixed(2)})) = ${R_motor_pu.toFixed(4)}$<br>
                        $Z_{1,motor,pu} = ${Z1_motor_pu.toString(4)}$<br>
                        $Z_{2,motor,pu} = ${Z2_motor_pu.toString(4)}$<br>
                        $Z_{0,motor,pu} \\approx \\text{infinity}$ (no zero sequence contribution)
                    `;
                }
                addDetailedCalculationStep(
                    "Step 5: Calculate Motor Contribution Impedance in Per Unit ($Z_{motor,pu}$)",
                    `Formula: Convert HP to kVA, then scale motor sub-transient reactance to system base. Calculate motor resistance from starting power factor. $Z_{1,motor,pu} = R_{\\text{motor,pu}} + jX''_{\\text{d,motor,pu}}$. $Z_{2,motor,pu} = Z_{1,motor,pu}$. $Z_{0,motor,pu} = \\infty$.`,
                    motorCalcText
                );

                // Step 6: Total Equivalent Sequence Impedances (pu) from Source Path
                // This is the series impedance of Utility + Transformer + Cable
                const Z1_total_source_path_pu = Z1_utility_pu.add(Z1_transformer_pu).add(Z1_cable_pu);
                const Z2_total_source_path_pu = Z1_total_source_path_pu; // Assume Z2 = Z1 for static components

                let Z0_total_source_path_pu = Z0_utility_pu.add(Z0_transformer_pu).add(Z0_cable_pu); // Sum of zero sequence impedances

                // Special handling for open zero sequence paths (e.g., Delta primary/secondary)
                // If a delta connection prevents zero sequence current flow, the Z0 path is infinite.
                // We've already set Z0 to a high value if the transformer connection implies an open path.
                // This ensures calculations don't result in NaN from 1/0 but rather approach 0 current.

                addDetailedCalculationStep(
                    "Step 6: Calculate Total Equivalent Sequence Impedances (Source Path) ($Z_{total,source,pu}$)",
                    `Formula: $Z_{1,total,source,pu} = Z_{1,utility,pu} + Z_{1,transformer,pu} + Z_{1,cable,pu}$<br>
                    $Z_{2,total,source,pu} = Z_{1,total,source,pu}$ (for passive components)<br>
                    $Z_{0,total,source,pu} = Z_{0,utility,pu} + Z_{0,transformer,pu} + Z_{0,cable,pu}$ (adjusted for grounding and connection type)`,
                    `Calculation: <br>
                    $Z_{1,total,source,pu} = ${Z1_total_source_path_pu.toString(4)}$<br>
                    $Z_{2,total,source,pu} = ${Z2_total_source_path_pu.toString(4)}$<br>
                    $Z_{0,total,source,pu} = ${Z0_total_source_path_pu.toString(4)}$`
                );

                // Base current for fault calculations
                const I_base = (baseMVA * 1000) / (Math.sqrt(3) * baseKV); // Amps (kVA / sqrt(3) * kV)
                addDetailedCalculationStep(
                    "Step 7: Calculate Base Current ($I_{base}$)",
                    `Formula: $I_{\\text{base}} = \\frac{\\text{MVA}_{\\text{base}} \\cdot 10^3}{\\sqrt{3} \\cdot V_{\\text{base,kV}}}$`,
                    `Calculation: $I_{\\text{base}} = \\frac{${baseMVA.toFixed(3)} \\cdot 10^3 \\text{ kVA}}{\\sqrt{3} \\cdot ${baseKV.toFixed(3)} \\text{ kV}} = ${I_base.toFixed(2)} \\text{ A}$`
                );

                let faultCurrent = 0; // For 3PH
                let faultCurrentSLG = 0;
                let faultCurrentLL = 0;
                let faultCurrentDLG = 0;
                let calculationDetails = '';

                // Step 8: Calculate Short Circuit Current based on Fault Type (using complex impedances)
                if (faultType === 'three-phase-symmetrical') {
                    // For 3-phase symmetrical fault, only positive sequence impedance is considered.
                    if (Z1_total_source_path_pu.magnitude() === 0) {
                        displayMessage("Total positive sequence impedance is zero, indicating an infinite fault current. Please check inputs.", "error");
                        loadingSpinner.style.display = 'none';
                        return;
                    }
                    // Motor contribution is added directly for symmetrical faults at the bus.
                    const Z1_total_pu_with_motor = Z1_total_source_path_pu.multiply(Z1_motor_pu).divide(Z1_total_source_path_pu.add(Z1_motor_pu)); // Parallel connection
                    
                    // If motor HP is 0, Z1_motor_pu will be infinite, making Z1_total_pu_with_motor effectively Z1_total_source_path_pu
                    let effective_Z1_pu = Z1_total_source_path_pu;
                    let parallel_calc_text = "";
                    if (motorHP > 0) {
                         effective_Z1_pu = Z1_total_source_path_pu.multiply(Z1_motor_pu).divide(Z1_total_source_path_pu.add(Z1_motor_pu)); // Parallel connection
                         parallel_calc_text = `(This is $Z_{1,source,pu}$ in parallel with $Z_{1,motor,pu}$ if motors are present).<br>
                         $Z_{1,effective,pu} = Z_{1,total,source,pu} || Z_{1,motor,pu} = \\frac{(${Z1_total_source_path_pu.toString(4)}) \\cdot (${Z1_motor_pu.toString(4)})}{(${Z1_total_source_path_pu.toString(4)}) + (${Z1_motor_pu.toString(4)})} = ${effective_Z1_pu.toString(4)}$`;
                    }
                    
                    faultCurrent = I_base / effective_Z1_pu.magnitude(); // Magnitude of current
                    calculationDetails = `
                        Total effective positive sequence impedance ($Z_{1,effective,pu}$) to fault point: ${effective_Z1_pu.toString(4)} pu ${parallel_calc_text}<br>
                        $I_{\\text{3PH}} = \\frac{I_{\\text{base}}}{|Z_{1,effective,pu}|}$<br>
                        $I_{\\text{3PH}} = \\frac{${I_base.toFixed(2)} \\text{ A}}{${effective_Z1_pu.magnitude().toFixed(4)}} = ${faultCurrent.toFixed(2)} \\text{ A}$
                    `;
                    addDetailedCalculationStep("Step 8: Calculate Three-Phase Symmetrical Fault Current ($I_{3PH}$)", `Formula: $I_{3PH} = \\frac{I_{\\text{base}}}{|Z_{1,effective,pu}|}$ where $Z_{1,effective,pu}$ is $Z_{1,total,source,pu}$ in parallel with $Z_{1,motor,pu}$.`, calculationDetails);

                } else if (faultType === 'single-line-to-ground') {
                    // SLG Fault: $I_{SLG} = \frac{3 \cdot V_{phase}}{Z_1 + Z_2 + Z_0 + 3Z_f}$
                    // Assuming $Z_f = 0$ (fault impedance is zero)
                    // No motor contribution to SLG zero sequence current
                    const Z_sum_pu = Z1_total_source_path_pu.add(Z2_total_source_path_pu).add(Z0_total_source_path_pu);
                    if (Z_sum_pu.magnitude() === 0) {
                        displayMessage("Total sequence impedance for SLG fault is zero, indicating an infinite fault current. Please check inputs.", "error");
                        loadingSpinner.style.display = 'none';
                        return;
                    }
                    faultCurrentSLG = (new Complex(3,0).multiply(new Complex(I_base, 0))).divide(Z_sum_pu).magnitude();
                    calculationDetails = `
                        $Z_{\\text{sum,pu}} = Z_{1,total,source,pu} + Z_{2,total,source,pu} + Z_{0,total,source,pu}$<br>
                        $Z_{\\text{sum,pu}} = (${Z1_total_source_path_pu.toString(4)}) + (${Z2_total_source_path_pu.toString(4)}) + (${Z0_total_source_path_pu.toString(4)}) = ${Z_sum_pu.toString(4)}$<br>
                        $I_{\\text{SLG}} = \\frac{3 \\cdot I_{\\text{base}}}{|Z_{\\text{sum,pu}}|}$<br>
                        $I_{\\text{SLG}} = \\frac{3 \\cdot ${I_base.toFixed(2)} \\text{ A}}{${Z_sum_pu.magnitude().toFixed(4)}} = ${faultCurrentSLG.toFixed(2)} \\text{ A}$
                    `;
                    addDetailedCalculationStep("Step 8: Calculate Single-Line-to-Ground Fault Current ($I_{SLG}$)", `Formula: $I_{SLG} = \\frac{3 \\cdot I_{\\text{base}}}{|Z_1 + Z_2 + Z_0|}$`, calculationDetails);

                } else if (faultType === 'line-to-line') {
                    // LL Fault: $I_{LL} = \frac{\sqrt{3} \cdot V_{phase}}{Z_1 + Z_2}$
                    const Z_sum_pu = Z1_total_source_path_pu.add(Z2_total_source_path_pu);
                     if (Z_sum_pu.magnitude() === 0) {
                        displayMessage("Total sequence impedance for LL fault is zero, indicating an infinite fault current. Please check inputs.", "error");
                        loadingSpinner.style.display = 'none';
                        return;
                    }
                    faultCurrentLL = (new Complex(Math.sqrt(3),0).multiply(new Complex(I_base, 0))).divide(Z_sum_pu).magnitude();
                    calculationDetails = `
                        $Z_{\\text{sum,pu}} = Z_{1,total,source,pu} + Z_{2,total,source,pu}$<br>
                        $Z_{\\text{sum,pu}} = (${Z1_total_source_path_pu.toString(4)}) + (${Z2_total_source_path_pu.toString(4)}) = ${Z_sum_pu.toString(4)}$<br>
                        $I_{\\text{LL}} = \\frac{\\sqrt{3} \\cdot I_{\\text{base}}}{|Z_{\\text{sum,pu}}|}$<br>
                        $I_{\\text{LL}} = \\frac{\\sqrt{3} \\cdot ${I_base.toFixed(2)} \\text{ A}}{${Z_sum_pu.magnitude().toFixed(4)}} = ${faultCurrentLL.toFixed(2)} \\text{ A}$
                    `;
                    addDetailedCalculationStep("Step 8: Calculate Line-to-Line Fault Current ($I_{LL}$)", `Formula: $I_{LL} = \\frac{\\sqrt{3} \\cdot I_{\\text{base}}}{|Z_1 + Z_2|}$`, calculationDetails);

                } else if (faultType === 'double-line-to-ground') {
                    // DLG Fault: $I_{DLG} = 3 \cdot I_{a1}$ where $I_{a1} = \frac{V_{phase}}{(Z_1 + \frac{Z_2 Z_0}{Z_2 + Z_0})}$
                    // Assuming $V_{phase}$ is 1 pu (since we use I_base)
                    const Z_parallel_Z2_Z0 = Z2_total_source_path_pu.multiply(Z0_total_source_path_pu).divide(Z2_total_source_path_pu.add(Z0_total_source_path_pu));
                    const Z_denominator_pu = Z1_total_source_path_pu.add(Z_parallel_Z2_Z0);
                    
                    if (Z_denominator_pu.magnitude() === 0 || isNaN(Z_denominator_pu.magnitude())) { // Check for NaN from Z2+Z0=0
                        displayMessage("Total sequence impedance for DLG fault is zero or undefined, indicating an infinite fault current. Please check inputs.", "error");
                        loadingSpinner.style.display = 'none';
                        return;
                    }
                    const I_a1_pu = (new Complex(1,0)).divide(Z_denominator_pu); // Per-unit positive sequence current component
                    faultCurrentDLG = (new Complex(3,0).multiply(I_a1_pu).multiply(new Complex(I_base, 0))).magnitude(); // Convert from pu current to actual amps

                    calculationDetails = `
                        $Z_{\\text{parallel,Z2Z0,pu}} = \\frac{Z_{2,total,source,pu} \\cdot Z_{0,total,source,pu}}{Z_{2,total,source,pu} + Z_{0,total,source,pu}} = \\frac{(${Z2_total_source_path_pu.toString(4)}) \\cdot (${Z0_total_source_path_pu.toString(4)})}{(${Z2_total_source_path_pu.toString(4)}) + (${Z0_total_source_path_pu.toString(4)})} = ${Z_parallel_Z2_Z0.toString(4)}$<br>
                        $Z_{\\text{denominator,pu}} = Z_{1,total,source,pu} + Z_{\\text{parallel,Z2Z0,pu}} = (${Z1_total_source_path_pu.toString(4)}) + (${Z_parallel_Z2_Z0.toString(4)}) = ${Z_denominator_pu.toString(4)}$<br>
                        $I_{\\text{a1,pu}} = \\frac{1}{Z_{\\text{denominator,pu}}} = \\frac{1}{${Z_denominator_pu.toString(4)}} = ${I_a1_pu.toString(4)}$<br>
                        $I_{\\text{DLG}} = |3 \\cdot I_{\\text{a1,pu}} \\cdot I_{\\text{base}}| = |3 \\cdot (${I_a1_pu.toString(4)}) \\cdot ${I_base.toFixed(2)} \\text{ A}| = ${faultCurrentDLG.toFixed(2)} \\text{ A}$
                    `;
                    addDetailedCalculationStep("Step 8: Calculate Double-Line-to-Ground Fault Current ($I_{DLG}$)", `Formula: $I_{DLG} = |3 \\cdot I_{\\text{base}} \\cdot \\frac{1}{Z_1 + \\frac{Z_2 Z_0}{Z_2 + Z_0}}|$`, calculationDetails);
                }

                // Display Summary results
                addResultRow("System Voltage", systemVoltage.toFixed(2) + " V");
                addResultRow("Fault Type", faultType.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ')); // Format text
                addResultRow("Transformer Rating", transformerKVA.toFixed(2) + " kVA");
                addResultRow("Transformer Impedance", transformerImpedance.toFixed(2) + " %");
                addResultRow("Utility Fault Level", utilityFaultMVA.toFixed(2) + " MVA");
                addResultRow("Cable Length", cableLength.toFixed(2) + " m");
                addResultRow("Cable Size", cableSize.toFixed(2) + " mm\u00B2");
                addResultRow("Cable Material", cableMaterial.charAt(0).toUpperCase() + cableMaterial.slice(1));
                addResultRow("Motor Total HP", motorHP.toFixed(0) + " HP");
                
                // Display specific fault current
                let finalFaultCurrentDisplay = '';
                if (faultType === 'three-phase-symmetrical') {
                    finalFaultCurrentDisplay = faultCurrent.toFixed(2) + " A";
                    addResultRow("Calculated Three-Phase Symmetrical Fault Current", finalFaultCurrentDisplay);
                } else if (faultType === 'single-line-to-ground') {
                    finalFaultCurrentDisplay = faultCurrentSLG.toFixed(2) + " A";
                    addResultRow("Calculated Single-Line-to-Ground Fault Current", finalFaultCurrentDisplay);
                } else if (faultType === 'line-to-line') {
                    finalFaultCurrentDisplay = faultCurrentLL.toFixed(2) + " A";
                    addResultRow("Calculated Line-to-Line Fault Current", finalFaultCurrentDisplay);
                } else if (faultType === 'double-line-to-ground') {
                    finalFaultCurrentDisplay = faultCurrentDLG.toFixed(2) + " A";
                    addResultRow("Calculated Double-Line-to-Ground Fault Current", finalFaultCurrentDisplay);
                }

                // Hide loading spinner and show results with animation
                loadingSpinner.style.display = 'none';
                resultContainer.style.display = 'block';
                resultContainer.classList.add('show');
                shortCircuitReductionTipsDiv.style.display = 'block';
                resultContainer.scrollIntoView({ behavior: 'smooth' }); // Scroll to results

                // IMPORTANT: Tell MathJax to re-render the newly added content after a small delay
                if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
                    setTimeout(() => {
                        window.MathJax.typesetPromise([detailedCalculationsDiv]);
                    }, 50); 
                }
            });

            // Function to display messages (replaces alert())
            function displayMessage(message, type = "info") {
                let messageBox = document.getElementById('custom-message-box');
                if (!messageBox) {
                    messageBox = document.createElement('div');
                    messageBox.id = 'custom-message-box';
                    messageBox.style.cssText = `
                        position: fixed;
                        top: 20px;
                        left: 50%;
                        transform: translateX(-50%);
                        padding: 15px 25px;
                        border-radius: 8px;
                        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
                        z-index: 1000;
                        font-weight: bold;
                        color: white;
                        opacity: 0;
                        transition: opacity 0.5s ease-in-out;
                    `;
                    document.body.appendChild(messageBox);
                }

                messageBox.textContent = message;
                if (type === "error") {
                    messageBox.style.backgroundColor = '#dc3545'; /* Red */
                } else if (type === "warning") {
                    messageBox.style.backgroundColor = '#ffc107'; /* Amber */
                    messageBox.style.color = '#333';
                } else {
                    messageBox.style.backgroundColor = '#28a745'; /* Green */
                }
                messageBox.style.opacity = 1;

                // Hide after 5 seconds
                setTimeout(() => {
                    messageBox.style.opacity = 0;
                }, 5000);
            }

            // Helper function to add a row to the summary result table
            function addResultRow(parameter, value) {
                const row = document.createElement('tr');
                
                const paramCell = document.createElement('td');
                paramCell.textContent = parameter;
                paramCell.classList.add('font-medium');
                
                const valueCell = document.createElement('td');
                valueCell.textContent = value;
                
                row.appendChild(paramCell);
                row.appendChild(valueCell);
                
                resultTableBody.appendChild(row);
            }

            // Helper function to add a detailed calculation step
            function addDetailedCalculationStep(stepTitle, formulaText, calculationText) {
                const stepDiv = document.createElement('div');
                stepDiv.classList.add('calculation-step');

                const titleElem = document.createElement('h4');
                titleElem.textContent = stepTitle;
                stepDiv.appendChild(titleElem);

                if (formulaText) {
                    const formulaElem = document.createElement('p');
                    formulaElem.innerHTML = formulaText; 
                    stepDiv.appendChild(formulaElem);
                }

                if (calculationText) {
                    const calcElem = document.createElement('p');
                    calcElem.innerHTML = calculationText; // Use innerHTML to allow MathJax to process
                    stepDiv.appendChild(calcElem);
                }
                detailedCalculationsDiv.appendChild(stepDiv);
            }
        });
    </script>
</body>

</html>

