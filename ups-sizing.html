<!DOCTYPE html>
<html lang="en">
<head>
                <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-23Y1V450SR"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-23Y1V450SR');     
</script>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5936527763614780"
     crossorigin="anonymous"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Industrial UPS Sizing Calculator - Design Calculators - Electrical</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- MathJax for LaTeX rendering -->
    <script type="text/javascript" id="MathJax-script" async
      src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
    </script>
    <style>
        /* Basic CSS Variables for a consistent theme */
        :root {
            --primary-color: #4CAF50; /* Green */
            --secondary-color: #45a049; /* Darker Green */
            --accent-color: #FFC107; /* Amber */
            --bg-color: #f4f7f6; /* Light Greyish Green */
            --card-bg: #ffffff; /* White */
            --text-color: #333333; /* Dark Grey */
            --header-bg: #2C3E50; /* Dark Blue Grey */
            --footer-bg: #34495E; /* Slightly Lighter Dark Blue Grey */
            --border-color: #cccccc;
            --card-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            --hover-color: #e2e6ea;
        }

        /* Dark Mode Variables */
        body.dark-mode {
            --bg-color: #2c3e50;
            --card-bg: #34495e;
            --text-color: #ecf0f1;
            --header-bg: #2c3e50;
            --footer-bg: #2c3e50;
            --border-color: #555555;
            --card-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            --hover-color: #446688;
        }

        /* General Body Styling */
        body {
            font-family: 'Inter', sans-serif; /* Using Inter as specified */
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 960px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: var(--header-bg);
            color: white;
            padding: 20px 0;
            text-align: center;
            box-shadow: var(--card-shadow);
            position: relative; /* For theme toggle positioning */
        }

        header h1 {
            margin: 0;
            font-size: 2.5em;
            color: var(--primary-color);
        }

        header .subtitle {
            margin: 5px 0 0;
            font-size: 1em;
            color: #bdc3c7;
        }

        main {
            padding: 20px 0;
        }

        .tool-container {
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 20px;
            box-shadow: var(--card-shadow);
            margin-bottom: 20px;
        }

        .tool-container h2 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            margin-top: 0;
            margin-bottom: 20px;
        }

        .tool-description {
            margin-bottom: 20px;
            color: var(--text-color);
        }

        .back-button {
            display: inline-block;
            background-color: var(--primary-color);
            color: white;
            padding: 10px 15px;
            border-radius: 4px;
            text-decoration: none;
            margin-bottom: 20px;
            transition: background-color 0.3s;
        }

        .back-button:hover {
            background-color: var(--secondary-color);
        }

        /* Theme Toggle */
        .theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
        }

        .theme-toggle .light-icon,
        .theme-toggle .dark-icon {
            color: white;
            margin: 0 5px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
        }

        input:checked + .slider {
            background-color: var(--primary-color);
        }

        input:focus + .slider {
            box-shadow: 0 0 1px var(--primary-color);
        }

        input:checked + .slider:before {
            -webkit-transform: translateX(26px);
            -ms-transform: translateX(26px);
            transform: translateX(26px);
        }

        /* Rounded sliders */
        .slider.round {
            border-radius: 34px;
        }

        .slider.round:before {
            border-radius: 50%;
        }

        /* Footer Styling */
        footer {
            background-color: var(--footer-bg);
            color: white;
            padding: 20px 0;
            text-align: center;
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1);
            margin-top: 30px;
        }

        footer .disclaimer h3,
        footer .social-share h3 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        footer .disclaimer p {
            font-size: 0.9em;
            color: #bdc3c7;
        }

        .social-buttons {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .social-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            color: white;
            text-decoration: none;
            font-size: 1.2em;
            transition: transform 0.3s ease-in-out;
        }

        .social-btn:hover {
            transform: translateY(-3px);
        }

        .social-btn.linkedin { background-color: #0A66C2; }
        .social-btn.facebook { background-color: #1877F2; }
        .social-btn.twitter { background-color: #1DA1F2; }
        .social-btn.whatsapp { background-color: #25D366; }
        .social-btn.reddit { background-color: #FF4500; }

        /* Styles for Calculator Forms and Results */
        .calculator-form {
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: var(--card-shadow);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        
        .form-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .form-row .form-group {
            flex: 1 1 200px;
        }
        
        .calculate-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin-top: 10px;
            transition: background-color 0.3s;
        }
        
        .calculate-btn:hover {
            background-color: var(--secondary-color);
        }
        
        .result-container {
            margin-top: 30px;
            padding: 20px;
            border-radius: 8px;
            background-color: var(--card-bg);
            box-shadow: var(--card-shadow);
            display: none; /* Hidden by default */
        }
        
        .result-container h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        
    .result-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .result-table th, .result-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        .result-table th {
            background-color: var(--hover-color);
        }
        
        .standard-reference {
            margin-top: 20px;
            font-style: italic;
            font-size: 0.9rem;
        }
        
        .info-icon {
            color: var(--primary-color);
            margin-left: 5px;
            cursor: help;
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* Custom message box style */
        #custom-message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            font-weight: bold;
            color: white;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        /* Styles for calculation details */
        #calculation-details {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 0.95em;
        }
        #calculation-details h4 {
            color: var(--secondary-color);
            margin-top: 0;
            margin-bottom: 10px;
        }
        #calculation-details p.formula {
            font-family: 'Times New Roman', serif; /* A font suitable for mathematical formulas */
            font-style: italic;
            font-size: 1.1em;
            text-align: center;
            padding: 10px 0;
            background-color: var(--hover-color);
            border-radius: 4px;
            margin: 10px 0;
            overflow-x: auto; /* Allow horizontal scrolling for long formulas */
        }
        #calculation-details p.calculation-step {
            font-family: 'Courier New', monospace; /* Monospace for steps */
            background-color: var(--hover-color);
            padding: 5px 10px;
            border-radius: 3px;
            margin-bottom: 5px;
        }
        #calculation-details ul {
            list-style-type: disc;
            margin-left: 20px;
            padding-left: 0;
        }
        #calculation-details ul li {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>Design Calculators - Electrical</h1>
            <p class="subtitle">Electrical Calculations Made Easy — Learn with Every Step</p>
            <div class="theme-toggle">
                <span class="light-icon"><i class="fas fa-sun"></i></span>
                <label class="switch">
                    <input type="checkbox" id="theme-switch">
                    <span class="slider round"></span>
                </label>
                <span class="dark-icon"><i class="fas fa-moon"></i></span>
            </div>
        </div>
    </header>

    <main class="container">
        <a href="indexEle.html" class="back-button"><i class="fas fa-arrow-left"></i> Back to Tools</a>
        
        <div class="tool-container">
            <h2>Industrial UPS Sizing Calculator</h2>
            
            <div class="tool-description">
                <p>Calculate the appropriate UPS capacity for industrial applications based on connected loads, power factors, and required backup time. This tool helps in selecting the right UPS system for your industrial needs.</p>
            </div>
            
            <div class="calculator-form">
                <form id="ups-sizing-form">
                    <div class="section-title">1. System Parameters</div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="system-voltage">System Voltage (V) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Nominal voltage of the system</span></span></label>
                            <select id="system-voltage" required>
                                <option value="220">220V (Single Phase)</option>
                                <option value="230">230V (Single Phase)</option>
                                <option value="240">240V (Single Phase)</option>
                                <option value="380">380V (Three Phase)</option>
                                <option value="400">400V (Three Phase)</option>
                                <option value="415">415V (Three Phase)</option>
                                <option value="480">480V (Three Phase)</option>
                                <option value="600">600V (Three Phase)</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>
                        <div class="form-group" id="custom-voltage-group" style="display: none;">
                            <label for="custom-voltage">Custom Voltage (V)</label>
                            <input type="number" id="custom-voltage" min="1" step="1">
                        </div>
                        <div class="form-group">
                            <label for="phase-type">System Type <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Single-phase or three-phase system</span></span></label>
                            <select id="phase-type" required>
                                <option value="single">Single-Phase</option>
                                <option value="three">Three-Phase</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="backup-time">Required Backup Time (minutes) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">How long the UPS should provide power during an outage</span></span></label>
                            <input type="number" id="backup-time" min="1" step="1" value="30" required>
                        </div>
                        <div class="form-group">
                            <label for="future-expansion">Future Expansion Factor (%) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Additional capacity for future growth</span></span></label>
                            <input type="number" id="future-expansion" min="0" max="100" step="5" value="25" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="ups-efficiency">UPS Efficiency (%) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Efficiency of the UPS system</span></span></label>
                            <input type="number" id="ups-efficiency" min="70" max="99" step="1" value="92" required>
                        </div>
                        <div class="form-group">
                            <label for="ups-type">UPS Technology <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Type of UPS technology</span></span></label>
                            <select id="ups-type" required>
                                <option value="online">Online/Double Conversion</option>
                                <option value="line-interactive">Line Interactive</option>
                                <option value="standby">Standby/Offline</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="dc-bus-voltage">UPS DC Bus Voltage (V) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The DC voltage of the UPS internal battery bus (e.g., 240V, 384V, 480V)</span></span></label>
                            <input type="number" id="dc-bus-voltage" min="12" step="12" value="384" required>
                        </div>
                         <div class="form-group">
                            <label for="battery-type">Battery Type <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Chemistry of the batteries. Affects unit voltage, efficiency, and depth of discharge.</span></span></label>
                            <select id="battery-type" required>
                                <option value="VRLA/LA">VRLA/LA (2V Cells)</option>
                                <option value="Ni-Cd">Ni-Cd (1.2V Cells)</option>
                                <option value="SMF">SMF (12V Blocks)</option>
                                <option value="Li-ion">Li-ion (48V Modules)</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Nominal Battery Unit Ah input removed as per user request -->
                    
                    <div class="section-title">2. Load Details</div>
                    
                    <div id="loads-container">
                        <div class="load-item" data-load-id="1">
                            <div class="load-item-header">
                                <div class="load-item-title">Load #1</div>
                                <button type="button" class="remove-load-btn" style="visibility: hidden;"><i class="fas fa-trash"></i> Remove</button>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="load-name-1">Load Description</label>
                                    <input type="text" id="load-name-1" placeholder="e.g., Motors, Servers, PLC">
                                </div>
                                <div class="form-group">
                                    <label for="load-type-1">Load Type</label>
                                    <select id="load-type-1" required>
                                        <option value="resistive">Resistive (Heaters, Lighting)</option>
                                        <option value="motor">Motors & Drives</option>
                                        <option value="electronic">Electronic Equipment</option>
                                        <option value="capacitive">Capacitive Loads</option>
                                        <option value="mixed">Mixed Loads</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="load-power-1">Power Rating <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Power consumption of the load</span></span></label>
                                    <input type="number" id="load-power-1" min="0" step="0.1" required>
                                </div>
                                <div class="form-group">
                                    <label for="power-unit-1">Unit</label>
                                    <select id="power-unit-1" required>
                                        <option value="kW">kW</option>
                                        <option value="kVA">kVA</option>
                                        <option value="W">W</option>
                                        <option value="VA">VA</option>
                                        <option value="A">A (Amps)</option>
                                        <option value="HP">HP (Horsepower)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="power-factor-1">Power Factor <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Power factor of the load</span></span></label>
                                    <input type="number" id="power-factor-1" min="0.1" max="1" step="0.01" value="0.8" required>
                                </div>
                                <div class="form-group">
                                    <label for="starting-factor-1">Starting Factor <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Inrush current multiplier for motors (e.g., 6 for direct-on-line start)</span></span></label>
                                    <input type="number" id="starting-factor-1" min="1" max="10" step="0.1" value="1" required>
                                </div>
                            </div>

                             <div class="form-row">
                                <div class="form-group">
                                    <label for="crest-factor-1">Crest Factor <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Ratio of peak current to RMS current (typically 1.41 for linear, 2-3 for non-linear)</span></span></label>
                                    <input type="number" id="crest-factor-1" min="1" max="5" step="0.01" value="1.41" required>
                                </div>
                                <div class="form-group">
                                    <label for="duty-cycle-1">Duty Cycle (%) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Percentage of time the load is active</span></span></label>
                                    <input type="number" id="duty-cycle-1" min="1" max="100" step="1" value="100" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="quantity-1">Quantity</label>
                                    <input type="number" id="quantity-1" min="1" step="1" value="1" required>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button type="button" id="add-load-btn" class="add-load-btn"><i class="fas fa-plus"></i> Add Another Load</button>
                    
                    <div class="section-title">3. Environmental Factors</div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="ambient-temp">Ambient Temperature (°C) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Operating temperature of the environment</span></span></label>
                            <input type="number" id="ambient-temp" min="0" max="50" step="1" value="25" required>
                        </div>
                        <div class="form-group">
                            <label for="altitude">Altitude (meters) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Installation altitude above sea level</span></span></label>
                            <input type="number" id="altitude" min="0" step="100" value="0" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="environment-type">Environment Type <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Type of installation environment</span></span></label>
                            <select id="environment-type" required>
                                <option value="clean">Clean/Office Environment</option>
                                <option value="industrial">Industrial Environment</option>
                                <option value="harsh">Harsh Environment (Dust/Humidity)</option>
                                <option value="outdoor">Outdoor Installation</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="redundancy">Redundancy Configuration <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Redundancy level for critical applications</span></span></label>
                            <select id="redundancy" required>
                                <option value="n">N (Single UPS)</option>
                                <option value="n+1">N+1 Redundancy</option>
                                <option value="2n">2N Redundancy</option>
                                <option value="2n+1">2N+1 Redundancy</option>
                            </select>
                        </div>
                    </div>
                    
                    <button type="button" id="calculate-btn" class="calculate-btn">Calculate UPS Size</button>
                </form>
            </div>
            
            <div id="result-container" class="result-container">
                <h3>UPS Sizing Results</h3>
                <div id="calculation-details">
                    <!-- Calculation steps will be inserted here -->
                </div>
                <div id="load-details-summary">
                    <!-- Load details summary will be inserted here -->
                </div>
                <table class="result-table">
                    <thead>
                        <tr>
                            <th>Parameter</th>
                            <th>Value</th>
                        </tr>
                    </thead>
                    <tbody id="result-table-body">
                    </tbody>
                </table>
                
                <div class="recommendation" id="recommendation">
                    <h4>Recommended UPS Configuration</h4>
                    <div id="recommendation-content"></div>
                </div>
                
                <div class="standard-reference" id="standard-reference">
                    Calculations based on IEEE 1100-2005 (Emerald Book) and industry best practices for UPS sizing.
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <div class="disclaimer">
                
                <p>Disclaimer: Always verify calculation results against applicable engineering standards and guidelines.</p>
            </div>
            <div class="credit">
                <p>Created by A Sharma</p>
                <p>&copy; 2025 Design Calculators</p>
            </div>
            <div class="social-share">
                <h3>Share This Site</h3>
                <div class="social-buttons">
                    <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://designcalculators.co.in&title=Design Calculators" target="_blank" class="social-btn linkedin">
                        <i class="fab fa-linkedin"></i>
                    </a>
                    <a href="https://www.facebook.com/sharer/sharer.php?u=https://designcalculators.co.in" target="_blank" class="social-btn facebook">
                        <i class="fab fa-facebook"></i>
                    </a>
                    <a href="https://twitter.com/intent/tweet?text=Check out this amazing Design Calculators!&url=https://designcalculators.co.in" target="_blank" class="social-btn twitter">
                        <i class="fab fa-twitter"></i>
                    </a>
                    <a href="https://api.whatsapp.com/send?text=Check out this amazing Design Calculators! https://designcalculators.co.in" target="_blank" class="social-btn whatsapp">
                        <i class="fab fa-whatsapp"></i>
                    </a>
                    <a href="https://www.reddit.com/submit?url=https://designcalculators.co.in&title=Design Calculators" target="_blank" class="social-btn reddit">
                        <i class="fab fa-reddit"></i>
                    </a>
                </div>
            </div>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const calculateBtn = document.getElementById('calculate-btn');
            const addLoadBtn = document.getElementById('add-load-btn');
            const loadsContainer = document.getElementById('loads-container');
            const resultContainer = document.getElementById('result-container');
            const resultTableBody = document.getElementById('result-table-body');
            const recommendationContent = document.getElementById('recommendation-content');
            const calculationDetailsDiv = document.getElementById('calculation-details'); 
            const loadDetailsSummaryDiv = document.getElementById('load-details-summary'); 
            
            // Custom message box function (replaces alert)
            function displayMessage(message, type = "info") {
                let messageBox = document.getElementById('custom-message-box');
                if (!messageBox) {
                    messageBox = document.createElement('div');
                    messageBox.id = 'custom-message-box';
                    messageBox.style.cssText = `
                        position: fixed;
                        top: 20px;
                        left: 50%;
                        transform: translateX(-50%);
                        padding: 15px 25px;
                        border-radius: 8px;
                        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
                        z-index: 1000;
                        font-weight: bold;
                        color: white;
                        opacity: 0;
                        transition: opacity 0.5s ease-in-out;
                    `;
                    document.body.appendChild(messageBox);
                }

                messageBox.textContent = message;
                if (type === "error") {
                    messageBox.style.backgroundColor = '#dc3545'; /* Red */
                } else if (type === "warning") {
                    messageBox.style.backgroundColor = '#ffc107'; /* Amber */
                    messageBox.style.color = '#333';
                } else {
                    messageBox.style.backgroundColor = '#28a745'; /* Green */
                }
                messageBox.style.opacity = 1;

                // Hide after 5 seconds
                setTimeout(() => {
                    messageBox.style.opacity = 0;
                }, 5000);
            }

            // Show/hide custom voltage field
            document.getElementById('system-voltage').addEventListener('change', function() {
                const customVoltageGroup = document.getElementById('custom-voltage-group');
                if (this.value === 'custom') {
                    customVoltageGroup.style.display = 'block';
                } else {
                    customVoltageGroup.style.display = 'none';
                }
            });
            
            // Battery type parameters including typical nominal Ah for parallel string calculation and charging C-rate
            const batteryTypes = {
                'VRLA/LA': { unitVoltage: 2, eff: 0.85, dod: 0.5, chargingCRate: 0.1, nominalAhTypical: 200 }, // 10% C-rate, typical 2V cell is often 200Ah
                'Ni-Cd': { unitVoltage: 1.2, eff: 0.75, dod: 0.8, chargingCRate: 0.2, nominalAhTypical: 100 }, // 20% C-rate as per user for high, typical 1.2V cell 100Ah
                'SMF': { unitVoltage: 12, eff: 0.85, dod: 0.6, chargingCRate: 0.1, nominalAhTypical: 100 }, // 10% C-rate, typical 12V block is 100Ah
                'Li-ion': { unitVoltage: 48, eff: 0.95, dod: 0.9, chargingCRate: 0.2, nominalAhTypical: 50 } // 20% C-rate, typical 48V module might be 50Ah
            };

            // Update starting factor and crest factor based on load type
            function updateLoadSpecificFactors(loadTypeId, startingFactorId, crestFactorId) {
                const loadType = document.getElementById(loadTypeId);
                const startingFactor = document.getElementById(startingFactorId);
                const crestFactor = document.getElementById(crestFactorId);
                
                loadType.addEventListener('change', function() {
                    switch(this.value) {
                        case 'motor':
                            startingFactor.value = '6';
                            crestFactor.value = '1.41'; // Motors typically have linear current
                            break;
                        case 'electronic':
                            startingFactor.value = '1.5'; // Small inrush for power supplies
                            crestFactor.value = '2.5'; // High crest factor for switch-mode power supplies
                            break;
                        case 'capacitive':
                            startingFactor.value = '2';
                            crestFactor.value = '1.41'; // Can be linear, but surge is the main concern
                            break;
                        case 'resistive':
                            startingFactor.value = '1';
                            crestFactor.value = '1.41'; // Purely resistive loads are linear
                            break;
                        case 'mixed':
                            startingFactor.value = '1.5'; // Default for mixed
                            crestFactor.value = '1.8'; // Default for mixed
                            break;
                        default:
                            startingFactor.value = '1';
                            crestFactor.value = '1.41';
                    }
                });
            }
            
            // Initialize factors for first load
            updateLoadSpecificFactors('load-type-1', 'starting-factor-1', 'crest-factor-1');
            
            // Add new load item
            let loadCounter = 1;
            
            addLoadBtn.addEventListener('click', function() {
                loadCounter++;
                
                const loadItem = document.createElement('div');
                loadItem.className = 'load-item';
                loadItem.dataset.loadId = loadCounter;
                
                loadItem.innerHTML = `
                    <div class="load-item-header">
                        <div class="load-item-title">Load #${loadCounter}</div>
                        <button type="button" class="remove-load-btn"><i class="fas fa-trash"></i> Remove</button>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="load-name-${loadCounter}">Load Description</label>
                            <input type="text" id="load-name-${loadCounter}" placeholder="e.g., Motors, Servers, PLC">
                        </div>
                        <div class="form-group">
                            <label for="load-type-${loadCounter}">Load Type</label>
                            <select id="load-type-${loadCounter}" required>
                                <option value="resistive">Resistive (Heaters, Lighting)</option>
                                <option value="motor">Motors & Drives</option>
                                <option value="electronic">Electronic Equipment</option>
                                <option value="capacitive">Capacitive Loads</option>
                                <option value="mixed">Mixed Loads</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="load-power-${loadCounter}">Power Rating <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Power consumption of the load</span></span></label>
                            <input type="number" id="load-power-${loadCounter}" min="0" step="0.1" required>
                        </div>
                        <div class="form-group">
                            <label for="power-unit-${loadCounter}">Unit</label>
                            <select id="power-unit-${loadCounter}" required>
                                <option value="kW">kW</option>
                                <option value="kVA">kVA</option>
                                <option value="W">W</option>
                                <option value="VA">VA</option>
                                <option value="A">A (Amps)</option>
                                <option value="HP">HP (Horsepower)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="power-factor-${loadCounter}">Power Factor <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Power factor of the load</span></span></label>
                            <input type="number" id="power-factor-${loadCounter}" min="0.1" max="1" step="0.01" value="0.8" required>
                        </div>
                        <div class="form-group">
                            <label for="starting-factor-${loadCounter}">Starting Factor <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Inrush current multiplier for motors (e.g., 6 for direct-on-line start)</span></span></label>
                            <input type="number" id="starting-factor-${loadCounter}" min="1" max="10" step="0.1" value="1" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="crest-factor-${loadCounter}">Crest Factor <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Ratio of peak current to RMS current (typically 1.41 for linear, 2-3 for non-linear)</span></span></label>
                            <input type="number" id="crest-factor-${loadCounter}" min="1" max="5" step="0.01" value="1.41" required>
                        </div>
                        <div class="form-group">
                            <label for="duty-cycle-${loadCounter}">Duty Cycle (%) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Percentage of time the load is active</span></span></label>
                            <input type="number" id="duty-cycle-${loadCounter}" min="1" max="100" step="1" value="100" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="quantity-${loadCounter}">Quantity</label>
                            <input type="number" id="quantity-${loadCounter}" min="1" step="1" value="1" required>
                        </div>
                    </div>
                `;
                
                loadsContainer.appendChild(loadItem);
                
                // Initialize factors for new load
                updateLoadSpecificFactors(`load-type-${loadCounter}`, `starting-factor-${loadCounter}`, `crest-factor-${loadCounter}`);
                
                // Add event listener for remove button
                const removeBtn = loadItem.querySelector('.remove-load-btn');
                removeBtn.addEventListener('click', function() {
                    loadItem.remove();
                });
            });
            
            // Remove load item
            loadsContainer.addEventListener('click', function(e) {
                if (e.target.classList.contains('remove-load-btn') || e.target.parentElement.classList.contains('remove-load-btn')) {
                    const button = e.target.classList.contains('remove-load-btn') ? e.target : e.target.parentElement;
                    const loadItem = button.closest('.load-item');
                    loadItem.remove();
                }
            });
            
            // Calculate UPS size
            calculateBtn.addEventListener('click', function() {
                // Get system parameters
                let systemVoltage = document.getElementById('system-voltage').value;
                if (systemVoltage === 'custom') {
                    systemVoltage = document.getElementById('custom-voltage').value;
                }
                systemVoltage = parseFloat(systemVoltage);
                
                const phaseType = document.getElementById('phase-type').value;
                const backupTime = parseFloat(document.getElementById('backup-time').value);
                const futureExpansion = parseFloat(document.getElementById('future-expansion').value) / 100;
                const upsEfficiency = parseFloat(document.getElementById('ups-efficiency').value) / 100;
                const upsType = document.getElementById('ups-type').value;
                const ambientTemp = parseFloat(document.getElementById('ambient-temp').value);
                const altitude = parseFloat(document.getElementById('altitude').value);
                const environmentType = document.getElementById('environment-type').value;
                const redundancy = document.getElementById('redundancy').value;

                const dcBusVoltage = parseFloat(document.getElementById('dc-bus-voltage').value);
                const batteryTypeSelected = document.getElementById('battery-type').value;
                
                const batteryParameters = batteryTypes[batteryTypeSelected];
                const batteryUnitVoltage = batteryParameters.unitVoltage;
                const batteryEfficiency = batteryParameters.eff;
                const depthOfDischarge = batteryParameters.dod;
                const chargingCRate = batteryParameters.chargingCRate; // Get charging C-rate
                const nominalBatteryUnitAhTypical = batteryParameters.nominalAhTypical; // Get typical Ah for parallel string calculation
                
                // Validate inputs
                if (!systemVoltage || !backupTime || !upsEfficiency || !dcBusVoltage) {
                    displayMessage("Please fill in all required system parameters.", "error");
                    return;
                }
                if (systemVoltage <= 0 || backupTime <= 0 || upsEfficiency <= 0 || futureExpansion < 0 || futureExpansion > 1 || ambientTemp < 0 || altitude < 0 || dcBusVoltage <= 0) {
                     displayMessage("Please enter valid positive numbers for system parameters. Future expansion must be between 0 and 100.", "error");
                     return;
                }

                // Get all load items
                const loadItems = document.querySelectorAll('.load-item');
                
                // Calculate total power requirements
                let totalPowerKW = 0;
                let totalPowerKVA = 0;
                let peakPowerKVA = 0; // Max of (running KVA * starting factor) or (running KVA * crest factor) for any single load
                let totalCurrentA = 0;
                let loadDetails = [];
                let calculationHtml = '<h4>Detailed Calculation Steps:</h4>';
                let loadDetailsHtml = '<h4>Load Details Summary:</h4><table class="result-table"><thead><tr><th>Load</th><th>Type</th><th>Power (kW)</th><th>Power (kVA)</th><th>Peak (kVA)</th><th>RMS Current (A)</th><th>Peak Current (A)</th></tr></thead><tbody>';
                
                // Step 1: Calculate Total Connected Load
                calculationHtml += `<p><strong>1. Calculate Total Connected Load:</strong></p>`;
                calculationHtml += `<p>Each connected load's power is converted to kW and kVA, then aggregated. Peak kVA considers starting factors for motors and crest factors for electronic loads to ensure the UPS can handle instantaneous current requirements.</p>`;

                loadItems.forEach((item, index) => {
                    const loadId = item.dataset.loadId;
                    const loadPower = parseFloat(document.getElementById(`load-power-${loadId}`).value);
                    const powerUnit = document.getElementById(`power-unit-${loadId}`).value;
                    const powerFactor = parseFloat(document.getElementById(`power-factor-${loadId}`).value);
                    const startingFactor = parseFloat(document.getElementById(`starting-factor-${loadId}`).value);
                    const crestFactor = parseFloat(document.getElementById(`crest-factor-${loadId}`).value);
                    const dutyCycle = parseFloat(document.getElementById(`duty-cycle-${loadId}`).value) / 100;
                    const quantity = parseFloat(document.getElementById(`quantity-${loadId}`).value);
                    const loadName = document.getElementById(`load-name-${loadId}`).value || `Load #${loadId}`;
                    const loadType = document.getElementById(`load-type-${loadId}`).value;
                    
                    if (isNaN(loadPower) || loadPower <= 0 || isNaN(powerFactor) || powerFactor <= 0 || powerFactor > 1 || isNaN(startingFactor) || startingFactor < 1 || isNaN(crestFactor) || crestFactor < 1 || isNaN(dutyCycle) || dutyCycle <= 0 || dutyCycle > 1 || isNaN(quantity) || quantity <= 0) {
                        displayMessage(`Please enter valid positive numbers for all parameters of ${loadName}.`, "error");
                        return;
                    }
                    
                    let powerKW = 0;
                    let powerKVA = 0;
                    
                    switch(powerUnit) {
                        case 'kW':
                            powerKW = loadPower;
                            powerKVA = loadPower / powerFactor;
                            break;
                        case 'kVA':
                            powerKVA = loadPower;
                            powerKW = loadPower * powerFactor;
                            break;
                        case 'W':
                            powerKW = loadPower / 1000;
                            powerKVA = powerKW / powerFactor;
                            break;
                        case 'VA':
                            powerKVA = loadPower / 1000;
                            powerKW = powerKVA * powerFactor;
                            break;
                        case 'A':
                            // Convert amps to kVA based on system phase
                            if (phaseType === 'single') {
                                powerKVA = (loadPower * systemVoltage) / 1000;
                            } else { // Three-phase
                                powerKVA = (loadPower * systemVoltage * Math.sqrt(3)) / 1000;
                            }
                            powerKW = powerKVA * powerFactor;
                            break;
                        case 'HP':
                            // Convert HP to kW (1 HP = 0.746 kW)
                            powerKW = loadPower * 0.746;
                            powerKVA = powerKW / powerFactor;
                            break;
                    }
                    
                    const runningPowerKW = powerKW * dutyCycle * quantity;
                    const runningPowerKVA = powerKVA * dutyCycle * quantity;
                    
                    // Calculate peak KVA from starting factor and crest factor
                    const peakKVAFromStarting = powerKVA * startingFactor * quantity;
                    const peakKVAFromCrest = (powerKVA / 1.0) * crestFactor * quantity; // Assuming RMS current from kVA is kVA/1.0 for simplification for crest factor, then apply crest factor

                    const peakPowerKVAForLoad = Math.max(peakKVAFromStarting, peakKVAFromCrest); // Take the higher of the two peak demands

                    totalPowerKW += runningPowerKW;
                    totalPowerKVA += runningPowerKVA; 
                    
                    if (peakPowerKVAForLoad > peakPowerKVA) {
                        peakPowerKVA = peakPowerKVAForLoad;
                    }
                    
                    let currentA_rms = 0;
                    if (systemVoltage > 0) { 
                        if (phaseType === 'single') {
                            currentA_rms = (runningPowerKVA * 1000) / systemVoltage;
                        } else {
                            currentA_rms = (runningPowerKVA * 1000) / (systemVoltage * Math.sqrt(3));
                        }
                    }
                    totalCurrentA += currentA_rms; // Sum of RMS currents

                    const peakCurrentA_load = currentA_rms * crestFactor; // Peak current for this specific load

                    loadDetails.push({
                        name: loadName,
                        type: loadType,
                        powerKW: runningPowerKW,
                        powerKVA: runningPowerKVA,
                        peakKVA: peakPowerKVAForLoad, // This is the peak kVA, not peak current directly
                        currentRMS: currentA_rms,
                        currentPeak: peakCurrentA_load
                    });

                    // Add detailed calculation for each load
                    calculationHtml += `<p class="calculation-step"><strong>Load #${loadId} (${loadName}):</strong></p>`;
                    calculationHtml += `<p class="calculation-step">Input Power: ${loadPower.toFixed(2)} ${powerUnit}</p>`;
                    calculationHtml += `<p class="calculation-step">Equivalent kW: ${powerKW.toFixed(2)} kW</p>`;
                    calculationHtml += `<p class="calculation-step">Equivalent kVA: ${powerKVA.toFixed(2)} kVA</p>`;
                    calculationHtml += `<p class="calculation-step">Running kW: ${runningPowerKW.toFixed(2)} kW (Applied Duty Cycle: ${(dutyCycle * 100).toFixed(0)}%, Quantity: ${quantity})</p>`;
                    calculationHtml += `<p class="calculation-step">Running kVA: ${runningPowerKVA.toFixed(2)} kVA (Applied Duty Cycle: ${(dutyCycle * 100).toFixed(0)}%, Quantity: ${quantity})</p>`;
                    calculationHtml += `<p class="calculation-step">Peak kVA from Starting Factor: ${peakKVAFromStarting.toFixed(2)} kVA (Starting Factor: ${startingFactor})</p>`;
                    calculationHtml += `<p class="calculation-step">Peak kVA from Crest Factor: ${peakKVAFromCrest.toFixed(2)} kVA (Crest Factor: ${crestFactor})</p>`;
                    calculationHtml += `<p class="calculation-step">Overall Peak kVA for Load: ${peakPowerKVAForLoad.toFixed(2)} kVA</p>`;
                    calculationHtml += `<p class="calculation-step">RMS Current for Load: ${currentA_rms.toFixed(2)} A</p>`;
                    calculationHtml += `<p class="calculation-step">Peak Current for Load: ${peakCurrentA_load.toFixed(2)} A</p>`;
                });
                
                // Step 2: Apply Future Expansion Factor (for Load only)
                const designPowerKW_for_load = totalPowerKW * (1 + futureExpansion);
                const designPowerKVA_for_load = totalPowerKVA * (1 + futureExpansion);

                calculationHtml += `<p><strong>2. Apply Future Expansion Factor (for Load):</strong></p>`;
                calculationHtml += `<p>An additional capacity margin is added to the total connected load to accommodate future growth and unforeseen requirements.</p>`;
                calculationHtml += `<p class="formula">$$P_{\\text{design, load, kW}} = P_{\\text{total, kW}} \\times (1 + \\text{Future Expansion})$$</p>`;
                calculationHtml += `<p class="formula">$$S_{\\text{design, load, kVA}} = S_{\\text{total, kVA}} \\times (1 + \\text{Future Expansion})$$</p>`;
                calculationHtml += `<p class="calculation-step">
                    P_design, load, kW = ${totalPowerKW.toFixed(2)} x (1 + ${futureExpansion.toFixed(2)}) = ${designPowerKW_for_load.toFixed(2)} kW
                </p>`;
                calculationHtml += `<p class="calculation-step">
                    S_design, load, kVA = ${totalPowerKVA.toFixed(2)} x (1 + ${futureExpansion.toFixed(2)}) = ${designPowerKVA_for_load.toFixed(2)} kVA
                </p>`;
                
                // Step 3: Calculate Battery Capacity (based on load)
                const backupTimeHours = backupTime / 60;
                
                // Energy required from batteries in kWh, based purely on the expanded LOAD
                const energyRequiredKWH_output = designPowerKW_for_load * backupTimeHours;
                
                // Total battery bank energy required from batteries (accounting for battery efficiency and DoD)
                const requiredBatteryEnergyWh_raw = (energyRequiredKWH_output * 1000) / (batteryEfficiency * depthOfDischarge);
                
                // Total Ah required at the DC bus voltage
                const requiredBatteryAhAtDCBus = requiredBatteryEnergyWh_raw / dcBusVoltage;

                // Number of series units per string
                const numSeriesUnitsPerString = Math.ceil(dcBusVoltage / batteryUnitVoltage);
                
                // Number of parallel strings, using typical Ah for calculation
                const numParallelStrings = Math.ceil(requiredBatteryAhAtDCBus / nominalBatteryUnitAhTypical);
                
                // Total batteries needed (series units * parallel strings)
                const totalBatteriesNeeded = numSeriesUnitsPerString * numParallelStrings;


                calculationHtml += `<p><strong>3. Calculate Battery Capacity:</strong></p>`;
                calculationHtml += `<p>Battery capacity is determined by the design power load and the required backup duration, considering battery efficiency and permissible depth of discharge (DoD). The total number of battery units is derived from the DC bus voltage and the characteristics of the selected battery type.</p>`;
                
                calculationHtml += `<p class="formula">$$E_{\\text{required, kWh}} = P_{\\text{design, load, kW}} \\times \\text{Backup Time (hours)}$$</p>`;
                calculationHtml += `<p class="calculation-step">
                    E_required, kWh = ${designPowerKW_for_load.toFixed(2)} x ${backupTimeHours.toFixed(2)} = ${energyRequiredKWH_output.toFixed(2)} kWh
                </p>`;

                calculationHtml += `<p class="formula">$$E_{\\text{battery bank, Wh}} = \\frac{E_{\\text{required, kWh}} \\times 1000}{\\text{Battery Efficiency} \\times \\text{Depth of Discharge}}$$</p>`;
                 calculationHtml += `<p class="calculation-step">
                    E_battery bank, Wh = (${energyRequiredKWH_output.toFixed(2)} x 1000) / (${batteryEfficiency.toFixed(2)} x ${depthOfDischarge.toFixed(2)}) = ${requiredBatteryEnergyWh_raw.toFixed(2)} Wh
                </p>`;

                calculationHtml += `<p class="formula">$$C_{\\text{battery, Ah @ DC Bus}} = \\frac{E_{\\text{battery bank, Wh}}}{\\text{UPS DC Bus Voltage}}$$</p>`;
                calculationHtml += `<p class="calculation-step">
                    C_battery, Ah @ DC Bus = ${requiredBatteryEnergyWh_raw.toFixed(2)} / ${dcBusVoltage.toFixed(0)} = ${requiredBatteryAhAtDCBus.toFixed(2)} Ah
                </p>`;
                calculationHtml += `<p class="formula">$$\\text{Series Units/String} = \\text{ceil}\\left(\\frac{\\text{UPS DC Bus Voltage}}{\\text{Battery Unit Voltage}}\\right)$$</p>`;
                calculationHtml += `<p class="calculation-step">
                    Series Units/String = ceil(${dcBusVoltage.toFixed(0)} / ${batteryUnitVoltage}) = ${numSeriesUnitsPerString}
                </p>`;
                calculationHtml += `<p class="formula">$$\\text{Parallel Strings} = \\text{ceil}\\left(\\frac{C_{\\text{battery, Ah @ DC Bus}}}{\\text{Nominal Battery Unit Ah (Typical)}}\\right)$$</p>`;
                calculationHtml += `<p class="calculation-step">
                    Parallel Strings = ceil(${requiredBatteryAhAtDCBus.toFixed(2)} / ${nominalBatteryUnitAhTypical}) = ${numParallelStrings}
                </p>`;
                calculationHtml += `<p class="formula">$$\\text{Total Batteries} = \\text{Series Units/String} \\times \\text{Parallel Strings}$$</p>`;
                calculationHtml += `<p class="calculation-step">
                    Total Batteries = ${numSeriesUnitsPerString} x ${numParallelStrings} = ${totalBatteriesNeeded}
                </p>`;

                // Step 4: Calculate UPS Charging Power and Total UPS Input kVA
                // This power is added to the load power to determine the total kVA the UPS must supply.
                const peakChargingCurrent = requiredBatteryAhAtDCBus * chargingCRate; // Amps
                const chargingPowerDC_kW = (peakChargingCurrent * dcBusVoltage) / 1000; // DC power into battery
                const chargerEfficiencyACtoDC = 0.9; // Typical charger efficiency (e.g., 90%)
                const chargerPowerFactor = 0.95; // Typical power factor of the charger circuit (e.g., 0.95)

                const chargingPowerAC_kW = chargingPowerDC_kW / chargerEfficiencyACtoDC;
                const chargingPowerAC_kVA = chargingPowerAC_kW / chargerPowerFactor;

                calculationHtml += `<p><strong>4. Calculate UPS Charging Power:</strong></p>`;
                calculationHtml += `<p>The UPS must also have sufficient capacity to simultaneously recharge the battery bank. The charging power is calculated based on the total required battery Ah and a typical charging rate for the selected battery chemistry, converted to an AC kVA equivalent that the UPS needs to draw.</p>`;
                calculationHtml += `<p class="calculation-step">
                    Peak Charging Current (A) = Battery Ah @ DC Bus x Charging C-Rate = ${requiredBatteryAhAtDCBus.toFixed(2)} Ah x ${chargingCRate} = ${peakChargingCurrent.toFixed(2)} A
                </p>`;
                calculationHtml += `<p class="calculation-step">
                    Charging Power (DC) (kW) = (Peak Charging Current x UPS DC Bus Voltage) / 1000 = (${peakChargingCurrent.toFixed(2)} A x ${dcBusVoltage} V) / 1000 = ${chargingPowerDC_kW.toFixed(2)} kW
                </p>`;
                calculationHtml += `<p class="calculation-step">
                    Charging Power (AC) (kW) = Charging Power (DC) / Charger Efficiency = ${chargingPowerDC_kW.toFixed(2)} kW / ${chargerEfficiencyACtoDC} = ${chargingPowerAC_kW.toFixed(2)} kW
                </p>`;
                calculationHtml += `<p class="calculation-step">
                    Charging Power (AC) (kVA) = Charging Power (AC) (kW) / Charger Power Factor = ${chargingPowerAC_kW.toFixed(2)} kW / ${chargerPowerFactor} = ${chargingPowerAC_kVA.toFixed(2)} kVA
                </p>`;
                
                // Total UPS output kVA required considering both load and charging
                const totalRequiredKVA_for_ups_output = designPowerKVA_for_load + chargingPowerAC_kVA;
                const totalRequiredKW_for_ups_output = designPowerKW_for_load + chargingPowerAC_kW;


                // Step 5: Account for UPS Efficiency (applied to total required KVA for load + charging)
                const upsSizeKVA_raw = totalRequiredKVA_for_ups_output / upsEfficiency;
                calculationHtml += `<p><strong>5. Account for UPS Efficiency:</strong></p>`;
                calculationHtml += `<p>The UPS must be rated to supply the combined design load and charging power while accounting for its own internal power losses.</p>`;
                calculationHtml += `<p class="formula">$$S_{\\text{UPS, required}} = \\frac{S_{\\text{Load+Charging, kVA}}}{\\text{UPS Efficiency}}$$</p>`;
                calculationHtml += `<p class="calculation-step">
                    S_UPS, required = ${totalRequiredKVA_for_ups_output.toFixed(2)} / ${upsEfficiency.toFixed(2)} = ${upsSizeKVA_raw.toFixed(2)} kVA
                </p>`;

                // Step 6: Apply Altitude and Temperature Derating Factors
                let altitudeDeratingFactor = 1.0;
                if (altitude > 1000) {
                    altitudeDeratingFactor = 1.0 - ((altitude - 1000) / 100) * 0.01; 
                    if (altitudeDeratingFactor < 0.85) altitudeDeratingFactor = 0.85; 
                }
                
                let tempDeratingFactor = 1.0;
                if (ambientTemp > 25) {
                    tempDeratingFactor = 1.0 - ((ambientTemp - 25) * 0.015); 
                    if (tempDeratingFactor < 0.7) tempDeratingFactor = 0.7; 
                }
                
                let environmentDeratingFactor = 1.0;
                switch(environmentType) {
                    case 'industrial':
                        environmentDeratingFactor = 0.95; 
                        break;
                    case 'harsh':
                        environmentDeratingFactor = 0.90; 
                        break;
                    case 'outdoor':
                        environmentDeratingFactor = 0.85; 
                        break;
                    default:
                        environmentDeratingFactor = 1.0; 
                }

                const combinedDeratingFactor = altitudeDeratingFactor * tempDeratingFactor * environmentDeratingFactor;
                const finalUpsKVA = upsSizeKVA_raw / combinedDeratingFactor;

                calculationHtml += `<p><strong>6. Apply Environmental Derating Factors:</strong></p>`;
                calculationHtml += `<p>UPS units can be derated based on environmental conditions like high altitude and temperature, as well as the general harshness of the installation environment. This ensures the UPS operates reliably under actual conditions.</p>`;
                calculationHtml += `<ul>
                    <li>Altitude Derating Factor: ${altitudeDeratingFactor.toFixed(2)} (Calculated: ${altitude > 1000 ? `1% per 100m above 1000m. At ${altitude}m: ${((altitude - 1000) / 100) * 0.01 * 100}% derating.` : 'No derating below 1000m'})</li>
                    <li>Temperature Derating Factor: ${tempDeratingFactor.toFixed(2)} (Calculated: ${ambientTemp > 25 ? `1.5% per °C above 25°C. At ${ambientTemp}°C: ${((ambientTemp - 25) * 0.015 * 100).toFixed(1)}% derating.` : 'No derating below 25°C'})</li>
                    <li>Environment Specific Derating Factor: ${environmentDeratingFactor.toFixed(2)} (Based on ${environmentType} environment)</li>
                </ul>`;
                calculationHtml += `<p class="formula">$$S_{\\text{UPS, final}} = \\frac{S_{\\text{UPS, required}}}{\\text{Altitude Derating} \\times \\text{Temp Derating} \\times \\text{Environment Derating}}$$</p>`;
                calculationHtml += `<p class="calculation-step">
                    S_UPS, final = ${upsSizeKVA_raw.toFixed(2)} / (${altitudeDeratingFactor.toFixed(2)} x ${tempDeratingFactor.toFixed(2)} x ${environmentDeratingFactor.toFixed(2)}) = ${finalUpsKVA.toFixed(2)} kVA
                </p>`;
                
                // Step 7: Apply Redundancy Configuration
                let redundantUpsKVA = 0;
                let redundancyConfig = '';
                
                switch(redundancy) {
                    case 'n+1':
                        redundantUpsKVA = finalUpsKVA * 2; 
                        redundancyConfig = `2 x ${Math.ceil(finalUpsKVA)} kVA UPS units in parallel`;
                        break;
                    case '2n':
                        redundantUpsKVA = finalUpsKVA * 2; 
                        redundancyConfig = `2 x ${Math.ceil(finalUpsKVA)} kVA UPS systems (2N configuration)`;
                        break;
                    case '2n+1':
                        redundantUpsKVA = finalUpsKVA * 3; 
                        redundancyConfig = `3 x ${Math.ceil(finalUpsKVA)} kVA UPS systems (2N+1 configuration)`;
                        break;
                    default: // n
                        redundancyConfig = `1 x ${Math.ceil(finalUpsKVA)} kVA UPS unit (N configuration)`;
                }

                calculationHtml += `<p><strong>7. Apply Redundancy Configuration:</strong></p>`;
                calculationHtml += `<p>For critical applications, redundancy ensures continuous power even if one UPS module or system fails. Different configurations (N+1, 2N, 2N+1) offer varying levels of fault tolerance.</p>`;
                calculationHtml += `<p class="calculation-step">
                    Redundancy Applied: ${redundancy.toUpperCase()}
                </p>`;
                calculationHtml += `<p class="calculation-step">
                    Resulting UPS Configuration: ${redundancyConfig}
                </p>`;
                
                // Step 8: Find the nearest common UPS kVA size
                const standardUpsSizes = [1, 2, 3, 5, 6, 8, 10, 15, 20, 30, 40, 50, 60, 80, 100, 120, 160, 200, 250, 300, 400, 500, 600, 800, 1000];
                
                let recommendedUpsSize = standardUpsSizes[0];
                for (let size of standardUpsSizes) {
                    if (size >= finalUpsKVA) {
                        recommendedUpsSize = size;
                        break;
                    }
                }
                calculationHtml += `<p><strong>8. Select Recommended Standard UPS Size:</strong></p>`;
                calculationHtml += `<p>After calculating the necessary UPS capacity, we select the next available standard UPS size that meets or exceeds the calculated final required kVA.</p>`;
                calculationHtml += `<ul>
                    <li>Calculated Final UPS kVA = ${finalUpsKVA.toFixed(2)} kVA</li>
                    <li>Available Standard UPS Sizes: ${standardUpsSizes.join(', ')} kVA</li>
                </ul>`;
                calculationHtml += `<p class="calculation-step">
                    Recommended Standard UPS Size = ${recommendedUpsSize} kVA
                </p>`;


                calculationDetailsDiv.innerHTML = calculationHtml;
                if (window.MathJax) {
                    window.MathJax.typesetPromise([calculationDetailsDiv]);
                }

                // Display results
                resultContainer.style.display = 'block';
                
                // Clear previous results
                resultTableBody.innerHTML = '';
                
                // Add rows to the results table
                function addResultRow(parameter, value) {
                    const tr = document.createElement('tr');
                    const paramCell = document.createElement('td');
                    const valueCell = document.createElement('td');
                    paramCell.textContent = parameter;
                    valueCell.textContent = value;
                    tr.appendChild(paramCell);
                    tr.appendChild(valueCell);
                    resultTableBody.appendChild(tr);
                }

                addResultRow('System Voltage', `${systemVoltage} V (${phaseType === 'single' ? 'Single-Phase' : 'Three-Phase'})`);
                addResultRow('Required Backup Time', `${backupTime} minutes`);
                addResultRow('Future Expansion Factor', `${(futureExpansion * 100).toFixed(0)}%`);
                addResultRow('UPS Efficiency', `${(upsEfficiency * 100).toFixed(0)}%`);
                addResultRow('UPS Technology', upsType.charAt(0).toUpperCase() + upsType.slice(1));
                addResultRow('Ambient Temperature', `${ambientTemp}°C`);
                addResultRow('Altitude', `${altitude} meters`);
                addResultRow('Environment Type', environmentType.charAt(0).toUpperCase() + environmentType.slice(1));
                addResultRow('Redundancy Configuration', redundancy.toUpperCase());
                addResultRow('UPS DC Bus Voltage', `${dcBusVoltage} V`);
                addResultRow('Battery Type', batteryTypeSelected);
                addResultRow('Total Connected Load', `${totalPowerKW.toFixed(2)} kW / ${totalPowerKVA.toFixed(2)} kVA`);
                addResultRow('Calculated Power Factor', (totalPowerKW / totalPowerKVA).toFixed(2));
                addResultRow('Peak Starting Load (Max)', `${peakPowerKVA.toFixed(2)} kVA`);
                addResultRow('Total Running RMS Current', `${totalCurrentA.toFixed(2)} A`); // Changed to RMS to reflect sum
                addResultRow('Design Load (with expansion)', `${designPowerKW_for_load.toFixed(2)} kW / ${designPowerKVA_for_load.toFixed(2)} kVA`);
                addResultRow('Battery Charging Power (kVA)', `${chargingPowerAC_kVA.toFixed(2)} kVA`); // NEW ROW
                addResultRow('Total KVA (Load + Charging)', `${totalRequiredKVA_for_ups_output.toFixed(2)} kVA`); // NEW ROW
                addResultRow('UPS Raw Required Size', `${upsSizeKVA_raw.toFixed(2)} kVA`);
                addResultRow('Altitude Derating Factor', altitudeDeratingFactor.toFixed(2));
                addResultRow('Temperature Derating Factor', tempDeratingFactor.toFixed(2));
                addResultRow('Environment Derating Factor', environmentDeratingFactor.toFixed(2));
                addResultRow('Final Adjusted UPS Size', `${finalUpsKVA.toFixed(2)} kVA`);
                addResultRow('Recommended Standard UPS Size', `${recommendedUpsSize} kVA`);
                addResultRow('Battery Capacity (Energy)', `${energyRequiredKWH_output.toFixed(2)} kWh`);
                addResultRow('Battery Capacity (Ah @ DC Bus)', `${requiredBatteryAhAtDCBus.toFixed(2)} Ah`);
                addResultRow('Battery Unit Voltage', `${batteryUnitVoltage} V`);
                addResultRow('Total Batteries Needed', `${totalBatteriesNeeded} units`); // Only total units

                // Generate load details table
                loadDetailsHtml += '<tbody>';
                loadDetails.forEach(load => {
                    loadDetailsHtml += `<tr>
                        <td>${load.name}</td>
                        <td>${load.type.charAt(0).toUpperCase() + load.type.slice(1)}</td>
                        <td>${load.powerKW.toFixed(2)}</td>
                        <td>${load.powerKVA.toFixed(2)}</td>
                        <td>${load.peakKVA.toFixed(2)}</td>
                        <td>${load.currentRMS.toFixed(2)}</td>
                        <td>${load.currentPeak.toFixed(2)}</td>
                    </tr>`;
                });
                
                loadDetailsHtml += '</tbody></table>';
                
                loadDetailsSummaryDiv.innerHTML = loadDetailsHtml;
                
                // Generate recommendation
                let recommendationHTML = '';
                
                // UPS technology recommendation
                let techRecommendation = '';
                switch(upsType) {
                    case 'online':
                        techRecommendation = 'Online/Double Conversion UPS is recommended for critical industrial applications, providing complete isolation from utility power problems.';
                        break;
                    case 'line-interactive':
                        techRecommendation = 'Line Interactive UPS provides good protection for less critical loads with moderate power quality issues.';
                        break;
                    case 'standby':
                        techRecommendation = 'Standby/Offline UPS is suitable only for non-critical applications in environments with stable power.';
                        break;
                }
                
                // Battery recommendation
                let batteryRecommendation = '';
                if (backupTime <= 10) {
                    batteryRecommendation = `For short backup times with ${batteryTypeSelected} batteries, consider optimizing for high-rate discharge.`;
                } else if (backupTime <= 30) {
                    batteryRecommendation = `For medium backup times with ${batteryTypeSelected} batteries, ensure adequate ventilation and temperature control.`;
                } else {
                    batteryRecommendation = `For extended backup times with ${batteryTypeSelected} batteries, a detailed battery runtime analysis is crucial. Consider a combination with a generator system.`;
                }
                
                // Environment recommendation
                let environmentRecommendation = '';
                switch(environmentType) {
                    case 'industrial':
                        environmentRecommendation = 'For industrial environments, ensure UPS has appropriate IP rating and consider additional air filtration.';
                        break;
                    case 'harsh':
                        environmentRecommendation = 'For harsh environments, UPS should be installed in a protective enclosure with temperature control and dust filtration.';
                        break;
                    case 'outdoor':
                        environmentRecommendation = 'For outdoor installation, a weatherproof enclosure with climate control is essential.';
                        break;
                }
                
                recommendationHTML = `
                    <p><strong>Recommended UPS Size:</strong> ${recommendedUpsSize} kVA</p>
                    <p><strong>Technology:</strong> ${techRecommendation}</p>
                    <p><strong>Battery System:</strong> Based on ${batteryTypeSelected} batteries, you will need approximately ${totalBatteriesNeeded} individual units. This calculation includes the power required for simultaneous battery charging.</p>
                    <p><strong>Installation Considerations:</strong> ${environmentRecommendation}</p>
                    <p><strong>Redundancy:</strong> ${redundancyConfig}</p>
                `;
                
                if (finalUpsKVA > 100) {
                    recommendationHTML += '<p><strong>Note:</strong> For large UPS systems, consider a modular approach for better scalability and maintenance.</p>';
                }
                
                recommendationContent.innerHTML = recommendationHTML;
                
                // Scroll to results
                resultContainer.scrollIntoView({ behavior: 'smooth' });
            });

            // Theme switch logic
            const themeSwitch = document.getElementById('theme-switch');
            if (themeSwitch) {
                // Check for saved theme preference
                if (localStorage.getItem('theme') === 'dark') {
                    document.body.classList.add('dark-mode');
                    themeSwitch.checked = true;
                }

                themeSwitch.addEventListener('change', function() {
                    if (this.checked) {
                        document.body.classList.add('dark-mode');
                        localStorage.setItem('theme', 'dark');
                    } else {
                        document.body.classList.remove('dark-mode');
                        localStorage.setItem('theme', 'light');
                    }
                });
            }
        });
    </script>
</body>
</html>

