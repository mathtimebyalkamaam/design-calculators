<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Industrial UPS Sizing Calculator - Design Calculators - Electrical</title>
    <!-- Meta tags -->
    <meta name="description" content="Professional Industrial UPS Sizing Calculator. Calculate kVA and battery Ah capacity for industrial loads, motors, and electronics per IEEE standards.">
    <meta name="keywords" content="ups sizing calculator, industrial ups, battery sizing calculator, kva calculator, ups kva, ieee, electrical calculator">
    <meta name="author" content="Design Calculators">
    <meta name="robots" content="index, follow">

    <!-- AdSense & Google Analytics -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5936527763614780" crossorigin="anonymous"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-23Y1V450SR"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-23Y1V450SR');
    </script>
    
    <!-- Fonts and Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Montserrat:wght@700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- MathJax for formula rendering -->
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
            svg: { fontCache: 'global' },
            options: { processHtmlClass: 'math-content', ignoreHtmlClass: 'no-mathjax' }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- jsPDF-AutoTable plugin -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <!-- Favicons -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    
    <!-- NEW Standardized CSS -->
    <style>
        :root {
            --primary-color: #1E3A8A;
            --secondary-color: #2563EB;
            --accent-color: #F59E0B;
            --success-color: #10B981;
            --bg-color: #F8FAFC;
            --card-bg: #FFFFFF;
            --text-color: #4B5563;
            --heading-color: #111827;
            --footer-bg: #0F172A;
            --border-color: #E2E8F0;
            --gradient-primary: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            --gradient-dark: linear-gradient(135deg, #0F172A, #1E293B);
            --card-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            --hover-color: #e2e6ea;
            --input-focus-shadow: 0 0 0 3px rgba(30, 58, 138, 0.25);
        }

        body.dark-mode {
            --primary-color: #10B981;
            --secondary-color: #34D399;
            --bg-color: #0F172A;
            --card-bg: #1E293B;
            --text-color: #CBD5E1;
            --heading-color: #F1F5F9;
            --footer-bg: #020617;
            --border-color: #334155;
            --hover-color: #1E293B;
            --input-focus-shadow: 0 0 0 3px rgba(16, 185, 129, 0.5);
        }

        * { box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.8;
            transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 24px;
        }

        /* HEADER */
        .header {
            background: var(--gradient-primary);
            color: white;
            padding: 24px 0;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo-container {
            flex-direction: column;
            align-items: flex-start;
            text-decoration: none;
            color: white;
            gap: 0;
        }
        .logo-text {
            font-size: 1.75rem;
            font-weight: 800;
            font-family: 'Montserrat', sans-serif;
        }
        .logo-subtitle {
            font-size: 0.8rem;
            line-height: 1.2;
            margin: 4px 0 0 0;
            font-weight: 300;
            max-width: 400px;
            color: #E0E7FF;
        }
        
        .nav-links {
            display: flex;
            gap: 24px;
            align-items: center;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        .nav-links a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }
        .nav-links a:hover { color: var(--accent-color); }

        /* Theme Toggle */
        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .theme-toggle .icon {
            color: white;
            font-size: 1.2rem;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 56px;
            height: 30px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.2);
            transition: .4s;
            border-radius: 30px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--accent-color); }
        input:checked + .slider:before { transform: translateX(26px); }

        /* Main Content */
        main { padding: 40px 0; }
        .tool-container {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 30px;
            box-shadow: var(--card-shadow);
            margin-bottom: 30px;
        }
        .tool-container h2 {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            padding-bottom: 15px;
            margin-top: 0;
            margin-bottom: 25px;
            font-family: 'Montserrat', sans-serif;
            font-size: 1.8rem;
        }
         .tool-container h3 {
            color: var(--heading-color);
            font-family: 'Montserrat', sans-serif;
            font-size: 1.5rem;
            margin-top: 25px;
            margin-bottom: 20px;
        }
        .tool-description {
            margin-bottom: 25px;
            color: var(--text-color);
            font-size: 1rem;
            line-height: 1.8;
        }
        .tool-description a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
        }
        .tool-description a:hover {
            text-decoration: underline;
        }

        /* Form Styles */
        .calculator-form {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 25px;
            margin-top: 25px;
        }
        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--heading-color);
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--bg-color);
            color: var(--text-color);
            box-sizing: border-box;
            transition: all 0.3s;
            font-size: 1rem;
        }
        .form-group input:focus, .form-group select:focus {
            border-color: var(--primary-color);
            box-shadow: var(--input-focus-shadow);
            outline: none;
        }
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        /* Button Styles */
        .calculate-btn {
            background: var(--gradient-primary);
            color: white;
            border: none;
            padding: 16px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 700;
            transition: all 0.3s;
            width: 100%;
            box-shadow: 0 4px 12px rgba(30, 58, 138, 0.3);
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .calculate-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(30, 58, 138, 0.4);
        }
        .calculate-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .calculate-btn:disabled {
            background: #9ca3af; /* Grey */
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .calculate-btn .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-left-color: #ffffff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: none; /* Hidden by default */
            margin-left: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Load Item Styles */
        .load-item {
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background-color: var(--bg-color);
        }
        .load-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .load-item-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        .remove-load-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.3s;
        }
        .remove-load-btn:hover {
            background: #c82333;
        }
        .add-load-btn {
            background-color: var(--success-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            margin-top: 10px;
            transition: background-color 0.3s, transform 0.2s;
        }
        .add-load-btn:hover {
            background-color: #0e9f6e;
            transform: translateY(-2px);
        }

        /* Result Styles */
        .result-container {
            margin-top: 40px;
            padding: 30px;
            border-radius: 12px;
            background-color: var(--card-bg);
            box-shadow: var(--card-shadow);
            display: none;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }
        .result-container.show {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }
        .result-container h3 {
            color: var(--primary-color);
            margin-bottom: 25px;
            font-family: 'Montserrat', sans-serif;
            font-size: 1.6rem;
        }
        #load-details-summary {
             margin-top: 25px;
        }
         #load-details-summary h4 {
            color: var(--heading-color);
            font-family: 'Montserrat', sans-serif;
            font-size: 1.4rem;
            margin-bottom: 15px;
        }
        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-radius: 8px;
            overflow: hidden;
        }
        .result-table th, .result-table td {
            padding: 14px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        .result-table th {
            background: var(--gradient-primary);
            color: white;
            font-weight: 700;
        }
        .result-table tr:nth-child(even) {
            background-color: rgba(0,0,0,0.02);
        }
        .result-table td strong {
            color: var(--heading-color);
        }
        body.dark-mode .result-table td strong {
             color: var(--primary-color);
        }
        
        /* Calculation Details & Standard Ref */
        #calculation-details { 
            background-color: var(--bg-color);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
            font-size: 0.95rem;
        }
        #calculation-details h3 { /* Changed from h4 */
            color: var(--primary-color);
            margin-bottom: 25px;
            font-family: 'Montserrat', sans-serif;
            font-size: 1.6rem;
            margin-top: 0;
        }
        #calculation-details h4 {
            color: var(--secondary-color);
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }
        #calculation-details p.formula {
            font-family: 'Times New Roman', serif;
            font-size: 1.1rem;
            text-align: center;
            padding: 15px;
            background-color: var(--hover-color);
            border-radius: 6px;
            margin: 15px 0;
            overflow-x: auto;
        }
        #calculation-details p.calculation-step {
            font-family: 'Courier New', monospace;
            background-color: var(--hover-color);
            padding: 8px 12px;
            border-radius: 4px;
            margin-bottom: 8px;
            line-height: 1.6;
        }
        #calculation-details ul {
            list-style-type: disc;
            margin-left: 25px;
            padding-left: 0;
        }
        #calculation-details ul li {
            margin-bottom: 8px;
            line-height: 1.7;
        }

        .standard-reference {
            margin-top: 25px;
            font-style: italic;
            font-size: 0.95rem;
            padding: 15px;
            background: linear-gradient(135deg, rgba(245,158,11,0.1), rgba(245,158,11,0.05));
            border-left: 4px solid var(--accent-color);
            border-radius: 6px;
            line-height: 1.7;
        }
         .standard-reference a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
        }
        .standard-reference a:hover {
            text-decoration: underline;
        }

        /* Tooltip */
        .info-icon {
            color: var(--primary-color);
            margin-left: 6px;
            cursor: help;
            font-size: 0.9rem;
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 280px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1000;
            bottom: 130%;
            left: 50%;
            margin-left: -140px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.85rem;
            line-height: 1.5;
            white-space: normal;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* Custom Message Box */
        #custom-message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 16px 28px;
            border-radius: 8px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.25);
            z-index: 10000;
            font-weight: 600;
            color: white;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        #custom-message-box.show { opacity: 1; }

        /* New Content Block Styles */
        .content-block { 
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 30px;
            box-shadow: var(--card-shadow);
            margin-bottom: 30px;
            margin-top: 30px;
            /* Added for smooth appearance */
            display: none;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }
        .content-block.show {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }
        .content-block h2 {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            padding-bottom: 15px;
            margin-top: 0;
            margin-bottom: 25px;
            font-family: 'Montserrat', sans-serif;
            font-size: 1.8rem;
        }
        .content-block h3 {
            color: var(--heading-color);
            font-family: 'Montserrat', sans-serif;
            font-size: 1.4rem;
            margin-top: 25px;
            margin-bottom: 15px;
        }
         .content-block h4 {
            color: var(--secondary-color);
            font-family: 'Montserrat', sans-serif;
            font-size: 1.2rem;
            margin-top: 20px;
            margin-bottom: 10px;
        }
        .content-block p, .content-block li {
            font-size: 1rem;
            line-height: 1.8;
            color: var(--text-color);
        }
        .content-block ul, .content-block ol {
            list-style-type: disc;
            margin-left: 20px;
            padding-left: 5px;
            margin-bottom: 15px;
        }
        .content-block ol {
            list-style-type: decimal;
        }
        .content-block li {
            margin-bottom: 10px;
        }
        .content-block strong {
            color: var(--heading-color);
        }
        body.dark-mode .content-block strong {
            color: var(--primary-color);
        }
        .content-block code {
            background-color: var(--hover-color);
            padding: 2px 5px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            color: var(--primary-color);
        }
        body.dark-mode .content-block code {
            color: var(--secondary-color);
        }
        .content-block .formula-block {
            font-family: 'Times New Roman', serif;
            font-size: 1.1rem;
            text-align: center;
            padding: 15px;
            background-color: var(--hover-color);
            border-radius: 6px;
            margin: 20px 0;
            overflow-x: auto;
            border: 1px dashed var(--primary-color);
        }
        .content-block table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-radius: 8px;
            overflow: hidden;
        }
        .content-block th, .content-block td {
            padding: 14px;
            text-align: left;
            border: 1px solid var(--border-color);
        }
        .content-block th {
            background-color: var(--hover-color);
            font-weight: 600;
        }
        
        /* FOOTER */
        footer {
            background: var(--gradient-dark);
            color: #CBD5E1;
            padding: 50px 0 20px 0;
        }
        .footer-content {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 40px;
            margin-bottom: 30px;
        }
        .footer-col {
            flex: 1;
            min-width: 200px;
        }
        .footer-col h4 {
            font-size: 1.1rem;
            color: white;
            margin-bottom: 15px;
            font-weight: 700;
        }
        .footer-col ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .footer-col ul li { margin-bottom: 10px; }
        .footer-col a {
            color: #CBD5E1;
            text-decoration: none;
            transition: color 0.3s;
            font-size: 0.95rem;
        }
        .footer-col a:hover { color: var(--accent-color); }
        .footer-disclaimer {
            text-align: center;
            margin: 30px auto;
            padding-top: 25px;
            border-top: 1px solid #334155;
            max-width: 800px;
            font-size: 0.9rem;
            line-height: 1.6;
        }
        .footer-bottom {
            text-align: center;
            padding-top: 20px;
            font-size: 0.9rem;
            color: #94A3B8;
        }
        .creator-name {
            color: var(--secondary-color);
            font-weight: bold;
        }
        .social-buttons {
            display: flex;
            gap: 12px;
            margin-top: 15px;
        }
        .social-btn {
            width: 40px;
            height: 40px;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            color: white;
            border-radius: 50%;
            text-decoration: none;
            font-size: 1.1rem;
            transition: transform 0.3s, box-shadow 0.3s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .social-btn:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
        }
        .social-btn.linkedin { background-color: #0A66C2; }
        .social-btn.youtube { background-color: #FF0000; }
        .social-btn.twitter { background-color: #1DA1F2; }
        .social-btn.facebook { background-color: #1877F2; }
        .social-btn.whatsapp { background-color: #25D366; }

        /* Responsive */
        @media (max-width: 768px) {
            .container { padding: 0 15px; }
            .navbar { flex-direction: column; gap: 20px; }
            .nav-links { flex-direction: column; gap: 12px; text-align: center; }
            .form-row { grid-template-columns: 1fr; }
            .tool-container, .content-block { padding: 20px; }
            .footer-content { flex-direction: column; gap: 25px; }
            .theme-toggle {
                position: relative;
                top: 0;
                right: 0;
                margin-top: 15px;
            }
            .content-block table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
             .logo-container {
                 align-items: center; 
            }
            .logo-subtitle {
                text-align: center; 
            }
        }
        .hidden { display: none; }
    </style>
</head>
<body>
    
    <!-- NEW HEADER -->
    <header class="header">
        <div class="container">
            <nav class="navbar">
                <a href="/" class="logo-container">
                    <span class="logo-text">Design Calculators</span>
                    <!-- Updated Subtitle -->
                    <p class="logo-subtitle">
                        Inspired by standards such as IEC, IEEE, ISA, ASME, and API.
                    </p>
                </a>
                <ul class="nav-links">
                    <li><a href="/">Home</a></li>
                    <li><a href='/articles'>Articles</a></li>
                    <li><a href='/indexmech'>Mechanical</a></li>
                    <li><a href='/indexele'>Electrical</a></li>
                    <li><a href='/indexinst'>Instrumentation</a></li>
                </ul>
                <div class="theme-toggle">
                    <i class="fas fa-sun icon"></i>
                    <label class="switch">
                        <input type="checkbox" id="theme-switch">
                        <span class="slider"></span>
                    </label>
                    <i class="fas fa-moon icon"></i>
                </div>
            </nav>
        </div>
    </header>

    <!-- MAIN CONTENT - Refactored -->
    <main class="container">
        <!-- Back button removed -->
        <div class="tool-container">
            <h2>Industrial UPS Sizing Calculator</h2>
            
            <div class="tool-description">
                <p>Calculate the appropriate UPS (Uninterruptible Power Supply) kVA capacity and battery (Ah) size for industrial applications. This tool accounts for multiple load types (kW, kVA, HP, Amps), power factors, inrush currents, future expansion, and battery derating factors to provide a robust sizing recommendation based on industry best practices and principles from standards like the IEEE Emerald Book.</p>
            </div>
            
            <div class="calculator-form">
                <form id="ups-sizing-form">
                    <h3>1. System Parameters</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="system-voltage">System Voltage (V) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Nominal voltage of the system</span></span></label>
                            <select id="system-voltage" required>
                                <option value="220">220V (Single Phase)</option>
                                <option value="230">230V (Single Phase)</option>
                                <option value="240">240V (Single Phase)</option>
                                <option value="380">380V (Three Phase)</option>
                                <option value="400">400V (Three Phase)</option>
                                <option value="415" selected>415V (Three Phase)</option>
                                <option value="480">480V (Three Phase)</option>
                                <option value="600">600V (Three Phase)</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>
                        <div class="form-group" id="custom-voltage-group" style="display: none;">
                            <label for="custom-voltage">Custom Voltage (V)</label>
                            <input type="number" id="custom-voltage" min="1" step="1">
                        </div>
                        <div class="form-group">
                            <label for="phase-type">System Type <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Single-phase or three-phase system</span></span></label>
                            <select id="phase-type" required>
                                <option value="single">Single-Phase</option>
                                <option value="three" selected>Three-Phase</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="backup-time">Required Backup Time (minutes) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">How long the UPS should provide power during an outage</span></span></label>
                            <input type="number" id="backup-time" min="1" step="1" value="30" required>
                        </div>
                        <div class="form-group">
                            <label for="future-expansion">Future Expansion Factor (%) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Additional capacity for future growth</span></span></label>
                            <input type="number" id="future-expansion" min="0" max="100" step="5" value="25" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="ups-efficiency">UPS Efficiency (%) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Efficiency of the UPS inverter (e.g., 92%).</span></span></label>
                            <input type="number" id="ups-efficiency" min="70" max="99" step="1" value="92" required>
                        </div>
                        <div class="form-group">
                            <label for="ups-type">UPS Technology <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Type of UPS technology</span></span></label>
                            <select id="ups-type" required>
                                <option value="online">Online/Double Conversion</option>
                                <option value="line-interactive">Line Interactive</option>
                                <option value="standby">Standby/Offline</option>
                            </select>
                        </div>
                    </div>

                    <h3>2. Battery System</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="dc-bus-voltage">UPS DC Bus Voltage (V) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The nominal DC voltage of the UPS internal battery bus (e.g., 240V, 384V, 480V)</span></span></label>
                            <input type="number" id="dc-bus-voltage" min="12" step="12" value="384" required>
                        </div>
                         <div class="form-group">
                            <label for="battery-type">Battery Type <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Chemistry of the batteries. Affects unit voltage, efficiency, and depth of discharge.</span></span></label>
                            <select id="battery-type" required>
                                <option value="VRLA/LA">VRLA/LA (2V Cells)</option>
                                <option value="Ni-Cd">Ni-Cd (1.2V Cells)</option>
                                <option value="SMF">SMF (12V Blocks)</option>
                                <option value="Li-ion">Li-ion (48V Modules)</option>
                            </select>
                        </div>
                    </div>
                    
                    <h3>3. Load Details</h3>
                    
                    <div id="loads-container">
                        <div class="load-item" data-load-id="1">
                            <div class="load-item-header">
                                <div class="load-item-title">Load #1</div>
                                <button type="button" class="remove-load-btn" style="visibility: hidden;"><i class="fas fa-trash"></i> Remove</button>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="load-name-1">Load Description</label>
                                    <input type="text" id="load-name-1" placeholder="e.g., Motors, Servers, PLC">
                                </div>
                                <div class="form-group">
                                    <label for="load-type-1">Load Type</label>
                                    <select id="load-type-1" required>
                                        <option value="resistive">Resistive (Heaters, Lighting)</option>
                                        <option value="motor">Motors & Drives</option>
                                        <option value="electronic">Electronic Equipment</option>
                                        <option value="capacitive">Capacitive Loads</option>
                                        <option value="mixed">Mixed Loads</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="load-power-1">Power Rating <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Power consumption of the load</span></span></label>
                                    <input type="number" id="load-power-1" min="0" step="0.1" value="10" required>
                                </div>
                                <div class="form-group">
                                    <label for="power-unit-1">Unit</label>
                                    <select id="power-unit-1" required>
                                        <option value="kW" selected>kW</option>
                                        <option value="kVA">kVA</option>
                                        <option value="W">W</option>
                                        <option value="VA">VA</option>
                                        <option value="A">A (Amps)</option>
                                        <option value="HP">HP (Horsepower)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="power-factor-1">Power Factor <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Power factor of the load (0.1 to 1.0)</span></span></label>
                                    <input type="number" id="power-factor-1" min="0.1" max="1" step="0.01" value="0.8" required>
                                </div>
                                <div class="form-group">
                                    <label for="starting-factor-1">Starting Factor <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Inrush current multiplier for motors (e.g., 6 for DOL start). Use 1 for non-motor loads.</span></span></label>
                                    <input type="number" id="starting-factor-1" min="1" max="10" step="0.1" value="1" required>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="crest-factor-1">Crest Factor <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Ratio of peak current to RMS current (1.41 for linear, 2-3 for non-linear)</span></span></label>
                                    <input type="number" id="crest-factor-1" min="1" max="5" step="0.01" value="1.41" required>
                                </div>
                                <div class="form-group">
                                    <label for="duty-cycle-1">Duty Cycle (%) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Percentage of time the load is active</span></span></label>
                                    <input type="number" id="duty-cycle-1" min="1" max="100" step="1" value="100" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="quantity-1">Quantity</label>
                                    <input type="number" id="quantity-1" min="1" step="1" value="1" required>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button type="button" id="add-load-btn" class="add-load-btn"><i class="fas fa-plus" style="margin-right: 8px;"></i> Add Another Load</button>
                    
                    <h3>4. Environmental & Redundancy</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="ambient-temp">Ambient Temperature (Â°C) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Operating temperature of the environment. High temps derate batteries and UPS.</span></span></label>
                            <input type="number" id="ambient-temp" min="0" max="50" step="1" value="25" required>
                        </div>
                        <div class="form-group">
                            <label for="altitude">Altitude (meters) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Installation altitude above sea level. High altitude derates UPS cooling.</span></span></label>
                            <input type="number" id="altitude" min="0" step="100" value="0" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="environment-type">Environment Type <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Type of installation environment</span></span></label>
                            <select id="environment-type" required>
                                <option value="clean">Clean/Office Environment</option>
                                <option value="industrial">Industrial Environment</option>
                                <option value="harsh">Harsh Environment (Dust/Humidity)</option>
                                <option value="outdoor">Outdoor Installation</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="redundancy">Redundancy Configuration <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Redundancy level for critical applications</span></span></label>
                            <select id="redundancy" required>
                                <option value="n">N (Single UPS)</option>
                                <option value="n+1">N+1 Redundancy</option>
                                <option value="2n">2N Redundancy</option>
                                <option value="2n+1">2N+1 Redundancy</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- NEW Button Group -->
                    <div class="form-row" style="gap: 10px; margin-top: 25px;">
                        <button type="button" id="calculate-btn" class="calculate-btn" style="flex: 2;">
                            <i class="fas fa-calculator" style="margin-right: 8px;"></i>Calculate UPS Size
                            <span class="spinner" id="calculate-spinner" style="display:none;"></span>
                        </button>
                        <button type="button" id="reset-calculations-btn" class="calculate-btn" style="flex: 1; background: var(--accent-color); box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);">
                            <i class="fas fa-sync-alt" style="margin-right: 8px;"></i>Reset
                        </button>
                        <button type="button" id="download-pdf-btn" class="calculate-btn" style="flex: 1; background: var(--secondary-color); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);">
                            <i class="fas fa-file-pdf" style="margin-right: 8px;"></i>Download PDF
                        </button>
                    </div>
                </form>
            </div>
            
            <div id="result-container" class="result-container">
                <h3>UPS Sizing Results</h3>
                <div id="load-details-summary">
                    <!-- Load details summary will be inserted here -->
                </div>
                <table class="result-table">
                    <thead>
                        <tr>
                            <th>Parameter</th>
                            <th>Value</th>
                        </tr>
                    </thead>
                    <tbody id="result-table-body">
                    </tbody>
                </table>
                
                <div id="calculation-details" class="math-content">
                    <!-- Calculation steps will be inserted here -->
                </div>
                
                <div class="standard-reference" id="recommendation">
                    <h4>Recommended UPS Configuration</h4>
                    <div id="recommendation-content"></div>
                </div>
                
                <div class="standard-reference" id="standard-reference">
                    Calculations based on IEEE 1100-2005 (Emerald Book) and industry best practices for UPS sizing.
                </div>
            </div>
        </div>
    </main>

    <!-- NEW CONTENT BLOCK for AdSense -->
    <div class="container">
        <div class="content-block" id="ups-guide-content" style="display: none;">
            <h2 class="math-content">Comprehensive Guide to Industrial UPS Sizing & Selection</h2>
            <p>Sizing an Uninterruptible Power Supply (UPS) for an industrial facility is a critical task that goes far beyond just adding up the power ratings of the equipment. A properly sized UPS ensures the continuity of critical processes, prevents data loss, and protects sensitive machinery from power anomalies. An undersized system will fail during an outage, while an oversized system is a significant and unnecessary capital expense. This guide explores the key principles this calculator uses, which are aligned with industry standards like the <strong>IEEE Emerald Book (IEEE 1100)</strong>.</p>

            <h3>1. UPS Sizing: kVA vs. kW</h3>
            <p>A UPS has two primary ratings, and both are critical:</p>
            <ul>
                <li><strong>kVA (Apparent Power):</strong> This is the <strong>voltage-amperage</strong> rating. It defines the maximum current the UPS components (inverter, rectifier) can handle. It is primarily limited by the $I^2R$ (current squared times resistance) heating in the wiring and components.</li>
                <li><strong>kW (Real Power):</strong> This is the to-work" rating. It defines the actual power the UPS can deliver to run the load. This is limited by the size of the DC battery bus and the power conversion capability of the inverter.</li>
            </ul>
            <p>The ratio between them is the <strong>Power Factor (PF)</strong> of the UPS (e.g., $kW = kVA \times PF$). Modern industrial UPS systems are often designed with a high power factor (0.9 or 1.0) to maximize the available real power. You must size your UPS to meet *both* the total kVA and total kW requirements of your load.</p>

            <h3>2. Detailed Load Analysis: The Core of Sizing</h3>
            <p>You cannot simply add up the nameplate ratings of your equipment. A detailed load analysis is essential.</p>
            
            <h4>a. Load Types (kW, kVA, HP, Amps)</h4>
            <p>This calculator correctly converts all your different load types into the two common denominators: kW and kVA.</p>
            <ul>
                <li><strong>kW / W:</strong> Loads like heaters or incandescent lights are resistive. Their kW = kVA (PF = 1.0).</li>
                <li><strong>kVA / VA:</strong> This is the apparent power. We use the load's power factor to find the real power (kW). $kW = kVA \times PF$.</li>
                <li><strong>HP (Horsepower):</strong> This is a measure of mechanical output power. We must convert it to electrical *input* power. $kW_{input} = (HP \times 0.746) / \text{Motor Efficiency}$. Then, $kVA = kW_{input} / \text{Motor PF}$.</li>
                <li><strong>Amps (A):</strong> This is often the most reliable value. We convert it to kVA using the system voltage:
                    <ul>
                        <li><strong>3-Phase:</strong> $kVA = (V_{L-L} \times A \times \sqrt{3}) / 1000$</li>
                        <li><strong>1-Phase:</strong> $kVA = (V_{L-N} \times A) / 1000$</li>
                    </ul>
                </li>
            </ul>

            <h4>b. Inrush Current & Starting Factor</h4>
            <p>This is the most common reason for undersizing a UPS. Many loads draw a massive, temporary surge of current when they first turn on. The UPS inverter must be able to supply this inrush without collapsing.</p>
            <ul>
                <li><strong>Motors (DOL):</strong> A Direct-On-Line motor can draw <strong>6 to 8 times</strong> its normal current during startup (Locked Rotor Amps, LRA).</li>
                <li><strong>Transformers:</strong> Can have an inrush of <strong>10 to 12 times</strong> their rated current.</li>
                <li><strong>Power Supplies (Servers, PLCs):</strong> Have an inrush to charge their internal capacitors.</li>
            </ul>
            <p>The calculator addresses this by calculating the "Peak kVA" for each load and ensuring the UPS can handle the single largest peak in the system.</p>

            <h4>c. Crest Factor (Non-linear Loads)</h4>
            <p>Modern electronic loads like servers, computers, and even LED lighting use "switch-mode power supplies" (SMPS). They don't draw current in a smooth sine wave; instead, they "sip" current at the very peak of the voltage waveform. This creates a high <strong>Crest Factor</strong> (the ratio of peak current to RMS current). While the RMS current (what you pay for) might be low, the peak current can be <strong>2 to 3 times</strong> higher. If the UPS inverter cannot supply this high peak current, its output voltage will distort, and the loads will fail. An industrial UPS must be sized to handle this.</p>
            
            <h3>3. Battery Sizing: The (Amp-Hour) Calculation</h3>
            <p>The battery bank is the "gas tank" of the UPS. Sizing it correctly is just as important as sizing the kVA. The calculation is:</p>
            <div class="formula-block math-content">
                $$ \text{Total Battery Ah} = \frac{P_{load,kW} \times T_{hours}}{V_{DC,bus} \times \eta_{inverter} \times \eta_{battery} \times DoD} $$
            </div>
            <ul>
                <li><strong>$P_{load,kW}$ (Load kW):</strong> The total *real power* (kW) drawn by your loads, including future expansion. Batteries only supply real power.</li>
                <li><strong>$T_{hours}$ (Backup Time):</strong> Your required runtime in hours (e.g., 30 min = 0.5 hours).</li>
                <li><strong>$V_{DC,bus}$ (DC Bus Voltage):</strong> The nominal voltage of the UPS battery bank (e.g., 384V).</li>
                <li><strong>$\eta_{inverter}$ (UPS Efficiency):</strong> The inverter is not 100% efficient. To deliver 100kW to the load, it might draw 108kW from the batteries (at ~92% efficiency).</li>
                <li><strong>$\eta_{battery}$ (Battery Efficiency):</strong> Batteries are also not 100% efficient (e.g., ~85% for VRLA).</li>
                <li><strong>$DoD$ (Depth of Discharge):</strong> You never drain a battery to 0%. This shortens its life. A typical DoD for VRLA batteries is 50-80%, meaning you are only using 50-80% of its total capacity to ensure long life.</li>
            </ul>
            <p>This calculator also determines the <strong>Battery Charging Power</strong>, which is the extra power the UPS must draw from the wall to recharge the batteries after an outage *while simultaneously powering your load*. This total power ($Load + Charging$) is a critical factor in sizing the UPS input breaker and wiring.</p>
            
            <h3>4. Environmental Derating & Redundancy</h3>
            <h4>a. Derating for Heat and Altitude</h4>
            <p>UPS systems are electronics, and they hate heat and thin air. All UPS systems are rated for a specific condition (e.g., 25Â°C at 1000m). If you install them in a hotter or higher location, their ability to cool themselves is reduced, and their power capacity must be derated.</p>
            <ul>
                <li><strong>Temperature:** Installing a UPS in a 40Â°C electrical room (vs. a 25Â°C data center) can reduce its capacity by 15-25%.</li>
                <li><strong>Altitude:** Thin air at high altitudes (e.g., > 1000m) reduces cooling efficiency, also requiring a derating factor.</li>
            </ul>

            <h4>b. Redundancy (N, N+1, 2N)</h4>
            <p>For critical industrial processes, a single UPS is a single point of failure. Redundancy ensures uptime even if one UPS fails.</p>
            <ul>
                <li><strong>N:</strong> The minimum capacity required to run the load (e.g., Load = 80 kVA, UPS = 1x 100 kVA). If it fails, the load is lost.</li>
                <li><strong>N+1:</strong> The most common redundant setup. You have one extra module than needed (e.g., Load = 80 kVA, UPS = 2x 100 kVA modules running in parallel). If one module fails, the other (N) can still carry the full load.</li>
                <li><strong>2N:</strong> The "fully redundant" standard for data centers and critical plants. Two completely independent UPS systems ("A" and "B"), each sized to carry the *full* load. Critical equipment with dual power supplies is fed from both. If the entire "A" system (UPS, breakers, wiring) fails, the "B" system is completely unaffected.</li>
            </ul>
        </div>
    </div>

    <!-- NEW FOOTER -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-col">
                    <h4>Design Calculators</h4>
                    <!-- Updated Text -->
                    <p style="font-size: 0.9rem; line-height: 1.6; margin-bottom: 15px;">
                        If you find this tool helpful, please consider sharing it with your colleagues!
                    </p>
                    <div class="social-buttons">
                        <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn linkedin" aria-label="LinkedIn"><i class="fab fa-linkedin-in"></i></a>
                        <a href="https://www.youtube.com/@designcalculators" target="_blank" rel="noopener noreferrer" class="social-btn youtube" aria-label="YouTube"><i class="fab fa-youtube"></i></a>
                        <a href="https://twitter.com/intent/tweet?url=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn twitter" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
                        <a href="https://www.facebook.com/sharer/sharer.php?u=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn facebook" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
                        <a href="https://api.whatsapp.com/send?text=Check%20out%20this%20amazing%20engineering%20resource:%20https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn whatsapp" aria-label="WhatsApp"><i class="fab fa-whatsapp"></i></a>
                    </div>
                </div>
                <div class="footer-col">
                    <h4>Quick Links</h4>
                    <ul>
                        <li><a href="/">Home</a></li>
                        <li><a href='/indexele'>Electrical</a></li>
                        <li><a href='/indexmech'>Mechanical</a></li>
                        <li><a href='/indexinst'>Instrumentation</a></li>
                        <li><a href='/articles'>Articles</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>Resources</h4>
                    <ul>
                        <li><a href='/about'>About Us</a></li>
                        <li><a href='/contact'>Contact</a></li>
                        <li><a href='/faq'>FAQ</a></li>
                        <li><a href='/privacy-policy'>Privacy Policy</a></li>
                        <li><a href='/terms-of-service'>Terms of Service</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>More</h4>
                    <ul>
                        <!-- Updated Link -->
                        <li><a href="/articles.html">Articles</a></li>
                        <li><a href='/sitemap2'>Sitemap</a></li>
                        <li><a href="https://www.youtube.com/@designcalculators" target="_blank" rel="noopener noreferrer">YouTube Channel</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-disclaimer">
                <p>All calculations are for preliminary design guidance. Always verify results against relevant engineering standards (ISO, ASME, IEC, NEC, IEEE) and manufacturer specifications. Final designs require professional engineering verification considering site-specific conditions.</p>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Design Calculators. Created by <span class="creator-name">A Sharma</span>. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Custom Message Box -->
    <div id="custom-message-box"></div>

    <!-- UPDATED SCRIPT with FIXES -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Get buttons
            const calculateBtn = document.getElementById('calculate-btn');
            const addLoadBtn = document.getElementById('add-load-btn');
            const resetFormBtn = document.getElementById('reset-calculations-btn');
            const downloadPdfBtn = document.getElementById('download-pdf-btn');
            const calculationSpinner = document.getElementById('calculate-spinner');
            
            // Get containers
            const loadsContainer = document.getElementById('loads-container');
            const resultContainer = document.getElementById('result-container');
            const resultTableBody = document.getElementById('result-table-body');
            const recommendationContent = document.getElementById('recommendation-content');
            // *** FIX: Correctly define detailedCalculationsDiv ***
            const calculationDetailsDiv = document.getElementById('calculation-details'); 
            const loadDetailsSummaryDiv = document.getElementById('load-details-summary'); 
            const standardReference = document.getElementById('standard-reference');
            const upsGuideContent = document.getElementById('ups-guide-content'); // Get content block

            // --- Custom Message Box Functionality ---
            function displayMessage(message, type = "info") {
                let messageBox = document.getElementById('custom-message-box');
                
                messageBox.textContent = message;
                messageBox.style.color = 'white'; // Default
                if (type === "error") {
                    messageBox.style.backgroundColor = '#dc3545'; // Red
                } else if (type === "warning") {
                    messageBox.style.backgroundColor = '#ffc107'; // Yellow
                    messageBox.style.color = '#333';
                } else {
                    messageBox.style.backgroundColor = '#28a745'; // Green
                }
                messageBox.classList.add('show');

                // Hide after 5 seconds
                setTimeout(() => {
                    messageBox.classList.remove('show');
                }, 5000);
            }

            // --- Show/hide custom voltage field ---
            document.getElementById('system-voltage').addEventListener('change', function() {
                const customVoltageGroup = document.getElementById('custom-voltage-group');
                if (this.value === 'custom') {
                    customVoltageGroup.style.display = 'block';
                } else {
                    customVoltageGroup.style.display = 'none';
                }
            });
            
            // --- Battery type parameters ---
            const batteryTypes = {
                'VRLA/LA': { unitVoltage: 2, eff: 0.85, dod: 0.5, chargingCRate: 0.1, nominalAhTypical: 200 },
                'Ni-Cd': { unitVoltage: 1.2, eff: 0.75, dod: 0.8, chargingCRate: 0.2, nominalAhTypical: 100 },
                'SMF': { unitVoltage: 12, eff: 0.85, dod: 0.6, chargingCRate: 0.1, nominalAhTypical: 100 },
                'Li-ion': { unitVoltage: 48, eff: 0.95, dod: 0.9, chargingCRate: 0.2, nominalAhTypical: 50 }
            };

            // --- Update load-specific factors ---
            function updateLoadSpecificFactors(loadTypeId, startingFactorId, crestFactorId, powerFactorId) {
                const loadType = document.getElementById(loadTypeId);
                const startingFactor = document.getElementById(startingFactorId);
                const crestFactor = document.getElementById(crestFactorId);
                const powerFactor = document.getElementById(powerFactorId);
                
                loadType.addEventListener('change', function() {
                    switch(this.value) {
                        case 'motor':
                            startingFactor.value = '6';
                            crestFactor.value = '1.41';
                            powerFactor.value = '0.80';
                            break;
                        case 'electronic':
                            startingFactor.value = '1.5';
                            crestFactor.value = '2.5';
                            powerFactor.value = '0.95';
                            break;
                        case 'capacitive':
                            startingFactor.value = '2';
                            crestFactor.value = '1.41';
                            powerFactor.value = '0.1'; // Capacitive loads have low (leading) PF
                            break;
                        case 'resistive':
                            startingFactor.value = '1';
                            crestFactor.value = '1.41';
                            powerFactor.value = '1.0';
                            break;
                        case 'mixed':
                            startingFactor.value = '1.5';
                            crestFactor.value = '1.8';
                            powerFactor.value = '0.85';
                            break;
                        default:
                            startingFactor.value = '1';
                            crestFactor.value = '1.41';
                            powerFactor.value = '0.8';
                    }
                });
            }
            
            // Initialize factors for first load
            updateLoadSpecificFactors('load-type-1', 'starting-factor-1', 'crest-factor-1', 'power-factor-1');
            
            // --- Add new load item ---
            let loadCounter = 1;
            addLoadBtn.addEventListener('click', function() {
                loadCounter++;
                
                const loadItem = document.createElement('div');
                loadItem.className = 'load-item';
                loadItem.dataset.loadId = loadCounter;
                
                loadItem.innerHTML = `
                    <div class="load-item-header">
                        <div class="load-item-title">Load #${loadCounter}</div>
                        <button type="button" class="remove-load-btn"><i class="fas fa-trash"></i> Remove</button>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="load-name-${loadCounter}">Load Description</label>
                            <input type="text" id="load-name-${loadCounter}" placeholder="e.g., Motors, Servers, PLC">
                        </div>
                        <div class="form-group">
                            <label for="load-type-${loadCounter}">Load Type</label>
                            <select id="load-type-${loadCounter}" required>
                                <option value="resistive">Resistive (Heaters, Lighting)</option>
                                <option value="motor">Motors & Drives</option>
                                <option value="electronic" selected>Electronic Equipment</option>
                                <option value="capacitive">Capacitive Loads</option>
                                <option value="mixed">Mixed Loads</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="load-power-${loadCounter}">Power Rating</label>
                            <input type="number" id="load-power-${loadCounter}" min="0" step="0.1" value="1" required>
                        </div>
                        <div class="form-group">
                            <label for="power-unit-${loadCounter}">Unit</label>
                            <select id="power-unit-${loadCounter}" required>
                                <option value="kW" selected>kW</option>
                                <option value="kVA">kVA</option>
                                <option value="W">W</option>
                                <option value="VA">VA</option>
                                <option value="A">A (Amps)</option>
                                <option value="HP">HP (Horsepower)</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="power-factor-${loadCounter}">Power Factor</label>
                            <input type="number" id="power-factor-${loadCounter}" min="0.1" max="1" step="0.01" value="0.95" required>
                        </div>
                        <div class="form-group">
                            <label for="starting-factor-${loadCounter}">Starting Factor</label>
                            <input type="number" id="starting-factor-${loadCounter}" min="1" max="10" step="0.1" value="1.5" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="crest-factor-${loadCounter}">Crest Factor</label>
                            <input type="number" id="crest-factor-${loadCounter}" min="1" max="5" step="0.01" value="2.5" required>
                        </div>
                        <div class="form-group">
                            <label for="duty-cycle-${loadCounter}">Duty Cycle (%)</label>
                            <input type="number" id="duty-cycle-${loadCounter}" min="1" max="100" step="1" value="100" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="quantity-${loadCounter}">Quantity</label>
                            <input type="number" id="quantity-${loadCounter}" min="1" step="1" value="1" required>
                        </div>
                    </div>
                `;
                
                loadsContainer.appendChild(loadItem);
                
                // Initialize factors for new load
                updateLoadSpecificFactors(`load-type-${loadCounter}`, `starting-factor-${loadCounter}`, `crest-factor-${loadCounter}`, `power-factor-${loadCounter}`);
            });
            
            // --- Remove load item ---
            loadsContainer.addEventListener('click', function(e) {
                // Find the closest button (works for icon click too)
                const removeBtn = e.target.closest('.remove-load-btn');
                if (removeBtn) {
                    const loadItem = removeBtn.closest('.load-item');
                    if (loadItem.dataset.loadId !== "1") { // Don't remove the first load
                        loadItem.remove();
                    } else {
                        displayMessage("The first load item cannot be removed.", "warning");
                    }
                }
            });

            // --- Helper function to add rows ---
            function addResultRow(parameter, value) {
                const tr = document.createElement('tr');
                const paramCell = document.createElement('td');
                const valueCell = document.createElement('td');
                paramCell.innerHTML = parameter; // Use innerHTML to allow <strong>
                valueCell.innerHTML = value;   // Use innerHTML to allow <strong>
                tr.appendChild(paramCell);
                tr.appendChild(valueCell);
                resultTableBody.appendChild(tr);
            }

            // --- Helper function to clear results ---
            function clearResults() {
                resultContainer.classList.remove('show');
                upsGuideContent.classList.remove('show'); // Hide content block
                
                // Hide and clear results
                setTimeout(() => {
                    if (!resultContainer.classList.contains('show')) {
                        resultTableBody.innerHTML = '';
                        calculationDetailsDiv.innerHTML = '';
                        loadDetailsSummaryDiv.innerHTML = '';
                        recommendationContent.innerHTML = '';
                        resultContainer.style.display = 'none';
                    }
                }, 500); // Wait for fade-out
            }

            // --- Reset Form Function ---
            function resetForm() {
                // Reset system parameters
                document.getElementById('system-voltage').value = '415';
                document.getElementById('custom-voltage-group').style.display = 'none';
                document.getElementById('custom-voltage').value = '';
                document.getElementById('phase-type').value = 'three';
                document.getElementById('backup-time').value = '30';
                document.getElementById('future-expansion').value = '25';
                document.getElementById('ups-efficiency').value = '92';
                document.getElementById('ups-type').value = 'online';
                document.getElementById('dc-bus-voltage').value = '384';
                document.getElementById('battery-type').value = 'VRLA/LA';
                document.getElementById('ambient-temp').value = '25';
                document.getElementById('altitude').value = '0';
                document.getElementById('environment-type').value = 'clean';
                document.getElementById('redundancy').value = 'n';

                // Remove all load items except the first one
                const allLoadItems = document.querySelectorAll('.load-item');
                allLoadItems.forEach(item => {
                    if (item.dataset.loadId !== '1') {
                        item.remove();
                    }
                });

                // Reset the first load item
                document.getElementById('load-name-1').value = '';
                document.getElementById('load-type-1').value = 'resistive';
                document.getElementById('load-power-1').value = '10';
                document.getElementById('power-unit-1').value = 'kW';
                document.getElementById('power-factor-1').value = '0.8';
                document.getElementById('starting-factor-1').value = '1';
                document.getElementById('crest-factor-1').value = '1.41';
                document.getElementById('duty-cycle-1').value = '100';
                document.getElementById('quantity-1').value = '1';
                
                // Manually trigger the change event to reset dependent fields
                document.getElementById('load-type-1').dispatchEvent(new Event('change'));

                // Reset load counter
                loadCounter = 1;

                // Clear results
                clearResults();
                displayMessage("Form has been reset to default values.", "info");
            }
            
            // --- Main Calculation Function ---
            function calculateUPSSize() {
                calculationSpinner.style.display = 'inline-block';
                calculateBtn.disabled = true;

                // Clear previous results immediately
                resultContainer.classList.remove('show');
                upsGuideContent.classList.remove('show');
                resultTableBody.innerHTML = '';
                calculationDetailsDiv.innerHTML = '';
                loadDetailsSummaryDiv.innerHTML = '';
                recommendationContent.innerHTML = '';
                resultContainer.style.display = 'none';

                setTimeout(() => {
                    try {
                        // --- 1. Get System Parameters ---
                        let systemVoltage = document.getElementById('system-voltage').value;
                        if (systemVoltage === 'custom') {
                            systemVoltage = document.getElementById('custom-voltage').value;
                        }
                        systemVoltage = parseFloat(systemVoltage);
                        
                        const phaseType = document.getElementById('phase-type').value;
                        const backupTime = parseFloat(document.getElementById('backup-time').value);
                        const futureExpansion = parseFloat(document.getElementById('future-expansion').value) / 100;
                        const upsEfficiency = parseFloat(document.getElementById('ups-efficiency').value) / 100;
                        const upsType = document.getElementById('ups-type').value;
                        const ambientTemp = parseFloat(document.getElementById('ambient-temp').value);
                        const altitude = parseFloat(document.getElementById('altitude').value);
                        const environmentType = document.getElementById('environment-type').value;
                        const redundancy = document.getElementById('redundancy').value;
                        const dcBusVoltage = parseFloat(document.getElementById('dc-bus-voltage').value);
                        const batteryTypeSelected = document.getElementById('battery-type').value;
                        
                        // Validate system inputs
                        if (!systemVoltage || systemVoltage <= 0) throw new Error("System Voltage must be a positive number.");
                        if (backupTime <= 0) throw new Error("Backup Time must be a positive number.");
                        if (upsEfficiency <= 0.7 || upsEfficiency > 1) throw new Error("UPS Efficiency must be between 70% and 100%.");
                        if (dcBusVoltage <= 0) throw new Error("DC Bus Voltage must be a positive number.");
                        
                        const batteryParameters = batteryTypes[batteryTypeSelected];
                        const { unitVoltage: batteryUnitVoltage, eff: batteryEfficiency, dod: depthOfDischarge, chargingCRate, nominalAhTypical } = batteryParameters;
                        
                        // --- 2. Process Loads ---
                        const loadItems = document.querySelectorAll('.load-item');
                        let totalPowerKW = 0;
                        let totalPowerKVA = 0;
                        let peakPowerKVA = 0;
                        let totalCurrentA = 0;
                        let loadDetails = [];
                        let calculationHtml = '<h3>Detailed Calculation Steps:</h3>';
                        let loadDetailsHtml = '<h4>Load Details Summary:</h4><table class="result-table"><thead><tr><th>Load</th><th>Type</th><th>Power (kW)</th><th>Power (kVA)</th><th>Peak (kVA)</th><th>RMS Current (A)</th><th>Peak Current (A)</th></tr></thead><tbody>';
                        
                        calculationHtml += `<p><strong>1. Calculate Total Connected Load:</strong></p>`;
                        
                        for (const item of loadItems) {
                            const loadId = item.dataset.loadId;
                            const loadPower = parseFloat(document.getElementById(`load-power-${loadId}`).value);
                            const powerUnit = document.getElementById(`power-unit-${loadId}`).value;
                            const powerFactor = parseFloat(document.getElementById(`power-factor-${loadId}`).value);
                            const startingFactor = parseFloat(document.getElementById(`starting-factor-${loadId}`).value);
                            const crestFactor = parseFloat(document.getElementById(`crest-factor-${loadId}`).value);
                            const dutyCycle = parseFloat(document.getElementById(`duty-cycle-${loadId}`).value) / 100;
                            const quantity = parseFloat(document.getElementById(`quantity-${loadId}`).value);
                            const loadName = document.getElementById(`load-name-${loadId}`).value || `Load #${loadId}`;
                            const loadType = document.getElementById(`load-type-${loadId}`).value;
                            
                            if (isNaN(loadPower) || loadPower < 0 || isNaN(powerFactor) || powerFactor <= 0 || powerFactor > 1 || isNaN(startingFactor) || startingFactor < 1 || isNaN(crestFactor) || crestFactor < 1 || isNaN(dutyCycle) || dutyCycle <= 0 || dutyCycle > 1 || isNaN(quantity) || quantity <= 0) {
                                throw new Error(`Invalid data for ${loadName}. Please check all fields.`);
                            }
                            
                            let powerKW = 0;
                            let powerKVA = 0;
                            
                            switch(powerUnit) {
                                case 'kW':
                                    powerKW = loadPower;
                                    powerKVA = loadPower / powerFactor;
                                    break;
                                case 'kVA':
                                    powerKVA = loadPower;
                                    powerKW = loadPower * powerFactor;
                                    break;
                                case 'W':
                                    powerKW = loadPower / 1000;
                                    powerKVA = powerKW / powerFactor;
                                    break;
                                case 'VA':
                                    powerKVA = loadPower / 1000;
                                    powerKW = powerKVA * powerFactor;
                                    break;
                                case 'A':
                                    powerKVA = (phaseType === 'single' ? (loadPower * systemVoltage) / 1000 : (loadPower * systemVoltage * Math.sqrt(3)) / 1000);
                                    powerKW = powerKVA * powerFactor;
                                    break;
                                case 'HP':
                                    powerKW = loadPower * 0.746; // Output Power
                                    powerKW = powerKW / 0.85; // Approx. input power, assuming 85% motor eff
                                    powerKVA = powerKW / powerFactor;
                                    break;
                            }
                            
                            const runningPowerKW = powerKW * dutyCycle * quantity;
                            const runningPowerKVA = powerKVA * dutyCycle * quantity;
                            
                            const peakKVAFromStarting = runningPowerKVA * startingFactor; // Peak from inrush
                            const peakKVAFromCrest = runningPowerKVA * (crestFactor / 1.414); // Peak from non-linearity
                            const peakPowerKVAForLoad = Math.max(peakKVAFromStarting, peakKVAFromCrest);

                            totalPowerKW += runningPowerKW;
                            totalPowerKVA += runningPowerKVA;
                            
                            if (peakPowerKVAForLoad > peakPowerKVA) {
                                peakPowerKVA = peakPowerKVAForLoad; // We are interested in the *single largest* peak load
                            }
                            
                            let currentA_rms = (phaseType === 'single') ? (runningPowerKVA * 1000) / systemVoltage : (runningPowerKVA * 1000) / (systemVoltage * Math.sqrt(3));
                            totalCurrentA += currentA_rms;
                            const peakCurrentA_load = currentA_rms * crestFactor;
                            
                            loadDetails.push({ name: loadName, type: loadType, powerKW: runningPowerKW, powerKVA: runningPowerKVA, peakKVA: peakPowerKVAForLoad, currentRMS: currentA_rms, currentPeak: peakCurrentA_load });
                            
                            calculationHtml += `<p class="calculation-step"><strong>Load #${loadId} (${loadName}):</strong> Running: ${runningPowerKW.toFixed(2)} kW / ${runningPowerKVA.toFixed(2)} kVA. Peak: ${peakPowerKVAForLoad.toFixed(2)} kVA.</p>`;
                            loadDetailsHtml += `<tr><td>${loadName}</td><td>${loadType}</td><td>${runningPowerKW.toFixed(2)}</td><td>${runningPowerKVA.toFixed(2)}</td><td>${peakPowerKVAForLoad.toFixed(2)}</td><td>${currentA_rms.toFixed(2)}</td><td>${peakCurrentA_load.toFixed(2)}</td></tr>`;
                        }
                        
                        loadDetailsHtml += '</tbody></table>';
                        
                        // --- 3. UPS Sizing ---
                        const designPowerKW_for_load = totalPowerKW * (1 + futureExpansion);
                        const designPowerKVA_for_load = totalPowerKVA * (1 + futureExpansion);
                        
                        calculationHtml += `<p><strong>2. Apply Future Expansion Factor (for Load):</strong></p>`;
                        calculationHtml += `<p class="formula">$$P_{\\text{design, load, kW}} = P_{\\text{total, kW}} \\times (1 + \\text{Future Expansion})$$</p>`;
                        calculationHtml += `<p class="calculation-step">P_design_load_kW = ${totalPowerKW.toFixed(2)} kW Ã (1 + ${futureExpansion}) = ${designPowerKW_for_load.toFixed(2)} kW</p>`;
                        calculationHtml += `<p class="formula">$$S_{\\text{design, load, kVA}} = S_{\\text{total, kVA}} \\times (1 + \\text{Future Expansion})$$</p>`;
                        calculationHtml += `<p class="calculation-step">S_design_load_kVA = ${totalPowerKVA.toFixed(2)} kVA Ã (1 + ${futureExpansion}) = ${designPowerKVA_for_load.toFixed(2)} kVA</p>`;

                        // --- 4. Battery Sizing ---
                        const backupTimeHours = backupTime / 60;
                        const energyRequiredKWH_output = designPowerKW_for_load / upsEfficiency; // Energy from battery must account for inverter efficiency
                        
                        const requiredBatteryEnergyWh_raw = (energyRequiredKWH_output * 1000 * backupTimeHours) / (batteryEfficiency * depthOfDischarge);
                        const requiredBatteryAhAtDCBus = requiredBatteryEnergyWh_raw / dcBusVoltage;
                        const numSeriesUnitsPerString = Math.ceil(dcBusVoltage / batteryUnitVoltage);
                        const numParallelStrings = Math.ceil(requiredBatteryAhAtDCBus / nominalAhTypical);
                        const totalBatteriesNeeded = numSeriesUnitsPerString * numParallelStrings;
                        const finalBatteryAh = numParallelStrings * nominalAhTypical; // The actual installed Ah

                        calculationHtml += `<p><strong>3. Calculate Battery Capacity:</strong></p>`;
                        calculationHtml += `<p class="formula">$$E_{\\text{required, inverter input}} = \\frac{P_{\\text{design, load, kW}}}{\\eta_{UPS}}$$</p>`;
                        calculationHtml += `<p class="calculation-step">E_required = ${designPowerKW_for_load.toFixed(2)} kW / ${upsEfficiency} = ${energyRequiredKWH_output.toFixed(2)} kW</p>`;
                        
                        calculationHtml += `<p class="formula">$$C_{\\text{Ah}} = \\frac{E_{\\text{required}} \\times T_{hours} \\times 1000}{V_{DC,bus} \\times \\eta_{battery} \\times DoD}$$</p>`;
                        calculationHtml += `<p class="calculation-step">C_Ah = (${energyRequiredKWH_output.toFixed(2)} kW Ã ${backupTimeHours.toFixed(2)}h Ã 1000) / (${dcBusVoltage}V Ã ${batteryEfficiency} Ã ${depthOfDischarge}) = ${requiredBatteryAhAtDCBus.toFixed(2)} Ah</p>`;
                        
                        calculationHtml += `<p class="calculation-step">Series Units/String = ceil(${dcBusVoltage}V / ${batteryUnitVoltage}V) = ${numSeriesUnitsPerString}</p>`;
                        calculationHtml += `<p class="calculation-step">Parallel Strings = ceil(${requiredBatteryAhAtDCBus.toFixed(2)}Ah / ${nominalAhTypical}Ah) = ${numParallelStrings}</p>`;
                        calculationHtml += `<p class="calculation-step">Total Batteries = ${numSeriesUnitsPerString} Ã ${numParallelStrings} = ${totalBatteriesNeeded} units (${batteryUnitVoltage}V / ${nominalAhTypical}Ah each)</p>`;
                        calculationHtml += `<p class="calculation-step">Final Battery Bank Rating: <strong>${finalBatteryAh.toFixed(0)} Ah</strong> at <strong>${dcBusVoltage}V</strong></p>`;

                        // --- 5. Charger & Total kVA Sizing ---
                        const peakChargingCurrent = finalBatteryAh * chargingCRate;
                        const chargingPowerDC_kW = (peakChargingCurrent * dcBusVoltage) / 1000;
                        const chargerEfficiencyACtoDC = 0.9, chargerPowerFactor = 0.95;
                        const chargingPowerAC_kW = chargingPowerDC_kW / chargerEfficiencyACtoDC;
                        const chargingPowerAC_kVA = chargingPowerAC_kW / chargerPowerFactor;
                        
                        calculationHtml += `<p><strong>4. Calculate UPS Charging Power:</strong></p>`;
                        calculationHtml += `<p class="calculation-step">Charging Power (kVA) = ${chargingPowerAC_kVA.toFixed(2)} kVA (to recharge ${finalBatteryAh.toFixed(0)} Ah bank)</p>`;

                        const totalRequiredKVA_for_ups_output = designPowerKVA_for_load + chargingPowerAC_kVA;
                        const totalRequiredKW_for_ups_output = designPowerKW_for_load + chargingPowerAC_kW;
                        
                        calculationHtml += `<p><strong>5. Calculate Total UPS Power:</strong></p>`;
                        calculationHtml += `<p class="formula">$$S_{UPS, total} = S_{\\text{design, load, kVA}} + S_{\\text{charging, kVA}}$$</p>`;
                        calculationHtml += `<p class="calculation-step">S_UPS_total = ${designPowerKVA_for_load.toFixed(2)} kVA + ${chargingPowerAC_kVA.toFixed(2)} kVA = ${totalRequiredKVA_for_ups_output.toFixed(2)} kVA</p>`;

                        // --- 6. Derating & Final Sizing ---
                        let altitudeDeratingFactor = 1.0;
                        if (altitude > 1000) altitudeDeratingFactor = 1.0 - ((altitude - 1000) / 100) * 0.01;
                        let tempDeratingFactor = 1.0;
                        if (ambientTemp > 25) tempDeratingFactor = 1.0 - ((ambientTemp - 25) * 0.015);
                        let environmentDeratingFactor = (environmentType === 'industrial') ? 0.95 : (environmentType === 'harsh') ? 0.90 : (environmentType === 'outdoor') ? 0.85 : 1.0;
                        
                        const combinedDeratingFactor = altitudeDeratingFactor * tempDeratingFactor * environmentDeratingFactor;
                        if(combinedDeratingFactor <= 0) throw new Error("Environmental conditions are too extreme, resulting in an invalid derating factor.");
                        
                        // UPS must be sized to handle the LARGEST of:
                        // 1. The derated continuous load (kVA)
                        // 2. The single largest peak load (kVA)
                        const finalUpsKVA_continuous = totalRequiredKVA_for_ups_output / combinedDeratingFactor;
                        const finalUpsKVA = Math.max(finalUpsKVA_continuous, peakPowerKVA);

                        calculationHtml += `<p><strong>6. Apply Environmental Derating Factors:</strong></p>`;
                        calculationHtml += `<p class="calculation-step">Altitude (${altitude}m) Factor: ${altitudeDeratingFactor.toFixed(2)}</p>`;
                        calculationHtml += `<p class="calculation-step">Temperature (${ambientTemp}Â°C) Factor: ${tempDeratingFactor.toFixed(2)}</p>`;
                        calculationHtml += `<p class="calculation-step">Environment (${environmentType}) Factor: ${environmentDeratingFactor.toFixed(2)}</p>`;
                        calculationHtml += `<p class="formula">$$S_{\\text{UPS, cont.}} = \\frac{S_{\\text{UPS, total}}}{\\text{Combined Derating Factor}}$$</p>`;
                        calculationHtml += `<p class="calculation-step">S_UPS_cont. = ${totalRequiredKVA_for_ups_output.toFixed(2)} kVA / ${combinedDeratingFactor.toFixed(2)} = ${finalUpsKVA_continuous.toFixed(2)} kVA</p>`;
                        calculationHtml += `<p class="formula">$$S_{\\text{UPS, final}} = \\max(S_{\\text{UPS, cont.}}, S_{\\text{Peak Load}})$$</p>`;
                        calculationHtml += `<p class="calculation-step">S_UPS_final = max(${finalUpsKVA_continuous.toFixed(2)} kVA, ${peakPowerKVA.toFixed(2)} kVA) = ${finalUpsKVA.toFixed(2)} kVA</p>`;


                        // --- 7. Redundancy & Final Selection ---
                        let redundancyFactor = 1;
                        let redundancyConfig = `1 x ${Math.ceil(finalUpsKVA)} kVA UPS (N)`;
                        switch(redundancy) {
                            case 'n+1': redundancyFactor = 2; redundancyConfig = `2 x ${Math.ceil(finalUpsKVA)} kVA UPS units (N+1)`; break;
                            case '2n': redundancyFactor = 2; redundancyConfig = `2 x ${Math.ceil(finalUpsKVA)} kVA UPS systems (2N)`; break;
                            case '2n+1': redundancyFactor = 3; redundancyConfig = `3 x ${Math.ceil(finalUpsKVA)} kVA UPS systems (2N+1)`; break;
                        }
                        
                        const standardUpsSizes = [1, 2, 3, 5, 6, 8, 10, 15, 20, 30, 40, 50, 60, 80, 100, 120, 160, 200, 250, 300, 400, 500, 600, 800, 1000];
                        let recommendedUpsSize = standardUpsSizes.find(size => size >= finalUpsKVA) || standardUpsSizes[standardUpsSizes.length - 1];
                        
                        // Final redundancy config based on standard size
                        switch(redundancy) {
                            case 'n+1': redundancyConfig = `2 x ${recommendedUpsSize} kVA UPS units (N+1)`; break;
                            case '2n': redundancyConfig = `2 x ${recommendedUpsSize} kVA UPS systems (2N)`; break;
                            case '2n+1': redundancyConfig = `3 x ${recommendedUpsSize} kVA UPS systems (2N+1)`; break;
                            default: redundancyConfig = `1 x ${recommendedUpsSize} kVA UPS unit (N)`;
                        }

                        calculationHtml += `<p><strong>7. Apply Redundancy & Select Standard Size:</strong></p>`;
                        calculationHtml += `<p class="calculation-step">Redundancy Configuration: ${redundancy.toUpperCase()}</p>`;
                        calculationHtml += `<p class="calculation-step">Recommended Standard UPS Size (per module): ${recommendedUpsSize} kVA</p>`;
                        
                        // --- 8. Populate UI ---
                        calculationDetailsDiv.innerHTML = calculationHtml;
                        if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
                            window.MathJax.typesetPromise([calculationDetailsDiv]).catch(err => console.error("MathJax Error:", err));
                        }
                        
                        loadDetailsSummaryDiv.innerHTML = loadDetailsHtml;
                        
                        addResultRow('<strong>Recommended UPS Size (Per Module)</strong>', `<strong>${recommendedUpsSize} kVA</strong>`);
                        addResultRow('<strong>Final UPS Configuration</strong>', `<strong>${redundancyConfig}</strong>`);
                        addResultRow('<strong>Required Battery Capacity</strong>', `<strong>${finalBatteryAh.toFixed(0)} Ah @ ${dcBusVoltage} V</strong>`);
                        addResultRow('Total Batteries Needed', `${totalBatteriesNeeded} units (${batteryUnitVoltage}V / ${nominalAhTypical}Ah)`);
                        addResultRow('---', '---');
                        addResultRow('Total Connected Load', `${totalPowerKW.toFixed(2)} kW / ${totalPowerKVA.toFixed(2)} kVA`);
                        addResultRow('Design Load (with Expansion)', `${designPowerKW_for_load.toFixed(2)} kW / ${designPowerKVA_for_load.toFixed(2)} kVA`);
                        addResultRow('Peak Load (Inrush/Crest)', `${peakPowerKVA.toFixed(2)} kVA`);
                        addResultRow('Battery Charging Power', `${chargingPowerAC_kVA.toFixed(2)} kVA`);
                        addResultRow('Total Required UPS Power (Load + Charging)', `${totalRequiredKVA_for_ups_output.toFixed(2)} kVA`);
                        addResultRow('Environmental Derating Factor', `${combinedDeratingFactor.toFixed(2)}`);
                        addResultRow('Final Adjusted UPS Size (Pre-Standard)', `${finalUpsKVA.toFixed(2)} kVA`);
                        addResultRow('UPS Technology', `${upsType.charAt(0).toUpperCase() + upsType.slice(1)}`);
                        addResultRow('Required Backup Time', `${backupTime} minutes`);
                        
                        // Recommendation content
                        let techRecommendation = (upsType === 'online') ? 'Online/Double Conversion UPS is recommended for critical industrial applications.' : 'Line Interactive or Standby UPS are suitable for less critical loads.';
                        recommendationContent.innerHTML = `
                            <p><strong>UPS Size:</strong> ${redundancyConfig}</p>
                            <p><strong>Technology:</strong> ${techRecommendation}</p>
                            <p><strong>Battery System:</strong> A <strong>${finalBatteryAh.toFixed(0)} Ah</strong> bank at <strong>${dcBusVoltage}V</strong> is required, composed of <strong>${totalBatteriesNeeded}</strong> individual ${batteryTypeSelected} units.</p>
                        `;
                        
                        standardReference.innerHTML = `Calculations based on <strong>IEEE 1100-2005 (Emerald Book)</strong> and industry best practices for UPS sizing, accounting for load types, inrush, and environmental factors.`;

                        // Show results
                        resultContainer.style.display = 'block';
                        setTimeout(() => {
                            resultContainer.classList.add('show');
                            upsGuideContent.classList.add('show'); // Show content block
                            resultContainer.scrollIntoView({ behavior: 'smooth' });
                        }, 10);

                    } catch (error) {
                        displayMessage(error.message, "error");
                    } finally {
                        calculationSpinner.style.display = 'none';
                        calculateBtn.disabled = false;
                    }
                }, 500); // 500ms delay
            }

            // --- PDF Generation for UPS ---
            function downloadPDF() {
                if (!resultContainer.classList.contains('show')) {
                    displayMessage("Please run a calculation first to generate a report.", "error");
                    return;
                }
                displayMessage("Generating PDF... Please wait.", "info");

                try {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    let currentY = 10;
                    
                    const addHeaderFooter = (page, pageCount) => {
                        pdf.setPage(page);
                        pdf.setFont("helvetica", "bold");
                        pdf.setFontSize(16);
                        pdf.setTextColor(30, 58, 138); // var(--primary-color)
                        pdf.text("https://designcalculators.co.in", pdfWidth / 2, 15, { align: 'center' });
                        
                        pdf.setFontSize(8);
                        pdf.setTextColor(150, 150, 150);
                        pdf.text(`Page ${page} of ${pageCount}`, pdfWidth / 2, pdfHeight - 15, { align: 'center' });
                        pdf.text("https://designcalculators.co.in", pdfWidth / 2, pdfHeight - 10, { align: 'center' });
                    };

                    // --- PDF Content ---
                    currentY = 25; // Start after header
                    pdf.setFont("helvetica", "bold");
                    pdf.setFontSize(18);
                    pdf.setTextColor(30, 58, 138);
                    pdf.text("Industrial UPS Sizing Report", pdfWidth / 2, currentY, { align: 'center' });
                    currentY += 10;
                    
                    pdf.setFont("helvetica", "normal");
                    pdf.setFontSize(10);
                    pdf.setTextColor(100, 100, 100);
                    pdf.text(`Generated on: ${new Date().toLocaleString()}`, pdfWidth / 2, currentY, { align: 'center' });
                    currentY += 15;

                    // --- 1. Input Parameters ---
                    pdf.setFont("helvetica", "bold");
                    pdf.setFontSize(14);
                    pdf.setTextColor(30, 58, 138);
                    pdf.text("Input Parameters", 10, currentY);
                    currentY += 8;
                    
                    pdf.setFont("helvetica", "normal");
                    pdf.setFontSize(10);
                    pdf.setTextColor(0, 0, 0);
                    
                    let systemVoltage = document.getElementById('system-voltage').value;
                    if (systemVoltage === 'custom') systemVoltage = document.getElementById('custom-voltage').value;
                    const phaseType = document.getElementById('phase-type').value;
                    const backupTime = document.getElementById('backup-time').value;
                    const futureExpansion = document.getElementById('future-expansion').value;
                    const upsEfficiency = document.getElementById('ups-efficiency').value;
                    const dcBusVoltage = document.getElementById('dc-bus-voltage').value;
                    const batteryType = document.getElementById('battery-type').value;
                    const redundancy = document.getElementById('redundancy').value;
                    
                    pdf.text(`System Voltage: ${systemVoltage} V`, 14, currentY);
                    pdf.text(`System Type: ${phaseType}`, pdfWidth / 2, currentY);
                    currentY += 6;
                    pdf.text(`Backup Time: ${backupTime} min`, 14, currentY);
                    pdf.text(`Future Expansion: ${futureExpansion} %`, pdfWidth / 2, currentY);
                    currentY += 6;
                    pdf.text(`UPS Efficiency: ${upsEfficiency} %`, 14, currentY);
                    pdf.text(`DC Bus Voltage: ${dcBusVoltage} V`, pdfWidth / 2, currentY);
                    currentY += 6;
                    pdf.text(`Battery Type: ${batteryType}`, 14, currentY);
                    pdf.text(`Redundancy: ${redundancy.toUpperCase()}`, pdfWidth / 2, currentY);
                    currentY += 10;

                    // --- 2. Load Summary ---
                    const loadTable = document.getElementById('load-details-summary').querySelector('table');
                    if (loadTable && pdf.autoTable) {
                        pdf.setFont("helvetica", "bold");
                        pdf.setFontSize(14);
                        pdf.setTextColor(30, 58, 138);
                        pdf.text("Load Summary", 10, currentY);
                        currentY += 8;
                        pdf.autoTable({
                            html: loadTable,
                            startY: currentY,
                            theme: 'grid',
                            headStyles: { fillColor: [30, 58, 138] },
                            didDrawPage: (data) => addHeaderFooter(data.pageNumber, pdf.internal.getNumberOfPages()),
                        });
                        currentY = pdf.autoTable.previous.finalY + 10;
                    }

                    // --- 3. Final Sizing Results ---
                    const resultTable = document.getElementById('result-table-body').closest('table');
                    if (resultTable && pdf.autoTable) {
                        if (currentY + 20 > pdfHeight - 20) { // Check for page break
                            pdf.addPage();
                            currentY = 25;
                        }
                        pdf.setFont("helvetica", "bold");
                        pdf.setFontSize(14);
                        pdf.setTextColor(30, 58, 138);
                        pdf.text("Final Sizing Results", 10, currentY);
                        currentY += 8;
                        pdf.autoTable({
                            html: resultTable,
                            startY: currentY,
                            theme: 'grid',
                            headStyles: { fillColor: [30, 58, 138] },
                            didDrawPage: (data) => addHeaderFooter(data.pageNumber, pdf.internal.getNumberOfPages()),
                        });
                        currentY = pdf.autoTable.previous.finalY + 10;
                    }

                    // --- 4. Recommendation ---
                    const recommendation = document.getElementById('recommendation-content').innerHTML;
                    if (recommendation) {
                        if (currentY + 20 > pdfHeight - 20) { // Check for page break
                            pdf.addPage();
                            currentY = 25;
                        }
                        pdf.setFont("helvetica", "bold");
                        pdf.setFontSize(14);
                        pdf.setTextColor(30, 58, 138);
                        pdf.text("Recommendations", 10, currentY);
                        currentY += 8;
                        
                        pdf.setFont("helvetica", "normal");
                        pdf.setFontSize(10);
                        pdf.setTextColor(0, 0, 0);
                        
                        // Split and wrap text
                        const lines = pdf.splitTextToSize(recommendation.replace(/<[^>]+>/g, '\n').replace(/\n\n/g, '\n'), pdfWidth - 20);
                        lines.forEach(line => {
                             if (currentY + 5 > pdfHeight - 20) {
                                pdf.addPage();
                                currentY = 25;
                            }
                            pdf.text(line.trim(), 10, currentY);
                            currentY += 5;
                        });
                    }
                    
                    // Add first page header/footer
                    addHeaderFooter(1, pdf.internal.getNumberOfPages());
                    
                    pdf.save('UPS-Sizing-Report.pdf');
                } catch (e) {
                    displayMessage("Error generating PDF. See console for details.", "error");
                    console.error("PDF Generation Error: ", e);
                }
            }

            // --- Add Event Listeners ---
            calculateBtn.addEventListener('click', calculateUPSSize);
            resetFormBtn.addEventListener('click', resetForm);
            downloadPdfBtn.addEventListener('click', downloadPDF);

            // --- Theme switch logic ---
            const themeSwitch = document.getElementById('theme-switch');
            if (themeSwitch) {
                if (localStorage.getItem('theme') === 'dark') {
                    document.body.classList.add('dark-mode');
                    themeSwitch.checked = true;
                }
                themeSwitch.addEventListener('change', function() {
                    if (this.checked) {
                        document.body.classList.add('dark-mode');
                        localStorage.setItem('theme', 'dark');
                    } else {
                        document.body.classList.remove('dark-mode');
                        localStorage.setItem('theme', 'light');
                    }
                });
            }
            
            // Initial setup
            // These lines were causing an error as they are not defined in this file.
            // updateUnitLabelsAndTooltips(unitSystemSelect.value);
            // unitSystemSelect.addEventListener('change', (e) => updateUnitLabelsAndTooltips(e.target.value));

        });
    </script>
</body>
</html>
