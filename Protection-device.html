<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-23Y1V450SR"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-23Y1V450SR');      
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Electrical Protective Device Selector - Design Calculators - Electrical</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- MathJax for LaTeX rendering (not directly used in this version but kept for consistency) -->
    <script type="text/javascript" id="MathJax-script" async
      src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
    </script>
    <style>
        /* Basic CSS Variables for a consistent theme from the provided file */
        :root {
            --primary-color: #4CAF50; /* Green */
            --secondary-color: #45a049; /* Darker Green */
            --accent-color: #FFC107; /* Amber */
            --bg-color: #f4f7f6; /* Light Greyish Green */
            --card-bg: #ffffff; /* White */
            --text-color: #333333; /* Dark Grey */
            --header-bg: #2C3E50; /* Dark Blue Grey */
            --footer-bg: #34495E; /* Slightly Lighter Dark Blue Grey */
            --border-color: #cccccc;
            --card-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            --hover-color: #e2e6ea;
        }

        /* Dark Mode Variables */
        body.dark-mode {
            --bg-color: #2c3e50;
            --card-bg: #34495e;
            --text-color: #ecf0f1;
            --header-bg: #2c3e50;
            --footer-bg: #2c3e50;
            --border-color: #555555;
            --card-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            --hover-color: #446688;
        }

        /* General Body Styling */
        body {
            font-family: 'Inter', sans-serif; /* Using Inter as specified */
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 960px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: var(--header-bg);
            color: white;
            padding: 20px 0;
            text-align: center;
            box-shadow: var(--card-shadow);
            position: relative; /* For theme toggle positioning */
        }

        header h1 {
            margin: 0;
            font-size: 2.5em;
            color: var(--primary-color);
        }

        header .subtitle {
            margin: 5px 0 0;
            font-size: 1em;
            color: #bdc3c7;
        }

        main {
            padding: 20px 0;
        }

        .tool-container {
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 20px;
            box-shadow: var(--card-shadow);
            margin-bottom: 20px;
            transition: transform 0.3s ease-out, box-shadow 0.3s ease-out; /* Animation */
        }

        .tool-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }

        .tool-container h2 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            margin-top: 0;
            margin-bottom: 20px;
        }
        /* Ensure H2 is visible in dark mode */
        body.dark-mode .tool-container h2 {
            color: var(--text-color); /* Explicitly set to white for visibility */
            border-bottom-color: var(--primary-color);
        }

        .tool-description {
            margin-bottom: 20px;
            color: var(--text-color);
        }

        /* Theme Toggle */
        .theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
        }

        .theme-toggle .light-icon,
        .theme-toggle .dark-icon {
            color: white;
            margin: 0 5px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
        }

        input:checked + .slider {
            background-color: var(--primary-color);
        }

        input:focus + .slider {
            box-shadow: 0 0 1px var(--primary-color);
        }

        input:checked + .slider:before {
            -webkit-transform: translateX(26px);
            -ms-transform: translateX(26px);
            transform: translateX(26px);
        }

        /* Rounded sliders */
        .slider.round {
            border-radius: 34px;
        }

        .slider.round:before {
            border-radius: 50%;
        }

        /* Footer Styling */
        footer {
            background-color: var(--footer-bg);
            color: white;
            padding: 20px 0;
            text-align: center;
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1);
            margin-top: 30px;
        }

        footer .disclaimer h3,
        footer .social-share h3 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        footer .disclaimer p {
            font-size: 0.9em;
            color: #bdc3c7;
        }

        .social-buttons {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .social-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            color: white;
            text-decoration: none;
            font-size: 1.2em;
            transition: transform 0.3s ease-in-out;
        }

        .social-btn:hover {
            transform: translateY(-3px);
        }

        .social-btn.linkedin { background-color: #0A66C2; }
        .social-btn.facebook { background-color: #1877F2; }
        .social-btn.twitter { background-color: #1DA1F2; }
        .social-btn.whatsapp { background-color: #25D366; }
        .social-btn.reddit { background-color: #FF4500; }

        /* Styles for Calculator Form (Input Form) */
        .calculator-form {
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: var(--card-shadow);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--text-color); /* Ensure label text is visible */
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2); /* Green glow */
            outline: none;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .form-row .form-group {
            flex: 1 1 200px;
        }
        
        .calculate-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin-top: 10px;
            transition: background-color 0.3s, transform 0.2s, box-shadow 0.2s; /* Animation */
            position: relative;
            overflow: hidden;
        }
        
        .calculate-btn:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .calculate-btn:active {
            transform: translateY(0);
            box-shadow: none;
        }

        /* Ripple effect for button */
        .calculate-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            opacity: 0;
            transform: scale(1) translate(-50%, -50%);
            transition: transform 0.5s, opacity 0.5s;
        }

        .calculate-btn:active::after {
            transform: scale(20) translate(-50%, -50%);
            opacity: 1;
            transition: 0s;
        }
        
        .result-container,
        .recommendation-section {
            margin-top: 30px;
            padding: 20px;
            border-radius: 8px;
            background-color: var(--card-bg);
            box-shadow: var(--card-shadow);
            display: none; /* Hidden by default */
            opacity: 0; /* For fade-in animation */
            transform: translateY(20px); /* For slide-up animation */
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }

        .result-container.show,
        .recommendation-section.show {
            opacity: 1;
            transform: translateY(0);
            display: block; /* Show after animation */
        }
        
        .result-container h3,
        .recommendation-section h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        /* Ensure H3 is visible in dark mode */
        body.dark-mode .result-container h3,
        body.dark-mode .recommendation-section h3 {
            color: var(--text-color); /* Explicitly set to white for visibility */
        }

        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .result-table th, .result-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        .result-table th {
            background-color: var(--hover-color);
        }
        
        .standard-reference {
            margin-top: 20px;
            font-style: italic;
            font-size: 0.9rem;
            color: var(--text-color); /* Ensure visibility in dark mode */
        }
        
        .info-icon {
            color: var(--primary-color);
            margin-left: 5px;
            cursor: help;
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 250px; /* Adjusted width */
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px; /* Increased padding */
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -125px; /* Half of width */
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            transform: translateY(10px);
            font-family: 'Inter', sans-serif; /* Professional font */
            font-size: 0.85rem; /* Slightly smaller font size */
            line-height: 1.4; /* Better readability */
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
            transform: translateY(0);
        }

        /* Custom message box style */
        #custom-message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            font-weight: bold;
            color: white;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        /* Specific styles for the current app's elements to match the new theme */
        .bg-gray-100 { background-color: var(--bg-color); }
        .dark-mode-aware { /* This class will be applied to elements that need to react to dark mode */
            background-color: var(--card-bg); /* Default light mode */
            color: var(--text-color); /* Default light mode */
        }
        body.dark-mode .dark-mode-aware {
            background-color: var(--card-bg); /* Dark mode */
            color: var(--text-color); /* Dark mode */
        }

        .border-indigo-500 { border-color: var(--primary-color); }
        .focus\:ring-indigo-500:focus { box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2); border-color: var(--primary-color); }
        .focus\:border-indigo-500:focus { border-color: var(--primary-color); }
        .text-indigo-600 { color: var(--primary-color); }
        .bg-indigo-600 { background-color: var(--primary-color); }
        .hover\:bg-indigo-700:hover { background-color: var(--secondary-color); }
        .focus\:ring-indigo-500:focus { --tw-ring-color: rgba(76, 175, 80, 0.5); } /* Green ring */

        .bg-green-100 { background-color: rgba(76, 175, 80, 0.1); } /* Light green tint */
        body.dark-mode .bg-green-100 { background-color: rgba(76, 175, 80, 0.2); } /* Darker green tint for dark mode */
        .border-green-500 { border-color: var(--primary-color); }
        .text-green-800 { color: var(--primary-color); }
        body.dark-mode .text-green-800 { color: var(--text-color); } /* Adjust for dark mode visibility */
        .text-green-700 { color: var(--primary-color); }
        body.dark-mode .text-green-700 { color: var(--text-color); } /* Adjust for dark mode visibility */

        .bg-blue-100 { background-color: rgba(0, 123, 255, 0.1); } /* Light blue tint */
        body.dark-mode .bg-blue-100 { background-color: rgba(0, 123, 255, 0.2); } /* Darker blue tint for dark mode */
        .border-blue-500 { border-color: #007bff; } /* Blue color */
        .text-blue-800 { color: #007bff; }
        body.dark-mode .text-blue-800 { color: var(--text-color); } /* Adjust for dark mode visibility */
        .text-blue-700 { color: #007bff; }
        body.dark-mode .text-blue-700 { color: var(--text-color); } /* Adjust for dark mode visibility */

        .text-red-500 { color: #dc3545; } /* Red for errors */
        body.dark-mode .text-red-500 { color: #dc3545; } /* Red for errors */
        .text-purple-700 { color: #6f42c1; } /* Purple for specific highlights */
        body.dark-mode .text-purple-700 { color: #6f42c1; } /* Purple for specific highlights */

        /* Ensure form inputs use custom styling */
        .mt-1.block.w-full.bg-white.dark\:bg-gray-700.border.border-gray-300.dark\:border-gray-600.rounded-md.shadow-sm.py-2.px-3.focus\:outline-none.focus\:ring-indigo-500.focus\:border-indigo-500.sm\:text-sm {
            background-color: var(--bg-color);
            color: var(--text-color);
            border-color: var(--border-color);
        }
        body.dark-mode .mt-1.block.w-full.bg-white.dark\:bg-gray-700.border.border-gray-300.dark\:border-gray-600.rounded-md.shadow-sm.py-2.px-3.focus\:outline-none.focus\:ring-indigo-500.focus\:border-indigo-500.sm\:text-sm {
            background-color: var(--card-bg); /* Use card-bg for inputs in dark mode */
            border-color: var(--border-color);
        }

        /* Checkbox styling adjustment */
        .h-4.w-4.rounded.border-gray-300.text-indigo-600.focus\:ring-indigo-500.mr-2 {
            border-color: var(--border-color);
            color: var(--primary-color);
        }
        body.dark-mode .h-4.w-4.rounded.border-gray-300.text-indigo-600.focus\:ring-indigo-500.mr-2 {
            border-color: var(--border-color);
            color: var(--primary-color);
        }
    </style>
</head>
<body class="bg-gray-100 dark-mode-aware">

    <header>
        <div class="container">
            <h1>Design Calculators - Electrical<h1>
            <p class="subtitle">Electrical Protective Device Selector - An Intelligent Tool for Electrical Engineers</p>
            <div class="theme-toggle">
                <span class="light-icon"><i class="fas fa-sun"></i></span>
                <label class="switch">
                    <input type="checkbox" id="theme-switch">
                    <span class="slider round"></span>
                </label>
                <span class="dark-icon"><i class="fas fa-moon"></i></span>
            </div>
        </div>
    </header>
    <main class="container"> 
        <a href="indexEle.html" class="back-button"><i class="fas fa-arrow-left"></i> Back to Tools</a>

    <main class="container">
        <div class="tool-container">
            <h2>System Parameters</h2>
            
            <div class="tool-description">
                <p>This tool helps electrical engineers select appropriate protective devices based on system parameters and protection requirements. Input accurate data for precise recommendations.</p>
            </div>
        
            <div class="calculator-form">
                <form id="protection-selector-form">
                    <h3 class="text-xl font-semibold mb-3 text-gray-700 dark:text-white">Input Parameters</h3>
                    
                    <div class="form-row">
                        <!-- Load Type -->
                        <div class="form-group">
                            <label for="load-type">Load Type <i class="fas fa-info-circle tooltip info-icon"><span class="tooltiptext">Resistive: Heaters; Inductive: Motors, Transformers; Capacitive: Capacitor banks; Motor: Specific inductive load with high starting current.</span></i></label>
                            <select id="load-type" class="mt-1 block w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                <option>Resistive</option>
                                <option>Inductive</option>
                                <option>Capacitive</option>
                                <option>Mixed</option>
                                <option>Motor</option>
                            </select>
                        </div>

                        <!-- Application Type -->
                        <div class="form-group">
                            <label for="application-type">Application Type <i class="fas fa-info-circle tooltip info-icon"><span class="tooltiptext">Defines the environment and regulatory requirements. E.g., Residential has lower fault levels than Industrial.</span></i></label>
                            <select id="application-type" class="mt-1 block w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                <option>Residential</option>
                                <option>Commercial</option>
                                <option>Industrial</option>
                                <option>Medical</option>
                                <option>Data Center</option>
                                <option>Hazardous Area</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <!-- Phase Type -->
                        <div class="form-group">
                            <label for="phase-type">Phase Type <i class="fas fa-info-circle tooltip info-icon"><span class="tooltiptext">Single-phase for smaller loads (e.g., homes), Three-phase for larger loads (e.g., industrial motors).</span></i></label>
                            <select id="phase-type" class="mt-1 block w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                <option>Single-phase</option>
                                <option>Three-phase</option>
                            </select>
                        </div>

                        <!-- Voltage Level -->
                        <div class="form-group">
                            <label for="voltage-level">Voltage Level <i class="fas fa-info-circle tooltip info-icon"><span class="tooltiptext">System operating voltage. LV: Low Voltage, MV: Medium Voltage, HV: High Voltage.</span></i></label>
                            <select id="voltage-level" class="mt-1 block w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                <option>LV (&lt;1kV)</option>
                                <option>MV (1-33kV)</option>
                                <option>HV (&gt;33kV)</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <!-- Current Rating -->
                        <div class="form-group">
                            <label for="current-rating">Current Rating (Amps) <i class="fas fa-info-circle tooltip info-icon"><span class="tooltiptext">The full load current of the circuit to be protected.</span></i></label>
                            <input type="number" id="current-rating" placeholder="e.g., 16" class="mt-1 block w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        </div>

                        <!-- Fault Level (kA) -->
                        <div class="form-group">
                            <label for="fault-level">Prospective Fault Current (kA) <i class="fas fa-info-circle tooltip info-icon"><span class="tooltiptext">The maximum possible short-circuit current at the point of installation. Critical for selecting device breaking capacity.</span></i></label>
                            <input type="number" id="fault-level" placeholder="e.g., 6" step="0.1" class="mt-1 block w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        </div>
                    </div>

                    <div class="form-row">
                        <!-- Earthing System -->
                        <div class="form-group">
                            <label for="earthing-system">Earthing System <i class="fas fa-info-circle tooltip info-icon"><span class="tooltiptext">TT: Earth and neutral separate. TN-S: Separate neutral and PE. TN-C: Combined neutral and PE. IT: Unearthed or high-impedance earthed.</span></i></label>
                            <select id="earthing-system" class="mt-1 block w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                <option>TT</option>
                                <option>TN-S</option>
                                <option>TN-C</option>
                                <option>IT</option>
                            </select>
                        </div>
                    </div>

                    <h3 class="text-xl font-semibold mb-3 mt-6 text-gray-700 dark:text-white">Protection Requirements <i class="fas fa-info-circle tooltip info-icon"><span class="tooltiptext">Select all required protections. This is a key factor in device selection.</span></i></h3>
                    <div id="protection-requirements" class="mt-4 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 checkbox-group">
                        <!-- Checkboxes will be inserted here by JS -->
                    </div>

                    <h3 class="text-xl font-semibold mb-3 mt-6 text-gray-700 dark:text-white">Environmental Conditions <i class="fas fa-info-circle tooltip info-icon"><span class="tooltiptext">The operational environment impacts device selection, especially enclosure type (IP rating) and material.</span></i></h3>
                    <div id="environmental-conditions" class="mt-4 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 checkbox-group">
                        <!-- Checkboxes will be inserted here by JS -->
                    </div>

                    <button type="button" id="get-recommendation" class="calculate-btn">Get Recommendation</button>
                </form>
            </div>
            
            <div id="results-display" class="result-container">
                <!-- Results will be injected here -->
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <div class="disclaimer">
                <p class="text-sm">Disclaimer: Always verify calculation results against applicable engineering standards and guidelines.</p>
            </div>
            <div class="credit">
                <p class="text-sm">Created by A Sharma</p>
                <p>&copy; 2025 Design Calculators</p>
            </div>
            <div class="social-share">
                <h3 class="text-lg font-semibold">Share This Site</h3>
                <div class="social-buttons">
                    <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://designcalculators.co.in&title=Design Calculators - Electrical" target="_blank" class="social-btn linkedin">
                        <i class="fab fa-linkedin"></i>
                    </a>
                    <a href="https://www.facebook.com/sharer/sharer.php?u=https://designcalculators.co.in" target="_blank" class="social-btn facebook">
                        <i class="fab fa-facebook"></i>
                    </a>
                    <a href="https://twitter.com/intent/tweet?text=Check out this amazing Design Calculators - Electrical!&url=https://designcalculators.co.in" target="_blank" class="social-btn twitter">
                        <i class="fab fa-twitter"></i>
                    </a>
                    <a href="https://api.whatsapp.com/send?text=Check out this amazing Design Calculators - Electrical! https://designcalculators.co.in" target="_blank" class="social-btn whatsapp">
                        <i class="fab fa-whatsapp"></i>
                    </a>
                    <a href="https://www.reddit.com/submit?url=https://designcalculators.co.in&title=Design Calculators - Electrical" target="_blank" class="social-btn reddit">
                        <i class="fab fa-reddit"></i>
                    </a>
                </div>
            </div>
        </div>
    </footer>

    <!-- Custom Message Box -->
    <div id="custom-message-box"></div>

    <script>
        // Function to display messages (replaces alert())
        function displayMessage(message, type = "info") {
            let messageBox = document.getElementById('custom-message-box');
            if (!messageBox) {
                messageBox = document.createElement('div');
                messageBox.id = 'custom-message-box';
                document.body.appendChild(messageBox);
            }

            messageBox.textContent = message;
            messageBox.style.backgroundColor = ''; // Reset background
            messageBox.style.color = 'white'; // Default text color

            if (type === "error") {
                messageBox.style.backgroundColor = '#dc3545'; /* Red */
            } else if (type === "warning") {
                messageBox.style.backgroundColor = '#ffc107'; /* Orange */
                messageBox.style.color = '#333'; /* Dark text for orange background */
            } else {
                messageBox.style.backgroundColor = '#28a745'; /* Green */
            }
            messageBox.style.opacity = 1;
            messageBox.style.transform = 'translateX(-50%) translateY(0)'; // Bring to position

            // Hide after 5 seconds
            setTimeout(() => {
                messageBox.style.opacity = 0;
                messageBox.style.transform = 'translateX(-50%) translateY(-20px)'; // Fade out and move up
            }, 5000);
        }

        // --- DATABASE of Protective Devices ---
        const devices = {
            // Fuses (IEC Standards)
            'Fuse-gG': { 
                name: 'Cartridge Fuse (gG/gL)', 
                type: 'Fuse', 
                minI: 0.1, maxI: 100, 
                voltage: ['LV'], 
                protections: ['Short Circuit', 'Overload'], 
                breakingCapacity: { LV: { min: 6, max: 50 } }, // kA
                discrimination: 'Good', selectivity: 'Good', 
                standards: 'IEC 60269-1, IEC 60269-2', 
                notes: 'General purpose fuse for cable and conductor protection. Non-rewirable. Widely used in residential and light commercial applications in Europe and other IEC-standard regions.' 
            },
            'Fuse-aM': { 
                name: 'Motor Protection Fuse (aM)', 
                type: 'Fuse', 
                minI: 1, maxI: 630, 
                voltage: ['LV'], 
                protections: ['Short Circuit'], 
                breakingCapacity: { LV: { min: 50, max: 120 } }, // kA
                discrimination: 'Good', selectivity: 'Good', 
                standards: 'IEC 60269-2', 
                notes: 'Specifically designed for motor circuits, providing only short-circuit protection. Requires separate overload protection (e.g., thermal overload relay). Common in industrial motor control centers.' 
            },
            'Fuse-HRC': { 
                name: 'HRC Fuse (High Rupturing Capacity)', 
                type: 'Fuse', 
                minI: 2, maxI: 1250, 
                voltage: ['LV', 'MV'], 
                protections: ['Short Circuit', 'Overload'], 
                breakingCapacity: { LV: { min: 80, max: 200 }, MV: { min: 10, max: 63 } }, // kA
                discrimination: 'Excellent', selectivity: 'Excellent', 
                standards: 'IEC 60269-2, IEC 60269-3', 
                notes: 'Known for very high breaking capacity, essential in industrial and commercial applications with high prospective fault currents. Ensures rapid fault clearance.' 
            },
            'Fuse-Semiconductor': { 
                name: 'Semiconductor Fuse (aR/gR)', 
                type: 'Fuse', 
                minI: 1, maxI: 1000, 
                voltage: ['LV'], 
                protections: ['Short Circuit'], 
                breakingCapacity: { LV: { min: 100, max: 300 } }, // kA
                discrimination: 'Excellent', selectivity: 'Excellent', 
                standards: 'IEC 60269-4', 
                notes: 'Ultra-fast acting, specifically for protecting sensitive power electronic devices (e.g., rectifiers, inverters, UPS systems) from short-circuit damage.' 
            },
            'Fuse-MV': {
                name: 'Medium Voltage Fuse',
                type: 'Fuse',
                minI: 1, maxI: 200,
                voltage: ['MV'],
                protections: ['Short Circuit', 'Overload'],
                breakingCapacity: { MV: { min: 20, max: 80 } }, // kA
                discrimination: 'Good', selectivity: 'Good',
                standards: 'IEC 60282-1',
                notes: 'Used in medium voltage networks for protection of transformers, capacitor banks, and feeder lines. Provides reliable protection in substations.'
            },
            
            // Circuit Breakers (IEC Standards)
            'MCB-B': { 
                name: 'Miniature Circuit Breaker (MCB) Type B', 
                type: 'Circuit Breaker', 
                minI: 0.5, maxI: 125, 
                voltage: ['LV'], 
                protections: ['Short Circuit', 'Overload'], 
                tripCurve: 'B (3-5 In)', 
                breakingCapacity: { LV: { min: 3, max: 10 } }, // kA
                discrimination: 'Limited', selectivity: 'Limited', 
                standards: 'IEC 60898-1', 
                notes: 'Suitable for resistive and lighting loads with no or very small inrush currents. Common in residential and light commercial installations.' 
            },
            'MCB-C': { 
                name: 'Miniature Circuit Breaker (MCB) Type C', 
                type: 'Circuit Breaker', 
                minI: 0.5, maxI: 125, 
                voltage: ['LV'], 
                protections: ['Short Circuit', 'Overload'], 
                tripCurve: 'C (5-10 In)', 
                breakingCapacity: { LV: { min: 6, max: 25 } }, // kA
                discrimination: 'Limited', selectivity: 'Limited', 
                standards: 'IEC 60898-1', 
                notes: 'General purpose for resistive and inductive loads (e.g., motors, transformers, fluorescent lighting) with moderate inrush currents. Most commonly used MCB type.' 
            },
            'MCB-D': { 
                name: 'Miniature Circuit Breaker (MCB) Type D', 
                type: 'Circuit Breaker', 
                minI: 0.5, maxI: 125, 
                voltage: ['LV'], 
                protections: ['Short Circuit', 'Overload'], 
                tripCurve: 'D (10-20 In)', 
                breakingCapacity: { LV: { min: 10, max: 25 } }, // kA
                discrimination: 'Limited', selectivity: 'Limited', 
                standards: 'IEC 60898-1', 
                notes: 'Designed for highly inductive loads with very high inrush currents, such as X-ray machines, large motors, and transformers. Provides delayed tripping for motor starting.' 
            },
            'MCB-K': { 
                name: 'Miniature Circuit Breaker (MCB) Type K', 
                type: 'Circuit Breaker', 
                minI: 0.5, maxI: 63, 
                voltage: ['LV'], 
                protections: ['Short Circuit', 'Overload'], 
                tripCurve: 'K (8-12 In)', 
                breakingCapacity: { LV: { min: 6, max: 10 } }, // kA
                discrimination: 'Limited', selectivity: 'Limited', 
                standards: 'IEC 60898-1', 
                notes: 'Similar to Type D but with a narrower tripping range, suitable for specific motor protection applications where precise coordination is needed.' 
            },
            'MCB-Z': { 
                name: 'Miniature Circuit Breaker (MCB) Type Z', 
                type: 'Circuit Breaker', 
                minI: 0.5, maxI: 63, 
                voltage: ['LV'], 
                protections: ['Short Circuit', 'Overload'], 
                tripCurve: 'Z (2-3 In)', 
                breakingCapacity: { LV: { min: 6, max: 10 } }, // kA
                discrimination: 'Limited', selectivity: 'Limited', 
                standards: 'IEC 60898-1', 
                notes: 'For sensitive electronic loads with very low inrush currents. Provides very fast response to short circuits to protect delicate equipment.' 
            },
            'MCCB': { 
                name: 'Molded Case Circuit Breaker (MCCB)', 
                type: 'Circuit Breaker', 
                minI: 16, maxI: 3200, 
                voltage: ['LV'], 
                protections: ['Short Circuit', 'Overload'], 
                breakingCapacity: { LV: { min: 10, max: 150 } }, // kA
                discrimination: 'Good', selectivity: 'Good', 
                standards: 'IEC 60947-2', 
                notes: 'Versatile breaker for commercial and industrial applications. Offers adjustable trip settings for overload and short-circuit, allowing for better coordination.' 
            },
            'ACB': { 
                name: 'Air Circuit Breaker (ACB)', 
                type: 'Circuit Breaker', 
                minI: 400, maxI: 6300, 
                voltage: ['LV'], 
                protections: ['Short Circuit', 'Overload', 'Earth Fault'], 
                breakingCapacity: { LV: { min: 40, max: 150 } }, // kA
                discrimination: 'Excellent', selectivity: 'Excellent', 
                standards: 'IEC 60947-2', 
                notes: 'Used in main distribution boards and large industrial applications for high current ratings and fault levels. Offers advanced protection features and high reliability.' 
            },
            'VCB': { 
                name: 'Vacuum Circuit Breaker (VCB)', 
                type: 'Circuit Breaker', 
                minI: 100, maxI: 4000, 
                voltage: ['MV', 'HV'], 
                protections: ['Short Circuit', 'Overload', 'Earth Fault'], 
                breakingCapacity: { MV: { min: 20, max: 63 }, HV: { min: 25, max: 80 } }, // kA
                discrimination: 'Excellent', selectivity: 'Excellent', 
                standards: 'IEC 62271-100', 
                notes: 'Primary switching and protection device in medium voltage systems. Utilizes vacuum interrupters for efficient and environmentally friendly arc quenching. Essential for industrial and utility substations.' 
            },
            'SF6-CB': {
                name: 'SF6 Circuit Breaker',
                type: 'Circuit Breaker',
                minI: 400, maxI: 3150,
                voltage: ['MV', 'HV'],
                protections: ['Short Circuit', 'Overload', 'Earth Fault'],
                breakingCapacity: { MV: { min: 25, max: 50 }, HV: { min: 31.5, max: 63 } }, // kA
                discrimination: 'Excellent', selectivity: 'Excellent',
                standards: 'IEC 62271-100',
                notes: 'Used in medium and high voltage substations. SF6 gas provides excellent insulation and arc quenching properties. While effective, its use is being phased out in some regions due to environmental concerns.'
            },
            
            // Residual Current Devices (RCDs)
            'RCCB-AC': { 
                name: 'Residual Current Circuit Breaker (RCCB) Type AC', 
                type: 'RCD', 
                minI: 16, maxI: 125, 
                voltage: ['LV'], 
                protections: ['Earth Leakage'], 
                earthingSystems: ['TT', 'TN-S'], 
                standards: 'IEC 61008-1', 
                notes: 'Detects sinusoidal AC residual currents. Most common type for general purpose loads in residential and commercial buildings.' 
            },
            'RCCB-A': { 
                name: 'Residual Current Circuit Breaker (RCCB) Type A', 
                type: 'RCD', 
                minI: 16, maxI: 125, 
                voltage: ['LV'], 
                protections: ['Earth Leakage'], 
                earthingSystems: ['TT', 'TN-S'],
                standards: 'IEC 61008-1', 
                notes: 'Detects sinusoidal AC and pulsating DC residual currents. Recommended for circuits supplying equipment with electronic components that might produce pulsating DC faults (e.g., computers, washing machines, dimmers).' 
            },
            'RCCB-B': { 
                name: 'Residual Current Circuit Breaker (RCCB) Type B', 
                type: 'RCD', 
                minI: 25, maxI: 125, 
                voltage: ['LV'], 
                protections: ['Earth Leakage'], 
                earthingSystems: ['TT', 'TN-S', 'IT'],
                standards: 'IEC 61008-1', 
                notes: 'Detects AC, pulsating DC, and smooth DC residual currents. Essential for applications with three-phase rectifiers or variable speed drives, EV charging stations, and medical equipment where smooth DC leakage currents can occur.' 
            },
            'RCCB-F': { 
                name: 'Residual Current Circuit Breaker (RCCB) Type F', 
                type: 'RCD', 
                minI: 16, maxI: 125, 
                voltage: ['LV'], 
                protections: ['Earth Leakage'], 
                earthingSystems: ['TT', 'TN-S'],
                standards: 'IEC 61008-1', 
                notes: 'Detects AC, pulsating DC, and composite residual currents up to 1kHz. Designed for circuits with single-phase variable speed drives, heat pumps, and air conditioning units where higher frequency leakage currents may be present.' 
            },
            'RCBO': { 
                name: 'Residual Current Breaker with Overload (RCBO)', 
                type: 'RCD/CB Combined', 
                minI: 6, maxI: 63, 
                voltage: ['LV'], 
                protections: ['Short Circuit', 'Overload', 'Earth Leakage'], 
                earthingSystems: ['TT', 'TN-S'], // Type AC/A/B/F variants exist, common for single circuit protection
                standards: 'IEC 61009-1', 
                notes: 'Combines the functions of an MCB (overcurrent and short-circuit protection) and an RCCB (earth leakage protection) in a single compact device. Ideal for comprehensive protection of individual circuits.' 
            },
            'ELCB': { 
                name: 'Earth Leakage Circuit Breaker (ELCB)', 
                type: 'RCD (Voltage)', 
                minI: 16, maxI: 100, 
                voltage: ['LV'], 
                protections: ['Earth Leakage'], 
                earthingSystems: ['TT'], 
                standards: 'BS 4293 (older)', 
                notes: 'An older type of earth leakage protection that operates based on voltage difference. Less common now; current-operated RCCBs are generally preferred for superior protection and wider applicability.' 
            },

            // Other Protective Devices
            'SFU': { 
                name: 'Switch Fuse Unit (SFU)', 
                type: 'Combined', 
                minI: 32, maxI: 800, 
                voltage: ['LV'], 
                protections: ['Short Circuit', 'Overload', 'Isolation'], 
                breakingCapacity: { LV: { min: 50, max: 100 } }, // kA (depends on fuse)
                discrimination: 'Good', selectivity: 'Good', 
                standards: 'IEC 60947-3', 
                notes: 'Combines a manual switch for isolation and fuses for overcurrent and short-circuit protection. Robust and reliable for industrial power distribution and motor feeders.' 
            },
            'Isolator': { 
                name: 'Isolator/Disconnect Switch', 
                type: 'Switch', 
                minI: 16, maxI: 5000, 
                voltage: ['LV', 'MV', 'HV'], 
                protections: ['Isolation'], 
                standards: 'IEC 60947-3', 
                notes: 'Designed for safe isolation of electrical circuits for maintenance or repair. It has no breaking capacity for fault currents and must only be operated off-load or in conjunction with upstream protection.' 
            },
            'Protection-Relay': { 
                name: 'Protection Relay (with CB)', 
                type: 'Relay', 
                minI: 1, maxI: 10000, 
                voltage: ['LV', 'MV', 'HV'], 
                protections: ['Short Circuit', 'Overload', 'Earth Leakage', 'Arc Flash', 'Under/Over Voltage', 'Frequency', 'Directional', 'Differential'], 
                standards: 'IEC 60255', 
                notes: 'Highly configurable digital or numerical protection device that senses fault conditions and sends a trip signal to an associated circuit breaker (e.g., VCB, ACB). Essential for complex industrial systems and utility grids requiring precise and flexible protection schemes.' 
            },
            'SPD': { 
                name: 'Surge Protection Device (SPD)', 
                type: 'Surge Protector', 
                minI: 0, maxI: 10000, // Rated for surge current, not continuous load current
                voltage: ['LV', 'MV'], 
                protections: ['Surge/Lightning'], 
                standards: 'IEC 61643-11, IEC 61643-21', 
                notes: 'Protects electrical equipment from transient overvoltages caused by lightning strikes or switching operations. Installed in parallel with the main power supply or at sub-distribution points. Categorized by Type (1, 2, 3) based on installation location.' 
            },
            'AFDD': {
                name: 'Arc Fault Detection Device (AFDD)',
                type: 'Arc Fault Detector',
                minI: 6, maxI: 40,
                voltage: ['LV'],
                protections: ['Arc Fault'],
                standards: 'IEC 62606',
                notes: 'Detects dangerous electrical arc faults (series and parallel) that traditional circuit breakers cannot, preventing electrical fires. Increasingly mandated in residential and public buildings for enhanced safety. Often combined with an MCB or RCBO.'
            }
        };

        const protectionTypes = [
            'Short Circuit', 'Overload', 'Earth Leakage', 'Arc Fault', 
            'Surge/Lightning', 'Isolation', 'Under/Over Voltage', 'Frequency', 
            'Directional', 'Differential', 'Fire Protection' // Fire protection often implied by SC/OL or specific devices like AFDD
        ];
        const environments = ['Indoor', 'Outdoor', 'Wet', 'Dusty', 'Corrosive', 'Explosive', 'High Temperature', 'Low Temperature'];

        // --- UI LOGIC ---
        document.addEventListener('DOMContentLoaded', () => {
            const protectionContainer = document.getElementById('protection-requirements');
            protectionTypes.forEach(p => {
                protectionContainer.innerHTML += `
                    <label class="text-sm text-gray-600 dark:text-gray-400"><input type="checkbox" value="${p}" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 mr-2">${p}</label>
                `;
            });

            const environmentContainer = document.getElementById('environmental-conditions');
            environments.forEach(e => {
                environmentContainer.innerHTML += `
                    <label class="text-sm text-gray-600 dark:text-gray-400"><input type="checkbox" value="${e}" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 mr-2">${e}</label>
                `;
            });
            
            document.getElementById('get-recommendation').addEventListener('click', getRecommendation);
            
            // Theme Toggle
            const themeSwitch = document.getElementById('theme-switch');
            if (themeSwitch) {
                // Check for saved theme preference
                if (localStorage.getItem('theme') === 'dark') {
                    document.body.classList.add('dark-mode');
                    themeSwitch.checked = true;
                }

                themeSwitch.addEventListener('change', function() {
                    if (this.checked) {
                        document.body.classList.add('dark-mode');
                        localStorage.setItem('theme', 'dark');
                    } else {
                        document.body.classList.remove('dark-mode');
                        localStorage.setItem('theme', 'light');
                    }
                });
            }

            // Initial fade-in for form sections
            const formSections = document.querySelectorAll('.form-group, .checkbox-group');
            formSections.forEach((section, index) => {
                setTimeout(() => {
                    section.classList.add('fade-in');
                }, 50 * index); // Staggered fade-in
            });
        });

        // --- CORE LOGIC ---
        function getRecommendation() {
            // 1. Gather Inputs
            const inputs = {
                loadType: document.getElementById('load-type').value,
                applicationType: document.getElementById('application-type').value,
                phaseType: document.getElementById('phase-type').value,
                voltageLevel: document.getElementById('voltage-level').value.split(' ')[0], // e.g., 'LV' from 'LV (<1kV)'
                currentRating: parseFloat(document.getElementById('current-rating').value),
                faultLevel: parseFloat(document.getElementById('fault-level').value), // kA
                earthingSystem: document.getElementById('earthing-system').value,
                protections: Array.from(document.querySelectorAll('#protection-requirements input:checked')).map(el => el.value),
                environments: Array.from(document.querySelectorAll('#environmental-conditions input:checked')).map(el => el.value)
            };

            // 2. Input Validation
            if (isNaN(inputs.currentRating) || inputs.currentRating <= 0) {
                displayMessage('Please enter a valid positive current rating.', 'error');
                return;
            }
            if (isNaN(inputs.faultLevel) || inputs.faultLevel <= 0) {
                displayMessage('Please enter a valid positive prospective fault current (kA).', 'error');
                return;
            }
            if (inputs.protections.length === 0) {
                displayMessage('Please select at least one protection requirement.', 'error');
                return;
            }

            // 3. Decision Engine
            let recommendations = [];
            let compositeRecommendations = []; // For devices that work together

            for (const key in devices) {
                const device = devices[key];
                let score = 0;
                let reasons = [];
                let potentialIssues = [];

                // Rule 1: Voltage compatibility - Must match
                if (!device.voltage.includes(inputs.voltageLevel)) {
                    continue; 
                }
                reasons.push(`Voltage compatible (${inputs.voltageLevel}).`);

                // Rule 2: Current rating range - Must be within device's typical range
                if (inputs.currentRating >= device.minI && inputs.currentRating <= device.maxI) {
                    score += 2;
                    reasons.push(`Current rating of ${inputs.currentRating}A falls within the typical operating range of ${device.minI}A - ${device.maxI}A.`);
                } else {
                    potentialIssues.push(`Current rating (${inputs.currentRating}A) is outside typical range (${device.minI}-${device.maxI}A).`);
                    score -= 5; // Significant penalty
                }

                // Rule 3: Breaking Capacity - Critical for interrupting devices
                const requiredBreakingCapacity = inputs.faultLevel;
                if (device.type === 'Circuit Breaker' || device.type === 'Fuse' || device.type === 'Combined') {
                    const deviceBreakingCapacity = device.breakingCapacity ? device.breakingCapacity[inputs.voltageLevel]?.max : 0;

                    if (deviceBreakingCapacity >= requiredBreakingCapacity) {
                        score += 3;
                        reasons.push(`Breaking capacity (${deviceBreakingCapacity}kA) meets or exceeds the prospective fault current (${requiredBreakingCapacity}kA).`);
                    } else {
                        potentialIssues.push(`Breaking capacity (${deviceBreakingCapacity || 'N/A'}kA) is insufficient for the prospective fault current (${requiredBreakingCapacity}kA).`);
                        score -= 10; // Major penalty for insufficient breaking capacity
                    }
                } else if (device.type === 'Relay' || device.type === 'Surge Protector' || device.type === 'Arc Fault Detector' || device.type === 'RCD' || device.type === 'Switch') {
                    // These devices do not have inherent breaking capacity; they rely on other devices.
                    // No penalty here, but their role will be highlighted in composite recommendations.
                    reasons.push(`Functions as a ${device.type}, which typically operates in conjunction with a circuit breaker for fault interruption.`);
                }


                // Rule 4: Protection requirements - Must provide ALL selected protections
                let missingProtections = inputs.protections.filter(p => !device.protections.includes(p));
                let providedProtections = inputs.protections.filter(p => device.protections.includes(p));

                if (providedProtections.length === inputs.protections.length) {
                    score += 10; 
                    reasons.push(`Provides all required protections: ${providedProtections.join(', ')}.`);
                } else if (providedProtections.length > 0) {
                    score += providedProtections.length * 2; 
                    potentialIssues.push(`Does not provide all required protections. Missing: ${missingProtections.join(', ')}.`);
                } else {
                    continue; // Skip if no required protections are met
                }

                // Rule 5: Load Type specific considerations (for MCBs/MCCBs)
                if (device.type === 'Circuit Breaker' && device.tripCurve) {
                    let loadMatch = false;
                    if (inputs.loadType === 'Resistive' && (device.tripCurve.includes('B') || device.tripCurve.includes('C'))) {
                        loadMatch = true;
                    } else if ((inputs.loadType === 'Inductive' || inputs.loadType === 'Mixed') && device.tripCurve.includes('C')) {
                        loadMatch = true;
                    } else if (inputs.loadType === 'Motor' && (device.tripCurve.includes('C') || device.tripCurve.includes('D') || device.tripCurve.includes('K'))) {
                        loadMatch = true;
                    } else if (inputs.loadType === 'Capacitive' && device.tripCurve.includes('C')) { 
                        loadMatch = true;
                    } else if (inputs.loadType === 'Sensitive Electronics' && device.tripCurve.includes('Z')) {
                        loadMatch = true;
                    }

                    if (loadMatch) {
                        score += 2;
                        reasons.push(`Trip curve (${device.tripCurve}) is well-suited for ${inputs.loadType} loads.`);
                    } else {
                        potentialIssues.push(`Trip curve (${device.tripCurve}) may not be ideal for ${inputs.loadType} loads.`);
                        score -= 1; // Minor penalty
                    }
                }
                
                // Rule 6: Application Type specific bonuses
                if (inputs.applicationType === 'Residential' && (key.includes('MCB') || key.includes('RCBO') || key.includes('RCCB') || key.includes('AFDD'))) {
                    score += 3;
                    reasons.push('Ideal for residential applications due to typical requirements and fault levels.');
                }
                if (inputs.applicationType === 'Commercial' && (key.includes('MCCB') || key.includes('ACB') || key.includes('RCBO') || key.includes('SPD'))) {
                    score += 3;
                    reasons.push('Well-suited for commercial environments, balancing protection and cost-effectiveness.');
                }
                if (inputs.applicationType === 'Industrial' && (key.includes('MCCB') || key.includes('ACB') || key.includes('VCB') || key.includes('SFU') || key.includes('Protection-Relay') || key.includes('HRC'))) {
                    score += 4;
                    reasons.push('Robust choice for industrial applications, designed for higher currents and fault levels.');
                }
                if (inputs.applicationType === 'Medical' && (key.includes('RCCB-B') || key.includes('IT') || key.includes('Isolation') || key.includes('Protection-Relay'))) { 
                    score += 5;
                    reasons.push('Meets stringent requirements for medical applications, prioritizing patient safety and continuity of supply.');
                }
                if (inputs.applicationType === 'Data Center' && (key.includes('MCCB') || key.includes('ACB') || key.includes('Semiconductor') || key.includes('SPD') || key.includes('Protection-Relay'))) {
                    score += 4;
                    reasons.push('Suitable for data center environments, emphasizing reliability, discrimination, and protection of sensitive equipment.');
                }
                if (inputs.applicationType === 'Hazardous Area' && (key.includes('SFU') || key.includes('Isolator') || key.includes('Protection-Relay'))) { 
                    score += 2;
                    reasons.push('Considered for hazardous area applications (requires certified explosion-proof enclosure and specific device ratings).');
                }

                // Rule 7: Earthing System compatibility (for RCDs)
                if (device.type && device.type.includes('RCD') && device.earthingSystems) {
                    if (!device.earthingSystems.includes(inputs.earthingSystem)) {
                        potentialIssues.push(`Device is not typically suitable for ${inputs.earthingSystem} earthing system.`);
                        score -= 3;
                    } else {
                        reasons.push(`Compatible with ${inputs.earthingSystem} earthing system.`);
                    }
                }

                // Rule 8: Specific protection type prioritization and notes
                if (inputs.protections.includes('Earth Leakage') && (key.includes('RCCB') || key.includes('RCBO') || key.includes('ELCB'))) {
                    score += 3;
                    reasons.push(`Provides essential earth leakage protection, crucial for personnel safety and fire prevention.`);
                }
                if (inputs.protections.includes('Arc Fault') && key.includes('AFDD')) {
                    score += 5;
                    reasons.push(`Specifically designed for arc fault detection, mitigating fire risks from faulty wiring.`);
                }
                if (inputs.protections.includes('Surge/Lightning') && key.includes('SPD')) {
                    score += 5;
                    reasons.push(`Offers dedicated surge protection, safeguarding equipment from transient overvoltages.`);
                }
                if (inputs.protections.includes('Isolation') && key.includes('Isolator')) {
                    score += 2;
                    reasons.push(`Provides safe isolation capability, enabling secure maintenance procedures.`);
                }
                if (inputs.protections.includes('Under/Over Voltage') && key.includes('Protection-Relay')) {
                    score += 5;
                    reasons.push(`Offers precise under/over voltage protection, critical for equipment longevity and system stability.`);
                }
                if (inputs.protections.includes('Frequency') && key.includes('Protection-Relay')) {
                    score += 5;
                    reasons.push(`Offers frequency protection, vital for generators and systems sensitive to frequency deviations.`);
                }
                if (inputs.protections.includes('Directional') && key.includes('Protection-Relay')) {
                    score += 5;
                    reasons.push(`Offers directional protection, essential for complex networks to isolate faults in specific directions.`);
                }
                if (inputs.protections.includes('Differential') && key.includes('Protection-Relay')) {
                    score += 5;
                    reasons.push(`Offers differential protection, providing high-speed and sensitive protection for transformers, generators, and busbars.`);
                }
                if (inputs.protections.includes('Fire Protection') && (key.includes('AFDD') || key.includes('RCCB') || key.includes('RCBO'))) {
                    score += 2;
                    reasons.push(`Contributes significantly to fire protection by detecting specific fault types (e.g., arc faults, earth leakage).`);
                }


                recommendations.push({ id: key, device, score, reasons, potentialIssues });
            }

            // Sort by score (highest first)
            recommendations.sort((a, b) => b.score - a.score);

            // Filter out devices with major issues (e.g., insufficient breaking capacity)
            let viableRecommendations = recommendations.filter(rec => rec.potentialIssues.length === 0 || !rec.potentialIssues.some(issue => issue.includes('insufficient for the prospective fault current')));

            // Handle composite recommendations if a single device isn't sufficient
            if (viableRecommendations.length === 0 && inputs.protections.length > 0) {
                // Try to find a combination
                let bestCombination = { devices: [], score: -Infinity, reasons: [], missing: [...inputs.protections] };

                // Scenario 1: CB (SC/OL) + RCD (EL)
                if (inputs.protections.includes('Short Circuit') && inputs.protections.includes('Overload') && inputs.protections.includes('Earth Leakage') && inputs.voltageLevel === 'LV') {
                    const cbCandidates = recommendations.filter(d => d.device.type === 'Circuit Breaker' && d.device.protections.includes('Short Circuit') && d.device.protections.includes('Overload') && d.potentialIssues.length === 0 && d.device.voltage.includes(inputs.voltageLevel) && d.device.breakingCapacity[inputs.voltageLevel]?.max >= inputs.faultLevel);
                    const rcdCandidates = recommendations.filter(d => d.device.type && d.device.type.includes('RCD') && d.device.protections.includes('Earth Leakage') && d.potentialIssues.length === 0 && d.device.voltage.includes(inputs.voltageLevel) && d.device.earthingSystems.includes(inputs.earthingSystem));

                    if (cbCandidates.length > 0 && rcdCandidates.length > 0) {
                        const cb = cbCandidates[0].device;
                        const rcd = rcdCandidates[0].device;
                        const combinedScore = cbCandidates[0].score + rcdCandidates[0].score; 
                        compositeRecommendations.push({
                            name: `${cb.name} + ${rcd.name}`,
                            devices: [cb, rcd],
                            score: combinedScore,
                            reasons: [`This combination provides comprehensive Short Circuit, Overload, and Earth Leakage protection for your low voltage system.`, ...cbCandidates[0].reasons, ...rcdCandidates[0].reasons],
                            notes: `This is a common and effective solution when a single circuit breaker does not offer integrated earth leakage protection, or when enhanced discrimination is required.`
                        });
                    }
                }

                // Scenario 2: CB + AFDD
                if (inputs.protections.includes('Short Circuit') && inputs.protections.includes('Overload') && inputs.protections.includes('Arc Fault') && inputs.voltageLevel === 'LV') {
                    const cbCandidates = recommendations.filter(d => d.device.type === 'Circuit Breaker' && d.device.protections.includes('Short Circuit') && d.device.protections.includes('Overload') && d.potentialIssues.length === 0 && d.device.voltage.includes(inputs.voltageLevel) && d.device.breakingCapacity[inputs.voltageLevel]?.max >= inputs.faultLevel);
                    const afddCandidates = recommendations.filter(d => d.id.includes('AFDD') && d.potentialIssues.length === 0 && d.device.voltage.includes(inputs.voltageLevel));

                    if (cbCandidates.length > 0 && afddCandidates.length > 0) {
                        const cb = cbCandidates[0].device;
                        const afdd = afddCandidates[0].device;
                        const combinedScore = cbCandidates[0].score + afddCandidates[0].score;
                        compositeRecommendations.push({
                            name: `${cb.name} + ${afdd.name}`,
                            devices: [cb, afdd],
                            score: combinedScore,
                            reasons: [`This combination provides robust Short Circuit, Overload, and crucial Arc Fault protection, significantly enhancing fire safety.`, ...cbCandidates[0].reasons, ...afddCandidates[0].reasons],
                            notes: `An AFDD is typically installed in series with an MCB or RCBO to provide comprehensive protection against dangerous electrical arc faults that conventional breakers cannot detect.`
                        });
                    }
                }

                // Scenario 3: Main CB + Protection Relay (for MV/HV or complex LV)
                if (inputs.protections.includes('Protection Relay')) {
                    const requiredRelayProtections = inputs.protections.filter(p => ['Under/Over Voltage', 'Frequency', 'Directional', 'Differential', 'Arc Flash'].includes(p));
                    const otherProtectionsNeeded = inputs.protections.filter(p => !requiredRelayProtections.includes(p) && p !== 'Protection Relay');

                    let suitableCBs = [];
                    if (inputs.voltageLevel === 'LV') {
                        suitableCBs = recommendations.filter(d => 
                            (d.id.includes('ACB') || d.id.includes('MCCB')) && 
                            d.device.voltage.includes(inputs.voltageLevel) &&
                            inputs.currentRating >= d.device.minI && inputs.currentRating <= d.device.maxI &&
                            (d.device.breakingCapacity && d.device.breakingCapacity[inputs.voltageLevel]?.max >= inputs.faultLevel) &&
                            otherProtectionsNeeded.every(p => d.device.protections.includes(p))
                        );
                    } else { // MV or HV
                        suitableCBs = recommendations.filter(d => 
                            (d.id.includes('VCB') || d.id.includes('SF6-CB')) && 
                            d.device.voltage.includes(inputs.voltageLevel) &&
                            inputs.currentRating >= d.device.minI && inputs.currentRating <= d.device.maxI &&
                            (d.device.breakingCapacity && d.device.breakingCapacity[inputs.voltageLevel]?.max >= inputs.faultLevel) &&
                            otherProtectionsNeeded.every(p => d.device.protections.includes(p))
                        );
                    }
                    
                    const suitableRelays = recommendations.filter(d => d.id.includes('Protection-Relay') && requiredRelayProtections.every(p => d.device.protections.includes(p)));

                    if (suitableCBs.length > 0 && suitableRelays.length > 0) {
                        const bestCB = suitableCBs[0].device;
                        const bestRelay = suitableRelays[0].device;
                        const combinedScore = suitableCBs[0].score + suitableRelays[0].score;

                        compositeRecommendations.push({
                            name: `${bestCB.name} + ${bestRelay.name}`,
                            devices: [bestCB, bestRelay],
                            score: combinedScore,
                            reasons: [
                                `This combination provides comprehensive and advanced protection functions, ideal for complex industrial and utility applications at ${inputs.voltageLevel}.`,
                                `The ${bestCB.name} provides the necessary high breaking capacity (${bestCB.breakingCapacity[inputs.voltageLevel]?.max}kA) for the fault level (${inputs.faultLevel}kA) and handles the continuous current (${inputs.currentRating}A).`,
                                `The ${bestRelay.name} offers highly configurable and precise protections including: ${requiredRelayProtections.join(', ')}.`,
                                `This setup ensures superior selectivity and discrimination, isolating faults rapidly without affecting healthy parts of the system.`,
                                ...suitableCBs[0].reasons.filter(r => !r.includes('Breaking capacity') && !r.includes('Suitable for') && !r.includes('Provides all required protections')),
                                ...suitableRelays[0].reasons.filter(r => !r.includes('Offers advanced and configurable protection functions'))
                            ],
                            notes: `This is the standard solution for critical industrial applications requiring precise and flexible protection, especially at Medium and High Voltage levels.`
                        });
                    }
                }

                compositeRecommendations.sort((a, b) => b.score - a.score);
            }

            // 4. Display Results
            displayResults(viableRecommendations, compositeRecommendations, inputs);
        }

        function displayResults(recommendations, compositeRecommendations, inputs) {
            const resultsDisplay = document.getElementById('results-display');
            resultsDisplay.innerHTML = ''; // Clear previous results

            let resultsHTML = '';

            // Prioritize composite recommendations if no single device is highly suitable
            let primaryRecommendation = null;
            // A single device is "highly suitable" if it has a good score and no major potential issues
            const bestSingleDevice = recommendations.length > 0 && recommendations[0].potentialIssues.length === 0 ? recommendations[0] : null;

            // A composite solution is "highly suitable" if it exists and has a good score
            const bestCompositeSolution = compositeRecommendations.length > 0 ? compositeRecommendations[0] : null;

            // Decision logic for primary recommendation:
            // 1. If a strong single device exists, prefer it.
            // 2. If no strong single device, but a strong composite exists, prefer composite.
            // 3. Otherwise, no strong recommendation.
            if (bestSingleDevice && bestSingleDevice.score >= 10) { // Arbitrary threshold for "strong" single device
                primaryRecommendation = bestSingleDevice;
            } else if (bestCompositeSolution && bestCompositeSolution.score > 0) { // Any positive score for composite
                primaryRecommendation = bestCompositeSolution;
            }


            if (primaryRecommendation) {
                if (primaryRecommendation.devices) { // It's a composite recommendation
                    const bestComposite = primaryRecommendation;
                    resultsHTML += `
                        <h2 class="text-2xl font-semibold mb-6 border-b-2 border-blue-500 pb-2">Composite Recommendation</h2>
                        <div class="bg-blue-100 dark-mode-aware p-6 rounded-lg shadow-lg mb-8">
                            <h3 class="text-xl font-bold text-blue-800 dark-mode-aware">${bestComposite.name}</h3>
                            <div class="mt-4">
                                <strong class="text-gray-700 dark-mode-aware">Justification:</strong>
                                <ul class="list-disc list-inside mt-2 text-blue-700 dark-mode-aware space-y-1">
                                    ${bestComposite.reasons.map(r => `<li>${r}</li>`).join('')}
                                    <li>${bestComposite.notes}</li>
                                    ${getEnvironmentalNotes(inputs.environments)}
                                </ul>
                            </div>
                            <div class="mt-4 pt-4 border-t border-blue-300 dark-mode-aware">
                                <strong class="text-gray-700 dark-mode-aware">Individual Device Specifications:</strong>
                                ${bestComposite.devices.map(dev => `
                                    <h4 class="font-semibold mt-4 mb-2">${dev.name}</h4>
                                    <ul class="list-disc list-inside ml-4 text-sm text-gray-600 dark-mode-aware space-y-1">
                                        <li><strong>Type:</strong> ${dev.type}</li>
                                        <li><strong>Typical Current Range:</strong> ${dev.minI}A - ${dev.maxI}A</li>
                                        <li><strong>Voltage Level:</strong> ${dev.voltage.join(', ')}</li>
                                        <li><strong>Protections Offered:</strong> ${dev.protections.join(', ')}</li>
                                        ${dev.tripCurve ? `<li><strong>Trip Curve:</strong> ${dev.tripCurve}</li>` : ''}
                                        ${dev.breakingCapacity ? `<li><strong>Breaking Capacity (${inputs.voltageLevel}):</strong> ${dev.breakingCapacity[inputs.voltageLevel]?.min || 'N/A'} - ${dev.breakingCapacity[inputs.voltageLevel]?.max || 'N/A'} kA</li>` : ''}
                                        ${dev.discrimination ? `<li><strong>Discrimination:</strong> ${dev.discrimination}</li>` : ''}
                                        ${dev.selectivity ? `<li><strong>Selectivity:</strong> ${dev.selectivity}</li>` : ''}
                                        ${dev.earthingSystems ? `<li><strong>Compatible Earthing Systems:</strong> ${dev.earthingSystems.join(', ')}</li>` : ''}
                                        <li><strong>Applicable Standard:</strong> ${dev.standards}</li>
                                        ${dev.notes ? `<li><strong>Note:</strong> ${dev.notes}</li>` : ''}
                                    </ul>
                                `).join('')}
                            </div>
                        </div>
                    `;
                } else { // It's a single device recommendation
                    const bestRec = primaryRecommendation;
                    resultsHTML += `
                        <h2 class="text-2xl font-semibold mb-6 border-b-2 border-green-500 pb-2">Primary Recommendation</h2>
                        
                        <!-- Best Recommendation Card -->
                        <div class="bg-green-100 dark-mode-aware border-l-4 border-green-500 p-6 rounded-lg shadow-lg mb-8">
                            <h3 class="text-xl font-bold text-green-800 dark-mode-aware">${bestRec.device.name}</h3>
                            <div class="mt-4">
                                <strong class="text-gray-700 dark-mode-aware">Justification:</strong>
                                <ul class="list-disc list-inside mt-2 text-green-700 dark-mode-aware space-y-1">
                                    ${bestRec.reasons.map(r => `<li>${r}</li>`).join('')}
                                    ${getEnvironmentalNotes(inputs.environments)}
                                </ul>
                            </div>
                            <div class="mt-4 pt-4 border-t border-green-300 dark-mode-aware">
                                <strong class="text-gray-700 dark-mode-aware">Specifications:</strong>
                                <ul class="list-disc list-inside mt-2 text-sm text-gray-600 dark-mode-aware space-y-1">
                                    <li><strong>Type:</strong> ${bestRec.device.type}</li>
                                    <li><strong>Typical Current Range:</strong> ${bestRec.device.minI}A - ${bestRec.device.maxI}A</li>
                                    <li><strong>Voltage Level:</strong> ${bestRec.device.voltage.join(', ')}</li>
                                    <li><strong>Protections Offered:</strong> ${bestRec.device.protections.join(', ')}</li>
                                    ${bestRec.device.tripCurve ? `<li><strong>Trip Curve:</strong> ${bestRec.device.tripCurve}</li>` : ''}
                                    ${bestRec.device.breakingCapacity ? `<li><strong>Breaking Capacity (${inputs.voltageLevel}):</strong> ${bestRec.device.breakingCapacity[inputs.voltageLevel]?.min || 'N/A'} - ${bestRec.device.breakingCapacity[inputs.voltageLevel]?.max || 'N/A'} kA</li>` : ''}
                                    ${bestRec.device.discrimination ? `<li><strong>Discrimination:</strong> ${bestRec.device.discrimination}</li>` : ''}
                                    ${bestRec.device.selectivity ? `<li><strong>Selectivity:</strong> ${bestRec.device.selectivity}</li>` : ''}
                                    ${bestRec.device.earthingSystems ? `<li><strong>Compatible Earthing Systems:</strong> ${bestRec.device.earthingSystems.join(', ')}</li>` : ''}
                                    <li><strong>Applicable Standard:</strong> ${bestRec.device.standards}</li>
                                    ${bestRec.device.notes ? `<li><strong>Note:</strong> ${bestRec.device.notes}</li>` : ''}
                                </ul>
                            </div>
                        </div>
                    `;
                }
            }
            
            // Alternatives or if no primary/composite found
            const alternatives = recommendations.filter(rec => rec !== primaryRecommendation).slice(0, 3); // Get next 3 single device alternatives
            if (alternatives.length > 0) {
                resultsHTML += `<h3 class="text-xl font-semibold mb-4 border-b pb-2">Optional Alternatives (Single Devices)</h3><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">`;
                alternatives.forEach(alt => {
                    resultsHTML += `
                        <div class="bg-gray-100 dark-mode-aware p-4 rounded-lg shadow">
                            <h4 class="font-bold text-lg">${alt.device.name}</h4>
                            <p class="text-sm text-gray-600 dark-mode-aware mt-2"><strong>Reasons:</strong> ${alt.reasons.map(r => r).join(' ')}</p>
                            ${alt.potentialIssues.length > 0 ? `<p class="text-sm text-red-500 dark-mode-aware mt-1"><strong>Potential Issues:</strong> ${alt.potentialIssues.join(' ')}</p>` : ''}
                            <p class="text-xs text-gray-500 dark-mode-aware mt-2">Score: ${alt.score}</p>
                        </div>
                    `;
                });
                resultsHTML += `</div>`;
            }

            if (resultsHTML === '') {
                resultsDisplay.innerHTML = `
                    <h2 class="text-2xl font-semibold mb-4 text-red-500">No Suitable Device Found</h2>
                    <p class="text-gray-600 dark-mode-aware">No single device or common combination meets all specified criteria. This could be due to conflicting requirements, extremely high fault levels, or a need for a highly specialized solution. Please review your inputs or consult with a qualified electrical engineer for a custom design.</p>
                `;
            }

            resultsDisplay.innerHTML = resultsHTML;
            resultsDisplay.classList.add('show'); // Use 'show' class for fade-in
            resultsDisplay.scrollIntoView({ behavior: 'smooth' });
        }

        function getEnvironmentalNotes(environments) {
            if (environments.length === 0) return '<li>Standard indoor installation assumed.</li>';
            
            let notes = [];
            if (environments.includes('Outdoor') || environments.includes('Wet') || environments.includes('Dusty')) {
                notes.push('Requires an appropriate IP-rated enclosure (e.g., IP65 or higher) for protection against environmental factors.');
            }
            if (environments.includes('Explosive')) {
                notes.push('Requires an ATEX/IECEx certified explosion-proof enclosure and device suitable for the specific hazardous zone.');
            }
            if (environments.includes('Corrosive')) {
                notes.push('Requires corrosion-resistant materials or special coatings for the device and enclosure.');
            }
            if (environments.includes('High Temperature')) {
                notes.push('Device must be rated for high ambient temperatures; derating may be necessary.');
            }
            if (environments.includes('Low Temperature')) {
                notes.push('Device must be rated for low ambient temperatures; special lubricants or heaters may be required.');
            }
            if (environments.includes('Indoor') && notes.length === 0) {
                notes.push('Suitable for standard indoor environments.');
            }
            return notes.map(n => `<li>${n}</li>`).join('');
        }

    </script>
</body>
</html>

