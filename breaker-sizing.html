<!DOCTYPE html>
<html lang="en">
<head>
        <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-23Y1V450SR"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-23Y1V450SR');
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Electrical Calculator - Design Calculators - Electrical</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- MathJax for LaTeX rendering (for calculation details only) -->
    <script type="text/javascript" id="MathJax-script" async
      src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
    </script>
    <style>
        /* Basic CSS Variables for a consistent theme */
        :root {
            --primary-color: #4CAF50; /* Green */
            --secondary-color: #45a049; /* Darker Green */
            --accent-color: #FFC107; /* Amber */
            --bg-color: #f4f7f6; /* Light Greyish Green */
            --card-bg: #ffffff; /* White */
            --text-color: #333333; /* Dark Grey */
            --header-bg: #2C3E50; /* Dark Blue Grey */
            --footer-bg: #34495E; /* Slightly Lighter Dark Blue Grey */
            --border-color: #cccccc;
            --card-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            --hover-color: #e2e6ea;
            --input-focus-shadow: 0 0 0 3px rgba(76, 175, 80, 0.3);
        }

        /* Dark Mode Variables */
        body.dark-mode {
            --bg-color: #2c3e50;
            --card-bg: #34495e;
            --text-color: #ecf0f1;
            --header-bg: #2c3e50;
            --footer-bg: #2c3e50;
            --border-color: #555555;
            --card-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            --hover-color: #446688;
            --input-focus-shadow: 0 0 0 3px rgba(76, 175, 80, 0.5);
        }

        /* General Body Styling */
        body {
            font-family: 'Inter', sans-serif; /* Using Inter as specified */
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 960px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: var(--header-bg);
            color: white;
            padding: 20px 0;
            text-align: center;
            box-shadow: var(--card-shadow);
            position: relative; /* For theme toggle positioning */
        }

        header h1 {
            margin: 0;
            font-size: 2.5em;
            color: var(--primary-color);
        }

        header .subtitle {
            margin: 5px 0 0;
            font-size: 1em;
            color: #bdc3c7;
        }

        main {
            padding: 20px 0;
        }

        .tool-container {
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 20px;
            box-shadow: var(--card-shadow);
            margin-bottom: 20px;
        }

        .tool-container h2 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            margin-top: 0;
            margin-bottom: 20px;
        }

        .tool-description {
            margin-bottom: 20px;
            color: var(--text-color);
        }

        .back-button {
            display: inline-block;
            background-color: var(--primary-color);
            color: white;
            padding: 10px 15px;
            border-radius: 4px;
            text-decoration: none;
            margin-bottom: 20px;
            transition: background-color 0.3s;
        }

        .back-button:hover {
            background-color: var(--secondary-color);
        }

        /* Theme Toggle */
        .theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
        }

        .theme-toggle .light-icon,
        .theme-toggle .dark-icon {
            color: white;
            margin: 0 5px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
        }

        input:checked + .slider {
            background-color: var(--primary-color);
        }

        input:focus + .slider {
            box-shadow: 0 0 1px var(--primary-color);
        }

        input:checked + .slider:before {
            -webkit-transform: translateX(26px);
            -ms-transform: translateX(26px);
            transform: translateX(26px);
        }

        /* Rounded sliders */
        .slider.round {
            border-radius: 34px;
        }

        .slider.round:before {
            border-radius: 50%;
        }

        /* Footer Styling */
        footer {
            background-color: var(--footer-bg);
            color: white;
            padding: 20px 0;
            text-align: center;
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1);
            margin-top: 30px;
        }

        footer .disclaimer h3,
        footer .social-share h3 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        footer .disclaimer p {
            font-size: 0.9em;
            color: #bdc3c7;
        }

        .social-buttons {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .social-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            color: white;
            text-decoration: none;
            font-size: 1.2em;
            transition: transform 0.3s ease-in-out;
        }

        .social-btn:hover {
            transform: translateY(-3px);
        }

        .social-btn.linkedin { background-color: #0A66C2; }
        .social-btn.facebook { background-color: #1877F2; }
        .social-btn.twitter { background-color: #1DA1F2; }
        .social-btn.whatsapp { background-color: #25D366; }
        .social-btn.reddit { background-color: #FF4500; }

        /* Styles for Calculator Forms and Results */
        .calculator-form {
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: var(--card-shadow);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px; /* Added rounded corners */
            background-color: var(--bg-color);
            color: var(--text-color);
            box-sizing: border-box; /* Ensures padding doesn't increase width */
            transition: border-color 0.3s, box-shadow 0.3s; /* Added transition for focus */
        }

        .form-group input:focus, .form-group select:focus {
            border-color: var(--primary-color);
            box-shadow: var(--input-focus-shadow); /* Green glow on focus */
            outline: none; /* Remove default outline */
        }

        .form-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .form-row .form-group {
            flex: 1 1 calc(50% - 10px); /* Two columns on larger screens */
        }

        @media (max-width: 768px) {
            .form-row .form-group {
                flex: 1 1 100%; /* Single column on smaller screens */
            }
        }

        .calculate-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px; /* Added rounded corners */
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin-top: 10px;
            transition: background-color 0.3s, transform 0.2s ease-in-out, box-shadow 0.2s;
            width: 100%; /* Full width button */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Initial shadow */
        }

        .calculate-btn:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15); /* Lifted shadow on hover */
        }

        .calculate-btn:active {
            transform: translateY(0); /* Press down effect */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* Reduced shadow on click */
            background-color: #3e8e41; /* Slightly darker green on click */
        }

        .result-container {
            margin-top: 30px;
            padding: 20px;
            border-radius: 8px;
            background-color: var(--card-bg);
            box-shadow: var(--card-shadow);
            display: none; /* Hidden by default */
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }

        .result-container.show {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .result-container h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            display: none; /* Hidden by default for animation */
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }

        .result-table.show {
            display: table;
            opacity: 1;
            transform: translateY(0);
        }

        .result-table th, .result-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .result-table th {
            background-color: var(--hover-color);
        }

        /* Animation for result table rows */
        .result-table tbody tr {
            opacity: 0;
            transform: translateX(-20px);
            animation: fadeInSlideIn 0.5s forwards;
        }

        @keyframes fadeInSlideIn {
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .standard-reference {
            margin-top: 20px;
            font-style: italic;
            font-size: 0.9rem;
        }

        .info-icon {
            color: var(--primary-color);
            margin-left: 5px;
            cursor: help;
        }

        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* Custom message box style */
        #custom-message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            font-weight: bold;
            color: white;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        /* Styles for calculation details */
        .calculation-section {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 0.95em;
            opacity: 0; /* Hidden by default for animation */
            transform: translateY(10px); /* Slight initial offset */
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }
        .calculation-section.show {
            opacity: 1;
            transform: translateY(0);
        }

        .calculation-section h4 {
            color: var(--secondary-color);
            margin-top: 0;
            margin-bottom: 10px;
        }
        .calculation-section p.formula {
            font-family: 'Times New Roman', serif; /* A font suitable for mathematical formulas */
            font-style: italic;
            font-size: 1.1em;
            text-align: center;
            padding: 10px 0;
            background-color: var(--hover-color);
            border-radius: 4px;
            margin: 10px 0;
            overflow-x: auto; /* Allow horizontal scrolling for long formulas */
        }
        .calculation-section p.calculation-step {
            font-family: 'Courier New', monospace; /* Monospace for steps */
            background-color: var(--hover-color);
            padding: 5px 10px;
            border-radius: 3px;
            margin-bottom: 5px;
        }
        .calculation-section ul {
            list-style-type: disc;
            margin-left: 20px;
            padding-left: 0;
        }
        .calculation-section ul li {
            margin-bottom: 5px;
        }

        /* Loading spinner animation */
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--primary-color);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>Design Calculators - Electrical</h1>
            <p class="subtitle">Electrical Calculations Made Easy — Learn with Every Step</p>
            <div class="theme-toggle">
                <span class="light-icon"><i class="fas fa-sun"></i></span>
                <label class="switch">
                    <input type="checkbox" id="theme-switch">
                    <span class="slider round"></span>
                </label>
                <span class="dark-icon"><i class="fas fa-moon"></i></span>
            </div>
        </div>
    </header>

    <main class="container">
        <a href="indexEle.html" class="back-button"><i class="fas fa-arrow-left"></i> Back to Tools</a>

        <div class="tool-container">
            <h2>Advanced Electrical Breaker Sizing and Selection Tool</h2>

            <div class="tool-description">
                <p>This powerful calculator assists in sizing circuit breakers and determining their thermal and magnetic trip settings for a wide range of industrial applications, adhering to international electrical standards like IEC and NEC. It provides detailed calculations and recommendations for optimal system protection and coordination.</p>
            </div>

            <div class="calculator-form">
                <form id="electrical-calculations-form">
                    <!-- Motor Breaker Calculation Section -->
                    <h3>Motor Circuit Breaker Calculation</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="motor-power-unit">Motor Power Unit <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Select the unit for motor power (Horsepower or Kilowatts).</span></span></label>
                            <select id="motor-power-unit" required>
                                <option value="hp">HP (Horsepower)</option>
                                <option value="kw">kW (Kilowatts)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="motor-power">Motor Power <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The rated power of the motor.</span></span></label>
                            <input type="number" id="motor-power" min="0.1" step="0.1" value="37" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="motor-type">Motor Type <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Select motor type for specific starting current characteristics (e.g., Squirrel Cage, Synchronous).</span></span></label>
                            <select id="motor-type" required>
                                <option value="squirrel-cage">Squirrel Cage Induction Motor</option>
                                <option value="synchronous">Synchronous Motor</option>
                                <option value="wound-rotor">Wound Rotor Induction Motor</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="motor-starting-method">Motor Starting Method <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The method used to start the motor, affecting its starting current (e.g., Direct Online, Star-Delta).</span></span></label>
                            <select id="motor-starting-method" required>
                                <option value="dol">Direct Online (DOL)</option>
                                <option value="star-delta">Star-Delta</option>
                                <option value="soft-starter">Soft Starter</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="voltage-type">System Voltage Type <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Specify if the system is Single Phase or Three Phase.</span></span></label>
                            <select id="voltage-type" required>
                                <option value="three-phase">Three Phase</option>
                                <option value="single-phase">Single Phase</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="system-voltage">System Voltage (V) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Nominal system voltage (e.g., 400V, 480V, 230V).</span></span></label>
                            <input type="number" id="system-voltage" min="1" step="1" value="400" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="power-factor">Power Factor (PF) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Motor power factor (e.g., 0.8 lagging). Enter as a decimal (0.0 to 1.0).</span></span></label>
                            <input type="number" id="power-factor" min="0.1" max="1" step="0.01" value="0.8" required>
                        </div>
                        <div class="form-group">
                            <label for="efficiency">Motor Efficiency (%) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Motor efficiency (e.g., 90%). Enter as a percentage.</span></span></label>
                            <input type="number" id="efficiency" min="1" max="100" step="0.1" value="90" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="cable-type">Cable Insulation Type <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Common types are PVC (75°C) or XLPE (90°C). This affects cable ampacity.</span></span></label>
                            <select id="cable-type" required>
                                <option value="75">PVC (75°C)</option>
                                <option value="90">XLPE (90°C)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="installation-method">Installation Method <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">How the cable is installed (e.g., in conduit, open air). Affects ampacity.</span></span></label>
                            <select id="installation-method" required>
                                <option value="conduit">In Conduit/Tray</option>
                                <option value="open-air">Open Air</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="ambient-temp">Ambient Temperature (°C) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The maximum ambient temperature around the cable and breaker. Standard is 30°C.</span></span></label>
                            <input type="number" id="ambient-temp" min="0" step="1" value="30" required>
                        </div>
                        <div class="form-group">
                            <label for="number-of-conductors">Number of Current-Carrying Conductors <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Number of active conductors in conduit/bundle (e.g., 3 for 3-phase, 4 for 3-phase+N).</span></span></label>
                            <input type="number" id="number-of-conductors" min="2" step="1" value="3" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="cable-length">Cable Length (m) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Total length of the cable run in meters. Used for voltage drop calculation.</span></span></label>
                            <input type="number" id="cable-length" min="1" step="1" value="50" required>
                        </div>
                        <div class="form-group">
                            <label for="conductor-material">Conductor Material <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Material of the cable conductor (Copper or Aluminum). Affects resistance.</span></span></label>
                            <select id="conductor-material" required>
                                <option value="copper">Copper</option>
                                <option value="aluminum">Aluminum</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="conductor-size-selection">Assumed Conductor Size (mm²) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Select a common conductor size for voltage drop calculation. This is for illustrative purposes.</span></span></label>
                            <select id="conductor-size-selection" required>
                                <option value="1.5">1.5 mm²</option>
                                <option value="2.5">2.5 mm²</option>
                                <option value="4">4 mm²</option>
                                <option value="6">6 mm²</option>
                                <option value="10">10 mm²</option>
                                <option value="16">16 mm²</option>
                                <option value="25">25 mm²</option>
                                <option value="35">35 mm²</option>
                                <option value="50">50 mm²</option>
                                <option value="70">70 mm²</option>
                                <option value="95">95 mm²</option>
                                <option value="120">120 mm²</option>
                                <option value="150">150 mm²</option>
                                <option value="185">185 mm²</option>
                                <option value="240">240 mm²</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="overload-protection-factor">Overload Protection Factor (%) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Factor for continuous load. Typically 125% for motors (NEC 430.32).</span></span></label>
                            <input type="number" id="overload-protection-factor" min="100" max="150" step="5" value="125" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="breaker-type">Breaker Type <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Common types like MCCB, ACB, MCB. MCCB is typically for industrial motor applications.</span></span></label>
                            <select id="breaker-type" required>
                                <option value="mccb">Moulded Case Circuit Breaker (MCCB)</option>
                                <option value="acb">Air Circuit Breaker (ACB)</option>
                                <option value="mcb">Miniature Circuit Breaker (MCB)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="short-circuit-current">Available Short Circuit Current (kA) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The maximum fault current available at the breaker's location (e.g., 20 kA).</span></span></label>
                            <input type="number" id="short-circuit-current" min="0.1" step="0.1" value="20" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="device-coordination">Device Coordination Strategy <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Select coordination strategy (e.g., Selective, Fully Coordinated).</span></span></label>
                            <select id="device-coordination" required>
                                <option value="selective">Selective Coordination</option>
                                <option value="fully-coordinated">Fully Coordinated</option>
                                <option value="none">No Specific Coordination</option>
                            </select>
                        </div>
                    </div>

                    <button type="button" id="calculate-motor-breaker-btn" class="calculate-btn">
                        Calculate Motor Breaker <span id="motor-loading-spinner" class="loading-spinner" style="display:none;"></span>
                    </button>

                    <hr style="margin: 30px 0; border-color: var(--border-color);">

                    <!-- PCC/MCC Incomer Breaker Calculation Section -->
                    <h3>PCC/MCC Incomer Breaker Calculation</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="pcc-mcc-load-unit">Total Connected Load Unit <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Unit for the total connected load (kVA or kW).</span></span></label>
                            <select id="pcc-mcc-load-unit" required>
                                <option value="kVA">kVA</option>
                                <option value="kW">kW</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="pcc-mcc-total-load">Total Connected Load <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Sum of all connected loads to the PCC/MCC.</span></span></label>
                            <input type="number" id="pcc-mcc-total-load" min="0.1" step="0.1" value="500" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="pcc-mcc-demand-factor">Demand Factor (%) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Ratio of maximum demand to total connected load. Typically < 100%.</span></span></label>
                            <input type="number" id="pcc-mcc-demand-factor" min="1" max="100" step="1" value="70" required>
                        </div>
                        <div class="form-group">
                            <label for="pcc-mcc-diversity-factor">Diversity Factor (%) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Ratio of sum of individual maximum demands to the overall maximum demand. Typically > 100%.</span></span></label>
                            <input type="number" id="pcc-mcc-diversity-factor" min="100" step="1" value="120" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="pcc-mcc-future-expansion">Future Expansion (%) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Percentage for anticipated load growth.</span></span></label>
                            <input type="number" id="pcc-mcc-future-expansion" min="0" step="1" value="20" required>
                        </div>
                        <div class="form-group">
                            <label for="pcc-mcc-voltage">System Voltage (V) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Nominal system voltage for the PCC/MCC.</span></span></label>
                            <input type="number" id="pcc-mcc-voltage" min="1" step="1" value="400" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="pcc-mcc-voltage-type">System Voltage Type <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Specify if the system is Single Phase or Three Phase.</span></span></label>
                            <select id="pcc-mcc-voltage-type" required>
                                <option value="three-phase">Three Phase</option>
                                <option value="single-phase">Single Phase</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="pcc-mcc-power-factor">Power Factor (PF) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Overall power factor of the PCC/MCC loads.</span></span></label>
                            <input type="number" id="pcc-mcc-power-factor" min="0.1" max="1" step="0.01" value="0.85" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="pcc-mcc-breaker-type">Breaker Type <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Common types like ACB, MCCB for incomers.</span></span></label>
                            <select id="pcc-mcc-breaker-type" required>
                                <option value="acb">Air Circuit Breaker (ACB)</option>
                                <option value="mccb">Moulded Case Circuit Breaker (MCCB)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="pcc-mcc-short-circuit-current">Available Short Circuit Current (kA) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Max fault current at incomer location.</span></span></label>
                            <input type="number" id="pcc-mcc-short-circuit-current" min="0.1" step="0.1" value="50" required>
                        </div>
                    </div>

                    <button type="button" id="calculate-pcc-mcc-breaker-btn" class="calculate-btn">
                        Calculate PCC/MCC Breaker <span id="pcc-mcc-loading-spinner" class="loading-spinner" style="display:none;"></span>
                    </button>

                    <hr style="margin: 30px 0; border-color: var(--border-color);">

                    <!-- Transformer Breaker Calculation Section -->
                    <h3>Transformer Breaker Calculation</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="transformer-kVA">Transformer kVA Rating <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Rated power of the transformer in kVA.</span></span></label>
                            <input type="number" id="transformer-kVA" min="1" step="1" value="1000" required>
                        </div>
                        <div class="form-group">
                            <label for="transformer-primary-voltage">Primary Voltage (V) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Nominal voltage on the primary side of the transformer.</span></span></label>
                            <input type="number" id="transformer-primary-voltage" min="1" step="1" value="11000" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="transformer-secondary-voltage">Secondary Voltage (V) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Nominal voltage on the secondary side of the transformer.</span></span></label>
                            <input type="number" id="transformer-secondary-voltage" min="1" step="1" value="400" required>
                        </div>
                        <div class="form-group">
                            <label for="transformer-impedance">Transformer Impedance (Z%) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Percentage impedance of the transformer. Important for fault current calculation.</span></span></label>
                            <input type="number" id="transformer-impedance" min="1" max="10" step="0.1" value="5" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="transformer-connection-type">Transformer Connection Type <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Common connection types (e.g., Delta-Wye). Affects fault current calculation.</span></span></label>
                            <select id="transformer-connection-type" required>
                                <option value="delta-wye">Delta-Wye (Dy)</option>
                                <option value="wye-wye">Wye-Wye (Yy)</option>
                                <option value="delta-delta">Delta-Delta (Dd)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="transformer-breaker-type">Breaker Type (Primary/Secondary) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Common types like ACB, MCCB.</span></span></label>
                            <select id="transformer-breaker-type" required>
                                <option value="acb">Air Circuit Breaker (ACB)</option>
                                <option value="mccb">Moulded Case Circuit Breaker (MCCB)</option>
                                <option value="vcb">Vacuum Circuit Breaker (VCB)</option>
                            </select>
                        </div>
                    </div>

                    <button type="button" id="calculate-transformer-breaker-btn" class="calculate-btn">
                        Calculate Transformer Breaker <span id="transformer-loading-spinner" class="loading-spinner" style="display:none;"></span>
                    </button>
                </form>
            </div>

            <div id="result-container" class="result-container">
                <h3>Calculation Results</h3>
                <div id="motor-calculation-details" class="calculation-section"></div>
                <table class="result-table" id="motor-result-table">
                    <thead><tr><th colspan="2">Motor Circuit Breaker Results</th></tr></thead>
                    <tbody id="motor-result-table-body"></tbody>
                </table>

                <div id="pcc-mcc-calculation-details" class="calculation-section" style="margin-top: 30px;"></div>
                <table class="result-table" id="pcc-mcc-result-table" style="margin-top: 15px;">
                    <thead><tr><th colspan="2">PCC/MCC Incomer Breaker Results</th></tr></thead>
                    <tbody id="pcc-mcc-result-table-body"></tbody>
                </table>

                <div id="transformer-calculation-details" class="calculation-section" style="margin-top: 30px;"></div>
                <table class="result-table" id="transformer-result-table" style="margin-top: 15px;">
                    <thead><tr><th colspan="2">Transformer Breaker Results</th></tr></thead>
                    <tbody id="transformer-result-table-body"></tbody>
                </table>

                <div class="standard-reference" id="standard-reference">
                    <!-- Standard reference text will be inserted here -->
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <div class="disclaimer">
                
                <p>Disclaimer: Always verify calculation results against applicable engineering standards and guidelines.</p>
            </div>
            <div class="credit">
                <p>Created by A Sharma</p>
                <p>&copy; 2025 Design Calculators</p>
            </div>
            <div class="social-share">
                <h3>Share This Site</h3>
                <div class="social-buttons">
                    <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://designcalculators.co.in&title=Design Calculators - Electrical" target="_blank" class="social-btn linkedin">
                        <i class="fab fa-linkedin"></i>
                    </a>
                    <a href="https://www.facebook.com/sharer/sharer.php?u=https://designcalculators.co.in" target="_blank" class="social-btn facebook">
                        <i class="fab fa-facebook"></i>
                    </a>
                    <a href="https://twitter.com/intent/tweet?text=Check out this amazing Design Calculators - Electrical!&url=https://designcalculators.co.in" target="_blank" class="social-btn twitter">
                        <i class="fab fa-twitter"></i>
                    </a>
                    <a href="https://api.whatsapp.com/send?text=Check out this amazing Design Calculators - Electrical! https://designcalculators.co.in" target="_blank" class="social-btn whatsapp">
                        <i class="fab fa-whatsapp"></i>
                    </a>
                    <a href="https://www.reddit.com/submit?url=https://designcalculators.co.in&title=Design Calculators - Electrical" target="_blank" class="social-btn reddit">
                        <i class="fab fa-reddit"></i>
                    </a>
                </div>
            </div>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Start of IIFE to encapsulate all script logic
            (function() {
                // Changed const to var for top-level DOM element references
                var calculateMotorBtn = document.getElementById('calculate-motor-breaker-btn');
                var calculatePccMccBtn = document.getElementById('calculate-pcc-mcc-breaker-btn');
                var calculateTransformerBtn = document.getElementById('calculate-transformer-breaker-btn');

                var motorLoadingSpinner = document.getElementById('motor-loading-spinner');
                var pccMccLoadingSpinner = document.getElementById('pcc-mcc-loading-spinner');
                var transformerLoadingSpinner = document.getElementById('transformer-loading-spinner');

                var resultContainer = document.getElementById('result-container');

                var motorCalculationDetailsDiv = document.getElementById('motor-calculation-details');
                var motorResultTableBody = document.getElementById('motor-result-table-body');
                var motorResultTable = document.getElementById('motor-result-table');

                var pccMccCalculationDetailsDiv = document.getElementById('pcc-mcc-calculation-details');
                var pccMccResultTableBody = document.getElementById('pcc-mcc-result-table-body');
                var pccMccResultTable = document.getElementById('pcc-mcc-result-table');

                var transformerCalculationDetailsDiv = document.getElementById('transformer-calculation-details');
                var transformerResultTableBody = document.getElementById('transformer-result-table-body');
                var transformerResultTable = document.getElementById('transformer-result-table');

                var standardReference = document.getElementById('standard-reference');

                // Set default values for inputs
                // Motor Section
                document.getElementById('motor-power-unit').value = 'kw';
                document.getElementById('motor-power').value = 37;
                document.getElementById('motor-type').value = 'squirrel-cage';
                document.getElementById('motor-starting-method').value = 'dol';
                document.getElementById('voltage-type').value = 'three-phase';
                document.getElementById('system-voltage').value = 400;
                document.getElementById('power-factor').value = 0.8;
                document.getElementById('efficiency').value = 90;
                document.getElementById('cable-type').value = 75;
                document.getElementById('installation-method').value = 'conduit';
                document.getElementById('ambient-temp').value = 30;
                document.getElementById('number-of-conductors').value = 3;
                document.getElementById('cable-length').value = 50;
                document.getElementById('conductor-material').value = 'copper';
                document.getElementById('conductor-size-selection').value = 16;
                document.getElementById('overload-protection-factor').value = 125;
                document.getElementById('breaker-type').value = 'mccb';
                document.getElementById('short-circuit-current').value = 20;
                document.getElementById('device-coordination').value = 'selective';

                // PCC/MCC Section
                document.getElementById('pcc-mcc-load-unit').value = 'kVA';
                document.getElementById('pcc-mcc-total-load').value = 500;
                document.getElementById('pcc-mcc-demand-factor').value = 70;
                document.getElementById('pcc-mcc-diversity-factor').value = 120;
                document.getElementById('pcc-mcc-future-expansion').value = 20;
                document.getElementById('pcc-mcc-voltage').value = 400;
                document.getElementById('pcc-mcc-voltage-type').value = 'three-phase';
                document.getElementById('pcc-mcc-power-factor').value = 0.85;
                document.getElementById('pcc-mcc-breaker-type').value = 'acb';
                document.getElementById('pcc-mcc-short-circuit-current').value = 50;

                // Transformer Section
                document.getElementById('transformer-kVA').value = 1000;
                document.getElementById('transformer-primary-voltage').value = 11000;
                document.getElementById('transformer-secondary-voltage').value = 400;
                document.getElementById('transformer-impedance').value = 5;
                document.getElementById('transformer-connection-type').value = 'delta-wye';
                document.getElementById('transformer-breaker-type').value = 'acb';

                // Standard reference text
                const standardReferenceText = "Electrical system design, including breaker sizing, cable selection, and fault current analysis, is governed by international standards such as the National Electrical Code (NEC) in North America and IEC 60364 series (Electrical installations of buildings), IEC 60947 series (Low-voltage switchgear and controlgear), and IEC 60076 series (Power transformers) internationally. Key considerations include continuous load current, motor starting characteristics, cable ampacity adjustments, voltage drop limits, short-circuit current ratings, and protective device coordination. Always refer to the latest edition of relevant codes, manufacturer data sheets, and local regulations for accurate and compliant design.";


                // Function to hide all calculation details and result tables
                function hideAllResults() {
                    motorCalculationDetailsDiv.classList.remove('show');
                    motorResultTable.classList.remove('show');
                    pccMccCalculationDetailsDiv.classList.remove('show');
                    pccMccResultTable.classList.remove('show');
                    transformerCalculationDetailsDiv.classList.remove('show');
                    transformerResultTable.classList.remove('show');
                    resultContainer.classList.remove('show'); // Hide main result container too
                }

                // Event listener for Motor Breaker Calculation
                calculateMotorBtn.addEventListener('click', function() {
                    hideAllResults(); // Hide all other results
                    motorLoadingSpinner.style.display = 'inline-block';

                    setTimeout(() => {
                        const motorResults = calculateMotorBreaker();
                        if (motorResults) {
                            displayMotorResults(motorResults);
                            resultContainer.classList.add('show'); // Show main result container
                            motorResultTable.scrollIntoView({ behavior: 'smooth' });
                        }
                        motorLoadingSpinner.style.display = 'none';
                        standardReference.textContent = standardReferenceText;
                    }, 800);
                });

                // Event listener for PCC/MCC Incomer Breaker Calculation
                calculatePccMccBtn.addEventListener('click', function() {
                    hideAllResults(); // Hide all other results
                    pccMccLoadingSpinner.style.display = 'inline-block';

                    setTimeout(() => {
                        const pccMccResults = calculatePCCMCCBreaker();
                        if (pccMccResults) {
                            displayPCCMCCResults(pccMccResults);
                            resultContainer.classList.add('show'); // Show main result container
                            pccMccResultTable.scrollIntoView({ behavior: 'smooth' });
                        }
                        pccMccLoadingSpinner.style.display = 'none';
                        standardReference.textContent = standardReferenceText;
                    }, 800);
                });

                // Event listener for Transformer Breaker Calculation
                calculateTransformerBtn.addEventListener('click', function() {
                    hideAllResults(); // Hide all other results
                    transformerLoadingSpinner.style.display = 'inline-block';

                    setTimeout(() => {
                        const transformerResults = calculateTransformerBreaker();
                        if (transformerResults) {
                            displayTransformerResults(transformerResults);
                            resultContainer.classList.add('show'); // Show main result container
                            transformerResultTable.scrollIntoView({ behavior: 'smooth' });
                        }
                        transformerLoadingSpinner.style.display = 'none';
                        standardReference.textContent = standardReferenceText;
                    }, 800);
                });

                // --- Helper function to add rows to tables with animation ---
                function addResultRow(tableBody, parameter, value, delay) {
                    const row = tableBody.insertRow();
                    const paramCell = row.insertCell();
                    const valueCell = row.insertCell();
                    paramCell.textContent = parameter;
                    valueCell.textContent = value;
                    row.style.animationDelay = `${delay}s`;
                }

                // --- Function to display messages (replaces alert()) ---
                function displayMessage(message, type = "info") {
                    let messageBox = document.getElementById('custom-message-box');
                    if (!messageBox) {
                        messageBox = document.createElement('div');
                        messageBox.id = 'custom-message-box';
                        messageBox.style.cssText = `
                            position: fixed;
                            top: 20px;
                            left: 50%;
                            transform: translateX(-50%);
                            padding: 15px 25px;
                            border-radius: 8px;
                            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
                            z-index: 1000;
                            font-weight: bold;
                            color: white;
                            opacity: 0;
                            transition: opacity 0.5s ease-in-out;
                        `;
                        document.body.appendChild(messageBox);
                    }

                    messageBox.textContent = message;
                    if (type === "error") {
                        messageBox.style.backgroundColor = '#dc3545'; /* Red */
                    } else if (type === "warning") {
                        messageBox.style.backgroundColor = '#ffc107'; /* Amber */
                        messageBox.style.color = '#333';
                    } else {
                        messageBox.style.backgroundColor = '#28a745'; /* Green */
                    }
                    messageBox.style.opacity = 1;

                    // Hide after 5 seconds
                    setTimeout(() => {
                        messageBox.style.opacity = 0;
                    }, 5000);
                }

                // --- Motor Breaker Calculation Logic ---
                function calculateMotorBreaker() {
                    const motorPowerUnit = document.getElementById('motor-power-unit').value;
                    const motorPower = parseFloat(document.getElementById('motor-power').value);
                    const motorType = document.getElementById('motor-type').value;
                    const motorStartingMethod = document.getElementById('motor-starting-method').value;
                    const voltageType = document.getElementById('voltage-type').value;
                    const systemVoltage = parseFloat(document.getElementById('system-voltage').value);
                    const powerFactor = parseFloat(document.getElementById('power-factor').value);
                    const efficiency = parseFloat(document.getElementById('efficiency').value) / 100;
                    const cableType = parseFloat(document.getElementById('cable-type').value);
                    const installationMethod = document.getElementById('installation-method').value;
                    const ambientTemp = parseFloat(document.getElementById('ambient-temp').value);
                    const numberOfConductors = parseInt(document.getElementById('number-of-conductors').value);
                    const cableLength = parseFloat(document.getElementById('cable-length').value);
                    const conductorMaterial = document.getElementById('conductor-material').value;
                    const conductorSizeSelected = parseFloat(document.getElementById('conductor-size-selection').value);
                    const overloadProtectionFactor = parseFloat(document.getElementById('overload-protection-factor').value);
                    const breakerType = document.getElementById('breaker-type').value;
                    const shortCircuitCurrent = parseFloat(document.getElementById('short-circuit-current').value);
                    // Removed redundant declaration of deviceCoordination
                    const selectedDeviceCoordination = document.getElementById('device-coordination').value;

                    // Input validation (basic, more comprehensive validation can be added)
                    if (isNaN(motorPower) || isNaN(systemVoltage) || isNaN(powerFactor) || isNaN(efficiency) ||
                        isNaN(ambientTemp) || isNaN(numberOfConductors) || isNaN(cableLength) ||
                        isNaN(overloadProtectionFactor) || isNaN(shortCircuitCurrent) || isNaN(conductorSizeSelected)) {
                        displayMessage("Motor Breaker: Please fill in all required fields with valid numbers.", "error");
                        return null;
                    }
                    if (motorPower <= 0 || systemVoltage <= 0 || powerFactor <= 0 || powerFactor > 1 || efficiency <= 0 || efficiency > 1 ||
                        ambientTemp < 0 || numberOfConductors < 2 || cableLength <= 0 || overloadProtectionFactor < 100 || overloadProtectionFactor > 150 ||
                        shortCircuitCurrent <= 0) {
                        displayMessage("Motor Breaker: Please enter valid positive values for all inputs. Power Factor and Efficiency should be between 0 and 1 (or 100%). Ambient temperature non-negative. Number of conductors >= 2. Cable length > 0. Overload protection factor between 100 and 150.", "error");
                        return null;
                    }

                    let calculationHtml = '<h4>Motor Circuit Breaker Calculation Steps:</h4>';

                    // Step 1: Calculate Motor Full Load Amps (FLA) from Motor Power
                    let motorFLA;
                    const KW_TO_HP = 0.7457;

                    let motorPowerKW = motorPower;
                    if (motorPowerUnit === 'hp') {
                        motorPowerKW = motorPower * KW_TO_HP;
                    }

                    if (voltageType === 'three-phase') {
                        motorFLA = (motorPowerKW * 1000) / (Math.sqrt(3) * systemVoltage * powerFactor * efficiency);
                        calculationHtml += `<p><strong>1. Calculate Motor Full Load Amps (FLA):</strong></p>`;
                        calculationHtml += `<p>For a Three-Phase system:</p>`;
                        calculationHtml += `<p class="formula">$$I_{\\text{FLA}} = \\frac{P_{\\text{kW}} \\times 1000}{\\sqrt{3} \\times V \\times PF \\times \\eta}$$</p>`;
                        calculationHtml += `<p class="calculation-step">I_FLA = (${motorPowerKW.toFixed(2)} x 1000) / (1.732 x ${systemVoltage.toFixed(0)} x ${powerFactor.toFixed(2)} x ${efficiency.toFixed(2)}) = ${motorFLA.toFixed(2)} A</p>`;
                    } else { // Single-phase
                        motorFLA = (motorPowerKW * 1000) / (systemVoltage * powerFactor * efficiency);
                        calculationHtml += `<p><strong>1. Calculate Motor Full Load Amps (FLA):</strong></p>`;
                        calculationHtml += `<p>For a Single-Phase system:</p>`;
                        calculationHtml += `<p class="formula">$$I_{\\text{FLA}} = \\frac{P_{\\text{kW}} \\times 1000}{V \\times PF \\times \\eta}$$</p>`;
                        calculationHtml += `<p class="calculation-step">I_FLA = (${motorPowerKW.toFixed(2)} x 1000) / (${systemVoltage.toFixed(0)} x ${powerFactor.toFixed(2)} x ${efficiency.toFixed(2)}) = ${motorFLA.toFixed(2)} A</p>`;
                    }

                    // Step 2: Calculate Continuous Current for Breaker Sizing
                    const continuousCurrent = motorFLA * (overloadProtectionFactor / 100);
                    calculationHtml += `<p><strong>2. Calculate Continuous Current for Breaker Sizing:</strong></p>`;
                    calculationHtml += `<p class="formula">$$I_{\\text{continuous}} = \\text{FLA} \\times \\frac{\\text{Overload Protection Factor}}{100}$$</p>`;
                    calculationHtml += `<p class="calculation-step">I_continuous = ${motorFLA.toFixed(2)} A x ${overloadProtectionFactor.toFixed(0)} / 100 = ${continuousCurrent.toFixed(2)} A</p>`;

                    // Step 3: Determine Cable Ampacity Adjustment Factors
                    let tempCorrectionFactor;
                    if (cableType === 75) { /* ... logic ... */ tempCorrectionFactor = (ambientTemp <= 20) ? 1.05 : (ambientTemp <= 25) ? 1.00 : (ambientTemp <= 30) ? 0.96 : (ambientTemp <= 35) ? 0.91 : (ambientTemp <= 40) ? 0.87 : (ambientTemp <= 45) ? 0.82 : (ambientTemp <= 50) ? 0.76 : 0.0; } else { /* ... logic ... */ tempCorrectionFactor = (ambientTemp <= 20) ? 1.04 : (ambientTemp <= 25) ? 1.00 : (ambientTemp <= 30) ? 0.97 : (ambientTemp <= 35) ? 0.94 : (ambientTemp <= 40) ? 0.91 : (ambientTemp <= 45) ? 0.87 : (ambientTemp <= 50) ? 0.84 : 0.0; }
                    let bundleCorrectionFactor;
                    if (numberOfConductors <= 3) bundleCorrectionFactor = 1.00; else if (numberOfConductors <= 6) bundleCorrectionFactor = 0.80; else if (numberOfConductors <= 9) bundleCorrectionFactor = 0.70; else if (numberOfConductors <= 20) bundleCorrectionFactor = 0.50; else bundleCorrectionFactor = 0.45;

                    calculationHtml += `<p><strong>3. Determine Cable Ampacity Adjustment Factors:</strong></p>`;
                    calculationHtml += `<p class="calculation-step">Temperature Correction Factor = ${tempCorrectionFactor.toFixed(2)}, Bundle Correction Factor = ${bundleCorrectionFactor.toFixed(2)}</p>`;

                    // Step 4: Calculate Minimum Required Conductor Ampacity
                    const minRequiredConductorAmpacity = continuousCurrent;
                    calculationHtml += `<p><strong>4. Calculate Minimum Required Conductor Ampacity:</strong></p>`;
                    calculationHtml += `<p class="calculation-step">Min Required Conductor Ampacity = ${minRequiredConductorAmpacity.toFixed(2)} A</p>`;

                    // Step 5: Calculate Voltage Drop
                    const cableData = { /* ... data ... */
                        'copper': {
                            1.5: { R: 12.1, X: 0.09 }, 2.5: { R: 7.41, X: 0.09 }, 4: { R: 4.61, X: 0.09 },
                            6: { R: 3.08, X: 0.09 }, 10: { R: 1.83, X: 0.08 }, 16: { R: 1.15, X: 0.08 },
                            25: { R: 0.727, X: 0.08 }, 35: { R: 0.524, X: 0.08 }, 50: { R: 0.387, X: 0.08 },
                            70: { R: 0.268, X: 0.08 }, 95: { R: 0.193, X: 0.08 }, 120: { R: 0.153, X: 0.08 },
                            150: { R: 0.124, X: 0.08 }, 185: { R: 0.0991, X: 0.08 }, 240: { R: 0.0754, X: 0.08 }
                        },
                        'aluminum': {
                            1.5: { R: 19.8, X: 0.09 }, 2.5: { R: 12.0, X: 0.09 }, 4: { R: 7.41, X: 0.09 },
                            6: { R: 4.95, X: 0.09 }, 10: { R: 2.95, X: 0.08 }, 16: { R: 1.84, X: 0.08 },
                            25: { R: 1.18, X: 0.08 }, 35: { R: 0.85, X: 0.08 }, 50: { R: 0.628, X: 0.08 },
                            70: { R: 0.443, X: 0.08 }, 95: { R: 0.32, X: 0.08 }, 120: { R: 0.253, X: 0.08 },
                            150: { R: 0.206, X: 0.08 }, 185: { R: 0.164, X: 0.08 }, 240: { R: 0.125, X: 0.08 }
                        }
                    };
                    const selectedConductorData = cableData[conductorMaterial][conductorSizeSelected];
                    let voltageDrop = 0;
                    let percentVoltageDrop = 0;
                    if (selectedConductorData) {
                        const R = selectedConductorData.R;
                        const X = selectedConductorData.X;
                        const cosPhi = powerFactor;
                        const sinPhi = Math.sqrt(1 - (powerFactor * powerFactor));
                        if (voltageType === 'three-phase') {
                            voltageDrop = (Math.sqrt(3) * cableLength * continuousCurrent * (R * cosPhi + X * sinPhi)) / 1000;
                        } else {
                            voltageDrop = (2 * cableLength * continuousCurrent * (R * cosPhi + X * sinPhi)) / 1000;
                        }
                        percentVoltageDrop = (voltageDrop / systemVoltage) * 100;
                    }
                    calculationHtml += `<p><strong>5. Calculate Voltage Drop:</strong></p>`;
                    if (selectedConductorData) {
                        calculationHtml += `<p class="calculation-step">Voltage Drop = ${voltageDrop.toFixed(2)} V (${percentVoltageDrop.toFixed(2)}%)</p>`;
                    } else {
                        calculationHtml += `<p class="calculation-step">Voltage Drop calculation skipped due to missing conductor data.</p>`;
                    }

                    // Step 6: Calculate Breaker Frame Size
                    const standardBreakerSizes = [15, 20, 25, 30, 35, 40, 45, 50, 60, 70, 80, 90, 100, 110, 125, 150, 175, 200, 225, 250, 300, 350, 400, 450, 500, 600, 700, 800, 1000, 1200, 1600, 2000, 2500, 3000, 4000, 5000, 6000];
                    let selectedBreakerFrameSize = standardBreakerSizes.find(size => size >= continuousCurrent);
                    if (!selectedBreakerFrameSize) { selectedBreakerFrameSize = standardBreakerSizes[standardBreakerSizes.length - 1]; }
                    calculationHtml += `<p><strong>6. Calculate Breaker Frame Size:</strong></p>`;
                    calculationHtml += `<p class="calculation-step">Selected Breaker Frame Size = ${selectedBreakerFrameSize.toFixed(0)} A</p>`;

                    // Step 7: Thermal Trip Setting
                    const thermalTripSetting = motorFLA * (overloadProtectionFactor / 100);
                    calculationHtml += `<p><strong>7. Determine Thermal Trip Setting (Long-Time Delay):</strong></p>`;
                    calculationHtml += `<p class="calculation-step">Thermal Trip Setting = ${thermalTripSetting.toFixed(2)} A</p>`;

                    // Step 8: Magnetic Trip Setting
                    let motorTypeStartingFactor;
                    switch(motorType) { case 'squirrel-cage': motorTypeStartingFactor = 6; break; case 'synchronous': motorTypeStartingFactor = 3.5; break; case 'wound-rotor': motorTypeStartingFactor = 2.5; break; default: motorTypeStartingFactor = 6; }
                    let startingMethodReductionFactor;
                    switch(motorStartingMethod) { case 'dol': startingMethodReductionFactor = 1.0; break; case 'star-delta': startingMethodReductionFactor = 1 / Math.sqrt(3); break; case 'soft-starter': startingMethodReductionFactor = 0.5; break; default: startingMethodReductionFactor = 1.0; }
                    const effectiveStartingCurrentFactor = motorTypeStartingFactor * startingMethodReductionFactor;
                    const estimatedStartingCurrent = motorFLA * effectiveStartingCurrentFactor;
                    let minMagneticTripFactor = 7; let maxMagneticTripFactor = 10;
                    if (breakerType === 'acb') { minMagneticTripFactor = 5; maxMagneticTripFactor = 8; } else if (breakerType === 'mcb') { minMagneticTripFactor = 5; maxMagneticTripFactor = 10; }
                    let magneticTripLowerBound = Math.max(estimatedStartingCurrent * 1.1, motorFLA * minMagneticTripFactor);
                    let magneticTripUpperBound = motorFLA * maxMagneticTripFactor;
                    magneticTripLowerBound = Math.ceil(magneticTripLowerBound / 50) * 50;
                    magneticTripUpperBound = Math.ceil(magneticTripUpperBound / 50) * 50;
                    calculationHtml += `<p><strong>8. Determine Magnetic Trip Setting (Instantaneous Trip):</strong></p>`;
                    calculationHtml += `<p class="calculation-step">Suggested Magnetic Trip Range: ${magneticTripLowerBound.toFixed(0)} A to ${magneticTripUpperBound.toFixed(0)} A</p>`;

                    // Step 9: Calculate Short Circuit Breaking Capacity
                    const requiredBreakingCapacity = shortCircuitCurrent;
                    calculationHtml += `<p><strong>9. Determine Short Circuit Breaking Capacity (Icu/Ics):</strong></p>`;
                    calculationHtml += `<p class="calculation-step">Minimum Required Breaking Capacity = ${requiredBreakingCapacity.toFixed(2)} kA</p>`;

                    // Step 10: Device Coordination Considerations
                    let coordinationRecommendation = "";
                    if (selectedDeviceCoordination === 'selective') { coordinationRecommendation = "Selective coordination ensures only the faulted section is isolated."; } else if (selectedDeviceCoordination === 'fully-coordinated') { coordinationRecommendation = "Fully coordinated systems minimize disruption through detailed analysis."; } else { coordinationRecommendation = "No specific coordination strategy selected. Nuisance tripping may occur."; }
                    calculationHtml += `<p><strong>10. Device Coordination Strategy:</strong></p>`;
                    calculationHtml += `<p class="calculation-step">${coordinationRecommendation}</p>`;

                    return {
                        html: calculationHtml,
                        results: {
                            motorPower: `${motorPower.toFixed(2)} ${motorPowerUnit.toUpperCase()}`,
                            calculatedMotorFLA: motorFLA.toFixed(2) + " A",
                            motorType: motorType.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' '),
                            motorStartingMethod: motorStartingMethod.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' '),
                            systemVoltage: systemVoltage.toFixed(0) + " V (" + voltageType.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ') + ")",
                            powerFactor: powerFactor.toFixed(2),
                            motorEfficiency: (efficiency * 100).toFixed(1) + "%",
                            cableInsulationType: cableType + "°C",
                            installationMethod: installationMethod === "conduit" ? "In Conduit/Tray" : "Open Air",
                            ambientTemperature: ambientTemp.toFixed(1) + "°C",
                            numberOfConductors: numberOfConductors,
                            cableLength: cableLength.toFixed(0) + " m",
                            conductorMaterial: conductorMaterial.charAt(0).toUpperCase() + conductorMaterial.slice(1),
                            assumedConductorSize: conductorSizeSelected + " mm²",
                            calculatedVoltageDrop: `${voltageDrop.toFixed(2)} V (${percentVoltageDrop.toFixed(2)}%)`,
                            overloadProtectionFactor: overloadProtectionFactor.toFixed(0) + "%",
                            selectedBreakerType: breakerType.toUpperCase(),
                            availableShortCircuitCurrent: shortCircuitCurrent.toFixed(2) + " kA",
                            deviceCoordinationStrategy: selectedDeviceCoordination.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' '),
                            recommendedBreakerFrameSize: selectedBreakerFrameSize.toFixed(0) + " A",
                            recommendedThermalTripSetting: thermalTripSetting.toFixed(2) + " A",
                            recommendedMagneticTripRange: `${magneticTripLowerBound.toFixed(0)} A to ${magneticTripUpperBound.toFixed(0)} A`,
                            minimumRequiredBreakingCapacity: requiredBreakingCapacity.toFixed(2) + " kA"
                        }
                    };
                }

                // --- PCC/MCC Incomer Breaker Calculation Logic ---
                function calculatePCCMCCBreaker() {
                    const pccMccLoadUnit = document.getElementById('pcc-mcc-load-unit').value;
                    const pccMccTotalLoad = parseFloat(document.getElementById('pcc-mcc-total-load').value);
                    const pccMccDemandFactor = parseFloat(document.getElementById('pcc-mcc-demand-factor').value) / 100;
                    const pccMccDiversityFactor = parseFloat(document.getElementById('pcc-mcc-diversity-factor').value) / 100;
                    const pccMccFutureExpansion = parseFloat(document.getElementById('pcc-mcc-future-expansion').value) / 100;
                    const pccMccVoltage = parseFloat(document.getElementById('pcc-mcc-voltage').value);
                    const pccMccVoltageType = document.getElementById('pcc-mcc-voltage-type').value;
                    const pccMccPowerFactor = parseFloat(document.getElementById('pcc-mcc-power-factor').value);
                    const pccMccBreakerType = document.getElementById('pcc-mcc-breaker-type').value;
                    const pccMccShortCircuitCurrent = parseFloat(document.getElementById('pcc-mcc-short-circuit-current').value);

                    // Input validation
                    if (isNaN(pccMccTotalLoad) || isNaN(pccMccDemandFactor) || isNaN(pccMccDiversityFactor) ||
                        isNaN(pccMccFutureExpansion) || isNaN(pccMccVoltage) || isNaN(pccMccPowerFactor) ||
                        isNaN(pccMccShortCircuitCurrent)) {
                        displayMessage("PCC/MCC Breaker: Please fill in all required fields with valid numbers.", "error");
                        return null;
                    }
                    if (pccMccTotalLoad <= 0 || pccMccDemandFactor <= 0 || pccMccDemandFactor > 1 ||
                        pccMccDiversityFactor < 1 || pccMccFutureExpansion < 0 || pccMccVoltage <= 0 ||
                        pccMccPowerFactor <= 0 || pccMccPowerFactor > 1 || pccMccShortCircuitCurrent <= 0) {
                        displayMessage("PCC/MCC Breaker: Please enter valid positive values. Demand Factor (0-100%), Diversity Factor (>=100%), Future Expansion (>=0%).", "error");
                        return null;
                    }

                    let calculationHtml = '<h4>PCC/MCC Incomer Breaker Calculation Steps:</h4>';

                    // Step 1: Calculate Diversified Load
                    let diversifiedLoadKVA;
                    let totalConnectedLoadKVA = pccMccTotalLoad;
                    if (pccMccLoadUnit === 'kW') {
                        // Convert kW to kVA using the power factor
                        totalConnectedLoadKVA = pccMccTotalLoad / pccMccPowerFactor;
                    }

                    // Diversified Load = (Total Connected Load * Demand Factor) / Diversity Factor
                    // Then add future expansion
                    diversifiedLoadKVA = (totalConnectedLoadKVA * pccMccDemandFactor) / pccMccDiversityFactor;
                    const designLoadKVA = diversifiedLoadKVA * (1 + pccMccFutureExpansion);

                   
                    calculationHtml += `<p><strong>1. Calculate Design Load:</strong></p>`;
                    calculationHtml += `<p>The design load considers the total connected load, demand factor (simultaneous operation), diversity factor (non-simultaneous peak demands), and future expansion.</p>`;
                    calculationHtml += `<p class="formula">$$P_{\\text{diversified, kVA}} = \\frac{P_{\\text{connected, kVA}} \\times \\text{Demand Factor}}{\\text{Diversity Factor}}$$</p>`;
                    calculationHtml += `<p class="formula">$$P_{\\text{design, kVA}} = P_{\\text{diversified, kVA}} \\times (1 + \\text{Future Expansion})$$</p>`;
                    calculationHtml += `<p class="calculation-step">Total Connected Load = ${pccMccTotalLoad.toFixed(2)} ${pccMccLoadUnit.toUpperCase()}</p>`;
                    if (pccMccLoadUnit === 'kW') {
                        calculationHtml += `<p class="calculation-step">Converted Total Connected Load = ${totalConnectedLoadKVA.toFixed(2)} kVA (at PF ${pccMccPowerFactor.toFixed(2)})</p>`;
                    }
                    calculationHtml += `<p class="calculation-step">Diversified Load = (${totalConnectedLoadKVA.toFixed(2)} kVA x ${pccMccDemandFactor.toFixed(2)}) / ${pccMccDiversityFactor.toFixed(2)} = ${diversifiedLoadKVA.toFixed(2)} kVA</p>`;
                    calculationHtml += `<p class="calculation-step">Design Load = ${diversifiedLoadKVA.toFixed(2)} kVA x (1 + ${pccMccFutureExpansion.toFixed(2)}) = ${designLoadKVA.toFixed(2)} kVA</p>`;


                    // Step 2: Calculate Design Current
                    let designCurrent;
                    if (pccMccVoltageType === 'three-phase') {
                        // I = (kVA * 1000) / (sqrt(3) * V)
                        designCurrent = (designLoadKVA * 1000) / (Math.sqrt(3) * pccMccVoltage);
                        calculationHtml += `<p><strong>2. Calculate Design Current:</strong></p>`;
                        calculationHtml += `<p>For a Three-Phase system:</p>`;
                        calculationHtml += `<p class="formula">$$I_{\\text{design}} = \\frac{P_{\\text{design, kVA}} \\times 1000}{\\sqrt{3} \\times V}$$</p>`;
                        calculationHtml += `<p class="calculation-step">I_design = (${designLoadKVA.toFixed(2)} x 1000) / (1.732 x ${pccMccVoltage.toFixed(0)}) = ${designCurrent.toFixed(2)} A</p>`;
                    } else { // Single-phase
                        // I = (kVA * 1000) / V
                        designCurrent = (designLoadKVA * 1000) / pccMccVoltage;
                        calculationHtml += `<p><strong>2. Calculate Design Current:</strong></p>`;
                        calculationHtml += `<p>For a Single-Phase system:</p>`;
                        calculationHtml += `<p class="formula">$$I_{\\text{design}} = \\frac{P_{\\text{design, kVA}} \\times 1000}{V}$$</p>`;
                        calculationHtml += `<p class="calculation-step">I_design = (${designLoadKVA.toFixed(2)} x 1000) / (${pccMccVoltage.toFixed(0)}) = ${designCurrent.toFixed(2)} A</p>`;
                    }

                    // Step 3: Select Breaker Frame Size (typically 125% of design current for continuous loads)
                    const requiredContinuousCurrent = designCurrent * 1.25; // NEC 210.19(A)(1) for continuous loads
                    const standardBreakerSizes = [100, 125, 150, 175, 200, 225, 250, 300, 350, 400, 450, 500, 600, 700, 800, 1000, 1200, 1600, 2000, 2500, 3000, 4000, 5000, 6000];
                    let selectedBreakerFrameSize = standardBreakerSizes.find(size => size >= requiredContinuousCurrent);
                    if (!selectedBreakerFrameSize) { selectedBreakerFrameSize = standardBreakerSizes[standardBreakerSizes.length - 1]; }
                    calculationHtml += `<p><strong>3. Select Breaker Frame Size:</strong></p>`;
                    calculationHtml += `<p class="calculation-step">Required Continuous Current (125% of Design Current) = ${requiredContinuousCurrent.toFixed(2)} A</p>`;
                    calculationHtml += `<p class="calculation-step">Selected Breaker Frame Size = ${selectedBreakerFrameSize.toFixed(0)} A</p>`;

                    // Step 4: Determine Thermal Trip Setting (typically 100% of design current, or adjustable range)
                    // For incomers, thermal trip is usually set to match or slightly exceed the design current.
                    const thermalTripSetting = designCurrent;
                    calculationHtml += `<p><strong>4. Determine Thermal Trip Setting:</strong></p>`;
                    calculationHtml += `<p class="formula">$$I_{\\text{thermal, trip}} = I_{\\text{design}}$$</p>`;
                    calculationHtml += `<p class="calculation-step">Thermal Trip Setting = ${thermalTripSetting.toFixed(2)} A</p>`;

                    // Step 5: Determine Magnetic Trip Setting (Instantaneous Trip)
                    // For incomers, magnetic trip is usually set higher to allow for downstream fault clearing.
                    // A common range is 5-10 times the breaker's nominal rating or adjustable range.
                    const minMagneticTripFactor = 5; // 500%
                    const maxMagneticTripFactor = 10; // 1000%
                    let magneticTripLowerBound = selectedBreakerFrameSize * minMagneticTripFactor;
                    let magneticTripUpperBound = selectedBreakerFrameSize * maxMagneticTripFactor;
                    magneticTripLowerBound = Math.ceil(magneticTripLowerBound / 100) * 100; // Round to nearest 100A
                    magneticTripUpperBound = Math.ceil(magneticTripUpperBound / 100) * 100;

                    calculationHtml += `<p><strong>5. Determine Magnetic Trip Setting (Instantaneous Trip):</strong></p>`;
                    calculationHtml += `<p class="calculation-step">Suggested Magnetic Trip Range: ${magneticTripLowerBound.toFixed(0)} A to ${magneticTripUpperBound.toFixed(0)} A</p>`;

                    // Step 6: Determine Short Circuit Breaking Capacity (Icu/Ics)
                    const requiredBreakingCapacity = pccMccShortCircuitCurrent;
                    calculationHtml += `<p><strong>6. Determine Short Circuit Breaking Capacity (Icu/Ics):</strong></p>`;
                    calculationHtml += `<p class="calculation-step">Minimum Required Breaking Capacity = ${requiredBreakingCapacity.toFixed(2)} kA</p>`;

                    return {
                        html: calculationHtml,
                        results: {
                            totalConnectedLoad: `${pccMccTotalLoad.toFixed(2)} ${pccMccLoadUnit.toUpperCase()}`,
                            designLoad: `${designLoadKVA.toFixed(2)} kVA`,
                            designCurrent: `${designCurrent.toFixed(2)} A`,
                            selectedBreakerFrameSize: `${selectedBreakerFrameSize.toFixed(0)} A`,
                            recommendedThermalTripSetting: `${thermalTripSetting.toFixed(2)} A`,
                            recommendedMagneticTripRange: `${magneticTripLowerBound.toFixed(0)} A to ${magneticTripUpperBound.toFixed(0)} A`,
                            minimumRequiredBreakingCapacity: `${requiredBreakingCapacity.toFixed(2)} kA`,
                            breakerType: pccMccBreakerType.toUpperCase()
                        }
                    };
                }

                // --- Transformer Breaker Calculation Logic ---
                function calculateTransformerBreaker() {
                    const transformerKVA = parseFloat(document.getElementById('transformer-kVA').value);
                    const primaryVoltage = parseFloat(document.getElementById('transformer-primary-voltage').value);
                    const secondaryVoltage = parseFloat(document.getElementById('transformer-secondary-voltage').value);
                    const transformerImpedance = parseFloat(document.getElementById('transformer-impedance').value) / 100; // Convert to decimal
                    const transformerConnectionType = document.getElementById('transformer-connection-type').value;
                    const transformerBreakerType = document.getElementById('transformer-breaker-type').value;

                    // Input validation
                    if (isNaN(transformerKVA) || isNaN(primaryVoltage) || isNaN(secondaryVoltage) ||
                        isNaN(transformerImpedance)) {
                        displayMessage("Transformer Breaker: Please fill in all required fields with valid numbers.", "error");
                        return null;
                    }
                    if (transformerKVA <= 0 || primaryVoltage <= 0 || secondaryVoltage <= 0 ||
                        transformerImpedance <= 0 || transformerImpedance > 0.1) { // Z% typically 1-10%
                        displayMessage("Transformer Breaker: Please enter valid positive values. Impedance should be between 1% and 10%.", "error");
                        return null;
                    }

                    let calculationHtml = '<h4>Transformer Breaker Calculation Steps:</h4>';

                    // Step 1: Calculate Transformer Full Load Currents (Primary and Secondary)
                    const primaryFLA = (transformerKVA * 1000) / (Math.sqrt(3) * primaryVoltage);
                    const secondaryFLA = (transformerKVA * 1000) / (Math.sqrt(3) * secondaryVoltage);

                    calculationHtml += `<p><strong>1. Calculate Transformer Full Load Currents:</strong></p>`;
                    calculationHtml += `<p class="formula">$$I_{\\text{FLA}} = \\frac{\\text{kVA} \\times 1000}{\\sqrt{3} \\times V}$$</p>`;
                    calculationHtml += `<p class="calculation-step">Primary FLA = (${transformerKVA.toFixed(0)} x 1000) / (1.732 x ${primaryVoltage.toFixed(0)}) = ${primaryFLA.toFixed(2)} A</p>`;
                    calculationHtml += `<p class="calculation-step">Secondary FLA = (${transformerKVA.toFixed(0)} x 1000) / (1.732 x ${secondaryVoltage.toFixed(0)}) = ${secondaryFLA.toFixed(2)} A</p>`;

                    // Step 2: Determine Primary Breaker Rating
                    // NEC 450.3(B) allows primary overcurrent protection up to 125% of FLA for transformers 600V or less,
                    // and up to 250% for transformers over 600V. For simplicity, we'll use 125% for continuous load.
                    const primaryBreakerRating = primaryFLA * 1.25;
                    const standardBreakerSizes = [15, 20, 25, 30, 35, 40, 45, 50, 60, 70, 80, 90, 100, 110, 125, 150, 175, 200, 225, 250, 300, 350, 400, 450, 500, 600, 700, 800, 1000, 1200, 1600, 2000, 2500, 3000, 4000, 5000, 6000];
                    let selectedPrimaryBreakerSize = standardBreakerSizes.find(size => size >= primaryBreakerRating);
                    if (!selectedPrimaryBreakerSize) { selectedPrimaryBreakerSize = standardBreakerSizes[standardBreakerSizes.length - 1]; }

                    calculationHtml += `<p><strong>2. Determine Primary Breaker Rating:</strong></p>`;
                    calculationHtml += `<p class="calculation-step">Required Primary Breaker Rating (125% of FLA) = ${primaryBreakerRating.toFixed(2)} A</p>`;
                    calculationHtml += `<p class="calculation-step">Selected Primary Breaker Size = ${selectedPrimaryBreakerSize.toFixed(0)} A</p>`;

                    // Step 3: Determine Secondary Breaker Rating
                    // NEC 450.3(B) allows secondary overcurrent protection up to 125% of FLA for transformers 600V or less,
                    const secondaryBreakerRating = secondaryFLA * 1.25;
                    let selectedSecondaryBreakerSize = standardBreakerSizes.find(size => size >= secondaryBreakerRating);
                    if (!selectedSecondaryBreakerSize) { selectedSecondaryBreakerSize = standardBreakerSizes[standardBreakerSizes.length - 1]; }

                    calculationHtml += `<p><strong>3. Determine Secondary Breaker Rating:</strong></p>`;
                    calculationHtml += `<p class="calculation-step">Required Secondary Breaker Rating (125% of FLA) = ${secondaryBreakerRating.toFixed(2)} A</p>`;
                    calculationHtml += `<p class="calculation-step">Selected Secondary Breaker Size = ${selectedSecondaryBreakerSize.toFixed(0)} A</p>`;

                    // Step 4: Calculate Secondary Side Fault Current
                    // Isc = Secondary FLA / (Z% / 100)
                    const secondaryFaultCurrent = secondaryFLA / transformerImpedance;
                    calculationHtml += `<p><strong>4. Calculate Secondary Side Fault Current:</strong></p>`;
                    calculationHtml += `<p>This is crucial for selecting the interrupting rating of downstream devices.</p>`;
                    calculationHtml += `<p class="formula">$$I_{\\text{sc, secondary}} = \\frac{\\text{Secondary FLA}}{Z\\% / 100}$$</p>`;
                    calculationHtml += `<p class="calculation-step">Secondary Fault Current = ${secondaryFLA.toFixed(2)} A / ${transformerImpedance.toFixed(2)} = ${secondaryFaultCurrent.toFixed(2)} A (${(secondaryFaultCurrent / 1000).toFixed(2)} kA)</p>`;

                    return {
                        html: calculationHtml,
                        results: {
                            transformerKVA: `${transformerKVA.toFixed(0)} kVA`,
                            primaryVoltage: `${primaryVoltage.toFixed(0)} V`,
                            secondaryVoltage: `${secondaryVoltage.toFixed(0)} V`,
                            transformerImpedance: `${(transformerImpedance * 100).toFixed(1)}%`,
                            primaryFLA: `${primaryFLA.toFixed(2)} A`,
                            secondaryFLA: `${secondaryFLA.toFixed(2)} A`,
                            selectedPrimaryBreakerSize: `${selectedPrimaryBreakerSize.toFixed(0)} A`,
                            selectedSecondaryBreakerSize: `${selectedSecondaryBreakerSize.toFixed(0)} A`,
                            secondaryFaultCurrent: `${(secondaryFaultCurrent / 1000).toFixed(2)} kA`,
                            breakerType: transformerBreakerType.toUpperCase()
                        }
                    };
                }


                // --- Functions to display results in their respective sections ---
                function displayMotorResults(data) {
                    motorCalculationDetailsDiv.innerHTML = data.html;
                    if (window.MathJax) { window.MathJax.typesetPromise([motorCalculationDetailsDiv]); }
                    motorCalculationDetailsDiv.classList.add('show');
                    motorResultTableBody.innerHTML = ''; // Clear previous results
                    let animationDelay = 0;
                    const delayIncrement = 0.05;
                    for (const key in data.results) {
                        addResultRow(motorResultTableBody, key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase()), data.results[key], animationDelay);
                        animationDelay += delayIncrement;
                    }
                    motorResultTable.classList.add('show');
                }

                function displayPCCMCCResults(data) {
                    pccMccCalculationDetailsDiv.innerHTML = data.html;
                    if (window.MathJax) { window.MathJax.typesetPromise([pccMccCalculationDetailsDiv]); }
                    pccMccCalculationDetailsDiv.classList.add('show');
                    pccMccResultTableBody.innerHTML = '';
                    let animationDelay = 0;
                    const delayIncrement = 0.05;
                    for (const key in data.results) {
                        addResultRow(pccMccResultTableBody, key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase()), data.results[key], animationDelay);
                        animationDelay += delayIncrement;
                    }
                    pccMccResultTable.classList.add('show');
                }

                function displayTransformerResults(data) {
                    transformerCalculationDetailsDiv.innerHTML = data.html;
                    if (window.MathJax) { window.MathJax.typesetPromise([transformerCalculationDetailsDiv]); }
                    transformerCalculationDetailsDiv.classList.add('show');
                    transformerResultTableBody.innerHTML = '';
                    let animationDelay = 0;
                    const delayIncrement = 0.05;
                    for (const key in data.results) {
                        addResultRow(transformerResultTableBody, key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase()), data.results[key], animationDelay);
                        animationDelay += delayIncrement;
                    }
                    transformerResultTable.classList.add('show');
                }

                // Theme switch logic
                const themeSwitch = document.getElementById('theme-switch');
                if (themeSwitch) {
                    if (localStorage.getItem('theme') === 'dark') {
                        document.body.classList.add('dark-mode');
                        themeSwitch.checked = true;
                    }
                    themeSwitch.addEventListener('change', function() {
                        if (this.checked) {
                            document.body.classList.add('dark-mode');
                            localStorage.setItem('theme', 'dark');
                        } else {
                            document.body.classList.remove('dark-mode');
                            localStorage.setItem('theme', 'light');
                        }
                    });
                }
            })(); // End of IIFE
        });
    </script>
</body>
</html>