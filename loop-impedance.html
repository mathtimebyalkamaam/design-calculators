<!DOCTYPE html>
<html lang="en">
<head>
    <!-- SEO Meta Tags -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loop Impedance & Voltage Drop Calculator (4-20mA) - Design Calculators - Instrumentation</title>
    <meta name="description" content="Professional 4-20mA loop voltage drop calculator. Ensures loop compliance by calculating total loop resistance, wire voltage drop, and available transmitter voltage.">
    <meta name="keywords" content="4-20ma calculator, voltage drop, loop impedance, instrumentation, loop power, awg, wire resistance, isa, iec, process control">
    <meta name="author" content="Design Calculators">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://designcalculators.co.in/loop-impedance.html" />

    <!-- AdSense & Analytics -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5936527763614780" crossorigin="anonymous"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-23Y1V450SR"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-23Y1V450SR');
    </script>
    
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Montserrat:wght@700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- MathJax for Formulas -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']]
            },
            svg: { fontCache: 'global' },
            options: {
                processHtmlClass: 'math-content', // Process elements with this class
                ignoreHtmlClass: 'no-mathjax'     // Ignore elements with this class
            }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <!-- Favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">

    <style>
        /* NEW: Root variables from provided file */
        :root {
            --primary: #1E3A8A;
            --secondary: #2563EB;
            --accent: #F59E0B;
            --success: #10B981;
            --danger: #DC2626;
            --warning: #F59E0B;
            --bg: #F8FAFC;
            --card: #FFFFFF;
            --text: #4B5563;
            --heading: #111827;
            --footer-bg: #0F172A;
            --border: #E2E8F0;
            --grad: linear-gradient(135deg, var(--primary), var(--secondary));
            --grad-dark: linear-gradient(135deg, #0F172A, #1E293B);
            --shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.1);
            
            /* Specific to this tool, using new theme */
            --reset-button-bg: var(--accent);
            --reset-button-hover-bg: #DAA520;
            --clear-button-bg: var(--secondary);
            --clear-button-hover-bg: var(--primary);
            
            /* NEW: Map tool-specific colors to theme */
            --voltage-color: var(--warning); 
            --voltage-color-dark: var(--accent);
            --ok-color: var(--success);
            --error-color: var(--danger);
            --warning-color: var(--warning); 
        }

        /* NEW: Dark mode variables from provided file */
        body.dark-mode {
            --primary: #10B981;
            --secondary: #34D399;
            --bg: #0F172A;
            --card: #1E293B;
            --text: #CBD5E1;
            --heading: #F1F5F9;
            --footer-bg: #020617;
            --border: #334155;

            /* Specific to this tool, using new theme */
            --reset-button-bg: var(--accent);
            --reset-button-hover-bg: #DAA520;
            --clear-button-bg: var(--secondary);
            --clear-button-hover-bg: var(--primary);
            
            /* NEW: Map tool-specific colors to theme */
            --voltage-color: var(--warning);
            --voltage-color-dark: var(--accent);
            --ok-color: var(--success);
            --error-color: var(--danger);
            --warning-color: var(--warning);
        }

        /* General Body Styling (Updated) */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background: var(--bg);
            color: var(--text);
            line-height: 1.7;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 24px;
        }
        
        /* NEW: Header styles (from provided file) */
        header {
            background: var(--grad);
            color: white;
            padding: 24px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo-container {
            display: flex;
            flex-direction: column;
            text-decoration: none;
            color: white;
        }
        .logo-text {
            font-size: 1.75rem;
            font-weight: 800;
            font-family: 'Montserrat', sans-serif;
        }
        .logo-subtitle {
            font-size: 0.8rem;
            margin: 4px 0 0 0;
            color: #E0E7FF;
            opacity: 0.9;
        }
        .nav-links {
            display: flex;
            gap: 24px;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        .nav-links a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }
        .nav-links a:hover { color: var(--accent); }
        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .switch {
            position: relative;
            width: 56px;
            height: 30px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.2);
            transition: .4s;
            border-radius: 30px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--accent);
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }

        main {
            padding: 40px 0;
        }

        /* Main Card Styling (Updated) */
        .tool-container {
            background-color: var(--card);
            border-radius: 12px;
            padding: 30px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            border: 1px solid var(--border);
            transition: transform 0.3s ease-in-out;
        }

        .tool-container:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .tool-container h2 {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
            padding-bottom: 15px;
            margin-top: 0;
            margin-bottom: 20px;
            font-family: 'Montserrat', sans-serif;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .tool-description {
            margin-bottom: 20px;
            color: var(--text);
            font-size: 1.05rem;
        }

        /* NEW: Footer styles (from provided file) */
        footer {
            background: var(--grad-dark);
            color: #CBD5E1;
            padding: 50px 0 20px 0;
            margin-top: 60px;
        }
        .footer-content {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 40px;
            margin-bottom: 30px;
        }
        .footer-col {
            flex: 1;
            min-width: 200px;
        }
        .footer-col h4 {
            color: white;
            margin-bottom: 15px;
            font-weight: 700;
        }
        .footer-col ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .footer-col a {
            color: #CBD5E1;
            text-decoration: none;
            transition: color 0.3s;
        }
        .footer-col a:hover {
            color: var(--accent);
        }
        .social-buttons {
            display: flex;
            gap: 12px;
            margin-top: 15px;
        }
        .social-btn {
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            border-radius: 50%;
            font-size: 1.1rem;
            transition: transform 0.3s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .social-btn:hover {
            transform: translateY(-4px);
        }
        .social-btn.linkedin { background-color: #0A66C2; }
        .social-btn.youtube { background-color: #FF0000; }
        .social-btn.twitter { background-color: #1DA1F2; }
        .social-btn.facebook { background-color: #1877F2; }
        .social-btn.whatsapp { background-color: #25D366; }
        .footer-disclaimer {
            text-align: center;
            padding-top: 25px;
            border-top: 1px solid #334155;
            max-width: 800px;
            margin: 0 auto;
            font-size: 0.9rem;
        }
        .footer-bottom {
            text-align: center;
            padding-top: 20px;
            font-size: 0.9rem;
            color: #94A3B8;
        }

        /* Styles for Calculator Forms and Results (Updated) */
        .calculator-form {
            background-color: var(--card);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: none;
        }
        
        .form-section {
            background-color: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 25px; /* Space between sections */
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
            opacity: 0; /* Initial state for fade-in animation */
            transform: translateY(10px); /* Initial state for slide-up animation */
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }

        .form-section.fade-in {
            opacity: 1;
            transform: translateY(0);
        }

        .form-section h3 {
            color: var(--secondary);
            margin-top: 0;
            margin-bottom: 15px;
            border-bottom: 1px dashed var(--border);
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px; /* Default margin for form groups */
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--heading);
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 6px;
            background-color: var(--bg);
            color: var(--text);
            box-sizing: border-box; /* Ensure padding doesn't increase width */
            transition: border-color 0.3s, box-shadow 0.3s;
            font-size: 1rem;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Responsive grid */
            gap: 20px; /* Gap between grid items */
            margin-bottom: 0; /* Handled by form-group margin */
        }
        
        /* Updated Button Styles */
        .calculate-btn {
            background: var(--grad);
            color: white;
            border: none;
            padding: 16px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 700;
            margin-top: 25px;
            transition: all 0.3s;
            width: auto;
            min-width: 220px;
            box-shadow: 0 4px 12px rgba(30, 58, 138, 0.3);
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }
        
        .calculate-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(30, 58, 138, 0.4);
        }

        .reset-btn {
            background-color: var(--reset-button-bg);
            color: #333;
            border: none;
            padding: 16px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 700;
            margin-top: 25px;
            margin-left: 15px;
            transition: all 0.3s;
            width: auto;
            min-width: 150px;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .reset-btn:hover {
            background-color: var(--reset-button-hover-bg);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(245, 158, 11, 0.4);
        }

        .clear-results-btn {
            background-color: var(--clear-button-bg);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 700;
            margin-top: 15px;
            transition: all 0.3s;
            box-shadow: var(--shadow);
        }

        .clear-results-btn:hover {
            background-color: var(--clear-button-hover-bg);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .result-container {
            margin-top: 30px;
            padding: 30px;
            border-radius: 12px;
            background-color: var(--card);
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            display: none; /* Hidden by default */
            opacity: 0; /* For animation */
            transform: translateY(20px); /* Initial state for animation */
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }
        
        .result-container.show {
            opacity: 1;
            transform: translateY(0);
        }

        .result-container h3 {
            color: var(--primary);
            margin-bottom: 20px;
            text-align: center;
            font-family: 'Montserrat', sans-serif;
            font-size: 1.8rem;
        }
        
        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 25px;
            border-radius: 8px;
            overflow: hidden; /* Ensures rounded corners apply to table content */
            box-shadow: var(--shadow);
        }
        
        .result-table th, .result-table td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
            transition: background-color 0.3s;
        }
        
        .result-table th {
            background: var(--grad);
            font-weight: 700;
            color: white;
        }

        .result-table tr:last-child td {
            border-bottom: none; /* No border for the last row */
        }
        
        .result-table tr:nth-child(even) {
            background-color: var(--bg);
        }

        .result-table tbody tr:hover {
            background-color: var(--border);
        }
        
        .result-table td:first-child {
            font-weight: 600;
            color: var(--heading);
        }
        
        .standard-reference {
            margin-top: 20px;
            font-style: italic;
            font-size: 0.9rem;
            color: var(--text);
            padding: 15px;
            border-left: 4px solid var(--primary);
            background-color: var(--bg);
            border-radius: 4px;
        }
        
        .info-icon {
            color: var(--primary);
            margin-left: 5px;
            cursor: help;
            transition: color 0.3s;
        }

        .info-icon:hover {
            color: var(--accent);
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 10;
            bottom: 125%;
            left: 50%;
            margin-left: -125px;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            transform: translateY(10px);
            font-size: 0.85em;
            font-family: 'Inter', sans-serif;
            line-height: 1.4;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
            transform: translateY(0);
        }

        /* Custom message box style (Updated) */
        #custom-message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 16px 28px;
            border-radius: 8px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.25);
            z-index: 10000;
            font-weight: 600;
            color: white;
            opacity: 0;
            transition: all 0.4s;
            display: none;
            align-items: center;
            justify-content: center;
            min-width: 250px;
        }
        #custom-message-box.show {
            display: flex;
            opacity: 1;
            top: 30px;
        }

        /* NEW: Styles for calculation steps (from provided file) */
        .steps-container {
            display: none;
            margin-top: 30px;
        }
        .steps-container.active {
            display: block;
        }
        .step-card {
            background: var(--card);
            border-radius: 12px;
            padding: 25px 30px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            animation: slideIn 0.6s ease-out;
            transition: all 0.3s;
            margin-bottom: 25px; /* Spacing between cards */
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .step-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }
        .step-card h4 {
            color: var(--primary);
            margin: 0 0 20px 0;
            font-size: 1.4rem;
            font-family: 'Montserrat', sans-serif;
            display: flex;
            align-items: center;
        }
        .step-card .number {
            display: inline-block;
            width: 40px;
            height: 40px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 40px;
            font-weight: 700;
            margin-right: 15px;
            font-size: 1.3rem;
            flex-shrink: 0;
        }
        .step-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            align-items: start;
        }
        @media (max-width: 768px) {
            .step-content {
                grid-template-columns: 1fr;
            }
        }
        .step-content .formula-block {
            background: var(--bg);
            border-radius: 8px;
            padding: 20px;
            font-size: 1rem;
            border: 1px solid var(--border);
        }
        .step-content .formula-block p {
            margin-top: 0;
        }
        .step-content .formula {
            background: var(--bg);
            border-left: 3px solid var(--accent);
            padding: 15px;
            margin: 12px 0;
            font-size: 1rem;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
        }
        .step-value {
            font-size: 2.2rem;
            font-weight: 800;
            color: var(--success);
            margin: 10px 0;
            line-height: 1.2;
        }
        .step-unit {
            font-size: 1rem;
            color: var(--text);
            opacity: 0.8;
            font-weight: 500;
            margin-left: 5px;
        }
        .step-explanation {
            font-size: 1.05rem;
            line-height: 1.8;
        }
        
        .button-wrapper {
            display: flex;
            justify-content: center; /* Center the button horizontally */
            flex-wrap: wrap;
            gap: 15px;
            width: 100%;
            padding-top: 20px;
        }

        /* Animation for input fields on focus (Updated) */
        .form-group input:focus, .form-group select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
            outline: none;
            /* Removed pulse animation */
        }
        body.dark-mode .form-group input:focus, 
        body.dark-mode .form-group select:focus {
             box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        /* Specific styles for Loop Impedance Calculator (Updated) */
        .unit-system-selector, .wire-gauge-input-selector, .wire-material-selector {
            margin-bottom: 20px;
            background-color: var(--bg);
            border-radius: 8px;
            padding: 10px;
            display: flex;
            align-items: center;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 10px;
        }
        .unit-system-selector label, .wire-gauge-input-selector label, .wire-material-selector label {
            font-weight: 600;
            color: var(--heading);
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 6px;
            transition: all 0.2s;
        }
        .unit-system-selector select {
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 6px;
            background-color: var(--card);
            color: var(--text);
            font-size: 1rem;
            font-weight: 600;
        }

        .wire-gauge-input-selector label:has(input:checked), 
        .wire-material-selector label:has(input:checked) {
            background-color: var(--card);
            color: var(--primary);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .wire-gauge-input-selector input[type="radio"], .wire-material-selector input[type="radio"] {
            margin-right: 8px;
            transform: scale(1.2);
            accent-color: var(--primary);
        }

        #wire-gauge-awg-group, #wire-gauge-mm2-group {
            display: none; /* Hidden by default */
            margin-top: 15px;
            border-top: 1px dashed var(--border);
            padding-top: 15px;
        }
        #wire-gauge-awg-group.active, #wire-gauge-mm2-group.active {
            display: block;
        }
        
        /* Voltage Drop Visualization (Updated) */
        .voltage-drop-visualization-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 30px;
            margin-bottom: 20px;
            padding: 20px;
            background-color: var(--bg);
            border-radius: 8px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            flex-direction: column;
        }
        .voltage-bar-container {
            width: 80%;
            height: 30px;
            background-color: var(--ok-color); /* Represents available supply voltage */
            border-radius: 5px;
            overflow: hidden;
            position: relative;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 10px;
            box-sizing: border-box;
            border: 1px solid var(--border);
        }
        .voltage-drop-overlay {
            position: absolute;
            top: 0;
            right: 0;
            height: 100%;
            background: linear-gradient(to left, var(--voltage-color), var(--voltage-color-dark));
            transition: width 1.5s ease-out; /* Smooth animation */
            border-radius: 5px;
            z-index: 1;
        }
        .voltage-bar-label {
            color: white;
            font-weight: bold;
            z-index: 2; /* Ensure text is above overlay */
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        .loop-status-display {
            font-weight: bold;
            font-size: 1.2em;
            margin-top: 15px;
            padding: 10px 20px;
            border-radius: 5px;
            transition: background-color 0.5s, color 0.5s;
            text-align: center;
        }
        .loop-status-display.ok {
            background-color: var(--ok-color);
            color: white;
        }
        .loop-status-display.error {
            background-color: var(--error-color);
            color: white;
        }
        .loop-status-display.warning {
            background-color: var(--warning-color);
            color: var(--heading); /* Dark text for warning background */
        }
        
        /* NEW: Educational Section Styles (from provided file) */
        .education-section {
            margin-top: 40px;
            margin-bottom: 40px;
            background: var(--card);
            border-radius: 12px;
            padding: 30px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }
        
        .education-section h2 {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
            padding-bottom: 15px;
            margin-top: 0;
            font-family: 'Montserrat', sans-serif;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .insight-card {
            background: linear-gradient(135deg, var(--card), rgba(37,99,235,0.03));
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            border-left: 5px solid var(--secondary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: all 0.3s;
        }
        .insight-card:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .insight-card h4 {
            color: var(--secondary);
            font-size: 1.3rem;
            margin: 0 0 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .insight-card h4 i {
            font-size: 1.5rem;
        }
        .insight-card p {
            margin: 10px 0;
            line-height: 1.8;
        }
        .insight-card ol,
        .insight-card ul {
            padding-left: 20px;
            margin: 10px 0;
        }
        .insight-card li {
            margin-bottom: 10px;
        }

        .danger-box {
            background: linear-gradient(135deg, rgba(220,38,38,0.1), rgba(220,38,38,0.05));
            border-left: 5px solid var(--danger);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }
        .danger-box h4 {
            color: var(--danger);
            margin-top: 0;
        }
        .success-box {
            background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(16,185,129,0.05));
            border-left: 5px solid var(--success);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }
        .success-box h4 {
            color: var(--success);
            margin-top: 0;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container { padding: 0 15px; }
            .navbar { flex-direction: column; gap: 20px; }
            .nav-links { flex-direction: column; gap: 12px; text-align: center; }
            .form-row { grid-template-columns: 1fr; }
            .tool-container, .education-section, .result-container { padding: 20px; }
            .footer-content { flex-direction: column; gap: 25px; }
        }
        .hidden { display: none; }
        
    </style>
</head>
<body>
    <!-- NEW: Message box -->
    <div id="custom-message-box" class="message-box"></div>
    
    <!-- NEW: Header from provided file -->
    <header>
        <div class="container">
            <nav class="navbar">
                <a href="index.html" class="logo-container">
                    <span class="logo-text">Design Calculators</span>
                    <p class="logo-subtitle">Inspired by standards such as IEC, IEEE, ISA, ASME, and API.</p>
                </a>
                <ul class="nav-links">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="articles">Articles</a></li>
                    <li><a href="indexmech">Mechanical</a></li>
                    <li><a href="indexele">Electrical</a></li>
                    <li><a href="indexinst">Instrumentation</a></li>
                </ul>
                <div class="theme-toggle">
                    <i class="fas fa-sun"></i>
                    <label class="switch">
                        <input type="checkbox" id="theme-switch">
                        <span class="slider"></span>
                    </label>
                    <i class="fas fa-moon"></i>
                </div>
            </nav>
        </div>
    </header>

    <main class="container">
        <!-- "Back to Tools" button REMOVED -->
        
        <div class="tool-container">
            <h2><i class="fas fa-bolt"></i> Loop Impedance & Voltage Drop Calculator (4-20 mA)</h2>
            
            <div class="tool-description">
                <p>This professional tool calculates the total loop resistance and voltage drop in <strong>4-20 mA current loops</strong>. Accurate calculation is vital to ensure sufficient voltage is available at the field device for proper operation, especially in long cable runs or complex instrumentation systems across all industries worldwide.</p>
            </div>
        
            <div class="calculator-form">
                <form id="loop-calculator-form">
                    <!-- Unit System Selection (Updated) -->
                    <div class="form-section unit-system-selector">
                        <label for="unit-system">Select Unit System:</label>
                        <select id="unit-system" required>
                            <option value="metric">Metric (meters, mm²)</option>
                            <option value="imperial">Imperial (feet, AWG)</option>
                        </select>
                    </div>

                    <!-- Loop Parameters -->
                    <div class="form-section">
                        <h3><i class="fas fa-plug"></i> Loop Parameters</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="supply-voltage" id="label-supply-voltage">Power Supply Voltage (V<sub>supply</sub>) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The voltage provided by the power supply to the 4-20 mA loop.</span></span></label>
                                <input type="number" id="supply-voltage" step="0.1" value="24.0" required>
                            </div>
                            <div class="form-group">
                                <label for="transmitter-voltage-drop" id="label-transmitter-voltage-drop">Transmitter Minimum Voltage (V<sub>TX,min</sub>) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The minimum voltage required for the 4-20 mA transmitter to operate correctly.</span></span></label>
                                <input type="number" id="transmitter-voltage-drop" step="0.1" value="10.0" required>
                            </div>
                            <div class="form-group">
                                <label for="load-resistance" id="label-load-resistance">Receiver/Load Resistance (R<sub>load</sub>) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The resistance of the receiver or load in the 4-20 mA loop (e.g., PLC analog input impedance).</span></span></label>
                                <input type="number" id="load-resistance" step="1" value="250.0" required>
                            </div>
                            <div class="form-group">
                                <label for="loop-length" id="label-loop-length">Loop Length (L) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The one-way length of the cable. The calculator accounts for two-way resistance.</span></span></label>
                                <input type="number" id="loop-length" step="1" value="100.0" required>
                            </div>
                        </div>
                    </div>

                    <!-- Wire Properties -->
                    <div class="form-section">
                        <h3><i class="fas fa-wave-square"></i> Wire Properties</h3>
                        <div class="wire-material-selector">
                            <label>Wire Material:</label>
                            <label>
                                <input type="radio" name="wire-material" value="copper" checked> Copper
                            </label>
                            <label>
                                <input type="radio" name="wire-material" value="aluminum"> Aluminum
                            </label>
                        </div>
                        <div class="wire-gauge-input-selector">
                            <label>Wire Gauge Input Method:</label>
                            <label>
                                <input type="radio" name="wire-gauge-method" value="awg" checked> AWG
                            </label>
                            <label>
                                <input type="radio" name="wire-gauge-method" value="mm2"> Cross-sectional Area (mm²)
                            </label>
                        </div>
                        <div class="form-row">
                            <div class="form-group" id="wire-gauge-awg-group" class="active">
                                <label for="wire-gauge-awg">Wire Gauge (AWG) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">American Wire Gauge. Smaller AWG numbers mean larger wire diameter.</span></span></label>
                                <select id="wire-gauge-awg" required>
                                    <option value="24">24 AWG</option>
                                    <option value="22">22 AWG</option>
                                    <option value="20">20 AWG</option>
                                    <option value="18" selected>18 AWG</option>
                                    <option value="16">16 AWG</option>
                                    <option value="14">14 AWG</option>
                                    <option value="12">12 AWG</option>
                                    <option value="10">10 AWG</option>
                                </select>
                            </div>
                            <div class="form-group" id="wire-gauge-mm2-group">
                                <label for="wire-gauge-mm2" id="label-wire-gauge-mm2">Cross-sectional Area (A) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The cross-sectional area of the wire.</span></span></label>
                                <input type="number" id="wire-gauge-mm2" step="0.01" value="0.823" required>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Advanced Loop Parameters -->
                    <div class="form-section">
                        <h3><i class="fas fa-cog"></i> Advanced Loop Parameters</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="ambient-temperature">Ambient Temperature (T) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The ambient temperature where the cable is installed. Wire resistance changes with temperature. (Units: °C)</span></span></label>
                                <input type="number" id="ambient-temperature" step="1" value="20" required>
                            </div>
                            <div class="form-group">
                                <label for="barrier-resistance">Intrinsic Safety Barrier Resistance (R<sub>barrier</sub>) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The series resistance added by an intrinsic safety barrier in hazardous area installations. (Units: Ohm)</span></span></label>
                                <input type="number" id="barrier-resistance" step="1" value="0" required>
                            </div>
                            <div class="form-group">
                                <label for="max-voltage-drop-percentage">Max Allowed Wire Voltage Drop (%) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The maximum permissible voltage drop *across the wire only*, as a percentage of the supply voltage. (e.g., 5% or 10%)</span></span></label>
                                <input type="number" id="max-voltage-drop-percentage" step="0.5" value="10" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="button-wrapper">
                        <button type="button" id="calculate-loop-btn" class="calculate-btn"><i class="fas fa-calculator"></i> Calculate</button>
                        <button type="button" id="reset-form-btn" class="reset-btn"><i class="fas fa-sync-alt"></i> Reset</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Results Container (Updated) -->
        <div id="result-container" class="result-container">
            <h3><i class="fas fa-clipboard-check"></i> Loop Calculation Results</h3>
            
            <div class="voltage-drop-visualization-container">
                <div class="voltage-bar-container">
                    <span class="voltage-bar-label">Supply: <span id="supply-voltage-display">0.00 V</span></span>
                    <div class="voltage-drop-overlay" id="voltage-drop-overlay" style="width: 0%;"></div>
                    <span class="voltage-bar-label">Margin: <span id="remaining-voltage-display">0.00 V</span></span>
                </div>
                <p class="loop-status-display" id="loop-status-display">Status: N/A</p>
                <p class="loop-status-display" id="voltage-drop-percentage-status" style="display: none;">Voltage Drop % Status: N/A</p>
            </div>
            
            <!-- NEW: Step-by-Step Calculation Cards -->
            <div id="steps-container" class="steps-container math-content">
                <!-- Calculation steps will be inserted here -->
            </div>
            
            <!-- Summary Table -->
            <table class="result-table">
                <thead>
                    <tr>
                        <th>Parameter</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody id="result-table-body">
                    <!-- Results will be dynamically inserted here -->
                </tbody>
            </table>
            
            <div style="display: flex; justify-content: center; margin-top: 20px;">
                <button type="button" id="clear-results-btn" class="clear-results-btn"><i class="fas fa-times-circle"></i> Clear Results</button>
            </div>
            
            <div class="standard-reference" id="standard-reference">
                <!-- Standard reference text will be inserted here -->
            </div>
            
            <!-- NEW: Educational Section -->
            <div id="education-section" class="education-section">
                <h2><i class="fas fa-lightbulb"></i> Professional Insights: The 4-20 mA Voltage Budget</h2>
    
                <div class="insight-card">
                    <h4><i class="fas fa-project-diagram"></i> What is a 4-20 mA Current Loop?</h4>
                    <p>The 4-20 mA current loop is the dominant analog signaling standard in the industrial control world. A transmitter (e.g., a temperature or pressure sensor) regulates the current in a two-wire loop to be proportional to its measurement. The receiver (e.g., a PLC or DCS analog input card) reads this current.</p>
                    <ul>
                        <li><strong>4 mA (Low Limit):</strong> Represents the "live zero" or 0% of the process range. The fact that it's not 0 mA is a key feature: a reading of 0 mA indicates a broken wire or failed transmitter (Fault Detection).</li>
                        <li><strong>20 mA (High Limit):</strong> Represents 100% of the process range.</li>
                    </ul>
                    <p>This standard is incredibly robust because the signal is a *current*, not a voltage. Voltage signals (like 0-10V) are highly susceptible to "voltage drop" and electrical noise over long cable runs. A current signal, by Kirchhoff's Law, is the <strong>same at every point in a series loop</strong>, whether the cable is 10 feet or 3,000 feet long. This noise immunity is why it's the global standard for instrumentation.</p>
                </div>
    
                <div class="danger-box">
                    <h4><i class="fas fa-exclamation-triangle"></i> The "Voltage Budget": Why This Calculation is Critical</h4>
                    <p>While the *signal* (current) isn't affected by distance, the *power* to run the loop is. The transmitter is "loop-powered," meaning it sips a tiny amount of voltage from the loop to power its own electronics. If the voltage at its terminals drops too low, it fails.</p>
                    <p>This calculator performs a "Voltage Budget" to ensure the loop is viable. The fundamental rule is:</p>
                    <div class="formula-block" style="text-align:center; font-weight:bold; font-size: 1.1rem; background-color: var(--card); border-color: var(--danger);">
                        V<sub>Supply</sub> ≥ Σ (All Voltage Drops in the Loop)
                    </div>
                    <p>If the total voltage *required* by all components (wire, load, barriers, and the transmitter itself) is greater than what the 24V power supply provides, the loop will fail. This failure isn't always obvious; it might work at 10mA (50%) but fail at 20mA (100%), leading to non-linear readings and erratic behavior. <strong>This calculation is performed at 20mA (worst-case scenario) to guarantee reliability.</strong></p>
                </div>
    
                <div class="insight-card">
                    <h4><i class="fas fa-list-ol"></i> The "Consumers" of Voltage in a Loop</h4>
                    <p>A typical 2-wire loop has four components that "consume" voltage from the supply. The total of these drops must be less than the supply voltage (e.g., 24V).</p>
                    <ol>
                        <li><strong>The Transmitter (V<sub>TX,min</sub>):</strong> This is the minimum voltage the "smart" device needs to power its own internal electronics (processor, sensor, display). This value (e.g., 10V, 12V) is found in the transmitter's data sheet.</li>
                        <li><strong>The Receiver/Load (V<sub>load</sub>):</strong> This is the voltage drop across the analog input card (PLC/DCS). This card has a precision resistor (typically 250Ω) to convert the 4-20mA current back into a voltage (1-5V) that its ADC can read. 
                        <br><code>V<sub>load</sub> = I<sub>max</sub> × R<sub>load</sub> = 0.020A × 250Ω = 5.0 V</code></li>
                        <li><strong>The Cable (V<sub>wire</sub>):</strong> This is the voltage "lost" as heat in the copper cable. It depends on the wire's resistance and the loop current. This is the primary variable this tool calculates, as it's a function of length, gauge, and temperature.
                        <br><code>V<sub>wire</sub> = I<sub>max</sub> × R<sub>wire,total</sub></code></li>
                        <li><strong>Intrinsic Safety (IS) Barriers (V<sub>barrier</sub>):</strong> In hazardous areas, a safety barrier is placed in the loop. This barrier has a known internal resistance (e.g., 50Ω to 300Ω) that adds another significant voltage drop.
                        <br><code>V<sub>barrier</sub> = I<sub>max</sub> × R<sub>barrier</sub></code></li>
                    </ol>
                </div>
                
                <div class="success-box">
                    <h4><i class="fas fa-check-circle"></i> The Golden Formula: Loop Compliance</h4>
                    <p>This calculator determines loop compliance by solving this equation:</p>
                    <div class="formula-block math-content" style="text-align:center; font-weight:bold; font-size: 1.1rem; background-color: var(--card); border-color: var(--success);">
                        $$V_{margin} = V_{supply} - (V_{wire} + V_{load} + V_{barrier} + V_{TX,min})$$
                    </div>
                    <p>The <strong>Voltage Margin</strong> must be greater than zero. A healthy margin (e.g., > 1-2 Volts) is recommended to account for future degradation, temperature swings, or variations in power supply voltage. If this calculation results in a negative number, your loop <strong>will not work reliably</strong> at 20mA.</p>
                </div>
    
                <div class="insight-card">
                    <h4><i class="fas-ruler-horizontal"></i> How Wire Resistance is Calculated (The Physics)</h4>
                    <p>The resistance of a wire is not just a guess; it's calculated using a fundamental physics formula:</p>
                    <div class="formula-block math-content" style="text-align:center; font-weight:bold; font-size: 1.1rem;">
                         $$R = \rho \times \frac{L}{A}$$
                    </div>
                    <ul>
                        <li><strong>R:</strong> Resistance (what we want to find).</li>
                        <li><strong>ρ (rho):</strong> Resistivity. This is an intrinsic property of the material. Copper has a lower resistivity (≈ 1.68×10<sup>-8</sup> Ω·m) than Aluminum (≈ 2.82×10<sup>-8</sup> Ω·m), making it a better conductor.</li>
                        <li><strong>L:</strong> Total Length of the wire (this tool uses one-way length $\times$ 2).</li>
                        <li><strong>A:</strong> Cross-sectional Area of the conductor. A larger wire (smaller AWG or larger mm²) has a larger 'A', which *decreases* the resistance.</li>
                    </ul>
                    <p>This tool either looks up the resistance/length for a given AWG or calculates it directly if you provide the area in mm².</p>
                </div>
    
                <div class="danger-box">
                    <h4><i class="fas fa-thermometer-half"></i> The "Gotcha": Temperature Correction</h4>
                    <p>The wire resistance calculated above is only valid at a reference temperature (usually 20°C / 68°F). As a cable gets hotter (e.g., in a sunny cable tray or near a hot process), its resistance *increases*. This calculator accounts for this:</p>
                     <div class="formula-block math-content" style="text-align:center; font-weight:bold; font-size: 1.1rem;">
                         $$R_{ambient} = R_{20°C} \times [1 + \alpha (T_{ambient} - 20)]$$
                    </div>
                    <p>Where <strong>$\alpha$ (alpha)</strong> is the temperature coefficient of the metal (e.g., 0.00393 for copper). A cable installed at 50°C can have over 11% more resistance than its 20°C rating, which could be enough to make a borderline loop fail. Always use a realistic ambient temperature for your calculation!</p>
                </div>
            </div>
            
        </div>
    </main>

    <!-- NEW: Footer from provided file -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-col">
                    <h4>Design Calculators</h4>
                    <p style="font-size: 0.9rem; line-height: 1.6; margin-bottom: 15px;">If you find this tool helpful, please consider sharing it with your colleagues!</p>
                    <div class="social-buttons">
                        <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn linkedin" title="LinkedIn"><i class="fab fa-linkedin-in"></i></a>
                        <a href="https://www.youtube.com/@designcalculators" target="_blank" rel="noopener noreferrer" class="social-btn youtube" title="YouTube"><i class="fab fa-youtube"></i></a>
                        <a href="https://twitter.com/intent/tweet?url=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn twitter" title="Twitter"><i class="fab fa-twitter"></i></a>
                        <a href="https://www.facebook.com/sharer/sharer.php?u=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn facebook" title="Facebook"><i class="fab fa-facebook-f"></i></a>
                        <a href="https://api.whatsapp.com/send?text=Check%20out%20this%20amazing%20engineering%20resource%20https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn whatsapp" title="WhatsApp"><i class="fab fa-whatsapp"></i></a>
                    </div>
                </div>
                <div class="footer-col">
                    <h4>Quick Links</h4>
                    <ul>
                        <li><a href="index.html">Home</a></li>
                        <li><a href="indexele">Electrical</a></li>
                        <li><a href="indexmech">Mechanical</a></li>
                        <li><a href="indexinst">Instrumentation</a></li>                        
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>Resources</h4>
                    <ul>
                        <li><a href="about">About Us</a></li>
                        <li><a href="contact">Contact</a></li>
                        <li><a href="faq">FAQ</a></li>
                        <li><a href="privacy-policy">Privacy Policy</a></li>
                        <li><a href="terms-of-service">Terms of Service</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>More</h4>
                    <ul>
                        <li><a href="articles.html">Articles & Whitepapers</a></li>
                        <li><a href="sitemap2.html">Sitemap</a></li>                        
                    </ul>
                </div>
            </div>
            <div class="footer-disclaimer">
                <p>This tool offers general guidance. Results should be reviewed for accuracy and compliance with relevant project standards and regulations before use.</p>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Design Calculators. Created by <span style="color: var(--secondary); font-weight: bold;">A Sharma</span>. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- Element Selection ---
            const unitSystemSelect = document.getElementById('unit-system');
            const wireGaugeMethodRadios = document.querySelectorAll('input[name="wire-gauge-method"]');
            const wireMaterialRadios = document.querySelectorAll('input[name="wire-material"]');

            const supplyVoltageInput = document.getElementById('supply-voltage');
            const transmitterVoltageDropInput = document.getElementById('transmitter-voltage-drop');
            const loadResistanceInput = document.getElementById('load-resistance');
            const loopLengthInput = document.getElementById('loop-length');
            const wireGaugeAWGSelect = document.getElementById('wire-gauge-awg');
            const wireGaugeMM2Input = document.getElementById('wire-gauge-mm2');
            const ambientTemperatureInput = document.getElementById('ambient-temperature');
            const barrierResistanceInput = document.getElementById('barrier-resistance');
            const maxVoltageDropPercentageInput = document.getElementById('max-voltage-drop-percentage');

            const wireGaugeAWGGroup = document.getElementById('wire-gauge-awg-group');
            const wireGaugeMM2Group = document.getElementById('wire-gauge-mm2-group');

            const labelSupplyVoltage = document.getElementById('label-supply-voltage');
            const labelTransmitterVoltageDrop = document.getElementById('label-transmitter-voltage-drop');
            const labelLoadResistance = document.getElementById('label-load-resistance');
            const labelLoopLength = document.getElementById('label-loop-length');
            const labelWireGaugeMM2 = document.getElementById('label-wire-gauge-mm2');

            const calculateLoopBtn = document.getElementById('calculate-loop-btn');
            const resetFormBtn = document.getElementById('reset-form-btn');
            const clearResultsBtn = document.getElementById('clear-results-btn');
            const resultContainer = document.getElementById('result-container');
            const resultTableBody = document.getElementById('result-table-body');
            const standardReference = document.getElementById('standard-reference');
            
            // UPDATED: Get new calculation steps container
            const calculationDetailsDiv = document.getElementById('steps-container');

            const supplyVoltageDisplay = document.getElementById('supply-voltage-display');
            const remainingVoltageDisplay = document.getElementById('remaining-voltage-display');
            const voltageDropOverlay = document.getElementById('voltage-drop-overlay');
            const loopStatusDisplay = document.getElementById('loop-status-display');
            const voltageDropPercentageStatus = document.getElementById('voltage-drop-percentage-status');
            
            // --- Constants ---
            const MAX_LOOP_CURRENT_MA = 20; // mA
            const RESISTIVITY_COPPER_SI = 1.68e-8; // Ohm·m at 20°C
            const RESISTIVITY_ALUMINUM_SI = 2.82e-8; // Ohm·m at 20°C
            const TEMP_COEFF_COPPER = 0.00393; // per °C
            const TEMP_COEFF_ALUMINUM = 0.00403; // per °C
            const REFERENCE_TEMPERATURE = 20; // °C
            
            // AWG to Resistance (Ohm/m for copper at 20°C)
            const WIRE_GAUGE_OHM_PER_M_COPPER = {
                '24': 0.0842, '22': 0.0530, '20': 0.0333, '18': 0.0210,
                '16': 0.0132, '14': 0.00828, '12': 0.00521, '10': 0.00328,
            };
            
            // --- Default Values ---
            const defaultValues = {
                'unit-system': 'metric',
                'wire-gauge-method': 'awg',
                'wire-material': 'copper',
                'supply-voltage': 24.0, 'transmitter-voltage-drop': 10.0,
                'load-resistance': 250.0, 'loop-length': 100.0,
                'wire-gauge-awg': '18', 'wire-gauge-mm2': 0.823,
                'ambient-temperature': 20, 'barrier-resistance': 0,
                'max-voltage-drop-percentage': 10,
            };
            
            // --- Unit Configurations ---
            const unitsConfig = {
                'metric': {
                    length: { label: 'm', tooltip: 'meters', toSI: 1, fromSI: 1, precision: 2 },
                    area: { label: 'mm²', tooltip: 'square millimeters', toSI: 1e-6, fromSI: 1e6, precision: 3 },
                },
                'imperial': {
                    length: { label: 'ft', tooltip: 'feet', toSI: 0.3048, fromSI: 3.28084, precision: 0 },
                    area: { label: 'AWG', tooltip: 'American Wire Gauge', precision: 0 },
                }
            };

            // --- Event Listeners ---
            unitSystemSelect.addEventListener('change', updateUnitLabelsAndTooltips);
            wireGaugeMethodRadios.forEach(radio => radio.addEventListener('change', updateWireGaugeInputVisibility));
            wireMaterialRadios.forEach(radio => radio.addEventListener('change', updateUnitLabelsAndTooltips));
            calculateLoopBtn.addEventListener('click', calculateLoopParameters);
            resetFormBtn.addEventListener('click', resetForm);
            clearResultsBtn.addEventListener('click', clearResults);

            // --- Initial Setup ---
            updateUnitLabelsAndTooltips();
            updateWireGaugeInputVisibility();
            
            const formSections = document.querySelectorAll('.form-section');
            formSections.forEach((section, index) => {
                setTimeout(() => { section.classList.add('fade-in'); }, 100 * index);
            });

            // --- Helper Functions ---
            function addResultRow(parameter, value) {
                const row = resultTableBody.insertRow();
                row.insertCell().innerHTML = parameter;
                row.insertCell().innerHTML = value;
            }

            function updateUnitLabelsAndTooltips() {
                const selectedSystem = unitSystemSelect.value;
                const config = unitsConfig[selectedSystem];
                const wireGaugeMethod = document.querySelector('input[name="wire-gauge-method"]:checked').value;

                labelSupplyVoltage.innerHTML = `Power Supply Voltage (V<sub>supply</sub>) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The voltage provided by the power supply to the 4-20 mA loop. Unit: Volts.</span></span>`;
                labelTransmitterVoltageDrop.innerHTML = `Transmitter Minimum Voltage (V<sub>TX,min</sub>) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The minimum voltage required for the 4-20 mA transmitter to operate correctly. Unit: Volts.</span></span>`;
                labelLoadResistance.innerHTML = `Receiver/Load Resistance (R<sub>load</sub>) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The resistance of the receiver or load in the 4-20 mA loop (e.g., PLC analog input impedance). Unit: Ohms.</span></span>`;
                labelLoopLength.innerHTML = `Loop Length (L) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The one-way length of the cable. The calculator accounts for two-way resistance. Unit: ${config.length.tooltip}.</span></span>`;
                
                if (wireGaugeMethod === 'mm2') {
                    labelWireGaugeMM2.innerHTML = `Cross-sectional Area (A) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The cross-sectional area of the wire. Unit: ${config.area.tooltip}.</span></span>`;
                }

                if (selectedSystem === 'imperial') {
                    document.querySelector('input[name="wire-gauge-method"][value="awg"]').checked = true;
                    updateWireGaugeInputVisibility();
                } else {
                    document.querySelector('input[name="wire-gauge-method"][value="mm2"]').checked = true;
                    updateWireGaugeInputVisibility();
                }
            }

            function updateWireGaugeInputVisibility() {
                const selectedMethod = document.querySelector('input[name="wire-gauge-method"]:checked').value;
                if (selectedMethod === 'awg') {
                    wireGaugeAWGGroup.classList.add('active');
                    wireGaugeMM2Group.classList.remove('active');
                    wireGaugeAWGSelect.setAttribute('required', 'required');
                    wireGaugeMM2Input.removeAttribute('required');
                } else {
                    wireGaugeAWGGroup.classList.remove('active');
                    wireGaugeMM2Group.classList.add('active');
                    wireGaugeAWGSelect.removeAttribute('required');
                    wireGaugeMM2Input.setAttribute('required', 'required');
                }
                clearResults();
            }

            function clearResults() {
                resultContainer.classList.remove('show');
                resultTableBody.innerHTML = '';
                calculationDetailsDiv.innerHTML = ''; // NEW: Clear steps
                calculationDetailsDiv.classList.remove('active'); // NEW: Hide steps
                standardReference.innerHTML = '';
                voltageDropOverlay.style.width = '0%';
                supplyVoltageDisplay.textContent = '0.00 V';
                remainingVoltageDisplay.textContent = '0.00 V';
                loopStatusDisplay.textContent = 'Status: N/A';
                loopStatusDisplay.classList.remove('ok', 'error', 'warning');
                voltageDropPercentageStatus.style.display = 'none';
                voltageDropPercentageStatus.classList.remove('ok', 'error', 'warning');
                displayMessage("Results cleared.", "info");
            }

            function resetForm() {
                for (const id in defaultValues) {
                    const input = document.getElementById(id);
                    if (input) {
                        if (input.type === 'radio') {
                            document.querySelector(`input[name="${input.name}"][value="${defaultValues[id]}"]`).checked = true;
                        } else {
                            input.value = defaultValues[id];
                        }
                    }
                }
                updateUnitLabelsAndTooltips();
                updateWireGaugeInputVisibility();
                clearResults();
                displayMessage("Form reset to default values.", "info");
            }

            // NEW: Updated displayMessage function
            function displayMessage(message, type = "info") {
                let messageBox = document.getElementById('custom-message-box');
                
                messageBox.textContent = message;
                if (type === "error") {
                    messageBox.style.backgroundColor = 'var(--danger)';
                    messageBox.style.color = 'white';
                } else if (type === "warning") {
                    messageBox.style.backgroundColor = 'var(--warning)';
                    messageBox.style.color = '#333';
                } else {
                    messageBox.style.backgroundColor = 'var(--success)';
                    messageBox.style.color = 'white';
                }
                messageBox.classList.add('show');

                setTimeout(() => {
                    messageBox.classList.remove('show');
                }, 5000);
            }

            // --- MAJOR UPDATE: New Calculation Function ---
            function calculateLoopParameters() {
                clearResults(); // Clear previous results
                
                const selectedSystem = unitSystemSelect.value;
                const config = unitsConfig[selectedSystem];

                const supplyVoltage = parseFloat(supplyVoltageInput.value);
                const transmitterVoltageDrop = parseFloat(transmitterVoltageDropInput.value);
                const loadResistance = parseFloat(loadResistanceInput.value);
                const loopLength_input = parseFloat(loopLengthInput.value);
                const ambientTemperature = parseFloat(ambientTemperatureInput.value);
                const barrierResistance = parseFloat(barrierResistanceInput.value);
                const maxVoltageDropPercentage = parseFloat(maxVoltageDropPercentageInput.value);
                
                const wireGaugeMethod = document.querySelector('input[name="wire-gauge-method"]:checked').value;
                const wireMaterial = document.querySelector('input[name="wire-material"]:checked').value;

                // --- Input Validation ---
                if (isNaN(supplyVoltage) || supplyVoltage <= 0) { displayMessage("Please enter a valid positive Power Supply Voltage.", "error"); return; }
                if (isNaN(transmitterVoltageDrop) || transmitterVoltageDrop < 0) { displayMessage("Please enter a valid non-negative Transmitter Minimum Voltage.", "error"); return; }
                if (isNaN(loadResistance) || loadResistance < 0) { displayMessage("Please enter a valid non-negative Receiver/Load Resistance.", "error"); return; }
                if (isNaN(loopLength_input) || loopLength_input < 0) { displayMessage("Please enter a valid non-negative Loop Length.", "error"); return; }
                if (isNaN(ambientTemperature)) { displayMessage("Please enter a valid Ambient Temperature.", "error"); return; }
                if (isNaN(barrierResistance) || barrierResistance < 0) { displayMessage("Please enter a valid non-negative Intrinsic Safety Barrier Resistance.", "error"); return; }
                if (isNaN(maxVoltageDropPercentage) || maxVoltageDropPercentage < 0 || maxVoltageDropPercentage > 100) { displayMessage("Please enter a valid Max Allowed Voltage Drop percentage (0-100).", "error"); return; }
                
                const maxCurrentAmps = MAX_LOOP_CURRENT_MA / 1000;
                let stepHtml = ''; // Initialize string for all steps

                // --- FIX: Declare all result variables at the top ---
                let totalWireResistance = 0;
                let totalLoopVoltageRequired = 0;
                let voltageMargin = 0;
                let loopStatus = "N/A";
                let loopStatusClass = "";
                let actualVoltageDropPercentage = 0;
                let percentageStatus = "N/A";
                let percentageStatusClass = "";
                let voltageDropWire = 0;
                let voltageDropLoad = 0;
                let voltageDropBarrier = 0;

                
                // --- Step 1: Input Parameters ---
                stepHtml += `<div class="step-card">
                    <h4><span class="number">1</span>Input Parameters</h4>
                    <div class="step-content">
                        <div class="step-explanation">
                            <strong>Unit System:</strong> ${selectedSystem.toUpperCase()}<br>
                            <strong>Supply Voltage (V<sub>supply</sub>):</strong> ${supplyVoltage.toFixed(2)} V<br>
                            <strong>Transmitter Min. (V<sub>TX,min</sub>):</strong> ${transmitterVoltageDrop.toFixed(2)} V<br>
                            <strong>Load Resistance (R<sub>load</sub>):</strong> ${loadResistance.toFixed(2)} Ω<br>
                            <strong>Barrier Resistance (R<sub>barrier</sub>):</strong> ${barrierResistance.toFixed(2)} Ω
                        </div>
                        <div class="step-explanation">
                            <strong>Loop Length (one-way):</strong> ${loopLength_input.toFixed(config.length.precision)} ${config.length.label}<br>
                            <strong>Wire Material:</strong> ${wireMaterial.charAt(0).toUpperCase() + wireMaterial.slice(1)}<br>
                            <strong>Ambient Temp (T<sub>ambient</sub>):</strong> ${ambientTemperature.toFixed(0)} °C<br>
                            <strong>Max Wire Drop:</strong> ${maxVoltageDropPercentage.toFixed(1)} %
                        </div>
                    </div>
                </div>`;
                
                // --- Step 2: Determine Wire Resistance at 20°C ---
                let wireResistancePerMeter_at_20C;
                let temperatureCoefficient;
                let resistivity_si;

                stepHtml += `<div class="step-card math-content"><h4><span class="number">2</span>Calculate Base Wire Resistance (at 20°C)</h4>`;
                
                if (wireMaterial === 'copper') {
                    resistivity_si = RESISTIVITY_COPPER_SI;
                    temperatureCoefficient = TEMP_COEFF_COPPER;
                } else {
                    resistivity_si = RESISTIVITY_ALUMINUM_SI;
                    temperatureCoefficient = TEMP_COEFF_ALUMINUM;
                }
                
                if (wireGaugeMethod === 'awg') {
                    const awg = wireGaugeAWGSelect.value;
                    if (!WIRE_GAUGE_OHM_PER_M_COPPER[awg]) {
                        displayMessage("Selected AWG is not supported for calculation.", "error"); return;
                    }
                    wireResistancePerMeter_at_20C = WIRE_GAUGE_OHM_PER_M_COPPER[awg];
                    stepHtml += `<div class="step-explanation"><p>From lookup table for <strong>${awg} AWG Copper</strong>:</p>
                                 <p class="formula">$$R_{20°C, Cu} = ${wireResistancePerMeter_at_20C.toFixed(4)} \\text{ } \\Omega/\\text{m}$$</p>`;
                    if (wireMaterial === 'aluminum') {
                        const materialFactor = RESISTIVITY_ALUMINUM_SI / RESISTIVITY_COPPER_SI;
                        wireResistancePerMeter_at_20C *= materialFactor;
                        stepHtml += `<p>Adjusting for <strong>Aluminum</strong> (Resistivity Factor ${materialFactor.toFixed(2)}):</p>
                                     <p class="formula">$$R_{20°C, Al} = ${wireResistancePerMeter_at_20C.toFixed(4)} \\text{ } \\Omega/\\text{m}$$</p>`;
                    }
                    stepHtml += `</div>`;
                } else { // mm2
                    const area_mm2 = parseFloat(wireGaugeMM2Input.value);
                    if (isNaN(area_mm2) || area_mm2 <= 0) {
                        displayMessage("Please enter a valid positive Cross-sectional Area (mm²).", "error"); return;
                    }
                    const area_si = area_mm2 * unitsConfig.metric.area.toSI;
                    wireResistancePerMeter_at_20C = resistivity_si / area_si;
                    
                    stepHtml += `<div class="step-explanation"><p>Using the formula $R = \\rho / A$ for <strong>${wireMaterial}</strong>:</p>
                                 <div class="formula-block">
                                     <p class="formula">$$\\rho_{20°C} = ${resistivity_si.toExponential(2)} \\text{ } \\Omega \\cdot \\text{m}$$</p>
                                     <p class="formula">$$A = ${area_mm2.toFixed(3)} \\text{ mm}^2 = ${area_si.toExponential(2)} \\text{ m}^2$$</p>
                                     <p class="formula">$$R_{20°C} = \\frac{${resistivity_si.toExponential(2)}}{${area_si.toExponential(2)}} = ${wireResistancePerMeter_at_20C.toFixed(4)} \\text{ } \\Omega/\\text{m}$$</p>
                                 </div></div>`;
                }
                stepHtml += `</div>`;

                // --- Step 3: Correct Resistance for Temperature ---
                const tempDifference = ambientTemperature - REFERENCE_TEMPERATURE;
                const wireResistancePerMeter_at_ambient = wireResistancePerMeter_at_20C * (1 + temperatureCoefficient * tempDifference);
                
                stepHtml += `<div class="step-card math-content">
                    <h4><span class="number">3</span>Correct Wire Resistance for Ambient Temperature</h4>
                    <div class="step-explanation">
                        <p>Adjusting the base resistance from 20°C to the ambient temperature of ${ambientTemperature.toFixed(0)}°C.</p>
                        <div class="formula-block">
                            <p class="formula">$$R_{T} = R_{20°C} \\times [1 + \\alpha (T_{ambient} - T_{ref})]$$</p>
                            <p class="formula">$$R_{T} = ${wireResistancePerMeter_at_20C.toFixed(4)} \\times [1 + ${temperatureCoefficient.toFixed(5)} \\times (${ambientTemperature.toFixed(0)} - ${REFERENCE_TEMPERATURE})]$$</p>
                            <p class="formula">$$R_{T, ambient} = ${wireResistancePerMeter_at_ambient.toFixed(4)} \\text{ } \\Omega/\\text{m}$$</p>
                        </div>
                    </div>
                </div>`;
                
                // --- Step 4: Calculate Total Wire Resistance ---
                const loopLength_si = loopLength_input * config.length.toSI;
                totalWireResistance = wireResistancePerMeter_at_ambient * loopLength_si * 2; // 2-wire loop (FIX: Use 'let' variable)
                
                stepHtml += `<div class="step-card math-content">
                    <h4><span class="number">4</span>Calculate Total Wire Resistance (R<sub>wire</sub>)</h4>
                    <div class="step-explanation">
                        <p>Calculating the total resistance for the 2-wire loop (out and back) over the one-way distance.</p>
                        <div class="formula-block">
                             <p class="formula">$$L_{one-way} = ${loopLength_input.toFixed(config.length.precision)} ${config.length.label} = ${loopLength_si.toFixed(2)} \\text{ m}$$</p>
                             <p class="formula">$$R_{wire} = R_{T, ambient} \\times L_{one-way} \\times 2$$</p>
                             <p class="formula">$$R_{wire} = ${wireResistancePerMeter_at_ambient.toFixed(4)} \\times ${loopLength_si.toFixed(2)} \\times 2 = ${totalWireResistance.toFixed(2)} \\text{ } \\Omega$$</p>
                        </div>
                    </div>
                </div>`;
                
                // --- Step 5: Calculate All Voltage Drops at 20mA ---
                voltageDropWire = maxCurrentAmps * totalWireResistance; // FIX: Use 'let' variable
                voltageDropLoad = maxCurrentAmps * loadResistance; // FIX: Use 'let' variable
                voltageDropBarrier = maxCurrentAmps * barrierResistance; // FIX: Use 'let' variable
                
                stepHtml += `<div class="step-card math-content">
                    <h4><span class="number">5</span>Calculate Voltage Drops (at $I_{max}$ = 20 mA)</h4>
                    <p>Calculating the voltage drop across each passive component in the loop at the worst-case current (0.020 A).</p>
                    <div class="step-content">
                        <div class="step-explanation">
                            <p><strong>Wire Drop (V<sub>wire</sub>):</strong></p>
                            <div class="formula-block">
                                <p class="formula">$$V_{wire} = I_{max} \\times R_{wire}$$</p>
                                <p class="formula">$$V_{wire} = 0.020 \\text{ A} \\times ${totalWireResistance.toFixed(2)} \\text{ } \\Omega = ${voltageDropWire.toFixed(2)} \\text{ V}$$</p>
                            </div>
                        </div>
                        <div class="step-explanation">
                            <p><strong>Load Drop (V<sub>load</sub>):</strong></p>
                            <div class="formula-block">
                                <p class="formula">$$V_{load} = I_{max} \\times R_{load}$$</p>
                                <p class="formula">$$V_{load} = 0.020 \\text{ A} \\times ${loadResistance.toFixed(2)} \\text{ } \\Omega = ${voltageDropLoad.toFixed(2)} \\text{ V}$$</p>
                            </div>
                        </div>
                    </div>
                    <div class="step-content" style="margin-top: 15px;">
                        <div class="step-explanation">
                            <p><strong>Barrier Drop (V<sub>barrier</sub>):</strong></p>
                            <div class="formula-block">
                                <p class="formula">$$V_{barrier} = I_{max} \\times R_{barrier}$$</p>
                                <p class="formula">$$V_{barrier} = 0.020 \\text{ A} \\times ${barrierResistance.toFixed(2)} \\text{ } \\Omega = ${voltageDropBarrier.toFixed(2)} \\text{ V}$$</p>
                            </div>
                        </div>
                        <div class="step-explanation">
                             <p><strong>Transmitter Drop (V<sub>TX,min</sub>):</strong></p>
                             <div class="formula-block">
                                <p class="formula">(From Input)</p>
                                <p class="formula">$$V_{TX,min} = ${transmitterVoltageDrop.toFixed(2)} \\text{ V}$$</p>
                             </div>
                        </div>
                    </div>
                </div>`;
                
                // --- Step 6: Check Loop Compliance (Voltage Budget) ---
                totalLoopVoltageRequired = voltageDropWire + voltageDropLoad + voltageDropBarrier + transmitterVoltageDrop; // FIX: Use 'let' variable
                voltageMargin = supplyVoltage - totalLoopVoltageRequired; // FIX: Use 'let' variable
                
                if (voltageMargin >= 0) {
                    loopStatus = "OK";
                    loopStatusClass = "ok";
                } else {
                    loopStatus = "INSUFFICIENT VOLTAGE";
                    loopStatusClass = "error";
                    displayMessage("Error: Insufficient voltage for transmitter operation!", "error");
                }
                
                stepHtml += `<div class="step-card math-content">
                    <h4><span class="number">6</span>Check Loop Compliance (Voltage Budget)</h4>
                    <div class="step-explanation">
                        <p>This is the final check. We sum all voltage drops (including the transmitter's minimum) and check if the power supply is sufficient.</p>
                        <div class="formula-block">
                            <p class="formula">$$V_{required} = V_{wire} + V_{load} + V_{barrier} + V_{TX,min}$$</p>
                            <p class="formula">$$V_{required} = ${voltageDropWire.toFixed(2)} + ${voltageDropLoad.toFixed(2)} + ${voltageDropBarrier.toFixed(2)} + ${transmitterVoltageDrop.toFixed(2)} = ${totalLoopVoltageRequired.toFixed(2)} \\text{ V}$$</p>
                        </div>
                        <p>We then find the remaining voltage margin:</p>
                        <div class="formula-block">
                            <p class="formula">$$V_{margin} = V_{supply} - V_{required}$$</p>
                            <p class="formula">$$V_{margin} = ${supplyVoltage.toFixed(2)} \\text{ V} - ${totalLoopVoltageRequired.toFixed(2)} \\text{ V} = ${voltageMargin.toFixed(2)} \\text{ V}$$</p>
                        </div>
                        <p><strong>Since the margin is ${voltageMargin >= 0 ? "positive" : "negative"}, the loop status is:</strong></p>
                        <div class="step-value" style="color: var(--${loopStatusClass});">${loopStatus}</div>
                    </div>
                </div>`;

                // --- Step 7: Voltage Drop Percentage Check ---
                actualVoltageDropPercentage = (voltageDropWire / supplyVoltage) * 100; // FIX: Use 'let' variable
                
                if (actualVoltageDropPercentage <= maxVoltageDropPercentage) {
                    percentageStatus = `Within ${maxVoltageDropPercentage.toFixed(1)}% Limit`;
                    percentageStatusClass = "ok";
                } else {
                    percentageStatus = `Exceeds ${maxVoltageDropPercentage.toFixed(1)}% Limit`;
                    percentageStatusClass = "warning";
                    displayMessage(`Warning: Wire voltage drop (${actualVoltageDropPercentage.toFixed(2)}%) exceeds the set limit of ${maxVoltageDropPercentage.toFixed(1)}%.`, "warning");
                }
                
                stepHtml += `<div class="step-card math-content">
                    <h4><span class="number">7</span>Check Wire Voltage Drop % (Optional)</h4>
                    <div class="step-explanation">
                        <p>This checks if the voltage drop *from the wire alone* exceeds your specified limit.</p>
                        <div class="formula-block">
                            <p class="formula">$$V_{\\% drop, wire} = (V_{wire} / V_{supply}) \\times 100$$</p>
                            <p class="formula">$$V_{\\% drop, wire} = (${voltageDropWire.toFixed(2)} \\text{ V} / ${supplyVoltage.toFixed(2)} \\text{ V}) \\times 100 = ${actualVoltageDropPercentage.toFixed(2)} \\text{ %}$$</p>
                        </div>
                         <p><strong>The wire voltage drop of ${actualVoltageDropPercentage.toFixed(2)}% is ${percentageStatus.toLowerCase()}:</strong></p>
                        <div class="step-value" style="color: var(--${percentageStatusClass}); font-size: 1.5rem;">${percentageStatus}</div>
                    </div>
                </div>`;

                // --- Display Results ---
                calculationDetailsDiv.innerHTML = stepHtml; // Insert all steps
                calculationDetailsDiv.classList.add('active');
                
                resultTableBody.innerHTML = '';
                addResultRow("Power Supply Voltage", `${supplyVoltage.toFixed(2)} V`);
                addResultRow("Transmitter Minimum Voltage", `${transmitterVoltageDrop.toFixed(2)} V`);
                addResultRow("Receiver/Load Resistance", `${loadResistance.toFixed(2)} Ω`);
                addResultRow("Loop Length (one-way)", `${loopLength_input.toFixed(config.length.precision)} ${config.length.label}`);
                addResultRow("Wire Material", wireMaterial.charAt(0).toUpperCase() + wireMaterial.slice(1));
                addResultRow("Wire Gauge", wireGaugeMethod === 'awg' ? `${wireGaugeAWGSelect.value} AWG` : `${wireGaugeMM2Input.value} mm²`);
                addResultRow("Ambient Temperature", `${ambientTemperature.toFixed(0)} °C`);
                addResultRow("IS Barrier Resistance", `${barrierResistance.toFixed(2)} Ω`);
                addResultRow("Total Wire Resistance (2-way, at T<sub>ambient</sub>)", `${totalWireResistance.toFixed(2)} Ω`);
                addResultRow("Total Loop Voltage Required (at 20mA)", `${totalLoopVoltageRequired.toFixed(2)} V`);
                addResultRow("<strong>Voltage Margin</strong>", `<strong class="${loopStatusClass}">${voltageMargin.toFixed(2)} V</strong>`);
                addResultRow("<strong>Transmitter Operation Status</strong>", `<strong class="${loopStatusClass}">${loopStatus}</strong>`);
                addResultRow("Wire Voltage Drop %", `${actualVoltageDropPercentage.toFixed(2)} %`);
                addResultRow("<strong>Wire Voltage Drop % Status</strong>", `<strong class="${percentageStatusClass}">${percentageStatus}</strong>`);
                
                // --- Update Visualization ---
                supplyVoltageDisplay.textContent = `${supplyVoltage.toFixed(2)} V`;
                remainingVoltageDisplay.textContent = `${voltageMargin.toFixed(2)} V`;
                
                let dropPercentageViz = (totalLoopVoltageRequired / supplyVoltage) * 100;
                dropPercentageViz = Math.min(100, Math.max(0, dropPercentageViz));
                
                voltageDropOverlay.style.width = `${dropPercentageViz}%`;
                // Change bar color based on status
                if(loopStatusClass === 'ok') {
                    voltageDropOverlay.style.background = `linear-gradient(to left, var(--voltage-color), var(--voltage-color-dark))`;
                } else {
                    voltageDropOverlay.style.background = `linear-gradient(to left, var(--error-color), #a00)`;
                }
                
                loopStatusDisplay.textContent = `Status: ${loopStatus}`;
                loopStatusDisplay.classList.remove('ok', 'error', 'warning');
                loopStatusDisplay.classList.add(loopStatusClass);

                voltageDropPercentageStatus.textContent = `Wire Drop %: ${percentageStatus}`;
                voltageDropPercentageStatus.classList.remove('ok', 'error', 'warning');
                voltageDropPercentageStatus.classList.add(percentageStatusClass);
                voltageDropPercentageStatus.style.display = 'block';

                // --- Standard Reference ---
                standardReference.innerHTML = `
                    <h4>International Standards Compliance & Best Practices:</h4>
                    <p>Accurate loop impedance and voltage drop calculations are critical for reliable 4-20 mA current loop operation, aligning with various international standards and industry best practices:</p>
                    <ul>
                        <li><strong>IEC 60381-1: Analogue signals for process control systems.</strong> This standard specifies the 4-20 mA signal, implying sufficient loop voltage for operation.</li>
                        <li><strong>ISA-50.1-1982 (R1992): Compatibility of Analog Signals.</strong> Establishes principles for ensuring proper voltage/current levels in analog loops.</li>
                        <li><strong>NAMUR NE 43:</strong> Specifies requirements for 4-20 mA devices, including minimum operating voltages.</li>
                        <li><strong>IEC 60079 series (Intrinsic Safety):</strong> Sets strict limits on loop parameters (including resistance) for hazardous areas. The inclusion of barrier resistance is crucial for compliance.</li>
                        <li><strong>ANSI/NFPA 70 (NEC):</strong> Provides guidelines for wire sizing and voltage drop limits, which serve as a reference for instrumentation wiring.</li>
                    </ul>
                    <p>This tool provides calculations based on these widely accepted engineering principles. For critical applications, always refer to official standards documents, device manufacturer specifications, and consult with a qualified engineer.</p>
                `;
                
                // --- Show Results ---
                resultContainer.style.display = 'block';
                setTimeout(() => {
                    resultContainer.classList.add('show');
                    resultContainer.scrollIntoView({ behavior: 'smooth', block: 'start' }); // Scroll to results
                }, 10);
                
                // NEW: Typeset MathJax
                if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
                    setTimeout(() => {
                        window.MathJax.typesetPromise([calculationDetailsDiv]);
                    }, 50);
                }
            }

            // --- Theme switch logic (from provided file) ---
            const themeSwitch = document.getElementById('theme-switch');
            if (themeSwitch) {
                if (localStorage.getItem('theme') === 'dark') {
                    document.body.classList.add('dark-mode');
                    themeSwitch.checked = true;
                }

                themeSwitch.addEventListener('change', function() {
                    if (this.checked) {
                        document.body.classList.add('dark-mode');
                        localStorage.setItem('theme', 'dark');
                    } else {
                        document.body.classList.remove('dark-mode');
                        localStorage.setItem('theme', 'light');
                    }
                });
            }
        });
    </script>
</body>
</html>

