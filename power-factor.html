<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Industrial Power Factor Correction Calculator - Design Calculators - Electrical</title>
    <!-- SEO Meta Tags -->
    <meta name="description" content="Professional industrial power factor correction calculator. Calculates kVAR, APFC steps, and detuning reactors for heavy-duty loads with harmonics per IEEE 18 & IEC 61000.">
    <meta name="keywords" content="power factor correction, pfc calculator, apfc calculator, detuned reactor, harmonic filter, kvar, IEEE 18, IEC 61000, industrial electrical">
    <meta name="author" content="Design Calculators">
    <meta name="robots" content="index, follow">
    <!-- AdSense & Analytics -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5936527763614780" crossorigin="anonymous"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-23Y1V450SR"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-23Y1V450SR');
    </script>
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Montserrat:wght@700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- MathJax for Formulas -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['\\(', '\\)'], ['$', '$']],
                displayMath: [['\\[', '\\]'], ['$$', '$$']]
            },
            svg: { fontCache: 'global' }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <!-- PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root {
            --primary: #1E3A8A;
            --secondary: #2563EB;
            --accent: #F59E0B;
            --success: #10B981;
            --danger: #DC2626;
            --warning: #F59E0B;
            --bg: #F8FAFC;
            --card: #FFFFFF;
            --text: #4B5563;
            --heading: #111827;
            --footer-bg: #0F172A;
            --border: #E2E8F0;
            --grad: linear-gradient(135deg, var(--primary), var(--secondary));
            --grad-dark: linear-gradient(135deg, #0F172A, #1E293B);
            --shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        body.dark-mode {
            --primary: #10B981;
            --secondary: #34D399;
            --bg: #0F172A;
            --card: #1E293B;
            --text: #CBD5E1;
            --heading: #F1F5F9;
            --footer-bg: #020617;
            --border: #334155;
        }

        * { box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.7;
            margin: 0;
            padding: 0;
        }

        .container { max-width: 1280px; margin: 0 auto; padding: 0 24px; }

        /* Header & Nav */
        header {
            background: var(--grad);
            color: white;
            padding: 24px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo-container {
            display: flex;
            flex-direction: column;
            text-decoration: none;
            color: white;
        }
        .logo-text {
            font-size: 1.75rem;
            font-weight: 800;
            font-family: 'Montserrat', sans-serif;
        }
        .logo-subtitle {
            font-size: 0.8rem;
            margin: 4px 0 0 0;
            color: #E0E7FF;
            opacity: 0.9;
        }
        .nav-links {
            display: flex;
            gap: 24px;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        .nav-links a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }
        .nav-links a:hover { color: var(--accent); }
        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .switch {
            position: relative;
            width: 56px;
            height: 30px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.2);
            transition: .4s;
            border-radius: 30px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--accent);
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        /* Main Content & Cards */
        main { padding: 40px 0; }
        .card {
            background: var(--card);
            border-radius: 12px;
            padding: 30px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            border: 1px solid var(--border);
        }
        h2 {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
            padding-bottom: 15px;
            margin-top: 0;
            font-family: 'Montserrat', sans-serif;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        h3 {
            color: var(--heading);
            font-family: 'Montserrat', sans-serif;
            font-size: 1.5rem;
            margin-top: 25px;
            margin-bottom: 20px;
        }
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--heading);
        }
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 6px;
            background-color: var(--bg);
            color: var(--text);
            font-size: 1rem;
        }
        .form-group input:focus,
        .form-group select:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
        }
        body.dark-mode .form-group input:focus {
             box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }
        
        /* Input Modes */
        .input-mode-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background-color: var(--bg);
            border-radius: 8px;
            padding: 5px;
        }
        .input-mode-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            background: transparent;
            color: var(--text);
            font-weight: 600;
            transition: all 0.3s;
        }
        .input-mode-btn.active {
            background: var(--card);
            color: var(--primary);
            border-color: var(--primary);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .btn {
            background: var(--grad);
            color: white;
            border: none;
            padding: 16px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(30, 58, 138, 0.3);
            transition: all 0.3s;
            width: 100%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(30, 58, 138, 0.4);
        }
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .btn-group .btn {
            flex: 1;
            min-width: 150px;
        }
        .btn.secondary {
            background: var(--secondary);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }
        .btn.accent {
            background: var(--accent);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }

        /* CALCULATION STEPS DISPLAY - REVAMPED */
        .steps-container {
            display: none;
            margin-top: 30px;
        }
        .steps-container.active {
            display: block;
        }
        .step-card {
            background: var(--card);
            border-radius: 12px;
            padding: 25px 30px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            animation: slideIn 0.6s ease-out;
            transition: all 0.3s;
            margin-bottom: 25px; /* Spacing between cards */
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .step-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }
        .step-card h4 {
            color: var(--primary);
            margin: 0 0 20px 0;
            font-size: 1.4rem;
            font-family: 'Montserrat', sans-serif;
            display: flex;
            align-items: center;
        }
        .step-card .number {
            display: inline-block;
            width: 40px;
            height: 40px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 40px;
            font-weight: 700;
            margin-right: 15px;
            font-size: 1.3rem;
            flex-shrink: 0;
        }
        .step-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            align-items: center;
        }
        .step-content-full {
             grid-template-columns: 1fr;
        }
         @media (max-width: 768px) {
            .step-content {
                grid-template-columns: 1fr;
            }
        }
        .step-value {
            font-size: 2.2rem;
            font-weight: 800;
            color: var(--success);
            margin: 10px 0;
            line-height: 1.2;
        }
        .step-unit {
            font-size: 1rem;
            color: var(--text);
            opacity: 0.8;
            font-weight: 500;
            margin-left: 5px;
        }
        .formula {
            background: var(--bg);
            border-left: 3px solid var(--accent);
            padding: 15px;
            margin: 12px 0;
            font-size: 1rem;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
        }
        .step-explanation {
            font-size: 1.05rem;
            line-height: 1.8;
        }
        .step-explanation strong {
            color: var(--heading);
        }
        .analogy {
            background: var(--bg);
            border: 1px dashed var(--border);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-style: italic;
        }
        .analogy i {
            color: var(--primary);
            margin-right: 8px;
        }
        .step-recommendation {
            border-radius: 8px;
            padding: 20px;
        }
        .step-recommendation.warning {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(245, 158, 11, 0.05));
            border-left: 5px solid var(--warning);
        }
        .step-recommendation.warning h5 { color: var(--warning); }
        
        .step-recommendation.success {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
            border-left: 5px solid var(--success);
        }
         .step-recommendation.success h5 { color: var(--success); }
        
        .step-recommendation h5 {
            margin: 0 0 10px 0;
            font-size: 1.2rem;
            font-weight: 700;
        }
        .step-recommendation ul {
            padding-left: 20px;
            margin: 10px 0 0 0;
        }

        /* Results */
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-radius: 8px;
            overflow: hidden;
        }
        .results-table th,
        .results-table td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        .results-table th {
            background: var(--grad);
            color: white;
            font-weight: 700;
        }
        .results-table tr:nth-child(even) {
            background-color: var(--bg);
        }
        .results-table td:first-child {
            font-weight: 600;
            color: var(--heading);
        }
        .results-table .highlight {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--success);
        }
        .highlight-box {
            background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(16,185,129,0.05));
            border-left: 4px solid var(--success);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .highlight-box h4 {
            color: var(--success);
            margin-top: 0;
        }

        /* Educational Section */
        .education-section {
            margin-top: 60px;
        }
        .insight-card {
            background: linear-gradient(135deg, var(--card), rgba(37,99,235,0.03));
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            border-left: 5px solid var(--secondary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: all 0.3s;
        }
        .insight-card:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .insight-card h4 {
            color: var(--secondary);
            font-size: 1.3rem;
            margin: 0 0 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .insight-card h4 i {
            font-size: 1.5rem;
        }
        .insight-card p {
            margin: 10px 0;
            line-height: 1.8;
        }
        .stat-highlight {
            display: inline-block;
            background: var(--accent);
            color: #333;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 700;
            margin: 0 4px;
        }
        .danger-box {
            background: linear-gradient(135deg, rgba(220,38,38,0.1), rgba(220,38,38,0.05));
            border-left: 5px solid var(--danger);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }
        .danger-box h4 {
            color: var(--danger);
            margin-top: 0;
        }
        .success-box {
            background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(16,185,129,0.05));
            border-left: 5px solid var(--success);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }
        .success-box h4 {
            color: var(--success);
            margin-top: 0;
        }
        .three-col {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .metric-box {
            background: var(--card);
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        .metric-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
            margin: 10px 0;
        }
        .metric-label {
            font-size: 0.9rem;
            color: var(--text);
        }
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            border-radius: 8px;
            overflow: hidden;
        }
        .comparison-table th,
        .comparison-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }
        .comparison-table th {
            background: var(--grad);
            color: white;
            font-weight: 700;
        }
        .comparison-table tr:nth-child(even) {
            background: var(--bg);
        }

        /* Message Box */
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 16px 28px;
            border-radius: 8px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.25);
            z-index: 10000;
            font-weight: 600;
            color: white;
            opacity: 0;
            transition: all 0.4s;
            display: none;
        }
        .message-box.show {
            display: block;
            opacity: 1;
            top: 30px;
        }

        /* Footer */
        footer {
            background: var(--grad-dark);
            color: #CBD5E1;
            padding: 50px 0 20px 0;
            margin-top: 60px;
        }
        .footer-content {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 40px;
            margin-bottom: 30px;
        }
        .footer-col {
            flex: 1;
            min-width: 200px;
        }
        .footer-col h4 {
            color: white;
            margin-bottom: 15px;
            font-weight: 700;
        }
        .footer-col ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .footer-col a {
            color: #CBD5E1;
            text-decoration: none;
            transition: color 0.3s;
        }
        .footer-col a:hover {
            color: var(--accent);
        }
        .social-buttons {
            display: flex;
            gap: 12px;
            margin-top: 15px;
        }
        .social-btn {
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            border-radius: 50%;
            font-size: 1.1rem;
            transition: transform 0.3s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .social-btn:hover {
            transform: translateY(-4px);
        }
        .social-btn.linkedin { background-color: #0A66C2; }
        .social-btn.youtube { background-color: #FF0000; }
        .social-btn.twitter { background-color: #1DA1F2; }
        .social-btn.facebook { background-color: #1877F2; }
        .social-btn.whatsapp { background-color: #25D366; }
        .footer-disclaimer {
            text-align: center;
            padding-top: 25px;
            border-top: 1px solid #334155;
            max-width: 800px;
            margin: 0 auto;
            font-size: 0.9rem;
        }
        .footer-bottom {
            text-align: center;
            padding-top: 20px;
            font-size: 0.9rem;
            color: #94A3B8;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container { padding: 0 15px; }
            .navbar { flex-direction: column; gap: 20px; }
            .nav-links { flex-direction: column; gap: 12px; text-align: center; }
            .form-row { grid-template-columns: 1fr; }
            .card { padding: 20px; }
            .footer-content { flex-direction: column; gap: 25px; }
            .btn-group { flex-direction: column; }
            .input-mode-toggle { flex-direction: column; }
        }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div id="message-box" class="message-box"></div>

    <header>
        <div class="container">
            <nav class="navbar">
                <a href="#" class="logo-container">
                    <span class="logo-text">Design Calculators</span>
                    <p class="logo-subtitle">Inspired by standards such as IEC, IEEE, ISA, ASME, and API.</p>
                </a>
                <ul class="nav-links">
                    <li><a href="#">Home</a></li>
                    <li><a href="articles">Articles</a></li>
                    <li><a href="index_mech">Mechanical</a></li>
                    <li><a href="index_ele">Electrical</a></li>
                    <li><a href="index_inst">Instrumentation</a></li>
                </ul>
                <div class="theme-toggle">
                    <i class="fas fa-sun"></i>
                    <label class="switch">
                        <input type="checkbox" id="theme-switch">
                        <span class="slider"></span>
                    </label>
                    <i class="fas fa-moon"></i>
                </div>
            </nav>
        </div>
    </header>

    <main class="container">
        <div class="card">
            <h2><i class="fas fa-industry"></i> Professional PFC Calculator</h2>
            <p>Calculate the exact reactive power (kVAR) and specify the correct equipment (Fixed, APFC, or Detuned) for your industrial system. Aligned with IEEE 18, IEEE 1036, & IEC 61000 standards.</p>

            <form id="pfc-form">
                <h3>System & Load Parameters</h3>
                
                <!-- Input Mode Toggle -->
                <div class="input-mode-toggle">
                    <button type="button" class="input-mode-btn active" data-mode="bill"><i class="fas fa-file-invoice-dollar"></i> From Utility Bill</button>
                    <button type="button" class="input-mode-btn" data-mode="load"><i class="fas fa-cogs"></i> From Load Data</button>
                </div>
                
                <!-- Mode 1: Utility Bill -->
                <div id="mode-bill">
                     <div class="form-row">
                        <div class="form-group">
                            <label for="peak-kw">Peak Demand (kW)</label>
                            <input type="number" id="peak-kw" min="1" step="0.1" value="100">
                        </div>
                        <div class="form-group">
                            <label for="peak-kva">Peak Apparent Power (kVA)</label>
                            <input type="number" id="peak-kva" min="1" step="0.1" value="133">
                        </div>
                         <div class="form-group">
                            <label for="target-pf-bill">Target Power Factor (0.85-1.0)</label>
                            <input type="number" id="target-pf-bill" min="0.85" max="1" step="0.01" value="0.95" required>
                        </div>
                    </div>
                </div>

                <!-- Mode 2: Load Data -->
                <div id="mode-load" class="hidden">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="power">Total Real Power (kW)</label>
                            <input type="number" id="power" min="0.1" step="0.1" value="100">
                        </div>
                        <div class="form-group">
                            <label for="current-pf">Current Power Factor (0.5-1.0)</label>
                            <input type="number" id="current-pf" min="0.5" max="1" step="0.01" value="0.75">
                        </div>
                        <div class="form-group">
                            <label for="target-pf-load">Target Power Factor (0.85-1.0)</label>
                            <input type="number" id="target-pf-load" min="0.85" max="1" step="0.01" value="0.95" required>
                        </div>
                    </div>
                </div>
                
                <hr style="margin: 15px 0; border: none; border-top: 1px solid var(--border);">

                <h3>Professional System Specification</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="voltage">System Voltage (V L-L)</label>
                        <select id="voltage" required>
                            <option value="380">380V</option>
                            <option value="400" selected>400V</option>
                            <option value="415">415V</option>
                            <option value="480">480V</option>
                            <option value="600">600V</option>
                            <option value="690">690V</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>
                    <div class="form-group hidden" id="custom-volt-group">
                        <label for="custom-volt">Custom Voltage (V)</label>
                        <input type="number" id="custom-volt" min="1">
                    </div>
                     <div class="form-group">
                        <label for="frequency">Frequency (Hz)</label>
                        <select id="frequency" required>
                            <option value="50">50 Hz</option>
                            <option value="60" selected>60 Hz</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="connection">Capacitor Connection</label>
                        <select id="connection" required>
                            <option value="delta" selected>Delta (Standard)</option>
                            <option value="star">Star/Wye (Less Common)</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                     <div class="form-group">
                        <label for="load-profile">Load Profile</label>
                        <select id="load-profile" required>
                            <option value="variable" selected>Variable Load (Whole Facility, APFC)</option>
                            <option value="constant">Constant Load (Single Motor, Fixed)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="harmonic-level">Harmonic Level (VFDs, Rectifiers)</label>
                        <select id="harmonic-level" required>
                            <option value="low" selected>Low (THD_v < 3%) - Linear Loads</option>
                            <option value="medium">Medium (THD_v 3-5%) - Some VFDs</option>
                            <option value="high">High (THD_v > 5%) - Many VFDs</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="cap-volt">Capacitor Rated Voltage (V)</label>
                        <input type="number" id="cap-volt" min="100" step="10" value="440" required>
                    </div>
                </div>

                <div class="btn-group" style="margin-top: 25px;">
                    <button type="button" id="calc-btn" class="btn"><i class="fas fa-calculator"></i> Calculate PFC</button>
                    <button type="button" id="reset-btn" class="btn accent"><i class="fas fa-sync-alt"></i> Reset</button>
                    <button type="button" id="pdf-btn" class="btn secondary" style="display: none;"><i class="fas fa-file-pdf"></i> Download PDF</button>
                </div>
            </form>
        </div>

        <!-- LIVE CALCULATION STEPS -->
        <div id="steps-container" class="steps-container">
            
            <div class="step-card">
                <h4><span class="number">1</span> Current System Analysis</h4>
                <div class="step-content">
                    <div class="step-explanation">
                        <p>First, we analyze your <strong>current</strong> electrical state to understand the problem. Your system is drawing more power (kVA) from the grid than it's performing useful work (kW).</p>
                        <p>This "wasted" energy is called Reactive Power (kVAR), which is required by inductive loads like motors but inflates your utility bill.</p>
                        <div class="analogy">
                            <i class="fas fa-beer-mug-empty"></i><strong>The Beer Analogy:</strong> Your Apparent Power (kVA) is the whole glass, Real Power (kW) is the beer, and Reactive Power (kVAR) is the foam. You pay for the whole glass, but only the beer does the job!
                        </div>
                    </div>
                    <div id="step1-content">
                        <!-- Content dynamically inserted by JS -->
                    </div>
                </div>
            </div>

            <div class="step-card">
                <h4><span class="number">2</span> Target System Definition</h4>
                <div class="step-content">
                     <div class="step-explanation">
                        <p>Next, we define the <strong>target</strong> efficient state. By improving the Power Factor, your system can perform the <strong>same amount of useful work (kW)</strong> while drawing significantly less total power (kVA) from the grid.</p>
                        <p>Our goal isn't to eliminate *all* reactive power (which can be unstable), but to reduce it to an efficient, manageable level (your target PF).</p>
                    </div>
                    <div id="step2-content">
                        <!-- Content dynamically inserted by JS -->
                    </div>
                </div>
            </div>
            
            <div class="step-card">
                <h4><span class="number">3</span> Required Reactive Power (kVAR)</h4>
                <div class="step-content">
                    <div class="step-explanation">
                        <p>The solution is to "cancel out" the excess Reactive Power (kVAR) by injecting an equal amount of "leading" kVAR from a capacitor bank.</p>
                        <p>The calculation is simply the difference between your <strong>current kVAR</strong> and your <strong>target kVAR</strong>.</p>
                        <p><strong>Formula:</strong><br> $Q_C = P \times [\tan(\phi_1) - \tan(\phi_2)]$</p>
                    </div>
                    <div id="step3-content">
                        <!-- Content dynamically inserted by JS -->
                    </div>
                </div>
            </div>
            
            <div class="step-card">
                <h4><span class="number">4</span> Professional Equipment Specification</h4>
                 <div class="step-content step-content-full">
                    <div class="step-explanation">
                        <p>In an industrial plant, simply adding a capacitor is dangerous. We must select the safe, correct *type* of equipment based on your load and harmonic levels.</p>
                    </div>
                    <div id="step4-content" style="margin-top: 20px;">
                        <!-- Recommendations inserted by JS -->
                    </div>
                </div>
            </div>
            
             <div class="step-card">
                <h4><span class="number">5</span> Component Sizing & Detuning</h4>
                 <div class="step-content step-content-full">
                    <div class="step-explanation">
                        <p>Finally, we size the components. If detuning reactors are required (as recommended in Step 4), the capacitor's *nameplate* ratings must be higher to compensate for the reactor's effect and deliver the target kVAR at the system frequency.</p>
                    </div>
                    <div id="step5-content" style="margin-top: 20px;">
                        <!-- Sizing inserted by JS -->
                    </div>
                </div>
            </div>

            <div class="step-card">
                <h4><span class="number">6</span> System & Financial Payback</h4>
                 <div class="step-content">
                    <div class="step-explanation">
                        <p>Correcting your power factor provides a significant return on investment, not just by eliminating utility penalties, but by improving your entire electrical infrastructure's efficiency and capacity.</p>
                    </div>
                    <div id="step6-content">
                        <!-- Payback inserted by JS -->
                    </div>
                </div>
            </div>

        </div>

        <!-- RESULTS TABLE -->
        <div id="results-section" class="card hidden" style="margin-top: 40px;">
            <h3><i class="fas fa-clipboard-check"></i> Complete Calculation & Specification Report</h3>
            <table class="results-table">
                <thead>
                    <tr>
                        <th>Parameter</th>
                        <th>Specification / Value</th>
                    </tr>
                </thead>
                <tbody id="results-tbody"></tbody>
            </table>
        </div>

        <!-- EDUCATIONAL INSIGHTS SECTION -->
        <div class="education-section card">
            <h2><i class="fas fa-lightbulb"></i> Professional Insights: Beyond the Calculation</h2>

            <!-- New: Harmonics & APFC -->
            <div class="danger-box">
                <h4>⚠️ The #1 Risk: Harmonics & Resonance</h4>
                <p><strong>What are harmonics?</strong> Modern loads like Variable Frequency Drives (VFDs), rectifiers, and welders are "non-linear." They draw current in pulses, injecting "dirty" power (harmonics) back into your system.</p>
                <p><strong>The Catastrophic Risk:</strong> A standard capacitor bank can create a "parallel resonance" circuit with your main transformer. If this new resonant frequency matches a harmonic frequency (e.g., the 5th harmonic, 250Hz/300Hz), currents will amplify uncontrollably, leading to:
                    <ul>
                        <li>Violent capacitor failure (explosion)</li>
                        <li>Nuisance tripping of breakers</li>
                        <li>Overheating and failure of transformers and cables</li>
                    </ul>
                <strong>The Solution:</strong> This tool recommends **Detuned Capacitors** (capacitors with a series reactor). This reactor shifts the resonant frequency to a safe, low value (e.t., 189Hz) where no harmonics exist, protecting your equipment.</p>
            </div>

            <div class="insight-card">
                <h4><i class="fas fa-robot"></i> APFC vs. Fixed: Why Variable Loads Demand Automatic Control</h4>
                <p><strong>The "Over-Correction" Problem:</strong> A "Fixed" capacitor bank (like the old tool calculated) is "always on." This is fine if your load is constant (e.g., one giant 24/7 compressor). But in a real factory, loads cycle on and off.</p>
                <p>During low-load periods (night shifts, weekends), a large fixed capacitor bank will *over-compensate* the system. This creates a "leading" power factor (e.g., 0.98 leading), which is just as bad as a lagging one. It causes:</p>
                <ul>
                    <li><strong>Dangerous Voltage Rises (Overvoltage):</strong> Can damage sensitive electronics.</li>
                    <li><strong>Utility Penalties:</strong> Most utilities penalize for *both* leading and lagging PF.</li>
                </ul>
                <p><strong>The Solution:</strong> An **Automatic Power Factor Correction (APFC) Panel**. This is a "smart" system with a controller and multiple small capacitor steps (e.g., 10 + 20 + 20 + 50 kVAR). The controller constantly monitors the load and switches steps on or off every few seconds to *perfectly match* the required kVAR, keeping your PF stable at 0.95 without ever over-correcting.</p>
            </div>
            
            <!-- Existing content below -->

            <div class="insight-card">
                <h4><i class="fas fa-chart-line"></i> What Is Power Factor & Why It Matters</h4>
                <p><strong>Power factor (PF)</strong> is the ratio of real power (kW) that does useful work to apparent power (kVA) drawn from the utility. A perfect 1.0 PF means 100% of power is converted to productive work. In reality, most industrial systems operate between 0.65–0.85, wasting enormous energy and incurring substantial utility penalties. <span class="stat-highlight">41% of industrial facilities operate below 0.90 PF and pay surcharges of 5–10% of their electricity bill.</span></p>
                <p><strong>The Reality:</strong> A North American manufacturing plant with a 400 kW load at 0.81 PF faced <span class="stat-highlight">$648 annually</span> in reactive power penalties. By installing just 100 kVAR of capacitors (costing ~$1,250), they improved PF to 0.90, eliminated penalties, and freed up <span class="stat-highlight">130 kW of transformer capacity</span>—with a payback period under 2 years.</p>
            </div>

            <div class="three-col">
                <div class="metric-box">
                    <div class="metric-label">Annual Penalty (Typical)</div>
                    <div class="metric-value" style="color: var(--danger);">$15,000+</div>
                    <p style="margin: 10px 0 0 0; font-size: 0.85rem;">For 500 kW @ 0.75 PF</p>
                </div>
                <div class="metric-box">
                    <div class="metric-label">Payback on PFC System</div>
                    <div class="metric-value" style="color: var(--success);">6-18 months</div>
                    <p style="margin: 10px 0 0 0; font-size: 0.85rem;">Including penalties & losses</p>
                </div>
                <div class="metric-box">
                    <div class="metric-label">Transformer Cap Released</div>
                    <div class="metric-value" style="color: var(--primary);">~25%</div>
                    <p style="margin: 10px 0 0 0; font-size: 0.85rem;">Correcting 0.75 → 0.95 PF</p>
                </div>
            </div>

            <div class="insight-card">
                <h4><i class="fas fa-triangle-exclamation"></i> The Power Triangle: Your Roadmap to Efficiency</h4>
                <p>Think of the power triangle: <strong>Real Power (kW)</strong> on the x-axis, <strong>Reactive Power (kVAR)</strong> on the y-axis, and <strong>Apparent Power (kVA)</strong> as the hypotenuse. By injecting capacitive reactive power, you cancel inductive reactive power and shrink the angle (θ), reducing apparent power.</p>
                <div class="formula">Mathematical elegance: $S = \sqrt{P^2 + Q^2}$   and   $PF = \cos(\theta) = P/S$</div>
                <p><strong>Practical Impact:</strong> A 500 kW facility at 0.75 PF draws 667 kVA. Correcting to 0.95 PF reduces draw to 526 kVA—freeing <span class="stat-highlight">141 kVA</span> of transformer capacity. That's room for growth without buying a new transformer.</p>
            </div>

            <div class="success-box">
                <h4>✓ Why 0.95 Is the Magic Target (Not 1.0)</h4>
                <p><strong>Tempting but wrong:</strong> A 1.0 PF seems optimal, but industry targets 0.95 for critical reasons:</p>
                <ul>
                    <li><strong>Over-correction danger:</strong> Pushing to leading power factor (>1.0) causes voltage rise and equipment damage</li>
                    <li><strong>System stability:</strong> Some residual reactive power stabilizes the grid during disturbances</li>
                    <li><strong>Transformer losses:</strong> Losses increase with leading PF, negating savings</li>
                    <li><strong>Regulatory cap:</strong> Most utilities cap leading PF at 0.95 to prevent grid damage</li>
                    <li><strong>Standards alignment:</strong> IEC 61000-2-2 industrial networks target 0.94–0.97 PF for compliance</li>
                </ul>
            </div>
            
            <div class="insight-card">
                <h4><i class="fas cogs"></i> Standards & Regulations: The Guardrails</h4>
                <p><strong>IEEE 18:</strong> Shunt capacitor installation guidelines define safe sizing, detuning, and protection.</p>
                <p><strong>IEEE 1036:</strong> Application guide for capacitor banks in power systems up to 765 kV.</p>
                <p><strong>IEC 61000-2-2/2-4:</strong> Power quality compatibility levels; industrial networks tolerate up to 8% total harmonic distortion (THD). Capacitor banks must not push you beyond this.</p>
                <p><strong>NEC Article 460:</strong> Capacitor safety mandate—disconnect switches, overcurrent protection, grounding, and discharge resistors. Violation can void insurance.</p>
            </div>
           
        </div>
    </main>

    <!-- FOOTER -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-col">
                    <h4>Design Calculators</h4>
                    <p style="font-size: 0.9rem; line-height: 1.6; margin-bottom: 15px;">If you find this tool helpful, please consider sharing it with your colleagues!</p>
                    <div class="social-buttons">
                        <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn linkedin" title="LinkedIn"><i class="fab fa-linkedin-in"></i></a>
                        <a href="https://www.youtube.com/@designcalculators" target="_blank" rel="noopener noreferrer" class="social-btn youtube" title="YouTube"><i class="fab fa-youtube"></i></a>
                        <a href="https://twitter.com/intent/tweet?url=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn twitter" title="Twitter"><i class="fab fa-twitter"></i></a>
                        <a href="https://www.facebook.com/sharer/sharer.php?u=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn facebook" title="Facebook"><i class="fab fa-facebook-f"></i></a>
                        <a href="https://api.whatsapp.com/send?text=Check%20out%20this%20amazing%20engineering%20resource%20https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn whatsapp" title="WhatsApp"><i class="fab fa-whatsapp"></i></a>
                    </div>
                </div>
                <div class="footer-col">
                    <h4>Quick Links</h4>
                    <ul>
                        <li><a href="#">Home</a></li>
                        <li><a href="index_ele">Electrical</a></li>
                        <li><a href="index_mech">Mechanical</a></li>
                        <li><a href="index_inst">Instrumentation</a></li>
                        <li><a href="articles">Articles</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>Resources</h4>
                    <ul>
                        <li><a href="about">About Us</a></li>
                        <li><a href="contact">Contact</a></li>
                        <li><a href="faq">FAQ</a></li>
                        <li><a href="privacy-policy">Privacy Policy</a></li>
                        <li><a href="terms-of-service">Terms of Service</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>More</h4>
                    <ul>
                        <li><a href="articles.html">Articles & Whitepapers</a></li>
                        <li><a href="sitemap">Sitemap</a></li>
                        <li><a href="https://www.youtube.com/@designcalculators" target="_blank" rel="noopener noreferrer">YouTube Channel</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-disclaimer">
                <p>All calculations are for preliminary engineering design guidance. Final capacitor bank installation must comply with IEEE 18, IEEE 1036, IEC 61000-2-2/2-4, IEC 60076, and local electrical codes (NEC Article 460, CEI, AS/NZS). Always perform a detailed harmonic analysis before installing capacitor banks in systems with VFDs or rectifiers to avoid resonance. Consult with a licensed professional engineer before implementation.</p>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Design Calculators. Created by <span style="color: var(--secondary); font-weight: bold;">A Sharma</span>. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Form Elements
            const form = document.getElementById('pfc-form');
            const calcBtn = document.getElementById('calc-btn');
            const resetBtn = document.getElementById('reset-btn');
            const pdfBtn = document.getElementById('pdf-btn');
            const voltageSelect = document.getElementById('voltage');
            const customVoltGroup = document.getElementById('custom-volt-group');
            
            // Input Mode
            const modeButtons = document.querySelectorAll('.input-mode-btn');
            const modeBill = document.getElementById('mode-bill');
            const modeLoad = document.getElementById('mode-load');
            let currentMode = 'bill';
            
            // Outputs
            const stepsContainer = document.getElementById('steps-container');
            const resultsSection = document.getElementById('results-section');
            const resultsTbody = document.getElementById('results-tbody');
            const messageBox = document.getElementById('message-box');
            
            // Theme
            const themeSwitch = document.getElementById('theme-switch');

            // --- Event Listeners ---
            
            // Input Mode Toggle
            modeButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    currentMode = btn.dataset.mode;
                    modeButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    if (currentMode === 'bill') {
                        modeBill.classList.remove('hidden');
                        modeLoad.classList.add('hidden');
                    } else {
                        modeBill.classList.add('hidden');
                        modeLoad.classList.remove('hidden');
                    }
                });
            });

            // Custom Voltage
            voltageSelect.addEventListener('change', function() {
                customVoltGroup.classList.toggle('hidden', this.value !== 'custom');
            });

            // Dark Mode
            themeSwitch.addEventListener('change', function() {
                if (this.checked) {
                    document.body.classList.add('dark-mode');
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.body.classList.remove('dark-mode');
                    localStorage.setItem('theme', 'light');
                }
            });

            // Load Dark Mode Preference
            if (localStorage.getItem('theme') === 'dark') {
                document.body.classList.add('dark-mode');
                themeSwitch.checked = true;
            }

            // Calculate Button
            calcBtn.addEventListener('click', performCalculation);

            // Reset Button
            resetBtn.addEventListener('click', function() {
                form.reset();
                stepsContainer.classList.remove('active');
                resultsSection.classList.add('hidden');
                pdfBtn.style.display = 'none';
                customVoltGroup.classList.add('hidden');
                voltageSelect.value = '400';
                // Reset mode to default
                modeButtons[0].click();
                showMessage('Form reset');
            });

            // PDF Button
            pdfBtn.addEventListener('click', generatePDF);

            // --- Utility Functions ---

            function showMessage(msg, type = 'success') {
                messageBox.textContent = msg;
                if (type === 'error') {
                    messageBox.style.backgroundColor = 'var(--danger)';
                } else if (type === 'warning') {
                     messageBox.style.backgroundColor = 'var(--warning)';
                } else {
                    messageBox.style.backgroundColor = 'var(--success)';
                }
                messageBox.classList.add('show');
                setTimeout(() => messageBox.classList.remove('show'), 4000);
            }
            
            function format(num, decimals = 2) {
                return num.toFixed(decimals).replace(/\.00$/, '');
            }

            // --- Main Calculation Logic ---

            function performCalculation() {
                try {
                    // 1. Get All Inputs
                    let P, currentPF, targetPF, currentKVA;
                    
                    if (currentMode === 'bill') {
                        P = parseFloat(document.getElementById('peak-kw').value);
                        currentKVA = parseFloat(document.getElementById('peak-kva').value);
                        targetPF = parseFloat(document.getElementById('target-pf-bill').value);
                        if (!P || !currentKVA || !targetPF) throw new Error('Please fill all fields in Utility Bill mode');
                        if (currentKVA < P) throw new Error('kVA cannot be less than kW');
                        currentPF = P / currentKVA;
                    } else {
                        P = parseFloat(document.getElementById('power').value);
                        currentPF = parseFloat(document.getElementById('current-pf').value);
                        targetPF = parseFloat(document.getElementById('target-pf-load').value);
                        if (!P || !currentPF || !targetPF) throw new Error('Please fill all fields in Load Data mode');
                        currentKVA = P / currentPF;
                    }

                    if (currentPF >= targetPF) {
                        showMessage('Target PF must be higher than current PF.', 'warning');
                        return;
                    }

                    let voltage = voltageSelect.value === 'custom' ? parseFloat(document.getElementById('custom-volt').value) : parseFloat(voltageSelect.value);
                    const frequency = parseFloat(document.getElementById('frequency').value);
                    const connection = document.getElementById('connection').value;
                    const loadProfile = document.getElementById('load-profile').value;
                    const harmonicLevel = document.getElementById('harmonic-level').value;
                    const capVolt = parseFloat(document.getElementById('cap-volt').value);

                    if (!voltage || !capVolt) throw new Error('Please specify all voltage ratings');
                    if (capVolt < voltage) {
                        showMessage('Capacitor voltage rating must be equal to or higher than system voltage.', 'error');
                        return;
                    }
                    
                    // 2. Core Calculations
                    const angle1 = Math.acos(currentPF);
                    const angle2 = Math.acos(targetPF);
                    
                    const currentQvar = P * Math.tan(angle1);
                    const targetKVA = P / targetPF;
                    const targetQvar = P * Math.tan(angle2);
                    const requiredQvar = currentQvar - targetQvar;
                    
                    // 3. Equipment Specification
                    let solutionType = "";
                    let solutionDetails = "";
                    let detuningFactor = 0;
                    
                    if (loadProfile === 'constant' && harmonicLevel === 'low') {
                        solutionType = "Fixed Capacitor Bank";
                        solutionDetails = "Standard capacitors are suitable for this constant, linear load.";
                    } else if (loadProfile === 'variable' && harmonicLevel === 'low') {
                        solutionType = "Automatic Power Factor Correction (APFC) Panel";
                        solutionDetails = "Standard capacitors with an automatic controller to match variable load.";
                    } else {
                        detuningFactor = 0.07; // Standard 7% detuning for 5th harmonic
                        if(harmonicLevel === 'high') detuningFactor = 0.07; // Could also be 14% for 3rd, but 7% is most common.
                        
                        if (loadProfile === 'constant') {
                            solutionType = `Fixed Detuned Capacitor Bank (p=${detuningFactor*100}%)`;
                            solutionDetails = `Detuned reactors are <strong>essential</strong> to prevent harmonic resonance.`;
                        } else {
                            solutionType = `Detuned Automatic (APFC) Panel (p=${detuningFactor*100}%)`;
                            solutionDetails = `<strong>Professional solution:</strong> An APFC panel with detuning reactors is required to handle both variable load and harmonics safely.`;
                        }
                    }
                    
                    // 4. Component Sizing
                    const omega = 2 * Math.PI * frequency;
                    const standardQvarSizes = [5, 10, 12.5, 15, 20, 25, 30, 40, 50, 60, 75, 100, 125, 150, 200, 250, 300, 400, 500];
                    const recommendedQvar = standardQvarSizes.find(s => s >= requiredQvar) || requiredQvar;
                    
                    let apfcSteps = "N/A (Fixed Bank)";
                    if (loadProfile === 'variable') {
                        apfcSteps = getApfcSteps(recommendedQvar);
                    }
                    
                    // Recalculate component ratings if detuned
                    let ratedCapVolt = capVolt;
                    let ratedCapQvar = recommendedQvar;
                    let reactorInductance = 0;
                    
                    if (detuningFactor > 0) {
                        let requiredCapVoltRating = voltage / (1 - detuningFactor);
                        if (capVolt < requiredCapVoltRating) {
                            throw new Error(`For ${detuningFactor*100}% detuning, capacitor voltage must be > ${format(requiredCapVoltRating, 0)}V. Please update "Capacitor Rated Voltage"`);
                        }
                        // Nameplate kVAR of the capacitor must be higher
                        ratedCapQvar = recommendedQvar / (1 - detuningFactor); 
                        // Inductance of the series reactor
                        // L = (V_L_L^2 * p) / (Qc_rated * omega) -> This is complex
                        // Simpler: X_L = p * X_C. X_C = V_phase^2 / Q_phase
                        // V_phase_cap = V_cap_rated / sqrt(3) or V_cap_rated
                        let Vc_phase, Qc_phase;
                        if(connection === 'delta') {
                            Vc_phase = ratedCapVolt;
                            Qc_phase = ratedCapQvar / 3;
                        } else { // Star
                            Vc_phase = ratedCapVolt / Math.sqrt(3);
                            Qc_phase = ratedCapQvar / 3;
                        }
                        const Xc = (Vc_phase * Vc_phase) / (Qc_phase * 1000);
                        const Xl = detuningFactor * Xc;
                        reactorInductance = (Xl / omega) * 1000; // in mH
                    }
                    
                    // Capacitance Calculation (based on *nameplate* kVAR and *nameplate* voltage)
                    let capPerPhase, totalCap;
                    if (connection === 'delta') {
                        capPerPhase = (ratedCapQvar * 1000000) / (3 * omega * ratedCapVolt * ratedCapVolt);
                        totalCap = capPerPhase * 3;
                    } else { // Star
                        const phaseVolt = ratedCapVolt / Math.sqrt(3);
                        capPerPhase = (ratedCapQvar * 1000000) / (3 * omega * phaseVolt * phaseVolt);
                        totalCap = capPerPhase * 3;
                    }

                    // 5. Payback
                    const kvaReduction = currentKVA - targetKVA;
                    const lossReduction = (1 - Math.pow(currentPF / targetPF, 2)) * 100;
                    
                    // 6. Update UI - Step 1
                    document.getElementById('step1-content').innerHTML = `
                        <p><strong>Real Power (P):</strong> <span class="step-value" style="color:var(--heading);">${format(P, 2)}<span class="step-unit">kW</span></span></p>
                        <p><strong>Apparent Power (S₁):</strong> <span class="step-value" style="color:var(--heading);">${format(currentKVA, 2)}<span class="step-unit">kVA</span></span></p>
                        <p><strong>Current Power Factor (PF₁):</strong> <span class="step-value" style="color:var(--danger);">${format(currentPF, 3)}</span></p>
                        <p><strong>Wasted Power (Q₁):</strong> <span class="step-value" style="color:var(--danger);">${format(currentQvar, 2)}<span class="step-unit">kVAR</span></span></p>
                    `;
                    
                    // Step 2
                    document.getElementById('step2-content').innerHTML = `
                        <p><strong>Real Power (P):</strong> <span class="step-value" style="color:var(--heading);">${format(P, 2)}<span class="step-unit">kW</span></span></p>
                        <p><strong>Target Apparent Power (S₂):</strong> <span class="step-value" style="color:var(--success);">${format(targetKVA, 2)}<span class="step-unit">kVA</span></span></p>
                        <p><strong>Target Power Factor (PF₂):</strong> <span class="step-value" style="color:var(--success);">${format(targetPF, 3)}</span></p>
                        <p><strong>Target Wasted Power (Q₂):</strong> <span class="step-value" style="color:var(--success);">${format(targetQvar, 2)}<span class="step-unit">kVAR</span></span></p>
                    `;
                    
                    // Step 3
                    document.getElementById('step3-content').innerHTML = `
                        <div class="step-value">${format(requiredQvar, 2)}<span class="step-unit">kVAR</span></div>
                        <p><strong>Recommended Standard Size:</strong></p>
                        <div class="step-value" style="color:var(--primary);">${format(recommendedQvar, 2)}<span class="step-unit">kVAR</span></div>
                        <div class="formula">Qc = ${format(P,2)} × [tan(${format(angle1 * 180 / Math.PI, 1)}°) - tan(${format(angle2 * 180 / Math.PI, 1)}°)]</div>
                    `;
                    
                    // Step 4
                    let harmWarning = harmonicLevel === 'low' ? 'success' : 'warning';
                    let loadWarning = loadProfile === 'constant' ? 'success' : 'warning';
                    
                    document.getElementById('step4-content').innerHTML = `
                        <div class="step-recommendation ${loadWarning}">
                            <h5><i class="fas fa-arrows-alt-v"></i> Load Profile Analysis</h5>
                            <p>You selected: <strong>${loadProfile.charAt(0).toUpperCase() + loadProfile.slice(1)} Load</strong></p>
                            <p>${loadProfile === 'variable' ? 'An <strong>Automatic (APFC)</strong> panel is required to prevent over-correction.' : 'A <strong>Fixed</strong> bank is suitable.'}</p>
                        </div>
                        <div class="step-recommendation ${harmWarning}" style="margin-top:15px;">
                            <h5><i class="fas fa-wave-square"></i> Harmonic Analysis</h5>
                            <p>You selected: <strong>${harmonicLevel.charAt(0).toUpperCase() + harmonicLevel.slice(1)} Harmonics</strong></p>
                            <p>${detuningFactor > 0 ? `<strong>Detuned Reactors (p=${detuningFactor*100}%)</strong> are required to prevent resonance.` : 'Standard capacitors are acceptable.'}</p>
                        </div>
                        <div class="highlight-box" style="margin-top: 20px;">
                            <h4><i class="fas fa-check-circle"></i> Recommended Solution</h4>
                            <div class="step-value" style="font-size: 1.5rem; color: var(--primary);">${solutionType}</div>
                            <p>${solutionDetails}</p>
                        </div>
                    `;

                    // Step 5
                    document.getElementById('step5-content').innerHTML = `
                        <p><strong>Final Panel/Bank Size:</strong> <span class="step-value" style="color:var(--primary);">${format(recommendedQvar, 2)}<span class="step-unit">kVAR</span></span></p>
                        <p><strong>APFC Steps:</strong> <span class="step-value" style="color:var(--heading); font-size: 1.2rem;">${apfcSteps}</span></p>
                        ${detuningFactor > 0 ? `
                            <p><strong>Detuned Capacitor Rating:</strong> <span class="step-value" style="color:var(--heading); font-size: 1.2rem;">${format(ratedCapQvar, 2)} kVAR @ ${format(ratedCapVolt, 0)}V</span></p>
                            <p><strong>Required Reactor (per phase):</strong> <span class="step-value" style="color:var(--heading); font-size: 1.2rem;">${format(reactorInductance, 2)} mH</span></p>
                        ` : `
                            <p><strong>Capacitor Rating:</strong> <span class="step-value" style="color:var(--heading); font-size: 1.2rem;">${format(recommendedQvar, 2)} kVAR @ ${format(ratedCapVolt, 0)}V</span></p>
                        `}
                        <p><strong>Total Capacitance:</strong> <span class="step-value" style="color:var(--heading); font-size: 1.2rem;">${format(totalCap, 0)} µF (${format(capPerPhase, 0)} µF per phase)</span></p>
                    `;

                    // Step 6
                    document.getElementById('step6-content').innerHTML = `
                        <p><strong>kVA Reduction:</strong> <span class="step-value">${format(kvaReduction, 2)}<span class="step-unit">kVA</span></span></p>
                        <p><strong>Transformer Capacity Freed:</strong> <span class="step-value">${format(kvaReduction, 2)}<span class="step-unit">kVA</span></span></p>
                        <p><strong>Cable I²R Loss Reduction:</strong> <span class="step-value">${format(lossReduction, 1)}<span class="step-unit">%</span></span></p>
                        <p style="font-size: 0.9rem; margin-top: 10px;">This also eliminates PF penalties and reduces heat in cables & transformers, extending equipment life.</p>
                    `;
                    
                    // 7. Update Results Table
                    resultsTbody.innerHTML = `
                        <tr><td>Required Reactive Power (Qc)</td><td class="highlight">${format(requiredQvar, 2)} kVAR</td></tr>
                        <tr><td>Recommended Solution Type</td><td><strong>${solutionType}</strong></td></tr>
                        <tr><td>Recommended Panel/Bank Size</td><td class="highlight">${format(recommendedQvar, 2)} kVAR</td></tr>
                        <tr><td>APFC Steps (if applicable)</td><td>${apfcSteps}</td></tr>
                        <tr><td>Capacitor Voltage Rating</td><td>${format(ratedCapVolt, 0)} V</td></tr>
                        ${detuningFactor > 0 ? `
                        <tr><td>Detuned Capacitor Nameplate</td><td>${format(ratedCapQvar, 2)} kVAR</td></tr>
                        <tr><td>Detuning Reactor (p=${detuningFactor*100}%)</td><td>${format(reactorInductance, 2)} mH per phase</td></tr>
                        ` : ''}
                        <tr><td>Total Capacitance</td><td>${format(totalCap, 0)} µF (${connection.toUpperCase()})</td></tr>
                        <tr><td>Capacitance per Phase</td><td>${format(capPerPhase, 0)} µF</td></tr>
                        <tr><td>System kVA Reduction</td><td>${format(kvaReduction, 2)} kVA</td></tr>
                        <tr><td>Cable I²R Loss Reduction</td><td>~${format(lossReduction, 1)} %</td></tr>
                        <tr><td>Current PF / kVA</td><td>${format(currentPF, 3)} PF / ${format(currentKVA, 2)} kVA</td></tr>
                        <tr><td>Corrected PF / kVA</td><td>${format(targetPF, 3)} PF / ${format(targetKVA, 2)} kVA</td></tr>
                    `;

                    // 8. Show sections
                    stepsContainer.classList.add('active');
                    resultsSection.classList.remove('hidden');
                    pdfBtn.style.display = 'inline-flex';

                    // 9. Scroll and notify
                    setTimeout(() => stepsContainer.scrollIntoView({ behavior: 'smooth' }), 100);
                    showMessage('Calculation complete! Professional specification below.');
                    
                    // 10. Re-render MathJax
                    if (window.MathJax && window.MathJax.typeset) {
                        window.MathJax.typeset();
                    }

                } catch (e) {
                    showMessage(e.message || 'Calculation error', 'error');
                    // Hide results on error
                    stepsContainer.classList.remove('active');
                    resultsSection.classList.add('hidden');
                    pdfBtn.style.display = 'none';
                }
            }
            
            function getApfcSteps(totalQvar) {
                // Simple C-series logic (1:2:4:8...)
                // A common industrial setup is 1:2:2 or 1:2:4
                if (totalQvar <= 10) return `${totalQvar} kVAR`;
                if (totalQvar <= 25) return `5 + 10 + 10 kVAR (25 kVAR Panel)`;
                if (totalQvar <= 50) return `10 + 20 + 20 kVAR (50 kVAR Panel)`;
                if (totalQvar <= 75) return `12.5 + 25 + 25 kVAR (62.5 kVAR Panel)`;
                if (totalQvar <= 100) return `25 + 25 + 50 kVAR (100 kVAR Panel)`;
                if (totalQvar <= 150) return `25 + 50 + 75 kVAR (150 kVAR Panel)`;
                if (totalQvar <= 200) return `50 + 50 + 100 kVAR (200 kVAR Panel)`;
                if (totalQvar <= 300) return `50 + 100 + 150 kVAR (300 kVAR Panel)`;
                return `e.g., 100 + 100 + 100... (${totalQvar} kVAR Panel)`;
            }

            function generatePDF() {
                try {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    let y = 15;

                    pdf.setFont('helvetica', 'bold');
                    pdf.setFontSize(16);
                    pdf.text('Power Factor Correction Specification Report', 105, y, { align: 'center' });
                    y += 8;

                    pdf.setFont('helvetica', 'normal');
                    pdf.setFontSize(9);
                    pdf.text(`Generated by Design Calculators | ${new Date().toLocaleString()}`, 105, y, { align: 'center' });
                    y += 10;
                    
                    pdf.setFont('helvetica', 'bold');
                    pdf.setFontSize(12);
                    pdf.text('Calculation & Specification', 14, y);
                    y += 2;

                    const rows = Array.from(resultsTbody.querySelectorAll('tr')).map(tr => [
                        tr.cells[0].textContent,
                        tr.cells[1].textContent
                    ]);

                    pdf.autoTable({
                        startY: y,
                        head: [['Parameter', 'Specification / Value']],
                        body: rows,
                        margin: { left: 14, right: 14 },
                        theme: 'grid',
                        headStyles: { 
                            fillColor: [30, 58, 138], 
                            textColor: [255, 255, 255], 
                            fontSize: 10, 
                            fontStyle: 'bold' 
                        },
                        bodyStyles: { 
                            fontSize: 9,
                            cellPadding: 2.5,
                        },
                        alternateRowStyles: {
                            fillColor: [248, 250, 252]
                        },
                        didParseCell: function (data) {
                            if (data.row.index === 0 || data.row.index === 2) { // Highlight rows
                                data.cell.styles.fontStyle = 'bold';
                                data.cell.styles.textColor = [16, 185, 129];
                            }
                             if (data.row.index === 1) { // Highlight solution
                                data.cell.styles.fontStyle = 'bold';
                            }
                        }
                    });
                    
                    y = pdf.autoTable.previous.finalY + 15;

                    pdf.setFont('helvetica', 'bold');
                    pdf.setFontSize(10);
                    pdf.text('Disclaimer:', 14, y);
                    y += 5;
                    
                    pdf.setFont('helvetica', 'normal');
                    pdf.setFontSize(8);
                    const disclaimer = document.querySelector('.footer-disclaimer p').textContent;
                    const splitDisclaimer = pdf.splitTextToSize(disclaimer, 182); // 210mm - 14 - 14
                    pdf.text(splitDisclaimer, 14, y);
                    
                    pdf.save('PFC-Specification-Report.pdf');
                    showMessage('PDF downloaded successfully');
                } catch(e) {
                    showMessage('Error generating PDF: ' + e.message, 'error');
                }
            }
            
            // Re-render MathJax on load if needed
            if (window.MathJax && window.MathJax.typeset) {
                window.MathJax.typeset();
            }
        });
    </script>
</body>
</html>
