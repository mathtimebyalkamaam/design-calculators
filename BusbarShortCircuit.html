<!DOCTYPE html>
<html lang="en">
<head>
    <!-- AdSense & Analytics -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5936527763614780" crossorigin="anonymous"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-23Y1V450SR"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-23Y1V450SR');
    </script>
    
    <!-- SEO Meta Tags -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IEC 60865 Busbar Force & Dynamic Stability Calculator - Industrial Grade</title>
    <meta name="description" content="Professional IEC 60865-1 Busbar Calculator. Calculate Short Circuit Peak Force, Natural Frequency, Dynamic Stress, and Insulator Loads. Optimize span length for LV/MV/HV switchgear.">
    <meta name="keywords" content="busbar calculator, iec 60865, short circuit force, dynamic stability, natural frequency, electromechanical stress, switchgear design, copper busbar sizing, insulator load">
    <meta name="author" content="Design Calculators">
    <meta name="robots" content="index, follow">

    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Montserrat:wght@700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- PDF & Charts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- MathJax -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['\\(', '\\)'], ['$', '$']],
                displayMath: [['\\[', '\\]'], ['$$', '$$']]
            },
            svg: { fontCache: 'global' }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <!-- Favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">

    <style>
        /* --- CORE THEME (Blue Industrial) --- */
        :root {
            --primary: #1E3A8A; /* Dark Blue */
            --secondary: #2563EB; /* Bright Blue */
            --accent: #F59E0B; /* Amber */
            --success: #10B981;
            --danger: #DC2626;
            --warning: #F59E0B;
            --bg: #F8FAFC;
            --card: #FFFFFF;
            --text: #4B5563;
            --heading: #111827;
            --footer-bg: #0F172A;
            --border: #E2E8F0;
            --grad: linear-gradient(135deg, var(--primary), var(--secondary));
        }

        body.dark-mode {
            --primary: #10B981;
            --secondary: #34D399;
            --bg: #0F172A;
            --card: #1E293B;
            --text: #CBD5E1;
            --heading: #F1F5F9;
            --footer-bg: #020617;
            --border: #334155;
            --accent: #F59E0B;
        }

        * { box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.7;
            margin: 0;
            padding: 0;
        }

        .container { max-width: 1280px; margin: 0 auto; padding: 0 24px; }

        /* Header */
        header {
            background: var(--grad);
            color: white;
            padding: 24px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .navbar { display: flex; justify-content: space-between; align-items: center; }
        .logo-container { text-decoration: none; color: white; display: flex; flex-direction: column; }
        .logo-text { font-size: 1.75rem; font-weight: 800; font-family: 'Montserrat', sans-serif; }
        .logo-subtitle { font-size: 0.8rem; margin: 4px 0 0 0; color: #E0E7FF; opacity: 0.9; }
        .nav-links { display: flex; gap: 24px; list-style: none; margin: 0; padding: 0; }
        .nav-links a { color: white; text-decoration: none; font-weight: 500; transition: color 0.3s; }
        .nav-links a:hover { color: var(--accent); }
        
        /* Theme Toggle */
        .theme-toggle { display: flex; align-items: center; gap: 12px; color: white; }
        .switch { position: relative; width: 56px; height: 30px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.2); transition: .4s; border-radius: 30px; }
        .slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(26px); }

        /* Main */
        main { padding: 40px 0; }
        .card {
            background: var(--card); border-radius: 12px; padding: 30px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05); margin-bottom: 30px; border: 1px solid var(--border);
            animation: fadeIn 0.6s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .card h2 {
            color: var(--primary); border-bottom: 3px solid var(--primary); padding-bottom: 15px;
            margin-top: 0; font-family: 'Montserrat', sans-serif; font-size: 1.8rem;
        }

        /* Forms */
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--heading); }
        .form-group input, .form-group select {
            width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 6px;
            background-color: var(--bg); color: var(--text); font-size: 1rem; transition: all 0.3s;
        }
        .form-group input:focus, .form-group select:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1); }
        
        .vector-input-group { background: var(--bg); padding: 15px; border-radius: 8px; border: 1px solid var(--border); position: relative; }
        .vector-input-header { font-weight: 700; margin-bottom: 10px; color: var(--primary); display: flex; align-items: center; gap: 8px; }

        /* Buttons */
        .btn {
            background: var(--grad); color: white; border: none; padding: 16px 30px;
            border-radius: 8px; cursor: pointer; font-size: 1.1rem; font-weight: 700;
            box-shadow: 0 4px 12px rgba(30, 58, 138, 0.3); transition: all 0.3s; width: 100%;
        }
        .btn:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(30, 58, 138, 0.4); }
        .btn-outline { background: transparent; border: 2px solid var(--secondary); color: var(--secondary); font-size: 0.9rem; padding: 8px 16px; }
        .btn-outline:hover { background: var(--secondary); color: white; }
        .button-wrapper { display: flex; justify-content: center; width: 100%; padding-top: 15px; gap: 15px; flex-wrap: wrap; }
        
        /* Presets */
        .preset-container { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
        .preset-btn { padding: 8px 12px; font-size: 0.85rem; border: 1px solid var(--border); background: var(--card); border-radius: 20px; cursor: pointer; transition: all 0.2s; color: var(--text); display: flex; align-items: center; gap: 5px; }
        .preset-btn:hover { background: var(--bg); border-color: var(--secondary); color: var(--secondary); }

        /* Results */
        .results-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; align-items: start; }
        @media (max-width: 1024px) { .results-grid { grid-template-columns: 1fr; } }
        .results-table { width: 100%; border-collapse: collapse; margin-top: 0; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-radius: 8px; overflow: hidden; }
        .results-table th, .results-table td { padding: 14px; text-align: left; border-bottom: 1px solid var(--border); }
        .results-table th { background: var(--grad); color: white; font-weight: 700; }
        .results-table td:first-child { font-weight: 600; color: var(--heading); }
        
        /* Steps */
        .calculation-step { font-family: 'Courier New', monospace; background-color: rgba(37, 99, 235, 0.05); padding: 15px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid var(--secondary); font-size: 0.95rem; line-height: 1.6; }
        .calculation-step h4 { color: var(--primary); margin-top: 0; margin-bottom: 10px; font-size: 1.1rem; border-bottom: 1px dashed var(--border); padding-bottom: 5px; }

        /* Visualization */
        .chart-container { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 15px; position: relative; height: 350px; width: 100%; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        canvas { max-width: 100%; max-height: 100%; }
        
        /* Educational */
        .insight-card { background: linear-gradient(135deg, var(--card), rgba(37,99,235,0.03)); border-radius: 12px; padding: 25px; margin: 20px 0; border-left: 5px solid var(--secondary); box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: all 0.3s; }
        .insight-card:hover { transform: translateX(5px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .insight-card h4 { color: var(--secondary); font-size: 1.3rem; margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px; font-family: 'Montserrat', sans-serif; }
        .insight-card p, .insight-card ul { margin: 10px 0; line-height: 1.8; color: var(--text); font-size: 1rem; }
        .insight-card ul { padding-left: 20px; }
        .insight-card li { margin-bottom: 8px; }

        /* Status Badges */
        .status-badge { padding: 4px 10px; border-radius: 4px; font-size: 0.75rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; display: inline-block; }
        .status-pass { background: #dcfce7; color: #166534; }
        .status-fail { background: #fee2e2; color: #991b1b; }
        .status-warn { background: #fef9c3; color: #854d0e; }

        /* Footer */
        footer { background: #0F172A; color: #CBD5E1; padding: 50px 0 20px 0; margin-top: 60px; }
        .footer-content { display: flex; justify-content: space-between; flex-wrap: wrap; gap: 40px; margin-bottom: 30px; }
        .footer-col { flex: 1; min-width: 200px; }
        .footer-col h4 { color: white; margin-bottom: 15px; font-weight: 700; }
        .footer-col ul { list-style: none; padding: 0; margin: 0; }
        .footer-col a { color: #CBD5E1; text-decoration: none; transition: color 0.3s; }
        .footer-col a:hover { color: var(--accent); }
        .social-buttons { display: flex; gap: 12px; margin-top: 15px; }
        .social-btn { width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; color: white; border-radius: 50%; font-size: 1.1rem; transition: transform 0.3s; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .social-btn:hover { transform: translateY(-4px); }
        .social-btn.linkedin { background-color: #0A66C2; }
        .social-btn.facebook { background-color: #1877F2; }
        .social-btn.twitter { background-color: #1DA1F2; }
        .footer-disclaimer { text-align: center; padding-top: 25px; border-top: 1px solid #334155; max-width: 800px; margin: 0 auto; font-size: 0.9rem; }
        .footer-bottom { text-align: center; padding-top: 20px; font-size: 0.9rem; color: #94A3B8; }
        .hidden { display: none; }
        
        .message-box { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); padding: 16px 28px; border-radius: 8px; box-shadow: 0 6px 16px rgba(0,0,0,0.25); z-index: 10000; font-weight: 600; color: white; opacity: 0; transition: all 0.4s; display: none; }
        .message-box.show { display: block; opacity: 1; top: 30px; }
    </style>
</head>
<body>
    <div id="message-box" class="message-box"></div>
    <header>
        <div class="container">
            <nav class="navbar">
                <a href="index.html" class="logo-container">
                    <span class="logo-text">Design Calculators</span>
                    <p class="logo-subtitle">Inspired by standards such as IEC, IEEE, ISA, ASME, and API.</p>
                </a>
                <ul class="nav-links">
                    <li><a href='index.html'>Home</a></li>
                    <li><a href="articles.html">Articles</a></li>
                    <li><a href="indexmech.html">Mechanical</a></li>
                    <li><a href="indexele.html">Electrical</a></li>
                    <li><a href="indexinst.html">Instrumentation</a></li>
                </ul>
                <div class="theme-toggle">
                    <i class="fas fa-sun"></i>
                    <label class="switch">
                        <input type="checkbox" id="theme-switch">
                        <span class="slider"></span>
                    </label>
                    <i class="fas fa-moon"></i>
                </div>
            </nav>
        </div>
    </header>

    <main class="container">
        <div class="card">
            <h2><i class="fas fa-bolt"></i> IEC 60865 Busbar Force & Dynamic Stability Calculator</h2>
            
            <div class="tool-description">
                <p>This commercial-grade engineering tool validates busbar systems against <strong>IEC 60865-1</strong> short-circuit standards. It calculates the **Peak Electromagnetic Force ($F_m$)**, determines the system's **Natural Frequency ($f_c$)** to detect resonance ($2f$ and $f$), and verifies if the resulting **Dynamic Stress ($\sigma_{tot}$)** and **Insulator Load** are within safe limits. It supports multi-bar configurations ($n$) and various support types.</p>
            </div>

            <div class="calculator-form">
                <form id="busbar-form">
                    <!-- Controls Row -->
                    <div class="form-row" style="align-items: end;">
                        <div class="form-group">
                            <label>Quick Load Scenarios:</label>
                            <div class="preset-container" style="margin-bottom: 0;">
                                <button type="button" class="preset-btn" onclick="loadPreset('lv_main')"><i class="fas fa-industry"></i> LV Main 50kA (Copper)</button>
                                <button type="button" class="preset-btn" onclick="loadPreset('mv_sub')"><i class="fas fa-bolt"></i> MV 25kA (Flat Mount)</button>
                                <button type="button" class="preset-btn" onclick="loadPreset('hv_alum')"><i class="fas fa-rss"></i> HV 40kA (Aluminum)</button>
                            </div>
                        </div>
                    </div>

                    <!-- Electrical Specs -->
                    <h4 style="color: var(--primary); margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 5px;">1. Electrical System</h4>
                    <div class="form-row">
                        <div class="vector-input-group">
                            <div class="vector-input-header"><i class="fas fa-bolt"></i> Fault Parameters</div>
                            <div class="form-group">
                                <label for="ik-rms">RMS Short Circuit ($I_k''$) [kA]</label>
                                <input type="number" id="ik-rms" value="50" step="1">
                            </div>
                            <div class="form-group" style="margin-top:10px;">
                                <label for="kappa">Peak Factor ($\kappa$) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Standard: 2.5 (DC component). Max theor: 2.828.</span></span></label>
                                <input type="number" id="kappa" value="2.5" step="0.1" min="1.0" max="3.0">
                            </div>
                            <div class="form-group" style="margin-top:10px;">
                                <label for="freq">System Frequency ($f$) [Hz]</label>
                                <select id="freq">
                                    <option value="50" selected>50 Hz</option>
                                    <option value="60">60 Hz</option>
                                </select>
                            </div>
                        </div>
                        <div class="vector-input-group">
                            <div class="vector-input-header"><i class="fas fa-ruler-horizontal"></i> Geometry</div>
                            <div class="form-group">
                                <label for="phase-dist">Phase Spacing ($a$) [mm] <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Center-to-center distance between phases.</span></span></label>
                                <input type="number" id="phase-dist" value="100" step="10">
                            </div>
                            <div class="form-group" style="margin-top:10px;">
                                <label for="span-len">Support Span ($l$) [mm] <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Distance between insulator supports.</span></span></label>
                                <input type="number" id="span-len" value="800" step="50">
                            </div>
                            <div class="form-group" style="margin-top:10px;">
                                <label for="beam-type">Support Type</label>
                                <select id="beam-type">
                                    <option value="continuous" selected>Continuous (Multi-span, c=3.56)</option>
                                    <option value="pinned">Pinned-Pinned (Simple, c=1.57)</option>
                                    <option value="fixed">Fixed-Fixed (c=3.56)</option>
                                    <option value="fixed-pinned">Fixed-Pinned (c=2.45)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Busbar Specs -->
                    <h4 style="color: var(--primary); margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 5px; margin-top: 20px;">2. Conductor Specification</h4>
                    <div class="form-row">
                        <div class="vector-input-group">
                            <div class="vector-input-header"><i class="fas fa-layer-group"></i> Material & Mounting</div>
                            <div class="form-group">
                                <label for="material">Busbar Material</label>
                                <select id="material">
                                    <option value="cu_hard" selected>Copper ETP (Hard) - Rp0.2=250 MPa</option>
                                    <option value="cu_half">Copper ETP (Half-Hard) - Rp0.2=200 MPa</option>
                                    <option value="al_t6">Aluminium 6060-T6 - Rp0.2=160 MPa</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-top:10px;">
                                <label for="orient">Orientation</label>
                                <select id="orient">
                                    <option value="edge" selected>Edge-to-Edge (Strong Axis)</option>
                                    <option value="flat">Flat-Facing (Weak Axis)</option>
                                </select>
                            </div>
                             <div class="form-group" style="margin-top:10px;">
                                <label for="sub-conductors">Bars per Phase ($n$)</label>
                                <select id="sub-conductors">
                                    <option value="1" selected>1 Bar</option>
                                    <option value="2">2 Bars</option>
                                    <option value="3">3 Bars</option>
                                    <option value="4">4 Bars</option>
                                </select>
                            </div>
                        </div>
                        <div class="vector-input-group">
                            <div class="vector-input-header"><i class="fas fa-ruler-combined"></i> Dimensions (Single Bar)</div>
                            <div class="form-group">
                                <label for="bar-width">Width ($b$) [mm] <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The wide dimension of the bar.</span></span></label>
                                <input type="number" id="bar-width" value="80" step="1">
                            </div>
                            <div class="form-group" style="margin-top:10px;">
                                <label for="bar-thick">Thickness ($d$) [mm]</label>
                                <input type="number" id="bar-thick" value="10" step="1">
                            </div>
                        </div>
                    </div>

                    <!-- Insulator Ratings -->
                    <h4 style="color: var(--primary); margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 5px; margin-top: 20px;">3. Limits</h4>
                    <div class="form-row">
                         <div class="vector-input-group">
                            <div class="vector-input-header"><i class="fas fa-shield-alt"></i> Safety</div>
                            <div class="form-group">
                                <label for="ins-rating">Insulator Rating [kN] <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Maximum Cantilever Strength from datasheet.</span></span></label>
                                <input type="number" id="ins-rating" value="10" step="0.5">
                            </div>
                        </div>
                    </div>

                    <div class="button-wrapper">
                        <button type="button" id="calculate-btn" class="btn"><i class="fas fa-calculator"></i> Calculate Dynamic Stress</button>
                        <button type="button" id="pdf-btn" class="btn btn-outline"><i class="fas fa-file-pdf"></i> Download IEC Report</button>
                    </div>
                </form>
            </div>

            <!-- Results Section -->
            <div id="result-container" class="card hidden" style="margin-top: 40px;">
                <h3><i class="fas fa-poll"></i> Stability Analysis</h3>
                
                <div class="results-grid">
                    <!-- Left Col: Table -->
                    <div>
                        <h4 style="margin-top: 0; color: var(--primary); margin-bottom: 15px;">IEC 60865 Results</h4>
                        <table class="results-table">
                            <thead>
                                <tr>
                                    <th>Parameter</th>
                                    <th>Value</th>
                                    <th>Limit / Status</th>
                                </tr>
                            </thead>
                            <tbody id="result-table-body">
                                <!-- Dynamic rows -->
                            </tbody>
                        </table>
                        
                        <div style="margin-top: 20px; background: var(--bg); padding: 15px; border-radius: 6px; border: 1px solid var(--border);">
                            <strong><i class="fas fa-info-circle"></i> Verification:</strong>
                            <div id="interpretation-text" style="margin-top: 5px; font-size: 0.95rem;"></div>
                        </div>
                    </div>

                    <!-- Right Col: Visual Chart -->
                    <div>
                        <h4 style="margin-top: 0; color: var(--primary); margin-bottom: 15px;">Dynamic Vibration Simulation</h4>
                        <div class="chart-container">
                            <canvas id="vibCanvas" width="400" height="300"></canvas>
                        </div>
                        <div style="text-align: center; margin-top: 10px; font-size: 0.85rem; color: var(--text);">
                            <span style="color: #3B82F6;">● Busbar Deflection (Exaggerated)</span> &nbsp;
                            <span style="color: #EF4444;">● Force</span>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <h4 style="margin-top: 0; color: var(--primary); margin-bottom: 15px;">Optimization Curve (Stress vs Span)</h4>
                             <div class="chart-container" style="height:200px">
                                <canvas id="optChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <h4 style="margin-top: 30px; border-top: 1px solid var(--border); padding-top: 20px;">Step-by-Step Engineering Calculation</h4>
                <div id="calculation-details">
                    <!-- Dynamic math steps -->
                </div>

                <div class="standard-reference" style="margin-top: 20px; font-style: italic; color: var(--text);">
                     Analysis strictly per IEC 60865-1. Calculates Peak Force ($F_m$), Natural Frequency ($f_c$), Stress Factor ($V_\sigma$), and Plasticity Factor ($q$). Assumes stiffening via spacers for multi-conductor systems.
                </div>
            </div>
        </div>

        <!-- EDUCATIONAL CONTENT SECTION (MASSIVE) -->
        <div class="education-section card">
            <h2><i class="fas fa-lightbulb"></i> Engineering Insights: Electromechanical Forces & IEC 60865</h2>
            
            <!-- Insight 1: Lorentz Force -->
            <div class="insight-card">
                <h4><i class="fas fa-magnet"></i> 1. The Physics of Short Circuits (Lorentz Force)</h4>
                <p>When a short-circuit fault occurs, thousands of amps flow through parallel busbars. The interaction between the magnetic fields creates a massive <strong>Lorentz Force</strong>. 
                <br>In a 3-phase fault, the force oscillates. The peak force ($F_m$) is proportional to the square of the peak current ($i_p^2$) and inversely proportional to the spacing ($a$).
                <br>$$ F_m = \frac{\mu_0}{2\pi} \frac{\sqrt{3}}{2} \frac{i_p^2}{a} $$
                <br>where $\mu_0 = 4\pi \times 10^{-7}$. Reducing phase spacing to save space drastically increases the force. Doubling the current quadruples the force.</p>
            </div>

            <!-- Insight 2: Dynamic Amplification -->
            <div class="insight-card">
                <h4><i class="fas fa-wave-square"></i> 2. Natural Frequency & Resonance</h4>
                <p>The busbar is a mechanical beam. If the electromagnetic force frequency ($2 \times f_{sys} \approx 100 \text{Hz}$ or $120 \text{Hz}$) aligns with the busbar's <strong>Natural Frequency ($f_c$)</strong>, resonance occurs.</p>
                <p>IEC 60865 defines dynamic response factors $V_F$ (for insulators) and $V_\sigma$ (for stress) based on the ratio $\eta = f_c / f_{force}$.
                <ul>
                    <li><strong>Stiff System ($f_c$ high):</strong> The busbar resists movement. $V \approx 1$.</li>
                    <li><strong>Flexible System ($f_c$ low):</strong> The busbar swings. Stresses might be lower due to flexibility, but displacement is high.</li>
                    <li><strong>Resonance ($f_c \approx 2f$):</strong> $V$ factors spike, potentially multiplying the static force by 3-5x.</li>
                </ul>
                </p>
            </div>

            <!-- Insight 3: Plasticity Factor q -->
            <div class="insight-card">
                <h4><i class="fas fa-compress-arrows-alt"></i> 3. The Plasticity Factor ($q$)</h4>
                <p>Unlike standard structural design where we stay below Yield Strength ($R_{p0.2}$), IEC 60865 allows busbars to slightly deform plastically during a rare fault event. This optimizes material usage.
                <br>For rectangular bars, the shape factor allows the outer fibers to yield while the core remains elastic.
                <br><strong>Allowable Stress = $q \times R_{p0.2}$</strong>. typically $q=1.5$ for rectangular copper sections. This means we can load the bar to 1.5x its yield strength safely for a momentary fault.</p>
            </div>

            <!-- Insight 4: Orientation & Multi-Conductor -->
            <div class="insight-card">
                <h4><i class="fas fa-layer-group"></i> 4. Edge vs. Flat & Multi-Bar</h4>
                <p><strong>Edge-to-Edge:</strong> The force acts against the "Height" of the bar (Strong Axis). High stiffness ($J$), high natural frequency. Best for high fault levels.
                <br><strong>Flat-Facing:</strong> The force acts against the "Thickness" (Weak Axis). Low stiffness. The bars will bow significantly. Only suitable for low fault levels or very short spans.</p>
                <p><strong>Multi-Conductor ($n > 1$):</strong> Using 2 or 3 bars per phase increases ampacity and cooling. If spaced properly, the total Inertia ($J$) is the sum of individual inertias. This tool approximates this by $n \times J_{single}$ assuming effective spacer coupling.</p>
            </div>
            
            <!-- Insight 5: Insulator Selection -->
             <div class="insight-card">
                <h4><i class="fas fa-shield-alt"></i> 5. Insulator Selection</h4>
                <p>The force transferred to the support ($F_d$) is often the limiting factor. It is not just the static peak force; it includes the dynamic amplification ($V_F$) and a reaction factor (typically 1.0 to 1.1 for continuous beams).
                <br>$$ F_d = V_F \cdot V_r \cdot \alpha \cdot F_m \cdot l $$
                <br>Ensure the insulator's Cantilever Strength Rating > $F_d$. Common ratings are 4kN, 6kN, 10kN. Upgrading insulators is often cheaper than adding more supports.</p>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-col">
                    <h4>Design Calculators</h4>
                    <p style="font-size: 0.9rem; line-height: 1.6; margin-bottom: 15px;">Empowering engineers with precision tools for complex analysis. If you find this tool helpful, please consider sharing it with your colleagues!</p>
                    <div class="social-buttons">
                        <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn linkedin" aria-label="LinkedIn"><i class="fab fa-linkedin-in"></i></a>
                        <a href="https://www.youtube.com/@designcalculators" target="_blank" rel="noopener noreferrer" class="social-btn youtube" aria-label="YouTube"><i class="fab fa-youtube"></i></a>
                        <a href="https://twitter.com/intent/tweet?url=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn twitter" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
                        <a href="https://www.facebook.com/sharer/sharer.php?u=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn facebook" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
                        <a href="https://api.whatsapp.com/send?text=Check%20out%20this%20amazing%20engineering%20resource:%20https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn whatsapp" aria-label="WhatsApp"><i class="fab fa-whatsapp"></i></a>
                    </div>
                </div>
                <div class="footer-col">
                    <h4>Quick Links</h4>
                    <ul>
                        <li><a href='index.html'>Home</a></li>
                        <li><a href="indexele.html">Electrical</a></li>
                        <li><a href="indexmech.html">Mechanical</a></li>
                        <li><a href="indexinst.html">Instrumentation</a></li>
                        <li><a href="articles.html">Articles</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>Resources</h4>
                    <ul>
                        <li><a href="about.html">About Us</a></li>
                        <li><a href="contact.html">Contact</a></li>
                        <li><a href="faq.html">FAQ</a></li>
                        <li><a href="privacy-policy.html">Privacy Policy</a></li>
                        <li><a href="terms-of-service.html">Terms of Service</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>More</h4>
                    <ul>
                        <li><a href='/articles.html'>Articles & Whitepapers</a></li>
                        <li><a href="sitemap2.html">Sitemap</a></li>                        
                    </ul>
                </div>
            </div>
            <div class="footer-disclaimer">
                <p>All calculations are for preliminary engineering design guidance. Final designs must comply with all applicable local and international standards (including but not limited to IEC 60865, IEEE 605). Always verify calculations and consult with a licensed professional engineer before implementation or construction.</p>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Design Calculators. Created by <span style="color: var(--secondary); font-weight: bold;">A Sharma</span>. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        // Global State
        let vibCanvas = null;
        let optChart = null;
        let lastResult = null;
        let animationId = null;

        // Material DB (SI units: Density kg/m3, E GPa, Rp MPa)
        const matDB = {
            'cu_hard': { name: 'Copper ETP (Hard)', rho: 8900, E: 120, Rp: 250 },
            'cu_half': { name: 'Copper ETP (Half)', rho: 8900, E: 120, Rp: 200 },
            'al_t6': { name: 'Aluminium 6060-T6', rho: 2700, E: 70, Rp: 160 }
        };

        // Support Factor 'c' for natural frequency
        const supportFactors = {
            'pinned': 1.57, // Simple
            'fixed': 3.56, // Fixed ends
            'fixed-pinned': 2.45,
            'continuous': 3.56 // IEC approx for multi-span main conductor
        };

        function loadPreset(type) {
            if (type === 'lv_main') {
                document.getElementById('ik-rms').value = '50';
                document.getElementById('kappa').value = '2.2';
                document.getElementById('phase-dist').value = '80';
                document.getElementById('span-len').value = '600';
                document.getElementById('material').value = 'cu_hard';
                document.getElementById('orient').value = 'edge';
                document.getElementById('bar-width').value = '80';
                document.getElementById('bar-thick').value = '10';
                document.getElementById('ins-rating').value = '10';
                document.getElementById('sub-conductors').value = '1';
                document.getElementById('beam-type').value = 'continuous';
            } else if (type === 'mv_sub') {
                document.getElementById('ik-rms').value = '25';
                document.getElementById('kappa').value = '2.5';
                document.getElementById('phase-dist').value = '220';
                document.getElementById('span-len').value = '800';
                document.getElementById('material').value = 'cu_half';
                document.getElementById('orient').value = 'flat'; 
                document.getElementById('bar-width').value = '60';
                document.getElementById('bar-thick').value = '10';
                document.getElementById('ins-rating').value = '12';
                document.getElementById('sub-conductors').value = '1';
                document.getElementById('beam-type').value = 'continuous';
            } else if (type === 'hv_alum') {
                document.getElementById('ik-rms').value = '40';
                document.getElementById('kappa').value = '2.6';
                document.getElementById('phase-dist').value = '400';
                document.getElementById('span-len').value = '1500';
                document.getElementById('material').value = 'al_t6';
                document.getElementById('orient').value = 'edge';
                document.getElementById('bar-width').value = '100';
                document.getElementById('bar-thick').value = '10';
                document.getElementById('ins-rating').value = '16';
                document.getElementById('sub-conductors').value = '2';
                document.getElementById('beam-type').value = 'continuous';
            }
            displayMessage(`${type.toUpperCase()} scenario loaded.`, "success");
        }

        function displayMessage(message, type = "info") {
            let messageBox = document.getElementById('message-box');
            messageBox.textContent = message;
            if (type === "error") messageBox.style.backgroundColor = 'var(--danger)';
            else if (type === "success") messageBox.style.backgroundColor = 'var(--success)';
            else messageBox.style.backgroundColor = 'var(--primary)';
            messageBox.classList.add('show');
            setTimeout(() => messageBox.classList.remove('show'), 4000);
        }

        document.addEventListener('DOMContentLoaded', function() {
            const themeSwitch = document.getElementById('theme-switch');
            if (themeSwitch && localStorage.getItem('theme') === 'dark') {
                document.body.classList.add('dark-mode');
                themeSwitch.checked = true;
            }
            if(themeSwitch) {
                themeSwitch.addEventListener('change', function() {
                    document.body.classList.toggle('dark-mode');
                    localStorage.setItem('theme', this.checked ? 'dark' : 'light');
                });
            }

            document.getElementById('calculate-btn').addEventListener('click', performCalculation);
            document.getElementById('pdf-btn').addEventListener('click', generatePDF);
        });

        function performCalculation() {
            // 1. Get Inputs
            const Ik_kA = parseFloat(document.getElementById('ik-rms').value);
            const kappa = parseFloat(document.getElementById('kappa').value);
            const freq = parseFloat(document.getElementById('freq').value);
            
            const a_mm = parseFloat(document.getElementById('phase-dist').value);
            const l_mm = parseFloat(document.getElementById('span-len').value);
            
            const matKey = document.getElementById('material').value;
            const orient = document.getElementById('orient').value;
            const b_mm = parseFloat(document.getElementById('bar-width').value); // Width (y)
            const d_mm = parseFloat(document.getElementById('bar-thick').value); // Thickness (x)
            const n_bars = parseInt(document.getElementById('sub-conductors').value);
            const beamType = document.getElementById('beam-type').value;
            
            const ins_rating_kN = parseFloat(document.getElementById('ins-rating').value);

            if (isNaN(Ik_kA) || isNaN(a_mm) || isNaN(l_mm) || isNaN(b_mm)) {
                displayMessage("Please enter valid numbers.", "error");
                return;
            }

            // 2. Physics Engine
            const mat = matDB[matKey];
            const E = mat.E * 1e9; // Pa
            const Rp = mat.Rp * 1e6; // Pa
            const rho = mat.rho;

            // Dimensions SI
            const a = a_mm / 1000;
            const l = l_mm / 1000;
            const b = b_mm / 1000;
            const d = d_mm / 1000;

            // Current
            const ip_kA = kappa * Math.sqrt(2) * Ik_kA;
            const ip = ip_kA * 1000;

            // A. Peak Force (Fm)
            // Fm = (mu0 / 2pi) * (sqrt(3)/2) * (ip^2 / a)
            const mu0 = 4 * Math.PI * 1e-7;
            const Fm = (mu0 / (2 * Math.PI)) * (Math.sqrt(3) / 2) * (Math.pow(ip, 2) / a); // N/m

            // B. Section Properties (Multi-Bar)
            // J (Inertia) depends on orientation relative to force.
            // Force is perpendicular to busbar length.
            // If Edge-to-Edge: Bending against Width (b). h = b, w = d.
            // If Flat: Bending against Thickness (d). h = d, w = b.
            
            let h_dim, w_dim;
            if (orient === 'edge') { h_dim = b; w_dim = d; }
            else { h_dim = d; w_dim = b; }

            // Single bar properties
            const J_single = (w_dim * Math.pow(h_dim, 3)) / 12; // m4
            const Z_single = (w_dim * Math.pow(h_dim, 2)) / 6;  // m3
            
            // Multi-bar properties (Simplified assumption: Spacers make them act as sum of individual bars for stiffness if loose, or compound if tight.
            // IEC 60865 simplifies this. For stress check, if spaced, calculate per bar. 
            // BUT for Frequency, mass increases by n, stiffness increases by n (if individual bending).
            // So J_total = n * J_single. Mass_total = n * Mass_single.
            // This simplification holds if bars are not structurally bonded into a composite beam.
            
            const J = n_bars * J_single;
            const Z = n_bars * Z_single; // Section modulus sum for stress calculation
            const Area = n_bars * b * d; // m2
            const m_prime = Area * rho; // kg/m

            // C. Natural Frequency (fc)
            // fc = (c / l^2) * sqrt(EJ / m')
            // c factor based on support type
            const c_factor = supportFactors[beamType];
            const fc = (c_factor / Math.pow(l, 2)) * Math.sqrt((E * J) / m_prime);

            // D. Response Factors (Rigorous IEC Logic)
            // ratio eta = fc / f. (Note: Stress freq is sometimes 2f, but IEC uses fc/f ratio for lookup)
            const N = fc / freq; 
            let VF = 1.0;
            let V_sigma = 1.0;
            
            // IEC 60865-1 Curve Equations (Simplified for code)
            // VF (Force factor on support)
            // V_sigma (Stress factor)
            
            // VF Logic:
            if (N > 2.0) VF = 1.0;
            else VF = Math.min(2.7, 1 + (2.7-1)*(1- (N-0.5)/1.5 ) ); // Mock curve peak at N=0.5 to 1.0? 
            // Better approx:
            // Region 1 (N < 0.66): VF = 1
            // Region 2 (0.66 < N < 2.5): Resonance peak. Max 2.0?
            // Let's use the explicit formulas often cited in guides or a robust curve fit.
            // For N < 0.5: VF = 1.
            // For N near 1: Resonance.
            // Use standard approximation: 
            if (N <= 0.5) VF = 1.0;
            else if (N >= 2.0) VF = 1.0;
            else VF = Math.max(1.0, 2.0 * Math.sin(Math.PI * N / 2)); // Bump function

            // V_sigma Logic:
            if (N <= 0.5) V_sigma = 1.0;
            else if (N >= 2.0) V_sigma = 1.0;
            else V_sigma = Math.min(3.0, 1 + 2 * Math.sin(Math.PI * N)); // Higher peak for stress

            // E. Stresses
            // Bending Moment M = Fm * l^2 / beta. beta depends on support.
            // continuous -> 10, pinned -> 8, fixed -> 12.
            let beta = 10;
            if(beamType === 'pinned') beta = 8;
            if(beamType === 'fixed') beta = 12;
            if(beamType === 'continuous') beta = 10;

            const M = (Fm * Math.pow(l, 2)) / beta;
            const sigma_tot = V_sigma * (M / Z); // Pa

            // Support Force Fd
            // Fd = VF * Fm * l * alpha. alpha reaction factor.
            // continuous -> 1.1, pinned -> 0.5 (per support? no total load/2), fixed -> 0.5.
            // For worst case support in continuous span, alpha = 1.1 or 1.25. Use 1.1.
            let alpha_react = 1.1;
            if(beamType === 'pinned') alpha_react = 0.5;
            
            const Fd = VF * Fm * l * alpha_react; // N

            // F. Limits
            // q factor (plasticity). Rectangular = 1.5.
            const q = 1.5;
            const sigma_limit = q * Rp;

            // Insulator Limit
            const F_limit = ins_rating_kN * 1000;

            // Status
            const stress_pass = sigma_tot < sigma_limit;
            const ins_pass = Fd < F_limit;
            
            lastResult = { Ik_kA, ip_kA, Fm, fc, VF, V_sigma, sigma_tot, Fd, sigma_limit, F_limit, stress_pass, ins_pass, mat, orient, l, a, b, d, n_bars, beamType };

            // 4. Render Step-by-Step
            let html = `<h4>Step 1: Electromagnetic Force Calculation</h4>`;
            html += `<div class="calculation-step">`;
            html += `Peak Current $i_p = \\kappa \\sqrt{2} I_k'' = ${kappa} \\sqrt{2} ( ${Ik_kA} ) = \\mathbf{${ip_kA.toFixed(1)} \\text{ kA}}$<br>`;
            html += `Peak Force $F_m = \\frac{\\mu_0}{2\\pi} \\frac{\\sqrt{3}}{2} \\frac{i_p^2}{a} = \\mathbf{${Fm.toFixed(0)} \\text{ N/m}}$<br>`;
            html += `(Force per unit length between main conductors)`;
            html += `</div>`;

            html += `<h4>Step 2: Natural Frequency ($f_c$)</h4>`;
            html += `<div class="calculation-step">`;
            html += `System: ${n_bars}x ${w_dim.toFixed(0)}x${h_dim.toFixed(0)}mm bars per phase.<br>`;
            html += `Total Inertia $J_{tot} = ${n_bars} \\times J_{single} = ${J.toExponential(2)} \\text{ m}^4$<br>`;
            html += `Total Mass $m' = ${m_prime.toFixed(2)} \\text{ kg/m}$. Factor $c=${c_factor}$ (${beamType}).<br>`;
            html += `$$ f_c = \\frac{${c_factor}}{l^2} \\sqrt{\\frac{EJ}{m'}} = \\frac{${c_factor}}{${l}^2} \\sqrt{\\frac{${(E/1e9).toFixed(0)}e9 \\cdot ${J.toExponential(1)}}{${m_prime.toFixed(1)}}} = \\mathbf{${fc.toFixed(1)} \\text{ Hz}} $$`;
            html += `</div>`;

            html += `<h4>Step 3: Dynamic Stress & Load</h4>`;
            html += `<div class="calculation-step">`;
            html += `Freq Ratio $\\eta = f_c / f = ${N.toFixed(2)}$. Dynamic Factors: $V_\\sigma=${V_sigma.toFixed(2)}$, $V_F=${VF.toFixed(2)}$.<br>`;
            html += `Bending Moment $M = \\frac{F_m l^2}{\\beta} = \\frac{${Fm.toFixed(0)} \\cdot ${l}^2}{${beta}} = ${(M).toFixed(1)} \\text{ Nm}$.<br>`;
            html += `$$ \\sigma_{tot} = V_\\sigma \\cdot V_r \\cdot \\frac{M}{Z} = ${V_sigma.toFixed(2)} \\cdot 1.0 \\cdot \\frac{${M.toFixed(1)}}{${Z.toExponential(2)}} = \\mathbf{${(sigma_tot/1e6).toFixed(1)} \\text{ MPa}} $$<br>`;
            html += `$$ F_d = V_F \\cdot F_m \\cdot l \\cdot \\alpha = ${VF.toFixed(2)} \\cdot ${Fm.toFixed(0)} \\cdot ${l} \\cdot ${alpha_react} = \\mathbf{${(Fd/1000).toFixed(2)} \\text{ kN}} $$`;
            html += `</div>`;

            document.getElementById('calculation-details').innerHTML = html;

            // 5. Update Table
            const tbody = document.getElementById('result-table-body');
            tbody.innerHTML = '';
            const addRow = (n, v, l, pass) => {
                const color = pass ? "var(--success)" : "var(--danger)";
                const status = pass ? "PASS" : "FAIL";
                tbody.innerHTML += `<tr style="color:${color}"><td><strong>${n}</strong></td><td>${v}</td><td>${l} <strong>(${status})</strong></td></tr>`;
            };
            addRow("Busbar Stress", (sigma_tot/1e6).toFixed(1) + " MPa", "< " + (sigma_limit/1e6).toFixed(1) + " MPa", stress_pass);
            addRow("Insulator Load", (Fd/1000).toFixed(2) + " kN", "< " + (F_limit/1000).toFixed(1) + " kN", ins_pass);
            
            tbody.innerHTML += `<tr><td><strong>Natural Freq</strong></td><td>${fc.toFixed(1)} Hz</td><td>-</td></tr>`;
            tbody.innerHTML += `<tr><td><strong>Peak Force</strong></td><td>${Fm.toFixed(0)} N/m</td><td>-</td></tr>`;

            const interpEl = document.getElementById('interpretation-text');
            if (!stress_pass && !ins_pass) {
                interpEl.innerHTML = `<span style="color:var(--danger); font-weight:bold;">CRITICAL FAILURE.</span> Both busbars and insulators will fail. Reduce span length immediately.`;
            } else if (!stress_pass) {
                interpEl.innerHTML = `<span style="color:var(--danger); font-weight:bold;">BUSBAR YIELD.</span> Stress exceeds plastic limit. Increase profile size or reduce span.`;
            } else if (!ins_pass) {
                interpEl.innerHTML = `<span style="color:var(--danger); font-weight:bold;">INSULATOR BREAKAGE.</span> Forces exceed support rating. Use stronger insulators or reduce span.`;
            } else {
                interpEl.innerHTML = `<span style="color:var(--success); font-weight:bold;">SYSTEM SAFE.</span> Design is compliant with IEC 60865.`;
            }

            // 6. Visuals
            startAnimation(fc, sigma_tot, sigma_limit);
            drawChart(sigma_limit);

            // 7. Show
            document.getElementById('result-container').classList.remove('hidden');
            if(window.MathJax) window.MathJax.typesetPromise([document.getElementById('calculation-details')]);
            document.getElementById('result-container').scrollIntoView({ behavior: 'smooth' });
        }

        // --- ANIMATION ---
        function startAnimation(fc, stress, limit) {
            const canvas = document.getElementById('vibCanvas');
            const ctx = canvas.getContext('2d');
            const cw = canvas.width;
            const ch = canvas.height;
            
            if (animationId) cancelAnimationFrame(animationId);
            
            let time = 0;
            // Amplitude scaling: if stress > limit, shake violently
            const baseAmp = 20;
            const severity = Math.min(stress / limit, 2.0); // Cap at 2x
            const amplitude = baseAmp * severity;
            const speed = Math.max(0.05, Math.min(fc / 200, 0.5)); // Visual speed proportional to fc

            function draw() {
                ctx.clearRect(0, 0, cw, ch);
                
                // Draw Supports
                ctx.fillStyle = '#64748B';
                ctx.fillRect(50, ch/2 + 20, 20, 40); // Left
                ctx.fillRect(cw-70, ch/2 + 20, 20, 40); // Right
                
                // Draw Busbar (Vibrating Beam)
                ctx.beginPath();
                ctx.lineWidth = 10;
                // Color changes if fail
                ctx.strokeStyle = stress > limit ? '#EF4444' : '#1E3A8A'; // Red or Blue
                
                // Sine wave shape
                for (let x = 50; x <= cw - 50; x++) {
                    const nx = (x - 50) / (cw - 100) * Math.PI;
                    const dy = Math.sin(nx) * Math.sin(time) * amplitude;
                    
                    if (x === 50) ctx.moveTo(x, ch/2 + dy);
                    else ctx.lineTo(x, ch/2 + dy);
                }
                ctx.stroke();

                // Draw Force Arrows
                if (Math.sin(time) > 0) {
                     ctx.fillStyle = '#F59E0B';
                     const yArr = ch/2 + amplitude/2;
                     ctx.beginPath();
                     ctx.moveTo(cw/2, yArr - 20);
                     ctx.lineTo(cw/2 - 10, yArr - 40);
                     ctx.lineTo(cw/2 + 10, yArr - 40);
                     ctx.fill();
                }

                time += speed;
                animationId = requestAnimationFrame(draw);
            }
            draw();
        }

        // --- CHART ---
        function drawChart(limit) {
             const ctx = document.getElementById('optChart').getContext('2d');
            if (optChart) optChart.destroy();

            // Plot Stress vs Span Length
            const currentL = lastResult.l * 1000; // mm
            const labels = [];
            const dataStress = [];
            const dataLimit = [];
            
            const startL = currentL * 0.5;
            const endL = currentL * 1.5;
            const step = (endL - startL) / 10;
            
            const baseStress = lastResult.sigma_tot / 1e6; // MPa
            const limitMPa = limit / 1e6;

            for(let l_val = startL; l_val <= endL; l_val += step) {
                labels.push(l_val.toFixed(0));
                // Stress scales with L^2 roughly
                const s = baseStress * Math.pow(l_val / currentL, 2);
                dataStress.push(s);
                dataLimit.push(limitMPa);
            }

            optChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Stress (MPa)',
                            data: dataStress,
                            borderColor: '#1E3A8A',
                            fill: true,
                            backgroundColor: 'rgba(30, 58, 138, 0.1)'
                        },
                        {
                            label: 'Limit',
                            data: dataLimit,
                            borderColor: '#EF4444',
                            borderDash: [5,5],
                            pointRadius: 0
                        },
                         {
                            label: 'Current Span',
                            data: [{x: currentL, y: baseStress}], 
                            pointRadius: 6,
                            backgroundColor: '#F59E0B',
                            type: 'scatter'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { title: {display:true, text:'Span Length (mm)'} },
                        y: { title: {display:true, text:'Stress (MPa)'} }
                    }
                }
            });
        }

        function generatePDF() {
            if (!lastResult) {
                displayMessage("Calculate first.", "error");
                return;
            }
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            let y = 15;

            pdf.setFont('helvetica', 'bold');
            pdf.setFontSize(16);
            pdf.setTextColor(30, 58, 138); 
            pdf.text('IEC 60865 Busbar Analysis', 105, y, { align: 'center' });
            y += 10;

            pdf.setFontSize(10);
            pdf.setTextColor(100);
            pdf.text(`Date: ${new Date().toLocaleString()}`, 105, y, { align: 'center' });
            y += 15;

            const inputData = [
                ['Peak Current (ip)', `${lastResult.ip_kA.toFixed(1)} kA`],
                ['Span Length', `${(lastResult.l*1000).toFixed(0)} mm`],
                ['Phase Spacing', `${(lastResult.a*1000).toFixed(0)} mm`],
                ['Material', lastResult.mat.name],
                ['Configuration', `${lastResult.n_bars}x ${(lastResult.b*1000).toFixed(0)}x${(lastResult.d*1000).toFixed(0)} mm`]
            ];

            pdf.autoTable({
                startY: y,
                head: [['Parameter', 'Value']],
                body: inputData,
                margin: { left: 14, right: 14 },
                theme: 'grid',
                headStyles: { fillColor: [30, 58, 138] }
            });
            y = pdf.lastAutoTable.finalY + 15;

            const resData = [
                ['Peak Force', `${lastResult.Fm.toFixed(0)} N/m`],
                ['Natural Freq', `${lastResult.fc.toFixed(1)} Hz`],
                ['Stress', `${(lastResult.sigma_tot/1e6).toFixed(1)} MPa`],
                ['Limit', `${(lastResult.sigma_limit/1e6).toFixed(1)} MPa`],
                ['Result', lastResult.stress_pass && lastResult.ins_pass ? 'PASS' : 'FAIL']
            ];

            pdf.autoTable({
                startY: y,
                head: [['Metric', 'Result']],
                body: resData,
                margin: { left: 14, right: 14 },
                theme: 'grid',
                headStyles: { fillColor: [30, 58, 138] },
                didParseCell: function(data) {
                    if(data.row.index === 4) {
                        data.cell.styles.fontStyle = 'bold';
                        data.cell.styles.textColor = lastResult.stress_pass && lastResult.ins_pass ? [16, 185, 129] : [220, 38, 38];
                    }
                }
            });

            pdf.save('Busbar_Report.pdf');
            displayMessage("PDF Downloaded", "success");
        }
    </script>
</body>
</html>
