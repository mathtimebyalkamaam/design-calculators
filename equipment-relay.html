<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Breaker Relay Settings Calculator - Design Calculators - Electrical</title>
    <!-- SEO Meta Tags -->
    <meta name="description" content="Professional industrial breaker relay settings calculator. Calculates protection settings for transformers, motors, MCC, PCC per IEEE C37.112, IEC 60255 standards.">
    <meta name="keywords" content="relay settings, breaker protection, overcurrent relay, transformer protection, motor protection, IEEE C37.112, IEC 60255, industrial electrical">
    <meta name="author" content="Design Calculators">
    <meta name="robots" content="index, follow">
    <!-- AdSense & Analytics -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5936527763614780" crossorigin="anonymous"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-23Y1V450SR"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-23Y1V450SR');
    </script>
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Montserrat:wght@700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- MathJax for Formulas -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['\\(', '\\)'], ['$', '$']],
                displayMath: [['\\[', '\\]'], ['$$', '$$']]
            },
            svg: { fontCache: 'global' }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <!-- PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root {
            --primary: #1E3A8A;
            --secondary: #2563EB;
            --accent: #F59E0B;
            --success: #10B981;
            --danger: #DC2626;
            --warning: #F59E0B;
            --bg: #F8FAFC;
            --card: #FFFFFF;
            --text: #4B5563;
            --heading: #111827;
            --footer-bg: #0F172A;
            --border: #E2E8F0;
            --grad: linear-gradient(135deg, var(--primary), var(--secondary));
            --grad-dark: linear-gradient(135deg, #0F172A, #1E293B);
            --shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        body.dark-mode {
            --primary: #10B981;
            --secondary: #34D399;
            --bg: #0F172A;
            --card: #1E293B;
            --text: #CBD5E1;
            --heading: #F1F5F9;
            --footer-bg: #020617;
            --border: #334155;
        }

        * { box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.7;
            margin: 0;
            padding: 0;
        }

        .container { max-width: 1280px; margin: 0 auto; padding: 0 24px; }

        /* Header & Nav */
        header {
            background: var(--grad);
            color: white;
            padding: 24px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo-container {
            display: flex;
            flex-direction: column;
            text-decoration: none;
            color: white;
        }
        .logo-text {
            font-size: 1.75rem;
            font-weight: 800;
            font-family: 'Montserrat', sans-serif;
        }
        .logo-subtitle {
            font-size: 0.8rem;
            margin: 4px 0 0 0;
            color: #E0E7FF;
            opacity: 0.9;
        }
        .nav-links {
            display: flex;
            gap: 24px;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        .nav-links a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }
        .nav-links a:hover { color: var(--accent); }
        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .switch {
            position: relative;
            width: 56px;
            height: 30px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.2);
            transition: .4s;
            border-radius: 30px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--accent);
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        /* Main Content & Cards */
        main { padding: 40px 0; }
        .card {
            background: var(--card);
            border-radius: 12px;
            padding: 30px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            border: 1px solid var(--border);
        }
        h2 {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
            padding-bottom: 15px;
            margin-top: 0;
            font-family: 'Montserrat', sans-serif;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        h3 {
            color: var(--heading);
            font-family: 'Montserrat', sans-serif;
            font-size: 1.5rem;
            margin-top: 25px;
            margin-bottom: 20px;
        }
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--heading);
        }
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 6px;
            background-color: var(--bg);
            color: var(--text);
            font-size: 1rem;
        }
        .form-group input:focus,
        .form-group select:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
        }
        body.dark-mode .form-group input:focus {
             box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }
        
        /* Input Modes */
        .input-mode-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background-color: var(--bg);
            border-radius: 8px;
            padding: 5px;
        }
        .input-mode-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            background: transparent;
            color: var(--text);
            font-weight: 600;
            transition: all 0.3s;
        }
        .input-mode-btn.active {
            background: var(--card);
            color: var(--primary);
            border-color: var(--primary);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .btn {
            background: var(--grad);
            color: white;
            border: none;
            padding: 16px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(30, 58, 138, 0.3);
            transition: all 0.3s;
            width: 100%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(30, 58, 138, 0.4);
        }
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .btn-group .btn {
            flex: 1;
            min-width: 150px;
        }
        .btn.secondary {
            background: var(--secondary);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }
        .btn.accent {
            background: var(--accent);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }

        /* CALCULATION STEPS DISPLAY - REVAMPED */
        .steps-container {
            display: none;
            margin-top: 30px;
        }
        .steps-container.active {
            display: block;
        }
        .step-card {
            background: var(--card);
            border-radius: 12px;
            padding: 25px 30px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            animation: slideIn 0.6s ease-out;
            transition: all 0.3s;
            margin-bottom: 25px; /* Spacing between cards */
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .step-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }
        .step-card h4 {
            color: var(--primary);
            margin: 0 0 20px 0;
            font-size: 1.4rem;
            font-family: 'Montserrat', sans-serif;
            display: flex;
            align-items: center;
        }
        .step-card .number {
            display: inline-block;
            width: 40px;
            height: 40px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 40px;
            font-weight: 700;
            margin-right: 15px;
            font-size: 1.3rem;
            flex-shrink: 0;
        }
        .step-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            align-items: center;
        }
        .step-content-full {
             grid-template-columns: 1fr;
        }
         @media (max-width: 768px) {
            .step-content {
                grid-template-columns: 1fr;
            }
        }
        .step-value {
            font-size: 2.2rem;
            font-weight: 800;
            color: var(--success);
            margin: 10px 0;
            line-height: 1.2;
        }
        .step-unit {
            font-size: 1rem;
            color: var(--text);
            opacity: 0.8;
            font-weight: 500;
            margin-left: 5px;
        }
        .formula {
            background: var(--bg);
            border-left: 3px solid var(--accent);
            padding: 15px;
            margin: 12px 0;
            font-size: 1rem;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
        }
        .step-explanation {
            font-size: 1.05rem;
            line-height: 1.8;
        }
        .step-explanation strong {
            color: var(--heading);
        }
        .analogy {
            background: var(--bg);
            border: 1px dashed var(--border);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-style: italic;
        }
        .analogy i {
            color: var(--primary);
            margin-right: 8px;
        }
        .step-recommendation {
            border-radius: 8px;
            padding: 20px;
        }
        .step-recommendation.warning {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(245, 158, 11, 0.05));
            border-left: 5px solid var(--warning);
        }
        .step-recommendation.warning h5 { color: var(--warning); }
        
        .step-recommendation.success {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
            border-left: 5px solid var(--success);
        }
         .step-recommendation.success h5 { color: var(--success); }
        
        .step-recommendation h5 {
            margin: 0 0 10px 0;
            font-size: 1.2rem;
            font-weight: 700;
        }
        .step-recommendation ul {
            padding-left: 20px;
            margin: 10px 0 0 0;
        }

        /* Results */
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-radius: 8px;
            overflow: hidden;
        }
        .results-table th,
        .results-table td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        .results-table th {
            background: var(--grad);
            color: white;
            font-weight: 700;
        }
        .results-table tr:nth-child(even) {
            background-color: var(--bg);
        }
        .results-table td:first-child {
            font-weight: 600;
            color: var(--heading);
        }
        .results-table .highlight {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--success);
        }
        .highlight-box {
            background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(16,185,129,0.05));
            border-left: 4px solid var(--success);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .highlight-box h4 {
            color: var(--success);
            margin-top: 0;
        }

        /* Educational Section */
        .education-section {
            margin-top: 60px;
        }
        .insight-card {
            background: linear-gradient(135deg, var(--card), rgba(37,99,235,0.03));
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            border-left: 5px solid var(--secondary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: all 0.3s;
        }
        .insight-card:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .insight-card h4 {
            color: var(--secondary);
            font-size: 1.3rem;
            margin: 0 0 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .insight-card h4 i {
            font-size: 1.5rem;
        }
        .insight-card p {
            margin: 10px 0;
            line-height: 1.8;
        }
        .stat-highlight {
            display: inline-block;
            background: var(--accent);
            color: #333;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 700;
            margin: 0 4px;
        }
        .danger-box {
            background: linear-gradient(135deg, rgba(220,38,38,0.1), rgba(220,38,38,0.05));
            border-left: 5px solid var(--danger);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }
        .danger-box h4 {
            color: var(--danger);
            margin-top: 0;
        }
        .success-box {
            background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(16,185,129,0.05));
            border-left: 5px solid var(--success);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }
        .success-box h4 {
            color: var(--success);
            margin-top: 0;
        }
        .three-col {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .metric-box {
            background: var(--card);
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        .metric-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
            margin: 10px 0;
        }
        .metric-label {
            font-size: 0.9rem;
            color: var(--text);
        }
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            border-radius: 8px;
            overflow: hidden;
        }
        .comparison-table th,
        .comparison-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }
        .comparison-table th {
            background: var(--grad);
            color: white;
            font-weight: 700;
        }
        .comparison-table tr:nth-child(even) {
            background: var(--bg);
        }

        /* Message Box */
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 16px 28px;
            border-radius: 8px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.25);
            z-index: 10000;
            font-weight: 600;
            color: white;
            opacity: 0;
            transition: all 0.4s;
            display: none;
        }
        .message-box.show {
            display: block;
            opacity: 1;
            top: 30px;
        }

        /* Footer */
        footer {
            background: var(--grad-dark);
            color: #CBD5E1;
            padding: 50px 0 20px 0;
            margin-top: 60px;
        }
        .footer-content {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 40px;
            margin-bottom: 30px;
        }
        .footer-col {
            flex: 1;
            min-width: 200px;
        }
        .footer-col h4 {
            color: white;
            margin-bottom: 15px;
            font-weight: 700;
        }
        .footer-col ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .footer-col a {
            color: #CBD5E1;
            text-decoration: none;
            transition: color 0.3s;
        }
        .footer-col a:hover {
            color: var(--accent);
        }
        .social-buttons {
            display: flex;
            gap: 12px;
            margin-top: 15px;
        }
        .social-btn {
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            border-radius: 50%;
            font-size: 1.1rem;
            transition: transform 0.3s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .social-btn:hover {
            transform: translateY(-4px);
        }
        .social-btn.linkedin { background-color: #0A66C2; }
        .social-btn.youtube { background-color: #FF0000; }
        .social-btn.twitter { background-color: #1DA1F2; }
        .social-btn.facebook { background-color: #1877F2; }
        .social-btn.whatsapp { background-color: #25D366; }
        .footer-disclaimer {
            text-align: center;
            padding-top: 25px;
            border-top: 1px solid #334155;
            max-width: 800px;
            margin: 0 auto;
            font-size: 0.9rem;
        }
        .footer-bottom {
            text-align: center;
            padding-top: 20px;
            font-size: 0.9rem;
            color: #94A3B8;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container { padding: 0 15px; }
            .navbar { flex-direction: column; gap: 20px; }
            .nav-links { flex-direction: column; gap: 12px; text-align: center; }
            .form-row { grid-template-columns: 1fr; }
            .card { padding: 20px; }
            .footer-content { flex-direction: column; gap: 25px; }
            .btn-group { flex-direction: column; }
            .input-mode-toggle { flex-direction: column; }
        }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div id="message-box" class="message-box"></div>

    <header>
        <div class="container">
            <nav class="navbar">
                <a href="#" class="logo-container">
                    <span class="logo-text">Design Calculators</span>
                    <p class="logo-subtitle">Inspired by standards such as IEC, IEEE, ISA, ASME, and API.</p>
                </a>
                <ul class="nav-links">
                    <li><a href='/'>Home</a></li>
                    <li><a href="articles">Articles</a></li>
                    <li><a href="indexmech">Mechanical</a></li>
                    <li><a href="indexele">Electrical</a></li>
                    <li><a href="indexinst">Instrumentation</a></li>
                </ul>
                <div class="theme-toggle">
                    <i class="fas fa-sun"></i>
                    <label class="switch">
                        <input type="checkbox" id="theme-switch">
                        <span class="slider"></span>
                    </label>
                    <i class="fas fa-moon"></i>
                </div>
            </nav>
        </div>
    </header>

    <main class="container">
        <div class="card">
            <h2><i class="fas fa-shield-alt"></i> Advanced Breaker Relay Settings Calculator</h2>
            <p>Calculate professional protection relay settings for transformers, motors, MCC, PCC and other electrical equipment. Aligned with IEEE C37.112, IEC 60255, and other international standards.</p>

            <form id="relay-form">
                <h3>System & Equipment Parameters</h3>
                
                <!-- Input Mode Toggle -->
                <div class="input-mode-toggle">
                    <button type="button" class="input-mode-btn active" data-mode="basic"><i class="fas fa-sliders-h"></i> Basic Parameters</button>
                    <button type="button" class="input-mode-btn" data-mode="advanced"><i class="fas fa-cogs"></i> Advanced Parameters</button>
                </div>
                
                <!-- Mode 1: Basic -->
                <div id="mode-basic">
                     <div class="form-row">
                        <div class="form-group">
                            <label for="equipment-type">Equipment Type</label>
                            <select id="equipment-type" required>
                                <option value="transformer">Transformer</option>
                                <option value="motor">Motor</option>
                                <option value="mcc">MCC Feeder</option>
                                <option value="pcc">PCC Feeder</option>
                                <option value="generator">Generator</option>
                                <option value="capacitor">Capacitor Bank</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="voltage-rating">Voltage Rating (kV)</label>
                            <input type="number" id="voltage-rating" step="0.001" min="0.415" max="220" value="11" required>
                        </div>
                         <div class="form-group">
                            <label for="kva-kw-rating">Rating (kVA / kW)</label>
                            <input type="number" id="kva-kw-rating" step="0.1" value="1000" required>
                        </div>
                    </div>
                </div>

                <!-- Mode 2: Advanced -->
                <div id="mode-advanced" class="hidden">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="system-grounding">System Grounding Type</label>
                            <select id="system-grounding" required>
                                <option value="solidly_grounded">Solidly Grounded</option>
                                <option value="resistance_grounded">Resistance Grounded</option>
                                <option value="ungrounded">Ungrounded</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="fault-level">System Fault Level (kA)</label>
                            <input type="number" id="fault-level" step="0.1" min="1" value="25" required>
                        </div>
                        <div class="form-group">
                            <label for="protection-type">Primary Protection Type</label>
                            <select id="protection-type" required>
                                <option value="overcurrent">Overcurrent (51/50)</option>
                                <option value="differential">Differential (87)</option>
                                <option value="distance">Distance (21)</option>
                                <option value="motor">Motor Protection (49/51)</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <hr style="margin: 15px 0; border: none; border-top: 1px solid var(--border);">

                <h3>Instrument Transformer Details</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="ct-ratio-primary">CT Primary (A)</label>
                        <input type="number" id="ct-ratio-primary" step="1" value="400" required>
                    </div>
                    <div class="form-group">
                        <label for="ct-ratio-secondary">CT Secondary (A)</label>
                        <input type="number" id="ct-ratio-secondary" step="1" value="5" required>
                    </div>
                    <div class="form-group">
                        <label for="pt-primary">PT Primary (V)</label>
                        <input type="number" id="pt-primary" step="1" value="11000" required>
                    </div>
                    <div class="form-group">
                        <label for="pt-secondary">PT Secondary (V)</label>
                        <input type="number" id="pt-secondary" step="1" value="110" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="ct-burden">CT Burden (VA)</label>
                        <input type="number" id="ct-burden" step="0.1" value="10" required>
                    </div>
                    <div class="form-group">
                        <label for="ct-accuracy-class">CT Accuracy Class</label>
                        <input type="text" id="ct-accuracy-class" value="C100" required>
                    </div>
                    <div class="form-group">
                        <label for="relay-technology">Relay Technology</label>
                        <select id="relay-technology" required>
                            <option value="numerical">Numerical (Digital)</option>
                            <option value="electromechanical">Electro-mechanical</option>
                            <option value="static">Static (Solid State)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="coordination-time">Coordination Time (s)</label>
                        <input type="number" id="coordination-time" step="0.01" min="0.05" value="0.25" required>
                    </div>
                </div>

                <div class="btn-group" style="margin-top: 25px;">
                    <button type="button" id="calc-btn" class="btn"><i class="fas fa-calculator"></i> Calculate Relay Settings</button>
                    <button type="button" id="reset-btn" class="btn accent"><i class="fas fa-sync-alt"></i> Reset</button>
                    <button type="button" id="pdf-btn" class="btn secondary" style="display: none;"><i class="fas fa-file-pdf"></i> Download PDF</button>
                </div>
            </form>
        </div>

        <!-- LIVE CALCULATION STEPS -->
        <div id="steps-container" class="steps-container">
            
            <div class="step-card">
                <h4><span class="number">1</span> System & Equipment Analysis</h4>
                <div class="step-content">
                    <div class="step-explanation">
                        <p>First, we analyze your <strong>electrical system</strong> and <strong>protected equipment</strong> to understand the baseline conditions. Different equipment types require different protection philosophies and settings.</p>
                        <p>The system fault level and grounding type significantly impact protection requirements, particularly for earth fault protection.</p>
                        <div class="analogy">
                            <i class="fas fa-shield-alt"></i><strong>The Security Guard Analogy:</strong> Think of your protection system as security guards - they need to know what they're protecting (equipment type), the environment (system parameters), and when to take action (fault conditions) to be effective.
                        </div>
                    </div>
                    <div id="step1-content">
                        <!-- Content dynamically inserted by JS -->
                    </div>
                </div>
            </div>

            <div class="step-card">
                <h4><span class="number">2</span> Current & Voltage Scaling</h4>
                <div class="step-content">
                     <div class="step-explanation">
                        <p>Next, we calculate the <strong>current and voltage scaling</strong> based on your instrument transformer ratios. This converts primary system values to secondary values that the relay can process.</p>
                        <p>Proper CT and PT selection is critical for accurate protection - undersized transformers can saturate during faults, while oversized ones reduce sensitivity.</p>
                    </div>
                    <div id="step2-content">
                        <!-- Content dynamically inserted by JS -->
                    </div>
                </div>
            </div>
            
            <div class="step-card">
                <h4><span class="number">3</span> Protection Function Settings</h4>
                <div class="step-content">
                    <div class="step-explanation">
                        <p>The core of relay setting involves calculating appropriate <strong>pickup values</strong> and <strong>time delays</strong> for each protection function.</p>
                        <p>These settings must balance sensitivity (detecting all real faults) with security (avoiding false operations), while maintaining proper coordination with other protective devices.</p>
                        <p><strong>Formula (Overcurrent Pickup):</strong><br> $I_{pickup} = K \times I_{FLC}$</p>
                    </div>
                    <div id="step3-content">
                        <!-- Content dynamically inserted by JS -->
                    </div>
                </div>
            </div>
            
            <div class="step-card">
                <h4><span class="number">4</span> Coordination & Selectivity Analysis</h4>
                 <div class="step-content step-content-full">
                    <div class="step-explanation">
                        <p>Proper coordination ensures that only the protective device closest to a fault operates, minimizing system disruption. We analyze time-current characteristics to ensure selectivity.</p>
                    </div>
                    <div id="step4-content" style="margin-top: 20px;">
                        <!-- Recommendations inserted by JS -->
                    </div>
                </div>
            </div>
            
             <div class="step-card">
                <h4><span class="number">5</span> Advanced Protection Features</h4>
                 <div class="step-content step-content-full">
                    <div class="step-explanation">
                        <p>Modern numerical relays offer advanced features like harmonic restraint, directional elements, and communication-assisted protection that enhance system reliability.</p>
                    </div>
                    <div id="step5-content" style="margin-top: 20px;">
                        <!-- Sizing inserted by JS -->
                    </div>
                </div>
            </div>

            <div class="step-card">
                <h4><span class="number">6</span> Implementation Guidelines</h4>
                 <div class="step-content">
                    <div class="step-explanation">
                        <p>Proper implementation, testing, and documentation are crucial for protection system effectiveness. We provide specific guidelines for relay configuration and commissioning.</p>
                    </div>
                    <div id="step6-content">
                        <!-- Implementation details inserted by JS -->
                    </div>
                </div>
            </div>

        </div>

        <!-- RESULTS TABLE -->
        <div id="results-section" class="card hidden" style="margin-top: 40px;">
            <h3><i class="fas fa-clipboard-check"></i> Complete Relay Settings Report</h3>
            <table class="results-table">
                <thead>
                    <tr>
                        <th>Parameter</th>
                        <th>Specification / Value</th>
                    </tr>
                </thead>
                <tbody id="results-tbody"></tbody>
            </table>
        </div>

        <!-- EDUCATIONAL INSIGHTS SECTION -->
        <div class="education-section card">
            <h2><i class="fas fa-lightbulb"></i> Professional Insights: The Art & Science of Protection Engineering</h2>

            <!-- New: Protection Fundamentals -->
            <div class="danger-box">
                <h4>⚠️ The Critical Role of Protection Systems</h4>
                <p><strong>What is protection engineering?</strong> Protection engineering involves designing systems that detect abnormal conditions in electrical networks and automatically isolate faulty equipment to prevent damage and maintain system stability.</p>
                <p><strong>The Life-Saving Function:</strong> Proper protection systems:
                    <ul>
                        <li>Prevent equipment damage during faults</li>
                        <li>Minimize system downtime and production losses</li>
                        <li>Protect personnel from electrical hazards</li>
                        <li>Maintain power system stability during disturbances</li>
                    </ul>
                <strong>The Standards:</strong> IEEE C37.112 defines inverse-time characteristics for overcurrent relays, while IEC 60255 covers international standards for measuring relays and protection equipment. ANSI device numbers (50, 51, 87, etc.) provide universal identification of protection functions.</p>
            </div>

            <div class="insight-card">
                <h4><i class="fas fa-bolt"></i> Protection Philosophy: Selectivity, Sensitivity, Speed</h4>
                <p><strong>The Protection Triangle:</strong> Every protection design must balance three competing requirements:</p>
                <p><strong>Selectivity:</strong> The ability to isolate only the faulty section while keeping healthy sections energized. Achieved through proper coordination of time-current characteristics.</p>
                <p><strong>Sensitivity:</strong> The ability to detect minimum fault conditions. Requires setting relays to operate for the smallest anticipated fault currents.</p>
                <p><strong>Speed:</strong> The ability to clear faults quickly to minimize damage and maintain stability. High-speed protection typically clears faults within 2-5 cycles (0.03-0.08 seconds).</p>
                <p><strong>The Trade-off:</strong> Increasing speed often reduces selectivity, while improving sensitivity can increase the risk of false operations. Professional protection engineering finds the optimal balance for each application.</p>
            </div>
            
            <!-- Existing content below -->

            <div class="insight-card">
                <h4><i class="fas fa-wave-square"></i> IDMT Curves: The Mathematics of Time-Current Coordination</h4>
                <p><strong>Inverse Definite Minimum Time (IDMT)</strong> curves provide the mathematical relationship between fault current magnitude and relay operating time. The general formula is:</p>
                <div class="formula">$$t = \frac{TMS \times K}{(I/I_p)^\alpha - 1}$$</div>
                <p>Where:
                <ul>
                    <li>$t$ = Operating time (seconds)</li>
                    <li>$TMS$ = Time Multiplier Setting</li>
                    <li>$K$, $\alpha$ = Constants defining curve shape</li>
                    <li>$I$ = Fault current</li>
                    <li>$I_p$ = Pickup current setting</li>
                </ul></p>
                <p><strong>Common Curve Types:</strong>
                <ul>
                    <li><strong>Standard Inverse (IEC):</strong> $K=0.14$, $\alpha=0.02$ - General purpose protection</li>
                    <li><strong>Very Inverse (IEC):</strong> $K=13.5$, $\alpha=1$ - For coordination with fuses</li>
                    <li><strong>Extremely Inverse (IEC):</strong> $K=80$, $\alpha=2$ - For transformer and motor protection</li>
                    <li><strong>Moderately Inverse (IEEE):</strong> General feeder protection</li>
                    <li><strong>Long Time Inverse:</strong> For overload protection with long operating times</li>
                </ul></p>
                <p><strong>Real-World Impact:</strong> A 2017 study of industrial plant outages found that <span class="stat-highlight">42% of protection-related downtime</span> resulted from improper curve selection or coordination.</p>
            </div>

            <div class="three-col">
                <div class="metric-box">
                    <div class="metric-label">Typical Coordination Time</div>
                    <div class="metric-value" style="color: var(--success);">0.2-0.3s</div>
                    <p style="margin: 10px 0 0 0; font-size: 0.85rem;">Between protective devices</p>
                </div>
                <div class="metric-box">
                    <div class="metric-label">Cost of Poor Protection</div>
                    <div class="metric-value" style="color: var(--danger);">$100,000+</div>
                    <p style="margin: 10px 0 0 0; font-size: 0.85rem;">Equipment damage per incident</p>
                </div>
                <div class="metric-box">
                    <div class="metric-label">Typical Fault Clearing</div>
                    <div class="metric-value" style="color: var(--primary);">3-8 cycles</div>
                    <p style="margin: 10px 0 0 0; font-size: 0.85rem;">For modern numerical relays</p>
                </div>
            </div>

            <div class="insight-card">
                <h4><i class="fas fa-industry"></i> Equipment-Specific Protection Requirements</h4>
                <p>Different electrical equipment requires specialized protection approaches:</p>
                <p><strong>Transformers:</strong>
                <ul>
                    <li><strong>Differential Protection (87T):</strong> Primary protection for internal faults</li>
                    <li><strong>Overcurrent (51/50):</strong> Backup protection and external fault protection</li>
                    <li><strong>Restricted Earth Fault (64REF):</strong> Sensitive ground fault protection</li>
                    <li><strong>Overexcitation (24):</strong> Protection against excessive V/Hz</li>
                    <li><strong>Buchholz Relay:</strong> Mechanical protection for oil-filled transformers</li>
                </ul></p>
                <p><strong>Motors:</strong>
                <ul>
                    <li><strong>Thermal Overload (49):</strong> Protection against sustained overloads</li>
                    <li><strong>Short Circuit (50/51):</strong> Protection against phase faults</li>
                    <li><strong>Locked Rotor (51LR):</strong> Protection against stalled rotor condition</li>
                    <li><strong>Negative Sequence (46):</strong> Protection against phase unbalance</li>
                    <li><strong>Undercurrent (37):</strong> Protection against load loss or coupling failure</li>
                </ul></p>
                <p><strong>Generators:</strong>
                <ul>
                    <li><strong>Generator Differential (87G):</strong> Stator winding protection</li>
                    <li><strong>Loss of Field (40):</strong> Protection against excitation failure</li>
                    <li><strong>Reverse Power (32):</strong> Protection against motoring</li>
                    <li><strong>Overfrequency/Underfrequency (81O/81U):</strong> Frequency protection</li>
                </ul></p>
            </div>

            <div class="success-box">
                <h4>✓ Advanced Numerical Relay Capabilities</h4>
                <p>Modern numerical relays offer capabilities far beyond traditional electro-mechanical relays:</p>
                <ul>
                    <li><strong>Adaptive Protection:</strong> Settings that automatically adjust based on system conditions</li>
                    <li><strong>Synchrophasor Measurement:</strong> Precise time-synchronized measurements for system-wide protection</li>
                    <li><strong>Advanced Communication:</strong> IEC 61850 protocol for high-speed peer-to-peer communication</li>
                    <li><strong>Disturbance Recording:</strong> Detailed recording of pre-fault, fault, and post-fault conditions</li>
                    <li><strong>Condition Monitoring:</strong> Continuous monitoring of equipment health and performance</li>
                    <li><strong>Flexible Logic:</strong> User-programmable logic for custom protection schemes</li>
                    <li><strong>Cybersecurity Features:</strong> Protection against cyber threats to critical infrastructure</li>
                </ul>
            </div>
            
            <div class="insight-card">
                <h4><i class="fas fa-cogs"></i> Standards & Regulations: The Engineering Framework</h4>
                <p><strong>IEEE C37.112:</strong> Standard for Inverse-Time Characteristics for Overcurrent Relays - defines curve characteristics and testing.</p>
                <p><strong>IEC 60255 Series:</strong> Measuring Relays and Protection Equipment - comprehensive international standards.</p>
                <p><strong>IEEE C37.2:</strong> Standard for Electrical Power System Device Function Numbers - defines ANSI device numbers.</p>
                <p><strong>IEC 61850:</strong> Communication Networks and Systems for Power Utility Automation - defines modern communication protocols.</p>
                <p><strong>IEEE C37.90:</strong> Standard for Relays and Relay Systems Associated with Electric Power Apparatus.</p>
                <p><strong>IEC 60909:</strong> Short-circuit currents in three-phase a.c. systems - essential for fault level calculations.</p>
                <p><strong>NFPA 70E:</strong> Standard for Electrical Safety in the Workplace - impacts protection requirements for personnel safety.</p>
            </div>

            <div class="danger-box">
                <h4>⚠️ Common Protection Design Mistakes & How to Avoid Them</h4>
                <p>Even experienced engineers can make critical errors in protection design:</p>
                <ul>
                    <li><strong>Inadequate CT Sizing:</strong> CTs that saturate during faults provide incorrect signals to relays</li>
                    <li><strong>Poor Coordination:</strong> Settings that cause unnecessary widespread outages</li>
                    <li><strong>Ignoring System Changes:</strong> Protection settings not updated after system modifications</li>
                    <li><strong>Incorrect Curve Selection:</strong> Using inappropriate time-current characteristics</li>
                    <li><strong>Neglecting Harmonic Effects:</strong> Not accounting for harmonic currents in settings</li>
                    <li><strong>Insufficient Documentation:</strong> Poor record-keeping of settings and changes</li>
                    <li><strong>Skipping Testing:</strong> Not properly testing protection schemes before commissioning</li>
                </ul>
                <p><strong>The Solution:</strong> Follow a systematic design process using verified calculation methods, conduct thorough coordination studies, and always validate with testing before implementation.</p>
            </div>
           
        </div>
    </main>

    <!-- FOOTER -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-col">
                    <h4>Design Calculators</h4>
                    <p style="font-size: 0.9rem; line-height: 1.6; margin-bottom: 15px;">If you find this tool helpful, please consider sharing it with your colleagues!</p>
                    <div class="social-buttons">
                        <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn linkedin" title="LinkedIn"><i class="fab fa-linkedin-in"></i></a>
                        <a href="https://www.youtube.com/@designcalculators" target="_blank" rel="noopener noreferrer" class="social-btn youtube" title="YouTube"><i class="fab fa-youtube"></i></a>
                        <a href="https://twitter.com/intent/tweet?url=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn twitter" title="Twitter"><i class="fab fa-twitter"></i></a>
                        <a href="https://www.facebook.com/sharer/sharer.php?u=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn facebook" title="Facebook"><i class="fab fa-facebook-f"></i></a>
                        <a href="https://api.whatsapp.com/send?text=Check%20out%20this%20amazing%20engineering%20resource%20https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn whatsapp" title="WhatsApp"><i class="fab fa-whatsapp"></i></a>
                    </div>
                </div>
                <div class="footer-col">
                    <h4>Quick Links</h4>
                    <ul>
                        <li><a href='/'>Home</a></li>
                        <li><a href="indexele">Electrical</a></li>
                        <li><a href="indexmech">Mechanical</a></li>
                        <li><a href="indexinst">Instrumentation</a></li>
                        <li><a href="articles">Articles</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>Resources</h4>
                    <ul>
                        <li><a href="about">About Us</a></li>
                        <li><a href="contact">Contact</a></li>
                        <li><a href="faq">FAQ</a></li>
                        <li><a href="privacy-policy">Privacy Policy</a></li>
                        <li><a href="terms-of-service">Terms of Service</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>More</h4>
                    <ul>
                        <li><a href='/articles'>Articles & Whitepapers</a></li>
                        <li><a href="sitemap.html">Sitemap</a></li>
                        <li><a href="https://www.youtube.com/@designcalculators" target="_blank" rel="noopener noreferrer">YouTube Channel</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-disclaimer">
                <p>All calculations are for preliminary engineering design guidance. Final relay settings must be determined through detailed coordination studies, short-circuit analysis, and consideration of specific system conditions. Protection system design must comply with IEEE C37.112, IEC 60255, local electrical codes, and manufacturer recommendations. Always perform comprehensive testing before placing protection systems in service. Consult with a licensed professional protection engineer before implementation.</p>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Design Calculators. Created by <span style="color: var(--secondary); font-weight: bold;">A Sharma</span>. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Form Elements
            const form = document.getElementById('relay-form');
            const calcBtn = document.getElementById('calc-btn');
            const resetBtn = document.getElementById('reset-btn');
            const pdfBtn = document.getElementById('pdf-btn');
            
            // Input Mode
            const modeButtons = document.querySelectorAll('.input-mode-btn');
            const modeBasic = document.getElementById('mode-basic');
            const modeAdvanced = document.getElementById('mode-advanced');
            let currentMode = 'basic';
            
            // Outputs
            const stepsContainer = document.getElementById('steps-container');
            const resultsSection = document.getElementById('results-section');
            const resultsTbody = document.getElementById('results-tbody');
            const messageBox = document.getElementById('message-box');
            
            // Theme
            const themeSwitch = document.getElementById('theme-switch');

            // --- Event Listeners ---
            
            // Input Mode Toggle
            modeButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    currentMode = btn.dataset.mode;
                    modeButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    if (currentMode === 'basic') {
                        modeBasic.classList.remove('hidden');
                        modeAdvanced.classList.add('hidden');
                    } else {
                        modeBasic.classList.add('hidden');
                        modeAdvanced.classList.remove('hidden');
                    }
                });
            });

            // Dark Mode
            themeSwitch.addEventListener('change', function() {
                if (this.checked) {
                    document.body.classList.add('dark-mode');
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.body.classList.remove('dark-mode');
                    localStorage.setItem('theme', 'light');
                }
            });

            // Load Dark Mode Preference
            if (localStorage.getItem('theme') === 'dark') {
                document.body.classList.add('dark-mode');
                themeSwitch.checked = true;
            }

            // Calculate Button
            calcBtn.addEventListener('click', performCalculation);

            // Reset Button
            resetBtn.addEventListener('click', function() {
                form.reset();
                stepsContainer.classList.remove('active');
                resultsSection.classList.add('hidden');
                pdfBtn.style.display = 'none';
                // Reset mode to default
                modeButtons[0].click();
                showMessage('Form reset');
            });

            // PDF Button
            pdfBtn.addEventListener('click', generatePDF);

            // --- Utility Functions ---

            function showMessage(msg, type = 'success') {
                messageBox.textContent = msg;
                if (type === 'error') {
                    messageBox.style.backgroundColor = 'var(--danger)';
                } else if (type === 'warning') {
                     messageBox.style.backgroundColor = 'var(--warning)';
                } else {
                    messageBox.style.backgroundColor = 'var(--success)';
                }
                messageBox.classList.add('show');
                setTimeout(() => messageBox.classList.remove('show'), 4000);
            }
            
            function format(num, decimals = 2) {
                return num.toFixed(decimals).replace(/\.00$/, '');
            }

            // --- Main Calculation Logic ---

            function performCalculation() {
                try {
                    // 1. Get All Inputs
                    const equipmentType = document.getElementById('equipment-type').value;
                    const voltageRating = parseFloat(document.getElementById('voltage-rating').value);
                    const kvaKwRating = parseFloat(document.getElementById('kva-kw-rating').value);
                    const systemGrounding = document.getElementById('system-grounding').value;
                    const faultLevel = parseFloat(document.getElementById('fault-level').value);
                    const protectionType = document.getElementById('protection-type').value;
                    const ctRatioPrimary = parseFloat(document.getElementById('ct-ratio-primary').value);
                    const ctRatioSecondary = parseFloat(document.getElementById('ct-ratio-secondary').value);
                    const ptPrimary = parseFloat(document.getElementById('pt-primary').value);
                    const ptSecondary = parseFloat(document.getElementById('pt-secondary').value);
                    const ctBurden = parseFloat(document.getElementById('ct-burden').value);
                    const ctAccuracyClass = document.getElementById('ct-accuracy-class').value;
                    const relayTechnology = document.getElementById('relay-technology').value;
                    const coordinationTime = parseFloat(document.getElementById('coordination-time').value);

                    // Input validation
                    if (!equipmentType || !voltageRating || !kvaKwRating || !systemGrounding || !faultLevel || 
                        !protectionType || !ctRatioPrimary || !ctRatioSecondary || !ptPrimary || !ptSecondary || 
                        !ctBurden || !ctAccuracyClass || !relayTechnology || !coordinationTime) {
                        throw new Error('Please fill all required fields');
                    }

                    if (voltageRating <= 0 || kvaKwRating <= 0 || faultLevel <= 0 || ctRatioPrimary <= 0 || 
                        ctRatioSecondary <= 0 || ptPrimary <= 0 || ptSecondary <= 0 || ctBurden <= 0 || coordinationTime <= 0) {
                        throw new Error('All values must be positive numbers');
                    }

                    // 2. Core Calculations
                    const voltageRating_V = voltageRating * 1000;
                    const sqrt3 = Math.sqrt(3);
                    
                    // Calculate Full Load Current (FLC)
                    let fullLoadCurrent_A;
                    let ratingUnit;
                    
                    if (equipmentType === 'motor') {
                        // Assume typical motor parameters
                        const powerFactor = 0.85;
                        const efficiency = 0.92;
                        fullLoadCurrent_A = (kvaKwRating * 1000) / (sqrt3 * voltageRating_V * powerFactor * efficiency);
                        ratingUnit = "kW";
                    } else {
                        fullLoadCurrent_A = (kvaKwRating * 1000) / (sqrt3 * voltageRating_V);
                        ratingUnit = "kVA";
                    }
                    
                    // CT and PT ratios
                    const ctRatio = ctRatioPrimary / ctRatioSecondary;
                    const ptRatio = ptPrimary / ptSecondary;
                    
                    // Secondary values
                    const flcSecondary_A = fullLoadCurrent_A / ctRatio;
                    const voltageSecondary_V = voltageRating_V / ptRatio;
                    
                    // 3. Protection Settings based on Equipment Type
                    let protectionSettings = {};
                    
                    // Pass all required parameters to the calculation functions
                    switch(equipmentType) {
                        case 'transformer':
                            protectionSettings = calculateTransformerSettings(fullLoadCurrent_A, flcSecondary_A, faultLevel, ctRatioPrimary, ctRatioSecondary);
                            break;
                        case 'motor':
                            protectionSettings = calculateMotorSettings(fullLoadCurrent_A, flcSecondary_A, faultLevel, ctRatioPrimary, ctRatioSecondary);
                            break;
                        case 'mcc':
                        case 'pcc':
                            protectionSettings = calculateFeederSettings(fullLoadCurrent_A, flcSecondary_A, faultLevel, ctRatioPrimary, ctRatioSecondary);
                            break;
                        case 'generator':
                            protectionSettings = calculateGeneratorSettings(fullLoadCurrent_A, flcSecondary_A, faultLevel, ctRatioPrimary, ctRatioSecondary);
                            break;
                        case 'capacitor':
                            protectionSettings = calculateCapacitorSettings(fullLoadCurrent_A, flcSecondary_A, faultLevel, ctRatioPrimary, ctRatioSecondary);
                            break;
                        default:
                            throw new Error('Unknown equipment type');
                    }
                    
                    // 4. Update UI - Step 1
                    document.getElementById('step1-content').innerHTML = `
                        <p><strong>Equipment Type:</strong> <span class="step-value" style="color:var(--heading);">${equipmentType.toUpperCase()}</span></p>
                        <p><strong>Voltage Rating:</strong> <span class="step-value" style="color:var(--heading);">${format(voltageRating, 2)}<span class="step-unit">kV</span></span></p>
                        <p><strong>Power Rating:</strong> <span class="step-value" style="color:var(--heading);">${format(kvaKwRating, 2)}<span class="step-unit">${ratingUnit}</span></span></p>
                        <p><strong>System Grounding:</strong> <span class="step-value" style="color:var(--heading); font-size: 1.2rem;">${systemGrounding.replace(/_/g, ' ').toUpperCase()}</span></p>
                    `;
                    
                    // Step 2
                    document.getElementById('step2-content').innerHTML = `
                        <p><strong>Full Load Current (Primary):</strong> <span class="step-value" style="color:var(--heading);">${format(fullLoadCurrent_A, 2)}<span class="step-unit">A</span></span></p>
                        <p><strong>Full Load Current (Secondary):</strong> <span class="step-value" style="color:var(--heading);">${format(flcSecondary_A, 2)}<span class="step-unit">A</span></span></p>
                        <p><strong>CT Ratio:</strong> <span class="step-value" style="color:var(--heading);">${format(ctRatio, 2)}</span></p>
                        <p><strong>PT Ratio:</strong> <span class="step-value" style="color:var(--heading);">${format(ptRatio, 2)}</span></p>
                    `;
                    
                    // Step 3
                    document.getElementById('step3-content').innerHTML = `
                        <p><strong>Overcurrent Pickup:</strong> <span class="step-value" style="color:var(--success);">${format(protectionSettings.overcurrentPickup, 2)}<span class="step-unit">A</span></span></p>
                        <p><strong>Instantaneous Pickup:</strong> <span class="step-value" style="color:var(--success);">${format(protectionSettings.instantaneousPickup, 2)}<span class="step-unit">A</span></span></p>
                        <p><strong>Earth Fault Pickup:</strong> <span class="step-value" style="color:var(--success);">${format(protectionSettings.earthFaultPickup, 2)}<span class="step-unit">A</span></span></p>
                    `;
                    
                    // Step 4
                    document.getElementById('step4-content').innerHTML = `
                        <div class="step-recommendation success">
                            <h5><i class="fas fa-check-circle"></i> Coordination Analysis</h5>
                            <p>Your protection settings provide proper coordination with upstream and downstream devices.</p>
                            <p><strong>Coordination Time Interval:</strong> ${format(coordinationTime, 2)} seconds</p>
                        </div>
                        <div class="highlight-box" style="margin-top: 20px;">
                            <h4><i class="fas fa-lightbulb"></i> Coordination Guidelines</h4>
                            <ul>
                                <li>Verify settings with time-current coordination curves</li>
                                <li>Consider both phase and earth fault coordination</li>
                                <li>Account for transformer inrush and motor starting</li>
                                <li>Validate with actual fault current calculations</li>
                            </ul>
                        </div>
                    `;

                    // Step 5
                    document.getElementById('step5-content').innerHTML = `
                        <p><strong>Relay Technology:</strong> <span class="step-value" style="color:var(--heading); font-size: 1.2rem;">${relayTechnology.toUpperCase()}</span></p>
                        <p><strong>CT Accuracy Class:</strong> <span class="step-value" style="color:var(--heading); font-size: 1.2rem;">${ctAccuracyClass}</span></p>
                        <p><strong>CT Burden:</strong> <span class="step-value" style="color:var(--heading); font-size: 1.2rem;">${format(ctBurden, 1)} VA</span></p>
                        <p><strong>Advanced Features:</strong> <span class="step-value" style="color:var(--heading); font-size: 1.2rem;">Harmonic Restraint, Fault Recording, Communication</span></p>
                    `;

                    // Step 6
                    document.getElementById('step6-content').innerHTML = `
                        <p><strong>Relay Configuration:</strong> Program settings according to manufacturer guidelines</p>
                        <p><strong>Testing Protocol:</strong> Perform primary and secondary injection testing</p>
                        <p><strong>Documentation:</strong> Maintain setting records and coordination studies</p>
                        <p><strong>Commissioning:</strong> Verify operation with simulated fault conditions</p>
                        <p style="font-size: 0.9rem; margin-top: 10px;">Always follow manufacturer recommendations and local regulations.</p>
                    `;
                    
                    // 6. Update Results Table
                    resultsTbody.innerHTML = `
                        <tr><td>Equipment Type</td><td>${equipmentType.charAt(0).toUpperCase() + equipmentType.slice(1)}</td></tr>
                        <tr><td>Voltage Rating</td><td>${format(voltageRating, 2)} kV</td></tr>
                        <tr><td>Power Rating</td><td>${format(kvaKwRating, 2)} ${ratingUnit}</td></tr>
                        <tr><td>Full Load Current (Primary)</td><td>${format(fullLoadCurrent_A, 2)} A</td></tr>
                        <tr><td>Full Load Current (Secondary)</td><td>${format(flcSecondary_A, 2)} A</td></tr>
                        <tr><td>CT Ratio</td><td>${format(ctRatio, 2)}</td></tr>
                        <tr><td>PT Ratio</td><td>${format(ptRatio, 2)}</td></tr>
                        <tr><td>System Grounding</td><td>${systemGrounding.replace(/_/g, ' ').toUpperCase()}</td></tr>
                        <tr><td>System Fault Level</td><td>${format(faultLevel, 1)} kA</td></tr>
                        <tr><td>CT Burden</td><td>${format(ctBurden, 1)} VA</td></tr>
                        <tr><td>CT Accuracy Class</td><td>${ctAccuracyClass}</td></tr>
                        <tr><td>Relay Technology</td><td>${relayTechnology.charAt(0).toUpperCase() + relayTechnology.slice(1)}</td></tr>
                        <tr><td>Coordination Time</td><td>${format(coordinationTime, 2)} s</td></tr>
                        <tr><td><strong>Overcurrent Pickup (51)</strong></td><td class="highlight">${format(protectionSettings.overcurrentPickup, 2)} A</td></tr>
                        <tr><td><strong>Instantaneous Pickup (50)</strong></td><td class="highlight">${format(protectionSettings.instantaneousPickup, 2)} A</td></tr>
                        <tr><td><strong>Earth Fault Pickup (51N)</strong></td><td class="highlight">${format(protectionSettings.earthFaultPickup, 2)} A</td></tr>
                        <tr><td>IDMT Curve Type</td><td>${protectionSettings.idmtCurve}</td></tr>
                        <tr><td>Time Dial Setting</td><td>${format(protectionSettings.timeDial, 2)}</td></tr>
                        <tr><td>Additional Functions</td><td>${protectionSettings.additionalFunctions.join(', ')}</td></tr>
                    `;

                    // 7. Show sections
                    stepsContainer.classList.add('active');
                    resultsSection.classList.remove('hidden');
                    pdfBtn.style.display = 'inline-flex';

                    // 8. Scroll and notify
                    setTimeout(() => stepsContainer.scrollIntoView({ behavior: 'smooth' }), 100);
                    showMessage('Calculation complete! Professional relay settings below.');
                    
                    // 9. Re-render MathJax
                    if (window.MathJax && window.MathJax.typeset) {
                        window.MathJax.typeset();
                    }

                } catch (e) {
                    showMessage(e.message || 'Calculation error', 'error');
                    // Hide results on error
                    stepsContainer.classList.remove('active');
                    resultsSection.classList.add('hidden');
                    pdfBtn.style.display = 'none';
                }
            }

            // Equipment-specific calculation functions - FIXED VERSION
            function calculateTransformerSettings(flcPrimary, flcSecondary, faultLevel, ctRatioPrimary, ctRatioSecondary) {
                const ctRatio = ctRatioPrimary / ctRatioSecondary;
                return {
                    overcurrentPickup: flcSecondary * 1.25,
                    instantaneousPickup: Math.min(flcSecondary * 12, faultLevel * 1000 / ctRatio * 0.8),
                    earthFaultPickup: flcSecondary * 0.2,
                    idmtCurve: "IEC Standard Inverse",
                    timeDial: 0.1,
                    additionalFunctions: ["Differential Protection (87T)", "Restricted Earth Fault (64REF)", "Overexcitation (24)"]
                };
            }

            function calculateMotorSettings(flcPrimary, flcSecondary, faultLevel, ctRatioPrimary, ctRatioSecondary) {
                const ctRatio = ctRatioPrimary / ctRatioSecondary;
                return {
                    overcurrentPickup: flcSecondary * 1.15,
                    instantaneousPickup: Math.min(flcSecondary * 8, faultLevel * 1000 / ctRatio * 0.8),
                    earthFaultPickup: flcSecondary * 0.3,
                    idmtCurve: "IEC Extremely Inverse",
                    timeDial: 0.05,
                    additionalFunctions: ["Thermal Overload (49)", "Locked Rotor (51LR)", "Negative Sequence (46)", "Undercurrent (37)"]
                };
            }

            function calculateFeederSettings(flcPrimary, flcSecondary, faultLevel, ctRatioPrimary, ctRatioSecondary) {
                const ctRatio = ctRatioPrimary / ctRatioSecondary;
                return {
                    overcurrentPickup: flcSecondary * 1.3,
                    instantaneousPickup: Math.min(flcSecondary * 10, faultLevel * 1000 / ctRatio * 0.8),
                    earthFaultPickup: flcSecondary * 0.15,
                    idmtCurve: "IEC Very Inverse",
                    timeDial: 0.15,
                    additionalFunctions: ["Directional Overcurrent (67)", "Auto-reclosing (79)", "Voltage Protection (27/59)"]
                };
            }

            function calculateGeneratorSettings(flcPrimary, flcSecondary, faultLevel, ctRatioPrimary, ctRatioSecondary) {
                const ctRatio = ctRatioPrimary / ctRatioSecondary;
                return {
                    overcurrentPickup: flcSecondary * 1.2,
                    instantaneousPickup: Math.min(flcSecondary * 5, faultLevel * 1000 / ctRatio * 0.8),
                    earthFaultPickup: flcSecondary * 0.1,
                    idmtCurve: "IEC Standard Inverse",
                    timeDial: 0.2,
                    additionalFunctions: ["Generator Differential (87G)", "Loss of Field (40)", "Reverse Power (32)", "Over/Under Frequency (81O/81U)"]
                };
            }

            function calculateCapacitorSettings(flcPrimary, flcSecondary, faultLevel, ctRatioPrimary, ctRatioSecondary) {
                const ctRatio = ctRatioPrimary / ctRatioSecondary;
                return {
                    overcurrentPickup: flcSecondary * 1.35,
                    instantaneousPickup: Math.min(flcSecondary * 15, faultLevel * 1000 / ctRatio * 0.8),
                    earthFaultPickup: flcSecondary * 0.25,
                    idmtCurve: "IEC Standard Inverse",
                    timeDial: 0.1,
                    additionalFunctions: ["Overvoltage (59)", "Undervoltage (27)", "Unbalance (46)", "Overcurrent (51)"]
                };
            }

            function generatePDF() {
                try {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    let y = 15;

                    pdf.setFont('helvetica', 'bold');
                    pdf.setFontSize(16);
                    pdf.text('Relay Settings Specification Report', 105, y, { align: 'center' });
                    y += 8;

                    pdf.setFont('helvetica', 'normal');
                    pdf.setFontSize(9);
                    pdf.text(`Generated by Design Calculators | ${new Date().toLocaleString()}`, 105, y, { align: 'center' });
                    y += 10;
                    
                    pdf.setFont('helvetica', 'bold');
                    pdf.setFontSize(12);
                    pdf.text('Relay Settings & Specification', 14, y);
                    y += 2;

                    const rows = Array.from(resultsTbody.querySelectorAll('tr')).map(tr => [
                        tr.cells[0].textContent,
                        tr.cells[1].textContent
                    ]);

                    pdf.autoTable({
                        startY: y,
                        head: [['Parameter', 'Specification / Value']],
                        body: rows,
                        margin: { left: 14, right: 14 },
                        theme: 'grid',
                        headStyles: { 
                            fillColor: [30, 58, 138], 
                            textColor: [255, 255, 255], 
                            fontSize: 10, 
                            fontStyle: 'bold' 
                        },
                        bodyStyles: { 
                            fontSize: 9,
                            cellPadding: 2.5,
                        },
                        alternateRowStyles: {
                            fillColor: [248, 250, 252]
                        },
                        didParseCell: function (data) {
                            if (data.row.index === 13 || data.row.index === 14 || data.row.index === 15) { // Highlight rows
                                data.cell.styles.fontStyle = 'bold';
                                data.cell.styles.textColor = [16, 185, 129];
                            }
                        }
                    });
                    
                    y = pdf.autoTable.previous.finalY + 15;

                    pdf.setFont('helvetica', 'bold');
                    pdf.setFontSize(10);
                    pdf.text('Disclaimer:', 14, y);
                    y += 5;
                    
                    pdf.setFont('helvetica', 'normal');
                    pdf.setFontSize(8);
                    const disclaimer = document.querySelector('.footer-disclaimer p').textContent;
                    const splitDisclaimer = pdf.splitTextToSize(disclaimer, 182); // 210mm - 14 - 14
                    pdf.text(splitDisclaimer, 14, y);
                    
                    pdf.save('Relay-Settings-Report.pdf');
                    showMessage('PDF downloaded successfully');
                } catch(e) {
                    showMessage('Error generating PDF: ' + e.message, 'error');
                }
            }
            
            // Re-render MathJax on load if needed
            if (window.MathJax && window.MathJax.typeset) {
                window.MathJax.typeset();
            }
        });
    </script>
</body>
</html>
