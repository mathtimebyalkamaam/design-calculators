<!DOCTYPE html>
<html lang="en">
<head>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5936527763614780"
     crossorigin="anonymous"></script>
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-23Y1V450SR"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-23Y1V450SR');
</script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5936527763614780"
     crossorigin="anonymous"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Breaker Relay Settings Calculator - Design Calculators - Electrical</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="icon" href="/favicon.ico" type="image/x-icon">

    <style>
        /* Basic CSS Variables for a consistent theme */
        :root {
            --primary-color: #4CAF50; /* Green */
            --secondary-color: #45a049; /* Darker Green */
            --accent-color: #FFC107; /* Amber */
            --bg-color: #f4f7f6; /* Light Greyish Green */
            --card-bg: #ffffff; /* White */
            --text-color: #333333; /* Dark Grey */
            --header-bg: #2C3E50; /* Dark Blue Grey */
            --footer-bg: #34495E; /* Slightly Lighter Dark Blue Grey */
            --border-color: #cccccc;
            --card-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            --hover-color: #e2e6ea;
            --button-gradient: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            --button-hover-gradient: linear-gradient(45deg, var(--secondary-color), #3b8e3e);
            --reset-button-bg: #FFC107; /* Yellow for reset */
            --reset-button-hover-bg: #E0A800; /* Darker yellow */
            --clear-button-bg: #007bff; /* Blue for clear */
            --clear-button-hover-bg: #0056b3; /* Darker blue */
            --ok-color: #28a745; /* Green for OK status */
            --error-color: #dc3545; /* Red for error status */
            --warning-color: #ffc107; /* Amber for warnings */
        }

        /* Dark Mode Variables */
        body.dark-mode {
            --bg-color: #2c3e50;
            --card-bg: #34495e;
            --text-color: #ecf0f1;
            --header-bg: #2c3e50;
            --footer-bg: #2c3e50;
            --border-color: #555555;
            --card-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            --hover-color: #446688;
            --button-gradient: linear-gradient(45deg, #3b8e3e, #4CAF50);
            --button-hover-gradient: linear-gradient(45deg, #4CAF50, #5cb85c);
            --reset-button-bg: #FFD700; /* Gold/Yellow for dark mode reset */
            --reset-button-hover-bg: #DAA520; /* Darker gold/yellow */
            --clear-button-bg: #17a2b8; /* Cyan for dark mode clear */
            --clear-button-hover-bg: #138496;
            --ok-color: #5cb85c;
            --error-color: #e74c3c;
            --warning-color: #DAA520;
        }

        /* General Body Styling */
        body {
            font-family: 'Inter', sans-serif; /* Using Inter as specified */
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, var(--bg-color), #e0e0e0);
            color: var(--text-color);
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 960px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: var(--header-bg);
            color: white;
            padding: 20px 0;
            text-align: center;
            box-shadow: var(--card-shadow);
            position: relative; /* For theme toggle positioning */
        }

        header h1 {
            margin: 0;
            font-size: 2.5em;
            color: var(--primary-color);
        }

        header .subtitle {
            margin: 5px 0 0;
            font-size: 1em;
            color: #bdc3c7;
        }

        main {
            padding: 20px 0;
        }

        .tool-container {
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 20px;
            box-shadow: var(--card-shadow);
            margin-bottom: 20px;
            transition: transform 0.3s ease-in-out;
        }

        .tool-container:hover {
            transform: translateY(-5px);
        }

        .tool-container h2 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            margin-top: 0;
            margin-bottom: 20px;
        }

        .tool-description {
            margin-bottom: 20px;
            color: var(--text-color);
        }

        .back-button {
            display: inline-block;
            background-color: var(--primary-color);
            color: white;
            padding: 10px 15px;
            border-radius: 4px;
            text-decoration: none;
            margin-bottom: 20px;
            transition: background-color 0.3s, transform 0.3s;
            width: fit-content; 
        }

        .back-button:hover {
            background-color: var(--secondary-color);
            transform: translateY(-3px);
        }

        /* Theme Toggle */
        .theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
        }

        .theme-toggle .light-icon,
        .theme-toggle .dark-icon {
            color: white;
            margin: 0 5px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
        }

        input:checked + .slider {
            background-color: var(--primary-color);
        }

        input:focus + .slider {
            box-shadow: 0 0 1px var(--primary-color);
        }

        input:checked + .slider:before {
            -webkit-transform: translateX(26px);
            -ms-transform: translateX(26px);
            transform: translateX(26px);
        }

        /* Rounded sliders */
        .slider.round {
            border-radius: 34px;
        }

        .slider.round:before {
            border-radius: 50%;
        }

        /* Footer Styling */
        footer {
            background-color: var(--footer-bg);
            color: white;
            padding: 20px 0;
            text-align: center;
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1);
            margin-top: 30px;
        }

        footer .disclaimer h3,
        footer .social-share h3 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        footer .disclaimer p {
            font-size: 0.9em;
            color: #bdc3c7;
        }

        .social-buttons {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .social-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            color: white;
            text-decoration: none;
            font-size: 1.2em;
            transition: transform 0.3s ease-in-out;
        }

        .social-btn:hover {
            transform: translateY(-3px);
        }

        .social-btn.linkedin { background-color: #0A66C2; }
        .social-btn.facebook { background-color: #1877F2; }
        .social-btn.twitter { background-color: #1DA1F2; }
        .social-btn.whatsapp { background-color: #25D366; }
        .social-btn.reddit { background-color: #FF4500; }

        /* Styles for Calculator Forms and Results */
        .calculator-form {
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: var(--card-shadow);
        }
        
        .form-section {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 25px; /* Space between sections */
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
            opacity: 0; /* Initial state for fade-in animation */
            transform: translateY(10px); /* Initial state for slide-up animation */
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }

        .form-section.fade-in {
            opacity: 1;
            transform: translateY(0);
        }

        .form-section h3 {
            color: var(--secondary-color);
            margin-top: 0;
            margin-bottom: 15px;
            border-bottom: 1px dashed var(--border-color);
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px; /* Default margin for form groups */
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--text-color);
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--card-bg); /* Use card-bg for input background */
            color: var(--text-color);
            box-sizing: border-box; /* Ensure padding doesn't increase width */
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Responsive grid */
            gap: 20px; /* Gap between grid items */
            margin-bottom: 0; /* Handled by form-group margin */
        }
        
        .calculate-btn {
            background: var(--button-gradient);
            color: white;
            border: none;
            padding: 12px 30px; /* Increased padding for better appearance */
            border-radius: 25px; /* More rounded */
            cursor: pointer;
            font-size: 1.1em; /* Slightly larger font */
            font-weight: bold;
            margin-top: 25px; /* More space above button */
            transition: background 0.3s ease-in-out, transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            width: auto; /* Allow button to size based on content and padding */
            min-width: 220px; /* Ensure a minimum width for consistency */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); /* More pronounced shadow */
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }
        
        .calculate-btn:hover {
            background: var(--button-hover-gradient);
            transform: translateY(-5px) scale(1.02); /* Lift and slightly scale */
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3); /* Deeper shadow on hover */
        }

        .reset-btn {
            background-color: var(--reset-button-bg);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            margin-top: 25px;
            margin-left: 15px; /* Space from calculate button */
            transition: background-color 0.3s ease-in-out, transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            width: auto;
            min-width: 150px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .reset-btn:hover {
            background-color: var(--reset-button-hover-bg);
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .clear-results-btn {
            background-color: var(--clear-button-bg);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
            margin-top: 15px;
            transition: background-color 0.3s ease-in-out, transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .clear-results-btn:hover {
            background-color: var(--clear-button-hover-bg);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .result-container {
            margin-top: 30px;
            padding: 20px;
            border-radius: 8px;
            background-color: var(--card-bg);
            box-shadow: var(--card-shadow);
            display: none; /* Hidden by default */
            opacity: 0; /* For animation */
            transform: translateY(20px); /* Initial state for animation */
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }
        
        .result-container.show {
            opacity: 1;
            transform: translateY(0);
        }

        .result-container h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            text-align: center;
        }
        
        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            border-radius: 8px;
            overflow: hidden; /* Ensures rounded corners apply to table content */
        }
        
        .result-table th, .result-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.3s;
        }
        
        .result-table th {
            background-color: var(--hover-color);
            font-weight: bold;
            color: var(--secondary-color);
        }

        .result-table tr:last-child td {
            border-bottom: none; /* No border for the last row */
        }

        .result-table tbody tr:hover {
            background-color: var(--hover-color); /* Highlight row on hover */
        }
        
        .standard-reference {
            margin-top: 20px;
            font-style: italic;
            font-size: 0.9rem;
            color: var(--text-color);
            padding: 10px;
            border-left: 4px solid var(--primary-color);
            background-color: var(--hover-color);
            border-radius: 4px;
        }
        
        .info-icon {
            color: var(--primary-color);
            margin-left: 5px;
            cursor: help;
            transition: color 0.3s;
        }

        .info-icon:hover {
            color: var(--accent-color);
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px; /* Increased padding */
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            transform: translateY(10px); /* Initial state for tooltip animation */
            font-size: 0.85em;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
            transform: translateY(0);
        }

        /* Custom message box style */
        #custom-message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            font-weight: bold;
            color: white;
            opacity: 0;
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            display: flex; /* Use flex for centering text */
            align-items: center;
            justify-content: center;
            min-width: 250px;
        }

        /* Styles for calculation details */
        #calculation-details {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px; /* More rounded */
            padding: 20px; /* Increased padding */
            margin-bottom: 25px; /* More space */
            font-size: 0.95em;
            color: var(--text-color);
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05); /* Subtle inner shadow */
        }
        #calculation-details h4 {
            color: var(--secondary-color);
            margin-top: 0;
            margin-bottom: 15px; /* More space */
            text-align: center;
            font-size: 1.2em;
        }
        #calculation-details p.formula {
            font-family: 'Times New Roman', serif; /* A font suitable for mathematical formulas */
            font-style: italic;
            font-size: 1.1em;
            text-align: center;
            padding: 12px 10px; /* Increased padding */
            background-color: var(--hover-color);
            border-radius: 6px; /* More rounded */
            margin: 15px 0; /* More space */
            overflow-x: auto; /* Allow horizontal scrolling for long formulas */
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        #calculation-details p.calculation-step {
            font-family: 'Courier New', monospace; /* Monospace for steps */
            background-color: var(--hover-color);
            padding: 8px 15px; /* Increased padding */
            border-radius: 4px; /* More rounded */
            margin-bottom: 8px; /* More space */
            color: var(--text-color);
            white-space: pre-wrap; /* Preserve whitespace and wrap text */
            word-break: break-word; /* Break long words */
        }
        #calculation-details ul {
            list-style-type: disc;
            margin-left: 25px; /* Increased margin */
            padding-left: 0;
            margin-top: 15px;
        }
        #calculation-details ul li {
            margin-bottom: 8px; /* More space */
            color: var(--text-color);
        }

        /* Style for centering the button */
        .button-wrapper {
            display: flex;
            justify-content: center; /* Center the button horizontally */
            width: 100%; /* Ensure it takes full width to center effectively */
            padding-top: 20px; /* Add more spacing above the button */
        }

        /* Animation for input fields on focus */
        .form-group input:focus, .form-group select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(76, 175, 80, 0.4); /* Green glow, slightly more pronounced */
            outline: none;
            animation: pulse 0.8s infinite alternate;
        }

        @keyframes pulse {
            from {
                box-shadow: 0 0 0 4px rgba(76, 175, 80, 0.4);
            }
            to {
                box-shadow: 0 0 0 8px rgba(76, 175, 80, 0.2); /* Softer pulse */
            }
        }
        /* Specific styles for Relay Settings Calculator */
        #motor-specific-inputs, #transformer-specific-inputs, #advanced-relay-inputs {
            display: none; /* Hidden by default */
        }

        #relay-guidance-section {
            display: none; /* Hidden by default */
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 25px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }
        #relay-guidance-section.fade-in {
            opacity: 1;
            transform: translateY(0);
        }
        #relay-guidance-section h3 {
            color: var(--secondary-color);
            margin-top: 0;
            margin-bottom: 15px;
            border-bottom: 1px dashed var(--border-color);
            padding-bottom: 10px;
        }
        #relay-guidance-section p, #relay-guidance-section ul {
            font-size: 0.9em;
            color: var(--text-color);
        }
        #relay-guidance-section ul {
            list-style-type: disc;
            margin-left: 20px;
            margin-bottom: 10px;
        }
        #relay-guidance-section strong {
            color: var(--primary-color);
        }

        /* Responsive adjustments for smaller screens */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            header h1 {
                font-size: 2em;
            }

            .form-row {
                grid-template-columns: 1fr; /* Stack columns on small screens */
            }

            .calculate-btn, .reset-btn {
                width: 100%;
                margin-left: 0;
                margin-top: 15px;
            }

            .button-wrapper {
                flex-direction: column; /* Stack buttons vertically */
                align-items: center; /* Center stacked buttons */
            }

            .theme-toggle {
                position: static; /* Remove absolute positioning on small screens */
                justify-content: center;
                margin-top: 10px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>Design Calculators - Electrical</h1>
            <p class="subtitle">Smart Tools for Modern Electrical Engineers</p>
            <div class="theme-toggle">
                <span class="light-icon"><i class="fas fa-sun"></i></span>
                <label class="switch">
                    <input type="checkbox" id="theme-switch">
                    <span class="slider round"></span>
                </label>
                <span class="dark-icon"><i class="fas fa-moon"></i></span>
            </div>
        </div>
    </header>

    <main class="container">
        <div style="display: flex; justify-content: center; margin-bottom: 20px;">
            <a href="indexEle.html" class="back-button"><i class="fas fa-arrow-left"></i> Back to Tools</a>
        </div>
        
        <div class="tool-container">
            <h2>Breaker Relay Settings Calculator</h2>
            
            <div class="tool-description">
                <p>This calculator provides guidance for setting protective relays for various electrical equipment, including transformers, Motor Control Centers (MCC), Power Control Centers (PCC), and motors. It aligns with common practices and standards from IEEE and IEC, assisting engineers in preliminary relay coordination.</p>
                <p style="font-weight: bold; color: var(--error-color);">Disclaimer: This tool provides preliminary settings for guidance only. Actual relay coordination requires a detailed system study, short-circuit analysis, and specialized software to ensure proper protection and selectivity. Always consult relevant standards and qualified engineers for final settings.</p>
            </div>
        
            <div class="calculator-form">
                <form id="relay-settings-form">
                    <!-- Equipment Details -->
                    <div class="form-section">
                        <h3>Equipment Details</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="equipment-type">Equipment Type <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Select the type of electrical equipment for which relay settings are needed.</span></span></label>
                                <select id="equipment-type" required>
                                    <option value="transformer">Transformer</option>
                                    <option value="motor">Motor</option>
                                    <option value="mcc">MCC Feeder</option>
                                    <option value="pcc">PCC Feeder</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="voltage-rating">Voltage Rating (kV) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Nominal line-to-line voltage of the equipment (in kilovolts). Range: 0.415 kV to 220 kV.</span></span></label>
                                <input type="number" id="voltage-rating" step="0.001" min="0.415" max="220" value="11" required>
                            </div>
                            <div class="form-group">
                                <label for="kva-kw-rating">Rating (kVA / kW) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Power rating of the equipment. Use kVA for transformers, MCC/PCC feeders, and kW for motors.</span></span></label>
                                <input type="number" id="kva-kw-rating" step="0.1" value="1000" required>
                            </div>
                            <div class="form-group">
                                <label for="system-grounding">System Grounding Type <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Type of grounding for the electrical system. Important for earth fault settings.</span></span></label>
                                <select id="system-grounding" required>
                                    <option value="solidly_grounded">Solidly Grounded</option>
                                    <option value="resistance_grounded">Resistance Grounded</option>
                                    <option value="ungrounded">Ungrounded</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="pt-primary">Potential Transformer (PT) Primary (V) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Primary voltage rating of the PT.</span></span></label>
                                <input type="number" id="pt-primary" step="1" value="11000" required>
                            </div>
                            <div class="form-group">
                                <label for="pt-secondary">Potential Transformer (PT) Secondary (V) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Secondary voltage rating of the PT (typically 110V or 120V).</span></span></label>
                                <input type="number" id="pt-secondary" step="1" value="110" required>
                            </div>
                        </div>
                    </div>

                    <!-- CT Details (General) -->
                    <div class="form-section" id="general-ct-inputs">
                        <h3>Current Transformer (CT) Details</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="ct-ratio-primary">CT Primary (A) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Primary rating of the Current Transformer (e.g., 400 for 400/5).</span></span></label>
                                <input type="number" id="ct-ratio-primary" step="1" value="400" required>
                            </div>
                            <div class="form-group">
                                <label for="ct-ratio-secondary">CT Secondary (A) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Secondary rating of the Current Transformer (e.g., 5 for 400/5).</span></span></label>
                                <input type="number" id="ct-ratio-secondary" step="1" value="5" required>
                            </div>
                            <div class="form-group">
                                <label for="ct-burden">CT Burden (VA) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Total burden connected to the CT secondary. Affects CT accuracy.</span></span></label>
                                <input type="number" id="ct-burden" step="0.1" value="10" required>
                            </div>
                            <div class="form-group">
                                <label for="ct-accuracy-class">CT Accuracy Class <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Accuracy class of the CT (e.g., C100, 5P20).</span></span></label>
                                <input type="text" id="ct-accuracy-class" value="C100" required>
                            </div>
                        </div>
                    </div>

                    <!-- Motor Specific Inputs -->
                    <div class="form-section" id="motor-specific-inputs">
                        <h3>Motor Specific Parameters</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="power-factor">Power Factor (PF) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Motor's operating power factor (0.0 to 1.0). Typical: 0.8.</span></span></label>
                                <input type="number" id="power-factor" step="0.01" min="0.0" max="1.0" value="0.8" required>
                            </div>
                            <div class="form-group">
                                <label for="efficiency">Efficiency (%) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Motor's operating efficiency (0.0 to 100.0). Typical: 85-95.</span></span></label>
                                <input type="number" id="efficiency" step="0.1" min="0.0" max="100.0" value="90" required>
                            </div>
                            <div class="form-group">
                                <label for="motor-lra-multiplier">Motor LRA Multiplier <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Locked Rotor Amps (LRA) as a multiple of FLC. Typical: 6-8.</span></span></label>
                                <input type="number" id="motor-lra-multiplier" step="0.1" min="1" max="20" value="6" required>
                            </div>
                            <div class="form-group">
                                <label for="motor-start-time">Motor Start Time (s) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Typical motor starting time in seconds. Used for instantaneous coordination.</span></span></label>
                                <input type="number" id="motor-start-time" step="0.1" min="0.1" max="60" value="5" required>
                            </div>
                            <div class="form-group">
                                <label for="thermal-time-constant">Thermal Time Constant (min) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Motor thermal model time constant for overload protection (for numerical relays).</span></span></label>
                                <input type="number" id="thermal-time-constant" step="0.1" min="1" value="10" required>
                            </div>
                            <div class="form-group">
                                <label for="cold-hot-curve">Thermal Curve <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Select cold or hot thermal curve for motor protection.</span></span></label>
                                <select id="cold-hot-curve">
                                    <option value="cold">Cold (Motor at ambient temp)</option>
                                    <option value="hot">Hot (Motor at operating temp)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="stall-protection-multiplier">Stall Protection Pickup (xFLC) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Pickup setting for motor stall protection (ANSI 51LR/48) as a multiple of FLC.</span></span></label>
                                <input type="number" id="stall-protection-multiplier" step="0.1" min="1" value="1.5" required>
                            </div>
                             <div class="form-group">
                                <label for="stall-protection-time">Stall Protection Time (s) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Time delay for motor stall protection (ANSI 51LR/48).</span></span></label>
                                <input type="number" id="stall-protection-time" step="0.1" min="0.1" value="2" required>
                            </div>
                            <div class="form-group">
                                <label for="undercurrent-pickup-percent">Undercurrent Pickup (%FLC) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Pickup setting for undercurrent protection (ANSI 37) as a percentage of FLC.</span></span></label>
                                <input type="number" id="undercurrent-pickup-percent" step="1" min="1" max="100" value="40" required>
                            </div>
                            <div class="form-group">
                                <label for="undercurrent-time">Undercurrent Time (s) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Time delay for undercurrent protection (ANSI 37).</span></span></label>
                                <input type="number" id="undercurrent-time" step="0.1" min="0.1" value="5" required>
                            </div>
                            <div class="form-group">
                                <label for="negative-sequence-pickup-percent">Neg. Seq. Overcurrent Pickup (%FLC) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Pickup for negative sequence overcurrent (ANSI 46) as a percentage of FLC.</span></span></label>
                                <input type="number" id="negative-sequence-pickup-percent" step="0.1" min="1" max="100" value="10" required>
                            </div>
                            <div class="form-group">
                                <label for="negative-sequence-time">Neg. Seq. Overcurrent Time (s) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Time delay for negative sequence overcurrent (ANSI 46).</span></span></label>
                                <input type="number" id="negative-sequence-time" step="0.1" min="0.1" value="10" required>
                            </div>
                            <div class="form-group">
                                <label for="starts-per-hour-limit">Starts/Hour Limit (ANSI 66) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Maximum number of motor starts allowed per hour.</span></span></label>
                                <input type="number" id="starts-per-hour-limit" step="1" min="1" value="3" required>
                            </div>
                            <div class="form-group">
                                <label for="restart-inhibit-time">Restart Inhibit Time (min) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Minimum time before allowing a restart after a trip or stop.</span></span></label>
                                <input type="number" id="restart-inhibit-time" step="0.1" min="0.1" value="5" required>
                            </div>
                            <div class="form-group">
                                <label for="thermal-alarm-pickup-percent">Thermal Alarm Pickup (% of FLC) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Setting for thermal alarm, as a percentage of FLC.</span></span></label>
                                <input type="number" id="thermal-alarm-pickup-percent" step="1" min="100" max="120" value="105" required>
                            </div>
                            <div class="form-group">
                                <label for="locked-rotor-trip-time">Locked Rotor Trip Time (s) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Specific trip time for locked rotor condition if different from instantaneous.</span></span></label>
                                <input type="number" id="locked-rotor-trip-time" step="0.1" min="0.1" value="10" required>
                            </div>
                             <div class="form-group">
                                <label for="motor-ground-fault-type">Motor Ground Fault Type <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Select the type of ground fault protection for the motor.</span></span></label>
                                <select id="motor-ground-fault-type">
                                    <option value="residual">Residual (51N/50N)</option>
                                    <option value="zero_sequence">Zero Sequence (51G/50G)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="motor-ground-fault-pickup">Motor Ground Fault Pickup (A) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Pickup current for motor ground fault protection (secondary A).</span></span></label>
                                <input type="number" id="motor-ground-fault-pickup" step="0.01" min="0.01" value="0.1" required>
                            </div>
                            <div class="form-group">
                                <label for="motor-ground-fault-time">Motor Ground Fault Time (s) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Time delay for motor ground fault protection.</span></span></label>
                                <input type="number" id="motor-ground-fault-time" step="0.01" min="0.01" value="0.2" required>
                            </div>
                        </div>
                    </div>

                    <!-- Transformer Specific Inputs -->
                    <div class="form-section" id="transformer-specific-inputs">
                        <h3>Transformer Specific Parameters</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="transformer-impedance">Transformer Impedance (Z%) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Percentage impedance of the transformer. Typical: 5-7%.</span></span></label>
                                <input type="number" id="transformer-impedance" step="0.1" min="1" max="20" value="6" required>
                            </div>
                            <div class="form-group">
                                <label for="transformer-inrush-factor">Inrush Current Factor (xFLC) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Inrush current as a multiple of FLC. Typical: 8-12.</span></span></label>
                                <input type="number" id="transformer-inrush-factor" step="0.1" min="1" max="20" value="10" required>
                            </div>
                            <div class="form-group">
                                <label for="hv-ct-primary">HV CT Primary (A) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Primary CT rating on the High Voltage side.</span></span></label>
                                <input type="number" id="hv-ct-primary" step="1" value="100" required>
                            </div>
                            <div class="form-group">
                                <label for="hv-ct-secondary">HV CT Secondary (A) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Secondary CT rating on the High Voltage side (e.g., 5).</span></span></label>
                                <input type="number" id="hv-ct-secondary" step="1" value="5" required>
                            </div>
                            <div class="form-group">
                                <label for="lv-ct-primary">LV CT Primary (A) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Primary CT rating on the Low Voltage side.</span></span></label>
                                <input type="number" id="lv-ct-primary" step="1" value="1000" required>
                            </div>
                            <div class="form-group">
                                <label for="lv-ct-secondary">LV CT Secondary (A) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Secondary CT rating on the Low Voltage side (e.g., 5).</span></span></label>
                                <input type="number" id="lv-ct-secondary" step="1" value="5" required>
                            </div>
                            <div class="form-group">
                                <label for="vector-group">Transformer Vector Group <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Transformer winding connection (e.g., Dyn11, YNd1). Affects differential relay compensation.</span></span></label>
                                <input type="text" id="vector-group" value="Dyn11" required>
                            </div>
                            <div class="form-group">
                                <label for="harmonic-restraint-2nd-percent">2nd Harmonic Restraint (% of Diff Current) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Percentage of 2nd harmonic current above which differential element is restrained. Typical: 15-25%.</span></span></label>
                                <input type="number" id="harmonic-restraint-2nd-percent" step="1" min="0" max="100" value="20" required>
                            </div>
                            <div class="form-group">
                                <label for="harmonic-restraint-5th-percent">5th Harmonic Restraint (% of Diff Current) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Percentage of 5th harmonic current above which differential element is restrained (for overexcitation). Typical: 25-40%.</span></span></label>
                                <input type="number" id="harmonic-restraint-5th-percent" step="1" min="0" max="100" value="35" required>
                            </div>
                            <div class="form-group">
                                <label for="overexcitation-pickup-v_hz">Overexcitation Pickup (V/Hz) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Pickup setting for overexcitation protection (ANSI 24) in Volts/Hertz. Typical: 1.15 - 1.25.</span></span></label>
                                <input type="number" id="overexcitation-pickup-v_hz" step="0.01" min="1" value="1.2" required>
                            </div>
                            <div class="form-group">
                                <label for="overexcitation-time-delay">Overexcitation Time Delay (s) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Time delay for overexcitation protection (ANSI 24).</span></span></label>
                                <input type="number" id="overexcitation-time-delay" step="0.01" min="0.1" value="5" required>
                            </div>
                            <div class="form-group">
                                <label for="low-set-differential-pickup-percent">Low-Set Differential Pickup (%FLC) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Sensitive differential pickup (ANSI 87L) for ground faults, as percentage of FLC.</span></span></label>
                                <input type="number" id="low-set-differential-pickup-percent" step="0.1" min="1" max="100" value="5" required>
                            </div>
                            <div class="form-group">
                                <label for="low-set-differential-time-delay">Low-Set Differential Time Delay (s) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Time delay for low-set differential protection.</span></span></label>
                                <input type="number" id="low-set-differential-time-delay" step="0.01" min="0" value="0.1" required>
                            </div>
                            <div class="form-group">
                                <label for="unrestrained-differential-pickup-xflc">Unrestrained Differential Pickup (xFLC) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">High-set instantaneous differential pickup (ANSI 87U) for severe internal faults.</span></span></label>
                                <input type="number" id="unrestrained-differential-pickup-xflc" step="0.1" min="1" value="15" required>
                            </div>
                            <div class="form-group">
                                <label for="unrestrained-differential-time">Unrestrained Differential Time (s) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Time delay for unrestrained differential protection (typically 0).</span></span></label>
                                <input type="number" id="unrestrained-differential-time" step="0.01" min="0" value="0" required>
                            </div>
                            <div class="form-group">
                                <label for="restricted-earth-fault-pickup">Restricted Earth Fault (64R) Pickup (A) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Pickup current for Restricted Earth Fault protection (secondary A).</span></span></label>
                                <input type="number" id="restricted-earth-fault-pickup" step="0.01" min="0.01" value="0.1" required>
                            </div>
                            <div class="form-group">
                                <label for="restricted-earth-fault-time">Restricted Earth Fault (64R) Time (s) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Time delay for Restricted Earth Fault protection.</span></span></label>
                                <input type="number" id="restricted-earth-fault-time" step="0.01" min="0.01" value="0.2" required>
                            </div>
                        </div>
                    </div>

                    <!-- Relay Details -->
                    <div class="form-section">
                        <h3>Relay Details</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="relay-type">Type of Relay <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Select the technology of the protective relay.</span></span></label>
                                <select id="relay-type" required>
                                    <option value="numerical">Numerical (Digital)</option>
                                    <option value="electromechanical">Electro-mechanical</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="relay-application">Relay Application <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Select the primary protection function of the relay.</span></span></label>
                                <select id="relay-application" required>
                                    <option value="overcurrent">Overcurrent (Phase) - 51/50</option>
                                    <option value="earth_fault">Earth Fault - 51N/50N</option>
                                    <option value="motor_protection">Motor Protection - 49/51/50/46</option>
                                    <option value="transformer_differential">Transformer Differential - 87T</option>
                                </select>
                            </div>
                            <div class="form-group" id="idmt-curve-input">
                                <label for="idmt-curve">IDMT Curve Type <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Inverse Definite Minimum Time (IDMT) curve characteristic. Common types per IEC/IEEE.</span></span></label>
                                <select id="idmt-curve">
                                    <option value="iec_standard_inverse">IEC Standard Inverse</option>
                                    <option value="iec_very_inverse">IEC Very Inverse</option>
                                    <option value="iec_extremely_inverse">IEC Extremely Inverse</option>
                                    <option value="ieee_moderately_inverse">IEEE Moderately Inverse</option>
                                    <option value="ieee_very_inverse">IEEE Very Inverse</option>
                                    <option value="ieee_extremely_inverse">IEEE Extremely Inverse</option>
                                </select>
                            </div>
                            <div class="form-group" id="tds-input">
                                <label for="time-dial-setting">Time Dial Setting (TDS) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Time Dial Setting for IDMT relays. Adjust for coordination. Typical: 0.1 to 1.0.</span></span></label>
                                <input type="number" id="time-dial-setting" step="0.01" min="0.01" max="1.0" value="0.2" required>
                            </div>
                            <div class="form-group" id="instantaneous-time-delay-input">
                                <label for="instantaneous-time-delay">Instantaneous Time Delay (s) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Time delay for instantaneous element (usually 0 for true instantaneous).</span></span></label>
                                <input type="number" id="instantaneous-time-delay" step="0.001" min="0" value="0" required>
                            </div>
                            <div class="form-group">
                                <label for="coordination-time-interval">Coordination Time Interval (CTI) (s) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Minimum time difference between successive protective devices for proper coordination. Typical: 0.2-0.3s.</span></span></label>
                                <input type="number" id="coordination-time-interval" step="0.01" min="0.05" value="0.25" required>
                            </div>
                             <div class="form-group">
                                <label for="dropout-ratio-percent">Dropout Ratio (%) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Percentage of pickup current at which the relay resets. Typical: 90-95% for numerical, 80-90% for EM.</span></span></label>
                                <input type="number" id="dropout-ratio-percent" step="1" min="50" max="100" value="95" required>
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Relay Parameters (Numerical Only) -->
                    <div class="form-section" id="advanced-relay-inputs">
                        <h3>Advanced Relay Parameters (Numerical Relays)</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="reset-time-factor">Reset Time Factor <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Factor affecting the reset time of the relay characteristic. Typical: 0.9 for numerical.</span></span></label>
                                <input type="number" id="reset-time-factor" step="0.01" min="0.1" max="1.0" value="0.9" required>
                            </div>
                            <div class="form-group">
                                <label for="harmonic-blocking-percent">Harmonic Blocking (% of Fundamental) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Percentage of harmonic content (e.g., 2nd harmonic) above which overcurrent/differential element is blocked to prevent nuisance tripping.</span></span></label>
                                <input type="number" id="harmonic-blocking-percent" step="1" min="0" max="100" value="15" required>
                            </div>
                            <div class="form-group">
                                <label for="ct-vt-supervision-enable">CT/VT Supervision (60) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Enable/Disable CT/VT circuit supervision. Essential for voltage-dependent functions.</span></span></label>
                                <select id="ct-vt-supervision-enable">
                                    <option value="enabled">Enabled</option>
                                    <option value="disabled">Disabled</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="breaker-failure-time">Breaker Failure (50BF/62BF) Time (s) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Time delay for breaker failure protection. Initiates trip of upstream breakers.</span></span></label>
                                <input type="number" id="breaker-failure-time" step="0.01" min="0.05" value="0.15" required>
                            </div>
                            <div class="form-group">
                                <label for="auto-reclosing-stages">Auto-Reclosing (79) Stages <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Number of reclosing attempts. Typical: 1 to 3.</span></span></label>
                                <input type="number" id="auto-reclosing-stages" step="1" min="0" value="1" required>
                            </div>
                            <div class="form-group">
                                <label for="auto-reclosing-dead-time">Auto-Reclosing (79) Dead Time (s) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Time interval before reclosing attempt.</span></span></label>
                                <input type="number" id="auto-reclosing-dead-time" step="0.1" min="0.1" value="0.5" required>
                            </div>
                            <div class="form-group">
                                <label for="sync-check-enable">Sync-Check (25) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Enable/Disable synchronism check for breaker closing.</span></span></label>
                                <select id="sync-check-enable">
                                    <option value="enabled">Enabled</option>
                                    <option value="disabled">Disabled</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="sync-check-voltage-diff">Sync-Check Voltage Diff (V) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Maximum permissible voltage difference for sync-check.</span></span></label>
                                <input type="number" id="sync-check-voltage-diff" step="1" min="0" value="10" required>
                            </div>
                            <div class="form-group">
                                <label for="sync-check-angle-diff">Sync-Check Angle Diff (deg) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Maximum permissible angle difference for sync-check.</span></span></label>
                                <input type="number" id="sync-check-angle-diff" step="1" min="0" max="180" value="30" required>
                            </div>
                            <div class="form-group">
                                <label for="under-voltage-pickup">Under Voltage (27) Pickup (V) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Pickup voltage for under-voltage protection (secondary V).</span></span></label>
                                <input type="number" id="under-voltage-pickup" step="0.1" min="0" value="80" required>
                            </div>
                            <div class="form-group">
                                <label for="under-voltage-time">Under Voltage (27) Time (s) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Time delay for under-voltage protection.</span></span></label>
                                <input type="number" id="under-voltage-time" step="0.1" min="0.1" value="5" required>
                            </div>
                            <div class="form-group">
                                <label for="over-voltage-pickup">Over Voltage (59) Pickup (V) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Pickup voltage for over-voltage protection (secondary V).</span></span></label>
                                <input type="number" id="over-voltage-pickup" step="0.1" min="0" value="120" required>
                            </div>
                            <div class="form-group">
                                <label for="over-voltage-time">Over Voltage (59) Time (s) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Time delay for over-voltage protection.</span></span></label>
                                <input type="number" id="over-voltage-time" step="0.1" min="0.1" value="2" required>
                            </div>
                            <div class="form-group">
                                <label for="under-frequency-pickup">Under Frequency (81U) Pickup (Hz) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Pickup frequency for under-frequency protection.</span></span></label>
                                <input type="number" id="under-frequency-pickup" step="0.01" min="45" max="50" value="48.5" required>
                            </div>
                            <div class="form-group">
                                <label for="under-frequency-time">Under Frequency (81U) Time (s) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Time delay for under-frequency protection.</span></span></label>
                                <input type="number" id="under-frequency-time" step="0.01" min="0.05" value="0.5" required>
                            </div>
                            <div class="form-group">
                                <label for="over-frequency-pickup">Over Frequency (81O) Pickup (Hz) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Pickup frequency for over-frequency protection.</span></span></label>
                                <input type="number" id="over-frequency-pickup" step="0.01" min="50" max="55" value="51.5" required>
                            </div>
                            <div class="form-group">
                                <label for="over-frequency-time">Over Frequency (81O) Time (s) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Time delay for over-frequency protection.</span></span></label>
                                <input type="number" id="over-frequency-time" step="0.01" min="0.05" value="0.5" required>
                            </div>
                            <div class="form-group">
                                <label for="directional-element-enable">Directional Element (67/67N) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Enable/Disable directional element for overcurrent/earth fault.</span></span></label>
                                <select id="directional-element-enable">
                                    <option value="disabled">Disabled</option>
                                    <option value="enabled">Enabled</option>
                                </select>
                            </div>
                            <div class="form-group" id="directional-angle-input">
                                <label for="directional-characteristic-angle">Directional Characteristic Angle (deg) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Relay characteristic angle for directional element (e.g., 30, 45, 60 degrees).</span></span></label>
                                <input type="number" id="directional-characteristic-angle" step="1" min="0" max="90" value="45" required>
                            </div>
                            <div class="form-group" id="directional-polarizing-input">
                                <label for="directional-polarizing-quantity">Directional Polarizing Quantity <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Voltage or current used for directional sensing.</span></span></label>
                                <select id="directional-polarizing-quantity">
                                    <option value="phase_voltage">Phase Voltage (e.g., Va)</option>
                                    <option value="quadrature_voltage">Quadrature Voltage (e.g., Vbc for Ia)</option>
                                    <option value="zero_sequence_voltage">Zero Sequence Voltage (3Vo for 67N)</option>
                                    <option value="negative_sequence_voltage">Negative Sequence Voltage (3V2 for 67)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- New: Relay Setting Guidance Section -->
                    <div class="form-section" id="relay-guidance-section">
                        <h3>Relay Setting Guidance</h3>
                        <div id="guidance-content">
                            <!-- Dynamic content will be inserted here -->
                        </div>
                    </div>

                    <div class="button-wrapper">
                        <button type="button" id="calculate-btn" class="calculate-btn">Calculate Relay Settings</button>
                        <button type="button" id="reset-form-btn" class="reset-btn"><i class="fas fa-sync-alt"></i> Reset Form</button>
                    </div>
                </form>
            </div>
            
            <div id="result-container" class="result-container">
                <h3>Calculated Relay Settings</h3>
                <div id="calculation-details">
                    <!-- Calculation steps will be inserted here -->
                </div>
                <table class="result-table">
                    <thead>
                        <tr>
                            <th>Setting Parameter</th>
                            <th>Calculated Value</th>
                            <th>Unit</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody id="result-table-body">
                        <!-- Results will be dynamically inserted here -->
                    </tbody>
                </table>
                <div style="display: flex; justify-content: center; margin-top: 20px;">
                    <button type="button" id="clear-results-btn" class="clear-results-btn"><i class="fas fa-times-circle"></i> Clear Results</button>
                </div>
                <div class="standard-reference" id="standard-reference">
                    <!-- Standard reference text will be inserted here -->
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <div class="disclaimer">
                <h3>Disclaimer</h3>
                <p>This calculator provides preliminary settings for guidance only. Actual relay coordination requires a detailed system study, short-circuit analysis, and specialized software to ensure proper protection and selectivity. Always consult relevant standards and qualified engineers for final settings.</p>
            </div>
            <div class="credit">
                <p>Created by A Sharma</p>
            </div>
            <div class="social-share">
                <h3>Share This Site</h3>
                <div class="social-buttons">
                    <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://designcalculators.co.in&title=Design Calculators - Electrical" target="_blank" class="social-btn linkedin">
                        <i class="fab fa-linkedin"></i>
                    </a>
                    <a href="https://www.facebook.com/sharer/sharer.php?u=https://designcalculators.co.in" target="_blank" class="social-btn facebook">
                        <i class="fab fa-facebook"></i>
                    </a>
                    <a href="https://twitter.com/intent/tweet?text=Check out this amazing Design Calculators - Electrical!&url=https://designcalculators.co.in" target="_blank" class="social-btn twitter">
                        <i class="fab fa-twitter"></i>
                    </a>
                    <a href="https://api.whatsapp.com/send?text=Check out this amazing Design Calculators - Electrical! https://designcalculators.co.in" target="_blank" class="social-btn whatsapp">
                        <i class="fab fa-whatsapp"></i>
                    </a>
                    <a href="https://www.reddit.com/submit?url=https://designcalculators.co.in&title=Design Calculators - Electrical" target="_blank" class="social-btn reddit">
                        <i class="fab fa-reddit"></i>
                    </a>
                </div>
            </div>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Input elements
            const equipmentTypeInput = document.getElementById('equipment-type');
            const voltageRatingInput = document.getElementById('voltage-rating');
            const kvaKwRatingInput = document.getElementById('kva-kw-rating');
            const systemGroundingInput = document.getElementById('system-grounding');
            const ptPrimaryInput = document.getElementById('pt-primary');
            const ptSecondaryInput = document.getElementById('pt-secondary');
            const ctRatioPrimaryInput = document.getElementById('ct-ratio-primary');
            const ctRatioSecondaryInput = document.getElementById('ct-ratio-secondary');
            const ctBurdenInput = document.getElementById('ct-burden');
            const ctAccuracyClassInput = document.getElementById('ct-accuracy-class');
            const powerFactorInput = document.getElementById('power-factor');
            const efficiencyInput = document.getElementById('efficiency');
            const motorLRAMultiplierInput = document.getElementById('motor-lra-multiplier');
            const motorStartTimeInput = document.getElementById('motor-start-time');
            const thermalTimeConstantInput = document.getElementById('thermal-time-constant');
            const coldHotCurveInput = document.getElementById('cold-hot-curve');
            const stallProtectionMultiplierInput = document.getElementById('stall-protection-multiplier');
            const stallProtectionTimeInput = document.getElementById('stall-protection-time');
            const undercurrentPickupPercentInput = document.getElementById('undercurrent-pickup-percent');
            const undercurrentTimeInput = document.getElementById('undercurrent-time');
            const negativeSequencePickupPercentInput = document.getElementById('negative-sequence-pickup-percent');
            const negativeSequenceTimeInput = document.getElementById('negative-sequence-time');
            const startsPerHourLimitInput = document.getElementById('starts-per-hour-limit');
            const restartInhibitTimeInput = document.getElementById('restart-inhibit-time');
            const thermalAlarmPickupPercentInput = document.getElementById('thermal-alarm-pickup-percent');
            const lockedRotorTripTimeInput = document.getElementById('locked-rotor-trip-time');
            const motorGroundFaultTypeInput = document.getElementById('motor-ground-fault-type');
            const motorGroundFaultPickupInput = document.getElementById('motor-ground-fault-pickup');
            const motorGroundFaultTimeInput = document.getElementById('motor-ground-fault-time');

            const transformerImpedanceInput = document.getElementById('transformer-impedance');
            const transformerInrushFactorInput = document.getElementById('transformer-inrush-factor');
            const hvCtPrimaryInput = document.getElementById('hv-ct-primary');
            const hvCtSecondaryInput = document.getElementById('hv-ct-secondary');
            const lvCtPrimaryInput = document.getElementById('lv-ct-primary');
            const lvCtSecondaryInput = document.getElementById('lv-ct-secondary');
            const vectorGroupInput = document.getElementById('vector-group');
            const harmonicRestraint2ndPercentInput = document.getElementById('harmonic-restraint-2nd-percent');
            const harmonicRestraint5thPercentInput = document.getElementById('harmonic-restraint-5th-percent');
            const overexcitationPickupVHzInput = document.getElementById('overexcitation-pickup-v_hz');
            const overexcitationTimeDelayInput = document.getElementById('overexcitation-time-delay');
            const lowSetDifferentialPickupPercentInput = document.getElementById('low-set-differential-pickup-percent');
            const lowSetDifferentialTimeDelayInput = document.getElementById('low-set-differential-time-delay');
            const unrestrainedDifferentialPickupXFLCInput = document.getElementById('unrestrained-differential-pickup-xflc');
            const unrestrainedDifferentialTimeInput = document.getElementById('unrestrained-differential-time');
            const restrictedEarthFaultPickupInput = document.getElementById('restricted-earth-fault-pickup');
            const restrictedEarthFaultTimeInput = document.getElementById('restricted-earth-fault-time');

            const relayTypeInput = document.getElementById('relay-type');
            const relayApplicationInput = document.getElementById('relay-application');
            const idmtCurveInput = document.getElementById('idmt-curve');
            const timeDialSettingInput = document.getElementById('time-dial-setting');
            const instantaneousTimeDelayInput = document.getElementById('instantaneous-time-delay');
            const coordinationTimeIntervalInput = document.getElementById('coordination-time-interval');
            const resetTimeFactorInput = document.getElementById('reset-time-factor');
            const dropoutRatioPercentInput = document.getElementById('dropout-ratio-percent');
            const harmonicBlockingPercentInput = document.getElementById('harmonic-blocking-percent');
            const ctVtSupervisionEnableInput = document.getElementById('ct-vt-supervision-enable');
            const breakerFailureTimeInput = document.getElementById('breaker-failure-time');
            const autoReclosingStagesInput = document.getElementById('auto-reclosing-stages');
            const autoReclosingDeadTimeInput = document.getElementById('auto-reclosing-dead-time');
            const syncCheckEnableInput = document.getElementById('sync-check-enable');
            const syncCheckVoltageDiffInput = document.getElementById('sync-check-voltage-diff');
            const syncCheckAngleDiffInput = document.getElementById('sync-check-angle-diff');
            const underVoltagePickupInput = document.getElementById('under-voltage-pickup');
            const underVoltageTimeInput = document.getElementById('under-voltage-time');
            const overVoltagePickupInput = document.getElementById('over-voltage-pickup');
            const overVoltageTimeInput = document.getElementById('over-voltage-time');
            const underFrequencyPickupInput = document.getElementById('under-frequency-pickup');
            const underFrequencyTimeInput = document.getElementById('under-frequency-time');
            const overFrequencyPickupInput = document.getElementById('over-frequency-pickup');
            const overFrequencyTimeInput = document.getElementById('over-frequency-time');
            const directionalElementEnableInput = document.getElementById('directional-element-enable');
            const directionalCharacteristicAngleInput = document.getElementById('directional-characteristic-angle');
            const directionalPolarizingQuantityInput = document.getElementById('directional-polarizing-quantity');


            // Conditional input sections
            const motorSpecificInputsDiv = document.getElementById('motor-specific-inputs');
            const transformerSpecificInputsDiv = document.getElementById('transformer-specific-inputs');
            const idmtCurveDiv = document.getElementById('idmt-curve-input');
            const tdsDiv = document.getElementById('tds-input');
            const instantaneousTimeDelayDiv = document.getElementById('instantaneous-time-delay-input');
            const generalCtInputsDiv = document.getElementById('general-ct-inputs');
            const advancedRelayInputsDiv = document.getElementById('advanced-relay-inputs');
            const directionalAngleInputDiv = document.getElementById('directional-angle-input');
            const directionalPolarizingInputDiv = document.getElementById('directional-polarizing-input');
            const relayGuidanceSection = document.getElementById('relay-guidance-section');
            const guidanceContentDiv = document.getElementById('guidance-content');


            // Buttons and result containers
            const calculateBtn = document.getElementById('calculate-btn');
            const resetFormBtn = document.getElementById('reset-form-btn');
            const clearResultsBtn = document.getElementById('clear-results-btn');
            const resultContainer = document.getElementById('result-container');
            const resultTableBody = document.getElementById('result-table-body');
            const standardReference = document.getElementById('standard-reference');
            const calculationDetailsDiv = document.getElementById('calculation-details');

            // Default values for resetting form
            const defaultValues = {
                'equipment-type': 'transformer',
                'voltage-rating': 11, // kV
                'kva-kw-rating': 1000, // kVA
                'system-grounding': 'solidly_grounded',
                'pt-primary': 11000,
                'pt-secondary': 110,
                'ct-ratio-primary': 400,
                'ct-ratio-secondary': 5,
                'ct-burden': 10,
                'ct-accuracy-class': 'C100',
                'power-factor': 0.8,
                'efficiency': 90, // %
                'motor-lra-multiplier': 6,
                'motor-start-time': 5,
                'thermal-time-constant': 10,
                'cold-hot-curve': 'cold',
                'stall-protection-multiplier': 1.5,
                'stall-protection-time': 2,
                'undercurrent-pickup-percent': 40,
                'undercurrent-time': 5,
                'negative-sequence-pickup-percent': 10,
                'negative-sequence-time': 10,
                'starts-per-hour-limit': 3,
                'restart-inhibit-time': 5,
                'thermal-alarm-pickup-percent': 105,
                'locked-rotor-trip-time': 10,
                'motor-ground-fault-type': 'residual',
                'motor-ground-fault-pickup': 0.1,
                'motor-ground-fault-time': 0.2,
                'transformer-impedance': 6, // %
                'transformer-inrush-factor': 10,
                'hv-ct-primary': 100,
                'hv-ct-secondary': 5,
                'lv-ct-primary': 1000,
                'lv-ct-secondary': 5,
                'vector-group': 'Dyn11',
                'harmonic-restraint-2nd-percent': 20,
                'harmonic-restraint-5th-percent': 35,
                'overexcitation-pickup-v_hz': 1.2,
                'overexcitation-time-delay': 5,
                'low-set-differential-pickup-percent': 5,
                'low-set-differential-time-delay': 0.1,
                'unrestrained-differential-pickup-xflc': 15,
                'unrestrained-differential-time': 0,
                'restricted-earth-fault-pickup': 0.1,
                'restricted-earth-fault-time': 0.2,
                'relay-type': 'numerical',
                'relay-application': 'overcurrent',
                'idmt-curve': 'iec_standard_inverse',
                'time-dial-setting': 0.2,
                'instantaneous-time-delay': 0,
                'coordination-time-interval': 0.25,
                'reset-time-factor': 0.9,
                'dropout-ratio-percent': 95,
                'harmonic-blocking-percent': 15,
                'ct-vt-supervision-enable': 'enabled',
                'breaker-failure-time': 0.15,
                'auto-reclosing-stages': 1,
                'auto-reclosing-dead-time': 0.5,
                'sync-check-enable': 'enabled',
                'sync-check-voltage-diff': 10,
                'sync-check-angle-diff': 30,
                'under-voltage-pickup': 80,
                'under-voltage-time': 5,
                'over-voltage-pickup': 120,
                'over-voltage-time': 2,
                'under-frequency-pickup': 48.5,
                'under-frequency-time': 0.5,
                'over-frequency-pickup': 51.5,
                'over-frequency-time': 0.5,
                'directional-element-enable': 'disabled',
                'directional-characteristic-angle': 45,
                'directional-polarizing-quantity': 'phase_voltage'
            };

            // Helper function to add rows to the result table
            function addResultRow(parameter, value, unit, notes = '') {
                const row = resultTableBody.insertRow();
                const paramCell = row.insertCell();
                const valueCell = row.insertCell();
                const unitCell = row.insertCell();
                const notesCell = row.insertCell();
                paramCell.innerHTML = parameter;
                valueCell.innerHTML = value;
                unitCell.innerHTML = unit;
                notesCell.innerHTML = notes;
            }

            // Function to display messages (replaces alert())
            function displayMessage(message, type = "info") {
                let messageBox = document.getElementById('custom-message-box');
                if (!messageBox) {
                    messageBox = document.createElement('div');
                    messageBox.id = 'custom-message-box';
                    messageBox.style.cssText = `
                        position: fixed;
                        top: 20px;
                        left: 50%;
                        transform: translateX(-50%);
                        padding: 15px 25px;
                        border-radius: 8px;
                        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
                        z-index: 1000;
                        font-weight: bold;
                        color: white;
                        opacity: 0;
                        transition: opacity 0.5s ease-in-out, transform 0.3s ease-out;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        min-width: 250px;
                    `;
                    document.body.appendChild(messageBox);
                }

                messageBox.textContent = message;
                if (type === "error") {
                    messageBox.style.backgroundColor = '#dc3545'; /* Red */
                } else if (type === "warning") {
                    messageBox.style.backgroundColor = '#ffc107'; /* Amber */
                    messageBox.style.color = '#333';
                } else {
                    messageBox.style.backgroundColor = '#28a745'; /* Green */
                }
                messageBox.style.opacity = 1;
                messageBox.style.transform = 'translateX(-50%) translateY(0)';

                setTimeout(() => {
                    messageBox.style.opacity = 0;
                    messageBox.style.transform = 'translateX(-50%) translateY(-20px)';
                }, 5000);
            }

            function clearResults() {
                resultContainer.classList.remove('show');
                resultTableBody.innerHTML = '';
                calculationDetailsDiv.innerHTML = '';
                standardReference.innerHTML = '';
                displayMessage("Results cleared.", "info");
            }

            function resetForm() {
                for (const key in defaultValues) {
                    const element = document.getElementById(key);
                    if (element) {
                        element.value = defaultValues[key];
                    }
                }
                updateInputFieldsVisibility(); // Reset visibility based on default
                clearResults();
                displayMessage("Form reset to default values.", "info");
            }

            // Function to dynamically show/hide input fields based on selections
            function updateInputFieldsVisibility() {
                const equipmentType = equipmentTypeInput.value;
                const relayApplication = relayApplicationInput.value;
                const relayType = relayTypeInput.value; // Get relay type for specific numerical/EM parameters

                // Hide all conditional inputs first
                motorSpecificInputsDiv.style.display = 'none';
                transformerSpecificInputsDiv.style.display = 'none';
                idmtCurveDiv.style.display = 'none';
                tdsDiv.style.display = 'none';
                instantaneousTimeDelayDiv.style.display = 'none';
                generalCtInputsDiv.style.display = 'block';
                advancedRelayInputsDiv.style.display = 'none';
                directionalAngleInputDiv.style.display = 'none';
                directionalPolarizingInputDiv.style.display = 'none';
                relayGuidanceSection.style.display = 'none'; // Hide guidance section by default
                guidanceContentDiv.innerHTML = ''; // Clear previous guidance content


                // Manage 'required' attribute for all conditional inputs
                const allConditionalInputs = [
                    powerFactorInput, efficiencyInput, motorLRAMultiplierInput, motorStartTimeInput,
                    thermalTimeConstantInput, coldHotCurveInput, stallProtectionMultiplierInput, stallProtectionTimeInput,
                    undercurrentPickupPercentInput, undercurrentTimeInput, negativeSequencePickupPercentInput, negativeSequenceTimeInput,
                    startsPerHourLimitInput, restartInhibitTimeInput, thermalAlarmPickupPercentInput, lockedRotorTripTimeInput,
                    motorGroundFaultTypeInput, motorGroundFaultPickupInput, motorGroundFaultTimeInput,
                    transformerImpedanceInput, transformerInrushFactorInput, hvCtPrimaryInput, hvCtSecondaryInput,
                    lvCtPrimaryInput, lvCtSecondaryInput, vectorGroupInput, harmonicRestraint2ndPercentInput,
                    harmonicRestraint5thPercentInput, overexcitationPickupVHzInput, overexcitationTimeDelayInput,
                    lowSetDifferentialPickupPercentInput, lowSetDifferentialTimeDelayInput,
                    unrestrainedDifferentialPickupXFLCInput, unrestrainedDifferentialTimeInput,
                    restrictedEarthFaultPickupInput, restrictedEarthFaultTimeInput,
                    idmtCurveInput, timeDialSettingInput, instantaneousTimeDelayInput,
                    resetTimeFactorInput, dropoutRatioPercentInput, harmonicBlockingPercentInput,
                    ctVtSupervisionEnableInput, breakerFailureTimeInput, autoReclosingStagesInput, autoReclosingDeadTimeInput,
                    syncCheckEnableInput, syncCheckVoltageDiffInput, syncCheckAngleDiffInput,
                    underVoltagePickupInput, underVoltageTimeInput, overVoltagePickupInput, overVoltageTimeInput,
                    underFrequencyPickupInput, underFrequencyTimeInput, overFrequencyPickupInput, overFrequencyTimeInput,
                    directionalElementEnableInput, directionalCharacteristicAngleInput, directionalPolarizingQuantityInput
                ];
                allConditionalInputs.forEach(input => input.removeAttribute('required'));

                // Set required for general inputs (always visible)
                voltageRatingInput.setAttribute('required', 'true');
                kvaKwRatingInput.setAttribute('required', 'true');
                systemGroundingInput.setAttribute('required', 'true');
                ptPrimaryInput.setAttribute('required', 'true');
                ptSecondaryInput.setAttribute('required', 'true');
                ctBurdenInput.setAttribute('required', 'true');
                ctAccuracyClassInput.setAttribute('required', 'true');
                coordinationTimeIntervalInput.setAttribute('required', 'true');
                relayTypeInput.setAttribute('required', 'true');
                relayApplicationInput.setAttribute('required', 'true');
                dropoutRatioPercentInput.setAttribute('required', 'true'); // Always required

                // Show inputs based on equipment type
                if (equipmentType === 'motor') {
                    motorSpecificInputsDiv.style.display = 'block';
                    powerFactorInput.setAttribute('required', 'true');
                    efficiencyInput.setAttribute('required', 'true');
                    motorLRAMultiplierInput.setAttribute('required', 'true');
                    motorStartTimeInput.setAttribute('required', 'true');
                    thermalTimeConstantInput.setAttribute('required', 'true');
                    coldHotCurveInput.setAttribute('required', 'true');
                    stallProtectionMultiplierInput.setAttribute('required', 'true');
                    stallProtectionTimeInput.setAttribute('required', 'true');
                    undercurrentPickupPercentInput.setAttribute('required', 'true');
                    undercurrentTimeInput.setAttribute('required', 'true');
                    negativeSequencePickupPercentInput.setAttribute('required', 'true');
                    negativeSequenceTimeInput.setAttribute('required', 'true');
                    startsPerHourLimitInput.setAttribute('required', 'true');
                    restartInhibitTimeInput.setAttribute('required', 'true');
                    thermalAlarmPickupPercentInput.setAttribute('required', 'true');
                    lockedRotorTripTimeInput.setAttribute('required', 'true');
                    motorGroundFaultTypeInput.setAttribute('required', 'true');
                    motorGroundFaultPickupInput.setAttribute('required', 'true');
                    motorGroundFaultTimeInput.setAttribute('required', 'true');
                } else if (equipmentType === 'transformer') {
                    transformerSpecificInputsDiv.style.display = 'block';
                    transformerImpedanceInput.setAttribute('required', 'true');
                    transformerInrushFactorInput.setAttribute('required', 'true');
                    hvCtPrimaryInput.setAttribute('required', 'true');
                    hvCtSecondaryInput.setAttribute('required', 'true');
                    lvCtPrimaryInput.setAttribute('required', 'true');
                    lvCtSecondaryInput.setAttribute('required', 'true');
                    vectorGroupInput.setAttribute('required', 'true');
                    harmonicRestraint2ndPercentInput.setAttribute('required', 'true');
                    harmonicRestraint5thPercentInput.setAttribute('required', 'true');
                    overexcitationPickupVHzInput.setAttribute('required', 'true');
                    overexcitationTimeDelayInput.setAttribute('required', 'true');
                    lowSetDifferentialPickupPercentInput.setAttribute('required', 'true');
                    lowSetDifferentialTimeDelayInput.setAttribute('required', 'true');
                    unrestrainedDifferentialPickupXFLCInput.setAttribute('required', 'true');
                    unrestrainedDifferentialTimeInput.setAttribute('required', 'true');
                    restrictedEarthFaultPickupInput.setAttribute('required', 'true');
                    restrictedEarthFaultTimeInput.setAttribute('required', 'true');
                    // Hide general CT inputs as transformer has specific CT inputs
                    generalCtInputsDiv.style.display = 'none';
                }

                // Show IDMT/TDS/Instantaneous Time Delay based on relay application
                if (relayApplication === 'overcurrent' || relayApplication === 'earth_fault' || relayApplication === 'motor_protection') {
                    idmtCurveDiv.style.display = 'block';
                    tdsDiv.style.display = 'block';
                    instantaneousTimeDelayDiv.style.display = 'block';
                    idmtCurveInput.setAttribute('required', 'true');
                    timeDialSettingInput.setAttribute('required', 'true');
                    instantaneousTimeDelayInput.setAttribute('required', 'true');
                }

                // Show advanced relay parameters if numerical
                if (relayType === 'numerical') {
                    advancedRelayInputsDiv.style.display = 'block';
                    resetTimeFactorInput.setAttribute('required', 'true');
                    harmonicBlockingPercentInput.setAttribute('required', 'true');
                    ctVtSupervisionEnableInput.setAttribute('required', 'true');
                    breakerFailureTimeInput.setAttribute('required', 'true');
                    autoReclosingStagesInput.setAttribute('required', 'true');
                    autoReclosingDeadTimeInput.setAttribute('required', 'true');
                    syncCheckEnableInput.setAttribute('required', 'true');
                    syncCheckVoltageDiffInput.setAttribute('required', 'true');
                    syncCheckAngleDiffInput.setAttribute('required', 'true');
                    underVoltagePickupInput.setAttribute('required', 'true');
                    underVoltageTimeInput.setAttribute('required', 'true');
                    overVoltagePickupInput.setAttribute('required', 'true');
                    overVoltageTimeInput.setAttribute('required', 'true');
                    underFrequencyPickupInput.setAttribute('required', 'true');
                    underFrequencyTimeInput.setAttribute('required', 'true');
                    overFrequencyPickupInput.setAttribute('required', 'true');
                    overFrequencyTimeInput.setAttribute('required', 'true');
                    directionalElementEnableInput.setAttribute('required', 'true');

                    // Show directional angle/polarizing only if directional element is enabled
                    if (directionalElementEnableInput.value === 'enabled') {
                        directionalAngleInputDiv.style.display = 'block';
                        directionalPolarizingInputDiv.style.display = 'block';
                        directionalCharacteristicAngleInput.setAttribute('required', 'true');
                        directionalPolarizingQuantityInput.setAttribute('required', 'true');
                    } else {
                        directionalAngleInputDiv.style.display = 'none';
                        directionalPolarizingInputDiv.style.display = 'none';
                    }

                } else { // Electromechanical
                    advancedRelayInputsDiv.style.display = 'none';
                }

                // Populate Relay Setting Guidance
                let guidanceHtml = '';
                if (relayApplication === 'overcurrent' || relayApplication === 'earth_fault' || relayApplication === 'motor_protection') {
                    relayGuidanceSection.style.display = 'block';
                    setTimeout(() => { relayGuidanceSection.classList.add('fade-in'); }, 200); // Staggered fade-in

                    guidanceHtml += `<h4>IDMT Curve Selection:</h4>
                        <p>The choice of Inverse Definite Minimum Time (IDMT) curve is crucial for proper coordination and depends on the characteristics of the protected equipment and upstream/downstream devices (e.g., fuses, other relays).</p>
                        <ul>`;
                    
                    if (relayApplication === 'overcurrent' || relayApplication === 'mcc' || relayApplication === 'pcc') {
                        guidanceHtml += `
                            <li><strong>IEC Standard Inverse / IEEE Moderately Inverse:</strong> These are the most common curves for general phase overcurrent protection. They provide good coordination with other relays and are suitable for feeders and main incoming breakers. They offer a balance between speed and selectivity.</li>
                            <li><strong>IEC Very Inverse / IEEE Very Inverse:</strong> These curves are more inverse, meaning their operating time changes more significantly with fault current. They are often used for coordination with fuses or when a faster trip is desired for higher fault currents, such as on distribution feeders.</li>
                            <li><strong>IEC Extremely Inverse / IEEE Extremely Inverse:</strong> These are the most inverse curves. They are typically used for protecting equipment with high inrush currents (like transformers) or for coordination with reclosers, where a very fast trip is needed for high fault currents. They are also effective for ground fault protection where fault current magnitude varies significantly.</li>
                        `;
                    } else if (relayApplication === 'earth_fault') {
                        guidanceHtml += `
                            <li><strong>IEC Extremely Inverse / IEEE Extremely Inverse:</strong> Often preferred for earth fault protection, especially in solidly grounded systems. This is because earth fault currents can vary widely depending on the fault location and system impedance, and an extremely inverse curve helps maintain consistent coordination.</li>
                            <li><strong>IEC Very Inverse / IEEE Very Inverse:</strong> Can also be used for earth fault protection, particularly in resistance-grounded systems where fault currents are limited.</li>
                        `;
                    } else if (relayApplication === 'motor_protection') {
                         guidanceHtml += `
                            <li><strong>IEC Standard Inverse / IEEE Moderately Inverse (for Overcurrent):</strong> While motor protection primarily uses thermal models, the overcurrent elements (51/50) for short-circuit protection often use standard or very inverse curves for coordination with upstream devices.</li>
                            <li><strong>Thermal Overload (ANSI 49):</strong> For motor thermal protection, numerical relays use a thermal model (often based on IEC 60255-8 or similar) rather than a simple IDMT curve. The "Thermal Time Constant" and "Cold/Hot Curve" settings are crucial here to match the motor's actual thermal characteristics.</li>
                        `;
                    }
                    guidanceHtml += `</ul>`;

                    guidanceHtml += `<h4>Time Dial Setting (TDS) Guidance:</h4>
                        <p>The Time Dial Setting (TDS) adjusts the operating time of the IDMT curve. A lower TDS results in a faster trip time for a given fault current. It is critical for achieving proper coordination between protective devices in series.</p>
                        <ul>
                            <li><strong>General Coordination:</strong> Adjust TDS to ensure a minimum Coordination Time Interval (CTI) between upstream and downstream devices. A typical CTI is 0.2 to 0.3 seconds. This allows the downstream device to clear the fault first.</li>
                            <li><strong>Closer to Load:</strong> Relays closer to the load (e.g., feeder relays) generally have lower TDS settings to clear faults quickly and minimize disruption.</li>
                            <li><strong>Closer to Source:</strong> Relays closer to the power source (e.g., main incoming relays) typically have higher TDS settings to provide backup protection and allow downstream devices to operate first.</li>
                        </ul>`;
                    
                    guidanceHtml += `<h4>Instantaneous Overcurrent (50) Guidance:</h4>
                        <p>The instantaneous element provides very fast tripping for high magnitude faults, typically within 0.01 to 0.05 seconds. It should be set above the maximum possible fault current seen by downstream devices and above the inrush current of protected equipment.</p>
                        <ul>
                            <li><strong>Motor Protection:</strong> For motors, the instantaneous setting must be set above the motor's locked rotor current (LRA) to prevent nuisance tripping during start-up. A common practice is 120% of LRA.</li>
                            <li><strong>Transformer Protection:</strong> For transformers, the instantaneous setting must be set above the transformer's magnetizing inrush current.</li>
                            <li><strong>Feeder Protection:</strong> Set above the maximum fault current that can be cleared by the downstream protective device (e.g., fuse, MCCB, or another relay).</li>
                        </ul>`;

                } else if (relayApplication === 'transformer_differential') {
                    relayGuidanceSection.style.display = 'block';
                    setTimeout(() => { relayGuidanceSection.classList.add('fade-in'); }, 200);

                    guidanceHtml += `<h4>Transformer Differential (87T) Guidance:</h4>
                        <p>Differential protection is primary for transformers, detecting internal faults by comparing currents entering and leaving the transformer.</p>
                        <ul>
                            <li><strong>Minimum Pickup:</strong> Set low (e.g., 15-30% of FLC) to detect small internal faults, but high enough to avoid tripping on CT ratio mismatches, tap changes, or normal load unbalance.</li>
                            <li><strong>Slope 1 (Initial Slope):</strong> This slope (e.g., 25%) handles minor CT saturation and tap changes. It provides security for external faults near the transformer.</li>
                            <li><strong>Slope 2 (Second Slope):</strong> This slope (e.g., 75%) is steeper and provides greater security for heavy external faults that might cause significant CT saturation. It ensures dependability for large internal faults.</li>
                            <li><strong>2nd Harmonic Restraint:</strong> Crucial for preventing false trips during transformer energization (inrush current). Inrush current contains a high percentage of 2nd harmonic. Setting this (e.g., 15-25%) blocks the differential element if 2nd harmonic content is high.</li>
                            <li><strong>5th Harmonic Restraint:</strong> Used to prevent tripping due to transformer overexcitation, which generates significant 5th harmonic currents.</li>
                            <li><strong>Restricted Earth Fault (64R):</strong> Provides sensitive ground fault protection for the transformer windings, often more sensitive than the overall differential element for internal ground faults.</li>
                            <li><strong>Overexcitation (24):</strong> Protects the transformer core from overheating due to sustained overvoltage or under-frequency conditions (high V/Hz).</li>
                        </ul>`;
                }

                guidanceContentDiv.innerHTML = guidanceHtml; // Insert dynamic guidance
            }

            // Event listeners for dynamic input visibility
            equipmentTypeInput.addEventListener('change', updateInputFieldsVisibility);
            relayApplicationInput.addEventListener('change', updateInputFieldsVisibility);
            relayTypeInput.addEventListener('change', updateInputFieldsVisibility); // Listen to relay type change
            directionalElementEnableInput.addEventListener('change', updateInputFieldsVisibility); // Listen to directional enable

            // IDMT Curve Constants (A, P, B for IEEE; specific constants for IEC)
            // For I/Ip (M) > 1.0 (pickup current)
            const idmtConstants = {
                'iec_standard_inverse': { type: 'IEC', A: 0.14, P: 0.02, B: 1 }, // t = TDS * 0.14 / ((I/Ip)^0.02 - 1)
                'iec_very_inverse': { type: 'IEC', A: 13.5, P: 1, B: 1 }, // t = TDS * 13.5 / ((I/Ip) - 1)
                'iec_extremely_inverse': { type: 'IEC', A: 80, P: 2, B: 1 }, // t = TDS * 80 / ((I/Ip)^2 - 1)
                'ieee_moderately_inverse': { type: 'IEEE', A: 0.0515, P: 0.02, B: 0.1140 }, // t = TDS * (A / (M^P - 1) + B)
                'ieee_very_inverse': { type: 'IEEE', A: 19.61, P: 2, B: 0.491 },
                'ieee_extremely_inverse': { type: 'IEEE', A: 28.2, P: 2, B: 0.121 }
            };

            // Function to calculate trip time based on IDMT curve
            function calculateTripTime(currentMultiple, tds, curveType) {
                if (currentMultiple <= 1) return Infinity; // Below pickup, no trip
                const constants = idmtConstants[curveType];
                if (!constants) return Infinity;

                const M = currentMultiple; // I / Ip

                if (constants.type === 'IEC') {
                    // IEC curves: t = TDS * K / (M^alpha - 1)
                    // Where K = A, alpha = P
                    return tds * constants.A / (Math.pow(M, constants.P) - 1);
                } else if (constants.type === 'IEEE') {
                    // IEEE curves: t = TDS * (A / (M^P - 1) + B)
                    return tds * (constants.A / (Math.pow(M, constants.P) - 1) + constants.B);
                }
                return Infinity;
            }


            function calculateRelaySettings() {
                clearResults(); // Clear previous results

                // Input values
                const equipmentType = equipmentTypeInput.value;
                const voltageRating_kV = parseFloat(voltageRatingInput.value);
                const kvaKwRating = parseFloat(kvaKwRatingInput.value);
                const systemGrounding = systemGroundingInput.value;
                const ptPrimary = parseFloat(ptPrimaryInput.value);
                const ptSecondary = parseFloat(ptSecondaryInput.value);
                const ctBurden = parseFloat(ctBurdenInput.value);
                const ctAccuracyClass = ctAccuracyClassInput.value;
                const relayType = relayTypeInput.value;
                const relayApplication = relayApplicationInput.value;
                const coordinationTimeInterval = parseFloat(coordinationTimeIntervalInput.value);
                const dropoutRatioPercent = parseFloat(dropoutRatioPercentInput.value);

                // Common CT ratio (for non-transformer applications)
                let ctRatioPrimary = parseFloat(ctRatioPrimaryInput.value);
                let ctRatioSecondary = parseFloat(ctRatioSecondaryInput.value);

                // Conditional inputs based on equipment type
                let powerFactor, efficiency_percent, motorLRAMultiplier, motorStartTime, thermalTimeConstant, coldHotCurve,
                    stallProtectionMultiplier, stallProtectionTime, undercurrentPickupPercent, undercurrentTime,
                    negativeSequencePickupPercent, negativeSequenceTime, startsPerHourLimit, restartInhibitTime,
                    thermalAlarmPickupPercent, lockedRotorTripTime, motorGroundFaultType, motorGroundFaultPickup, motorGroundFaultTime;

                let transformerImpedance_percent, transformerInrushFactor, hvCtPrimary, hvCtSecondary, lvCtPrimary, lvCtSecondary, vectorGroup,
                    harmonicRestraint2ndPercent, harmonicRestraint5thPercent, overexcitationPickupVHz, overexcitationTimeDelay,
                    lowSetDifferentialPickupPercent, lowSetDifferentialTimeDelay, unrestrainedDifferentialPickupXFLC,
                    unrestrainedDifferentialTime, restrictedEarthFaultPickup, restrictedEarthFaultTime;

                // Conditional inputs based on relay application (IDMT settings)
                let idmtCurve, timeDialSetting, instantaneousTimeDelay;

                // General numerical relay parameters
                let resetTimeFactor, harmonicBlockingPercent, ctVtSupervisionEnable, breakerFailureTime,
                    autoReclosingStages, autoReclosingDeadTime, syncCheckEnable, syncCheckVoltageDiff, syncCheckAngleDiff,
                    underVoltagePickup, underVoltageTime, overVoltagePickup, overVoltageTime,
                    underFrequencyPickup, underFrequencyTime, overFrequencyPickup, overFrequencyTime,
                    directionalElementEnable, directionalCharacteristicAngle, directionalPolarizingQuantity;


                // Populate conditional inputs based on visibility
                if (motorSpecificInputsDiv.style.display === 'block') {
                    powerFactor = parseFloat(powerFactorInput.value);
                    efficiency_percent = parseFloat(efficiencyInput.value);
                    motorLRAMultiplier = parseFloat(motorLRAMultiplierInput.value);
                    motorStartTime = parseFloat(motorStartTimeInput.value);
                    thermalTimeConstant = parseFloat(thermalTimeConstantInput.value);
                    coldHotCurve = coldHotCurveInput.value;
                    stallProtectionMultiplier = parseFloat(stallProtectionMultiplierInput.value);
                    stallProtectionTime = parseFloat(stallProtectionTimeInput.value);
                    undercurrentPickupPercent = parseFloat(undercurrentPickupPercentInput.value);
                    undercurrentTime = parseFloat(undercurrentTimeInput.value);
                    negativeSequencePickupPercent = parseFloat(negativeSequencePickupPercentInput.value);
                    negativeSequenceTime = parseFloat(negativeSequenceTimeInput.value);
                    startsPerHourLimit = parseFloat(startsPerHourLimitInput.value);
                    restartInhibitTime = parseFloat(restartInhibitTimeInput.value);
                    thermalAlarmPickupPercent = parseFloat(thermalAlarmPickupPercentInput.value);
                    lockedRotorTripTime = parseFloat(lockedRotorTripTimeInput.value);
                    motorGroundFaultType = motorGroundFaultTypeInput.value;
                    motorGroundFaultPickup = parseFloat(motorGroundFaultPickupInput.value);
                    motorGroundFaultTime = parseFloat(motorGroundFaultTimeInput.value);
                }
                if (transformerSpecificInputsDiv.style.display === 'block') {
                    transformerImpedance_percent = parseFloat(transformerImpedanceInput.value);
                    transformerInrushFactor = parseFloat(transformerInrushFactorInput.value);
                    hvCtPrimary = parseFloat(hvCtPrimaryInput.value);
                    hvCtSecondary = parseFloat(hvCtSecondaryInput.value);
                    lvCtPrimary = parseFloat(lvCtPrimaryInput.value);
                    lvCtSecondary = parseFloat(lvCtSecondaryInput.value);
                    vectorGroup = vectorGroupInput.value;
                    harmonicRestraint2ndPercent = parseFloat(harmonicRestraint2ndPercentInput.value);
                    harmonicRestraint5thPercent = parseFloat(harmonicRestraint5thPercentInput.value);
                    overexcitationPickupVHz = parseFloat(overexcitationPickupVHzInput.value);
                    overexcitationTimeDelay = parseFloat(overexcitationTimeDelayInput.value);
                    lowSetDifferentialPickupPercent = parseFloat(lowSetDifferentialPickupPercentInput.value);
                    lowSetDifferentialTimeDelay = parseFloat(lowSetDifferentialTimeDelayInput.value);
                    unrestrainedDifferentialPickupXFLC = parseFloat(unrestrainedDifferentialPickupXFLCInput.value);
                    unrestrainedDifferentialTime = parseFloat(unrestrainedDifferentialTimeInput.value);
                    restrictedEarthFaultPickup = parseFloat(restrictedEarthFaultPickupInput.value);
                    restrictedEarthFaultTime = parseFloat(restrictedEarthFaultTimeInput.value);
                }
                if (idmtCurveDiv.style.display === 'block') { // Check if IDMT section is visible
                    idmtCurve = idmtCurveInput.value;
                    timeDialSetting = parseFloat(timeDialSettingInput.value);
                    instantaneousTimeDelay = parseFloat(instantaneousTimeDelayInput.value);
                }
                if (advancedRelayInputsDiv.style.display === 'block') { // Check if Advanced Relay section is visible
                    resetTimeFactor = parseFloat(resetTimeFactorInput.value);
                    harmonicBlockingPercent = parseFloat(harmonicBlockingPercentInput.value);
                    ctVtSupervisionEnable = ctVtSupervisionEnableInput.value;
                    breakerFailureTime = parseFloat(breakerFailureTimeInput.value);
                    autoReclosingStages = parseFloat(autoReclosingStagesInput.value);
                    autoReclosingDeadTime = parseFloat(autoReclosingDeadTimeInput.value);
                    syncCheckEnable = syncCheckEnableInput.value;
                    syncCheckVoltageDiff = parseFloat(syncCheckVoltageDiffInput.value);
                    syncCheckAngleDiff = parseFloat(syncCheckAngleDiffInput.value);
                    underVoltagePickup = parseFloat(underVoltagePickupInput.value);
                    underVoltageTime = parseFloat(underVoltageTimeInput.value);
                    overVoltagePickup = parseFloat(overVoltagePickupInput.value);
                    overVoltageTime = parseFloat(overVoltageTimeInput.value);
                    underFrequencyPickup = parseFloat(underFrequencyPickupInput.value);
                    underFrequencyTime = parseFloat(underFrequencyTimeInput.value);
                    overFrequencyPickup = parseFloat(overFrequencyPickupInput.value);
                    overFrequencyTime = parseFloat(overFrequencyTimeInput.value);
                    directionalElementEnable = directionalElementEnableInput.value;
                    if (directionalElementEnable === 'enabled') {
                        directionalCharacteristicAngle = parseFloat(directionalCharacteristicAngleInput.value);
                        directionalPolarizingQuantity = directionalPolarizingQuantityInput.value;
                    }
                }


                // Input Validation (Expanded)
                // General validations
                if (isNaN(voltageRating_kV) || isNaN(kvaKwRating) || isNaN(ptPrimary) || isNaN(ptSecondary) ||
                    isNaN(ctBurden) || ctAccuracyClass.trim() === '' || isNaN(coordinationTimeInterval) || isNaN(dropoutRatioPercent)) {
                    displayMessage("Please fill in all general input fields with valid numbers/values.", "error");
                    return;
                }

                if (equipmentType !== 'transformer') { // General CTs are used for non-transformers
                    if (isNaN(ctRatioPrimary) || isNaN(ctRatioSecondary) || ctRatioPrimary <= 0 || ctRatioSecondary <= 0 || ctRatioPrimary < ctRatioSecondary) {
                        displayMessage("CT Primary and Secondary ratings must be positive, and Primary must be greater than Secondary for general CTs.", "error");
                        return;
                    }
                    if (ctRatioPrimary % ctRatioSecondary !== 0) {
                        displayMessage("Warning: General CT Ratio Primary should ideally be a multiple of CT Ratio Secondary (e.g., 400/5, 800/5).", "warning");
                    }
                }

                if (voltageRating_kV < 0.415 || voltageRating_kV > 220) {
                    displayMessage("Voltage Rating must be between 0.415 kV and 220 kV.", "error");
                    return;
                }
                if (kvaKwRating <= 0) {
                    displayMessage("Equipment Rating must be a positive value.", "error");
                    return;
                }
                if (ptPrimary <= 0 || ptSecondary <= 0 || ptPrimary < ptSecondary) {
                    displayMessage("PT Primary and Secondary ratings must be positive, and Primary must be greater than Secondary.", "error");
                    return;
                }
                if (ctBurden <= 0) {
                    displayMessage("CT Burden must be a positive value.", "error");
                    return;
                }
                if (coordinationTimeInterval <= 0) {
                    displayMessage("Coordination Time Interval must be a positive value.", "error");
                    return;
                }
                if (dropoutRatioPercent < 50 || dropoutRatioPercent > 100) {
                    displayMessage("Dropout Ratio must be between 50% and 100%.", "error");
                    return;
                }

                if (relayApplication === 'overcurrent' || relayApplication === 'earth_fault' || relayApplication === 'motor_protection') {
                    if (isNaN(timeDialSetting) || timeDialSetting <= 0 || timeDialSetting > 1.0) {
                        displayMessage("Time Dial Setting must be between 0.01 and 1.0.", "error");
                        return;
                    }
                    if (isNaN(instantaneousTimeDelay) || instantaneousTimeDelay < 0) {
                         displayMessage("Instantaneous Time Delay must be a non-negative value.", "error");
                         return;
                    }
                }

                // Equipment-specific validations
                if (equipmentType === 'motor') {
                    if (isNaN(powerFactor) || powerFactor <= 0 || powerFactor > 1) { displayMessage("For Motor, Power Factor must be between 0.01 and 1.0.", "error"); return; }
                    if (isNaN(efficiency_percent) || efficiency_percent <= 0 || efficiency_percent > 100) { displayMessage("For Motor, Efficiency must be between 0.01 and 100.0.", "error"); return; }
                    if (isNaN(motorLRAMultiplier) || motorLRAMultiplier <= 0) { displayMessage("Motor LRA Multiplier must be a positive value.", "error"); return; }
                    if (isNaN(motorStartTime) || motorStartTime <= 0) { displayMessage("Motor Start Time must be a positive value.", "error"); return; }
                    if (isNaN(thermalTimeConstant) || thermalTimeConstant <= 0) { displayMessage("Thermal Time Constant must be a positive value.", "error"); return; }
                    if (isNaN(stallProtectionMultiplier) || stallProtectionMultiplier <= 0) { displayMessage("Stall Protection Multiplier must be a positive value.", "error"); return; }
                    if (isNaN(stallProtectionTime) || stallProtectionTime <= 0) { displayMessage("Stall Protection Time must be a positive value.", "error"); return; }
                    if (isNaN(undercurrentPickupPercent) || undercurrentPickupPercent <= 0 || undercurrentPickupPercent > 100) { displayMessage("Undercurrent Pickup must be between 1% and 100%.", "error"); return; }
                    if (isNaN(undercurrentTime) || undercurrentTime <= 0) { displayMessage("Undercurrent Time must be a positive value.", "error"); return; }
                    if (isNaN(negativeSequencePickupPercent) || negativeSequencePickupPercent <= 0 || negativeSequencePickupPercent > 100) { displayMessage("Negative Sequence Overcurrent Pickup must be between 1% and 100%.", "error"); return; }
                    if (isNaN(negativeSequenceTime) || negativeSequenceTime <= 0) { displayMessage("Negative Sequence Overcurrent Time must be a positive value.", "error"); return; }
                    if (isNaN(startsPerHourLimit) || startsPerHourLimit <= 0) { displayMessage("Starts/Hour Limit must be a positive integer.", "error"); return; }
                    if (isNaN(restartInhibitTime) || restartInhibitTime <= 0) { displayMessage("Restart Inhibit Time must be a positive value.", "error"); return; }
                    if (isNaN(thermalAlarmPickupPercent) || thermalAlarmPickupPercent < 100 || thermalAlarmPickupPercent > 120) { displayMessage("Thermal Alarm Pickup must be between 100% and 120%.", "error"); return; }
                    if (isNaN(lockedRotorTripTime) || lockedRotorTripTime <= 0) { displayMessage("Locked Rotor Trip Time must be a positive value.", "error"); return; }
                    if (isNaN(motorGroundFaultPickup) || motorGroundFaultPickup <= 0) { displayMessage("Motor Ground Fault Pickup must be a positive value.", "error"); return; }
                    if (isNaN(motorGroundFaultTime) || motorGroundFaultTime <= 0) { displayMessage("Motor Ground Fault Time must be a positive value.", "error"); return; }
                } else if (equipmentType === 'transformer') {
                    if (isNaN(transformerImpedance_percent) || transformerImpedance_percent <= 0 || transformerImpedance_percent > 20) { displayMessage("For Transformer, Impedance must be between 1% and 20%.", "error"); return; }
                    if (isNaN(transformerInrushFactor) || transformerInrushFactor <= 0) { displayMessage("Transformer Inrush Factor must be a positive value.", "error"); return; }
                    if (isNaN(hvCtPrimary) || isNaN(hvCtSecondary) || hvCtPrimary <= 0 || hvCtSecondary <= 0 || hvCtPrimary < hvCtSecondary) { displayMessage("HV CT Primary and Secondary ratings must be positive, and Primary must be greater than Secondary.", "error"); return; }
                    if (isNaN(lvCtPrimary) || isNaN(lvCtSecondary) || lvCtPrimary <= 0 || lvCtSecondary <= 0 || lvCtPrimary < lvCtSecondary) { displayMessage("LV CT Primary and Secondary ratings must be positive, and Primary must be greater than Secondary.", "error"); return; }
                    if (hvCtPrimary % hvCtSecondary !== 0) { displayMessage("Warning: HV CT Ratio Primary should ideally be a multiple of Secondary.", "warning"); }
                    if (lvCtPrimary % lvCtSecondary !== 0) { displayMessage("Warning: LV CT Ratio Primary should ideally be a multiple of Secondary.", "warning"); }
                    if (vectorGroup.trim() === '') { displayMessage("Transformer Vector Group cannot be empty.", "error"); return; }
                    if (isNaN(harmonicRestraint2ndPercent) || harmonicRestraint2ndPercent < 0 || harmonicRestraint2ndPercent > 100) { displayMessage("2nd Harmonic Restraint must be between 0% and 100%.", "error"); return; }
                    if (isNaN(harmonicRestraint5thPercent) || harmonicRestraint5thPercent < 0 || harmonicRestraint5thPercent > 100) { displayMessage("5th Harmonic Restraint must be between 0% and 100%.", "error"); return; }
                    if (isNaN(overexcitationPickupVHz) || overexcitationPickupVHz <= 0) { displayMessage("Overexcitation Pickup (V/Hz) must be a positive value.", "error"); return; }
                    if (isNaN(overexcitationTimeDelay) || overexcitationTimeDelay < 0) { displayMessage("Overexcitation Time Delay must be a non-negative value.", "error"); return; }
                    if (isNaN(lowSetDifferentialPickupPercent) || lowSetDifferentialPickupPercent <= 0 || lowSetDifferentialPickupPercent > 100) { displayMessage("Low-Set Differential Pickup must be between 1% and 100%.", "error"); return; }
                    if (isNaN(lowSetDifferentialTimeDelay) || lowSetDifferentialTimeDelay < 0) { displayMessage("Low-Set Differential Time Delay must be a non-negative value.", "error"); return; }
                    if (isNaN(unrestrainedDifferentialPickupXFLC) || unrestrainedDifferentialPickupXFLC <= 0) { displayMessage("Unrestrained Differential Pickup must be a positive value.", "error"); return; }
                    if (isNaN(unrestrainedDifferentialTime) || unrestrainedDifferentialTime < 0) { displayMessage("Unrestrained Differential Time must be a non-negative value.", "error"); return; }
                    if (isNaN(restrictedEarthFaultPickup) || restrictedEarthFaultPickup <= 0) { displayMessage("Restricted Earth Fault Pickup must be a positive value.", "error"); return; }
                    if (isNaN(restrictedEarthFaultTime) || restrictedEarthFaultTime <= 0) { displayMessage("Restricted Earth Fault Time must be a positive value.", "error"); return; }
                }

                // Numerical relay specific validations
                if (relayType === 'numerical') {
                    if (isNaN(resetTimeFactor) || resetTimeFactor <= 0 || resetTimeFactor > 1.0) { displayMessage("Reset Time Factor must be between 0.1 and 1.0 for numerical relays.", "error"); return; }
                    if (isNaN(harmonicBlockingPercent) || harmonicBlockingPercent < 0 || harmonicBlockingPercent > 100) { displayMessage("Harmonic Blocking must be between 0% and 100%.", "error"); return; }
                    if (isNaN(breakerFailureTime) || breakerFailureTime <= 0) { displayMessage("Breaker Failure Time must be a positive value.", "error"); return; }
                    if (isNaN(autoReclosingStages) || autoReclosingStages < 0) { displayMessage("Auto-Reclosing Stages must be a non-negative integer.", "error"); return; }
                    if (isNaN(autoReclosingDeadTime) || autoReclosingDeadTime <= 0) { displayMessage("Auto-Reclosing Dead Time must be a positive value.", "error"); return; }
                    if (isNaN(syncCheckVoltageDiff) || syncCheckVoltageDiff < 0) { displayMessage("Sync-Check Voltage Diff must be a non-negative value.", "error"); return; }
                    if (isNaN(syncCheckAngleDiff) || syncCheckAngleDiff < 0 || syncCheckAngleDiff > 180) { displayMessage("Sync-Check Angle Diff must be between 0 and 180 degrees.", "error"); return; }
                    if (isNaN(underVoltagePickup) || underVoltagePickup < 0) { displayMessage("Under Voltage Pickup must be a non-negative value.", "error"); return; }
                    if (isNaN(underVoltageTime) || underVoltageTime < 0) { displayMessage("Under Voltage Time must be a non-negative value.", "error"); return; }
                    if (isNaN(overVoltagePickup) || overVoltagePickup < 0) { displayMessage("Over Voltage Pickup must be a non-negative value.", "error"); return; }
                    if (isNaN(overVoltageTime) || overVoltageTime < 0) { displayMessage("Over Voltage Time must be a non-negative value.", "error"); return; }
                    if (isNaN(underFrequencyPickup) || underFrequencyPickup <= 0) { displayMessage("Under Frequency Pickup must be a positive value.", "error"); return; }
                    if (isNaN(underFrequencyTime) || underFrequencyTime < 0) { displayMessage("Under Frequency Time must be a non-negative value.", "error"); return; }
                    if (isNaN(overFrequencyPickup) || overFrequencyPickup <= 0) { displayMessage("Over Frequency Pickup must be a positive value.", "error"); return; }
                    if (isNaN(overFrequencyTime) || overFrequencyTime < 0) { displayMessage("Over Frequency Time must be a non-negative value.", "error"); return; }
                    if (directionalElementEnable === 'enabled') {
                        if (isNaN(directionalCharacteristicAngle) || directionalCharacteristicAngle < 0 || directionalCharacteristicAngle > 90) { displayMessage("Directional Characteristic Angle must be between 0 and 90 degrees.", "error"); return; }
                        if (directionalPolarizingQuantity.trim() === '') { displayMessage("Directional Polarizing Quantity cannot be empty.", "error"); return; }
                    }
                }


                let calculationHtml = '<h4>Detailed Calculation Steps:</h4>';
                calculationHtml += `<p><strong>1. Input Parameters:</strong></p>`;
                calculationHtml += `<p class="calculation-step">Equipment Type: ${equipmentType}</p>`;
                calculationHtml += `<p class="calculation-step">Voltage Rating: ${voltageRating_kV} kV</p>`;
                calculationHtml += `<p class="calculation-step">Rating: ${kvaKwRating} ${equipmentType === 'motor' ? 'kW' : 'kVA'}</p>`;
                calculationHtml += `<p class="calculation-step">System Grounding: ${systemGrounding.replace(/_/g, ' ').toUpperCase()}</p>`;
                calculationHtml += `<p class="calculation-step">PT Ratio: ${ptPrimary} V / ${ptSecondary} V</p>`;
                calculationHtml += `<p class="calculation-step">CT Burden: ${ctBurden} VA</p>`;
                calculationHtml += `<p class="calculation-step">CT Accuracy Class: ${ctAccuracyClass}</p>`;
                calculationHtml += `<p class="calculation-step">Relay Type: ${relayType}</p>`;
                calculationHtml += `<p class="calculation-step">Relay Application: ${relayApplication}</p>`;
                calculationHtml += `<p class="calculation-step">Coordination Time Interval (CTI): ${coordinationTimeInterval} s</p>`;
                calculationHtml += `<p class="calculation-step">Dropout Ratio: ${dropoutRatioPercent}%</p>`;

                if (relayType === 'numerical') {
                    calculationHtml += `<p class="calculation-step">Reset Time Factor: ${resetTimeFactor}</p>`;
                    calculationHtml += `<p class="calculation-step">Harmonic Blocking: ${harmonicBlockingPercent}%</p>`;
                    calculationHtml += `<p class="calculation-step">CT/VT Supervision: ${ctVtSupervisionEnable.toUpperCase()}</p>`;
                    calculationHtml += `<p class="calculation-step">Breaker Failure Time: ${breakerFailureTime} s</p>`;
                    calculationHtml += `<p class="calculation-step">Auto-Reclosing Stages: ${autoReclosingStages}</p>`;
                    calculationHtml += `<p class="calculation-step">Auto-Reclosing Dead Time: ${autoReclosingDeadTime} s</p>`;
                    calculationHtml += `<p class="calculation-step">Sync-Check: ${syncCheckEnable.toUpperCase()}</p>`;
                    if (syncCheckEnable === 'enabled') {
                        calculationHtml += `<p class="calculation-step">Sync-Check Voltage Diff: ${syncCheckVoltageDiff} V</p>`;
                        calculationHtml += `<p class="calculation-step">Sync-Check Angle Diff: ${syncCheckAngleDiff} deg</p>`;
                    }
                    calculationHtml += `<p class="calculation-step">Under Voltage Pickup: ${underVoltagePickup} V, Time: ${underVoltageTime} s</p>`;
                    calculationHtml += `<p class="calculation-step">Over Voltage Pickup: ${overVoltagePickup} V, Time: ${overVoltageTime} s</p>`;
                    calculationHtml += `<p class="calculation-step">Under Frequency Pickup: ${underFrequencyPickup} Hz, Time: ${underFrequencyTime} s</p>`;
                    calculationHtml += `<p class="calculation-step">Over Frequency Pickup: ${overFrequencyPickup} Hz, Time: ${overFrequencyTime} s</p>`;
                    calculationHtml += `<p class="calculation-step">Directional Element: ${directionalElementEnable.toUpperCase()}</p>`;
                    if (directionalElementEnable === 'enabled') {
                        calculationHtml += `<p class="calculation-step">Directional Characteristic Angle: ${directionalCharacteristicAngle} deg</p>`;
                        calculationHtml += `<p class="calculation-step">Directional Polarizing Quantity: ${directionalPolarizingQuantity.replace(/_/g, ' ').toUpperCase()}</p>`;
                    }
                }


                // Convert kV to V
                const voltageRating_V = voltageRating_kV * 1000;
                const sqrt3 = Math.sqrt(3);

                // Calculate Full Load Current (FLC)
                let fullLoadCurrent_A;
                let ratingUnit;

                if (equipmentType === 'motor') {
                    const efficiency_pu = efficiency_percent / 100;
                    fullLoadCurrent_A = (kvaKwRating * 1000) / (sqrt3 * voltageRating_V * powerFactor * efficiency_pu);
                    ratingUnit = "kW";
                    calculationHtml += `<p class="calculation-step">Power Factor (PF): ${powerFactor}</p>`;
                    calculationHtml += `<p class="calculation-step">Efficiency: ${efficiency_percent}%</p>`;
                    calculationHtml += `<p class="calculation-step">Motor LRA Multiplier: ${motorLRAMultiplier}</p>`;
                    calculationHtml += `<p class="calculation-step">Motor Start Time: ${motorStartTime} s</p>`;
                    calculationHtml += `<p class="calculation-step">Thermal Time Constant: ${thermalTimeConstant} min</p>`;
                    calculationHtml += `<p class="calculation-step">Thermal Curve: ${coldHotCurve}</p>`;
                    calculationHtml += `<p class="calculation-step">Stall Protection Multiplier: ${stallProtectionMultiplier} xFLC</p>`;
                    calculationHtml += `<p class="calculation-step">Stall Protection Time: ${stallProtectionTime} s</p>`;
                    calculationHtml += `<p class="calculation-step">Undercurrent Pickup: ${undercurrentPickupPercent}%FLC</p>`;
                    calculationHtml += `<p class="calculation-step">Undercurrent Time: ${undercurrentTime} s</p>`;
                    calculationHtml += `<p class="calculation-step">Negative Sequence Overcurrent Pickup: ${negativeSequencePickupPercent}%FLC</p>`;
                    calculationHtml += `<p class="calculation-step">Negative Sequence Overcurrent Time: ${negativeSequenceTime} s</p>`;
                    calculationHtml += `<p class="calculation-step">Starts/Hour Limit: ${startsPerHourLimit}</p>`;
                    calculationHtml += `<p class="calculation-step">Restart Inhibit Time: ${restartInhibitTime} min</p>`;
                    calculationHtml += `<p class="calculation-step">Thermal Alarm Pickup: ${thermalAlarmPickupPercent}%FLC</p>`;
                    calculationHtml += `<p class="calculation-step">Locked Rotor Trip Time: ${lockedRotorTripTime} s</p>`;
                    calculationHtml += `<p class="calculation-step">Motor Ground Fault Type: ${motorGroundFaultType.replace(/_/g, ' ').toUpperCase()}</p>`;
                    calculationHtml += `<p class="calculation-step">Motor Ground Fault Pickup (Sec): ${motorGroundFaultPickup} A</p>`;
                    calculationHtml += `<p class="calculation-step">Motor Ground Fault Time: ${motorGroundFaultTime} s</p>`;
                    calculationHtml += `<p><strong>2. Full Load Current (FLC) Calculation (for Motor):</strong></p>`;
                    calculationHtml += `<p class="formula">FLC = (kW * 1000) / (sqrt(3) * Voltage_V * PF * Efficiency)</p>`;
                    calculationHtml += `<p class="calculation-step">FLC = (${kvaKwRating} * 1000) / (${sqrt3.toFixed(3)} * ${voltageRating_V} * ${powerFactor} * ${efficiency_pu.toFixed(2)}) = ${fullLoadCurrent_A.toFixed(2)} A</p>`;
                } else { // Transformer, MCC, PCC
                    fullLoadCurrent_A = (kvaKwRating * 1000) / (sqrt3 * voltageRating_V);
                    ratingUnit = "kVA";
                    if (equipmentType === 'transformer') {
                        calculationHtml += `<p class="calculation-step">Transformer Impedance: ${transformerImpedance_percent}%</p>`;
                        calculationHtml += `<p class="calculation-step">Transformer Inrush Factor: ${transformerInrushFactor}</p>`;
                        calculationHtml += `<p class="calculation-step">HV CT Ratio: ${hvCtPrimary} / ${hvCtSecondary}</p>`;
                        calculationHtml += `<p class="calculation-step">LV CT Ratio: ${lvCtPrimary} / ${lvCtSecondary}</p>`;
                        calculationHtml += `<p class="calculation-step">Vector Group: ${vectorGroup}</p>`;
                        calculationHtml += `<p class="calculation-step">2nd Harmonic Restraint: ${harmonicRestraint2ndPercent}%</p>`;
                        calculationHtml += `<p class="calculation-step">5th Harmonic Restraint: ${harmonicRestraint5thPercent}%</p>`;
                        calculationHtml += `<p class="calculation-step">Overexcitation Pickup: ${overexcitationPickupVHz} V/Hz</p>`;
                        calculationHtml += `<p class="calculation-step">Overexcitation Time Delay: ${overexcitationTimeDelay} s</p>`;
                        calculationHtml += `<p class="calculation-step">Low-Set Differential Pickup: ${lowSetDifferentialPickupPercent}%FLC</p>`;
                        calculationHtml += `<p class="calculation-step">Low-Set Differential Time Delay: ${lowSetDifferentialTimeDelay} s</p>`;
                        calculationHtml += `<p class="calculation-step">Unrestrained Differential Pickup: ${unrestrainedDifferentialPickupXFLC} xFLC</p>`;
                        calculationHtml += `<p class="calculation-step">Unrestrained Differential Time: ${unrestrainedDifferentialTime} s</p>`;
                        calculationHtml += `<p class="calculation-step">Restricted Earth Fault Pickup (Sec): ${restrictedEarthFaultPickup} A</p>`;
                        calculationHtml += `<p class="calculation-step">Restricted Earth Fault Time: ${restrictedEarthFaultTime} s</p>`;
                    }
                    calculationHtml += `<p><strong>2. Full Load Current (FLC) Calculation:</strong></p>`;
                    calculationHtml += `<p class="formula">FLC = (kVA * 1000) / (sqrt(3) * Voltage_V)</p>`;
                    calculationHtml += `<p class="calculation-step">FLC = (${kvaKwRating} * 1000) / (${sqrt3.toFixed(3)} * ${voltageRating_V}) = ${fullLoadCurrent_A.toFixed(2)} A</p>`;
                }

                let ctRatio, flcSecondary_A;
                if (equipmentType === 'transformer') {
                    // For transformer, CT ratio is handled per side for differential
                    ctRatio = null; // Not a single ratio for the whole equipment
                    flcSecondary_A = null; // Not directly applicable in the same way
                    calculationHtml += `<p><strong>3. CT Ratios:</strong></p>`;
                    calculationHtml += `<p class="calculation-step">HV CT Ratio: ${hvCtPrimary} / ${hvCtSecondary} = ${(hvCtPrimary / hvCtSecondary).toFixed(2)}</p>`;
                    calculationHtml += `<p class="calculation-step">LV CT Ratio: ${lvCtPrimary} / ${lvCtSecondary} = ${(lvCtPrimary / lvCtSecondary).toFixed(2)}</p>`;
                } else {
                    ctRatio = ctRatioPrimary / ctRatioSecondary;
                    flcSecondary_A = fullLoadCurrent_A / ctRatio;
                    calculationHtml += `<p><strong>3. CT Ratio Calculation:</strong></p>`;
                    calculationHtml += `<p class="formula">CT Ratio = CT Primary / CT Secondary</p>`;
                    calculationHtml += `<p class="calculation-step">CT Ratio = ${ctRatioPrimary} / ${ctRatioSecondary} = ${ctRatio}</p>`;
                    calculationHtml += `<p class="calculation-step">FLC Secondary = FLC Primary / CT Ratio = ${fullLoadCurrent_A.toFixed(2)} A / ${ctRatio} = ${flcSecondary_A.toFixed(2)} A</p>`;
                }

                // Initialize results table
                resultTableBody.innerHTML = '';
                addResultRow("Equipment Type", equipmentType.charAt(0).toUpperCase() + equipmentType.slice(1), "", "");
                addResultRow("Voltage Level", `${voltageRating_kV} kV`, "", "");
                addResultRow("Rating", `${kvaKwRating} ${ratingUnit}`, "", "");
                addResultRow("Full Load Current (FLC) Primary", fullLoadCurrent_A.toFixed(2), "A", "This is the continuous current drawn by the equipment at its rated power and voltage.");
                if (equipmentType !== 'transformer') {
                    addResultRow("Full Load Current (FLC) Secondary (CT Side)", flcSecondary_A.toFixed(2), "A", "The current seen by the relay on its secondary side, derived from the primary FLC and CT ratio.");
                    addResultRow("CT Ratio", ctRatio, "", `The ratio of CT Primary (${ctRatioPrimary} A) to CT Secondary (${ctRatioSecondary} A). This scales the primary current down for the relay.`);
                } else {
                    addResultRow("HV CT Ratio", `${hvCtPrimary / hvCtSecondary}`, "", `The ratio of CT Primary (${hvCtPrimary} A) to CT Secondary (${hvCtSecondary} A) on the High Voltage side.`);
                    addResultRow("LV CT Ratio", `${lvCtPrimary / lvCtSecondary}`, "", `The ratio of CT Primary (${lvCtPrimary} A) to CT Secondary (${lvCtSecondary} A) on the Low Voltage side.`);
                }
                addResultRow("PT Ratio", `${ptPrimary / ptSecondary}`, "", `The ratio of PT Primary (${ptPrimary} V) to PT Secondary (${ptSecondary} V). This scales the primary voltage down for the relay.`);
                addResultRow("System Grounding", systemGrounding.replace(/_/g, ' ').toUpperCase(), "", "The grounding method influences earth fault current magnitudes and protection strategies.");
                addResultRow("CT Burden", ctBurden, "VA", "The total load on the CT secondary. Ensure this is within the CT's rated burden to maintain accuracy.");
                addResultRow("CT Accuracy Class", ctAccuracyClass, "", "Indicates the accuracy of the CT under fault conditions. Important for proper relay operation.");
                addResultRow("Relay Type", relayType.charAt(0).toUpperCase() + relayType.slice(1), "", "Numerical relays offer more advanced functions and flexibility compared to electro-mechanical.");
                addResultRow("Relay Application", relayApplication.replace(/_/g, ' ').toUpperCase(), "", "The primary protection function the relay is configured for.");
                addResultRow("Coordination Time Interval (CTI)", coordinationTimeInterval.toFixed(2), "s", "The minimum time difference required between successive protective devices to ensure the closest device operates first and clears the fault.");
                addResultRow("Dropout Ratio", `${dropoutRatioPercent}%`, "", "The percentage of pickup current at which the relay resets (drops out). A higher ratio indicates faster resetting, which is beneficial for reclosing operations.");


                // Relay Settings based on Application
                switch (relayApplication) {
                    case 'overcurrent':
                    case 'earth_fault':
                    case 'motor_protection':
                        // Common calculations for IDMT-based relays
                        let pickupMultiplier, instMultiplier;
                        let instTimeDelayNote = "";
                        let notes = "";
                        let applicationSpecificDetails = "";

                        if (relayApplication === 'overcurrent') {
                            pickupMultiplier = 1.25; // 125% of FLC
                            instMultiplier = 8; // 8 times FLC for instantaneous (50)
                            notes = "Typically set between 120% to 150% of FLC for phase overcurrent. This ensures the relay does not trip on normal load fluctuations or permissible overloads, but operates for sustained overcurrents.";
                            instTimeDelayNote = "Usually set to 0 for true instantaneous operation to clear high-magnitude faults as quickly as possible. A small time delay (e.g., 0.05s) might be added for coordination with very fast downstream devices or to override transient conditions.";
                            applicationSpecificDetails = "Phase Overcurrent Protection (ANSI 51/50)";
                        } else if (relayApplication === 'earth_fault') {
                            // Earth fault pickup depends on grounding type
                            if (systemGrounding === 'solidly_grounded') {
                                pickupMultiplier = 0.15; // 15% of FLC for sensitive earth fault
                                notes = `Typically ${Math.round(pickupMultiplier * 100)}% of FLC. For solidly grounded systems, earth fault currents can be very high, so a sensitive pickup is important. Set above residual load unbalance and below minimum fault current.`;
                            } else if (systemGrounding === 'resistance_grounded') {
                                pickupMultiplier = 0.05; // Lower for resistance grounded
                                notes = `Typically ${Math.round(pickupMultiplier * 100)}% of FLC. For resistance grounded systems, earth fault currents are intentionally limited, requiring a very sensitive pickup.`;
                            } else { // Ungrounded
                                pickupMultiplier = 0.02; // Very low, often not used or specific high-impedance relay
                                notes = `Typically ${Math.round(pickupMultiplier * 100)}% of FLC. For ungrounded systems, earth fault currents are very low (capacitive), and detection often requires specialized high-impedance ground fault relays or voltage-based protection. This setting is for general guidance only.`;
                            }
                            instMultiplier = 2; // 2 times FLC for instantaneous earth fault
                            instTimeDelayNote = "Usually set to 0 for true instantaneous operation to clear earth faults quickly. Earth faults are often severe and require immediate isolation.";
                            applicationSpecificDetails = `Earth Fault Protection (ANSI 51N/50N) for ${systemGrounding.replace(/_/g, ' ').toLowerCase()} system`;
                        } else if (relayApplication === 'motor_protection') {
                            // Overload (49) - Thermal protection
                            pickupMultiplier = 1.15; // 115% of FLC for thermal overload
                            // Instantaneous (50) - Short circuit
                            instMultiplier = motorLRAMultiplier * 1.2; // 120% of LRA
                            notes = "Overload (49) setting for thermal protection. Typically set between 110% to 125% of FLC. This setting protects the motor from sustained overcurrents that could lead to overheating and damage. It should be set above FLC but below the motor's thermal damage curve.";
                            instTimeDelayNote = `The instantaneous element (50) is for short-circuit protection. It must be set above the motor's locked rotor current (LRA = ${motorLRAMultiplier}x FLC) to avoid nuisance tripping during start-up. A common practice is to set it at 120% of LRA. The time delay is usually 0, but a small delay might be introduced if coordination with very fast downstream devices (e.g., motor starters) is needed, or to allow the motor to clear its own starting transient (${motorStartTime} s).`;
                            applicationSpecificDetails = "Comprehensive Motor Protection (ANSI 49/51/50/46)";
                        }

                        const primaryPickupCurrent_A = fullLoadCurrent_A * pickupMultiplier;
                        const secondaryPickupCurrent_A = primaryPickupCurrent_A / ctRatio;
                        const primaryInstPickup_A = fullLoadCurrent_A * instMultiplier;
                        const secondaryInstPickup_A = primaryInstPickup_A / ctRatio;

                        calculationHtml += `<p><strong>4. ${applicationSpecificDetails} Settings:</strong></p>`;
                        calculationHtml += `<p><strong>Time-Overcurrent (51) Pickup Setting:</strong></p>`;
                        calculationHtml += `<p class="formula">Pickup Current (Primary) = FLC * Pickup Multiplier</p>`;
                        calculationHtml += `<p class="calculation-step">Pickup Current (Primary) = ${fullLoadCurrent_A.toFixed(2)} A * ${pickupMultiplier} = ${primaryPickupCurrent_A.toFixed(2)} A</p>`;
                        calculationHtml += `<p class="formula">Pickup Current (Secondary) = Pickup Current (Primary) / CT Ratio</p>`;
                        calculationHtml += `<p class="calculation-step">Pickup Current (Secondary) = ${primaryPickupCurrent_A.toFixed(2)} A / ${ctRatio} = ${secondaryPickupCurrent_A.toFixed(2)} A</p>`;

                        calculationHtml += `<p><strong>Instantaneous (50) Pickup Setting:</strong></p>`;
                        calculationHtml += `<p class="formula">Instantaneous Pickup (Primary) = FLC * Instantaneous Multiplier</p>`;
                        calculationHtml += `<p class="calculation-step">Instantaneous Pickup (Primary) = ${fullLoadCurrent_A.toFixed(2)} A * ${instMultiplier} = ${primaryInstPickup_A.toFixed(2)} A</p>`;
                        calculationHtml += `<p class="formula">Instantaneous Pickup (Secondary) = Instantaneous Pickup (Primary) / CT Ratio</p>`;
                        calculationHtml += `<p class="calculation-step">Instantaneous Pickup (Secondary) = ${primaryInstPickup_A.toFixed(2)} A / ${ctRatio} = ${secondaryInstPickup_A.toFixed(2)} A</p>`;


                        addResultRow("Time Overcurrent (51) Pickup (Primary)", primaryPickupCurrent_A.toFixed(2), "A", notes);
                        addResultRow("Time Overcurrent (51) Pickup (Secondary)", secondaryPickupCurrent_A.toFixed(2), "A", "This is the actual current setting you will enter into the relay. Ensure it's within the relay's setting range.");
                        addResultRow("IDMT Curve Type", idmtCurve.replace(/_/g, ' ').toUpperCase(), "", "The selected curve determines the inverse relationship between current and time. Choose based on coordination requirements and protected equipment characteristics.");
                        addResultRow("Time Dial Setting (TDS)", timeDialSetting.toFixed(2), "", "This factor scales the operating time of the IDMT curve. Adjust TDS to achieve proper coordination time intervals (CTI) with upstream and downstream protective devices.");
                        addResultRow("Instantaneous (50) Pickup (Primary)", primaryInstPickup_A.toFixed(2), "A", "Provides very fast fault clearing for high-magnitude faults. Set above maximum downstream fault current to maintain selectivity with downstream devices (e.g., motor starters, branch circuit breakers).");
                        addResultRow("Instantaneous (50) Pickup (Secondary)", secondaryInstPickup_A.toFixed(2), "A", "This is the actual current setting for the instantaneous element in the relay.");
                        addResultRow("Instantaneous (50) Time Delay", instantaneousTimeDelay.toFixed(3), "s", instTimeDelayNote);

                        // Example trip time for a fault current (e.g., 5 times secondary pickup)
                        const sampleFaultCurrentMultiple = 5;
                        const sampleTripCurrent_A = secondaryPickupCurrent_A * sampleFaultCurrentMultiple;
                        const calculatedTripTime_s = calculateTripTime(sampleFaultCurrentMultiple, timeDialSetting, idmtCurve);
                        
                        calculationHtml += `<p><strong>6. Sample Trip Time Calculation (IDMT):</strong></p>`;
                        calculationHtml += `<p class="formula">Trip Time = f(Current Multiple, TDS, Curve Type)</p>`;
                        calculationHtml += `<p class="calculation-step">For a fault current of ${sampleFaultCurrentMultiple} times secondary pickup (${sampleTripCurrent_A.toFixed(2)} A):</p>`;
                        calculationHtml += `<p class="calculation-step">Calculated Trip Time = ${calculatedTripTime_s.toFixed(3)} s</p>`;

                        addResultRow(`Sample Trip Time @ ${sampleFaultCurrentMultiple}x Pickup`, calculatedTripTime_s.toFixed(3), "s", `This is an example of the relay's trip time for a fault current of ${sampleTripCurrent_A.toFixed(2)} A (secondary). This helps in visualizing the curve's response.`);

                        // Additional "minute parameters" for numerical relays
                        if (relayType === 'numerical') {
                            addResultRow("Reset Time Factor", resetTimeFactor.toFixed(2), "", "For numerical relays, this factor (typically close to 1.0) influences how quickly the relay resets after a fault clears. A higher factor means faster reset, beneficial for auto-reclosing.");
                            addResultRow("Harmonic Blocking", `${harmonicBlockingPercent}%`, "", "This feature blocks the overcurrent element from tripping if the harmonic content (e.g., 2nd harmonic) in the current exceeds this percentage. Useful for preventing nuisance trips during transformer energization or other harmonic-rich transients.");
                            addResultRow("CT/VT Supervision (60)", ctVtSupervisionEnable.charAt(0).toUpperCase() + ctVtSupervisionEnable.slice(1), "", "Monitors the integrity of CT and VT circuits. If enabled, it can block protection functions or issue an alarm if an open or short circuit is detected, preventing false trips or missed operations.");
                            addResultRow("Breaker Failure (50BF/62BF) Time", breakerFailureTime.toFixed(2), "s", "If the local breaker fails to clear a fault within this time after receiving a trip command, this element initiates a trip command to upstream (backup) breakers to isolate the fault.");
                            addResultRow("Auto-Reclosing (79) Stages", autoReclosingStages, "", "The number of automatic reclosing attempts the breaker will make after a trip. Used to restore service quickly for transient faults (e.g., lightning strikes).");
                            addResultRow("Auto-Reclosing (79) Dead Time", autoReclosingDeadTime.toFixed(2), "s", "The time interval after a trip during which the breaker remains open before making a reclose attempt. This allows the fault arc to de-ionize.");
                            addResultRow("Sync-Check (25)", syncCheckEnable.charAt(0).toUpperCase() + syncCheckEnable.slice(1), "", "Ensures that the power system on both sides of the breaker is synchronized (matching voltage, frequency, and phase angle) before allowing the breaker to close. Prevents out-of-phase closing.");
                            if (syncCheckEnable === 'enabled') {
                                addResultRow("Sync-Check Voltage Diff", syncCheckVoltageDiff.toFixed(1), "V", "The maximum permissible voltage difference between the two sides of the breaker for sync-check to allow closing.");
                                addResultRow("Sync-Check Angle Diff", syncCheckAngleDiff.toFixed(1), "deg", "The maximum permissible phase angle difference between the two sides of the breaker for sync-check to allow closing.");
                            }
                            addResultRow("Under Voltage (27) Pickup", underVoltagePickup.toFixed(1), "V", "The secondary voltage level below which the under-voltage element will pick up. Used for load shedding, motor protection, or system integrity.");
                            addResultRow("Under Voltage (27) Time", underVoltageTime.toFixed(1), "s", "The time delay for the under-voltage trip. Allows for momentary voltage dips without tripping.");
                            addResultRow("Over Voltage (59) Pickup", overVoltagePickup.toFixed(1), "V", "The secondary voltage level above which the over-voltage element will pick up. Protects equipment from insulation degradation due to sustained high voltage.");
                            addResultRow("Over Voltage (59) Time", overVoltageTime.toFixed(1), "s", "The time delay for the over-voltage trip. Prevents tripping on transient overvoltages.");
                            addResultRow("Under Frequency (81U) Pickup", underFrequencyPickup.toFixed(2), "Hz", "The frequency level below which the under-frequency element will pick up. Used for load shedding to prevent system collapse during generation shortfalls.");
                            addResultRow("Under Frequency (81U) Time", underFrequencyTime.toFixed(2), "s", "The time delay for the under-frequency trip. Allows for momentary frequency dips.");
                            addResultRow("Over Frequency (81O) Pickup", overFrequencyPickup.toFixed(2), "Hz", "The frequency level above which the over-frequency element will pick up. Protects equipment from damage due to excessively high frequency.");
                            addResultRow("Over Frequency (81O) Time", overFrequencyTime.toFixed(2), "s", "The time delay for the over-frequency trip. Allows for momentary frequency excursions.");
                            addResultRow("Directional Element (67/67N)", directionalElementEnable.charAt(0).toUpperCase() + directionalElementEnable.slice(1), "", "When enabled, the relay can determine the direction of fault current flow. This is essential for selective tripping in meshed or looped systems, ensuring only the faulted section is isolated.");
                            if (directionalElementEnable === 'enabled') {
                                addResultRow("Directional Characteristic Angle", directionalCharacteristicAngle.toFixed(1), "deg", "The angle at which the relay has maximum sensitivity for directional detection. It depends on the system impedance angle and fault type.");
                                addResultRow("Directional Polarizing Quantity", directionalPolarizingQuantity.replace(/_/g, ' ').toUpperCase(), "", "The voltage or current used by the directional element as a reference to determine the fault direction.");
                            }
                        } else { // Electro-mechanical
                            addResultRow("Current Plug Setting (PS)", feederSecondaryPickup_A.toFixed(2), "A", "For electro-mechanical relays, this is the tap setting on the relay coil that determines the pickup current. It's the equivalent of the secondary pickup current.");
                            addResultRow("Instantaneous Unit Setting", feederSecondaryInstPickup_A.toFixed(2), "A", "A separate instantaneous unit on EM relays that operates with minimal time delay. Its setting is usually adjustable via a dial or taps.");
                            addResultRow("Auxiliary Lockout Relay (86)", "Recommended", "", "An external auxiliary relay used with electro-mechanical relays to provide a mechanical lockout function, preventing re-closure until manually reset. This ensures safety after a trip.");
                            addResultRow("Reset Time", "Instantaneous", "", "Electro-mechanical relays typically have an instantaneous reset characteristic, meaning they reset immediately when the current drops below the dropout level.");
                        }
                        break;

                    default:
                        displayMessage("Unknown relay application selected.", "error");
                        return;
                }

                // Standard Reference
                let standardRefText = `
                    <h4>International Standards Compliance & Best Practices:</h4>
                    <p>This calculator provides guidance based on principles and methodologies aligned with the following international standards and industry best practices for power system protection:</p>
                    <ul>
                        <li><strong>IEEE C37.112: IEEE Standard for Inverse-Time Characteristics for Overcurrent Relays.</strong> This standard defines the characteristics of inverse-time overcurrent relays, which are fundamental for time-current coordination.</li>
                        <li><strong>IEC 60255 Series: Measuring Relays and Protection Equipment.</strong> This comprehensive series covers various aspects of measuring relays and protection equipment, including functional requirements, performance, and testing.</li>
                        <li><strong>IEEE Std 242: IEEE Recommended Practice for Protection and Coordination of Industrial and Commercial Power Systems (Buff Book).</strong> Provides detailed guidance on the application and coordination of protective devices.</li>
                        <li><strong>IEC 60909: Short-circuit currents in three-phase a.c. systems.</strong> While this calculator does not perform short-circuit calculations, understanding fault currents (derived from system impedance) is crucial for accurate relay settings, as covered by this standard.</li>
                        <li><strong>IEEE Std 141: IEEE Recommended Practice for Electric Power Distribution for Industrial Plants (Red Book).</strong> Offers recommendations for the design and protection of industrial power distribution systems.</li>
                        <li><strong>IEC 61850: Communication Networks and Systems for Power Utility Automation.</strong> Relevant for modern numerical relays, though not directly used in setting calculations, it defines communication protocols for these devices.</li>
                        <li><strong>ANSI/IEEE C37.90: IEEE Standard for Relays and Relay Systems Associated with Electric Power Apparatus.</strong> Covers general requirements for protective relays.</li>
                        <li><strong>ANSI/IEEE C57.12.00: IEEE Standard for General Requirements for Liquid-Immersed Distribution, Power, and Regulating Transformers.</strong> Provides context for transformer characteristics relevant to protection.</li>
                        <li><strong>NEMA MG 1: Motors and Generators.</strong> Provides motor characteristics relevant to protection.</li>
                    </ul>
                    <p><strong>OEM-Specific Considerations:</strong> Modern numerical relays from manufacturers like ABB (e.g., Relion series), Siemens (e.g., SIPROTEC series), GE (e.g., Multilin series), and SEL (Schweitzer Engineering Laboratories) offer highly customizable and advanced features. The parameters provided here are typical, but specific relay models may have different ranges, curve types, and additional functionalities (e.g., adaptive settings, logic schemes, communication protocols, advanced metering). Always refer to the specific relay's instruction manual and software for precise setting capabilities and detailed application guidelines.</p>
                    <p>It is crucial to note that while this tool provides a robust preliminary assessment, actual relay coordination is a complex engineering task. It requires detailed system studies, short-circuit analysis, and often specialized software (e.g., ETAP, SKM PowerTools, DIgSILENT PowerFactory) to ensure proper protection, selectivity, and reliability of the power system. Always consult relevant standards, manufacturer's manuals, and qualified protection engineers for final settings and commissioning.</p>
                `;
                standardReference.innerHTML = standardRefText;

                calculationDetailsDiv.innerHTML = calculationHtml; // Insert detailed steps
                resultContainer.style.display = 'block';
                setTimeout(() => {
                    resultContainer.classList.add('show');
                    calculationDetailsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' }); // Scroll to calculation details
                }, 10);
                displayMessage("Relay settings calculated successfully!", "info");
            }

            // Event Listeners
            calculateBtn.addEventListener('click', calculateRelaySettings);
            resetFormBtn.addEventListener('click', resetForm);
            clearResultsBtn.addEventListener('click', clearResults);

            // Initial fade-in for form sections
            const formSections = document.querySelectorAll('.form-section');
            formSections.forEach((section, index) => {
                setTimeout(() => {
                    section.classList.add('fade-in');
                }, 100 * index); // Staggered fade-in
            });

            // Theme switch logic
            const themeSwitch = document.getElementById('theme-switch');
            if (themeSwitch) {
                if (localStorage.getItem('theme') === 'dark') {
                    document.body.classList.add('dark-mode');
                    themeSwitch.checked = true;
                }

                themeSwitch.addEventListener('change', function() {
                    if (this.checked) {
                        document.body.classList.add('dark-mode');
                        localStorage.setItem('theme', 'dark');
                    } else {
                        document.body.classList.remove('dark-mode');
                        localStorage.setItem('theme', 'light');
                    }
                });
            }

            // Initial call to set correct input field visibility
            updateInputFieldsVisibility();
        });
    </script>
</body>

</html>


