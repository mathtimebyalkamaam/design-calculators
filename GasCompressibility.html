<!DOCTYPE html>
<html lang="en">
<head>
    <!-- AdSense & Analytics -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5936527763614780" crossorigin="anonymous"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-23Y1V450SR"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-23Y1V450SR');
    </script>
    
    <!-- SEO Meta Tags -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gas Compressibility Factor (Z) Calculator - Industrial Equation of State</title>
    <meta name="description" content="Professional Gas Compressibility Factor (Z) Calculator. Solves Peng-Robinson, Redlich-Kwong, and CNGA equations. Calculates Real Gas Density, Supercompressibility (Fpv), and Critical Properties for Natural Gas custody transfer.">
    <meta name="keywords" content="z-factor calculator, gas compressibility, peng-robinson equation, redlich-kwong, natural gas density, Fpv factor, AGA 8, real gas law, critical pressure temperature, standing correlation">
    <meta name="author" content="Design Calculators">
    <meta name="robots" content="index, follow">

    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Montserrat:wght@700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>

    <!-- Chart.js for Visuals -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1/dist/chartjs-plugin-annotation.min.js"></script>

    <!-- MathJax for Formulas -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['\\(', '\\)'], ['$', '$']],
                displayMath: [['\\[', '\\]'], ['$$', '$$']]
            },
            svg: { fontCache: 'global' }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <!-- Favicon Links -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">

    <style>
        /* --- CORE THEME (Blue Industrial - Matching Symmetrical Components) --- */
        :root {
            --primary: #1E3A8A; /* Dark Blue */
            --secondary: #2563EB; /* Bright Blue */
            --accent: #F59E0B; /* Amber */
            --success: #10B981;
            --danger: #DC2626;
            --warning: #F59E0B;
            --bg: #F8FAFC;
            --card: #FFFFFF;
            --text: #4B5563;
            --heading: #111827;
            --footer-bg: #0F172A;
            --border: #E2E8F0;
            --grad: linear-gradient(135deg, var(--primary), var(--secondary));
            --grad-dark: linear-gradient(135deg, #0F172A, #1E293B);
            --shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        body.dark-mode {
            --primary: #10B981;
            --secondary: #34D399;
            --bg: #0F172A;
            --card: #1E293B;
            --text: #CBD5E1;
            --heading: #F1F5F9;
            --footer-bg: #020617;
            --border: #334155;
            --accent: #F59E0B;
        }

        * { box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.7;
            margin: 0;
            padding: 0;
        }

        .container { max-width: 1280px; margin: 0 auto; padding: 0 24px; }

        /* Header & Nav */
        header {
            background: var(--grad);
            color: white;
            padding: 24px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo-container {
            display: flex;
            flex-direction: column;
            text-decoration: none;
            color: white;
        }
        .logo-text {
            font-size: 1.75rem;
            font-weight: 800;
            font-family: 'Montserrat', sans-serif;
        }
        .logo-subtitle {
            font-size: 0.8rem;
            margin: 4px 0 0 0;
            color: #E0E7FF;
            opacity: 0.9;
        }
        .nav-links {
            display: flex;
            gap: 24px;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        .nav-links a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }
        .nav-links a:hover { color: var(--accent); }
        
        /* Theme Toggle */
        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
            color: white;
        }
        .switch {
            position: relative;
            width: 56px;
            height: 30px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0,0,0,0.2);
            transition: .4s;
            border-radius: 30px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 22px; width: 22px;
            left: 4px; bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(26px); }

        /* Main Content & Cards */
        main { padding: 40px 0; }
        .card {
            background: var(--card);
            border-radius: 12px;
            padding: 30px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            border: 1px solid var(--border);
            animation: fadeIn 0.6s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .card h2 {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
            padding-bottom: 15px;
            margin-top: 0;
            font-family: 'Montserrat', sans-serif;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        h3 {
            color: var(--heading);
            font-family: 'Montserrat', sans-serif;
            font-size: 1.5rem;
            margin-top: 25px;
            margin-bottom: 20px;
        }

        /* Forms */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .form-group { margin-bottom: 0; }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--heading);
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 6px;
            background-color: var(--bg);
            color: var(--text);
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        .form-group input:focus, .form-group select:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
        }
        body.dark-mode .form-group input:focus { 
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        /* Buttons */
        .btn {
            background: var(--grad);
            color: white;
            border: none;
            padding: 16px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(30, 58, 138, 0.3);
            transition: all 0.3s;
            width: 100%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(30, 58, 138, 0.4);
        }
        .btn-outline {
            background: transparent;
            border: 2px solid var(--secondary);
            color: var(--secondary);
            font-size: 0.9rem;
            padding: 8px 16px;
        }
        .btn-outline:hover {
            background: var(--secondary);
            color: white;
        }
        .button-wrapper {
            display: flex;
            justify-content: center;
            width: 100%;
            padding-top: 15px;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        /* Quick Load Buttons */
        .preset-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        .preset-btn {
            padding: 8px 12px;
            font-size: 0.85rem;
            border: 1px solid var(--border);
            background: var(--card);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .preset-btn:hover {
            background: var(--bg);
            border-color: var(--secondary);
            color: var(--secondary);
        }

        /* Results Layout */
        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            align-items: start;
        }
        @media (max-width: 1024px) {
            .results-grid { grid-template-columns: 1fr; }
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-radius: 8px;
            overflow: hidden;
        }
        .results-table th, .results-table td {
            padding: 14px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        .results-table th {
            background: var(--grad);
            color: white;
            font-weight: 700;
        }
        .results-table tr:nth-child(even) { background-color: var(--bg); }
        .results-table td:first-child {
            font-weight: 600;
            color: var(--heading);
        }
        .highlight { color: var(--success); font-weight: 700; }
        .danger-text { color: var(--danger); font-weight: 700; }

        /* Canvas Container */
        .chart-container {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            position: relative;
            height: 400px;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        canvas {
            max-width: 100%;
            max-height: 100%;
        }

        /* Educational Section Styling */
        .insight-card {
            background: linear-gradient(135deg, var(--card), rgba(37,99,235,0.03));
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            border-left: 5px solid var(--secondary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: all 0.3s;
        }
        .insight-card:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .insight-card h4 {
            color: var(--secondary);
            font-size: 1.3rem;
            margin: 0 0 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: 'Montserrat', sans-serif;
        }
        .insight-card p, .insight-card ul {
            margin: 10px 0;
            line-height: 1.8;
            color: var(--text);
        }
        .insight-card ul { padding-left: 20px; }
        .insight-card li { margin-bottom: 8px; }

        /* Formulas & Steps */
        .formula {
            background: var(--bg);
            border-left: 3px solid var(--accent);
            padding: 15px;
            margin: 12px 0;
            font-size: 1.1rem;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
            color: var(--heading);
        }
        .calculation-step {
            font-family: 'Courier New', monospace;
            background-color: rgba(0,0,0,0.03);
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            border-left: 4px solid var(--success);
            font-size: 0.95rem;
            line-height: 1.6;
        }
        body.dark-mode .calculation-step { background-color: rgba(255,255,255,0.05); }

        /* Vector Input Group Styling (Reused) */
        .vector-input-group {
            background: var(--bg);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border);
            position: relative;
        }
        .vector-input-header {
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Particle System for Gas Visual */
        #gasCanvas {
            width: 100%;
            height: 100%;
            background: var(--card);
        }
        
        /* Print Styling */
        @media print {
            header, footer, .education-section, .theme-toggle, .button-wrapper, .preset-container { display: none !important; }
            .card { border: none; shadow: none; padding: 0; }
            .container { width: 100%; max-width: 100%; padding: 0; }
            .results-grid { grid-template-columns: 1fr 1fr; }
            .chart-container { height: 300px; page-break-inside: avoid; }
        }

        /* Message Box */
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 16px 28px;
            border-radius: 8px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.25);
            z-index: 10000;
            font-weight: 600;
            color: white;
            opacity: 0;
            transition: all 0.4s;
            display: none;
        }
        .message-box.show { display: block; opacity: 1; top: 30px; }
        .hidden { display: none; }

        /* Tooltip */
        .info-icon { color: var(--secondary); margin-left: 5px; cursor: help; }
        .tooltip { position: relative; display: inline-block; }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 220px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -110px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.85rem;
            font-weight: 400;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }

        /* Footer */
        footer {
            background: var(--grad-dark);
            color: #CBD5E1;
            padding: 50px 0 20px 0;
            margin-top: 60px;
        }
        .footer-content {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 40px;
            margin-bottom: 30px;
        }
        .footer-col { flex: 1; min-width: 200px; }
        .footer-col h4 { color: white; margin-bottom: 15px; font-weight: 700; }
        .footer-col ul { list-style: none; padding: 0; margin: 0; }
        .footer-col a { color: #CBD5E1; text-decoration: none; transition: color 0.3s; }
        .footer-col a:hover { color: var(--accent); }
        .social-buttons { display: flex; gap: 12px; margin-top: 15px; }
        .social-btn {
            width: 40px; height: 40px;
            display: flex; justify-content: center; align-items: center;
            color: white; border-radius: 50%;
            font-size: 1.1rem; transition: transform 0.3s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .social-btn:hover { transform: translateY(-4px); }
        .social-btn.linkedin { background-color: #0A66C2; }
        .social-btn.youtube { background-color: #FF0000; }
        .social-btn.twitter { background-color: #1DA1F2; }
        .social-btn.facebook { background-color: #1877F2; }
        .social-btn.whatsapp { background-color: #25D366; }
        .footer-disclaimer {
            text-align: center; padding-top: 25px;
            border-top: 1px solid #334155;
            max-width: 800px; margin: 0 auto;
            font-size: 0.9rem;
        }
        .footer-bottom {
            text-align: center; padding-top: 20px;
            font-size: 0.9rem; color: #94A3B8;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container { padding: 0 15px; }
            .navbar { flex-direction: column; gap: 20px; }
            .nav-links { flex-direction: column; gap: 12px; text-align: center; }
            .form-row { grid-template-columns: 1fr; }
            .card { padding: 20px; }
            .footer-content { flex-direction: column; gap: 25px; }
        }
    </style>
</head>
<body>
    <div id="message-box" class="message-box"></div>
    <header>
        <div class="container">
            <nav class="navbar">
                <a href="#" class="logo-container">
                    <span class="logo-text">Design Calculators</span>
                    <p class="logo-subtitle">Inspired by standards such as IEC, IEEE, ISA, ASME, and API.</p>
                </a>
                <ul class="nav-links">
                    <li><a href='/'>Home</a></li>
                    <li><a href="articles">Articles</a></li>
                    <li><a href="indexmech">Mechanical</a></li>
                    <li><a href="indexele">Electrical</a></li>
                    <li><a href="indexinst">Instrumentation</a></li>
                </ul>
                <div class="theme-toggle">
                    <i class="fas fa-sun"></i>
                    <label class="switch">
                        <input type="checkbox" id="theme-switch">
                        <span class="slider"></span>
                    </label>
                    <i class="fas fa-moon"></i>
                </div>
            </nav>
        </div>
    </header>

    <main class="container">
        <div class="card">
            <h2><i class="fas fa-compress-arrows-alt"></i> Gas Compressibility Factor (Z) Calculator</h2>
            
            <div class="tool-description">
                <p>This industrial-grade calculator solves the <strong>Equation of State (EOS)</strong> for Natural Gas and industrial gases. It calculates the <strong>Compressibility Factor ($Z$)</strong>, <strong>Real Gas Density</strong>, and <strong>Supercompressibility ($F_{pv}$)</strong> using Peng-Robinson, Redlich-Kwong, or CNGA methods. Essential for Custody Transfer Flow Measurement (AGA 3/7/8).</p>
            </div>

            <div class="calculator-form">
                <form id="z-form">
                    <!-- Controls Row -->
                    <div class="form-row" style="align-items: end;">
                        <div class="form-group">
                            <label>Quick Load Scenarios:</label>
                            <div class="preset-container" style="margin-bottom: 0;">
                                <button type="button" class="preset-btn" onclick="loadPreset('methane_high')"><i class="fas fa-fire"></i> High Pressure Methane</button>
                                <button type="button" class="preset-btn" onclick="loadPreset('natgas_pipeline')"><i class="fas fa-industry"></i> Pipeline Nat Gas (0.6 SG)</button>
                                <button type="button" class="preset-btn" onclick="loadPreset('nitrogen_purge')"><i class="fas fa-wind"></i> Nitrogen Purge</button>
                            </div>
                        </div>
                    </div>

                    <!-- Fluid Selection -->
                    <h4 style="color: var(--primary); margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 5px;">1. Fluid Composition</h4>
                    <div class="form-row">
                        <div class="vector-input-group">
                            <div class="vector-input-header"><i class="fas fa-flask"></i> Gas Type</div>
                            <div class="form-group">
                                <label for="gas-select">Select Gas / Mixture</label>
                                <select id="gas-select" onchange="updateGasInputs()">
                                    <option value="methane" selected>Methane (CH4)</option>
                                    <option value="ethane">Ethane (C2H6)</option>
                                    <option value="propane">Propane (C3H8)</option>
                                    <option value="nitrogen">Nitrogen (N2)</option>
                                    <option value="co2">Carbon Dioxide (CO2)</option>
                                    <option value="air">Air (Standard)</option>
                                    <option value="natgas_sg">Natural Gas by SG (Mix)</option>
                                </select>
                            </div>
                        </div>
                        <div class="vector-input-group" id="sg-input-group">
                            <div class="vector-input-header"><i class="fas fa-weight-hanging"></i> Properties</div>
                            <div class="form-group">
                                <label for="sg-val">Specific Gravity (Air=1) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Used for SG-based correlations (CNGA/Standing).</span></span></label>
                                <input type="number" id="sg-val" value="0.554" step="0.001">
                            </div>
                            <div class="form-group" style="margin-top:10px;">
                                <label for="n2-mol">Nitrogen Mol % (Optional)</label>
                                <input type="number" id="n2-mol" value="0" step="0.1">
                            </div>
                            <div class="form-group" style="margin-top:10px;">
                                <label for="co2-mol">CO2 Mol % (Optional)</label>
                                <input type="number" id="co2-mol" value="0" step="0.1">
                            </div>
                        </div>
                    </div>

                    <!-- Process Conditions -->
                    <h4 style="color: var(--primary); margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 5px; margin-top: 20px;">2. Process Conditions & Method</h4>
                    <div class="form-row">
                        <div class="vector-input-group">
                            <div class="vector-input-header"><i class="fas fa-tachometer-alt"></i> State</div>
                            <div class="form-group">
                                <label for="pressure">Pressure [bar(g)]</label>
                                <input type="number" id="pressure" value="50" step="1">
                            </div>
                            <div class="form-group" style="margin-top:10px;">
                                <label for="temperature">Temperature [°C]</label>
                                <input type="number" id="temperature" value="20" step="1">
                            </div>
                        </div>
                        <div class="vector-input-group">
                            <div class="vector-input-header"><i class="fas fa-calculator"></i> Calculation Method</div>
                            <div class="form-group">
                                <label for="eos-method">Equation of State</label>
                                <select id="eos-method">
                                    <option value="pr" selected>Peng-Robinson (Best for HC)</option>
                                    <option value="rk">Redlich-Kwong (General)</option>
                                    <option value="cnga">CNGA (Simple SG correlation)</option>
                                    <option value="ideal">Ideal Gas (Z=1 Reference)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="button-wrapper">
                        <button type="button" id="calculate-btn" class="btn"><i class="fas fa-calculator"></i> Calculate Z-Factor</button>
                        <button type="button" id="pdf-btn" class="btn btn-outline"><i class="fas fa-file-pdf"></i> Download Report</button>
                    </div>
                </form>
            </div>

            <!-- Results Section -->
            <div id="result-container" class="card hidden" style="margin-top: 40px;">
                <h3><i class="fas fa-poll"></i> Compressibility Analysis</h3>
                
                <div class="results-grid">
                    <!-- Left Col: Table -->
                    <div>
                        <h4 style="margin-top: 0; color: var(--primary); margin-bottom: 15px;">Calculated Properties</h4>
                        <table class="results-table">
                            <thead>
                                <tr>
                                    <th>Parameter</th>
                                    <th>Value</th>
                                    <th>Unit</th>
                                </tr>
                            </thead>
                            <tbody id="result-table-body">
                                <!-- Dynamic rows -->
                            </tbody>
                        </table>
                        
                        <div style="margin-top: 20px; background: var(--bg); padding: 15px; border-radius: 6px; border: 1px solid var(--border);">
                            <strong><i class="fas fa-info-circle"></i> Impact:</strong>
                            <div id="interpretation-text" style="margin-top: 5px; font-size: 0.95rem;"></div>
                        </div>
                    </div>

                    <!-- Right Col: Visual Chart -->
                    <div>
                        <h4 style="margin-top: 0; color: var(--primary); margin-bottom: 15px;">Molecular Density Simulation</h4>
                        <div class="chart-container">
                            <canvas id="gasCanvas" width="400" height="300"></canvas>
                        </div>
                        <div style="text-align: center; margin-top: 10px; font-size: 0.85rem; color: var(--text);">
                            <span style="color: #3B82F6;">● Gas Molecules</span> &nbsp;
                            (Visualizing density increase vs Ideal)
                        </div>
                    </div>
                    
                    <!-- Isotherm Chart -->
                    <div style="grid-column: 1 / -1; margin-top: 20px;">
                        <h4 style="margin-top: 0; color: var(--primary); margin-bottom: 15px;">Z-Factor Isotherm</h4>
                        <div class="chart-container" style="height: 350px;">
                            <canvas id="isoChart"></canvas>
                        </div>
                    </div>
                </div>

                <h4 style="margin-top: 30px; border-top: 1px solid var(--border); padding-top: 20px;">Step-by-Step Engineering Calculation</h4>
                <div id="calculation-details">
                    <!-- Dynamic math steps -->
                </div>

                <div class="standard-reference" style="margin-top: 20px; font-style: italic; color: var(--text);">
                     Cubic Equation Roots solved via Cardano's Method. Critical Properties estimated via Standing's Correlation for mixtures.
                </div>
            </div>
        </div>

        <!-- EDUCATIONAL CONTENT SECTION (MASSIVE) -->
        <div class="education-section card">
            <h2><i class="fas fa-lightbulb"></i> Engineering Insights: The Reality of Real Gases</h2>
            
            <!-- Insight 1: Ideal vs Real -->
            <div class="insight-card">
                <h4><i class="fas fa-book"></i> 1. Ideal Gas vs. Real Gas</h4>
                <p>The Ideal Gas Law ($PV = nRT$) assumes that gas molecules have zero volume and do not interact with each other. This is accurate at low pressures (atmospheric). However, at high industrial pressures (e.g., 50 bar pipelines), molecules are forced close together. Repulsive and attractive forces (Van der Waals forces) come into play.</p>
                <p>To correct for this, we introduce the <strong>Compressibility Factor ($Z$)</strong>:</p>
                <div class="formula">$$ PV = ZnRT $$</div>
                <ul>
                    <li><strong>Z = 1:</strong> Ideal Gas behavior.</li>
                    <li><strong>Z < 1 (Compression):</strong> At moderate pressures, attractive forces dominate. The gas occupies <em>less</em> volume than predicted. It is "supercompressible". This is typical for natural gas in the 20-60 bar range.</li>
                    <li><strong>Z > 1 (Expansion):</strong> At very high pressures, the physical volume of the molecules prevents further compression. Repulsive forces dominate. The gas is "harder" to compress than ideal.</li>
                </ul>
            </div>

            <!-- Insight 2: Equations of State -->
            <div class="insight-card">
                <h4><i class="fas fa-calculator"></i> 2. Equations of State (EOS)</h4>
                <p>Predicting $Z$ requires an Equation of State. Industrial standards have evolved:</p>
                <ul>
                    <li><strong>Redlich-Kwong (RK):</strong> An improvement over Van der Waals, good for general gases but less accurate near the critical point.</li>
                    <li><strong>Peng-Robinson (PR):</strong> The gold standard for Hydrocarbons and Natural Gas processing. It accurately predicts phase behavior (VLE) and liquid densities. This tool uses PR as the primary engine. It solves a cubic equation of state to find the liquid and vapor roots.</li>
                    <li><strong>CNGA (California Natural Gas Association):</strong> A simplified empirical formula used for quick pipeline estimations ($P < 5000$ psi). $Z = \frac{1}{1 + \frac{344400 \cdot P_{psig} \cdot 10^{1.785G}}{T_{R}^{3.825}}}$. It is fast but limited in range.</li>
                    <li><strong>AGA 8 (Detail):</strong> The ultimate custody transfer standard (complex iterative virial equation). Requires full gas chromatography analysis (C1-C6+, N2, CO2). For this tool, we approximate using PR which matches AGA 8 closely for pure components.</li>
                </ul>
            </div>

            <!-- Insight 3: Custody Transfer Error -->
            <div class="insight-card">
                <h4><i class="fas fa-money-bill-wave"></i> 3. The Million Dollar Error</h4>
                <p>In custody transfer (buying/selling gas), flow is measured in Standard Cubic Meters ($Sm^3$) or SCF. Flow meters (Orifice, Turbine, Ultrasonic) measure Actual volume ($Am^3$). To convert, we use:</p>
                <div class="formula">$$ Q_{std} = Q_{act} \cdot \left( \frac{P_{act}}{P_{std}} \right) \cdot \left( \frac{T_{std}}{T_{act}} \right) \cdot \left( \frac{Z_{std}}{Z_{act}} \right) $$</div>
                <p>If you assume Ideal Gas ($Z_{act}=1$) when the actual $Z=0.9$, you are underestimating the gas volume by <strong>10%</strong>. On a major pipeline, a 10% error represents millions of dollars of lost product per year. This is why Supercompressibility Factor ($F_{pv} = \sqrt{1/Z}$) is a critical input in flow computers.</p>
            </div>

            <!-- Insight 4: Critical Properties -->
            <div class="insight-card">
                <h4><i class="fas fa-atom"></i> 4. Reduced Properties & Kay's Rule</h4>
                <p>EOS models rely on the "Law of Corresponding States". Gases behave similarly relative to their <strong>Critical Point ($P_c, T_c$)</strong>. The calculator determines the Reduced Temperature ($T_r = T/T_c$) and Reduced Pressure ($P_r = P/P_c$).</p>
                <p>For Natural Gas mixtures (defined only by SG), we use <strong>Standing's Correlations</strong> (or Kay's Rule mixing) to estimate the pseudo-critical properties based on the gas gravity and impurity content ($N_2, CO_2$). $T_{pc} = 168 + 325 G - 12.5 G^2$ is a common approximation used in the oilfield.</p>
            </div>
        </div>
    </main>    <!-- FOOTER -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-col">
                    <h4>Design Calculators</h4>
                    <p style="font-size: 0.9rem; line-height: 1.6; margin-bottom: 15px;">If you find this tool helpful, please consider sharing it with your colleagues!</p>
                    <div class="social-buttons">
                        <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn linkedin" title="LinkedIn"><i class="fab fa-linkedin-in"></i></a>
                        <a href="https://www.youtube.com/@designcalculators" target="_blank" rel="noopener noreferrer" class="social-btn youtube" title="YouTube"><i class="fab fa-youtube"></i></a>
                        <a href="https://twitter.com/intent/tweet?url=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn twitter" title="Twitter"><i class="fab fa-twitter"></i></a>
                        <a href="https://www.facebook.com/sharer/sharer.php?u=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn facebook" title="Facebook"><i class="fab fa-facebook-f"></i></a>
                        <a href="https://api.whatsapp.com/send?text=Check%20out%20this%20amazing%20engineering%20resource%20https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn whatsapp" title="WhatsApp"><i class="fab fa-whatsapp"></i></a>
                    </div>
                </div>
                <div class="footer-col">
                    <h4>Quick Links</h4>
                    <ul>
                        <li><a href='/'>Home</a></li>
                        <li><a href="indexele">Electrical</a></li>
                        <li><a href="indexmech">Mechanical</a></li>
                        <li><a href="indexinst">Instrumentation</a></li>                        
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>Resources</h4>
                    <ul>
                        <li><a href="about">About Us</a></li>
                        <li><a href="contact">Contact</a></li>
                        <li><a href="faq">FAQ</a></li>
                        <li><a href="privacy-policy">Privacy Policy</a></li>
                        <li><a href="terms-of-service">Terms of Service</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>More</h4>
                    <ul>
                        <li><a href='/articles'>Articles & Whitepapers</a></li>
                        <li><a href='/sitemap2'>Sitemap</a></li>                        
                    </ul>
                </div>
            </div>
            <div class="footer-disclaimer">
                <p>This tool offers general guidance. Results should be reviewed for accuracy and compliance with relevant project standards and regulations before use.</p>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Design Calculators. Created by <span style="color: var(--secondary); font-weight: bold;">A Sharma</span>. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        // Global State
        let isoChart = null;
        let lastResult = null;
        let animationId = null;
        let particles = [];

        // Gas Constants (SI)
        const R_SI = 8.31446; // J/(mol K)
        const P_STD_ATM = 101325; // Pa
        const T_STD_K = 288.15; // 15C

        // Pure Component Data (Tc in K, Pc in Bar, Omega)
        const compDB = {
            'methane': { Tc: 190.56, Pc: 45.99, w: 0.011, M: 16.043, SG: 0.554 },
            'ethane': { Tc: 305.32, Pc: 48.72, w: 0.099, M: 30.07, SG: 1.038 },
            'propane': { Tc: 369.83, Pc: 42.48, w: 0.152, M: 44.10, SG: 1.522 },
            'nitrogen': { Tc: 126.2, Pc: 33.9, w: 0.037, M: 28.01, SG: 0.967 },
            'co2': { Tc: 304.13, Pc: 73.77, w: 0.224, M: 44.01, SG: 1.519 },
            'air': { Tc: 132.5, Pc: 37.7, w: 0.0, M: 28.97, SG: 1.000 }
        };

        function updateGasInputs() {
            const key = document.getElementById('gas-select').value;
            const sgInput = document.getElementById('sg-val');
            
            if (key === 'natgas_sg') {
                sgInput.readOnly = false;
                sgInput.value = 0.6;
            } else {
                sgInput.readOnly = true;
                if(compDB[key]) sgInput.value = compDB[key].SG;
            }
        }

        function loadPreset(type) {
            if (type === 'methane_high') {
                document.getElementById('gas-select').value = 'methane';
                updateGasInputs();
                document.getElementById('pressure').value = '150';
                document.getElementById('temperature').value = '50';
                document.getElementById('eos-method').value = 'pr';
            } else if (type === 'natgas_pipeline') {
                document.getElementById('gas-select').value = 'natgas_sg';
                updateGasInputs();
                document.getElementById('sg-val').value = '0.6';
                document.getElementById('pressure').value = '60';
                document.getElementById('temperature').value = '15';
                document.getElementById('eos-method').value = 'cnga';
            } else if (type === 'nitrogen_purge') {
                document.getElementById('gas-select').value = 'nitrogen';
                updateGasInputs();
                document.getElementById('pressure').value = '200';
                document.getElementById('temperature').value = '25';
                document.getElementById('eos-method').value = 'pr';
            }
            displayMessage(`${type.toUpperCase()} scenario loaded.`, "success");
        }

        function displayMessage(message, type = "info") {
            let messageBox = document.getElementById('message-box');
            messageBox.textContent = message;
            if (type === "error") messageBox.style.backgroundColor = 'var(--danger)';
            else if (type === "success") messageBox.style.backgroundColor = 'var(--success)';
            else messageBox.style.backgroundColor = 'var(--primary)';
            messageBox.classList.add('show');
            setTimeout(() => messageBox.classList.remove('show'), 4000);
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Theme handling
            const themeSwitch = document.getElementById('theme-switch');
            if (themeSwitch && localStorage.getItem('theme') === 'dark') {
                document.body.classList.add('dark-mode');
                themeSwitch.checked = true;
            }
            if(themeSwitch) {
                themeSwitch.addEventListener('change', function() {
                    document.body.classList.toggle('dark-mode');
                    localStorage.setItem('theme', this.checked ? 'dark' : 'light');
                });
            }

            updateGasInputs(); // Init
            document.getElementById('calculate-btn').addEventListener('click', performCalculation);
            document.getElementById('pdf-btn').addEventListener('click', generatePDF);
        });

        // --- EOS SOLVERS ---
        
        // Solve Cubic: Z^3 + a2*Z^2 + a1*Z + a0 = 0
        function solveCubic(a2, a1, a0) {
            const Q = (3*a1 - a2*a2) / 9;
            const R = (9*a2*a1 - 27*a0 - 2*a2*a2*a2) / 54;
            const D = Q*Q*Q + R*R; // Discriminant
            
            if (D >= 0) {
                const S = Math.cbrt(R + Math.sqrt(D));
                const T = Math.cbrt(R - Math.sqrt(D));
                return -a2/3 + S + T; // Real root
            } else {
                // 3 Real roots, use trig method. For Z, we usually want largest root for Vapor.
                const theta = Math.acos(R / Math.sqrt(-(Q*Q*Q)));
                const z1 = 2 * Math.sqrt(-Q) * Math.cos(theta/3) - a2/3;
                const z2 = 2 * Math.sqrt(-Q) * Math.cos((theta + 2*Math.PI)/3) - a2/3;
                const z3 = 2 * Math.sqrt(-Q) * Math.cos((theta + 4*Math.PI)/3) - a2/3;
                return Math.max(z1, z2, z3); // Vapor root
            }
        }

        function performCalculation() {
            // 1. Get Inputs
            const gasKey = document.getElementById('gas-select').value;
            const sg = parseFloat(document.getElementById('sg-val').value);
            const P_bar_g = parseFloat(document.getElementById('pressure').value);
            const T_C = parseFloat(document.getElementById('temperature').value);
            const method = document.getElementById('eos-method').value;

            if (isNaN(sg) || isNaN(P_bar_g) || isNaN(T_C)) {
                displayMessage("Please enter valid numbers.", "error");
                return;
            }

            // Units Conv
            const P_abs_bar = P_bar_g + 1.01325;
            const P_abs_Pa = P_abs_bar * 1e5;
            const T_K = T_C + 273.15;

            // 2. Critical Props (Tc, Pc, Omega)
            let Tc = 0, Pc = 0, w = 0, M = 0;
            
            if (gasKey === 'natgas_sg') {
                // Standing's Correlation for Natural Gas
                // Tc = 168 + 325*SG - 12.5*SG^2
                // Pc = 677 + 15.0*SG - 37.5*SG^2 (psia)
                Tc = (168 + 325*sg - 12.5*sg*sg) * (5/9); // Rankine to Kelvin
                const Pc_psia = 677 + 15*sg - 37.5*sg*sg;
                Pc = Pc_psia * 0.0689476; // Bar
                w = 0.01; // Approx acentric factor for NG
                M = sg * 28.97;
            } else {
                const data = compDB[gasKey];
                Tc = data.Tc;
                Pc = data.Pc;
                w = data.w;
                M = data.M;
            }

            // Reduced Props
            const Tr = T_K / Tc;
            const Pr = P_abs_bar / Pc;

            // 3. EOS Solve
            let Z = 1.0;
            let derivationHtml = "";

            if (method === 'ideal') {
                Z = 1.0;
                derivationHtml = `Assumption: Ideal Gas Law ($PV=nRT$). $Z=1.0$.`;
            } 
            else if (method === 'cnga') {
                // CNGA Correlation
                const P_psig = P_bar_g * 14.5038;
                const T_R = T_K * 1.8;
                const num = 344400 * P_psig * Math.pow(10, 1.785 * sg);
                const den = Math.pow(T_R, 3.825);
                Z = 1 / (1 + num/den);
                derivationHtml = `Using CNGA Correlation (Valid for Natural Gas, P < 5000 psig).<br>$$ Z = \\frac{1}{1 + \\frac{344400 \\cdot P \\cdot 10^{1.785 G}}{T^{3.825}}} $$`;
            }
            else if (method === 'pr') {
                // Peng-Robinson
                const R_const = 0.08314; // bar L / mol K
                const kappa = 0.37464 + 1.54226*w - 0.26992*w*w;
                const alpha = Math.pow(1 + kappa*(1 - Math.sqrt(Tr)), 2);
                
                const a_c = 0.45724 * Math.pow(R_const * Tc, 2) / Pc;
                const b_c = 0.07780 * (R_const * Tc) / Pc;
                
                const a = a_c * alpha;
                const b = b_c;
                
                const A_fac = (a * P_abs_bar) / Math.pow(R_const * T_K, 2);
                const B_fac = (b * P_abs_bar) / (R_const * T_K);
                
                const c2 = -(1 - B_fac);
                const c1 = A_fac - 3*B_fac*B_fac - 2*B_fac;
                const c0 = -(A_fac*B_fac - B_fac*B_fac - B_fac*B_fac*B_fac);
                
                Z = solveCubic(c2, c1, c0);
                
                derivationHtml = `<strong>1. Reduced Properties:</strong><br> $T_r = \\frac{T}{T_c} = \\frac{${T_K.toFixed(2)}}{${Tc.toFixed(2)}} = ${Tr.toFixed(4)}$<br> $P_r = \\frac{P}{P_c} = \\frac{${P_abs_bar.toFixed(2)}}{${Pc.toFixed(2)}} = ${Pr.toFixed(4)}$<br><br>`;
                derivationHtml += `<strong>2. PR Parameters (Acentric Factor $\\omega=${w}$):</strong><br> $\\kappa = 0.37464 + 1.54226\\omega - 0.26992\\omega^2 = ${kappa.toFixed(4)}$<br> $\\alpha = [1 + \\kappa(1 - \\sqrt{T_r})]^2 = ${alpha.toFixed(4)}$<br><br>`;
                derivationHtml += `<strong>3. Dimensionless Coefficients:</strong><br> $A = \\frac{a\\alpha P}{R^2T^2} = ${A_fac.toFixed(5)}$<br> $B = \\frac{bP}{RT} = ${B_fac.toFixed(5)}$<br><br>`;
                derivationHtml += `<strong>4. Cubic Equation Construction:</strong><br> $Z^3 + (${c2.toFixed(4)})Z^2 + (${c1.toFixed(4)})Z + (${c0.toFixed(4)}) = 0$`;
            }
            else if (method === 'rk') {
                // Redlich-Kwong
                const R_const = 0.08314;
                const a_c = 0.42748 * Math.pow(R_const * Tc, 2) / Pc;
                const b_c = 0.08664 * (R_const * Tc) / Pc;
                
                const a = a_c / Math.sqrt(Tr);
                const b = b_c;
                
                const A_fac = (a * P_abs_bar) / Math.pow(R_const * T_K, 2);
                const B_fac = (b * P_abs_bar) / (R_const * T_K);
                
                const c2 = -1;
                const c1 = A_fac - B_fac - B_fac*B_fac;
                const c0 = -A_fac * B_fac;
                
                Z = solveCubic(c2, c1, c0);
                derivationHtml = `Using Redlich-Kwong EOS.<br>$T_r = ${Tr.toFixed(3)}$, $P_r = ${Pr.toFixed(3)}$.<br>Coeffs A=${A_fac.toFixed(4)}, B=${B_fac.toFixed(4)}`;
            }

            // 4. Derived Values
            const rho_real = (P_abs_Pa * M/1000) / (Z * 8.314 * T_K); // kg/m3
            const rho_ideal = (P_abs_Pa * M/1000) / (1.0 * 8.314 * T_K);
            const Fpv = Math.sqrt(1/Z);

            lastResult = { Z, rho_real, rho_ideal, Fpv, M, P_bar_g, T_C, gasKey, method, derivationHtml };

            // 5. Render Output
            const tbody = document.getElementById('result-table-body');
            tbody.innerHTML = '';
            const addRow = (n, v, u, c="") => {
                tbody.innerHTML += `<tr style="${c ? 'color:'+c : ''}"><td><strong>${n}</strong></td><td>${v}</td><td>${u}</td></tr>`;
            };
            addRow("Compressibility (Z)", Z.toFixed(4), "-", Z < 0.9 ? "var(--warning)" : "");
            addRow("Supercompressibility (Fpv)", Fpv.toFixed(4), "-", "var(--primary)");
            addRow("Real Gas Density", rho_real.toFixed(3), "kg/m³");
            addRow("Ideal Gas Density", rho_ideal.toFixed(3), "kg/m³");
            addRow("Deviation", ((rho_real - rho_ideal)/rho_ideal * 100).toFixed(2), "% Error if Z=1");

            const interpEl = document.getElementById('interpretation-text');
            if (Z < 0.9) {
                interpEl.innerHTML = `<span style="color:var(--warning); font-weight:bold;">High Compression.</span> Gas is ${( (1/Z - 1)*100 ).toFixed(1)}% denser than Ideal Law predicts. Critical for custody transfer.`;
            } else if (Z > 1.05) {
                interpEl.innerHTML = `Gas is expanding (Repulsive forces).`;
            } else {
                interpEl.innerHTML = `Near Ideal behavior.`;
            }

            document.getElementById('calculation-details').innerHTML = `<div class="calculation-step">${derivationHtml}<br><br><strong>5. Solve Roots (Cardano's Method):</strong><br>Solving cubic polynomial to find real roots.<br>Selected Vapor Root: $Z = \\mathbf{${Z.toFixed(5)}}$<br><br><strong>6. Density Calculation:</strong><br>$\\rho_{real} = \\frac{PM}{ZRT} = \\frac{${(P_abs_Pa/1e5).toFixed(1)} \\text{ bar} \\cdot ${M} \\text{ g/mol}}{${Z.toFixed(4)} \\cdot R \\cdot ${T_K.toFixed(1)} \\text{ K}} = \\mathbf{${rho_real.toFixed(3)} \\text{ kg/m}^3}$</div>`;

            // 6. Visuals
            drawIsotherm(method, Tc, Pc, M, w, T_K);
            animateGas(Z, T_K);

            // 7. Show
            document.getElementById('result-container').classList.remove('hidden');
            if(window.MathJax) window.MathJax.typesetPromise([document.getElementById('calculation-details')]);
            document.getElementById('result-container').scrollIntoView({ behavior: 'smooth' });
        }

        function drawIsotherm(method, Tc, Pc, M, w, T_K) {
            const ctx = document.getElementById('isoChart').getContext('2d');
            if (isoChart) isoChart.destroy();

            const labels = [];
            const dataZ_op = [];
            const dataZ_low = [];
            const dataZ_high = [];
            
            // Temperatures for families of curves
            const T_low = T_K - 20;
            const T_high = T_K + 20;

            // Generate P range 0 to 300 bar
            for (let p = 1; p <= 300; p += 10) {
                // Internal solver for chart points (Simplified PR logic for speed)
                const getZ = (P, T) => {
                    const Pr = (P+1.013)/Pc;
                    const Tr = T/Tc;
                    const R = 0.08314;
                    const kappa = 0.37464 + 1.54226*w - 0.26992*w*w;
                    const alpha = Math.pow(1 + kappa*(1 - Math.sqrt(Tr)), 2);
                    const a = 0.45724 * Math.pow(R * Tc, 2) / Pc * alpha;
                    const b = 0.07780 * (R * Tc) / Pc;
                    const A = (a * (P+1.013)) / Math.pow(R * T, 2);
                    const B = (b * (P+1.013)) / (R * T);
                    const c2 = -(1 - B);
                    const c1 = A - 3*B*B - 2*B;
                    const c0 = -(A*B - B*B - B*B*B);
                    return solveCubic(c2, c1, c0);
                };
                
                labels.push(p);
                dataZ_op.push(getZ(p, T_K));
                dataZ_low.push(getZ(p, T_low));
                dataZ_high.push(getZ(p, T_high));
            }

            isoChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: `${(T_K-273.15).toFixed(0)}°C (Operating)`,
                            data: dataZ_op,
                            borderColor: '#1E3A8A', // Dark Blue
                            borderWidth: 3,
                            pointRadius: 0,
                            fill: false
                        },
                        {
                            label: `${(T_low-273.15).toFixed(0)}°C`,
                            data: dataZ_low,
                            borderColor: '#3B82F6', // Light Blue
                            borderWidth: 1,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            fill: false
                        },
                        {
                            label: `${(T_high-273.15).toFixed(0)}°C`,
                            data: dataZ_high,
                            borderColor: '#EF4444', // Red
                            borderWidth: 1,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { title: {display:true, text:'Pressure (bar)'} },
                        y: { title: {display:true, text:'Compressibility Factor (Z)'} }
                    }
                }
            });
        }

        // --- PARTICLE ANIMATION ---
        function animateGas(Z, TempK) {
            const canvas = document.getElementById('gasCanvas');
            const ctx = canvas.getContext('2d');
            const cw = canvas.width;
            const ch = canvas.height;
            
            // Number of particles proportional to Density (1/Z)
            // Z=1 -> 50 particles. Z=0.8 -> 62 particles.
            const densityFactor = 1 / Z;
            const numParticles = Math.min(300, Math.floor(60 * densityFactor));
            
            // Speed proportional to sqrt(Temperature) (Kinetic Theory)
            // Base speed at 293K (20C) = 2.0
            const speedFactor = Math.sqrt(TempK / 293.15) * 2.0;

            particles = [];
            for(let i=0; i<numParticles; i++) {
                particles.push({
                    x: Math.random() * cw,
                    y: Math.random() * ch,
                    vx: (Math.random() - 0.5) * speedFactor,
                    vy: (Math.random() - 0.5) * speedFactor
                });
            }

            if (animationId) cancelAnimationFrame(animationId);

            function draw() {
                ctx.clearRect(0, 0, cw, ch);
                
                // Draw Container
                ctx.strokeStyle = '#334155';
                ctx.lineWidth = 4;
                ctx.strokeRect(10, 10, cw-20, ch-20);
                
                // Color based on temperature (Blue -> Red)
                // Map 250K to 400K -> Hue 240 to 0
                let hue = 240 - ((TempK - 250) / 150) * 240;
                hue = Math.max(0, Math.min(240, hue)); // Clamp
                ctx.fillStyle = `hsl(${hue}, 70%, 50%)`;

                particles.forEach(p => {
                    p.x += p.vx;
                    p.y += p.vy;
                    
                    // Bounce
                    if(p.x < 15 || p.x > cw-15) p.vx *= -1;
                    if(p.y < 15 || p.y > ch-15) p.vy *= -1;
                    
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, 3, 0, Math.PI*2);
                    ctx.fill();
                });
                
                // Stats
                ctx.fillStyle = '#000';
                ctx.font = '12px Inter';
                ctx.fillText(`Relative Density: ${densityFactor.toFixed(2)}x`, 20, 30);
                ctx.fillText(`Kinetic Energy (Temp): ${TempK.toFixed(0)} K`, 20, 45);

                animationId = requestAnimationFrame(draw);
            }
            draw();
        }

        function generatePDF() {
            if (!lastResult) {
                displayMessage("Calculate first.", "error");
                return;
            }
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            let y = 15;

            pdf.setFont('helvetica', 'bold');
            pdf.setFontSize(16);
            pdf.setTextColor(30, 58, 138); 
            pdf.text('Gas Compressibility Report', 105, y, { align: 'center' });
            y += 10;

            pdf.setFontSize(10);
            pdf.setTextColor(100);
            pdf.text(`Date: ${new Date().toLocaleString()}`, 105, y, { align: 'center' });
            y += 15;

            const inputData = [
                ['Gas Type', lastResult.gasKey.toUpperCase()],
                ['Mol Weight', lastResult.M],
                ['Pressure', `${lastResult.P_bar_g} bar(g)`],
                ['Temperature', `${lastResult.T_C} °C`],
                ['Method', lastResult.method.toUpperCase()]
            ];

            pdf.autoTable({
                startY: y,
                head: [['Parameter', 'Value']],
                body: inputData,
                margin: { left: 14, right: 14 },
                theme: 'grid',
                headStyles: { fillColor: [30, 58, 138] }
            });
            y = pdf.lastAutoTable.finalY + 15;

            // Results
            pdf.text('2. EOS Results', 14, y);
            y += 5;

            const resData = [
                ['Z-Factor', lastResult.Z.toFixed(5)],
                ['Fpv', lastResult.Fpv.toFixed(5)],
                ['Real Density', `${lastResult.rho_real.toFixed(3)} kg/m³`],
                ['Ideal Density', `${lastResult.rho_ideal.toFixed(3)} kg/m³`]
            ];

            pdf.autoTable({
                startY: y,
                head: [['Metric', 'Result']],
                body: resData,
                margin: { left: 14, right: 14 },
                theme: 'grid',
                headStyles: { fillColor: [30, 58, 138] },
                didParseCell: function(data) {
                    if(data.row.index === 0) {
                        data.cell.styles.fontStyle = 'bold';
                    }
                }
            });

            pdf.save('Z_Factor_Report.pdf');
            displayMessage("PDF Downloaded", "success");
        }

        function displayMessage(message, type = "info") {
            let messageBox = document.getElementById('message-box');
            messageBox.textContent = message;
            if (type === "error") messageBox.style.backgroundColor = 'var(--danger)';
            else if (type === "success") messageBox.style.backgroundColor = 'var(--success)';
            else messageBox.style.backgroundColor = 'var(--primary)';
            messageBox.classList.add('show');
            setTimeout(() => messageBox.classList.remove('show'), 4000);
        }
    </script>
</body>
</html>
