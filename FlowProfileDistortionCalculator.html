<!DOCTYPE html>
<html lang="en">
<head>
    <!-- AdSense & Analytics -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5936527763614780" crossorigin="anonymous"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-23Y1V450SR"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-23Y1V450SR');
    </script>
    
    <!-- SEO Meta Tags -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flow Meter Straight Length & Profile Calculator - Industrial Grade</title>
    <meta name="description" content="Professional Flow Meter Straight Run Calculator. Determine upstream/downstream piping requirements per ISO 5167 & AGA 3. Visualize flow profile distortion, swirl, and flow conditioner effects.">
    <meta name="keywords" content="flow meter straight length, ISO 5167 calculator, orifice plate piping, flow profile distortion, upstream diameters, beta ratio, flow conditioner, coriolis installation, ultrasonic meter run">
    <meta name="author" content="Design Calculators">
    <meta name="robots" content="index, follow">

    <!-- Fonts & Icons -->
    <link rel="preconnect" ="https://fonts.googleapis.com">
    <link rel="preconnect" ="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Montserrat:wght@700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>

    <!-- Chart.js for Visuals -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1/dist/chartjs-plugin-annotation.min.js"></script>

    <!-- MathJax for Formulas -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['\\(', '\\)'], ['$', '$']],
                displayMath: [['\\[', '\\]'], ['$$', '$$']]
            },
            svg: { fontCache: 'global' }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <!-- Favicon Links -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">

    <style>
        /* --- CORE THEME (Blue Industrial - Matches Symmetrical Components) --- */
        :root {
            --primary: #1E3A8A; /* Dark Blue */
            --secondary: #2563EB; /* Bright Blue */
            --accent: #F59E0B; /* Amber */
            --success: #10B981;
            --danger: #DC2626;
            --warning: #F59E0B;
            --bg: #F8FAFC;
            --card: #FFFFFF;
            --text: #4B5563;
            --heading: #111827;
            --footer-bg: #0F172A;
            --border: #E2E8F0;
            --grad: linear-gradient(135deg, var(--primary), var(--secondary));
            --grad-dark: linear-gradient(135deg, #0F172A, #1E293B);
            --shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        body.dark-mode {
            --primary: #10B981;
            --secondary: #34D399;
            --bg: #0F172A;
            --card: #1E293B;
            --text: #CBD5E1;
            --heading: #F1F5F9;
            --footer-bg: #020617;
            --border: #334155;
            --accent: #F59E0B;
        }

        * { box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.7;
            margin: 0;
            padding: 0;
        }

        .container { max-width: 1280px; margin: 0 auto; padding: 0 24px; }

        /* Header & Nav */
        header {
            background: var(--grad);
            color: white;
            padding: 24px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo-container {
            display: flex;
            flex-direction: column;
            text-decoration: none;
            color: white;
        }
        .logo-text {
            font-size: 1.75rem;
            font-weight: 800;
            font-family: 'Montserrat', sans-serif;
        }
        .logo-subtitle {
            font-size: 0.8rem;
            margin: 4px 0 0 0;
            color: #E0E7FF;
            opacity: 0.9;
        }
        .nav-links {
            display: flex;
            gap: 24px;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        .nav-links a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }
        .nav-links a:hover { color: var(--accent); }
        
        /* Theme Toggle */
        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
            color: white;
        }
        .switch {
            position: relative;
            width: 56px;
            height: 30px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0,0,0,0.2);
            transition: .4s;
            border-radius: 30px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 22px; width: 22px;
            left: 4px; bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(26px); }

        /* Main Content & Cards */
        main { padding: 40px 0; }
        .card {
            background: var(--card);
            border-radius: 12px;
            padding: 30px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            border: 1px solid var(--border);
            animation: fadeIn 0.6s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .card h2 {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
            padding-bottom: 15px;
            margin-top: 0;
            font-family: 'Montserrat', sans-serif;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        h3 {
            color: var(--heading);
            font-family: 'Montserrat', sans-serif;
            font-size: 1.5rem;
            margin-top: 25px;
            margin-bottom: 20px;
        }

        /* Forms */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .form-group { margin-bottom: 0; }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--heading);
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 6px;
            background-color: var(--bg);
            color: var(--text);
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        .form-group input:focus, .form-group select:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
        }
        body.dark-mode .form-group input:focus { 
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        /* Buttons */
        .btn {
            background: var(--grad);
            color: white;
            border: none;
            padding: 16px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(30, 58, 138, 0.3);
            transition: all 0.3s;
            width: 100%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(30, 58, 138, 0.4);
        }
        .btn-outline {
            background: transparent;
            border: 2px solid var(--secondary);
            color: var(--secondary);
            font-size: 0.9rem;
            padding: 8px 16px;
        }
        .btn-outline:hover {
            background: var(--secondary);
            color: white;
        }
        .button-wrapper {
            display: flex;
            justify-content: center;
            width: 100%;
            padding-top: 15px;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        /* Quick Load Buttons */
        .preset-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        .preset-btn {
            padding: 8px 12px;
            font-size: 0.85rem;
            border: 1px solid var(--border);
            background: var(--card);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .preset-btn:hover {
            background: var(--bg);
            border-color: var(--secondary);
            color: var(--secondary);
        }

        /* Results Layout */
        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            align-items: start;
        }
        @media (max-width: 1024px) {
            .results-grid { grid-template-columns: 1fr; }
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-radius: 8px;
            overflow: hidden;
        }
        .results-table th, .results-table td {
            padding: 14px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        .results-table th {
            background: var(--grad);
            color: white;
            font-weight: 700;
        }
        .results-table tr:nth-child(even) { background-color: var(--bg); }
        .results-table td:first-child {
            font-weight: 600;
            color: var(--heading);
        }
        .highlight { color: var(--success); font-weight: 700; }
        .danger-text { color: var(--danger); font-weight: 700; }

        /* Canvas Container */
        .chart-container {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            position: relative;
            height: 400px;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        canvas {
            max-width: 100%;
            max-height: 100%;
        }

        /* Educational Section Styling */
        .insight-card {
            background: linear-gradient(135deg, var(--card), rgba(37,99,235,0.03));
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            border-left: 5px solid var(--secondary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: all 0.3s;
        }
        .insight-card:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .insight-card h4 {
            color: var(--secondary);
            font-size: 1.3rem;
            margin: 0 0 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: 'Montserrat', sans-serif;
        }
        .insight-card p, .insight-card ul {
            margin: 10px 0;
            line-height: 1.8;
            color: var(--text);
        }
        .insight-card ul { padding-left: 20px; }
        .insight-card li { margin-bottom: 8px; }

        /* Formulas & Steps */
        .formula {
            background: var(--bg);
            border-left: 3px solid var(--accent);
            padding: 15px;
            margin: 12px 0;
            font-size: 1.1rem;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
            color: var(--heading);
        }
        .calculation-step {
            font-family: 'Courier New', monospace;
            background-color: rgba(0,0,0,0.03);
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            border-left: 4px solid var(--success);
            font-size: 0.95rem;
            line-height: 1.6;
        }
        body.dark-mode .calculation-step { background-color: rgba(255,255,255,0.05); }

        /* Vector Input Group Styling (Reused) */
        .vector-input-group {
            background: var(--bg);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border);
            position: relative;
        }
        .vector-input-header {
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Print Styling */
        @media print {
            header, footer, .education-section, .theme-toggle, .button-wrapper, .preset-container { display: none !important; }
            .card { border: none; shadow: none; padding: 0; }
            .container { width: 100%; max-width: 100%; padding: 0; }
            .results-grid { grid-template-columns: 1fr 1fr; }
            .chart-container { height: 300px; page-break-inside: avoid; }
        }

        /* Message Box */
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 16px 28px;
            border-radius: 8px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.25);
            z-index: 10000;
            font-weight: 600;
            color: white;
            opacity: 0;
            transition: all 0.4s;
            display: none;
        }
        .message-box.show { display: block; opacity: 1; top: 30px; }
        .hidden { display: none; }

        /* Tooltip */
        .info-icon { color: var(--secondary); margin-left: 5px; cursor: help; }
        .tooltip { position: relative; display: inline-block; }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 220px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -110px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.85rem;
            font-weight: 400;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }

        /* Footer */
        footer {
            background: var(--grad-dark);
            color: #CBD5E1;
            padding: 50px 0 20px 0;
            margin-top: 60px;
        }
        .footer-content {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 40px;
            margin-bottom: 30px;
        }
        .footer-col { flex: 1; min-width: 200px; }
        .footer-col h4 { color: white; margin-bottom: 15px; font-weight: 700; }
        .footer-col ul { list-style: none; padding: 0; margin: 0; }
        .footer-col a { color: #CBD5E1; text-decoration: none; transition: color 0.3s; }
        .footer-col a:hover { color: var(--accent); }
        .social-buttons { display: flex; gap: 12px; margin-top: 15px; }
        .social-btn {
            width: 40px; height: 40px;
            display: flex; justify-content: center; align-items: center;
            color: white; border-radius: 50%;
            font-size: 1.1rem; transition: transform 0.3s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .social-btn:hover { transform: translateY(-4px); }
        .social-btn.linkedin { background-color: #0A66C2; }
        .social-btn.youtube { background-color: #FF0000; }
        .social-btn.twitter { background-color: #1DA1F2; }
        .social-btn.facebook { background-color: #1877F2; }
        .social-btn.whatsapp { background-color: #25D366; }
        .footer-disclaimer {
            text-align: center; padding-top: 25px;
            border-top: 1px solid #334155;
            max-width: 800px; margin: 0 auto;
            font-size: 0.9rem;
        }
        .footer-bottom {
            text-align: center; padding-top: 20px;
            font-size: 0.9rem; color: #94A3B8;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container { padding: 0 15px; }
            .navbar { flex-direction: column; gap: 20px; }
            .nav-links { flex-direction: column; gap: 12px; text-align: center; }
            .form-row { grid-template-columns: 1fr; }
            .card { padding: 20px; }
            .footer-content { flex-direction: column; gap: 25px; }
        }
    </style>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="message-box" class="message-box"></div>
    <header class="header">
        <div class="header-bg-animation"></div>
        <div class="container">
            <nav class="navbar">
                <a href="/" class="logo-container">
                    <img src="logo.png" alt="Design Calculators Logo" class="logo">
                    <span class="logo-text">Design Calculators</span>
                </a>

                <div class="nav-menu">
                    <button class="mobile-menu-toggle" aria-label="Toggle menu">
                        <i class="fas fa-bars"></i>
                    </button>

                    <ul class="nav-links">
                        <li><a href="/index.html">Home</a></li>
                        
    <li class="dropdown">
        <a href="/indexele.html" class="dropdown-toggle">Electrical <i class="fas fa-chevron-down" style="font-size: 0.7em; margin-left: 4px;"></i></a>
        <div class="dropdown-menu">
            <div class="repo-grid"><div><a href="/arcflash.html">Arc Flash Calculator</a><a href="/breaker-sizing.html">Breaker Sizing</a><a href="/cable-thermal-rating.html">Cable Ampacity</a><a href="/comm-cable-loss.html">Comm Cable Loss</a><a href="/earth-conductor-size.html">Earth Conductor Size</a><a href="/generatorsizing.html">Generator Sizing</a><a href="/harmonicsanalyser.html">Harmonics Analyser</a><a href="/insulationresistance.html">Insulation Resistance</a><a href="/logicgate.html">Logic Gates Simulator</a><a href="/motor-starting.html">Motor Starting Current</a><a href="/pcbtrace.html">PCB Trace Width</a><a href="/protection-device.html">Protection Device</a><a href="/resistor.html">Resistor Color Code</a><a href="/solarcable.html">Solar Cable Sizing</a><a href="/systemxrcalculator.html">System X/R Ratio</a><a href="/transmissionline.html">Transmission Line</a><a href="/vfd-selection.html">VFD Selection Tool</a></div><div><a href="/batterylife.html">Battery Life Estimator</a><a href="/busbarampacity.html">Busbar Ampacity</a><a href="/cablepulling.html">Cable Pulling Tension</a><a href="/conduit-fill.html">Conduit Fill Calculator</a><a href="/earthingfaultsimulator.html">Earthing Fault Simulator</a><a href="/grounding.html">Grounding System Design</a><a href="/hvac-sizing.html">HVAC Sizing Calculator</a><a href="/lcresonancecalculator.html">LC Resonance Calculator</a><a href="/maintenance-guide.html">Maintenance Guide</a><a href="/nemaipconvertor.html">NEMA to IP Converter</a><a href="/power-factor.html">Power Factor Correction</a><a href="/relay-coordination.html">Relay Coordination</a><a href="/short-circuit.html">Short Circuit Current</a><a href="/solarpvarray.html">Solar PV Array</a><a href="/transformer-calculator.html">Transformer Calculator</a><a href="/unit-converter.html">Unit Converter</a><a href="/voltage-drop.html">Voltage Drop Calculator</a></div><div><a href="/battery-sizing.html">Battery Sizing (AH)</a><a href="/busbarshortcircuit.html">Busbar Short Circuit</a><a href="/cable-sizing.html">Cable Sizing Calculator</a><a href="/ctsaturation.html">CT Saturation</a><a href="/equipment-relay.html">Equipment Relay Setting</a><a href="/harmonic-distortion.html">Harmonic Distortion</a><a href="/industriallighting.html">Industrial Lighting</a><a href="/lighting-calulator.html">Lighting Calculator</a><a href="/motor-efficiency.html">Motor Efficiency</a><a href="/neutral-earth-fault-current.html">Neutral Earth Fault</a><a href="/powertriangletool.html">Power Triangle</a><a href="/electricalresidentialload.html">Residential Load Calc</a><a href="/skindepth.html">Skin Depth Calculator</a><a href="/symmetricalcomponents.html">Symmetrical Components</a><a href="/transformerinrush.html">Transformer Inrush</a><a href="/ups-sizing.html">UPS Sizing</a></div>
            </div>
            <div class="view-all-container">
                <a href="/indexele.html" class="view-all-link">View All Electrical Tools â†’</a>
            </div>
        </div>
    </li>
                        
    <li class="dropdown">
        <a href="/indexinst.html" class="dropdown-toggle">Instrumentation <i class="fas fa-chevron-down" style="font-size: 0.7em; margin-left: 4px;"></i></a>
        <div class="dropdown-menu">
            <div class="repo-grid"><div><a href="/adc-resolution.html">ADC Resolution</a><a href="/capillarylengthtemperatureerror.html">Capillary Error</a><a href="/cv-kv-valve.html">Cv/Kv Valve Sizing</a><a href="/dp-level.html">DP Level Measurement</a><a href="/hydrostatic-level.html">Hydrostatic Level</a><a href="/instrument-range.html">Instrument Range</a><a href="/loop-impedance.html">Loop Impedance</a><a href="/orifice-plate.html">Orifice Plate Beta</a><a href="/pid-tuning.html">PID Tuning</a><a href="/profibus.html">Profibus Calculator</a><a href="/tempsensorresponse.html">Response Time (Tau)</a><a href="/rtd-lead-comp.html">RTD Lead Wire Comp.</a><a href="/sealfluidzeroshift.html">Seal Fluid Shift</a><a href="/snr-calculator.html">SNR Calculator</a><a href="/thermocoupleextensioncable.html">TC Extension Cable</a><a href="/thermowellwakefreq.html">Thermowell Frequency</a><a href="/pressuretransmitteroverrange.html">Tx Overrange</a><a href="/valvecavitationcalculator.html">Valve Cavitation</a><a href="/vibrationtransmitter.html">Vibration Tx</a><a href="/zoneclassificationhelper.html">Zone Classification</a></div><div><a href="/baud-rate.html">Baud Rate Calculator</a><a href="/gascompressibility.html">Compressibility (Z)</a><a href="/dbcalculator.html">dB Gain/Loss Calc</a><a href="/flowprofiledistortioncalculator.html">Flow Distortion</a><a href="/impulselinefreezing.html">Impulse Freezing</a><a href="/intrinsic-safety.html">Intrinsic Safety Loop</a><a href="/measurement.html">Measurement Uncertainty</a><a href="/ph-temp-comp.html">pH Temp Compensation</a><a href="/plcscantime.html">PLC Scan Time</a><a href="/pressurereliefvalve.html">PRV Sizing (API 520)</a><a href="/reynoldsnumbercal.html">Reynolds Number</a><a href="/rtdselfheating.html">RTD Self-Heating</a><a href="/signal-scaling.html">Signal Scaling</a><a href="/staticheadcal.html">Static Head</a><a href="/temperaturesensorlag.html">Temp Sensor Lag</a><a href="/thermowell-wake.html">Thermowell Wake</a><a href="/ultrasoniclevel.html">Ultrasonic Level</a><a href="/valve-cv.html">Valve Cv Viewer</a><a href="/wetlegdensitycompensation.html">Wet Leg Compensation</a></div><div><a href="/capacitance-level.html">Capacitance Level</a><a href="/controlvalvenoise.html">Control Valve Noise</a><a href="/dp-flow-conversion.html">DP Flow Conversion</a><a href="/hartdevices.html">HART Devices</a><a href="/impulse-pressure-drop.html">Impulse Pressure Drop</a><a href="/junctionbox.html">Junction Box Sizing</a><a href="/orifice-flow.html">Orifice Flow Calculator</a><a href="/pid-symbol-library.html">PID Symbol Library</a><a href="/power-supply-load.html">Power Supply Load</a><a href="/prvsizing.html">Relief Orifice Area</a><a href="/rtdexcitationcurrentselection.html">RTD Excitation</a><a href="/rtd-tc-conversion.html">RTD/TC Conversion</a><a href="/sil.html">SIL Calculator</a><a href="/steamflow.html">Steam Flow</a><a href="/thermocouplecjccalculator.html">Thermocouple CJC</a><a href="/turndown.html">Turndown Ratio</a><a href="/controlvalveauthority.html">Valve Authority</a><a href="/controlvalveleakage.html">Valve Leakage Class</a><a href="/wirelesshart.html">WirelessHART Range</a></div>
            </div>
            <div class="view-all-container">
                <a href="/indexinst.html" class="view-all-link">View All Instrumentation Tools â†’</a>
            </div>
        </div>
    </li>
                        
    <li class="dropdown">
        <a href="/indexmech.html" class="dropdown-toggle">Mechanical <i class="fas fa-chevron-down" style="font-size: 0.7em; margin-left: 4px;"></i></a>
        <div class="dropdown-menu">
            <div class="repo-grid"><div><a href="/aircompressorfad.html">Air Compressor FAD</a><a href="/asme-vessel.html">ASME Vessel Design</a><a href="/belt-pulley.html">Belt & Pulley</a><a href="/bolt-torque.html">Bolt Torque</a><a href="/controlvalveactuator.html">Control Valve Actuator</a><a href="/frictionfactortool.html">Darcy Friction Factor</a><a href="/fatigue.html">Fatigue Analysis</a><a href="/fuel-combustion.html">Fuel Combustion</a><a href="/gas.html">Gas Properties</a><a href="/heat-exchanger.html">Heat Exchanger</a><a href="/hydroliccylinder.html">Hydraulic Cylinder</a><a href="/material-compatibility.html">Material Compatibility</a><a href="/nozzle-reinforcement.html">Nozzle Reinforcement</a><a href="/openchannelflow.html">Open Channel Flow</a><a href="/pipescheduletool.html">Pipe Schedule & Stress</a><a href="/pump-head.html">Pump Head</a><a href="/shaft-power-torque.html">Shaft Power & Torque</a><a href="/steam-table.html">Steam Table</a><a href="/vibrationanalysis.html">Vibration Analysis</a></div><div><a href="/air-flow-duct.html">Air Flow Duct Sizing</a><a href="/beam-deflection.html">Beam Deflection</a><a href="/bernoulli-equation.html">Bernoulli Equation</a><a href="/chiller-capacity.html">Chiller Capacity</a><a href="/cooling-tower-sizing.html">Cooling Tower Sizing</a><a href="/darcy-weisbach.html">Darcy-Weisbach</a><a href="/finned-tube-heat-transfer.html">Finned Tube Heat</a><a href="/furnace-heat-duty.html">Furnace Heat Duty</a><a href="/gear-design.html">Gear Design</a><a href="/heat-loss-pipes.html">Heat Loss Pipes</a><a href="/jacketed-vessel-heat-transfer.html">Jacketed Vessel</a><a href="/metalweight.html">Metal Weight Calculator</a><a href="/nptbspthreadcalculator.html">NPT/BSP Threads</a><a href="/overall-heat-transfer.html">Overall Heat Transfer</a><a href="/pipe-stress-flexibility.html">Pipe Stress</a><a href="/pump-power.html">Pump Power</a><a href="/specific-heat-enthalpy.html">Specific Heat</a><a href="/storage-tank-volume.html">Storage Tank Volume</a><a href="/weldingstress.html">Welding Stress</a></div><div><a href="/allowable-stress-safety-factor.html">Allowable Stress</a><a href="/bearinglife.html">Bearing Life Calculator</a><a href="/boiler-efficiency.html">Boiler Efficiency</a><a href="/compressor-power.html">Compressor Power</a><a href="/corrosion-rate.html">Corrosion Rate</a><a href="/fan-laws.html">Fan Laws</a><a href="/foundation.html">Foundation Design</a><a href="/gas-laws.html">Gas Laws</a><a href="/hardness.html">Hardness Converter</a><a href="/conduction-convection-radiation.html">Heat Transfer Modes</a><a href="/machining.html">Machining Calculator</a><a href="/momentofinertia.html">Moment of Inertia</a><a href="/oring.html">O-Ring Sizing</a><a href="/pipe-flow.html">Pipe Flow Calculator</a><a href="/psychrometric.html">Psychrometric Calc</a><a href="/reynolds-number.html">Reynolds Number</a><a href="/spring.html">Spring Design</a><a href="/thermal-expansion.html">Thermal Expansion</a></div>
            </div>
            <div class="view-all-container">
                <a href="/indexmech.html" class="view-all-link">View All Mechanical Tools â†’</a>
            </div>
        </div>
    </li>
                        <li><a href="/index.html#articles">Articles</a></li>
                        <li><a href="/sitemap2.html">Site Map</a></li>
                    </ul>

                    <div class="theme-toggle">
                        <i class="fas fa-sun icon"></i>
                        <label class="switch">
                            <input type="checkbox" id="theme-switch">
                            <span class="slider"></span>
                        </label>
                        <i class="fas fa-moon icon"></i>
                    </div>
                </div>
            </nav>
    </header>

    <main class="container">
        <div class="card">
            <h2><i class="fas fa-ruler-horizontal"></i> Flow Profile Distortion & Straight Length Calculator</h2>
            
            <div class="tool-description">
                <p>This industrial-grade calculator determines the mandatory <strong>Straight Pipe Runs ($U, D$)</strong> required for accurate flow measurement per <strong>ISO 5167</strong> and <strong>API 14.3</strong>. It visualizes flow profile distortion caused by fittings, simulates profile recovery, and calculates pressure loss across flow conditioners.</p>
            </div>

            <div class="calculator-form">
                <form id="flow-form">
                    <!-- Controls Row -->
                    <div class="form-row" style="align-items: end;">
                        <div class="form-group">
                            <label>Quick Load Scenarios:</label>
                            <div class="preset-container" style="margin-bottom: 0;">
                                <button type="button" class="preset-btn" onclick="loadPreset('orifice_standard')"><i class="fas fa-dot-circle"></i> Orifice (Beta 0.5)</button>
                                <button type="button" class="preset-btn" onclick="loadPreset('orifice_high')"><i class="fas fa-exclamation-triangle"></i> Orifice (Beta 0.75)</button>
                                <button type="button" class="preset-btn" onclick="loadPreset('mag_tight')"><i class="fas fa-magnet"></i> Magmeter (Tight Fit)</button>
                            </div>
                        </div>
                    </div>

                    <!-- Meter Specs -->
                    <h4 style="color: var(--primary); margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 5px;">1. Meter Specifications</h4>
                    <div class="form-row">
                        <div class="vector-input-group">
                            <div class="vector-input-header"><i class="fas fa-microchip"></i> Technology</div>
                            <div class="form-group">
                                <label for="meter-type">Meter Type</label>
                                <select id="meter-type" onchange="toggleBeta()">
                                    <option value="orifice" selected>Orifice Plate (ISO 5167)</option>
                                    <option value="venturi">Venturi Tube</option>
                                    <option value="ultrasonic">Ultrasonic (Multipath)</option>
                                    <option value="coriolis">Coriolis (Mass)</option>
                                    <option value="mag">Electromagnetic</option>
                                    <option value="vortex">Vortex Shedder</option>
                                    <option value="turbine">Turbine</option>
                                </select>
                            </div>
                            <div class="form-group" id="beta-group" style="margin-top:10px;">
                                <label for="beta-ratio">Beta Ratio ($\beta = d/D$) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Diameter Ratio. Higher Beta = More sensitivity to profile distortion.</span></span></label>
                                <input type="number" id="beta-ratio" value="0.5" step="0.01">
                            </div>
                        </div>
                        <div class="vector-input-group">
                            <div class="vector-input-header"><i class="fas fa-ban"></i> Piping</div>
                            <div class="form-group">
                                <label for="pipe-size">Line Size (NPS)</label>
                                <select id="pipe-size">
                                    <option value="2">2"</option>
                                    <option value="3">3"</option>
                                    <option value="4" selected>4"</option>
                                    <option value="6">6"</option>
                                    <option value="8">8"</option>
                                    <option value="10">10"</option>
                                    <option value="12">12"</option>
                                    <option value="24">24"</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-top:10px;">
                                <label for="schedule">Schedule</label>
                                <select id="schedule">
                                    <option value="40" selected>Sch 40 (Std)</option>
                                    <option value="80">Sch 80 (XS)</option>
                                </select>
                            </div>
                        </div>
                        <div class="vector-input-group">
                            <div class="vector-input-header"><i class="fas fa-wind"></i> Flow Rate</div>
                            <div class="form-group">
                                <label for="velocity">Velocity [m/s] <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Required for Conditioner Pressure Loss calc.</span></span></label>
                                <input type="number" id="velocity" value="5.0" step="0.1">
                            </div>
                            <div class="form-group" style="margin-top:10px;">
                                <label for="density">Fluid Density [kg/m³]</label>
                                <input type="number" id="density" value="1000" step="10">
                            </div>
                        </div>
                    </div>

                    <!-- Installation -->
                    <h4 style="color: var(--primary); margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 5px; margin-top: 20px;">2. Installation Details</h4>
                    <div class="form-row">
                        <div class="vector-input-group">
                            <div class="vector-input-header"><i class="fas fa-random"></i> Disturbance</div>
                            <div class="form-group">
                                <label for="fitting">Upstream Fitting</label>
                                <select id="fitting">
                                    <option value="single_90">Single 90° Elbow</option>
                                    <option value="two_90_plane">Two 90° Elbows (In Plane)</option>
                                    <option value="two_90_oop">Two 90° Elbows (Out of Plane)</option>
                                    <option value="reducer">Reducer (2D to D)</option>
                                    <option value="expander">Expander (0.5D to D)</option>
                                    <option value="valve_gate">Gate Valve (Fully Open)</option>
                                    <option value="valve_globe">Globe Valve (Partially Open)</option>
                                </select>
                            </div>
                        </div>
                        <div class="vector-input-group">
                            <div class="vector-input-header"><i class="fas fa-filter"></i> Conditioning</div>
                            <div class="form-group">
                                <label for="conditioner">Flow Conditioner</label>
                                <select id="conditioner">
                                    <option value="none" selected>None (Straight Pipe Only)</option>
                                    <option value="bundle">Tube Bundle (19-Tube)</option>
                                    <option value="zanker">Zanker / Gallagher Plate</option>
                                    <option value="spearman">Spearman / CPA (High Perf)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="button-wrapper">
                        <button type="button" id="calculate-btn" class="btn"><i class="fas fa-calculator"></i> Calculate Lengths</button>
                        <button type="button" id="pdf-btn" class="btn btn-outline"><i class="fas fa-file-pdf"></i> Download Datasheet</button>
                    </div>
                </form>
            </div>

            <!-- Results Section -->
            <div id="result-container" class="card hidden" style="margin-top: 40px;">
                <h3><i class="fas fa-poll"></i> Installation Requirements</h3>
                
                <div class="results-grid">
                    <!-- Left Col: Table -->
                    <div>
                        <h4 style="margin-top: 0; color: var(--primary); margin-bottom: 15px;">Required Straight Runs</h4>
                        <table class="results-table">
                            <thead>
                                <tr>
                                    <th>Section</th>
                                    <th>Diameter (D)</th>
                                    <th>Length (mm)</th>
                                </tr>
                            </thead>
                            <tbody id="result-table-body">
                                <!-- Dynamic rows -->
                            </tbody>
                        </table>
                        
                        <div style="margin-top: 20px; background: var(--bg); padding: 15px; border-radius: 6px; border: 1px solid var(--border);">
                            <strong><i class="fas fa-info-circle"></i> Design Note:</strong>
                            <div id="interpretation-text" style="margin-top: 5px; font-size: 0.95rem;"></div>
                        </div>
                    </div>

                    <!-- Right Col: Visual Chart -->
                    <div>
                        <h4 style="margin-top: 0; color: var(--primary); margin-bottom: 15px;">Dynamic Flow Simulation</h4>
                        <div class="chart-container">
                            <canvas id="pipeCanvas" width="400" height="300"></canvas>
                        </div>
                        <div style="text-align: center; margin-top: 10px; font-size: 0.85rem; color: var(--text);">
                            <span style="color: #3B82F6;">● Flow Particles</span> &nbsp;
                            <span style="color: #EF4444;">❚ Meter</span> &nbsp;
                            <span style="color: #F59E0B;">▧ Conditioner</span>
                        </div>
                    </div>
                </div>

                <h4 style="margin-top: 30px; border-top: 1px solid var(--border); padding-top: 20px;">Step-by-Step Engineering Calculation</h4>
                <div id="calculation-details">
                    <!-- Dynamic math steps -->
                </div>

                <div class="standard-reference" style="margin-top: 20px; font-style: italic; color: var(--text);">
                     Calculations based on ISO 5167-2 (2003) Table 4 for Orifice Plates, and manufacturer best practices for other technologies. Conditioner loss coefficients ($K$) are typical approximations.
                </div>
            </div>
        </div>

        <!-- EDUCATIONAL CONTENT SECTION (MASSIVE) -->
        <div class="education-section card">
            <h2><i class="fas fa-lightbulb"></i> Engineering Insights: The Art of Flow Conditioning</h2>
            
            <!-- Insight 1: Why Straight Run? -->
            <div class="insight-card">
                <h4><i class="fas fa-wind"></i> 1. The Physics of Flow Profiles</h4>
                <p>Accurate flow measurement assumes a <strong>Fully Developed Velocity Profile</strong>. In turbulent flow ($Re > 10,000$), this profile is flattened (plug-like) but symmetrical around the pipe axis. Pipe fittings (elbows, valves, tees) destroy this symmetry, introducing errors.</p>
                <ul>
                    <li><strong>Asymmetry:</strong> A single elbow throws the fast-moving fluid to the outside radius due to centrifugal force. The velocity profile becomes skewed. If a flow meter measures this skewed profile, it will read incorrectly (high or low depending on sensor orientation).</li>
                    <li><strong>Swirl:</strong> Two elbows out-of-plane create a corkscrew motion (swirl). Swirl is the most persistent disturbance; it can last for 100+ pipe diameters! It causes massive errors in Orifice ($C_d$ shift), Turbine (over-spin), and Vortex (shedding disruption) meters.</li>
                </ul>
            </div>

            <!-- Insight 2: Beta Ratio Sensitivity -->
            <div class="insight-card">
                <h4><i class="fas fa-compress-arrows-alt"></i> 2. The Beta Ratio ($\beta$) Factor</h4>
                <p>For Differential Pressure (DP) meters like Orifice Plates, the Beta Ratio ($\beta = d/D$) is the primary driver of installation sensitivity.</p>
                <p><strong>High Beta ($\beta > 0.6$):</strong> The orifice hole is large relative to the pipe. The meter samples more of the velocity profile near the pipe walls, making it extremely sensitive to profile distortion. ISO 5167 mandates very long straight runs (e.g., 44D for 2 elbows) to ensure the profile is developed.</p>
                <p><strong>Low Beta ($\beta < 0.4$):</strong> The hole is small. The plate acts as its own flow conditioner, blocking the distorted outer profile and only passing the core flow. Shorter runs are acceptable, but the trade-off is significantly higher permanent pressure loss.</p>
            </div>

            <!-- Insight 3: Meter Technologies -->
            <div class="insight-card">
                <h4><i class="fas fa-microchip"></i> 3. Technology Comparison</h4>
                <p>Different technologies tolerate distortion differently:</p>
                <ul>
                    <li><strong>Orifice / Turbine / Vortex:</strong> Highly sensitive to velocity profile shape. Require 10D - 50D upstream depending on the disturbance severity.</li>
                    <li><strong>Ultrasonic (Multipath):</strong> Modern 4+ path meters can measure asymmetric profiles by averaging chords, reducing straight run needs to ~5D-10D. However, single-path meters are very sensitive.</li>
                    <li><strong>Coriolis:</strong> Measures Mass and Momentum change directly. Independent of velocity profile. Requires <strong>0D Up / 0D Down</strong>. The straight run is only needed for mechanical stress isolation, not flow physics.</li>
                    <li><strong>Magmeter:</strong> Measures average velocity via Faraday's law. Insensitive to profile shape but sensitive to asymmetry. Typically requires 5D Up / 2D Down.</li>
                </ul>
            </div>

            <!-- Insight 4: Flow Conditioners -->
            <div class="insight-card">
                <h4><i class="fas fa-filter"></i> 4. Flow Conditioners: The Space Savers</h4>
                <p>When physical space is not available for 40D of straight pipe, engineers use Flow Conditioners. They function in two ways:</p>
                <ol>
                    <li><strong>Anti-Swirl:</strong> Tube bundles (19 tubes) act like a honeycomb to kill swirl, but they do NOT fix profile asymmetry. They are "Straighteners".</li>
                    <li><strong>Profile Correction:</strong> High-performance plates (Zanker, Spearman, Gallagher) use hole patterns to mix the flow, killing swirl AND restoring a symmetrical profile in a very short distance (e.g., 7D-10D).</li>
                </ol>
                <p><strong>Energy Cost:</strong> Conditioners act as obstructions and add pressure drop (Head Loss). This tool estimates that loss ($h_L = K \cdot v^2/2g$). Tube bundles have low loss ($K \approx 0.75$), while perforated plates have high loss ($K \approx 2.0+$).</p>
            </div>
            
            <!-- Insight 5: ISO 5167 Standards -->
            <div class="insight-card">
                <h4><i class="fas fa-book"></i> 5. ISO 5167 vs. API 14.3 (AGA 3)</h4>
                <p>Standards differ slightly. ISO 5167 (International) is generally more conservative, requiring longer lengths. AGA 3 (USA Natural Gas) allows for slightly shorter runs in specific configurations but is stricter on tube roughness. This calculator follows the ISO 5167-2 logic which is universally accepted as safe practice.</p>
            </div>
        </div>
    </main>    <!-- FOOTER -->
        <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-left">
                    <a href="/" class="footer-logo">
                        <img src="logo.png" alt="Design Calculators Logo" loading="lazy" decoding="async">
                        <span class="footer-logo-text">Design Calculators</span>
                    </a>
                    <p class="footer-description">A comprehensive engineering calculator hub based on IEC, IEEE, and
                        global standards.</p>
                    <div class="social-buttons">
                        <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://designcalculators.co.in"
                            target="_blank" rel="noopener noreferrer" class="social-btn linkedin"
                            aria-label="LinkedIn"><i class="fab fa-linkedin-in"></i></a>
                        <a href="https://www.youtube.com/@designcalculators" target="_blank" rel="noopener noreferrer"
                            class="social-btn youtube" aria-label="YouTube"><i class="fab fa-youtube"></i></a>
                        <a href="https://twitter.com/intent/tweet?url=https://designcalculators.co.in&text=Check%20out%20this%20amazing%20engineering%20calculator%20hub!"
                            target="_blank" rel="noopener noreferrer" class="social-btn twitter" aria-label="Twitter"><i
                                class="fab fa-twitter"></i></a>
                        <a href="https://www.facebook.com/sharer/sharer.php?u=https://designcalculators.co.in"
                            target="_blank" rel="noopener noreferrer" class="social-btn facebook"
                            aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
                        <a href="https://api.whatsapp.com/send?text=Check%20out%20this%20amazing%20engineering%20resource:%20https://designcalculators.co.in"
                            target="_blank" rel="noopener noreferrer" class="social-btn whatsapp"
                            aria-label="WhatsApp"><i class="fab fa-whatsapp"></i></a>
                    </div>
                </div>
                <div class="footer-right">
                    <div class="footer-col">
                        <h4>Quick Links</h4>
                        <ul>
                            <li><a href='/indexele.html'>Electrical Tools</a></li>
                            <li><a href='/indexmech.html'>Mechanical Tools</a></li>
                            <li><a href='/indexinst.html'>Instrumentation Tools</a></li>
                            <li><a href='/about.html'>About Us</a></li>
                            <li><a href='/faq.html'>FAQ</a></li>
                        </ul>
                    </div>
                    <div class="footer-col">
                        <h4>Learn More</h4>
                        <ul>
                            <li><a href="https://www.youtube.com/@designcalculators" target="_blank"
                                    rel="noopener noreferrer">YouTube Channel</a></li>
                            <li><a href='/contact.html'>Contact Us</a></li>
                            <li><a href='/privacy-policy.html'>Privacy Policy</a></li>
                            <li><a href='/terms-of-service.html'>Terms of Service</a></li>
                            <li><a href='/sitemap2.html'>Sitemap</a></li>
                        </ul>
                    </div>
                    <div class="footer-col">
                        <h4>Our Network</h4>
                        <ul>
                            <li style="margin-bottom: 12px;">
                                <a href="https://reliabilitytools.co.in/" target="_blank" rel="noopener"
                                   style="font-weight: 600; display: block; margin-bottom: 2px;">Reliability Tools</a>
                                <span style="font-size: 0.85rem; color: #94a3b8; line-height: 1.3; display: block;">Reliability
                                    & maintenance engineering calculators.</span>
                            </li>
                            <li style="margin-bottom: 12px;">
                                <a href="https://electrosafe.homes/" target="_blank" rel="noopener"
                                   style="font-weight: 600; display: block; margin-bottom: 2px;">ElectroSafe</a>
                                <span style="font-size: 0.85rem; color: #94a3b8; line-height: 1.3; display: block;">Dedicated
                                    to home electrical safety & protection.</span>
                            </li>
                            <li>
                                <a href="https://knowyourname.co.in/" target="_blank" rel="noopener"
                                   style="font-weight: 600; display: block; margin-bottom: 2px;">KnowYourName</a>
                                <span style="font-size: 0.85rem; color: #94a3b8; line-height: 1.3; display: block;">Scientific
                                    name analysis: Phonetics, Ergonomics & Acoustics.</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="footer-disclaimer">
                <p>All calculations are for preliminary engineering design guidance. Final designs must comply with all applicable local and international standards (including but not limited to ASHRAE 90.1, ARI 550/590). Always verify calculations and consult with a licensed professional engineer before implementation or construction.</p>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Design Calculators. Created by <span style="color: var(--secondary); font-weight: bold;">Anil Sharma</span>. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        // Global State
        let lastResult = null;
        let particles = [];
        let animationId = null;

        // Pipe DB (NPS -> ID inches)
        const pipeDB = {
            '2': 2.067, '3': 3.068, '4': 4.026, '6': 6.065,
            '8': 7.981, '10': 10.020, '12': 12.000, '24': 23.25
        };

        // Conditioner K-Factors (Approx)
        const condK = {
            'none': 0,
            'bundle': 0.75,
            'zanker': 1.5,
            'spearman': 2.5
        };

        // Meter Requirements Table (Diameters Upstream)
        const reqTable = {
            'orifice': {
                'single_90': { b04: 16, b06: 42, b075: 44 },
                'two_90_plane': { b04: 10, b06: 44, b075: 60 }, 
                'two_90_oop': { b04: 30, b06: 60, b075: 75 }, 
                'reducer': { b04: 5, b06: 12, b075: 20 },
                'expander': { b04: 12, b06: 25, b075: 35 },
                'valve_gate': { b04: 12, b06: 18, b075: 25 },
                'valve_globe': { b04: 20, b06: 35, b075: 50 },
                'downstream': { b04: 5, b06: 6, b075: 8 }
            },
            'ultrasonic': { up: 10, down: 5 },
            'coriolis': { up: 0, down: 0 },
            'mag': { up: 5, down: 2 },
            'vortex': { up: 20, down: 5 },
            'turbine': { up: 15, down: 5 },
            'venturi': { up: 10, down: 4 }
        };

        function toggleBeta() {
            const type = document.getElementById('meter-type').value;
            const group = document.getElementById('beta-group');
            if (type === 'orifice' || type === 'venturi') {
                group.classList.remove('hidden');
            } else {
                group.classList.add('hidden');
            }
        }

        function loadPreset(type) {
            if (type === 'orifice_standard') {
                document.getElementById('meter-type').value = 'orifice';
                toggleBeta();
                document.getElementById('beta-ratio').value = '0.5';
                document.getElementById('fitting').value = 'single_90';
                document.getElementById('pipe-size').value = '4';
                document.getElementById('velocity').value = '5.0';
            } else if (type === 'orifice_high') {
                document.getElementById('meter-type').value = 'orifice';
                toggleBeta();
                document.getElementById('beta-ratio').value = '0.73';
                document.getElementById('fitting').value = 'two_90_oop';
                document.getElementById('pipe-size').value = '6';
                document.getElementById('velocity').value = '10.0';
            } else if (type === 'mag_tight') {
                document.getElementById('meter-type').value = 'mag';
                toggleBeta();
                document.getElementById('fitting').value = 'reducer';
                document.getElementById('pipe-size').value = '3';
                document.getElementById('velocity').value = '2.0';
            }
            displayMessage(`${type.toUpperCase()} scenario loaded.`, "success");
        }

        function displayMessage(message, type = "info") {
            let messageBox = document.getElementById('message-box');
            messageBox.textContent = message;
            if (type === "error") messageBox.style.backgroundColor = 'var(--danger)';
            else if (type === "success") messageBox.style.backgroundColor = 'var(--success)';
            else messageBox.style.backgroundColor = 'var(--primary)';
            messageBox.classList.add('show');
            setTimeout(() => messageBox.classList.remove('show'), 4000);
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Theme handling
            const themeSwitch = document.getElementById('theme-switch');
            if (themeSwitch && localStorage.getItem('theme') === 'dark') {
                document.body.classList.add('dark-mode');
                themeSwitch.checked = true;
            }
            if(themeSwitch) {
                themeSwitch.addEventListener('change', function() {
                    document.body.classList.toggle('dark-mode');
                    localStorage.setItem('theme', this.checked ? 'dark' : 'light');
                });
            }

            toggleBeta(); 
            document.getElementById('calculate-btn').addEventListener('click', performCalculation);
            document.getElementById('pdf-btn').addEventListener('click', generatePDF);
        });

        function performCalculation() {
            // 1. Get Inputs
            const type = document.getElementById('meter-type').value;
            const fitting = document.getElementById('fitting').value;
            const beta = parseFloat(document.getElementById('beta-ratio').value);
            const nps = document.getElementById('pipe-size').value;
            const cond = document.getElementById('conditioner').value;
            const velocity = parseFloat(document.getElementById('velocity').value);
            const density = parseFloat(document.getElementById('density').value);

            if (isNaN(beta) || beta <= 0 || beta >= 1 || isNaN(velocity)) {
                displayMessage("Please check input values.", "error");
                return;
            }

            // 2. Logic Engine
            let upD = 0;
            let downD = 0;
            let logicText = "";

            if (type === 'orifice') {
                const rules = reqTable.orifice[fitting];
                if (!rules) { upD = 20; }
                else {
                    if (beta <= 0.4) upD = rules.b04;
                    else if (beta <= 0.6) {
                        const r = (beta - 0.4) / 0.2;
                        upD = rules.b04 + r * (rules.b06 - rules.b04);
                    } else {
                        const r = (beta - 0.6) / 0.15;
                        upD = rules.b06 + r * (rules.b075 - rules.b06);
                    }
                }
                
                const dRules = reqTable.orifice.downstream;
                if (beta <= 0.4) downD = dRules.b04;
                else if (beta <= 0.6) downD = dRules.b06;
                else downD = dRules.b075;
                
                logicText = `Based on ISO 5167-2 for $\\beta=${beta}$.`;
            } else {
                upD = reqTable[type].up;
                downD = reqTable[type].down;
                logicText = `Standard manufacturer recommendation for ${type.toUpperCase()}.`;
            }

            // Conditioner Effect
            if (cond !== 'none') {
                let target = upD;
                if (cond === 'bundle') target = Math.min(upD, 18);
                if (cond === 'zanker') target = Math.min(upD, 12);
                if (cond === 'spearman') target = Math.min(upD, 7);
                
                if (fitting === 'two_90_oop' && cond !== 'none') {
                     target = Math.min(target, 10);
                }
                
                if (target < upD) {
                    logicText += `<br>Conditioner reduced Upstream from ${upD.toFixed(1)}D to ${target.toFixed(1)}D.`;
                    upD = target;
                }
            }

            // Pressure Drop Calc
            const K = condK[cond];
            // dP = K * rho * v^2 / 2
            const dP_Pa = K * density * Math.pow(velocity, 2) / 2;
            const dP_bar = dP_Pa / 100000;

            // Physical Lengths
            const id_in = pipeDB[nps];
            const id_mm = id_in * 25.4;
            const len_up_mm = upD * id_mm;
            const len_down_mm = downD * id_mm;

            lastResult = { type, fitting, beta, upD, downD, len_up_mm, len_down_mm, id_mm, logicText, cond, dP_bar };

            // 4. Render Step-by-Step
            let html = `<h4>Step 1: Base Requirement Lookup</h4>`;
            html += `<div class="calculation-step">`;
            html += `Meter: <strong>${type.toUpperCase()}</strong>. Disturbance: ${fitting.replace(/_/g, ' ')}.<br>`;
            if (type === 'orifice') html += `Beta Ratio $\\beta = ${beta}$.<br>`;
            html += `Base Upstream Requirement: <strong>${(type === 'orifice' ? 'Calculated from ISO Table' : upD + 'D')}</strong>.`;
            html += `</div>`;

            if (cond !== 'none') {
                html += `<h4>Step 2: Conditioner Correction</h4>`;
                html += `<div class="calculation-step">`;
                html += `Flow Conditioner: ${cond}. Loss Coeff $K \\approx ${K}$.<br>`;
                html += `Pressure Loss $\\Delta P = K \\frac{\\rho v^2}{2} = ${K} \\frac{${density} \\cdot ${velocity}^2}{2} = \\mathbf{${dP_bar.toFixed(4)} \\text{ bar}}$<br>`;
                html += `Reduces development length by straightening flow profile.`;
                html += `</div>`;
            }

            html += `<h4>Step 3: Dimensional Calculation</h4>`;
            html += `<div class="calculation-step">`;
            html += `Pipe ID (${nps}" Sch 40): ${id_mm.toFixed(1)} mm.<br>`;
            html += `$$ L_{upstream} = ${upD.toFixed(1)} \\times ${id_mm.toFixed(1)} = \\mathbf{${Math.round(len_up_mm)} \\text{ mm}} $$<br>`;
            html += `$$ L_{downstream} = ${downD.toFixed(1)} \\times ${id_mm.toFixed(1)} = \\mathbf{${Math.round(len_down_mm)} \\text{ mm}} $$`;
            html += `</div>`;

            document.getElementById('calculation-details').innerHTML = html;

            // 5. Update Table
            const tbody = document.getElementById('result-table-body');
            tbody.innerHTML = '';
            const addRow = (n, v, u) => {
                tbody.innerHTML += `<tr><td><strong>${n}</strong></td><td>${v}</td><td>${u}</td></tr>`;
            };
            addRow("Upstream (U)", upD.toFixed(1) + " D", Math.round(len_up_mm) + " mm");
            addRow("Downstream (D)", downD.toFixed(1) + " D", Math.round(len_down_mm) + " mm");
            if(cond !== 'none') addRow("Conditioner Loss", dP_bar.toFixed(4) + " bar", "Energy Cost");
            addRow("Pipe ID", "1 D", id_mm.toFixed(1) + " mm");

            const interpEl = document.getElementById('interpretation-text');
            if (type === 'coriolis') {
                interpEl.innerHTML = `<span style="color:var(--success);">Robust.</span> Coriolis meters are generally immune to flow profile. 0D/0D is standard, but supports are critical.`;
            } else if (upD > 40) {
                interpEl.innerHTML = `<span style="color:var(--warning);">Extreme Length Required.</span> High Beta + Swirl requires massive straight runs. Strongly consider a Flow Conditioner.`;
            } else {
                interpEl.innerHTML = `Standard installation requirements.`;
            }

            // 6. Start Animation
            initSimulation(fitting, cond, velocity);

            // 7. Show
            document.getElementById('result-container').classList.remove('hidden');
            if(window.MathJax) window.MathJax.typesetPromise([document.getElementById('calculation-details')]);
            document.getElementById('result-container').scrollIntoView({ behavior: 'smooth' });
        }

        // --- PARTICLE SYSTEM ---
        class Particle {
            constructor(canvas, fitting, conditioner, velocity) {
                this.canvas = canvas;
                this.reset(fitting, conditioner, velocity, true);
            }

            reset(fitting, conditioner, velocity, initial) {
                this.x = initial ? Math.random() * this.canvas.width : 0;
                this.y = (Math.random() * 0.8 + 0.1) * this.canvas.height; // Stay inside pipe
                this.baseSpeed = Math.max(2, velocity); // Visual speed
                
                // Disturbance Logic
                this.vy = 0;
                this.swirl = 0;

                if (fitting.includes('90')) {
                    // Skew to top or bottom
                    if (this.x < 100) this.vy = (Math.random() - 0.5) * 2; 
                } 
                if (fitting.includes('oop')) {
                    // Swirl
                    this.swirl = (this.y - this.canvas.height/2) * 0.1;
                }
                
                this.condX = this.canvas.width * 0.4; // Conditioner pos
                this.hasConditioner = conditioner !== 'none';
            }

            update() {
                this.x += this.baseSpeed;
                
                // Swirl effect
                if (this.swirl !== 0 && (!this.hasConditioner || this.x < this.condX)) {
                    this.y += Math.sin(this.x * 0.05) * this.swirl;
                }

                // Fitting turbulence decay
                if (this.x < 150) {
                     this.y += this.vy;
                } else {
                    // Gradual straightening
                    if (!this.hasConditioner) {
                        // Natural decay
                         // Move slowly back to streamline? 
                    }
                }

                // Conditioner Effect
                if (this.hasConditioner && this.x > this.condX) {
                    // Straighten immediately
                    this.swirl = 0;
                    this.vy = 0;
                }

                if (this.x > this.canvas.width) this.reset("", "", this.baseSpeed, false);
            }

            draw(ctx) {
                ctx.fillStyle = '#3B82F6';
                ctx.beginPath();
                ctx.arc(this.x, this.y, 2, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function initSimulation(fitting, conditioner, velocity) {
            const canvas = document.getElementById('pipeCanvas');
            const ctx = canvas.getContext('2d');
            const cw = canvas.width;
            const ch = canvas.height;
            
            // Re-init particles
            particles = [];
            for(let i=0; i<100; i++) {
                particles.push(new Particle(canvas, fitting, conditioner, velocity));
            }

            if (animationId) cancelAnimationFrame(animationId);

            function animate() {
                ctx.clearRect(0, 0, cw, ch);
                
                // Draw Pipe Walls
                ctx.strokeStyle = '#334155';
                ctx.lineWidth = 4;
                ctx.beginPath();
                ctx.moveTo(0, 10); ctx.lineTo(cw, 10);
                ctx.moveTo(0, ch-10); ctx.lineTo(cw, ch-10);
                ctx.stroke();

                // Draw Fitting Area
                ctx.fillStyle = '#E2E8F0';
                ctx.fillRect(0, 10, 50, ch-20);
                ctx.fillStyle = '#64748B';
                ctx.font = '12px Inter';
                ctx.fillText("Fitting", 5, ch/2);

                // Draw Conditioner
                if (conditioner !== 'none') {
                    const condX = cw * 0.4;
                    ctx.fillStyle = '#F59E0B';
                    ctx.fillRect(condX, 10, 10, ch-20); // Plate
                    ctx.fillText("Conditioner", condX-20, ch-15);
                }

                // Draw Meter
                const meterX = cw * 0.8;
                ctx.fillStyle = '#EF4444';
                ctx.fillRect(meterX, 10, 20, ch-20);
                ctx.fillText("Meter", meterX-10, ch-15);

                // Update & Draw Particles
                particles.forEach(p => {
                    p.update();
                    p.draw(ctx);
                });

                animationId = requestAnimationFrame(animate);
            }
            animate();
        }

        function generatePDF() {
            if (!lastResult) {
                displayMessage("Calculate first.", "error");
                return;
            }
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            let y = 15;

            // Header
            pdf.setFont('helvetica', 'bold');
            pdf.setFontSize(16);
            pdf.setTextColor(30, 58, 138); 
            pdf.text('Flow Meter Installation Report', 105, y, { align: 'center' });
            y += 10;

            pdf.setFontSize(10);
            pdf.setTextColor(100);
            pdf.text(`Date: ${new Date().toLocaleString()}`, 105, y, { align: 'center' });
            y += 15;

            // Inputs
            pdf.setFontSize(12);
            pdf.setTextColor(0);
            pdf.text('1. Design Inputs', 14, y);
            y += 5;

            const inputData = [
                ['Meter Type', lastResult.type.toUpperCase()],
                ['Fitting', lastResult.fitting.replace(/_/g, ' ')],
                ['Beta Ratio', lastResult.type === 'orifice' ? lastResult.beta : 'N/A'],
                ['Conditioner', lastResult.cond.toUpperCase()]
            ];

            pdf.autoTable({
                startY: y,
                head: [['Parameter', 'Value']],
                body: inputData,
                margin: { left: 14, right: 14 },
                theme: 'grid',
                headStyles: { fillColor: [30, 58, 138] }
            });
            y = pdf.lastAutoTable.finalY + 15;

            // Results
            pdf.text('2. Requirements', 14, y);
            y += 5;

            const resData = [
                ['Upstream Length', `${lastResult.upD.toFixed(1)} D (${Math.round(lastResult.len_up_mm)} mm)`],
                ['Downstream Length', `${lastResult.downD.toFixed(1)} D (${Math.round(lastResult.len_down_mm)} mm)`],
                ['Pipe ID', `${lastResult.id_mm.toFixed(1)} mm`],
                ['Conditioner Loss', lastResult.cond !== 'none' ? `${lastResult.dP_bar.toFixed(4)} bar` : 'N/A']
            ];

            pdf.autoTable({
                startY: y,
                head: [['Section', 'Requirement']],
                body: resData,
                margin: { left: 14, right: 14 },
                theme: 'grid',
                headStyles: { fillColor: [30, 58, 138] },
                didParseCell: function(data) {
                    if(data.row.index === 0) {
                        data.cell.styles.fontStyle = 'bold';
                    }
                }
            });

            // Footer
            y = pdf.lastAutoTable.finalY + 20;
            pdf.setFontSize(8);
            pdf.setTextColor(150);
            pdf.text('Calculated based on ISO 5167 and industry standards.', 105, y, { align: 'center' });

            pdf.save('Flow_Install_Report.pdf');
            displayMessage("PDF Downloaded", "success");
        }
    </script>
</body>
</html>
