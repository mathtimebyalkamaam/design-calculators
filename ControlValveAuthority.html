<!DOCTYPE html>
<html lang="en">
<head>
    <!-- AdSense & Analytics -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5936527763614780" crossorigin="anonymous"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-23Y1V450SR"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-23Y1V450SR');
    </script>
    
    <!-- SEO Meta Tags -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Valve Authority & Installed Characteristic Analyzer - Industrial Grade</title>
    <meta name="description" content="Professional Control Valve Authority Calculator. Analyze Installed Flow Characteristics, Gain Distortion, and Energy Loss based on Valve Authority (N). Visualizes Inherent vs Installed curves.">
    <meta name="keywords" content="valve authority, control valve sizing, installed characteristic, inherent characteristic, valve gain, pressure drop, IEC 60534, pump head, instrumentation, process control">
    <meta name="author" content="Design Calculators">
    <meta name="robots" content="index, follow">

    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Montserrat:wght@700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>

    <!-- Chart.js for Visuals -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1/dist/chartjs-plugin-annotation.min.js"></script>

    <!-- MathJax for Formulas -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['\\(', '\\)'], ['$', '$']],
                displayMath: [['\\[', '\\]'], ['$$', '$$']]
            },
            svg: { fontCache: 'global' }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <!-- Favicon Links -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">

    <style>
        /* --- CORE THEME (Blue Industrial - Matches Symmetrical Components) --- */
        :root {
            --primary: #1E3A8A; /* Dark Blue */
            --secondary: #2563EB; /* Bright Blue */
            --accent: #F59E0B; /* Amber */
            --success: #10B981;
            --danger: #DC2626;
            --warning: #F59E0B;
            --bg: #F8FAFC;
            --card: #FFFFFF;
            --text: #4B5563;
            --heading: #111827;
            --footer-bg: #0F172A;
            --border: #E2E8F0;
            --grad: linear-gradient(135deg, var(--primary), var(--secondary));
            --grad-dark: linear-gradient(135deg, #0F172A, #1E293B);
            --shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        body.dark-mode {
            --primary: #10B981;
            --secondary: #34D399;
            --bg: #0F172A;
            --card: #1E293B;
            --text: #CBD5E1;
            --heading: #F1F5F9;
            --footer-bg: #020617;
            --border: #334155;
            --accent: #F59E0B;
        }

        * { box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.7;
            margin: 0;
            padding: 0;
        }

        .container { max-width: 1280px; margin: 0 auto; padding: 0 24px; }

        /* Header & Nav */
        header {
            background: var(--grad);
            color: white;
            padding: 24px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo-container {
            display: flex;
            flex-direction: column;
            text-decoration: none;
            color: white;
        }
        .logo-text {
            font-size: 1.75rem;
            font-weight: 800;
            font-family: 'Montserrat', sans-serif;
        }
        .logo-subtitle {
            font-size: 0.8rem;
            margin: 4px 0 0 0;
            color: #E0E7FF;
            opacity: 0.9;
        }
        .nav-links {
            display: flex;
            gap: 24px;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        .nav-links a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }
        .nav-links a:hover { color: var(--accent); }
        
        /* Theme Toggle */
        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
            color: white;
        }
        .switch {
            position: relative;
            width: 56px;
            height: 30px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0,0,0,0.2);
            transition: .4s;
            border-radius: 30px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 22px; width: 22px;
            left: 4px; bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(26px); }

        /* Main Content & Cards */
        main { padding: 40px 0; }
        .card {
            background: var(--card);
            border-radius: 12px;
            padding: 30px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            border: 1px solid var(--border);
            animation: fadeIn 0.6s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .card h2 {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
            padding-bottom: 15px;
            margin-top: 0;
            font-family: 'Montserrat', sans-serif;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        h3 {
            color: var(--heading);
            font-family: 'Montserrat', sans-serif;
            font-size: 1.5rem;
            margin-top: 25px;
            margin-bottom: 20px;
        }

        /* Forms */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .form-group { margin-bottom: 0; }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--heading);
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 6px;
            background-color: var(--bg);
            color: var(--text);
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        .form-group input:focus, .form-group select:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
        }
        body.dark-mode .form-group input:focus { 
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        /* Buttons */
        .btn {
            background: var(--grad);
            color: white;
            border: none;
            padding: 16px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(30, 58, 138, 0.3);
            transition: all 0.3s;
            width: 100%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(30, 58, 138, 0.4);
        }
        .btn-outline {
            background: transparent;
            border: 2px solid var(--secondary);
            color: var(--secondary);
            font-size: 0.9rem;
            padding: 8px 16px;
        }
        .btn-outline:hover {
            background: var(--secondary);
            color: white;
        }
        .button-wrapper {
            display: flex;
            justify-content: center;
            width: 100%;
            padding-top: 15px;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        /* Quick Load Buttons */
        .preset-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        .preset-btn {
            padding: 8px 12px;
            font-size: 0.85rem;
            border: 1px solid var(--border);
            background: var(--card);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .preset-btn:hover {
            background: var(--bg);
            border-color: var(--secondary);
            color: var(--secondary);
        }

        /* Results Layout */
        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            align-items: start;
        }
        @media (max-width: 1024px) {
            .results-grid { grid-template-columns: 1fr; }
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-radius: 8px;
            overflow: hidden;
        }
        .results-table th, .results-table td {
            padding: 14px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        .results-table th {
            background: var(--grad);
            color: white;
            font-weight: 700;
        }
        .results-table tr:nth-child(even) { background-color: var(--bg); }
        .results-table td:first-child {
            font-weight: 600;
            color: var(--heading);
        }
        .highlight { color: var(--success); font-weight: 700; }
        .danger-text { color: var(--danger); font-weight: 700; }

        /* Canvas Container */
        .chart-container {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            position: relative;
            height: 400px;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        canvas {
            max-width: 100%;
            max-height: 100%;
        }

        /* Educational Section Styling */
        .insight-card {
            background: linear-gradient(135deg, var(--card), rgba(37,99,235,0.03));
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            border-left: 5px solid var(--secondary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: all 0.3s;
        }
        .insight-card:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .insight-card h4 {
            color: var(--secondary);
            font-size: 1.3rem;
            margin: 0 0 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: 'Montserrat', sans-serif;
        }
        .insight-card p, .insight-card ul {
            margin: 10px 0;
            line-height: 1.8;
            color: var(--text);
        }
        .insight-card ul { padding-left: 20px; }
        .insight-card li { margin-bottom: 8px; }

        /* Formulas & Steps */
        .formula {
            background: var(--bg);
            border-left: 3px solid var(--accent);
            padding: 15px;
            margin: 12px 0;
            font-size: 1.1rem;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
            color: var(--heading);
        }
        .calculation-step {
            font-family: 'Courier New', monospace;
            background-color: rgba(0,0,0,0.03);
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            border-left: 4px solid var(--success);
            font-size: 0.95rem;
            line-height: 1.6;
        }
        body.dark-mode .calculation-step { background-color: rgba(255,255,255,0.05); }

        /* Vector Input Group Styling (Reused) */
        .vector-input-group {
            background: var(--bg);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border);
            position: relative;
        }
        .vector-input-header {
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Print Styling */
        @media print {
            header, footer, .education-section, .theme-toggle, .button-wrapper, .preset-container { display: none !important; }
            .card { border: none; shadow: none; padding: 0; }
            .container { width: 100%; max-width: 100%; padding: 0; }
            .results-grid { grid-template-columns: 1fr 1fr; }
            .chart-container { height: 300px; page-break-inside: avoid; }
        }

        /* Message Box */
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 16px 28px;
            border-radius: 8px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.25);
            z-index: 10000;
            font-weight: 600;
            color: white;
            opacity: 0;
            transition: all 0.4s;
            display: none;
        }
        .message-box.show { display: block; opacity: 1; top: 30px; }
        .hidden { display: none; }

        /* Tooltip */
        .info-icon { color: var(--secondary); margin-left: 5px; cursor: help; }
        .tooltip { position: relative; display: inline-block; }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 220px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -110px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.85rem;
            font-weight: 400;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }

        /* Footer */
        footer {
            background: var(--grad-dark);
            color: #CBD5E1;
            padding: 50px 0 20px 0;
            margin-top: 60px;
        }
        .footer-content {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 40px;
            margin-bottom: 30px;
        }
        .footer-col { flex: 1; min-width: 200px; }
        .footer-col h4 { color: white; margin-bottom: 15px; font-weight: 700; }
        .footer-col ul { list-style: none; padding: 0; margin: 0; }
        .footer-col a { color: #CBD5E1; text-decoration: none; transition: color 0.3s; }
        .footer-col a:hover { color: var(--accent); }
        .social-buttons { display: flex; gap: 12px; margin-top: 15px; }
        .social-btn {
            width: 40px; height: 40px;
            display: flex; justify-content: center; align-items: center;
            color: white; border-radius: 50%;
            font-size: 1.1rem; transition: transform 0.3s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .social-btn:hover { transform: translateY(-4px); }
        .social-btn.linkedin { background-color: #0A66C2; }
        .social-btn.youtube { background-color: #FF0000; }
        .social-btn.twitter { background-color: #1DA1F2; }
        .social-btn.facebook { background-color: #1877F2; }
        .social-btn.whatsapp { background-color: #25D366; }
        .footer-disclaimer {
            text-align: center; padding-top: 25px;
            border-top: 1px solid #334155;
            max-width: 800px; margin: 0 auto;
            font-size: 0.9rem;
        }
        .footer-bottom {
            text-align: center; padding-top: 20px;
            font-size: 0.9rem; color: #94A3B8;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container { padding: 0 15px; }
            .navbar { flex-direction: column; gap: 20px; }
            .nav-links { flex-direction: column; gap: 12px; text-align: center; }
            .form-row { grid-template-columns: 1fr; }
            .card { padding: 20px; }
            .footer-content { flex-direction: column; gap: 25px; }
        }
    </style>
</head>
<body>
    <div id="message-box" class="message-box"></div>
    <header>
        <div class="container">
            <nav class="navbar">
                <a href="#" class="logo-container">
                    <span class="logo-text">Design Calculators</span>
                    <p class="logo-subtitle">Inspired by standards such as IEC, IEEE, ISA, ASME, and API.</p>
                </a>
                <ul class="nav-links">
                    <li><a href='/'>Home</a></li>
                    <li><a href="articles.html">Articles</a></li>
                    <li><a href="indexmech.html">Mechanical</a></li>
                    <li><a href="indexele.html">Electrical</a></li>
                    <li><a href="indexinst.html">Instrumentation</a></li>
                </ul>
                <div class="theme-toggle">
                    <i class="fas fa-sun"></i>
                    <label class="switch">
                        <input type="checkbox" id="theme-switch">
                        <span class="slider"></span>
                    </label>
                    <i class="fas fa-moon"></i>
                </div>
            </nav>
        </div>
    </header>

    <main class="container">
        <div class="card">
            <h2><i class="fas fa-sliders-h"></i> Control Valve Authority & Installed Characteristic Analyzer</h2>
            
            <div class="tool-description">
                <p>This industrial-grade calculator evaluates <strong>Valve Authority ($N$)</strong> and simulates the <strong>Installed Flow Characteristic</strong>. It quantifies how system pressure losses distort the valve's inherent curve (Linear/EQ%) and calculates the <strong>Installed Gain</strong> to predict control loop stability. Includes Pump Energy Audit.</p>
            </div>

            <div class="calculator-form">
                <form id="authority-form">
                    <!-- Controls Row -->
                    <div class="form-row" style="align-items: end;">
                        <div class="form-group">
                            <label>Quick Load Scenarios:</label>
                            <div class="preset-container" style="margin-bottom: 0;">
                                <button type="button" class="preset-btn" onclick="loadPreset('good_auth')"><i class="fas fa-check-circle"></i> Good Authority (N=0.5)</button>
                                <button type="button" class="preset-btn" onclick="loadPreset('bad_auth')"><i class="fas fa-exclamation-triangle"></i> Poor Authority (N=0.1)</button>
                                <button type="button" class="preset-btn" onclick="loadPreset('pump_sys')"><i class="fas fa-water"></i> Pump System (Dynamic)</button>
                            </div>
                        </div>
                    </div>

                    <!-- Valve Specs -->
                    <h4 style="color: var(--primary); margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 5px;">1. Valve Specifications</h4>
                    <div class="form-row">
                        <div class="vector-input-group">
                            <div class="vector-input-header"><i class="fas fa-cogs"></i> Performance</div>
                            <div class="form-group">
                                <label for="valve-cv">Rated Cv ($C_{v,100}$) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Flow coefficient at 100% opening.</span></span></label>
                                <input type="number" id="valve-cv" value="100" step="1">
                            </div>
                            <div class="form-group" style="margin-top: 10px;">
                                <label for="characteristic">Trim Characteristic</label>
                                <select id="characteristic">
                                    <option value="linear">Linear</option>
                                    <option value="eq_percent" selected>Equal Percentage (EQ%)</option>
                                    <option value="quick_open">Quick Opening</option>
                                </select>
                            </div>
                        </div>
                        <div class="vector-input-group">
                            <div class="vector-input-header"><i class="fas fa-tint"></i> Fluid</div>
                            <div class="form-group">
                                <label for="sg">Specific Gravity (SG)</label>
                                <input type="number" id="sg" value="1.0" step="0.01">
                            </div>
                        </div>
                    </div>

                    <!-- Process Data -->
                    <h4 style="color: var(--primary); margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 5px; margin-top: 20px;">2. System & Process Data</h4>
                    <div class="form-row">
                        <div class="vector-input-group">
                            <div class="vector-input-header"><i class="fas fa-tachometer-alt"></i> Flow Conditions</div>
                            <div class="form-group">
                                <label for="flow-max">Max Design Flow ($Q_{max}$) [gpm]</label>
                                <input type="number" id="flow-max" value="500" step="10">
                            </div>
                        </div>
                        <div class="vector-input-group">
                            <div class="vector-input-header"><i class="fas fa-compress-arrows-alt"></i> Pressure Drops</div>
                            <div class="form-group">
                                <label for="dp-sys">Line Loss @ $Q_{max}$ ($\Delta P_{line}$) [psi] <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Pressure lost to pipes/fittings at max flow. Excludes valve drop.</span></span></label>
                                <input type="number" id="dp-sys" value="10" step="1">
                            </div>
                            <div class="form-group" style="margin-top: 10px;">
                                <label for="dp-valve">Valve Drop @ $Q_{max}$ ($\Delta P_{v,min}$) [psi] <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">If unknown, leave 0. Tool will calculate from Cv and Qmax.</span></span></label>
                                <input type="number" id="dp-valve" value="0" step="0.1">
                            </div>
                        </div>
                    </div>

                    <div class="button-wrapper">
                        <button type="button" id="calculate-btn" class="btn"><i class="fas fa-calculator"></i> Analyze Authority</button>
                        <button type="button" id="pdf-btn" class="btn btn-outline"><i class="fas fa-file-pdf"></i> Download PDF Report</button>
                    </div>
                </form>
            </div>

            <!-- Results Section -->
            <div id="result-container" class="card hidden" style="margin-top: 40px;">
                <h3><i class="fas fa-poll"></i> Performance Analysis</h3>
                
                <div class="results-grid">
                    <!-- Left Col: Table -->
                    <div>
                        <h4 style="margin-top: 0; color: var(--primary); margin-bottom: 15px;">Authority & Gain</h4>
                        <table class="results-table">
                            <thead>
                                <tr>
                                    <th>Parameter</th>
                                    <th>Value</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="result-table-body">
                                <!-- Dynamic rows -->
                            </tbody>
                        </table>
                        
                        <div style="margin-top: 20px; background: var(--bg); padding: 15px; border-radius: 6px; border: 1px solid var(--border);">
                            <strong><i class="fas fa-info-circle"></i> Insight:</strong>
                            <div id="interpretation-text" style="margin-top: 5px; font-size: 0.95rem;"></div>
                        </div>

                        <!-- Mini Pressure Diagram Canvas -->
                        <div style="margin-top: 20px; text-align: center;">
                             <canvas id="schematicCanvas" width="350" height="150" style="border: 1px solid var(--border); border-radius: 4px; background: #fff;"></canvas>
                        </div>
                    </div>

                    <!-- Right Col: Visual Chart -->
                    <div>
                        <h4 style="margin-top: 0; color: var(--primary); margin-bottom: 15px;">Installed Flow Characteristic</h4>
                        <div class="chart-container">
                            <canvas id="flowChart"></canvas>
                        </div>
                        <div style="text-align: center; margin-top: 10px; font-size: 0.85rem; color: var(--text);">
                            <span style="color: #3B82F6; border-bottom: 2px dashed #3B82F6;">-- Inherent (Ideal)</span> &nbsp;
                            <span style="color: #10B981;">● Installed (Real)</span>
                        </div>
                    </div>
                </div>

                <h4 style="margin-top: 30px; border-top: 1px solid var(--border); padding-top: 20px;">Step-by-Step Engineering Calculation</h4>
                <div id="calculation-details">
                    <!-- Dynamic math steps -->
                </div>

                <div class="standard-reference" style="margin-top: 20px; font-style: italic; color: var(--text);">
                     Analysis based on IEC 60534 standards. Distortion calculated assuming constant source pressure ($\Delta P_{total} = \text{const}$).
                </div>
            </div>
        </div>

        <!-- EDUCATIONAL CONTENT SECTION (MASSIVE) -->
        <div class="education-section card">
            <h2><i class="fas fa-lightbulb"></i> Engineering Insights: The Truth About Control Valves</h2>
            
            <!-- Insight 1: Authority Defined -->
            <div class="insight-card">
                <h4><i class="fas fa-balance-scale"></i> 1. What is Valve Authority ($N$)?</h4>
                <p>Valve Authority is the ratio of the pressure drop across the valve compared to the total pressure drop of the entire system (Valve + Pipes + Heat Exchangers) when the valve is fully open.</p>
                <div class="formula">$$ N = \frac{\Delta P_{valve}}{\Delta P_{valve} + \Delta P_{system}} $$</div>
                <p>Ideally, we want the valve to dominate the pressure drop so it stays in control. However, high valve drop wastes energy (pumping costs).
                <ul>
                    <li><strong>N = 1.0 (Ideal):</strong> The valve takes 100% of the drop. No pipe friction. The installed curve matches the manufacturer's curve perfectly.</li>
                    <li><strong>N < 0.1 (Poor):</strong> The pipes take all the drop. As the valve opens, flow increases slightly, but pipe friction eats up the pressure immediately. The flow "flatlines" early. The valve loses control range.</li>
                </ul>
                </p>
            </div>

            <!-- Insight 2: Characteristic Distortion -->
            <div class="insight-card">
                <h4><i class="fas fa-chart-line"></i> 2. Characteristic Distortion: Why Linear becomes Quick Opening</h4>
                <p>Manufacturers sell valves with "Inherent Characteristics" (Linear, EQ%), tested with constant pressure drop in a lab. In the real world, as a valve opens, flow increases, and line friction ($\Delta P_{line} \propto Q^2$) increases. This steals pressure from the valve.</p>
                <p><strong>The Result:</strong>
                <ul>
                    <li>A <strong>Linear</strong> valve installed in a system with low authority ($N=0.1$) will behave like a <strong>Quick Opening</strong> valve. It will reach 80% flow at only 30% lift!</li>
                    <li>An <strong>Equal Percentage (EQ%)</strong> valve is designed specifically to combat this. As authority drops, the EQ% curve distorts "upwards" towards Linear. This is why EQ% is the standard for most process loops.</li>
                </ul>
                </p>
            </div>

            <!-- Insight 3: Gain & Tuning -->
            <div class="insight-card">
                <h4><i class="fas fa-sliders-h"></i> 3. Loop Gain and Tuning Stability</h4>
                <p>The "Gain" of the valve is the slope of the flow curve ($\Delta Flow / \Delta Lift$). For stable control, we want constant gain across the operating range.</p>
                <p>If authority is low, the gain changes drastically.
                <br><strong>At 10% Open:</strong> High Gain (Small move = Big Flow change). Loop oscillates.
                <br><strong>At 80% Open:</strong> Low Gain (Big move = Small Flow change). Loop is sluggish.</p>
                <p>This requires complex adaptive tuning or characterizers. Proper sizing ($N > 0.3$) solves this mechanically.</p>
            </div>

            <!-- Insight 4: Energy Efficiency -->
            <div class="insight-card">
                <h4><i class="fas fa-bolt"></i> 4. The Energy Trade-Off</h4>
                <p>High Authority ($N=0.5$) is great for control but terrible for energy bills. It means you are burning 50% of your pump's energy across the control valve just to maintain controllability.</p>
                <p><strong>Modern Design:</strong> Use Variable Frequency Drives (VFDs) for the primary control and use control valves only for trim/fast-response. Or, accept lower authority ($N=0.2$) but use smart positioners with characterization maps to linearize the response.</p>
            </div>

            <!-- Insight 5: Pump Sizing -->
            <div class="insight-card">
                <h4><i class="fas fa-water"></i> 5. Pump Head Implications</h4>
                <p>When sizing a pump, you must account for the $\Delta P_{valve}$ at max flow.
                <br>If you size for $N=0.5$, your pump head must be double the pipe friction loss.
                <br>If you size for $N=0.1$, your pump is smaller, but your control is worse.
                <br><strong>Gold Standard:</strong> Aim for $N = 0.33$ (Valve drop is 50% of Friction drop, or 33% of Total drop).</p>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-col">
                    <h4>Design Calculators</h4>
                    <p style="font-size: 0.9rem; line-height: 1.6; margin-bottom: 15px;">Empowering engineers with precision tools for complex analysis. If you find this tool helpful, please consider sharing it with your colleagues!</p>
                    <div class="social-buttons">
                        <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn linkedin" aria-label="LinkedIn"><i class="fab fa-linkedin-in"></i></a>
                        <a href="https://www.youtube.com/@designcalculators" target="_blank" rel="noopener noreferrer" class="social-btn youtube" aria-label="YouTube"><i class="fab fa-youtube"></i></a>
                        <a href="https://twitter.com/intent/tweet?url=https://designcalculators.co.in&text=Check%20out%20this%20amazing%20engineering%20calculator%20hub!" target="_blank" rel="noopener noreferrer" class="social-btn twitter" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
                        <a href="https://www.facebook.com/sharer/sharer.php?u=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn facebook" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
                        <a href="https://api.whatsapp.com/send?text=Check%20out%20this%20amazing%20engineering%20resource:%20https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn whatsapp" aria-label="WhatsApp"><i class="fab fa-whatsapp"></i></a>
                    </div>
                </div>
                <div class="footer-col">
                    <h4>Quick Links</h4>
                    <ul>
                        <li><a href='/'>Home</a></li>
                        <li><a href="indexele.html">Electrical</a></li>
                        <li><a href="indexmech.html">Mechanical</a></li>
                        <li><a href="indexinst.html">Instrumentation</a></li>                       
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>Resources</h4>
                    <ul>
                        <li><a href="about.html">About Us</a></li>
                        <li><a href="contact.html">Contact</a></li>
                        <li><a href="faq">FAQ.html</a></li>
                        <li><a href="privacy-policy.html">Privacy Policy</a></li>
                        <li><a href="terms-of-service.html">Terms of Service</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>More</h4>
                    <ul>
                        <li><a href='/articles.html'>Articles & Whitepapers</a></li>
                        <li><a href="sitemap2.html">Sitemap</a></li>                        
                    </ul>
                </div>
            </div>
            <div class="footer-disclaimer">
                <p>All calculations are for preliminary engineering design guidance. Final designs must comply with all applicable local and international standards (including but not limited to IEC 60534, ISA 75.01). Always verify calculations and consult with a licensed professional engineer before implementation or construction.</p>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Design Calculators. Created by <span style="color: var(--secondary); font-weight: bold;">A Sharma</span>. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        // Global State
        let flowChart = null;
        let lastResult = null;

        function loadPreset(type) {
            if (type === 'good_auth') {
                document.getElementById('valve-cv').value = '100';
                document.getElementById('characteristic').value = 'eq_percent';
                document.getElementById('flow-max').value = '500';
                document.getElementById('dp-sys').value = '25'; // Friction
                document.getElementById('dp-valve').value = '0'; // Let calc handle it (approx 25)
                document.getElementById('sg').value = '1.0';
            } else if (type === 'bad_auth') {
                document.getElementById('valve-cv').value = '200'; // Oversized valve
                document.getElementById('characteristic').value = 'linear';
                document.getElementById('flow-max').value = '500';
                document.getElementById('dp-sys').value = '40'; // High friction
                document.getElementById('dp-valve').value = '0'; 
                document.getElementById('sg').value = '1.0';
            } else if (type === 'pump_sys') {
                document.getElementById('valve-cv').value = '80';
                document.getElementById('characteristic').value = 'eq_percent';
                document.getElementById('flow-max').value = '300';
                document.getElementById('dp-sys').value = '30';
                document.getElementById('dp-valve').value = '15'; // Manual input
                document.getElementById('sg').value = '0.9';
            }
            displayMessage(`${type.toUpperCase()} scenario loaded.`, "success");
        }

        function displayMessage(message, type = "info") {
            let messageBox = document.getElementById('message-box');
            messageBox.textContent = message;
            if (type === "error") messageBox.style.backgroundColor = 'var(--danger)';
            else if (type === "success") messageBox.style.backgroundColor = 'var(--success)';
            else messageBox.style.backgroundColor = 'var(--primary)';
            messageBox.classList.add('show');
            setTimeout(() => messageBox.classList.remove('show'), 4000);
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Theme handling
            const themeSwitch = document.getElementById('theme-switch');
            if (themeSwitch && localStorage.getItem('theme') === 'dark') {
                document.body.classList.add('dark-mode');
                themeSwitch.checked = true;
            }
            if(themeSwitch) {
                themeSwitch.addEventListener('change', function() {
                    document.body.classList.toggle('dark-mode');
                    localStorage.setItem('theme', this.checked ? 'dark' : 'light');
                });
            }

            document.getElementById('calculate-btn').addEventListener('click', performCalculation);
            document.getElementById('pdf-btn').addEventListener('click', generatePDF);
        });

        function performCalculation() {
            // 1. Get Inputs
            const Cv_rated = parseFloat(document.getElementById('valve-cv').value);
            const charType = document.getElementById('characteristic').value;
            const Q_max = parseFloat(document.getElementById('flow-max').value);
            const dP_sys = parseFloat(document.getElementById('dp-sys').value); // Friction Loss
            let dP_valve = parseFloat(document.getElementById('dp-valve').value); // Valve Drop
            const sg = parseFloat(document.getElementById('sg').value);

            if (isNaN(Cv_rated) || isNaN(Q_max) || isNaN(dP_sys) || Cv_rated <= 0) {
                displayMessage("Please enter valid positive numbers.", "error");
                return;
            }

            // 2. Physics Engine
            
            // Calculate dP_valve if 0
            if (dP_valve <= 0) {
                // Cv = Q * sqrt(SG / dP) -> dP = SG * (Q/Cv)^2
                dP_valve = sg * Math.pow(Q_max / Cv_rated, 2);
            }

            // Total Dynamic Drop
            const dP_total = dP_valve + dP_sys; // Assume constant source pressure P_in - P_out = dP_total

            // Authority N
            const N = dP_valve / dP_total;

            // Installed Gain Calculation (Max/Min)
            // Need to simulate curve to find max slope

            lastResult = { Cv_rated, charType, Q_max, dP_sys, dP_valve, dP_total, N, sg };

            // 3. Render Step-by-Step (Whiteboard)
            let html = `<h4>Step 1: Valve Pressure Drop ($\Delta P_{valve}$)</h4>`;
            html += `<div class="calculation-step">`;
            html += `At max flow $Q_{max} = ${Q_max} \\text{ gpm}$, Valve $C_v = ${Cv_rated}$.<br>`;
            html += `$$ \\Delta P_{v,min} = G_f \\cdot \\left(\\frac{Q}{C_v}\\right)^2 = ${sg} \\cdot \\left(\\frac{${Q_max}}{${Cv_rated}}\\right)^2 = \\mathbf{${dP_valve.toFixed(2)} \\text{ psi}} $$`;
            html += `</div>`;

            html += `<h4>Step 2: Total System Dynamic Head</h4>`;
            html += `<div class="calculation-step">`;
            html += `$$ \\Delta P_{total} = \\Delta P_{v,min} + \\Delta P_{line} = ${dP_valve.toFixed(2)} + ${dP_sys} = \\mathbf{${dP_total.toFixed(2)} \\text{ psi}} $$<br>`;
            html += `(Assumes Constant Pressure Drop system)`;
            html += `</div>`;

            html += `<h4>Step 3: Authority Calculation ($N$)</h4>`;
            html += `<div class="calculation-step">`;
            html += `$$ N = \\frac{\\Delta P_{v,min}}{\\Delta P_{total}} = \\frac{${dP_valve.toFixed(2)}}{${dP_total.toFixed(2)}} = \\mathbf{${N.toFixed(3)}} $$`;
            html += `</div>`;

            html += `<h4>Step 4: Energy Impact</h4>`;
            html += `<div class="calculation-step">`;
            html += `Hydraulic Power lost across valve:<br>`;
            // HP = Q(gpm) * dP(psi) / 1714
            const hp_loss = (Q_max * dP_valve) / 1714;
            html += `$$ P_{loss} = \\frac{Q \\cdot \\Delta P}{1714} = \\frac{${Q_max} \\cdot ${dP_valve.toFixed(2)}}{1714} = \\mathbf{${hp_loss.toFixed(2)} \\text{ HP}} $$`;
            html += `</div>`;

            document.getElementById('calculation-details').innerHTML = html;

            // 4. Update Table
            const tbody = document.getElementById('result-table-body');
            tbody.innerHTML = '';
            const addRow = (n, v, s, c="") => {
                tbody.innerHTML += `<tr style="${c ? 'color:'+c : ''}"><td><strong>${n}</strong></td><td>${v}</td><td>${s}</td></tr>`;
            };
            
            let statusColor = "";
            let statusText = "";
            if (N < 0.25) {
                statusColor = "var(--danger)";
                statusText = "POOR (Distorted)";
            } else if (N > 0.5) {
                statusColor = "var(--warning)";
                statusText = "GOOD (High Energy Cost)";
            } else {
                statusColor = "var(--success)";
                statusText = "OPTIMAL";
            }

            addRow("Valve Authority (N)", N.toFixed(3), statusText, statusColor);
            addRow("Valve Drop @ Max", dP_valve.toFixed(2) + " psi", ((dP_valve/dP_total)*100).toFixed(1) + "% of Total");
            addRow("Power Loss", hp_loss.toFixed(2) + " HP", "Wasted Energy");

            const interpEl = document.getElementById('interpretation-text');
            if (N < 0.25) {
                interpEl.innerHTML = `<span style="color:var(--danger); font-weight:bold;">Control Issues Likely.</span> The installed characteristic will distort significantly. An EQ% valve will act Linear, Linear will act Quick Open.`;
            } else {
                interpEl.innerHTML = `Control behavior will be predictable.`;
            }

            // 5. Draw Schematic
            drawSchematic(dP_valve, dP_sys);

            // 6. Draw Chart
            drawChart(charType, N);

            // 7. Show
            document.getElementById('result-container').classList.remove('hidden');
            if(window.MathJax) window.MathJax.typesetPromise([document.getElementById('calculation-details')]);
            document.getElementById('result-container').scrollIntoView({ behavior: 'smooth' });
        }

        function drawSchematic(dP_v, dP_l) {
            const canvas = document.getElementById('schematicCanvas');
            const ctx = canvas.getContext('2d');
            const cw = canvas.width;
            const ch = canvas.height;

            ctx.clearRect(0, 0, cw, ch);
            ctx.lineWidth = 2;
            ctx.strokeStyle = '#334155';
            ctx.font = '12px Inter';
            ctx.fillStyle = '#334155';

            // Pipe
            ctx.beginPath();
            ctx.moveTo(20, ch/2);
            ctx.lineTo(120, ch/2); // To valve
            ctx.moveTo(180, ch/2); // From valve
            ctx.lineTo(280, ch/2); // To Load
            
            // Load/Friction (Resistor style)
            ctx.moveTo(280, ch/2);
            ctx.lineTo(290, ch/2 - 10);
            ctx.lineTo(300, ch/2 + 10);
            ctx.lineTo(310, ch/2 - 10);
            ctx.lineTo(320, ch/2 + 10);
            ctx.lineTo(330, ch/2);
            ctx.stroke();

            // Valve Symbol (Bowtie)
            const vx = 150; const vy = ch/2;
            ctx.fillStyle = '#E0F2FE';
            ctx.beginPath();
            ctx.moveTo(vx, vy);
            ctx.lineTo(vx-30, vy-15);
            ctx.lineTo(vx-30, vy+15);
            ctx.lineTo(vx, vy);
            ctx.lineTo(vx+30, vy-15);
            ctx.lineTo(vx+30, vy+15);
            ctx.lineTo(vx, vy);
            ctx.fill();
            ctx.stroke();
            // Stem
            ctx.beginPath();
            ctx.moveTo(vx, vy);
            ctx.lineTo(vx, vy-25);
            ctx.arc(vx, vy-30, 5, 0, 2*Math.PI); // Actuator
            ctx.stroke();

            // Labels
            ctx.fillStyle = '#EF4444';
            ctx.fillText(`ΔP Valve: ${dP_v.toFixed(1)} psi`, vx-40, vy+40);
            
            ctx.fillStyle = '#F59E0B';
            ctx.fillText(`ΔP Line: ${dP_l.toFixed(1)} psi`, 250, vy+40);
        }

        function drawChart(charType, N) {
            const ctx = document.getElementById('flowChart').getContext('2d');
            if (flowChart) flowChart.destroy();

            // Generate Curves
            const labels = [];
            const inherent = [];
            const installed = [];
            
            for (let h = 0; h <= 100; h += 2) {
                const h_frac = h / 100;
                let Cv_rel = 0;

                // Inherent Cv(h) / Cv_max
                if (charType === 'linear') {
                    Cv_rel = h_frac;
                } else if (charType === 'eq_percent') {
                    // R = 50 (Rangeability)
                    Cv_rel = Math.pow(50, h_frac - 1); 
                } else {
                    // Quick Open (Sqrt)
                    Cv_rel = Math.sqrt(h_frac);
                }

                // Installed Flow Q(h) / Q_max
                // Q_rel = 1 / sqrt( 1 + ( (1-N)/N ) * (Cv_rel)^-2 ) ? No
                // Correct formula: Q_rel = Cv_rel / sqrt( N + (1-N)*Cv_rel^2 )
                const Q_rel = Cv_rel / Math.sqrt( N + (1-N)*Math.pow(Cv_rel, 2) );

                labels.push(h);
                inherent.push(Cv_rel * 100);
                installed.push(Q_rel * 100);
            }

            flowChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Inherent (Ideal N=1)',
                            data: inherent,
                            borderColor: '#3B82F6',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointRadius: 0
                        },
                        {
                            label: `Installed (Real N=${N.toFixed(2)})`,
                            data: installed,
                            borderColor: '#10B981',
                            borderWidth: 2,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { title: { display: true, text: '% Valve Opening (Lift)' } },
                        y: { title: { display: true, text: '% Max Flow' }, max: 100 }
                    }
                }
            });
        }

        function generatePDF() {
            if (!lastResult) {
                displayMessage("Calculate first.", "error");
                return;
            }
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            let y = 15;

            // Header
            pdf.setFont('helvetica', 'bold');
            pdf.setFontSize(16);
            pdf.setTextColor(30, 58, 138); 
            pdf.text('Valve Authority Analysis Report', 105, y, { align: 'center' });
            y += 10;

            pdf.setFontSize(10);
            pdf.setTextColor(100);
            pdf.text(`Date: ${new Date().toLocaleString()}`, 105, y, { align: 'center' });
            y += 15;

            // Inputs
            pdf.setFontSize(12);
            pdf.setTextColor(0);
            pdf.text('1. Input Data', 14, y);
            y += 5;

            const inputData = [
                ['Rated Cv', lastResult.Cv_rated],
                ['Characteristic', lastResult.charType],
                ['Max Flow', `${lastResult.Q_max} gpm`],
                ['Line Loss', `${lastResult.dP_sys} psi`],
                ['Calc Valve Drop', `${lastResult.dP_valve.toFixed(2)} psi`]
            ];

            pdf.autoTable({
                startY: y,
                head: [['Parameter', 'Value']],
                body: inputData,
                margin: { left: 14, right: 14 },
                theme: 'grid',
                headStyles: { fillColor: [30, 58, 138] }
            });
            y = pdf.lastAutoTable.finalY + 15;

            // Results
            pdf.text('2. Calculated Performance', 14, y);
            y += 5;

            const resData = [
                ['Total Dynamic Drop', `${lastResult.dP_total.toFixed(2)} psi`],
                ['Valve Authority (N)', lastResult.N.toFixed(3)],
                ['Status', lastResult.N < 0.25 ? 'POOR' : 'ACCEPTABLE']
            ];

            pdf.autoTable({
                startY: y,
                head: [['Metric', 'Result']],
                body: resData,
                margin: { left: 14, right: 14 },
                theme: 'grid',
                headStyles: { fillColor: [30, 58, 138] },
                didParseCell: function(data) {
                    if(data.row.index === 1) {
                        data.cell.styles.fontStyle = 'bold';
                    }
                }
            });

            // Footer
            y = pdf.lastAutoTable.finalY + 20;
            pdf.setFontSize(8);
            pdf.setTextColor(150);
            pdf.text('Based on standard IEC 60534 control valve equations.', 105, y, { align: 'center' });

            pdf.save('Valve_Authority_Report.pdf');
            displayMessage("PDF Downloaded", "success");
        }

        function displayMessage(message, type = "info") {
            let messageBox = document.getElementById('message-box');
            messageBox.textContent = message;
            if (type === "error") messageBox.style.backgroundColor = 'var(--danger)';
            else if (type === "success") messageBox.style.backgroundColor = 'var(--success)';
            else messageBox.style.backgroundColor = 'var(--primary)';
            messageBox.classList.add('show');
            setTimeout(() => messageBox.classList.remove('show'), 4000);
        }
    </script>
</body>
</html>
