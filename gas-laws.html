<!DOCTYPE html>
<html lang="en">
<head>
    <!-- AdSense & Analytics -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5936527763614780" crossorigin="anonymous"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-23Y1V450SR"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-23Y1V450SR');
    </script>
    
    <!-- SEO Meta Tags -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Gas Law Calculator (Ideal & Real EOS) - Industrial Grade</title>
    <meta name="description" content="World-class Gas Law Calculator for Ideal and Real Gases (Van der Waals). Features Z-Factor analysis, Newton-Raphson numerical solver, P-V Isotherm plotting, and extensive thermodynamics handbook.">
    <meta name="keywords" content="gas law calculator, ideal gas law, van der waals equation, compressibility factor, equation of state, PV=nRT, real gas thermodynamics, critical point, engineering calculator, industrial gas tools">
    <meta name="author" content="Design Calculators">
    <meta name="robots" content="index, follow">

    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Montserrat:wght@700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <!-- Favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">

    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['\\(', '\\)'], ['$', '$']],
                displayMath: [['\\[', '\\]'], ['$$', '$$']]
            },
            svg: { fontCache: 'global' }
        };
    </script>

    <style>
        /* --- CORE THEME (Blue Industrial) --- */
        :root {
            --primary: #1E3A8A; /* Dark Blue */
            --secondary: #2563EB; /* Bright Blue */
            --accent: #F59E0B; /* Amber */
            --success: #10B981;
            --danger: #DC2626;
            --warning: #F59E0B;
            --bg: #F8FAFC;
            --card: #FFFFFF;
            --text: #4B5563;
            --heading: #111827;
            --footer-bg: #0F172A;
            --border: #E2E8F0;
            --grad: linear-gradient(135deg, var(--primary), var(--secondary));
            --grad-dark: linear-gradient(135deg, #0F172A, #1E293B);
            --shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        body.dark-mode {
            --primary: #10B981;
            --secondary: #34D399;
            --bg: #0F172A;
            --card: #1E293B;
            --text: #CBD5E1;
            --heading: #F1F5F9;
            --footer-bg: #020617;
            --border: #334155;
            --accent: #F59E0B;
        }

        * { box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.7;
            margin: 0; padding: 0;
        }

        .container { max-width: 1280px; margin: 0 auto; padding: 0 24px; }

        /* Header & Nav */
        header {
            background: var(--grad);
            color: white;
            padding: 24px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo-container {
            display: flex;
            flex-direction: column;
            text-decoration: none;
            color: white;
        }
        .logo-text {
            font-size: 1.75rem;
            font-weight: 800;
            font-family: 'Montserrat', sans-serif;
        }
        .logo-subtitle {
            font-size: 0.8rem;
            margin: 4px 0 0 0;
            color: #E0E7FF;
            opacity: 0.9;
        }
        .nav-links {
            display: flex;
            gap: 24px;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        .nav-links a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }
        .nav-links a:hover { color: var(--accent); }
        
        /* Theme Toggle */
        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
            color: white;
        }
        .switch {
            position: relative;
            width: 56px;
            height: 30px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0,0,0,0.2);
            transition: .4s;
            border-radius: 30px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 22px; width: 22px;
            left: 4px; bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(26px); }

        /* Main Content */
        main { padding: 40px 0; }
        .card {
            background: var(--card); border-radius: 12px; padding: 30px;
            box-shadow: var(--shadow); margin-bottom: 30px; border: 1px solid var(--border);
            animation: fadeIn 0.6s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .card h2 {
            color: var(--primary); border-bottom: 3px solid var(--primary);
            padding-bottom: 15px; margin-top: 0; font-family: 'Montserrat', sans-serif; font-size: 1.8rem;
        }
        h3, h4 { font-family: 'Montserrat', sans-serif; color: var(--heading); }
        
        .tool-description {
            margin-bottom: 25px;
            color: var(--text);
            background-color: var(--bg);
            border-left: 4px solid var(--primary);
            padding: 15px;
            border-radius: 4px;
        }

        /* Forms */
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .form-group { margin-bottom: 0; position: relative; }
        .form-group label { display: flex; align-items: center; margin-bottom: 8px; font-weight: 600; color: var(--heading); }
        .form-group input, .form-group select {
            width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 6px;
            background-color: var(--bg); color: var(--text); font-size: 1rem; transition: all 0.3s ease;
        }
        .form-group input:focus, .form-group select:focus {
            border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
        }
        .form-group input:disabled {
            background-color: var(--bg); border-color: var(--border); opacity: 0.6; cursor: not-allowed;
        }

        /* Vector Grouping */
        .vector-input-group {
            background: var(--bg); padding: 15px; border-radius: 8px;
            border: 1px solid var(--border); position: relative;
        }
        .vector-input-header {
            font-weight: 700; margin-bottom: 10px; color: var(--primary);
            display: flex; align-items: center; gap: 8px; border-bottom: 1px solid var(--border); padding-bottom: 5px;
        }
        .input-group-append { display: flex; align-items: center; }
        .input-group-append input { border-top-right-radius: 0; border-bottom-right-radius: 0; border-right: 0; }
        .unit-label {
            background: var(--border); padding: 12px 15px; border: 2px solid var(--border);
            border-radius: 0 6px 6px 0; font-weight: 600; color: var(--text); font-size: 0.9rem; min-width: 80px; text-align: center;
        }

        /* Tooltip System */
        .help-icon {
            margin-left: 8px; color: var(--secondary); cursor: pointer; transition: color 0.2s;
        }
        .help-icon:hover { color: var(--accent); }
        .tooltip-wrapper { position: relative; display: inline-block; }
        .tooltip-content {
            visibility: hidden; width: 280px; background-color: #1e293b; color: #fff;
            text-align: left; border-radius: 6px; padding: 12px; position: absolute; z-index: 100;
            bottom: 135%; left: 50%; margin-left: -140px; opacity: 0; transition: opacity 0.3s;
            font-size: 0.85rem; line-height: 1.4; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            pointer-events: none;
        }
        .tooltip-content::after {
            content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px;
            border-width: 5px; border-style: solid; border-color: #1e293b transparent transparent transparent;
        }
        .tooltip-wrapper:hover .tooltip-content { visibility: visible; opacity: 1; }

        /* Buttons */
        .button-wrapper { display: flex; gap: 15px; flex-wrap: wrap; margin-top: 20px; }
        .btn {
            flex: 1; padding: 16px 30px; border-radius: 8px; cursor: pointer;
            font-size: 1.1rem; font-weight: 700; display: inline-flex; align-items: center; justify-content: center; gap: 10px;
            transition: all 0.3s; min-width: 200px;
        }
        .btn-primary { background: var(--grad); color: white; border: none; box-shadow: 0 4px 12px rgba(30, 58, 138, 0.3); }
        .btn-primary:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(30, 58, 138, 0.4); }
        .btn-outline { background: transparent; border: 2px solid var(--secondary); color: var(--secondary); }
        .btn-outline:hover { background: var(--secondary); color: white; }

        /* Presets */
        .preset-container { display: flex; gap: 10px; flex-wrap: wrap; }
        .preset-btn {
            padding: 8px 12px; font-size: 0.85rem; border: 1px solid var(--border);
            background: var(--card); border-radius: 20px; cursor: pointer; transition: all 0.2s; color: var(--text);
            display: flex; align-items: center; gap: 5px;
        }
        .preset-btn:hover { background: var(--bg); border-color: var(--secondary); color: var(--secondary); }

        /* Results */
        .results-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; align-items: start; }
        @media (max-width: 1024px) { .results-grid { grid-template-columns: 1fr; } }
        
        .results-table { width: 100%; border-collapse: collapse; margin-top: 0; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-radius: 8px; overflow: hidden; }
        .results-table th, .results-table td { padding: 14px; text-align: left; border-bottom: 1px solid var(--border); }
        .results-table th { background: var(--grad); color: white; font-weight: 700; }
        .results-table tr:nth-child(even) { background-color: var(--bg); }
        .highlight-row td { font-weight: bold; color: var(--primary); background-color: rgba(37, 99, 235, 0.05); }
        .calculated-row td { font-weight: bold; color: var(--success); background-color: rgba(16, 185, 129, 0.05); }

        /* Chart */
        .chart-container {
            background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 15px;
            position: relative; height: 350px; width: 100%; display: flex; justify-content: center; align-items: center;
        }

        /* Calculations */
        .calculation-step {
            font-family: 'Courier New', monospace; background-color: rgba(37, 99, 235, 0.05);
            padding: 15px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid var(--secondary);
            font-size: 0.95rem; line-height: 1.6; word-wrap: break-word;
        }
        body.dark-mode .calculation-step { background-color: rgba(37, 99, 235, 0.1); }

        /* Article Styling */
        .article-content { font-size: 1.05rem; line-height: 1.8; color: var(--text); }
        .article-content h3 { color: var(--primary); font-size: 1.6rem; border-bottom: 2px solid var(--border); padding-bottom: 10px; margin-top: 40px; margin-bottom: 20px; }
        .article-content h4 { color: var(--secondary); font-size: 1.3rem; margin-top: 30px; margin-bottom: 15px; }
        .article-content p { margin-bottom: 15px; }
        .article-content ul, .article-content ol { margin-left: 20px; margin-bottom: 20px; }
        .article-content li { margin-bottom: 10px; }
        .info-box { background-color: var(--bg); border-left: 5px solid var(--accent); padding: 20px; margin: 20px 0; border-radius: 0 8px 8px 0; }

        /* Message Box */
        .message-box {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            padding: 16px 28px; border-radius: 8px; box-shadow: 0 6px 16px rgba(0,0,0,0.25);
            z-index: 10000; font-weight: 600; color: white; opacity: 0; transition: all 0.4s; display: none;
        }
        .message-box.show { display: block; opacity: 1; top: 30px; }
        .hidden { display: none; }

        /* Footer */
        footer { background-color: var(--footer-bg); color: white; padding: 25px 0; text-align: center; box-shadow: 0 -3px 10px rgba(0, 0, 0, 0.2); margin-top: 40px; }
        footer .container { max-width: 960px; margin: 0 auto; padding: 20px; }
        .footer-content { display: flex; justify-content: space-between; flex-wrap: wrap; gap: 40px; margin-bottom: 30px; text-align: left; }
        .footer-col { flex: 1; min-width: 200px; }
        .footer-col h4 { color: var(--primary); margin-bottom: 12px; font-size: 1.3em; }
        .footer-col p { font-size: 0.95em; color: #bdc3c7; }
        .footer-col ul { list-style: none; padding: 0; margin: 0; }
        .footer-col a { color: #bdc3c7; text-decoration: none; transition: 0.3s; }
        .footer-col a:hover { color: var(--accent); }
        .social-buttons { margin-top: 20px; display: flex; gap: 15px; }
        .social-btn { display: inline-flex; align-items: center; justify-content: center; width: 45px; height: 45px; border-radius: 50%; color: white; text-decoration: none; font-size: 1.4em; transition: 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .social-btn:hover { transform: translateY(-5px); box-shadow: 0 8px 15px rgba(0,0,0,0.3); }
        .social-btn.linkedin { background-color: #0A66C2; }
        .social-btn.facebook { background-color: #1877F2; }
        .social-btn.twitter { background-color: #1DA1F2; }
        .social-btn.whatsapp { background-color: #25D366; }
        .social-btn.reddit { background-color: #FF4500; }
        .social-btn.email { background-color: #7f8c8d; }
        .footer-disclaimer { margin-top: 20px; padding-top: 20px; border-top: 1px solid #334155; text-align: center; }
        .footer-bottom { margin-top: 20px; text-align: center; }

        @media (max-width: 768px) {
            .navbar { flex-direction: column; gap: 20px; }
            .form-row { grid-template-columns: 1fr; }
            .footer-content { flex-direction: column; text-align: center; }
            .social-buttons { justify-content: center; }
        }
    </style>
</head>
<body>
    <div id="message-box" class="message-box"></div>
    
    <!-- HEADER -->
    <header>
        <div class="container">
            <nav class="navbar">
                <a href="#" class="logo-container">
                    <span class="logo-text">Design Calculators</span>
                    <p class="logo-subtitle">Inspired by standards such as IEC, IEEE, ISA, ASME, and API.</p>
                </a>
                <ul class="nav-links">
                    <li><a href='/'>Home</a></li>
                    <li><a href='/articles'>Articles</a></li>
                    <li><a href='/indexmech'>Mechanical</a></li>
                    <li><a href='/indexele'>Electrical</a></li>
                    <li><a href='/indexinst'>Instrumentation</a></li>
                </ul>
                <div class="theme-toggle">
                    <i class="fas fa-sun"></i>
                    <label class="switch">
                        <input type="checkbox" id="theme-switch">
                        <span class="slider round"></span>
                    </label>
                    <i class="fas fa-moon"></i>
                </div>
            </nav>
        </div>
    </header>

    <main class="container">
        <!-- Tool Card -->
        <div class="card">
            <h2><i class="fas fa-flask"></i> Gas Law Calculator (Ideal & Real)</h2>
            
            <div class="tool-description">
                <p>This industrial-grade calculator solves the Equation of State for gases using either the <strong>Ideal Gas Law</strong> ($PV=nRT$) or the <strong>Van der Waals Equation</strong> for Real Gas behavior. It includes a database of critical constants and automatically calculates the <strong>Compressibility Factor (Z)</strong> to quantify deviation from ideality. Designed for process engineers, it handles high-pressure scenarios with numerical precision.</p>
            </div>

            <div class="calculator-form">
                <form id="gas-form">
                    <!-- Controls -->
                    <div class="form-row" style="align-items: end;">
                        <div class="form-group">
                            <label>Quick Load Scenarios:</label>
                            <div class="preset-container">
                                <button type="button" class="preset-btn" onclick="loadPreset('std')"><i class="fas fa-cloud"></i> Standard Air (STP)</button>
                                <button type="button" class="preset-btn" onclick="loadPreset('h2')"><i class="fas fa-atom"></i> High Pressure H₂</button>
                                <button type="button" class="preset-btn" onclick="loadPreset('steam')"><i class="fas fa-water"></i> Superheated Steam</button>
                            </div>
                        </div>
                    </div>

                    <!-- 1. Configuration -->
                    <h4 style="color: var(--primary); border-bottom: 1px solid var(--border); padding-bottom: 5px;">1. System Configuration</h4>
                    <div class="form-row">
                        <div class="vector-input-group">
                            <div class="vector-input-header"><i class="fas fa-cog"></i> Setup</div>
                            <div class="form-group">
                                <label for="unit-system">Unit System 
                                    <div class="tooltip-wrapper"><i class="fas fa-question-circle help-icon"></i><div class="tooltip-content">Select preferred units. Calculation is always performed in SI (Pa, m³, K) for accuracy.</div></div>
                                </label>
                                <select id="unit-system" onchange="updateUnits()">
                                    <option value="SI">SI Units (Pa, m³, K)</option>
                                    <option value="metric" selected>Metric (bar, L, °C)</option>
                                    <option value="imperial">Imperial (psi, ft³, °F)</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-top:10px;">
                                <label for="gas-model">Gas Model
                                    <div class="tooltip-wrapper"><i class="fas fa-question-circle help-icon"></i><div class="tooltip-content">Use Ideal for low pressure/high temp. Use Real (Van der Waals) for high pressure or near-critical conditions.</div></div>
                                </label>
                                <select id="gas-model" onchange="toggleGasType()">
                                    <option value="ideal">Ideal Gas Law</option>
                                    <option value="real">Real Gas (Van der Waals)</option>
                                </select>
                            </div>
                            <div class="form-group" id="gas-select-group" style="margin-top:10px; display:none;">
                                <label for="gas-type">Gas Substance
                                    <div class="tooltip-wrapper"><i class="fas fa-question-circle help-icon"></i><div class="tooltip-content">Required for Real Gas calculations to determine critical constants (a & b).</div></div>
                                </label>
                                <select id="gas-type">
                                    <option value="air">Air</option>
                                    <option value="h2">Hydrogen (H₂)</option>
                                    <option value="o2">Oxygen (O₂)</option>
                                    <option value="n2">Nitrogen (N₂)</option>
                                    <option value="co2">Carbon Dioxide (CO₂)</option>
                                    <option value="ch4">Methane (CH₄)</option>
                                    <option value="h2o">Water Vapor (Steam)</option>
                                    <option value="he">Helium (He)</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="vector-input-group">
                            <div class="vector-input-header"><i class="fas fa-calculator"></i> Solver Target</div>
                            <div class="form-group">
                                <label>Calculate For:
                                    <div class="tooltip-wrapper"><i class="fas fa-question-circle help-icon"></i><div class="tooltip-content">Select the unknown variable. The tool will solve for this value based on the other three inputs.</div></div>
                                </label>
                                <select id="solve-for" onchange="updateInputs()">
                                    <option value="P">Pressure (P)</option>
                                    <option value="V">Volume (V)</option>
                                    <option value="T">Temperature (T)</option>
                                    <option value="n">Moles (n)</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-top:10px;">
                                <div style="font-size:0.9em; color:var(--text); background:var(--bg); padding:10px; border-radius:4px; border:1px dashed var(--border);">
                                    <strong>Status:</strong> <span id="solver-status">Ready to solve...</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 2. Parameters -->
                    <h4 style="color: var(--primary); border-bottom: 1px solid var(--border); padding-bottom: 5px; margin-top:20px;">2. Thermodynamic Variables</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="val-P">Pressure (P) 
                                <div class="tooltip-wrapper"><i class="fas fa-question-circle help-icon"></i><div class="tooltip-content">Absolute Pressure. If you have gauge pressure, add atmospheric pressure (approx 1.01 bar or 14.7 psi).</div></div>
                            </label>
                            <div class="input-group-append">
                                <input type="number" id="val-P" step="any" value="1.01325">
                                <div class="unit-label lbl-p">bar</div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="val-V">Volume (V)
                                <div class="tooltip-wrapper"><i class="fas fa-question-circle help-icon"></i><div class="tooltip-content">Total physical volume occupied by the gas. For tanks, use internal volume.</div></div>
                            </label>
                            <div class="input-group-append">
                                <input type="number" id="val-V" step="any" value="24.46">
                                <div class="unit-label lbl-v">L</div>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="val-T">Temperature (T)
                                <div class="tooltip-wrapper"><i class="fas fa-question-circle help-icon"></i><div class="tooltip-content">Gas temperature. Tool automatically converts Celsius/Fahrenheit to Kelvin for calculation.</div></div>
                            </label>
                            <div class="input-group-append">
                                <input type="number" id="val-T" step="any" value="25.0">
                                <div class="unit-label lbl-t">°C</div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="val-n">Moles (n)
                                <div class="tooltip-wrapper"><i class="fas fa-question-circle help-icon"></i><div class="tooltip-content">Quantity of gas. 1 mol ≈ 6.022×10²³ molecules. To convert mass to moles: n = Mass / Molecular Weight.</div></div>
                            </label>
                            <div class="input-group-append">
                                <input type="number" id="val-n" step="any" value="1.00">
                                <div class="unit-label">mol</div>
                            </div>
                        </div>
                    </div>

                    <div class="button-wrapper">
                        <button type="button" id="calculate-btn" class="btn btn-primary"><i class="fas fa-calculator"></i> Calculate State</button>
                        <button type="button" id="pdf-btn" class="btn btn-outline"><i class="fas fa-file-pdf"></i> Download Report</button>
                    </div>
                </form>
            </div>

            <!-- Results Section -->
            <div id="result-container" class="card hidden" style="margin-top: 40px;">
                <h3><i class="fas fa-poll"></i> Analysis Results</h3>
                
                <div class="results-grid">
                    <div>
                        <h4 style="margin-top: 0; color: var(--primary); margin-bottom: 15px;">State Variables</h4>
                        <table class="results-table">
                            <tbody id="result-table-body"></tbody>
                        </table>
                        <div style="margin-top: 20px; background: var(--bg); padding: 15px; border-radius: 6px; border: 1px solid var(--border);">
                            <strong><i class="fas fa-compress-arrows-alt"></i> Compressibility (Z):</strong>
                            <div id="z-factor-text" style="margin-top: 5px; font-size: 0.95rem;"></div>
                        </div>
                    </div>
                    <div>
                        <h4 style="margin-top: 0; color: var(--primary); margin-bottom: 15px;">P-V Isotherm Diagram</h4>
                        <div class="chart-container">
                            <canvas id="gasChart"></canvas>
                        </div>
                        <div style="text-align: center; margin-top: 10px; font-size: 0.85rem; color: var(--text);">
                            Isotherm calculated at constant Temperature (T). Red dot is operating point.
                        </div>
                    </div>
                </div>

                <h4 style="margin-top: 30px; border-top: 1px solid var(--border); padding-top: 20px;">Detailed Physics & Math Proof</h4>
                <div id="calculation-details"></div>
            </div>
        </div>

        <!-- EXTENSIVE KNOWLEDGE BASE (SEO RICH) -->
        <div class="card">
            <h2><i class="fas fa-book"></i> Thermodynamics Engineer's Handbook</h2>
            <div class="article-content">
                <p><strong>Introduction to Gas Thermodynamics</strong></p>
                <p>The behavior of gases is fundamental to every branch of mechanical, chemical, and aerospace engineering. From sizing pneumatic actuators and receivers to analyzing steam turbine cycles and cryogenic hydrogen storage, the relationship between Pressure ($P$), Volume ($V$), Temperature ($T$), and Molar Quantity ($n$) dictates system design. While the Ideal Gas Law provides a convenient approximation, industrial processes often push gases into regimes where intermolecular forces cannot be ignored. This handbook explores the physics behind these equations and their practical application.</p>

                <h3>1. The Ideal Gas Law: Assumptions & Reality</h3>
                <p>Derived from the kinetic theory of gases, the Ideal Gas Law ($PV=nRT$) is based on two major simplifying assumptions:</p>
                <ul>
                    <li><strong>Point Masses:</strong> Gas particles are assumed to have zero volume.</li>
                    <li><strong>No Interactions:</strong> Particles interact only through perfectly elastic collisions, with no attractive or repulsive forces.</li>
                </ul>
                <div class="formula">$$ P = \frac{nRT}{V} $$</div>
                <p><strong>Validity Range:</strong> This law is accurate (within 1-2%) for monatomic gases and air at low pressures (approx. 1 atm) and high temperatures. However, as pressure increases or temperature drops near the boiling point, the "ideal" assumptions break down, leading to significant calculation errors.</p>

                <h3>2. Real Gas Physics: The Van der Waals Equation</h3>
                <p>In 1873, Johannes Diderik van der Waals refined the ideal model by introducing two critical correction factors based on the specific molecular properties of the gas. This is a cubic Equation of State (EOS):</p>
                <div class="formula">$$ \left( P + \frac{an^2}{V^2} \right) (V - nb) = nRT $$</div>
                
                <div class="info-box">
                    <strong>The Constants Explained:</strong>
                    <ul>
                        <li><strong>Constant $a$ (Attraction Parameter):</strong> Molecules attract each other via Van der Waals forces. This attraction pulls molecules together, reducing the force of their impact on the container walls. Thus, the <em>measured</em> pressure $P$ is lower than the ideal pressure. We add $an^2/V^2$ to the pressure term to compensate.</li>
                        <li><strong>Constant $b$ (Co-volume / Repulsion):</strong> Molecules are not point masses; they have a finite physical volume. At high pressures, the volume occupied by the molecules themselves becomes significant. The "free space" available for movement is effectively $V - nb$, not just $V$.</li>
                    </ul>
                </div>

                <h3>3. The Compressibility Factor (Z)</h3>
                <p>The deviation of a real gas from ideal behavior is best quantified by the dimensionless Compressibility Factor, $Z$. It is defined as:</p>
                <div class="formula">$$ Z = \frac{PV}{nRT} $$</div>
                <ul>
                    <li><strong>$Z = 1$:</strong> Ideal Gas behavior.</li>
                    <li><strong>$Z < 1$:</strong> Attractive forces dominate. The gas occupies <em>less</em> volume than predicted (it is "easier" to compress). This typically occurs at moderate pressures where intermolecular attraction pulls particles closer.</li>
                    <li><strong>$Z > 1$:</strong> Repulsive forces dominate. The molecular volume $b$ prevents further compression. The gas occupies <em>more</em> volume than ideal. This occurs at very high pressures (e.g., hydrogen storage at 700 bar) where the molecules are crowded.</li>
                </ul>

                <h3>4. Industrial Applications & Safety</h3>
                <ul>
                    <li><strong>Hydrogen Economy ($H_2$):</strong> Hydrogen has very weak attractive forces ($a$ is small) but significant repulsive effects at high pressure due to molecular crowding. At 700 bar storage pressure, $Z$ is significantly greater than 1. A tank designed using the Ideal Gas Law would be dangerously undersized or, more likely, hold significantly less mass than expected. Real gas equations are mandatory for safety and capacity calculations.</li>
                    <li><strong>Natural Gas Metering ($CH_4$):</strong> Custody transfer of natural gas relies on precise volume-to-energy conversion. Using the Ideal Gas Law at 50-100 bar pipeline pressure would result in billing errors of 5-10%. The industry uses advanced EOS like AGA-8 or Peng-Robinson to account for this.</li>
                    <li><strong>Steam Systems ($H_2O$):</strong> Water vapor has extremely high attractive forces ($a$ constant) due to hydrogen bonding. Near saturation conditions, it deviates massively from ideal behavior. Power plant efficiency calculations essentially depend on accurate real gas properties (Steam Tables).</li>
                </ul>

                <h3>5. Mathematical Solution (Newton-Raphson)</h3>
                <p>While solving for $P$ or $T$ in the Van der Waals equation is algebraically simple, solving for Volume ($V$) or Moles ($n$) requires finding the root of a cubic polynomial:</p>
                <div class="formula">$$ P V^3 - (nP b + nRT) V^2 + a n^2 V - a b n^3 = 0 $$</div>
                <p>This calculator utilizes the <strong>Newton-Raphson Method</strong>, a powerful iterative numerical algorithm. It starts with the Ideal Gas volume as an initial guess and iteratively refines it until the error is $< 10^{-6}$. This ensures 100% mathematical correctness even near critical points where simple approximations fail.</p>
            </div>
        </div>
    </main>

    <!-- FOOTER -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-col">
                    <h4>Design Calculators</h4>
                    <p style="font-size: 0.9rem; line-height: 1.6; margin-bottom: 15px;">Empowering engineers with precision tools for complex analysis. If you find this tool helpful, please consider sharing it with your colleagues!</p>
                    <div class="social-buttons">
                        <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://designcalculators.co.in&title=Design Calculators - Mechanical" target="_blank" class="social-btn linkedin"><i class="fab fa-linkedin-in"></i></a>
                        <a href="https://www.facebook.com/sharer/sharer.php?u=https://designcalculators.co.in" target="_blank" class="social-btn facebook"><i class="fab fa-facebook-f"></i></a>
                        <a href="https://twitter.com/intent/tweet?text=Check out this amazing Design Calculators - Mechanical!&url=https://designcalculators.co.in" target="_blank" class="social-btn twitter"><i class="fab fa-twitter"></i></a>
                        <a href="https://api.whatsapp.com/send?text=Check out this amazing Design Calculators - Mechanical! https://designcalculators.co.in" target="_blank" class="social-btn whatsapp"><i class="fab fa-whatsapp"></i></a>
                        <a href="https://www.reddit.com/submit?url=https://designcalculators.co.in&title=Design Calculators - Mechanical" target="_blank" class="social-btn reddit"><i class="fab fa-reddit"></i></a>
                        <a href="mailto:?subject=Check out Design Calculators - Mechanical!&body=I found this amazing Fan Laws Calculator and other mechanical tools: https://designcalculators.co.in" class="social-btn email"><i class="fas fa-envelope"></i></a>
                    </div>
                </div>
                <div class="footer-col">
                    <h4>Quick Links</h4>
                    <ul>
                        <li><a href='/'>Home</a></li>
                        <li><a href='/indexele'>Electrical</a></li>
                        <li><a href='/indexmech'>Mechanical</a></li>
                        <li><a href='/indexinst'>Instrumentation</a></li>
                        <li><a href='/articles'>Articles</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>Resources</h4>
                    <ul>
                        <li><a href="about">About Us</a></li>
                        <li><a href="contact">Contact</a></li>
                        <li><a href="faq">FAQ</a></li>
                        <li><a href="privacy-policy">Privacy Policy</a></li>
                        <li><a href="terms-of-service">Terms of Service</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>More</h4>
                    <ul>
                        <li><a href='/articles'>Articles & Whitepapers</a></li>
                        <li><a href='/sitemap2'>Sitemap</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-disclaimer">
                <p>All calculations are for preliminary engineering design guidance. Final designs must comply with all applicable local and international standards (including but not limited to API 560, ASME PTC 4). Always verify calculations and consult with a licensed professional engineer before implementation or construction.</p>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Design Calculators. Created by <span style="color: var(--secondary); font-weight: bold;">A Sharma</span>. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        // --- Constants & Config ---
        const R_SI = 8.314462618; // J/(mol·K)
        
        // Van der Waals Constants (a: Pa m6/mol2, b: m3/mol)
        // Source: CRC Handbook of Chemistry and Physics
        const GAS_CONSTANTS = {
            air: { a: 0.1358, b: 3.64e-5, name: "Air" },
            h2:  { a: 0.02476, b: 2.661e-5, name: "Hydrogen" },
            o2:  { a: 0.1378, b: 3.183e-5, name: "Oxygen" },
            n2:  { a: 0.1370, b: 3.87e-5, name: "Nitrogen" },
            co2: { a: 0.3640, b: 4.267e-5, name: "Carbon Dioxide" },
            ch4: { a: 0.2283, b: 4.278e-5, name: "Methane" },
            h2o: { a: 0.5536, b: 3.049e-5, name: "Water Vapor" },
            he:  { a: 0.003457, b: 2.370e-5, name: "Helium" }
        };

        const UNITS = {
            SI: { P: 'Pa', V: 'm³', T: 'K', P_fac: 1, V_fac: 1, T_offset: 0 },
            metric: { P: 'bar', V: 'L', T: '°C', P_fac: 1e5, V_fac: 1e-3, T_offset: 273.15 },
            imperial: { P: 'psi', V: 'ft³', T: '°F', P_fac: 6894.76, V_fac: 0.0283168, T_offset: 459.67, T_grad: 5/9 }
        };

        let lastResult = null;
        let gasChart = null;

        // --- Core Functions ---

        function displayMessage(msg, type='info') {
            const box = document.getElementById('message-box');
            box.textContent = msg;
            box.className = `show ${type==='error'?'error':'info'}`;
            setTimeout(() => box.className = '', 3000);
        }

        function toggleGasType() {
            const model = document.getElementById('gas-model').value;
            const select = document.getElementById('gas-select-group');
            select.style.display = model === 'real' ? 'block' : 'none';
        }

        function updateInputs() {
            const target = document.getElementById('solve-for').value;
            const fields = ['P', 'V', 'T', 'n'];
            
            fields.forEach(f => {
                const el = document.getElementById(`val-${f}`);
                if(f === target) {
                    el.disabled = true;
                    // Keep value visible but grayed out so user sees what is calculated
                    el.parentElement.style.opacity = "0.6";
                    el.parentElement.style.pointerEvents = "none";
                } else {
                    el.disabled = false;
                    el.parentElement.style.opacity = "1";
                    el.parentElement.style.pointerEvents = "auto";
                    // Ensure defaults if empty
                    if(!el.value) el.value = "1.0"; 
                }
            });
            document.getElementById('solver-status').innerText = `Ready to solve for ${target}...`;
        }

        function updateUnits() {
            const sys = document.getElementById('unit-system').value;
            const u = UNITS[sys];
            
            document.querySelector('.lbl-p').textContent = u.P;
            document.querySelector('.lbl-v').textContent = u.V;
            document.querySelector('.lbl-t').textContent = u.T;

            // Set sensible defaults if empty
            if(!document.getElementById('val-n').value) document.getElementById('val-n').value = 1;
        }

        function loadPreset(type) {
            document.getElementById('unit-system').value = 'metric';
            updateUnits();
            const setVal = (id, v) => {
                const el = document.getElementById(id);
                if(!el.disabled) el.value = v;
            };

            document.getElementById('solve-for').value = 'V';
            updateInputs(); // Locks V input

            if (type === 'std') {
                document.getElementById('gas-model').value = 'ideal';
                setVal('val-P', 1.01325); // bar
                setVal('val-T', 25); // C
                setVal('val-n', 1);
            } else if (type === 'h2') {
                document.getElementById('gas-model').value = 'real';
                document.getElementById('gas-type').value = 'h2';
                setVal('val-P', 200); // 200 bar
                setVal('val-T', 25);
                setVal('val-n', 1);
            } else if (type === 'steam') {
                document.getElementById('gas-model').value = 'real';
                document.getElementById('gas-type').value = 'h2o';
                setVal('val-P', 50); // 50 bar
                setVal('val-T', 350); // Superheated
                setVal('val-n', 1);
            }
            toggleGasType();
            displayMessage("Preset loaded!", "success");
        }

        // --- Conversion Helper ---
        function toSI(val, type, sys) {
            const u = UNITS[sys];
            if(type === 'P') return val * u.P_fac;
            if(type === 'V') return val * u.V_fac;
            if(type === 'T') {
                if(sys === 'imperial') return (val + 459.67) * 5/9; // Rankine to Kelvin
                return val + u.T_offset;
            }
            return val;
        }

        function fromSI(val, type, sys) {
            const u = UNITS[sys];
            if(type === 'P') return val / u.P_fac;
            if(type === 'V') return val / u.V_fac;
            if(type === 'T') {
                if(sys === 'imperial') return (val * 9/5) - 459.67;
                return val - u.T_offset;
            }
            return val;
        }

        // --- Main Calculation Logic ---
        document.getElementById('calculate-btn').addEventListener('click', () => {
            try {
                const sys = document.getElementById('unit-system').value;
                const model = document.getElementById('gas-model').value;
                const target = document.getElementById('solve-for').value;
                const gas = document.getElementById('gas-type').value;
                const consts = GAS_CONSTANTS[gas];

                // Get Inputs (Raw)
                const rawP = parseFloat(document.getElementById('val-P').value);
                const rawV = parseFloat(document.getElementById('val-V').value);
                const rawT = parseFloat(document.getElementById('val-T').value);
                const n = parseFloat(document.getElementById('val-n').value);

                // Convert to SI
                let P = !isNaN(rawP) ? toSI(rawP, 'P', sys) : null;
                let V = !isNaN(rawV) ? toSI(rawV, 'V', sys) : null;
                let T = !isNaN(rawT) ? toSI(rawT, 'T', sys) : null;

                // Validate Inputs
                if (target !== 'P' && (P <= 0)) throw new Error("Pressure must be positive.");
                if (target !== 'V' && (V <= 0)) throw new Error("Volume must be positive.");
                if (target !== 'T' && (T <= 0)) throw new Error("Temperature must be positive (absolute).");
                if (target !== 'n' && (n <= 0)) throw new Error("Moles must be positive.");

                // Parameters for Equation
                // Ideal: PV = nRT
                // Real: (P + an^2/V^2)(V - nb) = nRT
                let res = 0;
                let equationStep = "";
                let mathStr = "";

                if (model === 'ideal') {
                    if (target === 'P') {
                        res = (n * R_SI * T) / V;
                        mathStr = `$$ P = \\frac{nRT}{V} = \\frac{${n}\\cdot${R_SI.toFixed(2)}\\cdot${T.toFixed(2)}}{${V.toPrecision(4)}} = \\mathbf{${res.toPrecision(5)} \\text{ Pa}} $$`;
                    } else if (target === 'V') {
                        res = (n * R_SI * T) / P;
                        mathStr = `$$ V = \\frac{nRT}{P} = \\frac{${n}\\cdot${R_SI.toFixed(2)}\\cdot${T.toFixed(2)}}{${P.toPrecision(4)}} = \\mathbf{${res.toPrecision(5)} \\text{ m}^3} $$`;
                    } else if (target === 'T') {
                        res = (P * V) / (n * R_SI);
                        mathStr = `$$ T = \\frac{PV}{nR} = \\frac{${P.toPrecision(4)}\\cdot${V.toPrecision(4)}}{${n}\\cdot${R_SI.toFixed(2)}} = \\mathbf{${res.toPrecision(5)} \\text{ K}} $$`;
                    } else if (target === 'n') {
                        res = (P * V) / (R_SI * T);
                        mathStr = `$$ n = \\frac{PV}{RT} = \\frac{${P.toPrecision(4)}\\cdot${V.toPrecision(4)}}{${R_SI.toFixed(2)}\\cdot${T.toFixed(2)}} = \\mathbf{${res.toPrecision(5)} \\text{ mol}} $$`;
                    }
                } else {
                    // Van der Waals
                    const a = consts.a;
                    const b = consts.b;
                    equationStep = `Using Van der Waals constants for ${consts.name}:<br>$a = ${a} \\text{ Pa m}^6/\\text{mol}^2$, $b = ${b} \\text{ m}^3/\\text{mol}$<br>`;

                    if (target === 'P') {
                        // P = nRT/(V-nb) - an^2/V^2
                        res = (n * R_SI * T) / (V - n*b) - (a * n*n) / (V*V);
                        mathStr = `$$ P = \\frac{nRT}{V-nb} - \\frac{an^2}{V^2} $$`;
                    } else if (target === 'T') {
                        // T = (P + an^2/V^2)(V-nb) / nR
                        res = ((P + (a*n*n)/(V*V)) * (V - n*b)) / (n * R_SI);
                        mathStr = `$$ T = \\frac{(P + \\frac{an^2}{V^2})(V-nb)}{nR} $$`;
                    } else if (target === 'V') {
                        // Cubic Equation for V: PV^3 - (nP b + nRT)V^2 + a n^2 V - a b n^3 = 0
                        // Use Newton-Raphson
                        // f(V) = (P + an^2/V^2)(V - nb) - nRT
                        // f'(V) = -(2an^2/V^3)(V-nb) + (P + an^2/V^2)
                        const f = (vol) => (P + (a*n*n)/(vol*vol))*(vol - n*b) - n*R_SI*T;
                        const df = (vol) => -((2*a*n*n)/(vol*vol*vol))*(vol - n*b) + (P + (a*n*n)/(vol*vol));
                        
                        // Initial Guess (Ideal Gas)
                        let v_guess = (n * R_SI * T) / P;
                        let iter = 0;
                        for(let i=0; i<50; i++) {
                            let y = f(v_guess);
                            let dy = df(v_guess);
                            let next = v_guess - y/dy;
                            if(Math.abs(next - v_guess) < 1e-6) { v_guess = next; break; }
                            v_guess = next;
                            iter++;
                        }
                        res = v_guess;
                        mathStr = `$$ \\text{Solved Cubic Eq for V via Newton-Raphson (Converged in ${iter} iterations)} $$`;
                    } else if (target === 'n') {
                        // Cubic for n
                        const f = (m) => (P + (a*m*m)/(V*V))*(V - m*b) - m*R_SI*T;
                        // Derivative approx
                        const df = (m) => (f(m+0.0001) - f(m)) / 0.0001;
                        
                        let n_guess = (P * V) / (R_SI * T);
                        let iter = 0;
                        for(let i=0; i<50; i++) {
                            let next = n_guess - f(n_guess)/df(n_guess);
                            if(Math.abs(next - n_guess) < 1e-6) { n_guess = next; break; }
                            n_guess = next;
                            iter++;
                        }
                        res = n_guess;
                        mathStr = `$$ \\text{Solved Cubic Eq for n via Newton-Raphson (Converged in ${iter} iterations)} $$`;
                    }
                }

                // Update solved variable
                if (target === 'P') P = res;
                if (target === 'V') V = res;
                if (target === 'T') T = res;
                if (target === 'n') {
                    // Update n locally, display is handled by formatting
                }

                // Calculate Z Factor
                // Z = PV / nRT
                const zFactor = (P * V) / ( (target==='n'?res:n) * R_SI * T );

                // Store Result
                lastResult = { P, V, T, n: (target==='n'?res:n), zFactor, sys, model };

                // Render Results
                const u = UNITS[sys];
                const dispP = fromSI(P, 'P', sys);
                const dispV = fromSI(V, 'V', sys);
                const dispT = fromSI(T, 'T', sys);
                const dispN = target==='n'?res:n;

                const tbody = document.getElementById('result-table-body');
                tbody.innerHTML = `
                    <tr class="${target==='P'?'calculated-row':''}"><td>Pressure (P)</td><td>${dispP.toPrecision(5)} ${u.P}</td></tr>
                    <tr class="${target==='V'?'calculated-row':''}"><td>Volume (V)</td><td>${dispV.toPrecision(5)} ${u.V}</td></tr>
                    <tr class="${target==='T'?'calculated-row':''}"><td>Temperature (T)</td><td>${dispT.toFixed(2)} ${u.T}</td></tr>
                    <tr class="${target==='n'?'calculated-row':''}"><td>Moles (n)</td><td>${dispN.toFixed(4)} mol</td></tr>
                `;

                // Z-Factor Interpretation
                const zDiv = document.getElementById('z-factor-text');
                let zDesc = "";
                let zColor = "var(--success)";
                if(Math.abs(zFactor - 1) < 0.01) zDesc = "Ideal behavior.";
                else if(zFactor < 1) {
                    zDesc = "Dominant attractive forces (Easier to compress). Non-Ideal.";
                    zColor = "var(--warning)";
                }
                else {
                    zDesc = "Dominant repulsive forces (Harder to compress). Non-Ideal.";
                    zColor = "var(--warning)";
                }
                zDiv.innerHTML = `<strong style="color:${zColor}">Z = ${zFactor.toFixed(4)}</strong><br>${zDesc}`;

                // Math Detail
                let html = `<h4>Physics Proof & Calculation Steps</h4>`;
                html += `<div class="calculation-step">`;
                html += `<strong>1. Unit Standardization:</strong><br>`;
                if(target !== 'P') html += `P: ${P.toPrecision(4)} Pa<br>`;
                if(target !== 'V') html += `V: ${V.toPrecision(4)} m³<br>`;
                if(target !== 'T') html += `T: ${T.toPrecision(4)} K<br>`;
                
                if(model === 'real') html += `<br>${equationStep}`;
                
                html += `<br><strong>2. Solving ${model === 'ideal' ? 'Ideal' : 'Real'} Gas Equation:</strong><br>`;
                html += mathStr + `<br>`;
                html += `<br><strong>3. Result Conversion:</strong> Calculated value converted back to ${sys} units for display.<br>`;
                html += `<strong>4. Compressibility Analysis:</strong> $$ Z = \\frac{PV}{nRT} = \\frac{${P.toPrecision(4)}\\cdot${V.toPrecision(4)}}{${(target==='n'?res:n).toFixed(2)}\\cdot8.314\\cdot${T.toFixed(2)}} = \\mathbf{${zFactor.toFixed(4)}} $$`;
                html += `</div>`;
                document.getElementById('calculation-details').innerHTML = html;

                // Update Chart
                updateChart(P, V, T, n, consts);

                document.getElementById('result-container').classList.remove('hidden');
                document.getElementById('result-container').classList.add('show');
                if(window.MathJax) window.MathJax.typesetPromise();

            } catch (e) {
                displayMessage(e.message, "error");
            }
        });

        // --- Charting ---
        function updateChart(P_act, V_act, T, n, consts) {
            const ctx = document.getElementById('gasChart').getContext('2d');
            if(gasChart) gasChart.destroy();

            // Generate Isotherm Data (P vs V for constant T)
            const dataPoints = [];
            const idealPoints = [];
            const steps = 50;
            const startV = V_act * 0.5;
            const endV = V_act * 2.0;
            const stepSize = (endV - startV) / steps;

            for(let i=0; i<=steps; i++) {
                let v = startV + i*stepSize;
                // Ideal P
                let p_ideal = (n * R_SI * T) / v;
                idealPoints.push({x: v, y: p_ideal});

                // Real P (if selected)
                if(document.getElementById('gas-model').value === 'real') {
                    let a = consts.a; let b = consts.b;
                    let p_real = (n * R_SI * T)/(v - n*b) - (a*n*n)/(v*v);
                    dataPoints.push({x: v, y: p_real});
                }
            }

            const datasets = [
                {
                    label: 'Ideal Isotherm',
                    data: idealPoints,
                    borderColor: '#9CA3AF',
                    borderDash: [5, 5],
                    fill: false,
                    pointRadius: 0
                }
            ];

            if(document.getElementById('gas-model').value === 'real') {
                datasets.push({
                    label: 'Real Gas Isotherm',
                    data: dataPoints,
                    borderColor: '#2563EB',
                    fill: false,
                    pointRadius: 0
                });
            }

            // Operating Point
            datasets.push({
                label: 'Operating Point',
                data: [{x: V_act, y: P_act}],
                backgroundColor: '#EF4444',
                borderColor: '#EF4444',
                pointRadius: 6
            });

            gasChart = new Chart(ctx, {
                type: 'line',
                data: { datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { type: 'linear', position: 'bottom', title: {display:true, text:'Volume (m³)'} },
                        y: { title: {display:true, text:'Pressure (Pa)'} }
                    },
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `P: ${context.parsed.y.toPrecision(4)} Pa, V: ${context.parsed.x.toPrecision(4)} m³`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // --- PDF Generation ---
        document.getElementById('pdf-btn').addEventListener('click', () => {
            if(!lastResult) return;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const r = lastResult;
            const u = UNITS[r.sys];

            doc.setFontSize(18);
            doc.setTextColor(30, 58, 138);
            doc.text("Gas Analysis Report", 14, 20);
            
            doc.setFontSize(11);
            doc.setTextColor(100);
            doc.text(`Model: ${r.model === 'ideal' ? 'Ideal Gas' : 'Real Gas (Van der Waals)'}`, 14, 30);
            doc.text(`Compressibility Factor (Z): ${r.zFactor.toFixed(4)}`, 14, 38);

            const tableData = [
                ['Parameter', 'Value', 'Unit'],
                ['Pressure', fromSI(r.P, 'P', r.sys).toPrecision(5), u.P],
                ['Volume', fromSI(r.V, 'V', r.sys).toPrecision(5), u.V],
                ['Temperature', fromSI(r.T, 'T', r.sys).toFixed(2), u.T],
                ['Moles', r.n.toFixed(4), 'mol']
            ];

            doc.autoTable({
                startY: 45,
                head: [['Property', 'Value', 'Unit']],
                body: tableData.slice(1),
                theme: 'grid',
                headStyles: { fillColor: [30, 58, 138] }
            });

            doc.save('Gas_Law_Report.pdf');
        });

        // --- Init ---
        toggleGasType();
        updateInputs();
        updateUnits();
        
        // Theme Listener (Shared)
        if(localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark-mode');
            document.getElementById('theme-switch').checked = true;
        }
        document.getElementById('theme-switch').addEventListener('change', function() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('theme', this.checked ? 'dark' : 'light');
        });

    </script>
</body>
</html>
