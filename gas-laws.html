<!DOCTYPE html>
<html lang="en">
<head>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5936527763614780"
     crossorigin="anonymous"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-23Y1V450SR"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-23Y1V450SR');
</script>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5936527763614780"
     crossorigin="anonymous"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gas Law Calculator - Design Calculators - Mechanical</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- MathJax for LaTeX rendering -->
    <script type="text/javascript" id="MathJax-script" async
            src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
    </script>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="icon" href="/favicon.ico" type="image/x-icon">

    <script>
        // MathJax configuration to support inline and display LaTeX
        MathJax = {
            tex: {
                inlineMath: [['\\(', '\\)']],
                displayMath: [['\\[', '\\]']],
                processEscapes: true
            }
        };
    </script>
    <style>
        /* CSS Variables for theming (light and dark mode) */
        :root {
            --primary-color: #2196F3;
            --secondary-color: #1976D2;
            --accent-color: #FFC107;
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --text-color: #333333;
            --header-bg: #2C3E50;
            --footer-bg: #34495E;
            --border-color: #cccccc;
            --card-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
            --hover-color: #e2e6ea;
            --primary-color-rgb: 33, 150, 243;
            --success-color: #28a745;
            --error-color: #dc3545;
        }
        /* Dark mode overrides */
        body.dark-mode {
            --primary-color: #5DADE2;
            --secondary-color: #2874A6;
            --bg-color: #252D3A;
            --card-bg: #2F3C4C;
            --text-color: #E0E6EB;
            --header-bg: #252D3A;
            --footer-bg: #252D3A;
            --border-color: #4C5C70;
            --card-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
            --hover-color: #3A475C;
            --primary-color-rgb: 93, 173, 226;
            --success-color: #4CAF50;
            --error-color: #F44336;
        }
        /* Base body styling */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            background-image: radial-gradient(circle at center, var(--bg-color) 0%, rgba(244, 247, 246, 0.8) 100%);
            color: var(--text-color);
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s, background-image 0.3s;
        }
        /* Container for content width limitation and centering */
        .container {
            max-width: 960px;
            margin: 0 auto;
            padding: 20px;
        }
        /* Header styling */
        header {
            background-color: var(--header-bg);
            color: white;
            padding: 25px 0;
            text-align: center;
            box-shadow: var(--card-shadow);
            position: relative;
        }
        header h1 {
            margin: 0;
            font-size: 2.8em;
            color: var(--primary-color);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }
        header .subtitle {
            margin: 8px 0 0;
            font-size: 1.1em;
            color: #bdc3c7;
        }
        /* Main content area styling */
        main {
            padding: 30px 0;
        }
        /* Tool container styling */
        .tool-container {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 30px;
            box-shadow: var(--card-shadow);
            margin-bottom: 25px;
            transition: transform 0.3s ease-in-out;
        }
        .tool-container:hover {
            transform: translateY(-5px);
        }
        .tool-container h2 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 12px;
            margin-top: 0;
            margin-bottom: 25px;
            font-size: 2em;
        }
        .tool-description {
            margin-bottom: 25px;
            color: var(--text-color);
            font-size: 1.05em;
        }
        .tool-description ul {
            list-style-type: disc;
            margin-left: 25px;
            padding-left: 0;
            margin-top: 15px;
        }
        .tool-description ul li {
            margin-bottom: 8px;
        }
        .tool-description strong {
            color: var(--primary-color);
        }
        /* Back button styling */
        .back-button {
            display: inline-block;
            background-color: var(--primary-color);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            text-decoration: none;
            margin-bottom: 25px;
            transition: background-color 0.3s, transform 0.2s ease-in-out;
            font-weight: bold;
        }
        .back-button:hover {
            background-color: var(--secondary-color);
            transform: scale(1.03);
        }
        /* Theme toggle switch styling */
        .theme-toggle {
            position: absolute;
            top: 25px;
            right: 25px;
            display: flex;
            align-items: center;
        }
        .theme-toggle .light-icon,
        .theme-toggle .dark-icon {
            color: white;
            margin: 0 8px;
            font-size: 1.3em;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 65px;
            height: 38px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 30px;
            width: 30px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
        }
        input:checked + .slider {
            background-color: var(--primary-color);
        }
        input:focus + .slider {
            box-shadow: 0 0 1px var(--primary-color);
        }
        input:checked + .slider:before {
            transform: translateX(27px);
        }
        .slider.round {
            border-radius: 38px;
        }
        .slider.round:before {
            border-radius: 50%;
        }
        /* Footer styling */
        footer {
            background-color: var(--footer-bg);
            color: white;
            padding: 25px 0;
            text-align: center;
            box-shadow: 0 -3px 10px rgba(0, 0, 0, 0.2);
            margin-top: 40px;
        }
        footer .disclaimer h3,
        footer .social-share h3 {
            color: var(--primary-color);
            margin-bottom: 12px;
            font-size: 1.3em;
        }
        footer .disclaimer p {
            font-size: 0.95em;
            color: #bdc3c7;
        }
        .social-buttons {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        .social-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            color: white;
            text-decoration: none;
            font-size: 1.4em;
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .social-btn:hover {
            transform: translateY(-5px) scale(1.1);
            box-shadow: 0 8px 15px rgba(0,0,0,0.3);
        }
        /* Specific social button colors */
        .social-btn.linkedin { background-color: #0A66C2; }
        .social-btn.facebook { background-color: #1877F2; }
        .social-btn.twitter { background-color: #1DA1F2; }
        .social-btn.whatsapp { background-color: #25D366; }
        .social-btn.reddit { background-color: #FF4500; }
        .social-btn.email { background-color: #7f8c8d; }
        /* Calculator form styling */
        .calculator-form {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 30px;
            margin-top: 25px;
            box-shadow: var(--card-shadow);
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            font-size: 1.05em;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--bg-color);
            color: var(--text-color);
            box-sizing: border-box;
            font-size: 1em;
            transition: border-color 0.3s, box-shadow 0.3s;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.08);
        }
        .form-group input:focus, .form-group select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(var(--primary-color-rgb), 0.3);
            outline: none;
        }
        /* Responsive form row layout */
        .form-row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap; /* Allows items to wrap on smaller screens */
        }
        .form-row .form-group {
            flex: 1 1 calc(50% - 10px); /* Two columns, with gap */
            min-width: 280px; /* Minimum width before wrapping */
        }
        /* Media query for single column on small screens */
        @media (max-width: 600px) {
            .form-row .form-group {
                flex: 1 1 100%; /* Single column */
            }
        }
        /* Calculate button styling */
        .calculate-btn {
            background-image: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 18px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 17px;
            font-weight: bold;
            margin-top: 20px;
            transition: background-image 0.3s ease-in-out, transform 0.2s ease-in-out, box-shadow 0.3s ease-in-out;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            width: 100%; /* Full width button */
        }
        .calculate-btn:hover {
            background-image: linear-gradient(to right, var(--secondary-color), var(--primary-color));
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }
        /* Result container styling */
        .result-container {
            margin-top: 40px;
            padding: 30px;
            border-radius: 12px;
            background-color: var(--card-bg);
            box-shadow: var(--card-shadow);
            display: block; /* Always block, but opacity controls visibility */
            opacity: 0;
            transition: opacity 0.6s ease-out;
            pointer-events: none; /* Prevents interaction when hidden */
        }
        .result-container.show {
            opacity: 1;
            pointer-events: auto; /* Allows interaction when shown */
        }
        .result-container h3 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 1.8em;
        }
        /* Result table styling */
        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .result-table th, .result-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        .result-table th {
            background-color: var(--hover-color);
            font-weight: bold;
            font-size: 1.1em;
        }
        .result-table tr:last-child td {
            border-bottom: none;
        }
        /* Standard reference text styling */
        .standard-reference {
            margin-top: 25px;
            font-style: italic;
            font-size: 0.95rem;
            line-height: 1.5;
            padding: 10px;
            background-color: var(--bg-color);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        /* Tooltip styling */
        .info-icon {
            color: var(--primary-color);
            margin-left: 8px;
            cursor: help;
            font-size: 1em;
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 220px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%; /* Position above the element */
            left: 50%;
            margin-left: -110px; /* Center the tooltip */
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.85em;
        }
        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%; /* Arrow at the bottom */
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        /* Custom message box for alerts */
        #custom-message-box {
            position: fixed;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            padding: 18px 30px;
            border-radius: 10px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.3);
            z-index: 1000;
            font-weight: bold;
            color: white;
            opacity: 0;
            transition: opacity 0.5s ease-in-out, background-color 0.3s;
            font-size: 1.1em;
        }
        #custom-message-box.info {
            background-color: var(--success-color);
        }
        #custom-message-box.error {
            background-color: var(--error-color);
        }
        #custom-message-box.warning {
            background-color: var(--accent-color);
            color: #333;
        }

        /* Calculation details section styling */
        #calculation-details {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
            font-size: 0.98em;
            overflow-x: auto; /* Allow horizontal scrolling for formulas if needed */
        }
        #calculation-details h4 {
            color: var(--secondary-color);
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        #calculation-details p.formula {
            font-family: 'Times New Roman', serif;
            font-style: italic;
            font-size: 1.2em;
            text-align: center;
            padding: 12px 0;
            background-color: var(--hover-color);
            border-radius: 6px;
            margin: 15px 0;
            border: 1px dashed var(--border-color);
            white-space: nowrap; /* Prevent formula from wrapping */
        }
        #calculation-details p.calculation-step {
            font-family: 'Courier New', monospace;
            background-color: var(--hover-color);
            padding: 8px 12px;
            border-radius: 5px;
            margin-bottom: 8px;
            font-size: 0.95em;
            white-space: nowrap; /* Prevent calculation steps from wrapping */
        }
        #calculation-details ul {
            list-style-type: disc;
            margin-left: 25px;
            padding-left: 0;
        }
        #calculation-details ul li {
            margin-bottom: 5px;
        }
        /* Specific styling for required inputs to highlight visually */
        input:required:invalid {
            border-color: var(--error-color);
        }
        input:required:valid {
            border-color: var(--success-color);
        }

        /* Radio button styling for Gas Model */
        .radio-group {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .radio-group label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: normal;
        }
        .radio-group input[type="radio"] {
            width: auto;
            margin-right: 8px;
            transform: scale(1.2); /* Make radio buttons slightly larger */
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>Design Calculators - Mechanical</h1>
            <p class="subtitle">Smart Tools for Modern Mechanical Engineers</p>
            <div class="theme-toggle">
                <span class="light-icon"><i class="fas fa-sun"></i></span>
                <label class="switch">
                    <input type="checkbox" id="theme-switch">
                    <span class="slider round"></span>
                </label>
                <span class="dark-icon"><i class="fas fa-moon"></i></span>
            </div>
        </div>
    </header>

    <main class="container">
        <a href="indexMech.html" class="back-button">
            <i class="fas fa-arrow-left"></i> Back to Tools
        </a>

        <div class="tool-container">
            <h2>Gas Law Calculator (Ideal & Real Gases)</h2>
            <div class="tool-description">
                <p>This calculator allows you to perform calculations for both <strong>Ideal Gases</strong> using the Ideal Gas Law (\\(PV = nRT\\)) and <strong>Real Gases</strong> using the Van der Waals Equation (\\((P + \\frac{an^2}{V^2})(V - nb) = nRT\\)).</p>
                <p><strong>Key Features:</strong></p>
                <ul>
                    <li>Calculate any unknown variable (P, V, n, or T) given the other three.</li>
                    <li>Supports common unit systems.</li>
                    <li>Provides Van der Waals constants for selected common gases.</li>
                    <li>Detailed step-by-step calculations for transparent results.</li>
                </ul>
                <p><strong>Important Notes:</strong></p>
                <ul>
                    <li>For real gas calculations, ensure you select a gas type to auto-populate Van der Waals constants (\\(a\\) and \\(b\\)).</li>
                    <li>When calculating Volume (\\(V\\)) or Number of Moles (\\(n\\)) for real gases, the calculator employs a numerical root-finding method (Newton-Raphson) as these equations are cubic and do not have a simple direct algebraic solution. Convergence may vary based on input values.</li>
                    <li><strong>Units:</strong> Ensure consistency. All inputs will be converted internally to SI units (P in Pascal, V in m³, n in mol, T in Kelvin) for calculation, and then results converted back to your chosen display units.</li>
                </ul>
            </div>

            <div class="calculator-form">
                <form id="gas-law-form">
                    <div class="form-group">
                        <label for="unit-system">Unit System: <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Select the desired unit system for inputs and outputs.</span></span></label>
                        <select id="unit-system" required>
                            <option value="SI">SI (Pa, m³, mol, K)</option>
                            <option value="kPa_L">kPa, L, mol, K</option>
                            <option value="atm_L">atm, L, mol, K</option>
                            <option value="psi_ft3_F">psi, ft³, mol, °F</option>
                            <option value="bar_L_C">bar, L, mol, °C</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Gas Model: <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Choose between Ideal Gas Law or Van der Waals Equation for real gases.</span></span></label>
                        <div class="radio-group">
                            <label><input type="radio" name="gas-model" value="ideal" checked> Ideal Gas</label>
                            <label><input type="radio" name="gas-model" value="real"> Real Gas (Van der Waals)</label>
                        </div>
                    </div>

                    <div class="form-group" id="gas-type-group" style="display: none;">
                        <label for="gas-type">Gas Type: <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Select a common gas to load its Van der Waals constants.</span></span></label>
                        <select id="gas-type">
                            <option value="air">Air</option>
                            <option value="h2">Hydrogen (H₂)</option>
                            <option value="o2">Oxygen (O₂)</option>
                            <option value="n2">Nitrogen (N₂)</option>
                            <option value="ch4">Methane (CH₄)</option>
                            <option value="h2o">Water (H₂O) Vapor</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="calculate-variable">Calculate: <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Select which variable you want to calculate. Its input field will be disabled.</span></span></label>
                        <select id="calculate-variable" required>
                            <option value="P">Pressure (P)</option>
                            <option value="V">Volume (V)</option>
                            <option value="n">Number of Moles (n)</option>
                            <option value="T">Temperature (T)</option>
                        </select>
                    </div>

                    <h3>Input Parameters</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="pressure-input">Pressure (P) <span class="pressure-unit-label">(Pa)</span>: </label>
                            <input type="number" id="pressure-input" step="any" value="" required>
                        </div>
                        <div class="form-group">
                            <label for="volume-input">Volume (V) <span class="volume-unit-label">(m³)</span>: </label>
                            <input type="number" id="volume-input" step="any" value="" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="moles-input">Number of Moles (n) <span class="moles-unit-label">(mol)</span>: </label>
                            <input type="number" id="moles-input" step="any" value="" required>
                        </div>
                        <div class="form-group">
                            <label for="temperature-input">Temperature (T) <span class="temperature-unit-label">(K)</span>: </label>
                            <input type="number" id="temperature-input" step="any" value="" required>
                        </div>
                    </div>

                    <div class="form-row" id="van-der-waals-constants" style="display: none;">
                        <div class="form-group">
                            <label for="vdw-a">Van der Waals 'a' <span class="vdw-a-unit-label">(Pa·m⁶/mol²)</span>: </label>
                            <input type="number" id="vdw-a" step="any" value="0.137" readonly>
                        </div>
                        <div class="form-group">
                            <label for="vdw-b">Van der Waals 'b' <span class="vdw-b-unit-label">(m³/mol)</span>: </label>
                            <input type="number" id="vdw-b" step="any" value="0.0000364" readonly>
                        </div>
                    </div>

                    <button type="button" id="calculate-gas-law-btn" class="calculate-btn">Calculate Gas Law</button>
                </form>
            </div>

            <div id="result-container" class="result-container">
                <h3>Calculation Results</h3>
                <div id="calculation-details"></div>
                <table class="result-table">
                    <thead>
                        <tr>
                            <th>Parameter</th>
                            <th>Value</th>
                        </tr>
                    </thead>
                    <tbody id="result-table-body"></tbody>
                </table>
                <div class="standard-reference" id="standard-reference"></div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <div class="disclaimer">
                <h3>Disclaimer</h3>
                <p>To ensure accuracy and reliability, always verify the results obtained from these tools against the relevant engineering standards and guidelines.</p>
            </div>
            <div class="credit">
                <p>Created by A Sharma</p>
            </div>
            <div class="social-share">
                <h3>Share This Site</h3>
                <div class="social-buttons">
                    <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://designcalculators.co.in&title=Design Calculators - Mechanical" target="_blank" class="social-btn linkedin">
                        <i class="fab fa-linkedin"></i>
                    </a>
                    <a href="https://www.facebook.com/sharer/sharer.php?u=https://designcalculators.co.in" target="_blank" class="social-btn facebook">
                        <i class="fab fa-facebook"></i>
                    </a>
                    <a href="https://twitter.com/intent/tweet?text=Check out this amazing Design Calculators - Mechanical!&url=https://designcalculators.co.in" target="_blank" class="social-btn twitter">
                        <i class="fab fa-twitter"></i>
                    </a>
                    <a href="https://api.whatsapp.com/send?text=Check out this amazing Design Calculators - Mechanical! https://designcalculators.co.in" target="_blank" class="social-btn whatsapp">
                        <i class="fab fa-whatsapp"></i>
                    </a>
                    <a href="https://www.reddit.com/submit?url=https://designcalculators.co.in&title=Design Calculators - Mechanical" target="_blank" class="social-btn reddit">
                        <i class="fab fa-reddit"></i>
                    </a>
                    <a href="mailto:?subject=Check out Design Calculators - Mechanical!&body=I found this amazing Gas Law Calculator and other mechanical tools: https://designcalculators.co.in" class="social-btn email">
                        <i class="fas fa-envelope"></i>
                    </a>
                </div>
            </div>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Get references to DOM elements
            const calculateBtn = document.getElementById('calculate-gas-law-btn');
            const resultContainer = document.getElementById('result-container');
            const resultTableBody = document.getElementById('result-table-body');
            const standardReference = document.getElementById('standard-reference');
            const calculationDetailsDiv = document.getElementById('calculation-details');

            // Input fields
            const unitSystemSelect = document.getElementById('unit-system');
            const gasModelRadios = document.querySelectorAll('input[name="gas-model"]');
            const gasTypeSelect = document.getElementById('gas-type');
            const calculateVariableSelect = document.getElementById('calculate-variable');
            
            const pressureInput = document.getElementById('pressure-input');
            const volumeInput = document.getElementById('volume-input');
            const molesInput = document.getElementById('moles-input');
            const temperatureInput = document.getElementById('temperature-input');

            const vdwAGroup = document.getElementById('van-der-waals-constants');
            const vdwAInput = document.getElementById('vdw-a');
            const vdwBInput = document.getElementById('vdw-b');

            // Unit labels
            const pressureUnitLabel = document.querySelector('.pressure-unit-label');
            const volumeUnitLabel = document.querySelector('.volume-unit-label');
            const molesUnitLabel = document.querySelector('.moles-unit-label');
            const temperatureUnitLabel = document.querySelector('.temperature-unit-label');
            const vdwAUnitLabel = document.querySelector('.vdw-a-unit-label');
            const vdwBUnitLabel = document.querySelector('.vdw-b-unit-label');

            // Universal Gas Constant (R) in J/(mol·K)
            const R_UNIVERSAL = 8.314462618; // J/(mol·K) or Pa·m³/(mol·K)

            // Default values for P, V, n, T in SI units
            const defaultSIValues = {
                P: 101325, // Pa (1 atm)
                V: 1,      // m³
                n: 1,      // mol
                T: 298.15  // K (25 °C)
            };

            // Van der Waals constants for common gases (a in Pa·m⁶/mol², b in m³/mol)
            const vanDerWaalsConstants = {
                air: { a: 0.137, b: 3.64e-5 },
                h2: { a: 0.02476, b: 2.661e-5 }, // Hydrogen
                o2: { a: 0.1378, b: 3.183e-5 },  // Oxygen
                n2: { a: 0.1366, b: 3.861e-5 },  // Nitrogen
                ch4: { a: 0.2250, b: 4.278e-5 }, // Methane
                h2o: { a: 0.5536, b: 3.049e-5 }  // Water Vapor
            };

            /**
             * Displays a custom message box at the top of the screen.
             * @param {string} message - The message to display.
             * @param {string} type - The type of message ('info', 'error', 'warning').
             */
            function displayMessage(message, type = "info") {
                let messageBox = document.getElementById('custom-message-box');
                if (!messageBox) {
                    messageBox = document.createElement('div');
                    messageBox.id = 'custom-message-box';
                    document.body.appendChild(messageBox);
                }
                messageBox.textContent = message;
                messageBox.className = ''; // Clear previous classes
                messageBox.classList.add(type); // Add type class for styling
                messageBox.style.opacity = 1;

                // Hide message after 5 seconds
                setTimeout(() => {
                    messageBox.style.opacity = 0;
                }, 5000);
            }

            /**
             * Updates the unit labels and default input values in the UI based on the selected unit system.
             */
            function updateUnitLabelsAndDefaults() {
                const unitSystem = unitSystemSelect.value;
                let pUnit, vUnit, nUnit, tUnit, vdwAUnit, vdwBUnit;

                switch (unitSystem) {
                    case 'SI':
                        pUnit = '(Pa)'; vUnit = '(m³)'; nUnit = '(mol)'; tUnit = '(K)';
                        vdwAUnit = '(Pa·m⁶/mol²)'; vdwBUnit = '(m³/mol)';
                        break;
                    case 'kPa_L':
                        pUnit = '(kPa)'; vUnit = '(L)'; nUnit = '(mol)'; tUnit = '(K)';
                        vdwAUnit = '(kPa·L²/mol²)'; vdwBUnit = '(L/mol)';
                        break;
                    case 'atm_L':
                        pUnit = '(atm)'; vUnit = '(L)'; nUnit = '(mol)'; tUnit = '(K)';
                        vdwAUnit = '(atm·L²/mol²)'; vdwBUnit = '(L/mol)';
                        break;
                    case 'psi_ft3_F':
                        pUnit = '(psi)'; vUnit = '(ft³)'; nUnit = '(mol)'; tUnit = '(°F)';
                        vdwAUnit = '(psi·ft⁶/lbmol²)'; vdwBUnit = '(ft³/lbmol)'; // Using lbmol for consistency in Imperial
                        break;
                    case 'bar_L_C':
                        pUnit = '(bar)'; vUnit = '(L)'; nUnit = '(mol)'; tUnit = '(°C)';
                        vdwAUnit = '(bar·L²/mol²)'; vdwBUnit = '(L/mol)';
                        break;
                }

                pressureUnitLabel.textContent = pUnit;
                volumeUnitLabel.textContent = vUnit;
                molesUnitLabel.textContent = nUnit;
                temperatureUnitLabel.textContent = tUnit;
                vdwAUnitLabel.textContent = vdwAUnit;
                vdwBUnitLabel.textContent = vdwBUnit;

                // Set default values for inputs, respecting disabled state
                if (!pressureInput.disabled) {
                    pressureInput.value = convertFromSI(defaultSIValues.P, 'P').toPrecision(6);
                }
                if (!volumeInput.disabled) {
                    volumeInput.value = convertFromSI(defaultSIValues.V, 'V').toPrecision(6);
                }
                if (!molesInput.disabled) {
                    molesInput.value = convertFromSI(defaultSIValues.n, 'n').toPrecision(6);
                }
                if (!temperatureInput.disabled) {
                    temperatureInput.value = convertFromSI(defaultSIValues.T, 'T').toPrecision(6);
                }

                // Update VdW constants if real gas is selected
                const isRealGas = document.querySelector('input[name="gas-model"]:checked').value === 'real';
                if (isRealGas) {
                    updateVanDerWaalsConstants();
                }
            }

            /**
             * Converts a value from the selected UI unit to SI base unit.
             * @param {number} value - The input value.
             * @param {string} type - The type of value ('P', 'V', 'n', 'T', 'a', 'b').
             * @returns {number} - The value in SI base unit.
             */
            function convertToSI(value, type) {
                const unitSystem = unitSystemSelect.value;
                switch (type) {
                    case 'P':
                        switch (unitSystem) {
                            case 'SI': return value;
                            case 'kPa_L': return value * 1000; // kPa to Pa
                            case 'atm_L': return value * 101325; // atm to Pa
                            case 'psi_ft3_F': return value * 6894.76; // psi to Pa
                            case 'bar_L_C': return value * 100000; // bar to Pa
                            default: return value;
                        }
                    case 'V':
                        switch (unitSystem) {
                            case 'SI': return value;
                            case 'kPa_L': return value / 1000; // L to m³
                            case 'atm_L': return value / 1000; // L to m³
                            case 'psi_ft3_F': return value * 0.0283168; // ft³ to m³
                            case 'bar_L_C': return value / 1000; // L to m³
                            default: return value;
                        }
                    case 'n': // Moles are mol in most systems or lbmol. Assuming mol for calculations here.
                        return value; // Mol is typically base unit, no conversion needed for standard mol
                    case 'T':
                        switch (unitSystem) {
                            case 'SI':
                            case 'kPa_L':
                            case 'atm_L': return value; // K
                            case 'psi_ft3_F': return (value - 32) * 5/9 + 273.15; // °F to K
                            case 'bar_L_C': return value + 273.15; // °C to K
                            default: return value;
                        }
                    case 'a': // Van der Waals 'a' constant to Pa·m⁶/mol²
                        switch (unitSystem) {
                            case 'SI': return value;
                            case 'kPa_L': return value * 1000 * (1/1000)**2; // kPa·L²/mol² to Pa·m⁶/mol² (kPa to Pa, L² to m⁶)
                            case 'atm_L': return value * 101325 * (1/1000)**2; // atm·L²/mol² to Pa·m⁶/mol²
                            case 'psi_ft3_F': return value * (6894.76 * (0.0283168)**2); // psi·ft⁶/lbmol² to Pa·m⁶/mol²
                            case 'bar_L_C': return value * (100000 * (1/1000)**2); // bar·L²/mol² to Pa·m⁶/mol²
                            default: return value;
                        }
                    case 'b': // Van der Waals 'b' constant to m³/mol
                        switch (unitSystem) {
                            case 'SI': return value;
                            case 'kPa_L': return value / 1000; // L/mol to m³/mol
                            case 'atm_L': return value / 1000; // L/mol to m³/mol
                            case 'psi_ft3_F': return value * 0.0283168; // ft³/lbmol to m³/mol
                            case 'bar_L_C': return value / 1000; // L/mol to m³/mol
                            default: return value;
                        }
                    default: return value;
                }
            }

            /**
             * Converts a value from SI base unit to the selected UI unit.
             * @param {number} value - The value in SI base unit.
             * @param {string} type - The type of value ('P', 'V', 'n', 'T', 'a', 'b').
             * @returns {number} - The value in the selected UI unit.
             */
            function convertFromSI(value, type) {
                const unitSystem = unitSystemSelect.value;
                switch (type) {
                    case 'P':
                        switch (unitSystem) {
                            case 'SI': return value;
                            case 'kPa_L': return value / 1000; // Pa to kPa
                            case 'atm_L': return value / 101325; // Pa to atm
                            case 'psi_ft3_F': return value / 6894.76; // Pa to psi
                            case 'bar_L_C': return value / 100000; // Pa to bar
                            default: return value;
                        }
                    case 'V':
                        switch (unitSystem) {
                            case 'SI': return value;
                            case 'kPa_L': return value * 1000; // m³ to L
                            case 'atm_L': return value * 1000; // m³ to L
                            case 'psi_ft3_F': return value / 0.0283168; // m³ to ft³
                            case 'bar_L_C': return value * 1000; // m³ to L
                            default: return value;
                        }
                    case 'n':
                        return value; // mol
                    case 'T':
                        switch (unitSystem) {
                            case 'SI':
                            case 'kPa_L':
                            case 'atm_L': return value; // K
                            case 'psi_ft3_F': return (value - 273.15) * 9/5 + 32; // K to °F
                            case 'bar_L_C': return value - 273.15; // K to °C
                            default: return value;
                        }
                    case 'a': // Van der Waals 'a' constant from Pa·m⁶/mol²
                        switch (unitSystem) {
                            case 'SI': return value;
                            case 'kPa_L': return value / (1000 * (1/1000)**2); // Pa·m⁶/mol² to kPa·L²/mol²
                            case 'atm_L': return value / (101325 * (1/1000)**2); // Pa·m⁶/mol² to atm·L²/mol²
                            case 'psi_ft3_F': return value / (6894.76 * (0.0283168)**2); // Pa·m⁶/mol² to psi·ft⁶/lbmol²
                            case 'bar_L_C': return value / (100000 * (1/1000)**2); // Pa·m⁶/mol² to bar·L²/mol²
                            default: return value;
                        }
                    case 'b': // Van der Waals 'b' constant from m³/mol
                        switch (unitSystem) {
                            case 'SI': return value;
                            case 'kPa_L': return value * 1000; // m³/mol to L/mol
                            case 'atm_L': return value * 1000; // m³/mol to L/mol
                            case 'psi_ft3_F': return value / 0.0283168; // m³/mol to ft³/lbmol
                            case 'bar_L_C': return value * 1000; // m³/mol to L/mol
                            default: return value;
                        }
                    default: return value;
                }
            }


            /**
             * Adds a row to the result table.
             * @param {string} parameterHtml - The HTML content for the parameter column.
             * @param {string} valueHtml - The HTML content for the value column.
             */
            function addResultRow(parameterHtml, valueHtml) {
                const row = resultTableBody.insertRow();
                const paramCell = row.insertCell();
                const valueCell = row.insertCell();
                paramCell.innerHTML = parameterHtml;
                valueCell.innerHTML = valueHtml;
            }

            /**
             * Toggles visibility of Van der Waals constants inputs based on gas model selection.
             */
            function toggleVanDerWaalsInputs() {
                const isRealGas = document.querySelector('input[name="gas-model"]:checked').value === 'real';
                gasTypeSelect.disabled = !isRealGas;
                vdwAGroup.style.display = isRealGas ? 'flex' : 'none';
                if (isRealGas) {
                    updateVanDerWaalsConstants();
                }
                updateInputDisabilityAndDefaults(); // Recalculate which inputs should be enabled/disabled and set defaults
            }

            /**
             * Updates Van der Waals 'a' and 'b' values based on selected gas type.
             */
            function updateVanDerWaalsConstants() {
                const selectedGas = gasTypeSelect.value;
                const constants = vanDerWaalsConstants[selectedGas];
                if (constants) {
                    vdwAInput.value = convertFromSI(constants.a, 'a').toPrecision(4);
                    vdwBInput.value = convertFromSI(constants.b, 'b').toPrecision(4);
                }
            }

            /**
             * Disables the input field for the variable to be calculated and sets default values for enabled fields.
             */
            function updateInputDisabilityAndDefaults() {
                const calculateVariable = calculateVariableSelect.value;
                
                // First, disable and clear the input to be calculated
                pressureInput.disabled = (calculateVariable === 'P');
                volumeInput.disabled = (calculateVariable === 'V');
                molesInput.disabled = (calculateVariable === 'n');
                temperatureInput.disabled = (calculateVariable === 'T');

                // Ensure required attribute is consistent with disability
                pressureInput.required = !pressureInput.disabled;
                volumeInput.required = !volumeInput.disabled;
                molesInput.required = !molesInput.disabled;
                temperatureInput.required = !temperatureInput.disabled;

                // Clear value if disabled to avoid stale data
                if (pressureInput.disabled) pressureInput.value = '';
                if (volumeInput.disabled) volumeInput.value = '';
                if (molesInput.disabled) molesInput.value = '';
                if (temperatureInput.disabled) temperatureInput.value = '';

                // Now, set default values for the enabled inputs
                if (!pressureInput.disabled) {
                    pressureInput.value = convertFromSI(defaultSIValues.P, 'P').toPrecision(6);
                }
                if (!volumeInput.disabled) {
                    volumeInput.value = convertFromSI(defaultSIValues.V, 'V').toPrecision(6);
                }
                if (!molesInput.disabled) {
                    molesInput.value = convertFromSI(defaultSIValues.n, 'n').toPrecision(6);
                }
                if (!temperatureInput.disabled) {
                    temperatureInput.value = convertFromSI(defaultSIValues.T, 'T').toPrecision(6);
                }
            }

            /**
             * Newton-Raphson method for finding roots.
             * @param {function} f - The function for which to find the root.
             * @param {function} df - The derivative of the function.
             * @param {number} x0 - Initial guess.
             * @param {number} tolerance - The desired accuracy.
             * @param {number} maxIterations - Maximum number of iterations.
             * @returns {number|null} - The root found, or null if not converged.
             */
            function newtonRaphson(f, df, x0, tolerance = 1e-9, maxIterations = 1000) {
                let x = x0;
                for (let i = 0; i < maxIterations; i++) {
                    const fx = f(x);
                    const dfx = df(x);

                    if (Math.abs(dfx) < 1e-15) { // Avoid division by very small numbers
                        displayMessage("Newton-Raphson: Derivative too small, cannot converge. Try a different initial guess or inputs.", "warning");
                        return null;
                    }

                    const x_new = x - fx / dfx;
                    if (Math.abs(x_new - x) < tolerance) {
                        return x_new;
                    }
                    x = x_new;
                }
                displayMessage("Newton-Raphson: Did not converge within maximum iterations. Consider adjusting inputs or tolerance.", "warning");
                return null; // Did not converge
            }

            // Event listeners
            unitSystemSelect.addEventListener('change', updateUnitLabelsAndDefaults);
            gasModelRadios.forEach(radio => radio.addEventListener('change', toggleVanDerWaalsInputs));
            gasTypeSelect.addEventListener('change', updateVanDerWaalsConstants);
            calculateVariableSelect.addEventListener('change', updateInputDisabilityAndDefaults);

            // Initial UI setup on load
            updateUnitLabelsAndDefaults(); // Sets initial labels and default values
            toggleVanDerWaalsInputs(); // Sets initial state for gas type and VdW constants (will call updateInputDisabilityAndDefaults again, which is fine)


            calculateBtn.addEventListener('click', function() {
                const form = document.getElementById('gas-law-form');
                if (!form.checkValidity()) {
                    displayMessage("Please fill in all required fields correctly.", "error");
                    form.reportValidity();
                    return;
                }

                // Gather input values in SI units
                let P_si = pressureInput.disabled ? null : convertToSI(parseFloat(pressureInput.value), 'P');
                let V_si = volumeInput.disabled ? null : convertToSI(parseFloat(volumeInput.value), 'V');
                let n_si = molesInput.disabled ? null : convertToSI(parseFloat(molesInput.value), 'n');
                let T_si = temperatureInput.disabled ? null : convertToSI(parseFloat(temperatureInput.value), 'T');

                const gasModel = document.querySelector('input[name="gas-model"]:checked').value;
                let a_si = 0; // Van der Waals 'a' in Pa·m⁶/mol²
                let b_si = 0; // Van der Waals 'b' in m³/mol
                if (gasModel === 'real') {
                    a_si = convertToSI(parseFloat(vdwAInput.value), 'a');
                    b_si = convertToSI(parseFloat(vdwBInput.value), 'b');
                }

                let calculationHtml = '<h4>Detailed Calculation Steps:</h4>';
                calculationHtml += `<p><strong>1. Input Parameters (converted to SI Units for calculation):</strong></p>`;
                calculationHtml += `<ul>
                    <li>Gas Model: ${gasModel === 'ideal' ? 'Ideal Gas' : 'Real Gas (Van der Waals)'}</li>
                    <li>R (Universal Gas Constant): ${R_UNIVERSAL.toPrecision(6)} J/(mol·K)</li>
                    ${P_si !== null ? `<li>Pressure (P): ${P_si.toPrecision(6)} Pa</li>` : ''}
                    ${V_si !== null ? `<li>Volume (V): ${V_si.toPrecision(6)} m³</li>` : ''}
                    ${n_si !== null ? `<li>Number of Moles (n): ${n_si.toPrecision(6)} mol</li>` : ''}
                    ${T_si !== null ? `<li>Temperature (T): ${T_si.toPrecision(6)} K</li>` : ''}
                    ${gasModel === 'real' ? `<li>Van der Waals 'a': ${a_si.toPrecision(6)} Pa·m⁶/mol²</li>` : ''}
                    ${gasModel === 'real' ? `<li>Van der Waals 'b': ${b_si.toPrecision(6)} m³/mol</li>` : ''}
                </ul>`;

                let calculatedValue = null;
                const calculateVariable = calculateVariableSelect.value;

                try {
                    if (gasModel === 'ideal') {
                        calculationHtml += `<p><strong>2. Ideal Gas Law:</strong> \\(PV = nRT\\)</p>`;
                        if (calculateVariable === 'P') {
                            if (V_si <= 0 || n_si <= 0 || T_si <= 0) { throw new Error("V, n, T must be positive for Ideal Gas Law."); }
                            calculatedValue = (n_si * R_UNIVERSAL * T_si) / V_si;
                            calculationHtml += `<p class="formula">\\[ P = \\frac{nRT}{V} \\]</p>`;
                            calculationHtml += `<p class="calculation-step">
                                P = (${n_si.toPrecision(4)} \\times ${R_UNIVERSAL.toPrecision(4)} \\times ${T_si.toPrecision(4)}) / ${V_si.toPrecision(4)} = ${calculatedValue.toPrecision(6)} Pa
                            </p>`;
                        } else if (calculateVariable === 'V') {
                            if (P_si <= 0 || n_si <= 0 || T_si <= 0) { throw new Error("P, n, T must be positive for Ideal Gas Law."); }
                            calculatedValue = (n_si * R_UNIVERSAL * T_si) / P_si;
                            calculationHtml += `<p class="formula">\\[ V = \\frac{nRT}{P} \\]</p>`;
                            calculationHtml += `<p class="calculation-step">
                                V = (${n_si.toPrecision(4)} \\times ${R_UNIVERSAL.toPrecision(4)} \\times ${T_si.toPrecision(4)}) / ${P_si.toPrecision(4)} = ${calculatedValue.toPrecision(6)} m³
                            </p>`;
                        } else if (calculateVariable === 'n') {
                            if (P_si <= 0 || V_si <= 0 || T_si <= 0) { throw new Error("P, V, T must be positive for Ideal Gas Law."); }
                            calculatedValue = (P_si * V_si) / (R_UNIVERSAL * T_si);
                            calculationHtml += `<p class="formula">\\[ n = \\frac{PV}{RT} \\]</p>`;
                            calculationHtml += `<p class="calculation-step">
                                n = (${P_si.toPrecision(4)} \\times ${V_si.toPrecision(4)}) / (${R_UNIVERSAL.toPrecision(4)} \\times ${T_si.toPrecision(4)}) = ${calculatedValue.toPrecision(6)} mol
                            </p>`;
                        } else if (calculateVariable === 'T') {
                            if (P_si <= 0 || V_si <= 0 || n_si <= 0) { throw new Error("P, V, n must be positive for Ideal Gas Law."); }
                            calculatedValue = (P_si * V_si) / (n_si * R_UNIVERSAL);
                            calculationHtml += `<p class="formula">\\[ T = \\frac{PV}{nR} \\]</p>`;
                            calculationHtml += `<p class="calculation-step">
                                T = (${P_si.toPrecision(4)} \\times ${V_si.toPrecision(4)}) / (${n_si.toPrecision(4)} \\times ${R_UNIVERSAL.toPrecision(4)}) = ${calculatedValue.toPrecision(6)} K
                            </p>`;
                        }

                    } else { // Real Gas (Van der Waals)
                        calculationHtml += `<p><strong>2. Van der Waals Equation:</strong> \\((P + \\frac{an^2}{V^2})(V - nb) = nRT\\)</p>`;
                        
                        if (a_si < 0 || b_si < 0) { throw new Error("Van der Waals constants 'a' and 'b' must be non-negative."); }

                        if (calculateVariable === 'P') {
                            if (V_si <= 0 || n_si <= 0 || T_si <= 0) { throw new Error("V, n, T must be positive for Real Gas Law."); }
                            // (P + an^2/V^2)(V - nb) = nRT
                            // P = (nRT / (V - nb)) - an^2/V^2
                            if (V_si - n_si * b_si <= 0) {
                                throw new Error("Volume (V) must be greater than nb (V > nb) for real gas calculation. Check your inputs or Van der Waals 'b' constant.");
                            }
                            calculatedValue = (n_si * R_UNIVERSAL * T_si) / (V_si - n_si * b_si) - (a_si * n_si * n_si) / (V_si * V_si);
                            if (calculatedValue < 0) {
                                displayMessage("Calculated pressure is negative, which is physically impossible. This might indicate that the given conditions are beyond the validity of the Van der Waals equation for this gas, or inputs are unrealistic.", "warning");
                            }
                            calculationHtml += `<p class="formula">\\[ P = \\frac{nRT}{V - nb} - \\frac{an^2}{V^2} \\]</p>`;
                            calculationHtml += `<p class="calculation-step">
                                P = (${n_si.toPrecision(4)} \\times ${R_UNIVERSAL.toPrecision(4)} \\times ${T_si.toPrecision(4)}) / (${V_si.toPrecision(4)} - ${n_si.toPrecision(4)} \\times ${b_si.toPrecision(4)}) - (${a_si.toPrecision(4)} \\times ${n_si.toPrecision(4)}^2) / (${V_si.toPrecision(4)}^2) = ${calculatedValue.toPrecision(6)} Pa
                            </p>`;
                        } else if (calculateVariable === 'T') {
                            if (P_si <= 0 || V_si <= 0 || n_si <= 0) { throw new Error("P, V, n must be positive for Real Gas Law."); }
                            // T = ( (P + an^2/V^2)(V - nb) ) / (nR)
                            if (V_si - n_si * b_si <= 0) {
                                throw new Error("Volume (V) must be greater than nb (V > nb) for real gas calculation. Check your inputs or Van der Waals 'b' constant.");
                            }
                            calculatedValue = ((P_si + (a_si * n_si * n_si) / (V_si * V_si)) * (V_si - n_si * b_si)) / (n_si * R_UNIVERSAL);
                            if (calculatedValue < 0) {
                                displayMessage("Calculated temperature is negative (below absolute zero), which is physically impossible. This might indicate that the given conditions are beyond the validity of the Van der Waals equation for this gas, or inputs are unrealistic.", "warning");
                            }
                            calculationHtml += `<p class="formula">\\[ T = \\frac{(P + \\frac{an^2}{V^2})(V - nb)}{nR} \\]</p>`;
                            calculationHtml += `<p class="calculation-step">
                                T = ( (${P_si.toPrecision(4)} + ${a_si.toPrecision(4)} \\times ${n_si.toPrecision(4)}^2 / ${V_si.toPrecision(4)}^2) \\times (${V_si.toPrecision(4)} - ${n_si.toPrecision(4)} \\times ${b_si.toPrecision(4)}) ) / (${n_si.toPrecision(4)} \\times ${R_UNIVERSAL.toPrecision(4)}) = ${calculatedValue.toPrecision(6)} K
                            </p>`;
                        } else if (calculateVariable === 'V') {
                            if (P_si <= 0 || n_si <= 0 || T_si <= 0) { throw new Error("P, n, T must be positive for Real Gas Law."); }
                            // (P + an^2/V^2)(V - nb) = nRT
                            // Rearrange to cubic in V: PV^3 - (Pnb + nRT)V^2 + an^2V - an^3b = 0
                            // Let X = V
                            // f(X) = PX^3 - (Pnb + nRT)X^2 + an^2X - an^3b
                            // f'(X) = 3PX^2 - 2(Pnb + nRT)X + an^2

                            const coeff2 = -(P_si * n_si * b_si + n_si * R_UNIVERSAL * T_si);
                            const coeff1 = a_si * n_si * n_si;
                            const coeff0 = -a_si * n_si * n_si * n_si * b_si;

                            const f_v = (V) => P_si * V * V * V + coeff2 * V * V + coeff1 * V + coeff0;
                            const df_v = (V) => 3 * P_si * V * V + 2 * coeff2 * V + coeff1;

                            // Initial guess for V (start with ideal gas volume)
                            let initialGuessV = (n_si * R_UNIVERSAL * T_si) / P_si;
                            if (initialGuessV < n_si * b_si) { // Ensure initial guess is physically meaningful for V > nb
                                initialGuessV = n_si * b_si * 1.01; // Slightly larger than nb
                            }
                            
                            calculatedValue = newtonRaphson(f_v, df_v, initialGuessV);

                            if (calculatedValue !== null && calculatedValue <= n_si * b_si) {
                                displayMessage("Calculated volume is less than or equal to 'nb', which is physically impossible (gas molecules occupy zero volume). This might indicate the conditions are below the critical point, or inputs are unrealistic for the Van der Waals equation to predict a gas phase.", "warning");
                                calculatedValue = null; // Invalidate result
                            }

                            calculationHtml += `<p><strong>3. Numerical Solution for Volume (\\(V\\)) using Newton-Raphson:</strong></p>`;
                            calculationHtml += `<p>Equation to solve for \\(V\\): \\(PV^3 - (Pnb + nRT)V^2 + an^2V - an^3b = 0\\)</p>`;
                            if (calculatedValue !== null) {
                                calculationHtml += `<p class="calculation-step">
                                    Initial Guess (from Ideal Gas Law): ${initialGuessV.toPrecision(6)} m³<br>
                                    Converged Volume (V) = ${calculatedValue.toPrecision(6)} m³
                                </p>`;
                            } else {
                                calculationHtml += `<p class="calculation-step">Volume calculation did not converge or found an invalid result.</p>`;
                            }
                            
                        } else if (calculateVariable === 'n') {
                            if (P_si <= 0 || V_si <= 0 || T_si <= 0) { throw new Error("P, V, T must be positive for Real Gas Law."); }
                            // (P + an^2/V^2)(V - nb) = nRT
                            // This is a cubic equation in n:
                            // n^3(ab) + n^2(P_si*b_si - a_si/V_si - R_UNIVERSAL*T_si) + n(P_si*V_si + R_UNIVERSAL*T_si) - P_si*V_si^2 = 0 -- Re-evaluate this.
                            // Let's rewrite: (P + a n^2/V^2)(V - n b) - n R T = 0
                            // PV - Pnb + an^2/V - an^3b/V^2 - nRT = 0
                            // -ab/V^2 * n^3 + (a/V - Pb - RT) * n + PV = 0 (If quadratic for n)
                            // It's not straightforward cubic like V. Let's define the function directly.

                            const f_n = (n) => (P_si + (a_si * n * n) / (V_si * V_si)) * (V_si - n * b_si) - n * R_UNIVERSAL * T_si;
                            const df_n = (n) => {
                                // Derivative with respect to n:
                                // d/dn [ (P + an^2/V^2)(V - nb) - nRT ]
                                // Using product rule for first term: (u'v + uv')
                                // u = P + an^2/V^2  => u' = 2an/V^2
                                // v = V - nb        => v' = -b
                                // Derivative = (2an/V^2)(V - nb) + (P + an^2/V^2)(-b) - RT
                                return (2 * a_si * n / (V_si * V_si)) * (V_si - n * b_si) + (P_si + (a_si * n * n) / (V_si * V_si)) * (-b_si) - R_UNIVERSAL * T_si;
                            };

                            // Initial guess for n (start with ideal gas moles)
                            let initialGuessN = (P_si * V_si) / (R_UNIVERSAL * T_si);
                            if (initialGuessN < 0) initialGuessN = 0.1; // Ensure positive guess
                            
                            calculatedValue = newtonRaphson(f_n, df_n, initialGuessN);

                            if (calculatedValue !== null && calculatedValue < 0) {
                                displayMessage("Calculated number of moles is negative, which is physically impossible. This might indicate the given conditions are beyond the validity of the Van der Waals equation, or inputs are unrealistic.", "warning");
                                calculatedValue = null; // Invalidate result
                            }

                            calculationHtml += `<p><strong>3. Numerical Solution for Number of Moles (\\(n\\)) using Newton-Raphson:</strong></p>`;
                            calculationHtml += `<p>Equation to solve for \\(n\\): \\((P + \\frac{an^2}{V^2})(V - nb) - nRT = 0\\)</p>`;
                             if (calculatedValue !== null) {
                                calculationHtml += `<p class="calculation-step">
                                    Initial Guess (from Ideal Gas Law): ${initialGuessN.toPrecision(6)} mol<br>
                                    Converged Moles (n) = ${calculatedValue.toPrecision(6)} mol
                                </p>`;
                            } else {
                                calculationHtml += `<p class="calculation-step">Number of Moles calculation did not converge or found an invalid result.</p>`;
                            }
                        }
                    }

                    // Display results
                    resultTableBody.innerHTML = ''; // Clear previous results
                    
                    const pDisp = calculateVariable === 'P' ? convertFromSI(calculatedValue, 'P') : convertFromSI(P_si, 'P');
                    const vDisp = calculateVariable === 'V' ? convertFromSI(calculatedValue, 'V') : convertFromSI(V_si, 'V');
                    const nDisp = calculateVariable === 'n' ? convertFromSI(calculatedValue, 'n') : convertFromSI(n_si, 'n');
                    const tDisp = calculateVariable === 'T' ? convertFromSI(calculatedValue, 'T') : convertFromSI(T_si, 'T');

                    addResultRow("Pressure (P)", `<strong>${pDisp.toPrecision(6)} ${pressureUnitLabel.textContent.slice(1, -1)}</strong>`);
                    addResultRow("Volume (V)", `<strong>${vDisp.toPrecision(6)} ${volumeUnitLabel.textContent.slice(1, -1)}</strong>`);
                    addResultRow("Number of Moles (n)", `<strong>${nDisp.toPrecision(6)} ${molesUnitLabel.textContent.slice(1, -1)}</strong>`);
                    addResultRow("Temperature (T)", `<strong>${tDisp.toPrecision(6)} ${temperatureUnitLabel.textContent.slice(1, -1)}</strong>`);
                    
                    if (gasModel === 'real') {
                        addResultRow("Van der Waals 'a'", `${convertFromSI(a_si, 'a').toPrecision(6)} ${vdwAUnitLabel.textContent.slice(1, -1)}`);
                        addResultRow("Van der Waals 'b'", `${convertFromSI(b_si, 'b').toPrecision(6)} ${vdwBUnitLabel.textContent.slice(1, -1)}`);
                    }

                    calculationDetailsDiv.innerHTML = calculationHtml;

                    // Re-render MathJax equations
                    if (window.MathJax) {
                        window.MathJax.typesetPromise([calculationDetailsDiv, resultTableBody]);
                    }

                    // Display standard reference
                    standardReference.innerHTML = `This calculation is based on the <strong>${gasModel === 'ideal' ? 'Ideal Gas Law' : 'Van der Waals Equation for Real Gases'}</strong>. For complex or highly accurate scenarios, especially near critical points, more advanced equations of state or specialized thermodynamic software may be required.`;

                    // Show results container
                    resultContainer.style.display = 'block';
                    setTimeout(() => {
                        resultContainer.classList.add('show');
                    }, 10);
                    resultContainer.scrollIntoView({ behavior: 'smooth' });

                    displayMessage("Calculation completed successfully!", "info");

                } catch (error) {
                    displayMessage(`Calculation Error: ${error.message}`, "error");
                    resultContainer.classList.remove('show'); // Hide results on error
                    resultContainer.style.display = 'none';
                    resultTableBody.innerHTML = '';
                    calculationDetailsDiv.innerHTML = '';
                }
            });

            // Theme switch functionality
            const themeSwitch = document.getElementById('theme-switch');
            if (themeSwitch) {
                if (localStorage.getItem('theme') === 'dark') {
                    document.body.classList.add('dark-mode');
                    themeSwitch.checked = true;
                }
                themeSwitch.addEventListener('change', function() {
                    if (this.checked) {
                        document.body.classList.add('dark-mode');
                        localStorage.setItem('theme', 'dark');
                    } else {
                        document.body.classList.remove('dark-mode');
                        localStorage.setItem('theme', 'light');
                    }
                });
            }
        });
    </script>
</body>

</html>


