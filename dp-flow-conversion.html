<!DOCTYPE html>
<html lang="en" oncontextmenu="return false;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Differential Pressure to Flow Conversion - Design Calculators - Instrumentation</title>
    <!-- SEO Meta Tags -->
    <meta name="description" content="Professional calculator for DP flow conversion. Calculates mass and volumetric flow from differential pressure for orifice, venturi, nozzle, and pitot tubes per ISO 5167.">
    <meta name="keywords" content="dp flow calculator, differential pressure, flow rate, orifice plate, venturi, nozzle, pitot tube, iso 5167, bernoulli, reynolds number, beta ratio">
    <meta name="author" content="Design Calculators">
    <meta name="robots" content="index, follow">
    <!-- AdSense & Analytics -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5936527763614780" crossorigin="anonymous"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-23Y1V450SR"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-23Y1V450SR');
    </script>
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Montserrat:wght@700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- MathJax for Formulas -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['\\(', '\\)'], ['$', '$']],
                displayMath: [['\\[', '\\]'], ['$$', '$$']]
            },
            svg: { fontCache: 'global' },
            options: {
                processHtmlClass: 'math-content', // Process elements with this class
                ignoreHtmlClass: 'no-mathjax'     // Ignore elements with this class
            }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <!-- PDF Generation (Not used by this tool, but part of header) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>
    <!-- Favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    
    <style>
        /* Base Styles from new header */
        :root {
            --primary: #1E3A8A;
            --secondary: #2563EB;
            --accent: #F59E0B;
            --success: #10B981;
            --danger: #DC2626;
            --warning: #F59E0B;
            --bg: #F8FAFC;
            --card: #FFFFFF;
            --text: #4B5563;
            --heading: #111827;
            --footer-bg: #0F172A;
            --border: #E2E8F0;
            --grad: linear-gradient(135deg, var(--primary), var(--secondary));
            --grad-dark: linear-gradient(135deg, #0F172A, #1E293B);
            --shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        body.dark-mode {
            --primary: #10B981;
            --secondary: #34D399;
            --bg: #0F172A;
            --card: #1E293B;
            --text: #CBD5E1;
            --heading: #F1F5F9;
            --footer-bg: #020617;
            --border: #334155;
        }

        * { box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.7;
            margin: 0;
            padding: 0;
        }

        .container { max-width: 1280px; margin: 0 auto; padding: 0 24px; }

        /* Header & Nav */
        header {
            background: var(--grad);
            color: white;
            padding: 24px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo-container {
            display: flex;
            flex-direction: column;
            text-decoration: none;
            color: white;
        }
        .logo-text {
            font-size: 1.75rem;
            font-weight: 800;
            font-family: 'Montserrat', sans-serif;
        }
        .logo-subtitle {
            font-size: 0.8rem;
            margin: 4px 0 0 0;
            color: #E0E7FF;
            opacity: 0.9;
        }
        .nav-links {
            display: flex;
            gap: 24px;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        .nav-links a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }
        .nav-links a:hover { color: var(--accent); }
        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .switch {
            position: relative;
            width: 56px;
            height: 30px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.2);
            transition: .4s;
            border-radius: 30px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--accent);
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        /* Main Content & Cards */
        main { padding: 40px 0; }
        .card {
            background: var(--card);
            border-radius: 12px;
            padding: 30px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            border: 1px solid var(--border);
        }
        /* Applied to the tool container */
        .tool-container {
            background: var(--card);
            border-radius: 12px;
            padding: 30px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            border: 1px solid var(--border);
        }
        .tool-description {
            margin-bottom: 20px;
            color: var(--text);
            font-size: 1.05rem;
        }
        h2 {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
            padding-bottom: 15px;
            margin-top: 0;
            font-family: 'Montserrat', sans-serif;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        h3 {
            color: var(--heading);
            font-family: 'Montserrat', sans-serif;
            font-size: 1.5rem;
            margin-top: 25px;
            margin-bottom: 20px;
        }
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--heading);
        }
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 6px;
            background-color: var(--bg);
            color: var(--text);
            font-size: 1rem;
        }
        .form-group input:focus,
        .form-group select:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
        }
        body.dark-mode .form-group input:focus {
             box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }
        .calculator-form {
            background-color: var(--card);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
         .form-section {
            background-color: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 25px; /* Space between sections */
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
            opacity: 0; /* Initial state for fade-in animation */
            transform: translateY(10px); /* Initial state for slide-up animation */
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }
        .form-section.fade-in {
            opacity: 1;
            transform: translateY(0);
        }
        .form-section h3 {
            color: var(--secondary);
            margin-top: 0;
            margin-bottom: 15px;
            border-bottom: 1px dashed var(--border);
            padding-bottom: 10px;
        }
        .btn {
            background: var(--grad);
            color: white;
            border: none;
            padding: 16px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(30, 58, 138, 0.3);
            transition: all 0.3s;
            width: 100%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(30, 58, 138, 0.4);
        }
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center; /* Center buttons */
        }
        .btn-group .btn {
            flex: 1;
            min-width: 150px;
            max-width: 250px; /* Max width for buttons */
        }
        .btn.secondary {
            background: var(--secondary);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }
        .btn.accent {
            background: var(--accent);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }
        

        /* CALCULATION STEPS DISPLAY */
        .steps-container {
            display: none;
            margin-top: 30px;
        }
        .steps-container.active {
            display: block;
        }
        .step-card {
            background: var(--card);
            border-radius: 12px;
            padding: 25px 30px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            animation: slideIn 0.6s ease-out;
            transition: all 0.3s;
            margin-bottom: 25px; /* Spacing between cards */
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .step-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }
        .step-card h4 {
            color: var(--primary);
            margin: 0 0 20px 0;
            font-size: 1.4rem;
            font-family: 'Montserrat', sans-serif;
            display: flex;
            align-items: center;
        }
        .step-card .number {
            display: inline-block;
            width: 40px;
            height: 40px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 40px;
            font-weight: 700;
            margin-right: 15px;
            font-size: 1.3rem;
            flex-shrink: 0;
        }
        .step-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            align-items: start;
        }
        @media (max-width: 768px) {
            .step-content {
                grid-template-columns: 1fr;
            }
        }
        .step-content .formula-block {
            background: var(--bg);
            border-radius: 8px;
            padding: 20px;
            font-size: 1rem;
            border: 1px solid var(--border);
        }
        .step-content .formula-block p {
            margin-top: 0;
        }
        .step-content .formula {
            background: var(--bg);
            border-left: 3px solid var(--accent);
            padding: 15px;
            margin: 12px 0;
            font-size: 1rem;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
        }
        .step-value {
            font-size: 2.2rem;
            font-weight: 800;
            color: var(--success);
            margin: 10px 0;
            line-height: 1.2;
        }
        .step-unit {
            font-size: 1rem;
            color: var(--text);
            opacity: 0.8;
            font-weight: 500;
            margin-left: 5px;
        }
        .step-explanation {
            font-size: 1.05rem;
            line-height: 1.8;
        }

        /* Results */
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-radius: 8px;
            overflow: hidden;
        }
        .results-table th,
        .results-table td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        .results-table th {
            background: var(--grad);
            color: white;
            font-weight: 700;
        }
        .results-table tr:nth-child(even) {
            background-color: var(--bg);
        }
        .results-table td:first-child {
            font-weight: 600;
            color: var(--heading);
        }
        .results-table .highlight {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--success);
        }
        .results-table .warning {
            font-weight: 700;
            color: var(--warning);
        }
         .results-table .error {
            font-weight: 700;
            color: var(--danger);
        }

        /* Educational Section */
        .education-section {
            margin-top: 60px;
        }
        .insight-card {
            background: linear-gradient(135deg, var(--card), rgba(37,99,235,0.03));
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            border-left: 5px solid var(--secondary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: all 0.3s;
        }
        .insight-card:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .insight-card h4 {
            color: var(--secondary);
            font-size: 1.3rem;
            margin: 0 0 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .insight-card h4 i {
            font-size: 1.5rem;
        }
        .insight-card p {
            margin: 10px 0;
            line-height: 1.8;
        }
        .insight-card ol,
        .insight-card ul {
            padding-left: 20px;
            margin: 10px 0;
        }
        .insight-card li {
            margin-bottom: 10px;
        }
        .stat-highlight {
            display: inline-block;
            background: var(--accent);
            color: #333;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 700;
            margin: 0 4px;
        }
        .danger-box {
            background: linear-gradient(135deg, rgba(220,38,38,0.1), rgba(220,38,38,0.05));
            border-left: 5px solid var(--danger);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }
        .danger-box h4 {
            color: var(--danger);
            margin-top: 0;
        }
        .success-box {
            background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(16,185,129,0.05));
            border-left: 5px solid var(--success);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }
        .success-box h4 {
            color: var(--success);
            margin-top: 0;
        }

        /* Message Box */
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 16px 28px;
            border-radius: 8px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.25);
            z-index: 10000;
            font-weight: 600;
            color: white;
            opacity: 0;
            transition: all 0.4s;
            display: none;
        }
        .message-box.show {
            display: block;
            opacity: 1;
            top: 30px;
        }

        /* Footer */
        footer {
            background: var(--grad-dark);
            color: #CBD5E1;
            padding: 50px 0 20px 0;
            margin-top: 60px;
        }
        .footer-content {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 40px;
            margin-bottom: 30px;
        }
        .footer-col {
            flex: 1;
            min-width: 200px;
        }
        .footer-col h4 {
            color: white;
            margin-bottom: 15px;
            font-weight: 700;
        }
        .footer-col ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .footer-col a {
            color: #CBD5E1;
            text-decoration: none;
            transition: color 0.3s;
        }
        .footer-col a:hover {
            color: var(--accent);
        }
        .social-buttons {
            display: flex;
            gap: 12px;
            margin-top: 15px;
        }
        .social-btn {
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            border-radius: 50%;
            font-size: 1.1rem;
            transition: transform 0.3s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .social-btn:hover {
            transform: translateY(-4px);
        }
        .social-btn.linkedin { background-color: #0A66C2; }
        .social-btn.youtube { background-color: #FF0000; }
        .social-btn.twitter { background-color: #1DA1F2; }
        .social-btn.facebook { background-color: #1877F2; }
        .social-btn.whatsapp { background-color: #25D366; }
        .footer-disclaimer {
            text-align: center;
            padding-top: 25px;
            border-top: 1px solid #334155;
            max-width: 800px;
            margin: 0 auto;
            font-size: 0.9rem;
        }
        .footer-bottom {
            text-align: center;
            padding-top: 20px;
            font-size: 0.9rem;
            color: #94A3B8;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container { padding: 0 15px; }
            .navbar { flex-direction: column; gap: 20px; }
            .nav-links { flex-direction: column; gap: 12px; text-align: center; }
            .form-row { grid-template-columns: 1fr; }
            .card { padding: 20px; }
            .footer-content { flex-direction: column; gap: 25px; }
            .btn-group { flex-direction: column; }
        }
        .hidden { display: none; }
        
        /* Tooltip */
        .info-icon {
            color: var(--primary);
            margin-left: 5px;
            cursor: help;
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 250px; /* Adjusted width */
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px; /* Increased padding */
            position: absolute;
            z-index: 10;
            bottom: 125%;
            left: 50%;
            margin-left: -125px; /* Half of width */
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            transform: translateY(10px);
            font-family: 'Inter', sans-serif; /* Professional font */
            font-size: 0.85rem; /* Slightly smaller font size */
            line-height: 1.4; /* Better readability */
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
            transform: translateY(0);
        }

        /* ----- From Old File: Specific DP Flow Styles ----- */
        
        /* Status Display (for Power Supply) */
        .status-display {
            font-weight: bold;
            font-size: 1.1em;
            margin-top: 15px;
            padding: 10px 20px;
            border-radius: 5px;
            transition: background-color 0.5s, color 0.5s;
            text-align: center;
            width: 100%;
        }
        .status-display.optimal {
            background-color: var(--success);
            color: white;
        }
        .status-display.adequate {
            background-color: #34D399; /* Lighter green */
            color: white;
        }
        .status-display.warning {
            background-color: var(--warning);
            color: #333;
        }
        .status-display.critical {
            background-color: var(--danger);
            color: white;
        }

        /* Loading Overlay */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            color: white;
            font-size: 1.5em;
            flex-direction: column;
            gap: 20px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        #loading-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid var(--primary);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* User ID Display */
        #user-id-display {
            text-align: center;
            margin-top: 10px;
            font-size: 0.85em;
            color: var(--text);
            padding: 8px;
            background-color: var(--bg);
            border: 1px solid var(--border);
            border-radius: 5px;
            word-break: break-all; /* Ensure long IDs wrap */
        }
    </style>
</head>
<body class="math-content" oncontextmenu="return false;">
    <div id="message-box" class="message-box"></div>
    <div id="loading-overlay">
        <div class="spinner"></div>
        <p>Loading...</p>
    </div>

    <header>
        <div class="container">
            <nav class="navbar">
                <a href="index.html" class="logo-container">
                    <span class="logo-text">Design Calculators</span>
                    <p class="logo-subtitle">Inspired by standards such as IEC, IEEE, ISA, ASME, and API.</p>
                </a>
                <ul class="nav-links">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="articles">Articles</a></li>
                    <li><a href="indexmech">Mechanical</a></li>
                    <li><a href="indexele">Electrical</a></li>
                    <li><a href="indexinst">Instrumentation</a></li>
                </ul>
                <div class="theme-toggle">
                    <i class="fas fa-sun"></i>
                    <label class="switch">
                        <input type="checkbox" id="theme-switch">
                        <span class="slider"></span>
                    </label>
                    <i class="fas fa-moon"></i>
                </div>
            </nav>
        </div>
    </header>

    <main class="container">
                
        <div class="tool-container">
            <h2><i class="fas fa-tachometer-alt"></i> Differential Pressure to Flow Conversion</h2>
                        
            <div class="tool-description">
                <p>This calculator determines volumetric and mass flow rates based on differential pressure measurements across various primary flow elements. It considers fluid properties and common industrial units, adhering to foundational principles from standards like <strong>ISO 5167</strong>.</p>
            </div>
                    
            <div class="calculator-form">
                <form id="dp-flow-calculator-form">
                    <!-- Process Parameters -->
                    <div class="form-section">
                        <h3>Process & Device Parameters</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="dp-value">Differential Pressure ($\Delta P$) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The measured differential pressure across the primary element.</span></span></label>
                                <input type="number" id="dp-value" step="any" value="100" required>
                                <select id="dp-unit">
                                    <option value="Pa">Pa</option>
                                    <option value="kPa">kPa</option>
                                    <option value="psi">psi</option>
                                    <option value="mmH2O">mmH2O (4°C)</option>
                                    <option value="mmHg">mmHg (0°C)</option>
                                    <option value="mbar">mbar</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="pipe-id">Pipe Internal Diameter ($D$) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The internal diameter of the pipe where the primary element is installed.</span></span></label>
                                <input type="number" id="pipe-id" step="any" value="100" required>
                                <select id="pipe-id-unit">
                                    <option value="mm">mm</option>
                                    <option value="inch">inch</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="primary-element">Primary Element Type <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The type of differential pressure flow element used.</span></span></label>
                                <select id="primary-element">
                                    <option value="Orifice Plate">Orifice Plate</option>
                                    <option value="Venturi Tube">Venturi Tube</option>
                                    <option value="Flow Nozzle">Flow Nozzle</option>
                                    <option value="Pitot Tube">Pitot Tube</option>
                                </select>
                            </div>
                            <div class="form-group" id="throat-diameter-group">
                                <label for="throat-diameter">Orifice/Throat Diameter ($d$) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The diameter of the orifice bore, Venturi throat, or nozzle throat.</span></span></label>
                                <input type="number" id="throat-diameter" step="any" value="50" required>
                                <select id="throat-diameter-unit">
                                    <option value="mm">mm</option>
                                    <option value="inch">inch</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Fluid Properties -->
                    <div class="form-section">
                        <h3>Fluid Properties</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="fluid-type">Fluid Type <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Select the type of fluid being measured.</span></span></label>
                                <select id="fluid-type">
                                    <option value="Liquid">Liquid</option>
                                    <option value="Gas">Gas</option>
                                    <option value="Saturated Steam">Saturated Steam</option>
                                    <option value="Superheated Steam">Superheated Steam</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="fluid-temperature">Fluid Temperature ($T$) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Operating temperature of the fluid.</span></span></label>
                                <input type="number" id="fluid-temperature" step="any" value="25" required>
                                <select id="fluid-temperature-unit">
                                    <option value="C">°C</option>
                                    <option value="F">°F</option>
                                </select>
                            </div>
                            <div class="form-group" id="fluid-pressure-group">
                                <label for="fluid-pressure">Fluid Pressure ($P_1$) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Operating static pressure of the fluid upstream of the primary element. Required for compressible fluids.</span></span></label>
                                <input type="number" id="fluid-pressure" step="any" value="1" required>
                                <select id="fluid-pressure-unit">
                                    <option value="bar">bar</option>
                                    <option value="kPa">kPa</option>
                                    <option value="psi">psi</option>
                                    <option value="atm">atm</option>
                                </select>
                            </div>
                            <div class="form-group" id="fluid-density-group">
                                <label for="fluid-density">Fluid Density ($\rho$) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Density of the fluid at operating conditions. Required for liquids.</span></span></label>
                                <input type="number" id="fluid-density" step="any" value="1000" required>
                                <select id="fluid-density-unit">
                                    <option value="kg/m3">kg/m³</option>
                                    <option value="lb/ft3">lb/ft³</option>
                                </select>
                            </div>
                            <div class="form-group" id="fluid-sg-group" style="display: none;">
                                <label for="fluid-sg">Fluid Specific Gravity (SG) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Specific gravity of the liquid relative to water at 4°C (density 1000 kg/m³). Alternative to density input.</span></span></label>
                                <input type="number" id="fluid-sg" step="any" value="1" min="0.001">
                            </div>
                            <div class="form-group">
                                <label for="fluid-viscosity">Fluid Dynamic Viscosity ($\mu$) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Dynamic viscosity of the fluid at operating conditions. Used for Reynolds number.</span></span></label>
                                <input type="number" id="fluid-viscosity" step="any" value="0.001" required>
                                <select id="fluid-viscosity-unit">
                                    <option value="Pa.s">Pa·s</option>
                                    <option value="cP">cP</option>
                                </select>
                            </div>
                            <div class="form-group" id="specific-heat-ratio-group">
                                <label for="specific-heat-ratio">Specific Heat Ratio ($\kappa$) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Ratio of specific heats (Cp/Cv) for compressible fluids (e.g., 1.4 for air).</span></span></label>
                                <input type="number" id="specific-heat-ratio" step="any" value="1.4" min="1" required>
                            </div>                        </div>
                    </div>
                    
                    <div class="btn-group" style="margin-top: 25px;">
                        <button type="button" id="calculate-btn" class="btn"><i class="fas fa-calculator"></i> Calculate Flow</button>
                        <button type="button" id="save-config-btn" class="btn secondary"><i class="fas fa-save"></i> Save Config</button>
                        <button type="button" id="load-config-btn" class="btn secondary"><i class="fas fa-folder-open"></i> Load Config</button>
                        <button type="button" id="reset-form-btn" class="btn accent"><i class="fas fa-sync-alt"></i> Reset Form</button>
                    </div>
                </form>
            </div>
            
            <div id="user-id-display"></div>
        </div>

        <!-- NEW Step-by-Step Results Container -->
        <div id="steps-container" class="steps-container math-content">
            <!-- Step cards will be dynamically inserted here -->
        </div>

        <!-- Updated Results Section -->
        <div id="results-section" class="card hidden">
            <h3><i class="fas fa-clipboard-check"></i> Calculation Summary</h3>
            
            <p class="status-display" id="flow-status-display">Flow Status: N/A</p>

            <table class="results-table">
                <thead>
                    <tr>
                        <th>Parameter</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody id="result-table-body">
                    <!-- Results will be dynamically inserted here -->
                </tbody>
            </table>

            <div id="practical-recommendations" style="display: none;">
                <h4><i class="fas fa-tools"></i> Practical Considerations & Recommendations</h4>
                <ul id="recommendations-list">
                    <!-- Recommendations will be dynamically inserted here -->
                </ul>
            </div>

            <div class="btn-group" style="justify-content: center; margin-top: 20px;">
                <button type="button" id="clear-results-btn" class="btn accent"><i class="fas fa-times-circle"></i> Clear Results</button>
            </div>

            <div class="insight-card" id="standard-reference" style="margin-top: 30px;">
                 <h4><i class="fas fa-book"></i> Applicable Standards and Guidelines</h4>
                 <p>Flow measurement using differential pressure devices is governed by international standards to ensure accuracy and repeatability. Key standards and considerations include:</p>                    
                 <ul>                        
                    <li><strong>ISO 5167: Measurement of fluid flow by means of pressure differential devices inserted in circular cross-section conduits running full.</strong> This is the primary standard for orifice plates, nozzles, and Venturi tubes. It defines geometry, installation requirements, and calculation methods for discharge coefficients and expansion factors.</li>
                    <li><strong>ASME MFC-3M: Measurement of Fluid Flow in Pipes Using Orifice, Nozzle, and Venturi.</strong> An American standard similar to ISO 5167.</li>                        
                    <li><strong>API 14.3 / AGA Report No. 3: Orifice Metering of Natural Gas and Other Related Hydrocarbon Fluids.</strong> Specific to natural gas flow measurement using orifice plates.</li>                        
                    <li><strong>Fluid Properties:</strong> Accurate fluid density, viscosity, and specific heat ratio at operating conditions are critical. These properties can vary significantly with temperature and pressure. For precise industrial applications, these properties are often obtained from fluid property databases or equations of state.</li>                        
                    <li><strong>Reynolds Number:</strong> Flow meters operate reliably within specific Reynolds number ranges. Laminar flow (low $Re$) and highly turbulent flow (very high $Re$) can affect accuracy.</li>                        
                    <li><strong>Beta Ratio ($\beta$):</strong> The ratio of the primary element's throat diameter to the pipe's internal diameter ($d/D$). It significantly influences the discharge coefficient and pressure recovery. Typical ranges are 0.2 to 0.75 for orifice plates.</li>                        
                    <li><strong>Discharge Coefficient ($C_d$):</strong> An empirical factor accounting for energy losses and flow contraction. It is determined through extensive experimental data and often depends on the Reynolds number and Beta ratio. For this calculator, simplified empirical values are used; for high accuracy, refer to ISO 5167's iterative methods.</li>
                    <li><strong>Expansion Factor ($Y$):</strong> Accounts for the change in density of compressible fluids as they expand through the primary element. It is a function of the pressure ratio across the element and the specific heat ratio of the fluid.</li>                    
                </ul>
            </div>
        </div>

        <!-- NEW Educational Section on DP Flow -->
        <div id="education-section" class="education-section card">
            <h2><i class="fas fa-water"></i> The Physics of DP Flow: Bernoulli's & The Square Root Problem</h2>
            
            <div class="tool-description">
                <p>Differential Pressure (DP) flow measurement is the most common flow sensing technology in the world. It's based on a simple, brilliant 18th-century principle from Daniel Bernoulli: <strong>as a fluid's speed increases, its pressure decreases.</strong></p>
                <p>A primary element (like an orifice plate) is just a carefully engineered "squeeze" in the pipe. It forces the fluid to accelerate to pass through the restriction. This acceleration causes a measurable pressure drop ($\Delta P$) between the upstream tap ($P_1$) and the downstream tap ($P_2$). This $\Delta P$ is the key to measuring flow.</p>
                
            </div>

            <div class="danger-box">
                <h4><i class="fas fa-exclamation-triangle"></i> The #1 Concept: The Square Root Problem</h4>
                <p>The relationship between flow and differential pressure is not linear. It is a <strong>square root relationship</strong>, based on Bernoulli's equation:</p>
                <p style="text-align: center; font-size: 1.2rem; font-weight: bold;">$Flow \propto \sqrt{\Delta P}$</p>
                <p>This single fact is the most important (and most problematic) aspect of DP flow measurement. It means:</p>
                <ul>
                    <li>To <strong>double</strong> your flow, you must generate <strong>four times</strong> the $\Delta P$.</li>
                    <li>To <strong>halve</strong> your flow, the $\Delta P$ drops to only <strong>one-quarter</strong>.</li>
                </ul>
                <p><strong>This creates the "Turndown Problem":</strong> A <strong>10:1</strong> turndown in flow (e.g., from 100% to 10% flow) requires a <strong>100:1</strong> turndown in pressure! (Since $10^2 = 100$). A DP transmitter calibrated for 0-100 inches of $\Delta P$ must accurately read 1 inch at 10% flow. This tiny signal is often lost in the "noise" of the process, making DP flow notoriously inaccurate at low flow rates.</p>
            </div>

            <div class="insight-card">
                <h4><i class="fas fa-cogs"></i> The "Flow Family": Orifice, Venturi, Nozzle</h4>
                <p>All DP elements create a restriction, but they do it in different ways, leading to tradeoffs in cost, accuracy, and energy efficiency.</p>
                <ul>
                    <li><strong>Orifice Plate:</strong>
                        <br><strong>What it is:</strong> A simple plate with a precision-bored hole in it.
                        <br><strong>Pros:</strong> Extremely cheap, easy to install, and well-understood (ISO 5167).
                        <br><strong>Cons:</strong> A "sharp-edged" orifice is an abrupt, inefficient restriction. It creates massive turbulence, resulting in significant, *permanent* pressure loss (PPL) downstream. This PPL is wasted energy that your pump must overcome 24/7.
                    </li>
                    <li><strong>Venturi Tube:</strong>
                        <br><strong>What it is:</strong> A large, custom-fabricated tube with a long, smooth converging cone and a very long, gentle diverging "pressure recovery" cone.
                        <br><strong>Pros:</strong> Extremely efficient. The smooth cones guide the flow with minimal turbulence, allowing it to recover up to 98% of its original pressure. This saves enormous amounts of energy.
                        <br><strong>Cons:</strong> Very large and extremely expensive.
                    </li>
                    <li><strong>Flow Nozzle:</strong>
                        <br><strong>What it is:</strong> A hybrid. It has a smooth, rounded inlet like a Venturi but no recovery cone (it dumps into the pipe like an orifice).
                        <br><strong>Pros:</strong> More efficient and less permanent pressure loss than an orifice. Its rigid design is excellent for high-velocity, high-temperature, or erosive fluids (like steam).
                        <br><strong>Cons:</strong> More expensive than an orifice, less efficient than a Venturi.
                    </li>
                </ul>
            </div>

            <div class="success-box">
                <h4><i class="fas fa-check-circle"></i> Key Parameters in This Calculator</h4>
                <p>To get an accurate flow rate, you can't just use $\sqrt{\Delta P}$. You must correct for the real-world physics using these key factors from ISO 5167:</p>
                <ul>
                    <li><strong>Beta Ratio ($\beta = d/D$):</strong> The ratio of the hole (throat) diameter $d$ to the pipe diameter $D$. A small $\beta$ (e.g., 0.2) means a tiny hole, which creates a high $\Delta P$ and high pressure loss. A large $\beta$ (e.g., 0.7) is a big hole with a low $\Delta P$.</li>
                    
                    <li><strong>Discharge Coefficient ($C_d$):</strong> The "fudge factor" for efficiency. A perfect, frictionless element would have $C_d = 1.0$. In reality, friction and turbulence mean the *actual* flow is less than the *theoretical* flow. A typical orifice $C_d$ is ~0.61 (meaning it's 61% efficient), while a Venturi $C_d$ is ~0.985 (98.5% efficient). This value is critical and is determined experimentally.</li>

                    <li><strong>Expansion Factor ($Y$):</strong> This is for <strong>gases and steam only</strong>. As the gas passes through the orifice, its pressure drops, causing it to *expand* (density decreases). This expansion means the gas speeds up *even more* than a liquid would. The $Y$ factor (a value slightly less than 1.0) corrects for this extra acceleration, ensuring the flow rate isn't overestimated. It is not needed for liquids, as they are non-compressible ($Y=1.0$).</li>
                    
                    <li><strong>Reynolds Number ($Re$):</strong> This dimensionless number describes the flow regime.
                        <br><strong>Laminar ($Re < 4000$):</strong> Flow is smooth and "syrupy." DP meters are *not* accurate here.
                        <br><strong>Turbulent ($Re > 20000$):</strong> Flow is chaotic and well-mixed. This is the <strong>ideal state</strong> for a DP meter, as the $C_d$ becomes stable and predictable.
                        <br>This calculator determines the $Re$ to help you validate that your measurement is in the reliable turbulent regime.</li>
                </ul>
            </div>
        </div>

    </main>

    <!-- FOOTER -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-col">
                    <h4>Design Calculators</h4>
                    <p style="font-size: 0.9rem; line-height: 1.6; margin-bottom: 15px;">If you find this tool helpful, please consider sharing it with your colleagues!</p>
                    <div class="social-buttons">
                        <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn linkedin" title="LinkedIn"><i class="fab fa-linkedin-in"></i></a>
                        <a href="https://www.youtube.com/@designcalculators" target="_blank" rel="noopener noreferrer" class="social-btn youtube" title="YouTube"><i class="fab fa-youtube"></i></a>
                        <a href="https://twitter.com/intent/tweet?url=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn twitter" title="Twitter"><i class="fab fa-twitter"></i></a>
                        <a href="https://www.facebook.com/sharer/sharer.php?u=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn facebook" title="Facebook"><i class="fab fa-facebook-f"></i></a>
                        <a href="https://api.whatsapp.com/send?text=Check%20out%20this%20amazing%20engineering%20resource%20https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn whatsapp" title="WhatsApp"><i class="fab fa-whatsapp"></i></a>
                    </div>
                </div>
                <div class="footer-col">
                    <h4>Quick Links</h4>
                    <ul>
                        <li><a href="index.html">Home</a></li>
                        <li><a href="indexele">Electrical</a></li>
                        <li><a href="indexmech">Mechanical</a></li>
                        <li><a href="indexinst">Instrumentation</a></li>                        
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>Resources</h4>
                    <ul>
                        <li><a href="about">About Us</a></li>
                        <li><a href="contact">Contact</a></li>
                        <li><a href="faq">FAQ</a></li>
                        <li><a href="privacy-policy">Privacy Policy</a></li>
                        <li><a href="terms-of-service">Terms of Service</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>More</h4>
                    <ul>
                        <li><a href="articles.html">Articles & Whitepapers</a></li>
                        <li><a href="sitemap2.html">Sitemap</a></li>                        
                    </ul>
                </div>
            </div>
            <div class="footer-disclaimer">
                <p>This tool offers general guidance. Results should be reviewed for accuracy and compliance with relevant project standards and regulations before use.</p>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Design Calculators. Created by <span style="color: var(--secondary); font-weight: bold;">A Sharma</span>. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let db;
        let auth;
        let userId = 'anonymous'; // Default to anonymous
        
        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfigStr = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        document.addEventListener('DOMContentLoaded', async function() {
            // Initialize Firebase
            try {
                const firebaseConfig = JSON.parse(firebaseConfigStr);
                if (Object.keys(firebaseConfig).length > 0) {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    setLogLevel('Debug'); // Enable detailed logging

                    // Authenticate user
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                        
                        onAuthStateChanged(auth, (user) => {
                            if (user) {
                                userId = user.uid;
                                document.getElementById('user-id-display').textContent = `User ID: ${userId}`;
                                console.log("Firebase initialized and user authenticated:", userId);
                            } else {
                                userId = crypto.randomUUID();
                                document.getElementById('user-id-display').textContent = `User ID (Anonymous, no persistence): ${userId}`;
                                console.log("User signed out, using temporary ID.");
                            }
                        });

                    } catch (error) {
                        console.error("Firebase authentication failed:", error);
                        showCustomMessage("Failed to authenticate. Save/Load features may not work.", 'error');
                        userId = crypto.randomUUID(); // Fallback
                        document.getElementById('user-id-display').textContent = `User ID (Auth Error): ${userId}`;
                    }
                } else {
                    console.warn("Firebase config not found. Save/Load features will be disabled.");
                    showCustomMessage("Firebase is not configured. Save/Load are disabled.", 'warning');
                    document.getElementById('user-id-display').textContent = `User ID (Firebase Disabled): ${userId}`;
                }
            } catch (e) {
                console.error("Failed to parse Firebase config:", e);
                showCustomMessage("Error loading Firebase config. Save/Load disabled.", "error");
            }

            // Input elements
            const dpValueInput = document.getElementById('dp-value');
            const dpUnitSelect = document.getElementById('dp-unit');
            const pipeIdInput = document.getElementById('pipe-id');
            const pipeIdUnitSelect = document.getElementById('pipe-id-unit');
            const primaryElementSelect = document.getElementById('primary-element');
            const throatDiameterGroup = document.getElementById('throat-diameter-group');
            const throatDiameterInput = document.getElementById('throat-diameter');
            const throatDiameterUnitSelect = document.getElementById('throat-diameter-unit');
            const fluidTypeSelect = document.getElementById('fluid-type');
            const fluidTemperatureInput = document.getElementById('fluid-temperature');
            const fluidTemperatureUnitSelect = document.getElementById('fluid-temperature-unit');
            const fluidPressureGroup = document.getElementById('fluid-pressure-group');
            const fluidPressureInput = document.getElementById('fluid-pressure');
            const fluidPressureUnitSelect = document.getElementById('fluid-pressure-unit');
            const fluidDensityGroup = document.getElementById('fluid-density-group');
            const fluidDensityInput = document.getElementById('fluid-density');
            const fluidDensityUnitSelect = document.getElementById('fluid-density-unit');
            const fluidSgGroup = document.getElementById('fluid-sg-group');
            const fluidSgInput = document.getElementById('fluid-sg');
            const fluidViscosityInput = document.getElementById('fluid-viscosity');
            const fluidViscosityUnitSelect = document.getElementById('fluid-viscosity-unit');
            const specificHeatRatioGroup = document.getElementById('specific-heat-ratio-group');
            const specificHeatRatioInput = document.getElementById('specific-heat-ratio');

            // Buttons and result containers
            const calculateBtn = document.getElementById('calculate-btn');
            const resetFormBtn = document.getElementById('reset-form-btn');
            const clearResultsBtn = document.getElementById('clear-results-btn');
            const saveConfigBtn = document.getElementById('save-config-btn');
            const loadConfigBtn = document.getElementById('load-config-btn');
            
            const resultsSection = document.getElementById('results-section');
            const stepsContainer = document.getElementById('steps-container');
            const resultTableBody = document.getElementById('result-table-body');
            const flowStatusDisplay = document.getElementById('flow-status-display');
            const practicalRecommendationsDiv = document.getElementById('practical-recommendations');
            const recommendationsList = document.getElementById('recommendations-list');
            const loadingOverlay = document.getElementById('loading-overlay');
            const themeSwitch = document.getElementById('theme-switch');

            // Default values for resetting form
            const defaultValues = {
                'dp-value': 100,
                'dp-unit': 'Pa',
                'pipe-id': 100,
                'pipe-id-unit': 'mm',
                'primary-element': 'Orifice Plate',
                'throat-diameter': 50,
                'throat-diameter-unit': 'mm',
                'fluid-type': 'Liquid',
                'fluid-temperature': 25,
                'fluid-temperature-unit': 'C',
                'fluid-pressure': 1,
                'fluid-pressure-unit': 'bar',
                'fluid-density': 1000,
                'fluid-density-unit': 'kg/m3',
                'fluid-sg': 1,
                'fluid-viscosity': 0.001,
                'fluid-viscosity-unit': 'Pa.s',
                'specific-heat-ratio': 1.4
            };

            // Helper for unit conversions
            const unitConversions = {
                dp: {
                    'Pa': 1, 'kPa': 1000, 'psi': 6894.76, 'mmH2O': 9.80665, 'mmHg': 133.322, 'mbar': 100
                },
                length: {
                    'mm': 0.001, 'inch': 0.0254
                },
                pressure: {
                    'Pa': 1, 'kPa': 1000, 'bar': 100000, 'psi': 6894.76, 'atm': 101325
                },
                density: {
                    'kg/m3': 1, 'lb/ft3': 16.0185
                },
                viscosity: {
                    'Pa.s': 1, 'cP': 0.001
                },
                temperature: {
                    'C_to_K': (T_c) => T_c + 273.15,
                    'F_to_K': (T_f) => (T_f - 32) * 5/9 + 273.15,
                    'K_to_C': (T_k) => T_k - 273.15,
                    'K_to_F': (T_k) => (T_k - 273.15) * 9/5 + 32
                }
            };

            // --- Standard showMessage function ---
            function showMessage(msg, type = 'success') {
                let messageBox = document.getElementById('message-box');
                if (!messageBox) {
                    messageBox = document.createElement('div');
                    messageBox.id = 'custom-message-box';
                    document.body.appendChild(messageBox);
                }
                messageBox.textContent = msg;
                messageBox.className = 'message-box'; // Clear previous classes
                
                if (type === 'error') {
                    messageBox.style.backgroundColor = 'var(--danger)';
                    messageBox.style.color = 'white';
                } else if (type === 'warning') {
                     messageBox.style.backgroundColor = 'var(--warning)';
                     messageBox.style.color = '#333';
                } else {
                    messageBox.style.backgroundColor = 'var(--success)';
                    messageBox.style.color = 'white';
                }
                messageBox.classList.add('show');
                setTimeout(() => messageBox.classList.remove('show'), 4000);
            }

            // Function to show/hide loading overlay
            function showLoading(message = "Loading...") {
                loadingOverlay.querySelector('p').textContent = message;
                loadingOverlay.classList.add('show');
            }
            function hideLoading() {
                loadingOverlay.classList.remove('show');
            }

            // --- Helper: Add row to summary table ---
            function addResultRow(parameter, value, statusClass = '') {
                const row = resultTableBody.insertRow();
                const paramCell = row.insertCell();
                const valueCell = row.insertCell();
                paramCell.innerHTML = parameter;
                valueCell.innerHTML = value;
                if (statusClass) {
                    valueCell.classList.add(statusClass);
                }
            }

            // --- Helper: Clear all results ---
            function clearResults() {
                resultsSection.classList.add('hidden');
                stepsContainer.innerHTML = '';
                stepsContainer.classList.remove('active');
                resultTableBody.innerHTML = '';
                flowStatusDisplay.textContent = 'Flow Status: N/A';
                flowStatusDisplay.className = 'status-display';
                practicalRecommendationsDiv.style.display = 'none';
                recommendationsList.innerHTML = '';
                
                showMessage("Results cleared.", "success");
            }

            // --- Helper: Reset form ---
            function resetForm() {
                for (const key in defaultValues) {
                    const input = document.getElementById(key);
                    if (input) {
                        input.value = defaultValues[key];
                    }
                }
                toggleFluidInputs(); // Reset visibility
                clearResults();
                showMessage("Form reset to default values.", "success");
            }

            // Function to toggle visibility of fluid property inputs
            function toggleFluidInputs() {
                const fluidType = fluidTypeSelect.value;
                if (fluidType === 'Liquid') {
                    fluidPressureGroup.style.display = 'none';
                    specificHeatRatioGroup.style.display = 'none';
                    fluidDensityGroup.style.display = 'block';
                    fluidSgGroup.style.display = 'block';
                    fluidDensityInput.setAttribute('required', 'required');
                    fluidPressureInput.removeAttribute('required');
                    specificHeatRatioInput.removeAttribute('required');
                } else { // Gas, Saturated Steam, Superheated Steam
                    fluidPressureGroup.style.display = 'block';
                    specificHeatRatioGroup.style.display = 'block';
                    fluidDensityGroup.style.display = 'none';
                    fluidSgGroup.style.display = 'none';
                    fluidPressureInput.setAttribute('required', 'required');
                    specificHeatRatioInput.setAttribute('required', 'required');
                    fluidDensityInput.removeAttribute('required');
                }
                
                if (primaryElementSelect.value === 'Pitot Tube') {
                    throatDiameterGroup.style.display = 'none';
                    throatDiameterInput.removeAttribute('required');
                } else {
                    throatDiameterGroup.style.display = 'block';
                    throatDiameterInput.setAttribute('required', 'required');
                }
            }
            // Event listeners for dynamic input visibility
            fluidTypeSelect.addEventListener('change', toggleFluidInputs);
            primaryElementSelect.addEventListener('change', toggleFluidInputs);
            
            // Initial call to set correct visibility
            toggleFluidInputs();

            // --- Main Calculation Function ---
            calculateBtn.addEventListener('click', function() {
                // Clear previous results
                resultsSection.classList.add('hidden');
                stepsContainer.innerHTML = '';
                stepsContainer.classList.remove('active');
                resultTableBody.innerHTML = '';
                
                let stepsHtml = '';
                let recommendations = [];
                let validationError = false;

                try {
                    // --- 1. Get All Inputs ---
                    let dp_raw = parseFloat(dpValueInput.value);
                    let dp_unit = dpUnitSelect.value;
                    let pipeId_raw = parseFloat(pipeIdInput.value);
                    let pipeId_unit = pipeIdUnitSelect.value;
                    let throatDiameter_raw = parseFloat(throatDiameterInput.value);
                    let throatDiameter_unit = throatDiameterUnitSelect.value;
                    let fluidTemperature_raw = parseFloat(fluidTemperatureInput.value);
                    let fluidTemperature_unit = fluidTemperatureUnitSelect.value;
                    let fluidPressure_raw = parseFloat(fluidPressureInput.value);
                    let fluidPressure_unit = fluidPressureUnitSelect.value;
                    let fluidDensity_raw = parseFloat(fluidDensityInput.value);
                    let fluidDensity_unit = fluidDensityUnitSelect.value;
                    let fluidSg = parseFloat(fluidSgInput.value);
                    let fluidViscosity_raw = parseFloat(fluidViscosityInput.value);
                    let fluidViscosity_unit = fluidViscosityUnitSelect.value;
                    let specificHeatRatio = parseFloat(specificHeatRatioInput.value);
                    
                    const primaryElement = primaryElementSelect.value;
                    const fluidType = fluidTypeSelect.value;

                    // --- 2. Input Validation ---
                    if (isNaN(dp_raw) || dp_raw < 0) throw new Error('Differential Pressure must be a non-negative number.');
                    if (isNaN(pipeId_raw) || pipeId_raw <= 0) throw new Error('Pipe Internal Diameter must be a positive number.');
                    if (primaryElement !== 'Pitot Tube' && (isNaN(throatDiameter_raw) || throatDiameter_raw <= 0)) {
                        throw new Error('Orifice/Throat Diameter must be a positive number for selected element.');
                    }
                    if (isNaN(fluidTemperature_raw)) throw new Error('Fluid Temperature must be a number.');
                    if (isNaN(fluidViscosity_raw) || fluidViscosity_raw <= 0) throw new Error('Fluid Dynamic Viscosity must be a positive number.');

                    let fluidDensity_kg_m3; // This will be our SI density
                    if (fluidType === 'Liquid') {
                        if (isNaN(fluidDensity_raw) || fluidDensity_raw <= 0) {
                            if (isNaN(fluidSg) || fluidSg <= 0) {
                                throw new Error('For liquid, either Fluid Density or Specific Gravity must be a positive number.');
                            } else {
                                fluidDensity_kg_m3 = fluidSg * 1000; // Convert SG to density
                                fluidDensity_raw = fluidDensity_kg_m3; // Update raw for display
                                fluidDensity_unit = 'kg/m3';
                            }
                        } else {
                            fluidDensity_kg_m3 = fluidDensity_raw * unitConversions.density[fluidDensity_unit];
                        }
                    } else { // Gas or Steam
                        if (isNaN(fluidPressure_raw) || fluidPressure_raw <= 0) throw new Error('Fluid Pressure must be a positive number for compressible fluids.');
                        if (isNaN(specificHeatRatio)) throw new Error('Specific Heat Ratio must be a positive number for compressible fluids.');
                    }
                    
                    // --- 3. Convert all inputs to SI units ---
                    const dp_pa = dp_raw * unitConversions.dp[dp_unit];
                    const pipeId_m = pipeId_raw * unitConversions.length[pipeId_unit];
                    let throatDiameter_m = 0;
                    if (primaryElement !== 'Pitot Tube') {
                        throatDiameter_m = throatDiameter_raw * unitConversions.length[throatDiameter_unit];
                        if (throatDiameter_m >= pipeId_m) {
                            throw new Error('Orifice/Throat Diameter must be less than Pipe Internal Diameter.');
                        }
                    }
                    const fluidTemperature_K = fluidTemperature_unit === 'C' ? unitConversions.temperature.C_to_K(fluidTemperature_raw) : unitConversions.temperature.F_to_K(fluidTemperature_raw);
                    const fluidViscosity_Pas = fluidViscosity_raw * unitConversions.viscosity[fluidViscosity_unit];
                    let fluidPressure_Pa = 0;
                    
                    // Step 1: Input Parameters Card
                    stepsHtml += `<div class="step-card">
                        <h4><span class="number">1</span>Input Parameters & SI Conversion</h4>
                        <div class="step-content">
                            <div class="step-explanation">
                                <p><strong>Device Parameters:</strong></p>
                                <p>$\Delta P = ${dp_raw} ${dp_unit} \rightarrow ${dp_pa.toFixed(2)} \text{ Pa}$</p>
                                <p>$D = ${pipeId_raw} ${pipeId_unit} \rightarrow ${pipeId_m.toFixed(4)} \text{ m}$</p>
                                ${primaryElement !== 'Pitot Tube' ? `<p>$d = ${throatDiameter_raw} ${throatDiameter_unit} \rightarrow ${throatDiameter_m.toFixed(4)} \text{ m}$</p>` : ''}
                            </div>
                            <div class="step-explanation">
                                <p><strong>Fluid Parameters:</strong></p>
                                <p>$T = ${fluidTemperature_raw} \text{°${fluidTemperature_unit}} \rightarrow ${fluidTemperature_K.toFixed(2)} \text{ K}$</p>
                                <p>$\mu = ${fluidViscosity_raw} ${fluidViscosity_unit} \rightarrow ${fluidViscosity_Pas.toExponential(3)} \text{ Pa·s}$</p>
                                ${fluidType !== 'Liquid' ? `<p>$P_1 = ${fluidPressure_raw} ${fluidPressure_unit} \rightarrow ${fluidPressure_Pa = fluidPressure_raw * unitConversions.pressure[fluidPressure_unit], fluidPressure_Pa.toExponential(3)} \text{ Pa}$</p>` : ''}
                                ${fluidType !== 'Liquid' ? `<p>$\kappa = ${specificHeatRatio.toFixed(2)}$</p>` : ''}
                            </div>
                        </div>
                    </div>`;

                    // --- 4. Calculate Derived Properties (Density, Beta, etc.) ---
                    const pipeArea_m2 = Math.PI * Math.pow(pipeId_m / 2, 2);
                    let throatArea_m2 = 0;
                    let betaRatio = 0;

                    if (primaryElement !== 'Pitot Tube') {
                        throatArea_m2 = Math.PI * Math.pow(throatDiameter_m / 2, 2);
                        betaRatio = throatDiameter_m / pipeId_m;
                    }
                    
                    // Calculate Density for Gas/Steam
                    if (fluidType !== 'Liquid') {
                        if (fluidType === 'Gas') {
                            const M_air = 0.02897; // kg/mol (approx molar mass of air)
                            const R_ideal = 8.314; // J/(mol·K)
                            fluidDensity_kg_m3 = (fluidPressure_Pa * M_air) / (R_ideal * fluidTemperature_K);
                        } else { // Steam
                            fluidDensity_kg_m3 = 0.59; // Placeholder
                            showMessage("For Steam, accurate density values from steam tables are crucial. This calculator uses a simplified placeholder.", 'warning');
                        }
                    }

                    // Step 2: Geometric & Fluid Properties Card
                    stepsHtml += `<div class="step-card math-content">
                        <h4><span class="number">2</span>Derived Properties</h4>
                        <div class="step-content">
                            <div class="step-explanation">
                                <p><strong>Geometric Properties:</strong></p>
                                <p class="formula">$$A_{pipe} = \pi (D/2)^2 = ${pipeArea_m2.toExponential(4)} \text{ m}^2$$</p>
                                ${primaryElement !== 'Pitot Tube' ? `<p class="formula">$$A_{throat} = \pi (d/2)^2 = ${throatArea_m2.toExponential(4)} \text{ m}^2$$</p>
                                <p class="formula">$$\beta = d / D = ${betaRatio.toFixed(4)}$$</p>` : '<p>$\beta$ is not applicable for Pitot Tube.</p>'}
                            </div>
                            <div class="step-explanation">
                                <p><strong>Fluid Density ($\rho$):</strong></p>
                                ${fluidType === 'Liquid' ? `<p>User-provided (or from SG):<br><strong>$\rho = ${fluidDensity_kg_m3.toFixed(4)} \text{ kg/m}^3$</strong></p>` : ''}
                                ${fluidType === 'Gas' ? `<p>Calculated via Ideal Gas Law (approx.):<br>$\rho = (P_1 M) / (R T)$</p><p><strong>$\rho = ${fluidDensity_kg_m3.toFixed(4)} \text{ kg/m}^3$</strong></p>` : ''}
                                ${fluidType.includes('Steam') ? `<p>Using simplified placeholder:<br><strong>$\rho \approx ${fluidDensity_kg_m3.toFixed(4)} \text{ kg/m}^3$</strong><br>(Use steam tables for accuracy)</p>` : ''}
                            </div>
                        </div>
                    </div>`;

                    // --- 5. Determine $C_d$ and $Y$ ---
                    let dischargeCoefficient = 0;
                    let expansionFactor = 1; // Default for liquids
                    let cd_step = '';
                    let y_step = '';

                    switch (primaryElement) {
                        case 'Orifice Plate':
                            dischargeCoefficient = 0.61;
                            cd_step = `<p>Using a common approximation for Orifice Plates (ISO 5167 recommends an iterative formula based on $Re$ and $\beta$).</p><p><strong>$C_d \approx 0.61$</strong></p>`;
                            break;
                        case 'Venturi Tube':
                            dischargeCoefficient = 0.985;
                            cd_step = `<p>Using a typical value for Venturi Tubes, which have high efficiency and pressure recovery.</p><p><strong>$C_d \approx 0.985$</strong></p>`;
                            break;
                        case 'Flow Nozzle':
                            dischargeCoefficient = 0.99;
                            cd_step = `<p>Using a typical value for Flow Nozzles, which are good for high-velocity flows.</p><p><strong>$C_d \approx 0.99$</strong></p>`;
                            break;
                        case 'Pitot Tube':
                            dischargeCoefficient = 0.995;
                            cd_step = `<p>Using a typical value for Pitot Tubes, which measure local velocity.</p><p><strong>$C_d \approx 0.995$</strong></p>`;
                            break;
                    }

                    if (fluidType !== 'Liquid') {
                        if (fluidPressure_Pa <= dp_pa) throw new Error('Upstream pressure must be greater than differential pressure.');
                        expansionFactor = 1 - (0.41 + 0.35 * Math.pow(betaRatio, 4)) * (dp_pa / (specificHeatRatio * fluidPressure_Pa));
                        if (expansionFactor < 0.5 || expansionFactor > 1) {
                            showMessage('Calculated Expansion Factor (Y) is outside typical range (0.5-1.0). Check inputs.', 'warning');
                        }
                        y_step = `<p>For compressible fluid, using simplified ISO 5167 formula:</p>
                                  <p class="formula">$$Y = 1 - (0.41 + 0.35\beta^4) \times \frac{\Delta P}{\kappa P_1}$$</p>
                                  <p class="formula">$Y = 1 - (0.41 + 0.35 \times ${betaRatio.toFixed(4)}^4) \times \frac{${dp_pa.toFixed(2)}}{${specificHeatRatio.toFixed(2)} \times ${fluidPressure_Pa.toExponential(3)}}$</p>
                                  <p><strong>$Y = ${expansionFactor.toFixed(4)}$</strong></p>`;
                    } else {
                        y_step = `<p>For incompressible liquids, the Expansion Factor ($Y$) is <strong>1.0</strong>.</p>`;
                    }
                    
                    stepsHtml += `<div class="step-card math-content">
                        <h4><span class="number">3</span>Flow Coefficients ($C_d$ and $Y$)</h4>
                        <div class="step-content">
                            <div class="step-explanation">${cd_step}</div>
                            <div class="step-explanation">${y_step}</div>
                        </div>
                    </div>`;

                    // --- 6. Calculate Flow Rate ---
                    let massFlowRate_kg_s = 0;
                    let volumetricFlowRate_m3_s = 0;
                    
                    stepsHtml += `<div class="step-card math-content">
                        <h4><span class="number">4</span>Calculate Flow Rate</h4>`;

                    if (primaryElement === 'Pitot Tube') {
                        const velocity_m_s = dischargeCoefficient * Math.sqrt((2 * dp_pa) / fluidDensity_kg_m3);
                        volumetricFlowRate_m3_s = velocity_m_s * pipeArea_m2;
                        massFlowRate_kg_s = volumetricFlowRate_m3_s * fluidDensity_kg_m3;
                        
                        stepsHtml += `<div class="step-content">
                                        <div class="step-explanation">
                                            <p>For a Pitot Tube, we first find the local velocity ($v$) and assume it's the average flow velocity.</p>
                                            <p class="formula">$$v = C_d \times \sqrt{\frac{2 \Delta P}{\rho}}$$</p>
                                            <p class="formula">$v = ${dischargeCoefficient.toFixed(3)} \times \sqrt{\frac{2 \times ${dp_pa.toFixed(2)}}{${fluidDensity_kg_m3.toFixed(4)}}} = ${velocity_m_s.toFixed(4)} \text{ m/s}$</p>
                                            <p class="formula">$$Q = v \times A_{pipe}$$</p>
                                            <p class="formula">$Q = ${velocity_m_s.toFixed(4)} \times ${pipeArea_m2.toExponential(4)} = ${volumetricFlowRate_m3_s.toExponential(4)} \text{ m}^3\text{/s}$</p>
                                        </div>
                                        <div>
                                            <p><strong>Volumetric Flow (m³/hr):</strong></p>
                                            <div class="step-value">${(volumetricFlowRate_m3_s * 3600).toFixed(4)}<span class="step-unit">m³/hr</span></div>
                                            <p><strong>Mass Flow (kg/hr):</strong></p>
                                            <div class="step-value">${(massFlowRate_kg_s * 3600).toFixed(4)}<span class="step-unit">kg/hr</span></div>
                                        </div>
                                    </div>`;
                    } else {
                        massFlowRate_kg_s = (dischargeCoefficient * expansionFactor * throatArea_m2 * Math.sqrt((2 * dp_pa * fluidDensity_kg_m3) / (1 - Math.pow(betaRatio, 4))));
                        volumetricFlowRate_m3_s = massFlowRate_kg_s / fluidDensity_kg_m3;

                        stepsHtml += `<div class="step-content">
                                        <div class="step-explanation">
                                            <p>Using the full ISO 5167 mass flow equation:</p>
                                            <p class="formula">$$m = \frac{C_d Y A_{throat}}{\sqrt{1 - \beta^4}} \times \sqrt{2 \Delta P \rho_1}$$</p>
                                            <p class="formula" style="font-size: 0.8rem;">$m = \frac{${dischargeCoefficient.toFixed(3)} \times ${expansionFactor.toFixed(4)} \times ${throatArea_m2.toExponential(4)}}{\sqrt{1 - ${Math.pow(betaRatio, 4).toFixed(4)}}} \times \sqrt{2 \times ${dp_pa.toFixed(2)} \times ${fluidDensity_kg_m3.toFixed(4)}}$</p>
                                            <p class="formula">$m = ${massFlowRate_kg_s.toExponential(4)} \text{ kg/s}$</p>
                                        </div>
                                        <div>
                                            <p><strong>Volumetric Flow (m³/hr):</strong></p>
                                            <div class="step-value">${(volumetricFlowRate_m3_s * 3600).toFixed(4)}<span class="step-unit">m³/hr</span></div>
                                            <p><strong>Mass Flow (kg/hr):</strong></p>
                                            <div class="step-value">${(massFlowRate_kg_s * 3600).toFixed(4)}<span class="step-unit">kg/hr</span></div>
                                        </div>
                                    </div>`;
                    }
                    stepsHtml += `</div>`; // Close step-card

                    // --- 7. Calculate Reynolds Number & Final Status ---
                    let reynoldsNumber = 0;
                    if (fluidViscosity_Pas > 0) {
                        reynoldsNumber = (4 * massFlowRate_kg_s) / (Math.PI * pipeId_m * fluidViscosity_Pas);
                    }
                    
                    stepsHtml += `<div class="step-card math-content">
                        <h4><span class="number">5</span>Flow Regime (Reynolds Number)</h4>
                        <div class="step-content">
                            <div class="step-explanation">
                                <p>The Reynolds Number ($Re$) determines the flow regime (laminar, transitional, or turbulent). DP meters are most accurate in turbulent flow.</p>
                                <p class="formula">$$Re = \frac{4 m}{\pi D \mu}$$</p>
                                <p class="formula">$Re = \frac{4 \times ${massFlowRate_kg_s.toExponential(4)}}{\pi \times ${pipeId_m.toFixed(4)} \times ${fluidViscosity_Pas.toExponential(3)}}$</p>
                            </div>
                            <div>
                                <p><strong>Reynolds Number:</strong></p>
                                <div class="step-value">${reynoldsNumber.toExponential(2)}</div>
                            </div>
                        </div>
                    </div>`;

                    // --- 8. Populate Summary Table ---
                    addResultRow("<strong>Volumetric Flow Rate</strong>", `<strong>${(volumetricFlowRate_m3_s * 3600).toFixed(4)} m³/hr</strong>`, 'highlight');
                    addResultRow("<strong>Mass Flow Rate</strong>", `<strong>${(massFlowRate_kg_s * 3600).toFixed(4)} kg/hr</strong>`, 'highlight');
                    addResultRow("Reynolds Number ($Re$)", reynoldsNumber.toExponential(2));
                    addResultRow("Fluid Density ($\rho$)", `${fluidDensity_kg_m3.toFixed(4)} kg/m³`);
                    addResultRow("Beta Ratio ($\beta$)", betaRatio.toFixed(4));
                    addResultRow("Discharge Coefficient ($C_d$)", dischargeCoefficient.toFixed(4));
                    addResultRow("Expansion Factor ($Y$)", expansionFactor.toFixed(4));

                    // --- 9. Set Status & Recommendations ---
                    let statusText = 'Flow Status: ';
                    let statusClass = 'status-display ';
                    if (reynoldsNumber > 20000) {
                        statusClass += 'optimal';
                        statusText += 'Turbulent Flow (Optimal)';
                        recommendations.push("The calculated Reynolds number indicates fully turbulent flow, which is ideal for differential pressure flow measurement devices, ensuring stable and predictable performance.");
                    } else if (reynoldsNumber >= 4000 && reynoldsNumber <= 20000) {
                        statusClass += 'warning';
                        statusText += 'Transitional Flow (Caution)';
                        recommendations.push("The calculated Reynolds number falls within the transitional flow regime. Accuracy of differential pressure meters can be reduced in this range. Consider optimizing flow conditions or selecting a different flow meter technology if high accuracy is critical.");
                    } else {
                        statusClass += 'critical';
                        statusText += 'Laminar Flow (Not Suitable)';
                        recommendations.push("The calculated Reynolds number indicates laminar flow. Differential pressure flow meters are generally not suitable for laminar flow conditions, and accuracy will be severely compromised. Consider a different flow measurement principle (e.g., Coriolis, Positive Displacement).");
                    }
                    recommendations.push(`For ${primaryElement}, the used $C_d$ is an approximation. For high-accuracy or custody transfer, $C_d$ must be calculated iteratively per ISO 5167 based on $Re$ and $\beta$.`);

                    // --- 10. Show All Results ---
                    stepsContainer.innerHTML = stepsHtml;
                    stepsContainer.classList.add('active');
                    
                    recommendationsList.innerHTML = '';
                    recommendations.forEach(rec => {
                        const li = document.createElement('li');
                        li.innerHTML = rec;
                        recommendationsList.appendChild(li);
                    });
                    practicalRecommendationsDiv.style.display = 'block';

                    flowStatusDisplay.textContent = statusText;
                    flowStatusDisplay.className = statusClass;
                    
                    resultsSection.classList.remove('hidden');
                    
                    if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
                        setTimeout(() => {
                            window.MathJax.typesetPromise([stepsContainer, resultsSection]);
                        }, 50); 
                    }

                    setTimeout(() => {
                        stepsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 100);
                    
                    showMessage('Calculation successful!', 'success');

                } catch (error) {
                    showMessage('An error occurred: ' + error.message, 'error');
                    console.error('DP Flow Calculation Error:', error);
                }
            });

            // --- Firebase Save/Load Logic ---
            saveConfigBtn.addEventListener('click', async function() {
                if (!db || !auth || !userId || userId === 'anonymous') {
                    showMessage("Cannot save. Firebase is not configured or user is not authenticated.", 'error');
                    return;
                }
                showLoading("Saving configuration...");
                
                try {
                    const configData = {
                        'dp-value': dpValueInput.value,
                        'dp-unit': dpUnitSelect.value,
                        'pipe-id': pipeIdInput.value,
                        'pipe-id-unit': pipeIdUnitSelect.value,
                        'primary-element': primaryElementSelect.value,
                        'throat-diameter': throatDiameterInput.value,
                        'throat-diameter-unit': throatDiameterUnitSelect.value,
                        'fluid-type': fluidTypeSelect.value,
                        'fluid-temperature': fluidTemperatureInput.value,
                        'fluid-temperature-unit': fluidTemperatureUnitSelect.value,
                        'fluid-pressure': fluidPressureInput.value,
                        'fluid-pressure-unit': fluidPressureUnitSelect.value,
                        'fluid-density': fluidDensityInput.value,
                        'fluid-density-unit': fluidDensityUnitSelect.value,
                        'fluid-sg': fluidSgInput.value,
                        'fluid-viscosity': fluidViscosityInput.value,
                        'fluid-viscosity-unit': fluidViscosityUnitSelect.value,
                        'specific-heat-ratio': specificHeatRatioInput.value
                    };
                    
                    const configDocRef = doc(db, `artifacts/${appId}/users/${userId}/configs`, 'dpFlowCalculator');
                    await setDoc(configDocRef, configData);
                    showMessage('Configuration saved successfully!', 'success');
                } catch (error) {
                    console.error("Error saving configuration:", error);
                    showMessage('Failed to save configuration. Please try again.', 'error');
                } finally {
                    hideLoading();
                }
            });

            loadConfigBtn.addEventListener('click', async function() {
                if (!db || !auth || !userId || userId === 'anonymous') {
                    showMessage("Cannot load. Firebase is not configured or user is not authenticated.", 'error');
                    return;
                }
                showLoading("Loading configuration...");
                
                try {
                    const configDocRef = doc(db, `artifacts/${appId}/users/${userId}/configs`, 'dpFlowCalculator');
                    const docSnap = await getDoc(configDocRef);
                    
                    if (docSnap.exists()) {
                        const loadedConfig = docSnap.data();
                        
                        // Populate form fields
                        for (const key in loadedConfig) {
                            const element = document.getElementById(key);
                            if (element) {
                                element.value = loadedConfig[key];
                            }
                        }
                        
                        toggleFluidInputs(); // Adjust visibility
                        clearResults(); // Clear any old results
                        showMessage('Configuration loaded successfully!', 'success');
                    } else {
                        showMessage('No saved configuration found for this user.', 'info');
                    }
                } catch (error) {
                    console.error("Error loading configuration:", error);
                    showMessage('Failed to load configuration. Please try again.', 'error');
                } finally {
                    hideLoading();
                }
            });

            // --- Other Listeners ---
            resetFormBtn.addEventListener('click', resetForm);
            clearResultsBtn.addEventListener('click', clearResults);
            
            // --- Initial Page Load ---
            toggleFluidInputs(); // Set initial visibility

            // Initial fade-in for form sections
            const formSections = document.querySelectorAll('.form-section');
            formSections.forEach((section, index) => {
                setTimeout(() => {
                    section.classList.add('fade-in');
                }, 100 * index); // Staggered fade-in
            });

            // --- Theme switch logic ---
            if (themeSwitch) {
                if (localStorage.getItem('theme') === 'dark') {
                    document.body.classList.add('dark-mode');
                    themeSwitch.checked = true;
                }
                themeSwitch.addEventListener('change', function() {
                    if (this.checked) {
                        document.body.classList.add('dark-mode');
                        localStorage.setItem('theme', 'dark');
                    } else {
                        document.body.classList.remove('dark-mode');
                        localStorage.setItem('theme', 'light');
                    }
                });
            }
        });
    </script>
</body>
</html>
