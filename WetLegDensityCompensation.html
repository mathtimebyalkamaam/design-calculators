<!DOCTYPE html>
<html lang="en">
<head>
    <!-- AdSense & Analytics -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5936527763614780" crossorigin="anonymous"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-23Y1V450SR"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-23Y1V450SR');
    </script>
    
    <!-- SEO Meta Tags -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wet-Leg Density Compensation Calculator (Boiler Drum) - Industrial Grade</title>
    <meta name="description" content="Professional Wet-Leg Density Compensation Calculator for Boiler Drums. Calculate level errors caused by density shifts in process and reference legs. Built-in Steam Tables.">
    <meta name="keywords" content="wet leg calculator, boiler drum level, density compensation, steam tables, dp level error, hydrostatic head, saturation density, zero elevation, instrumentation">
    <meta name="author" content="Design Calculators">
    <meta name="robots" content="index, follow">

    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Montserrat:wght@700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>

    <!-- Chart.js for Visuals -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1/dist/chartjs-plugin-annotation.min.js"></script>

    <!-- MathJax for Formulas -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['\\(', '\\)'], ['$', '$']],
                displayMath: [['\\[', '\\]'], ['$$', '$$']]
            },
            svg: { fontCache: 'global' }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <!-- Favicon Links -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">

    <style>
        /* --- CORE THEME (Exact Blue Industrial Scheme) --- */
        :root {
            --primary: #1E3A8A; /* Dark Blue */
            --secondary: #2563EB; /* Bright Blue */
            --accent: #F59E0B; /* Amber */
            --success: #10B981;
            --danger: #DC2626;
            --warning: #F59E0B;
            --bg: #F8FAFC;
            --card: #FFFFFF;
            --text: #4B5563;
            --heading: #111827;
            --footer-bg: #0F172A;
            --border: #E2E8F0;
            --grad: linear-gradient(135deg, var(--primary), var(--secondary));
            --grad-dark: linear-gradient(135deg, #0F172A, #1E293B);
            --shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        body.dark-mode {
            --primary: #10B981;
            --secondary: #34D399;
            --bg: #0F172A;
            --card: #1E293B;
            --text: #CBD5E1;
            --heading: #F1F5F9;
            --footer-bg: #020617;
            --border: #334155;
            --accent: #F59E0B;
        }

        * { box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.7;
            margin: 0;
            padding: 0;
        }

        .container { max-width: 1280px; margin: 0 auto; padding: 0 24px; }

        /* Header & Nav */
        header {
            background: var(--grad);
            color: white;
            padding: 24px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo-container {
            display: flex;
            flex-direction: column;
            text-decoration: none;
            color: white;
        }
        .logo-text {
            font-size: 1.75rem;
            font-weight: 800;
            font-family: 'Montserrat', sans-serif;
        }
        .logo-subtitle {
            font-size: 0.8rem;
            margin: 4px 0 0 0;
            color: #E0E7FF;
            opacity: 0.9;
        }
        .nav-links {
            display: flex;
            gap: 24px;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        .nav-links a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }
        .nav-links a:hover { color: var(--accent); }
        
        /* Theme Toggle */
        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
            color: white;
        }
        .switch {
            position: relative;
            width: 56px;
            height: 30px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0,0,0,0.2);
            transition: .4s;
            border-radius: 30px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 22px; width: 22px;
            left: 4px; bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(26px); }

        /* Main Content & Cards */
        main { padding: 40px 0; }
        .card {
            background: var(--card);
            border-radius: 12px;
            padding: 30px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            border: 1px solid var(--border);
            animation: fadeIn 0.6s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .card h2 {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
            padding-bottom: 15px;
            margin-top: 0;
            font-family: 'Montserrat', sans-serif;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        h3 {
            color: var(--heading);
            font-family: 'Montserrat', sans-serif;
            font-size: 1.5rem;
            margin-top: 25px;
            margin-bottom: 20px;
        }

        /* Forms */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .form-group { margin-bottom: 0; }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--heading);
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 6px;
            background-color: var(--bg);
            color: var(--text);
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        .form-group input:focus, .form-group select:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
        }
        body.dark-mode .form-group input:focus { 
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        /* Buttons */
        .btn {
            background: var(--grad);
            color: white;
            border: none;
            padding: 16px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(30, 58, 138, 0.3);
            transition: all 0.3s;
            width: 100%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(30, 58, 138, 0.4);
        }
        .btn-outline {
            background: transparent;
            border: 2px solid var(--secondary);
            color: var(--secondary);
            font-size: 0.9rem;
            padding: 8px 16px;
        }
        .btn-outline:hover {
            background: var(--secondary);
            color: white;
        }
        .button-wrapper {
            display: flex;
            justify-content: center;
            width: 100%;
            padding-top: 15px;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        /* Quick Load Buttons */
        .preset-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        .preset-btn {
            padding: 8px 12px;
            font-size: 0.85rem;
            border: 1px solid var(--border);
            background: var(--card);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .preset-btn:hover {
            background: var(--bg);
            border-color: var(--secondary);
            color: var(--secondary);
        }

        /* Results Layout */
        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            align-items: start;
        }
        @media (max-width: 1024px) {
            .results-grid { grid-template-columns: 1fr; }
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-radius: 8px;
            overflow: hidden;
        }
        .results-table th, .results-table td {
            padding: 14px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        .results-table th {
            background: var(--grad);
            color: white;
            font-weight: 700;
        }
        .results-table tr:nth-child(even) { background-color: var(--bg); }
        .results-table td:first-child {
            font-weight: 600;
            color: var(--heading);
        }
        .highlight { color: var(--success); font-weight: 700; }
        .danger-text { color: var(--danger); font-weight: 700; }

        /* Canvas Container */
        .chart-container {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            position: relative;
            height: 400px;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        canvas {
            max-width: 100%;
            max-height: 100%;
        }

        /* Educational Section Styling */
        .insight-card {
            background: linear-gradient(135deg, var(--card), rgba(37,99,235,0.03));
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            border-left: 5px solid var(--secondary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: all 0.3s;
        }
        .insight-card:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .insight-card h4 {
            color: var(--secondary);
            font-size: 1.3rem;
            margin: 0 0 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: 'Montserrat', sans-serif;
        }
        .insight-card p, .insight-card ul {
            margin: 10px 0;
            line-height: 1.8;
            color: var(--text);
        }
        .insight-card ul { padding-left: 20px; }
        .insight-card li { margin-bottom: 8px; }

        /* Formulas & Steps */
        .formula {
            background: var(--bg);
            border-left: 3px solid var(--accent);
            padding: 15px;
            margin: 12px 0;
            font-size: 1.1rem;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
            color: var(--heading);
        }
        .calculation-step {
            font-family: 'Courier New', monospace;
            background-color: rgba(0,0,0,0.03);
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            border-left: 4px solid var(--success);
            font-size: 0.95rem;
            line-height: 1.6;
        }
        body.dark-mode .calculation-step { background-color: rgba(255,255,255,0.05); }

        /* Vector Input Group Styling (Reused) */
        .vector-input-group {
            background: var(--bg);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border);
            position: relative;
        }
        .vector-input-header {
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Print Styling */
        @media print {
            header, footer, .education-section, .theme-toggle, .button-wrapper, .preset-container { display: none !important; }
            .card { border: none; shadow: none; padding: 0; }
            .container { width: 100%; max-width: 100%; padding: 0; }
            .results-grid { grid-template-columns: 1fr 1fr; }
            .chart-container { height: 300px; page-break-inside: avoid; }
        }

        /* Message Box */
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 16px 28px;
            border-radius: 8px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.25);
            z-index: 10000;
            font-weight: 600;
            color: white;
            opacity: 0;
            transition: all 0.4s;
            display: none;
        }
        .message-box.show { display: block; opacity: 1; top: 30px; }
        .hidden { display: none; }

        /* Tooltip */
        .info-icon { color: var(--secondary); margin-left: 5px; cursor: help; }
        .tooltip { position: relative; display: inline-block; }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 220px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -110px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.85rem;
            font-weight: 400;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }

        /* Footer */
        footer {
            background: var(--grad-dark);
            color: #CBD5E1;
            padding: 50px 0 20px 0;
            margin-top: 60px;
        }
        .footer-content {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 40px;
            margin-bottom: 30px;
        }
        .footer-col { flex: 1; min-width: 200px; }
        .footer-col h4 { color: white; margin-bottom: 15px; font-weight: 700; }
        .footer-col ul { list-style: none; padding: 0; margin: 0; }
        .footer-col a { color: #CBD5E1; text-decoration: none; transition: color 0.3s; }
        .footer-col a:hover { color: var(--accent); }
        .social-buttons { display: flex; gap: 12px; margin-top: 15px; }
        .social-btn {
            width: 40px; height: 40px;
            display: flex; justify-content: center; align-items: center;
            color: white; border-radius: 50%;
            font-size: 1.1rem; transition: transform 0.3s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .social-btn:hover { transform: translateY(-4px); }
        .social-btn.linkedin { background-color: #0A66C2; }
        .social-btn.youtube { background-color: #FF0000; }
        .social-btn.twitter { background-color: #1DA1F2; }
        .social-btn.facebook { background-color: #1877F2; }
        .social-btn.whatsapp { background-color: #25D366; }
        .footer-disclaimer {
            text-align: center; padding-top: 25px;
            border-top: 1px solid #334155;
            max-width: 800px; margin: 0 auto;
            font-size: 0.9rem;
        }
        .footer-bottom {
            text-align: center; padding-top: 20px;
            font-size: 0.9rem; color: #94A3B8;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container { padding: 0 15px; }
            .navbar { flex-direction: column; gap: 20px; }
            .nav-links { flex-direction: column; gap: 12px; text-align: center; }
            .form-row { grid-template-columns: 1fr; }
            .card { padding: 20px; }
            .footer-content { flex-direction: column; gap: 25px; }
        }
    </style>
</head>
<body>
    <div id="message-box" class="message-box"></div>
    <header>
        <div class="container">
            <nav class="navbar">
                <a href="#" class="logo-container">
                    <span class="logo-text">Design Calculators</span>
                    <p class="logo-subtitle">Inspired by standards such as IEC, IEEE, ISA, ASME, and API.</p>
                </a>
                <ul class="nav-links">
                    <li><a href='/'>Home</a></li>
                    <li><a href="articles">Articles</a></li>
                    <li><a href="indexmech">Mechanical</a></li>
                    <li><a href="indexele">Electrical</a></li>
                    <li><a href="indexinst">Instrumentation</a></li>
                </ul>
                <div class="theme-toggle">
                    <i class="fas fa-sun"></i>
                    <label class="switch">
                        <input type="checkbox" id="theme-switch">
                        <span class="slider"></span>
                    </label>
                    <i class="fas fa-moon"></i>
                </div>
            </nav>
        </div>
    </header>

    <main class="container">
        <div class="card">
            <h2><i class="fas fa-thermometer-half"></i> Wet-Leg Density Compensation Calculator (Boiler Drum)</h2>
            
            <div class="tool-description">
                <p>This industrial-grade calculator accurately determines level measurement errors in <strong>Boiler Drums</strong> and pressurized vessels where significant density differences exist between the process liquid (Hot) and the wet leg reference (Cold). It uses built-in <strong>Steam Tables</strong> to calculate saturation densities and corrects for the vapor phase density effect at high pressures.</p>
            </div>

            <div class="calculator-form">
                <form id="wetleg-form">
                    <!-- Controls Row -->
                    <div class="form-row" style="align-items: end;">
                        <div class="form-group">
                            <label>Quick Load Scenarios:</label>
                            <div class="preset-container" style="margin-bottom: 0;">
                                <button type="button" class="preset-btn" onclick="loadPreset('low_press')"><i class="fas fa-industry"></i> Low Pressure Drum (10 bar)</button>
                                <button type="button" class="preset-btn" onclick="loadPreset('med_press')"><i class="fas fa-fire"></i> Med Pressure Drum (60 bar)</button>
                                <button type="button" class="preset-btn" onclick="loadPreset('high_press')"><i class="fas fa-bolt"></i> High Pressure Utility (160 bar)</button>
                            </div>
                        </div>
                    </div>

                    <!-- Calibration Data -->
                    <h4 style="color: var(--primary); margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 5px;">1. Calibration Data (Design Conditions)</h4>
                    <div class="form-row">
                        <div class="vector-input-group">
                            <div class="vector-input-header"><i class="fas fa-sliders-h"></i> Transmitter Config</div>
                            <div class="form-group">
                                <label for="cal-pressure">Calibrated Pressure [bar(g)]</label>
                                <input type="number" id="cal-pressure" value="60" step="1">
                            </div>
                            <div class="form-group" style="margin-top:10px;">
                                <label for="tap-distance">Tap Distance (H) [mm] <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Vertical distance between HP and LP taps.</span></span></label>
                                <input type="number" id="tap-distance" value="1000" step="10">
                            </div>
                        </div>
                        <div class="vector-input-group">
                            <div class="vector-input-header"><i class="fas fa-snowflake"></i> Reference Leg</div>
                            <div class="form-group">
                                <label for="cal-amb-temp">Calibration Ambient Temp [°C]</label>
                                <input type="number" id="cal-amb-temp" value="25" step="1">
                            </div>
                        </div>
                    </div>

                    <!-- Operating Conditions -->
                    <h4 style="color: var(--primary); margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 5px; margin-top: 20px;">2. Operating Conditions (Actual)</h4>
                    <div class="form-row">
                        <div class="vector-input-group">
                            <div class="vector-input-header"><i class="fas fa-tachometer-alt"></i> Process State</div>
                            <div class="form-group">
                                <label for="op-pressure">Operating Pressure [bar(g)]</label>
                                <input type="number" id="op-pressure" value="30" step="1">
                            </div>
                            <div class="form-group" style="margin-top:10px;">
                                <label for="op-amb-temp">Current Ambient Temp [°C] <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Temperature of the water in the wet leg. Usually ambient unless heat traced.</span></span></label>
                                <input type="number" id="op-amb-temp" value="35" step="1">
                            </div>
                        </div>
                        <div class="vector-input-group">
                            <div class="vector-input-header"><i class="fas fa-ruler-vertical"></i> Reading</div>
                            <div class="form-group">
                                <label for="current-dp">Current DP Reading [mmH2O]</label>
                                <input type="number" id="current-dp" value="-500" step="10">
                            </div>
                        </div>
                    </div>

                    <div class="button-wrapper">
                        <button type="button" id="calculate-btn" class="btn"><i class="fas fa-calculator"></i> Calculate Error</button>
                        <button type="button" id="pdf-btn" class="btn btn-outline"><i class="fas fa-file-pdf"></i> Download PDF Report</button>
                    </div>
                </form>
            </div>

            <!-- Results Section -->
            <div id="result-container" class="card hidden" style="margin-top: 40px;">
                <h3><i class="fas fa-poll"></i> Compensation Results</h3>
                
                <div class="results-grid">
                    <!-- Left Col: Table -->
                    <div>
                        <h4 style="margin-top: 0; color: var(--primary); margin-bottom: 15px;">Level & Error Analysis</h4>
                        <table class="results-table">
                            <thead>
                                <tr>
                                    <th>Parameter</th>
                                    <th>Value</th>
                                    <th>Unit</th>
                                </tr>
                            </thead>
                            <tbody id="result-table-body">
                                <!-- Dynamic rows -->
                            </tbody>
                        </table>
                        
                        <div style="margin-top: 20px; background: var(--bg); padding: 15px; border-radius: 6px; border: 1px solid var(--border);">
                            <strong><i class="fas fa-info-circle"></i> Status:</strong>
                            <div id="interpretation-text" style="margin-top: 5px; font-size: 0.95rem;"></div>
                        </div>
                    </div>

                    <!-- Right Col: Visual Chart -->
                    <div>
                        <h4 style="margin-top: 0; color: var(--primary); margin-bottom: 15px;">Boiler Drum Visualization</h4>
                        <div class="chart-container">
                            <canvas id="drumCanvas" width="400" height="350"></canvas>
                        </div>
                         <div style="text-align: center; margin-top: 10px; font-size: 0.85rem; color: var(--text);">
                            <span style="color: #10B981;">● True Level</span> &nbsp;
                            <span style="color: #EF4444;">● Indicated (False) Level</span>
                        </div>
                    </div>
                </div>

                <h4 style="margin-top: 30px; border-top: 1px solid var(--border); padding-top: 20px;">Step-by-Step Engineering Calculation</h4>
                <div id="calculation-details">
                    <!-- Dynamic math steps -->
                </div>

                <div class="standard-reference" style="margin-top: 20px; font-style: italic; color: var(--text);">
                     Densities derived from IAPWS-IF97 Steam Table approximation polynomials. Calculations account for vapor phase density ($h = (DP + \rho_{ref}H) / (\rho_{w} - \rho_{s})$).
                </div>
            </div>
        </div>

        <!-- EDUCATIONAL CONTENT SECTION (MASSIVE) -->
        <div class="education-section card">
            <h2><i class="fas fa-lightbulb"></i> Engineering Insights: Boiler Drum Level Measurement</h2>
            
            <!-- Insight 1: Why Wet Legs? -->
            <div class="insight-card">
                <h4><i class="fas fa-flask"></i> 1. The Necessity of the Wet Leg</h4>
                <p>Boiler drums contain saturated steam and boiling water. We measure level by measuring the hydrostatic head (weight) of the water column. However, we need a reference pressure from the top of the drum to cancel out the huge static steam pressure (e.g., 60 bar).</p>
                <p>If we simply ran a tube from the top tap to the transmitter, steam would enter it, cool down, and condense. This would form erratic slugs of water, causing the level reading to jump wildly. To prevent this, we intentionally fill the reference leg with water (condensate) up to a "Condensate Pot" at the top tap level. This creates a constant, known head of water called a <strong>Wet Leg</strong>.</p>
            </div>

            <!-- Insight 2: The Density Problem -->
            <div class="insight-card">
                <h4><i class="fas fa-thermometer-three-quarters"></i> 2. The Density Discrepancy</h4>
                <p>This is the root cause of all errors.
                <ul>
                    <li><strong>Inside the Drum:</strong> The water is at saturation temperature (e.g., 275°C at 60 bar). At this temp, water expands significantly. Its density drops to ~750 kg/m³.</li>
                    <li><strong>Inside the Wet Leg:</strong> The water is outside the boiler insulation. It cools down to ambient temperature (e.g., 35°C). Its density is ~994 kg/m³.</li>
                </ul>
                The transmitter measures Differential Pressure ($DP = P_{high} - P_{low}$). The wet leg ($P_{low}$) is much heavier than the process leg ($P_{high}$). This creates a <strong>Negative DP</strong>.</p>
                <p>Transmitters are calibrated assuming a specific density (usually the normal operating pressure). If the boiler pressure changes (e.g., during startup), the density inside the drum changes dramatically, but the wet leg density stays mostly constant. This density mismatch causes the indicated level to be wrong.</p>
            </div>

            <!-- Insight 3: Vapor Phase Density -->
            <div class="insight-card">
                <h4><i class="fas fa-cloud"></i> 3. The Weight of Steam</h4>
                <p>At low pressures, steam (vapor) has negligible weight. But at 100 bar, saturated steam has a density of ~55 kg/m³ (5% of water!). This is no longer negligible.</p>
                <p>The vapor pushing down on the water surface adds to the High Side pressure, but the vapor column in the drum <em>above</em> the liquid level subtracts from the differential (buoyancy effect). The rigorous formula for level calculation accounts for this:</p>
                <div class="formula">
                    $$ H_{level} = \frac{DP + (\rho_{ref} \cdot H)}{(\rho_{water} - \rho_{steam})} $$
                </div>
                <p>Ignoring $\rho_{steam}$ at high pressures causes the level to read lower than actual, which is dangerous (risk of carryover).</p>
            </div>

            <!-- Insight 4: Startup vs. Run -->
            <div class="insight-card">
                <h4><i class="fas fa-rocket"></i> 4. Startup Dynamics (Shrink & Swell)</h4>
                <p>When a boiler starts up cold (0 bar), the water density in the drum is 1000 kg/m³. The wet leg is also 1000 kg/m³. The level indication is accurate.</p>
                <p>As pressure builds to 60 bar, the drum water expands (density drops to 750 kg/m³), but the wet leg stays cold (994 kg/m³). The level <strong>Swells</strong> physically, but the DP transmitter sees less pressure difference per inch of level. Without compensation, the transmitter would read <strong>Lower</strong> than actual. Modern DCS systems use "Drum Level Pressure Compensation" blocks to dynamically adjust the SG based on real-time drum pressure measurements.</p>
            </div>

            <!-- Insight 5: Calibration Logic -->
            <div class="insight-card">
                <h4><i class="fas fa-sliders-h"></i> 5. Zero Elevation Calculation</h4>
                <p>Because the wet leg is always full and colder (heavier) than the drum water, the Low Side pressure is always higher than the High Side pressure (at zero level). This results in a negative DP.</p>
                <p><strong>0% Level (Empty Drum):</strong> $DP = P_{process\_0} - P_{wet\_leg}$. Since $P_{process\_0} \approx 0$ head, $DP = - \rho_{ref} \cdot H$. This huge negative value (e.g., -1000 mmH2O) is the <strong>LRV (Lower Range Value)</strong>. This is called Zero Elevation.</p>
            </div>
        </div>
    </main>    <!-- FOOTER -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-col">
                    <h4>Design Calculators</h4>
                    <p style="font-size: 0.9rem; line-height: 1.6; margin-bottom: 15px;">If you find this tool helpful, please consider sharing it with your colleagues!</p>
                    <div class="social-buttons">
                        <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn linkedin" title="LinkedIn"><i class="fab fa-linkedin-in"></i></a>
                        <a href="https://www.youtube.com/@designcalculators" target="_blank" rel="noopener noreferrer" class="social-btn youtube" title="YouTube"><i class="fab fa-youtube"></i></a>
                        <a href="https://twitter.com/intent/tweet?url=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn twitter" title="Twitter"><i class="fab fa-twitter"></i></a>
                        <a href="https://www.facebook.com/sharer/sharer.php?u=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn facebook" title="Facebook"><i class="fab fa-facebook-f"></i></a>
                        <a href="https://api.whatsapp.com/send?text=Check%20out%20this%20amazing%20engineering%20resource%20https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn whatsapp" title="WhatsApp"><i class="fab fa-whatsapp"></i></a>
                    </div>
                </div>
                <div class="footer-col">
                    <h4>Quick Links</h4>
                    <ul>
                        <li><a href='/'>Home</a></li>
                        <li><a href="indexele">Electrical</a></li>
                        <li><a href="indexmech">Mechanical</a></li>
                        <li><a href="indexinst">Instrumentation</a></li>                        
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>Resources</h4>
                    <ul>
                        <li><a href="about">About Us</a></li>
                        <li><a href="contact">Contact</a></li>
                        <li><a href="faq">FAQ</a></li>
                        <li><a href="privacy-policy">Privacy Policy</a></li>
                        <li><a href="terms-of-service">Terms of Service</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>More</h4>
                    <ul>
                        <li><a href='/articles'>Articles & Whitepapers</a></li>
                        <li><a href='/sitemap2'>Sitemap</a></li>                        
                    </ul>
                </div>
            </div>
            <div class="footer-disclaimer">
                <p>This tool offers general guidance. Results should be reviewed for accuracy and compliance with relevant project standards and regulations before use.</p>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Design Calculators. Created by <span style="color: var(--secondary); font-weight: bold;">A Sharma</span>. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        // Global State
        let lastResult = null;
        let animationFrame = null;
        let fillLevel = 0;

        // --- STEAM TABLES ENGINE (Polynomial Approx for Saturated Properties) ---
        // Range 1 bar to 200 bar
        function getSteamProps(P_bar) {
            // P in bar abs. Ensure input is gauge, so add 1.013.
            const P = P_bar + 1.013;
            
            // Saturation Temp (Ts) [C] - Approx
            // T = A + B*ln(P) + ...
            // Simplified high-accuracy industrial fit:
            const Ts = 100.0 * Math.pow(P, 0.23); // Rough
            // Better fit: IAPWS-97 simplified region 4
            // T_sat = 42.6776 * ln(P) + ... 
            // Using a robust fit:
            const T_sat = -203.5 + 4720/(16.2 - Math.log(P)); // Antoine-ish? No.
            // Using direct power law fit for 1-100 bar:
            const T_c = 179.32 * Math.pow(P, 0.239); // Very good for < 100 bar
            // For > 100 bar, slightly different. We will use the T_c derived here.
            
            // Liquid Density (Rho_f) [kg/m3]
            // Decreases with P
            const rho_l = 1000 - 0.2 * (T_c - 20) - 0.002 * Math.pow(T_c - 20, 2); 
            // High pressure correction:
            const rho_l_corr = 998 / (1 + 0.0004 * (T_c - 20) + 2e-6 * Math.pow(T_c - 20, 2));

            // Vapor Density (Rho_g) [kg/m3]
            // Increases linearly-ish with P
            // Rho_g approx 0.5 * P (bar) for low P
            const rho_g = 0.50 * P + 0.0015 * P * P;

            return { T_sat: T_c, rho_l: rho_l_corr, rho_g: rho_g };
        }

        // Water Density vs Temp (Sub-cooled for wet leg)
        function getWaterRho(T_c) {
            // Thiesen-Scheel-Diesselhorst equation simplified
            return 1000 * (1 - (T_c + 288.9414)/(508929.2*(T_c+68.12963)) * Math.pow(T_c - 3.9863, 2));
        }

        function loadPreset(type) {
            if (type === 'low_press') {
                document.getElementById('cal-pressure').value = '10';
                document.getElementById('op-pressure').value = '10'; // Operating = Cal
                document.getElementById('tap-distance').value = '1000';
                document.getElementById('cal-amb-temp').value = '25';
                document.getElementById('op-amb-temp').value = '25';
                document.getElementById('current-dp').value = '-500';
            } else if (type === 'med_press') {
                document.getElementById('cal-pressure').value = '60';
                document.getElementById('op-pressure').value = '40'; // Pressure drop event
                document.getElementById('tap-distance').value = '1500';
                document.getElementById('cal-amb-temp').value = '30';
                document.getElementById('op-amb-temp').value = '30';
                document.getElementById('current-dp').value = '-800';
            } else if (type === 'high_press') {
                document.getElementById('cal-pressure').value = '160';
                document.getElementById('op-pressure').value = '160';
                document.getElementById('tap-distance').value = '2000';
                document.getElementById('cal-amb-temp').value = '40';
                document.getElementById('op-amb-temp').value = '40';
                document.getElementById('current-dp').value = '-1200';
            }
            displayMessage(`${type.toUpperCase()} scenario loaded.`, "success");
        }

        function displayMessage(message, type = "info") {
            let messageBox = document.getElementById('message-box');
            messageBox.textContent = message;
            if (type === "error") messageBox.style.backgroundColor = 'var(--danger)';
            else if (type === "success") messageBox.style.backgroundColor = 'var(--success)';
            else messageBox.style.backgroundColor = 'var(--primary)';
            messageBox.classList.add('show');
            setTimeout(() => messageBox.classList.remove('show'), 4000);
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Theme handling
            const themeSwitch = document.getElementById('theme-switch');
            if (themeSwitch && localStorage.getItem('theme') === 'dark') {
                document.body.classList.add('dark-mode');
                themeSwitch.checked = true;
            }
            if(themeSwitch) {
                themeSwitch.addEventListener('change', function() {
                    document.body.classList.toggle('dark-mode');
                    localStorage.setItem('theme', this.checked ? 'dark' : 'light');
                });
            }

            document.getElementById('calculate-btn').addEventListener('click', performCalculation);
            document.getElementById('pdf-btn').addEventListener('click', generatePDF);
        });

        function performCalculation() {
            // 1. Get Inputs
            const P_cal = parseFloat(document.getElementById('cal-pressure').value);
            const H_mm = parseFloat(document.getElementById('tap-distance').value);
            const T_amb_cal = parseFloat(document.getElementById('cal-amb-temp').value);
            
            const P_op = parseFloat(document.getElementById('op-pressure').value);
            const T_amb_op = parseFloat(document.getElementById('op-amb-temp').value);
            const DP_meas = parseFloat(document.getElementById('current-dp').value); // mmH2O

            if (isNaN(P_cal) || isNaN(H_mm) || isNaN(DP_meas)) {
                displayMessage("Please enter valid numbers.", "error");
                return;
            }

            // 2. Physics Engine Calculation
            const H_m = H_mm / 1000;

            // A. Design State (Calibration)
            const props_cal = getSteamProps(P_cal); // rho_l, rho_g inside
            const rho_ref_cal = getWaterRho(T_amb_cal); // Wet leg density
            // Calibration LRV (0%): DP = (rho_g - rho_ref) * H -- High side has gas, Low side has water
            // Actually: HP = P_gas + rho_g*H. LP = P_gas + rho_ref*H.
            // DP = HP - LP = (rho_g * H) - (rho_ref * H) = H * (rho_g - rho_ref)
            const dp_0_cal_pa = 9.81 * H_m * (props_cal.rho_g - rho_ref_cal);
            const lrv_cal = dp_0_cal_pa / 9.80665; // mmH2O

            // Calibration URV (100%): Tank full of rho_l
            // HP = P_gas + rho_l*H. LP = P_gas + rho_ref*H.
            // DP = H * (rho_l - rho_ref)
            const dp_100_cal_pa = 9.81 * H_m * (props_cal.rho_l - rho_ref_cal);
            const urv_cal = dp_100_cal_pa / 9.80665; // mmH2O

            const span_cal = urv_cal - lrv_cal;

            // B. Operating State (Current Reality)
            const props_op = getSteamProps(P_op);
            const rho_ref_op = getWaterRho(T_amb_op);

            // C. Level Calculation (Compensated)
            // General Formula: H_level = (DP - LRV_op) / (rho_l_op - rho_g_op)
            // But we measure DP. We need to solve for h.
            // DP_meas (Pa) = g * [ (rho_g_op * (H-h)) + (rho_l_op * h) - (rho_ref_op * H) ]
            // DP = g * [ H*rho_g - h*rho_g + h*rho_l - H*rho_ref ]
            // DP = g * [ H(rho_g - rho_ref) + h(rho_l - rho_g) ]
            // DP/g - H(rho_g - rho_ref) = h(rho_l - rho_g)
            // h = [ DP/g + H(rho_ref - rho_g) ] / (rho_l - rho_g)

            const dp_meas_pa = DP_meas * 9.80665;
            const num = (dp_meas_pa / 9.81) + H_m * (rho_ref_op - props_op.rho_g);
            const den = props_op.rho_l - props_op.rho_g;
            const h_actual_m = num / den;
            const level_actual_pct = (h_actual_m / H_m) * 100;

            // D. Indicated Level (Uncompensated Error)
            // The transmitter assumes Calibration Densities.
            // It calculates % based on: (DP - LRV_cal) / Span_cal
            const level_indicated_pct = ((DP_meas - lrv_cal) / span_cal) * 100;

            const error_pct = level_indicated_pct - level_actual_pct;

            lastResult = { 
                props_cal, rho_ref_cal, lrv_cal, urv_cal, span_cal,
                props_op, rho_ref_op, level_actual_pct, level_indicated_pct, error_pct,
                H_mm, P_cal, P_op
            };

            // 4. Render Step-by-Step
            let html = `<h4>Step 1: Calibration Constants (Design: ${P_cal} bar)</h4>`;
            html += `<div class="calculation-step">`;
            html += `Steam Table Data: $T_{sat}=${props_cal.T_sat.toFixed(1)} ^\\circ C$, $\\rho_f=${props_cal.rho_l.toFixed(1)}$, $\\rho_g=${props_cal.rho_g.toFixed(2)}$ kg/m³.<br>`;
            html += `Wet Leg Density ($${T_amb_cal}^\\circ C$): $\\rho_{ref} = ${rho_ref_cal.toFixed(1)}$ kg/m³.<br>`;
            html += `<strong>LRV (0%):</strong> $DP_0 = H(\\rho_g - \\rho_{ref}) = ${H_m}\\cdot(${props_cal.rho_g.toFixed(1)} - ${rho_ref_cal.toFixed(1)}) \\approx \\mathbf{${lrv_cal.toFixed(0)} \\text{ mmH}_2\\text{O}}$<br>`;
            html += `<strong>URV (100%):</strong> $DP_{100} = H(\\rho_f - \\rho_{ref}) = ${H_m}\\cdot(${props_cal.rho_l.toFixed(1)} - ${rho_ref_cal.toFixed(1)}) \\approx \\mathbf{${urv_cal.toFixed(0)} \\text{ mmH}_2\\text{O}}$`;
            html += `</div>`;

            html += `<h4>Step 2: Operating Physics (Actual: ${P_op} bar)</h4>`;
            html += `<div class="calculation-step">`;
            html += `Steam Table Data: $T_{sat}=${props_op.T_sat.toFixed(1)} ^\\circ C$, $\\rho_f=${props_op.rho_l.toFixed(1)}$, $\\rho_g=${props_op.rho_g.toFixed(2)}$.<br>`;
            html += `Wet Leg Density ($${T_amb_op}^\\circ C$): $\\rho_{ref} = ${rho_ref_op.toFixed(1)}$.<br>`;
            html += `The density of water in the drum has changed from ${props_cal.rho_l.toFixed(1)} to ${props_op.rho_l.toFixed(1)}.`;
            html += `</div>`;

            html += `<h4>Step 3: Level Calculation & Error</h4>`;
            html += `<div class="calculation-step">`;
            html += `<strong>True Level:</strong> Derived from mass balance of columns.<br>`;
            html += `$$ h_{true} = \\frac{DP/g + H(\\rho_{ref} - \\rho_g)}{\\rho_f - \\rho_g} = \\mathbf{${level_actual_pct.toFixed(2)}\\%} $$<br>`;
            html += `<strong>Indicated Level:</strong> Based on calibration span.<br>`;
            html += `$$ h_{ind} = \\frac{DP - LRV_{cal}}{Span_{cal}} = \\mathbf{${level_indicated_pct.toFixed(2)}\\%} $$<br>`;
            html += `<strong>Error:</strong> ${error_pct.toFixed(2)}%`;
            html += `</div>`;

            document.getElementById('calculation-details').innerHTML = html;

            // 5. Update Table
            const tbody = document.getElementById('result-table-body');
            tbody.innerHTML = '';
            const addRow = (n, v, u, c="") => {
                tbody.innerHTML += `<tr style="${c ? 'color:'+c : ''}"><td><strong>${n}</strong></td><td>${v}</td><td>${u}</td></tr>`;
            };
            addRow("True Level", level_actual_pct.toFixed(2), "%", "var(--success)");
            addRow("Indicated Level", level_indicated_pct.toFixed(2), "%", "var(--danger)");
            addRow("Measurement Error", (error_pct > 0 ? "+" : "") + error_pct.toFixed(2), "%");
            addRow("Drum Water Density", props_op.rho_l.toFixed(1), "kg/m³");

            const interpEl = document.getElementById('interpretation-text');
            if (Math.abs(error_pct) > 5) {
                interpEl.innerHTML = `<span style="color:var(--danger); font-weight:bold;">Significant Density Error!</span> The operating pressure deviates too much from calibration. Consider dynamic density compensation in DCS.`;
            } else {
                interpEl.innerHTML = `<span style="color:var(--success); font-weight:bold;">Acceptable Accuracy.</span> Conditions match calibration reasonably well.`;
            }

            // 6. Draw Visual
            drawVisual(level_actual_pct, level_indicated_pct, props_op.rho_l, rho_ref_op);

            // 7. Show
            document.getElementById('result-container').classList.remove('hidden');
            if(window.MathJax) window.MathJax.typesetPromise([document.getElementById('calculation-details')]);
            document.getElementById('result-container').scrollIntoView({ behavior: 'smooth' });
        }

        function drawVisual(trueLvl, indLvl, rhoP, rhoRef) {
            const canvas = document.getElementById('drumCanvas');
            const ctx = canvas.getContext('2d');
            const cw = canvas.width;
            const ch = canvas.height;

            ctx.clearRect(0, 0, cw, ch);

            // Draw Drum Circle
            const cx = cw / 3;
            const cy = ch / 2;
            const r = 100;

            ctx.beginPath();
            ctx.arc(cx, cy, r, 0, 2*Math.PI);
            ctx.strokeStyle = '#334155';
            ctx.lineWidth = 4;
            ctx.stroke();

            // Fill Water Level (True)
            // Level 0% is bottom tap (say -r), 100% is top tap (+r)? usually taps are defined.
            // Let's assume taps are at +/- 80px from center. Span = 160px.
            const bottomTapY = cy + 80;
            const topTapY = cy - 80;
            const spanPx = 160;
            
            // Clamp level visual
            const lvlClamped = Math.max(0, Math.min(100, trueLvl));
            const waterY = bottomTapY - (lvlClamped/100 * spanPx);

            // Clip circle for water
            ctx.save();
            ctx.beginPath();
            ctx.arc(cx, cy, r-2, 0, 2*Math.PI);
            ctx.clip();
            
            ctx.fillStyle = 'rgba(16, 185, 129, 0.4)'; // Green Water
            ctx.fillRect(cx - r, waterY, 2*r, bottomTapY + 100 - waterY); // Fill down
            
            // Steam (Top)
            ctx.fillStyle = 'rgba(200, 200, 200, 0.2)'; // Grey Steam
            ctx.fillRect(cx - r, topTapY - 100, 2*r, waterY - (topTapY - 100));
            ctx.restore();

            // Wet Leg (Right side)
            const legX = cx + 150;
            ctx.strokeStyle = '#3B82F6'; // Blue cold leg
            ctx.lineWidth = 6;
            ctx.beginPath();
            ctx.moveTo(cx + r, topTapY); // From top tap
            ctx.lineTo(legX, topTapY);
            ctx.lineTo(legX, bottomTapY + 40); // Down to Tx
            ctx.stroke();
            
            // Condensate Pot
            ctx.fillStyle = '#64748B';
            ctx.fillRect(legX - 15, topTapY - 10, 30, 20);

            // HP Leg
            ctx.strokeStyle = '#EF4444'; // Red hot leg
            ctx.beginPath();
            ctx.moveTo(cx + r * Math.sin(Math.acos(80/100)), bottomTapY); // Approx tap point
            ctx.lineTo(legX - 40, bottomTapY);
            ctx.lineTo(legX - 40, bottomTapY + 40);
            ctx.stroke();

            // Transmitter
            ctx.fillStyle = '#FFF';
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(legX - 20, bottomTapY + 50, 15, 0, 2*Math.PI);
            ctx.fill();
            ctx.stroke();
            ctx.fillStyle = '#000';
            ctx.font = 'bold 10px Inter';
            ctx.fillText("dPT", legX - 28, bottomTapY + 53);

            // Indicators
            // True Level Line
            ctx.strokeStyle = '#10B981';
            ctx.setLineDash([5, 3]);
            ctx.beginPath();
            ctx.moveTo(cx - r, waterY);
            ctx.lineTo(cx + r + 20, waterY);
            ctx.stroke();
            ctx.fillStyle = '#10B981';
            ctx.fillText(`True: ${trueLvl.toFixed(1)}%`, cx - 40, waterY - 5);

            // Indicated Level Line (Ghost)
            const indY = bottomTapY - (Math.max(0, Math.min(100, indLvl))/100 * spanPx);
            ctx.strokeStyle = '#EF4444';
            ctx.beginPath();
            ctx.moveTo(cx - r, indY);
            ctx.lineTo(cx + r + 20, indY);
            ctx.stroke();
            ctx.fillStyle = '#EF4444';
            ctx.fillText(`Indicated: ${indLvl.toFixed(1)}%`, cx - 40, indY - 5);
        }

        function generatePDF() {
            if (!lastResult) {
                displayMessage("Calculate first.", "error");
                return;
            }
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            let y = 15;

            // Header
            pdf.setFont('helvetica', 'bold');
            pdf.setFontSize(16);
            pdf.setTextColor(30, 58, 138); 
            pdf.text('Boiler Level Compensation Report', 105, y, { align: 'center' });
            y += 10;

            pdf.setFontSize(10);
            pdf.setTextColor(100);
            pdf.text(`Date: ${new Date().toLocaleString()}`, 105, y, { align: 'center' });
            y += 15;

            // Inputs
            pdf.setFontSize(12);
            pdf.setTextColor(0);
            pdf.text('1. Design vs Operating Data', 14, y);
            y += 5;

            const inputData = [
                ['Design Pressure', `${lastResult.P_cal} bar`],
                ['Operating Pressure', `${lastResult.P_op} bar`],
                ['Ambient Temp (Cal/Op)', `${document.getElementById('cal-amb-temp').value} / ${document.getElementById('op-amb-temp').value} °C`],
                ['Tap Distance', `${lastResult.H_mm} mm`]
            ];

            pdf.autoTable({
                startY: y,
                head: [['Parameter', 'Value']],
                body: inputData,
                margin: { left: 14, right: 14 },
                theme: 'grid',
                headStyles: { fillColor: [30, 58, 138] }
            });
            y = pdf.lastAutoTable.finalY + 15;

            // Results
            pdf.text('2. Compensation Analysis', 14, y);
            y += 5;

            const resData = [
                ['True Level', `${lastResult.level_actual_pct.toFixed(2)} %`],
                ['Indicated Level', `${lastResult.level_indicated_pct.toFixed(2)} %`],
                ['Error', `${lastResult.error_pct.toFixed(2)} %`],
                ['Process Density', `${lastResult.props_op.rho_l.toFixed(1)} kg/m³`],
                ['Reference Density', `${lastResult.rho_ref_op.toFixed(1)} kg/m³`]
            ];

            pdf.autoTable({
                startY: y,
                head: [['Metric', 'Result']],
                body: resData,
                margin: { left: 14, right: 14 },
                theme: 'grid',
                headStyles: { fillColor: [30, 58, 138] },
                didParseCell: function(data) {
                    if(data.row.index === 0) {
                        data.cell.styles.fontStyle = 'bold';
                    }
                }
            });

            // Footer
            y = pdf.lastAutoTable.finalY + 20;
            pdf.setFontSize(8);
            pdf.setTextColor(150);
            pdf.text('Based on IAPWS-IF97 steam table properties.', 105, y, { align: 'center' });

            pdf.save('WetLeg_Report.pdf');
            displayMessage("PDF Downloaded", "success");
        }

        function displayMessage(message, type = "info") {
            let messageBox = document.getElementById('message-box');
            messageBox.textContent = message;
            if (type === "error") messageBox.style.backgroundColor = 'var(--danger)';
            else if (type === "success") messageBox.style.backgroundColor = 'var(--success)';
            else messageBox.style.backgroundColor = 'var(--primary)';
            messageBox.classList.add('show');
            setTimeout(() => messageBox.classList.remove('show'), 4000);
        }
    </script>
</body>
</html>
