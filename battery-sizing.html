<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Industrial Battery Sizing Calculator (IEEE 485) - Design Calculators</title>
    <!-- Meta tags -->
    <meta name="description" content="Professional Industrial Battery Sizing Calculator per IEEE 485. Calculates required Ah capacity based on complex load profiles, derating factors, and battery type.">
    <meta name="keywords" content="battery sizing calculator, ieee 485, battery ah calculator, industrial battery, dc system, lead-acid sizing, battery bank calculator, electrical calculator">
    <meta name="author" content="Design Calculators">
    <meta name="robots" content="index, follow">

    <!-- AdSense & Google Analytics -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5936527763614780" crossorigin="anonymous"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-23Y1V450SR"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-23Y1V450SR');
    </script>
    
    <!-- Fonts and Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Montserrat:wght@700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- MathJax for formula rendering -->
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
            svg: { fontCache: 'global' },
            options: { processHtmlClass: 'math-content', ignoreHtmlClass: 'no-mathjax' }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- jsPDF-AutoTable plugin -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <!-- Favicons -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    
    <!-- NEW Standardized CSS -->
    <style>
        :root {
            --primary-color: #1E3A8A;
            --secondary-color: #2563EB;
            --accent-color: #F59E0B;
            --success-color: #10B981;
            --bg-color: #F8FAFC;
            --card-bg: #FFFFFF;
            --text-color: #4B5563;
            --heading-color: #111827;
            --footer-bg: #0F172A;
            --border-color: #E2E8F0;
            --gradient-primary: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            --gradient-dark: linear-gradient(135deg, #0F172A, #1E293B);
            --card-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            --hover-color: #e2e6ea;
            --input-focus-shadow: 0 0 0 3px rgba(30, 58, 138, 0.25);
        }

        body.dark-mode {
            --primary-color: #10B981;
            --secondary-color: #34D399;
            --bg-color: #0F172A;
            --card-bg: #1E293B;
            --text-color: #CBD5E1;
            --heading-color: #F1F5F9;
            --footer-bg: #020617;
            --border-color: #334155;
            --hover-color: #1E293B;
            --input-focus-shadow: 0 0 0 3px rgba(16, 185, 129, 0.5);
        }

        * { box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.8;
            transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 24px;
        }

        /* HEADER */
        .header {
            background: var(--gradient-primary);
            color: white;
            padding: 24px 0;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo-container {
            flex-direction: column;
            align-items: flex-start;
            text-decoration: none;
            color: white;
            gap: 0;
        }
        .logo-text {
            font-size: 1.75rem;
            font-weight: 800;
            font-family: 'Montserrat', sans-serif;
        }
        .logo-subtitle {
            font-size: 0.8rem;
            line-height: 1.2;
            margin: 4px 0 0 0;
            font-weight: 300;
            max-width: 400px;
            color: #E0E7FF;
        }
        
        .nav-links {
            display: flex;
            gap: 24px;
            align-items: center;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        .nav-links a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }
        .nav-links a:hover { color: var(--accent-color); }

        /* Theme Toggle */
        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .theme-toggle .icon {
            color: white;
            font-size: 1.2rem;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 56px;
            height: 30px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.2);
            transition: .4s;
            border-radius: 30px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--accent-color); }
        input:checked + .slider:before { transform: translateX(26px); }

        /* Main Content */
        main { padding: 40px 0; }
        .tool-container {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 30px;
            box-shadow: var(--card-shadow);
            margin-bottom: 30px;
        }
        .tool-container h2 {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            padding-bottom: 15px;
            margin-top: 0;
            margin-bottom: 25px;
            font-family: 'Montserrat', sans-serif;
            font-size: 1.8rem;
        }
         .tool-container h3 {
            color: var(--heading-color);
            font-family: 'Montserrat', sans-serif;
            font-size: 1.5rem;
            margin-top: 25px;
            margin-bottom: 20px;
        }
        .tool-description {
            margin-bottom: 25px;
            color: var(--text-color);
            font-size: 1rem;
            line-height: 1.8;
        }
        .tool-description a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
        }
        .tool-description a:hover {
            text-decoration: underline;
        }

        /* Form Styles */
        .calculator-form {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 25px;
            margin-top: 25px;
        }
        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--heading-color);
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--bg-color);
            color: var(--text-color);
            box-sizing: border-box;
            transition: all 0.3s;
            font-size: 1rem;
        }
        .form-group input:focus, .form-group select:focus {
            border-color: var(--primary-color);
            box-shadow: var(--input-focus-shadow);
            outline: none;
        }
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        .input-with-unit {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .input-with-unit input { flex: 1; }
        .input-with-unit select { width: auto; min-width: 70px; }
        
        /* Button Styles */
        .calculate-btn {
            background: var(--gradient-primary);
            color: white;
            border: none;
            padding: 16px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 700;
            transition: all 0.3s;
            width: 100%;
            box-shadow: 0 4px 12px rgba(30, 58, 138, 0.3);
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .calculate-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(30, 58, 138, 0.4);
        }
        .calculate-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .calculate-btn:disabled {
            background: #9ca3af; /* Grey */
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .calculate-btn .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-left-color: #ffffff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: none; /* Hidden by default */
            margin-left: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Result Styles */
        .result-container {
            margin-top: 40px;
            padding: 30px;
            border-radius: 12px;
            background-color: var(--card-bg);
            box-shadow: var(--card-shadow);
            display: none;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }
        .result-container.show {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }
        .result-container h3 {
            color: var(--primary-color);
            margin-bottom: 25px;
            font-family: 'Montserrat', sans-serif;
            font-size: 1.6rem;
        }
        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-radius: 8px;
            overflow: hidden;
        }
        .result-table th, .result-table td {
            padding: 14px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        .result-table th {
            background: var(--gradient-primary);
            color: white;
            font-weight: 700;
        }
        .result-table tr:nth-child(even) {
            background-color: rgba(0,0,0,0.02);
        }
        .result-table td strong {
            color: var(--heading-color);
        }
        body.dark-mode .result-table td strong {
             color: var(--primary-color);
        }
        
        /* Calculation Details & Standard Ref */
        #calculation-details { 
            background-color: var(--bg-color);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
            font-size: 0.95rem;
        }
        #calculation-details h3 {
            color: var(--primary-color);
            margin-bottom: 25px;
            font-family: 'Montserrat', sans-serif;
            font-size: 1.6rem;
            margin-top: 0;
        }
        #calculation-details h4 {
            color: var(--secondary-color);
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }
        #calculation-details p.formula {
            font-family: 'Times New Roman', serif;
            font-size: 1.1rem;
            text-align: center;
            padding: 15px;
            background-color: var(--hover-color);
            border-radius: 6px;
            margin: 15px 0;
            overflow-x: auto;
        }
        #calculation-details p.calculation-step {
            font-family: 'Courier New', monospace;
            background-color: var(--hover-color);
            padding: 8px 12px;
            border-radius: 4px;
            margin-bottom: 8px;
            line-height: 1.6;
        }
        #calculation-details ul {
            list-style-type: disc;
            margin-left: 25px;
            padding-left: 0;
        }
        #calculation-details ul li {
            margin-bottom: 8px;
            line-height: 1.7;
        }

        .standard-reference {
            margin-top: 25px;
            font-style: italic;
            font-size: 0.95rem;
            padding: 15px;
            background: linear-gradient(135deg, rgba(245,158,11,0.1), rgba(245,158,11,0.05));
            border-left: 4px solid var(--accent-color);
            border-radius: 6px;
            line-height: 1.7;
        }
         .standard-reference a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
        }
        .standard-reference a:hover {
            text-decoration: underline;
        }

        /* Tooltip */
        .info-icon {
            color: var(--primary-color);
            margin-left: 6px;
            cursor: help;
            font-size: 0.9rem;
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 280px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1000;
            bottom: 130%;
            left: 50%;
            margin-left: -140px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.85rem;
            line-height: 1.5;
            white-space: normal;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* Custom Message Box */
        #custom-message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 16px 28px;
            border-radius: 8px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.25);
            z-index: 10000;
            font-weight: 600;
            color: white;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        #custom-message-box.show { opacity: 1; }

        /* New Content Block Styles */
        .content-block { 
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 30px;
            box-shadow: var(--card-shadow);
            margin-bottom: 30px;
            margin-top: 30px;
            /* Added for smooth appearance */
            display: none;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }
        .content-block.show {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }
        .content-block h2 {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            padding-bottom: 15px;
            margin-top: 0;
            margin-bottom: 25px;
            font-family: 'Montserrat', sans-serif;
            font-size: 1.8rem;
        }
        .content-block h3 {
            color: var(--heading-color);
            font-family: 'Montserrat', sans-serif;
            font-size: 1.4rem;
            margin-top: 25px;
            margin-bottom: 15px;
        }
         .content-block h4 {
            color: var(--secondary-color);
            font-family: 'Montserrat', sans-serif;
            font-size: 1.2rem;
            margin-top: 20px;
            margin-bottom: 10px;
        }
        .content-block p, .content-block li {
            font-size: 1rem;
            line-height: 1.8;
            color: var(--text-color);
        }
        .content-block ul, .content-block ol {
            list-style-type: disc;
            margin-left: 20px;
            padding-left: 5px;
            margin-bottom: 15px;
        }
        .content-block ol {
            list-style-type: decimal;
        }
        .content-block li {
            margin-bottom: 10px;
        }
        .content-block strong {
            color: var(--heading-color);
        }
        body.dark-mode .content-block strong {
            color: var(--primary-color);
        }
        .content-block code {
            background-color: var(--hover-color);
            padding: 2px 5px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            color: var(--primary-color);
        }
        body.dark-mode .content-block code {
            color: var(--secondary-color);
        }
        .content-block .formula-block {
            font-family: 'Times New Roman', serif;
            font-size: 1.1rem;
            text-align: center;
            padding: 15px;
            background-color: var(--hover-color);
            border-radius: 6px;
            margin: 20px 0;
            overflow-x: auto;
            border: 1px dashed var(--primary-color);
        }
        .content-block table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-radius: 8px;
            overflow: hidden;
        }
        .content-block th, .content-block td {
            padding: 14px;
            text-align: left;
            border: 1px solid var(--border-color);
        }
        .content-block th {
            background-color: var(--hover-color);
            font-weight: 600;
        }
        
        /* FOOTER */
        footer {
            background: var(--gradient-dark);
            color: #CBD5E1;
            padding: 50px 0 20px 0;
        }
        .footer-content {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 40px;
            margin-bottom: 30px;
        }
        .footer-col {
            flex: 1;
            min-width: 200px;
        }
        .footer-col h4 {
            font-size: 1.1rem;
            color: white;
            margin-bottom: 15px;
            font-weight: 700;
        }
        .footer-col ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .footer-col ul li { margin-bottom: 10px; }
        .footer-col a {
            color: #CBD5E1;
            text-decoration: none;
            transition: color 0.3s;
            font-size: 0.95rem;
        }
        .footer-col a:hover { color: var(--accent-color); }
        .footer-disclaimer {
            text-align: center;
            margin: 30px auto;
            padding-top: 25px;
            border-top: 1px solid #334155;
            max-width: 800px;
            font-size: 0.9rem;
            line-height: 1.6;
        }
        .footer-bottom {
            text-align: center;
            padding-top: 20px;
            font-size: 0.9rem;
            color: #94A3B8;
        }
        .creator-name {
            color: var(--secondary-color);
            font-weight: bold;
        }
        .social-buttons {
            display: flex;
            gap: 12px;
            margin-top: 15px;
        }
        .social-btn {
            width: 40px;
            height: 40px;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            color: white;
            border-radius: 50%;
            text-decoration: none;
            font-size: 1.1rem;
            transition: transform 0.3s, box-shadow 0.3s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .social-btn:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
        }
        .social-btn.linkedin { background-color: #0A66C2; }
        .social-btn.youtube { background-color: #FF0000; }
        .social-btn.twitter { background-color: #1DA1F2; }
        .social-btn.facebook { background-color: #1877F2; }
        .social-btn.whatsapp { background-color: #25D366; }

        /* Responsive */
        @media (max-width: 768px) {
            .container { padding: 0 15px; }
            .navbar { flex-direction: column; gap: 20px; }
            .nav-links { flex-direction: column; gap: 12px; text-align: center; }
            .form-row { grid-template-columns: 1fr; }
            .tool-container, .content-block { padding: 20px; }
            .footer-content { flex-direction: column; gap: 25px; }
            .theme-toggle {
                position: relative;
                top: 0;
                right: 0;
                margin-top: 15px;
            }
            .content-block table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
             .logo-container {
                 align-items: center; 
            }
            .logo-subtitle {
                text-align: center; 
            }
        }
        .hidden { display: none; }
    </style>
</head>
<body>
    
    <!-- NEW HEADER -->
    <header class="header">
        <div class="container">
            <nav class="navbar">
                <a href="/" class="logo-container">
                    <span class="logo-text">Design Calculators</span>
                    <!-- Updated Subtitle -->
                    <p class="logo-subtitle">
                        Inspired by standards such as IEC, IEEE, ISA, ASME, and API.
                    </p>
                </a>
                <ul class="nav-links">
                    <li><a href="/">Home</a></li>
                    <li><a href='/articles.html'>Articles</a></li>
                    <li><a href='/indexmech.html'>Mechanical</a></li>
                    <li><a href='/indexele.html'>Electrical</a></li>
                    <li><a href='/indexinst.html'>Instrumentation</a></li>
                </ul>
                <div class="theme-toggle">
                    <i class="fas fa-sun icon"></i>
                    <label class="switch">
                        <input type="checkbox" id="theme-switch">
                        <span class="slider"></span>
                    </label>
                    <i class="fas fa-moon icon"></i>
                </div>
            </nav>
        </div>
    </header>

    <!-- MAIN CONTENT - Refactored -->
    <main class="container">
        <!-- Back button removed -->
        <div class="tool-container">
            <h2>Industrial Battery Sizing Calculator</h2>
            <div class="tool-description">
                <p>This calculator helps you determine the appropriate battery capacity (Ah) based on load requirements, backup time, and system parameters according to IEEE 450 and IEC 60896 standards. This enhanced version allows for more precise sizing by considering varying load profiles, including initial high loads and final high loads, crucial for industrial and critical applications.</p>
            </div>

            <div class="calculator-form">
                <form id="battery-sizing-form">
                    <h3>1. System Parameters</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="system-voltage">System Voltage (V) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Nominal DC voltage of the battery system.</span></span></label>
                            <select id="system-voltage" required>
                                <option value="12">12V</option>
                                <option value="24">24V</option>
                                <option value="48" selected>48V</option>
                                <option value="110">110V</option>
                                <option value="125">125V</option>
                                <option value="220">220V</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>
                        <div class="form-group hidden" id="custom-voltage-row">
                            <label for="custom-voltage">Custom Voltage (V)</label>
                            <input type="number" id="custom-voltage" min="1" step="0.1" value="48">
                        </div>
                         <div class="form-group">
                            <label for="backup-time">Total Required Backup Time (hours) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The total duration for which the system should run on battery power.</span></span></label>
                            <input type="number" id="backup-time" min="0.1" step="0.1" value="2" required>
                        </div>
                    </div>

                    <h3>2. Load Profile (IEEE 485)</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="initial-high-load">Initial High Load <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Peak load at the beginning of the backup period (e.g., motor starting, inrush). Set to 0 if not applicable.</span></span></label>
                            <div class="input-with-unit">
                                <input type="number" id="initial-high-load" min="0" step="1" value="1000" required>
                                <select id="initial-high-load-unit">
                                    <option value="W">W</option>
                                    <option value="VA">VA</option>
                                    <option value="A">A</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="initial-high-load-duration">Initial Load Duration (minutes) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">How long the initial high load persists. Must be less than total backup time.</span></span></label>
                            <input type="number" id="initial-high-load-duration" min="0" step="1" value="5" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="normal-load-power">Normal Load <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">The continuous or average load during the main part of the backup period.</span></span></label>
                            <div class="input-with-unit">
                                <input type="number" id="normal-load-power" min="0" step="0.1" value="500" required>
                                <select id="normal-load-power-unit">
                                    <option value="W" selected>W</option>
                                    <option value="VA">VA</option>
                                    <option value="A">A</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="final-high-load">Final High Load <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Peak load at the end of the backup period (e.g., emergency shutdown). Set to 0 if not applicable.</span></span></label>
                            <div class="input-with-unit">
                                <input type="number" id="final-high-load" min="0" step="1" value="700" required>
                                <select id="final-high-load-unit">
                                    <option value="W">W</option>
                                    <option value="VA">VA</option>
                                    <option value="A">A</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group hidden" id="power-factor-row">
                            <label for="power-factor">Power Factor (PF) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Required if any load is in VA. Value between 0.1 and 1.</span></span></label>
                            <input type="number" id="power-factor" min="0.1" max="1" step="0.01" value="0.8">
                        </div>
                        <div class="form-group">
                            <label for="final-high-load-duration">Final Load Duration (minutes) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">How long the final high load persists. Must be less than total backup time.</span></span></label>
                            <input type="number" id="final-high-load-duration" min="0" step="1" value="5" required>
                        </div>
                    </div>

                    <h3>3. Battery & System Parameters</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="discharge-rate">Max Discharge Rate (C-rate) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Maximum safe discharge rate (e.g., 0.1C = 10-hour discharge). This is a general guideline.</span></span></label>
                            <select id="discharge-rate" required>
                                <option value="0.05">0.05C (20-hour)</option>
                                <option value="0.1" selected>0.1C (10-hour)</option>
                                <option value="0.2">0.2C (5-hour)</option>
                                <option value="0.5">0.5C (2-hour)</option>
                                <option value="1.0">1.0C (1-hour)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="battery-type">Battery Type <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Type of battery technology, affecting nominal cell voltage and temperature correction.</span></span></label>
                            <select id="battery-type" required>
                                <option value="lead-acid">Lead Acid (VRLA/AGM)</option>
                                <option value="gel">Gel</option>
                                <option value="lithium">Lithium-ion</option>
                                <option value="nickel-cadmium">Nickel-Cadmium</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="depth-of-discharge">Depth of Discharge (DOD) (%) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Maximum allowable discharge for battery longevity. Higher DOD reduces battery lifespan.</span></span></label>
                            <select id="depth-of-discharge" required>
                                <option value="50">50% (Lead Acid - Standard)</option>
                                <option value="80">80% (Deep Cycle)</option>
                                <option value="90">90% (Lithium-ion)</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>
                        <div class="form-group hidden" id="custom-dod-row">
                            <label for="custom-dod">Custom DOD (%)</label>
                            <input type="number" id="custom-dod" min="10" max="95" step="1" value="80">
                        </div>
                         <div class="form-group">
                            <label for="temperature">Operating Temperature (°C) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Average operating temperature. Lower temperatures reduce usable capacity.</span></span></label>
                            <input type="number" id="temperature" min="-20" max="60" step="1" value="25" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="efficiency">System Efficiency (%) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Overall system efficiency including inverter/converter losses.</span></span></label>
                            <input type="number" id="efficiency" min="70" max="98" step="0.1" value="85" required>
                        </div>
                        <div class="form-group">
                            <label for="aging-factor">Aging Factor <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Factor to account for capacity reduction over its service life (e.g., 1.25 for 25%).</span></span></label>
                            <select id="aging-factor" required>
                                <option value="1.0">No aging (New system)</option>
                                <option value="1.2" selected>20% aging margin</option>
                                <option value="1.25">25% aging margin</option>
                                <option value="1.3">30% aging margin</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="safety-factor">Safety Factor <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Additional safety margin for critical applications (e.g., 1.1 for 10%).</span></span></label>
                            <select id="safety-factor" required>
                                <option value="1.0">No safety factor</option>
                                <option value="1.1">10% safety margin</option>
                                <option value="1.2" selected>20% safety margin</option>
                                <option value="1.25">25% safety margin</locati>
                            </select>
                        </div>
                        <!-- FIX: Added the missing "standard" form group -->
                        <div class="form-group">
                            <label for="standard">Design Standard <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Standard to use for calculations. IEEE 485 is often used for load profiling.</span></span></label>
                            <select id="standard" required>
                                <option value="ieee450">IEEE 450</option>
                                <option value="iec60896">IEC 60896</option>
                                <option value="ieee1188">IEEE 1188</option>
                                <option value="ieee485" selected>IEEE 485 (for Load Profile)</option>
                            </select>
                        </div>
                    </div>

                    <!-- NEW Button Group -->
                    <div class="form-row" style="gap: 10px; margin-top: 25px;">
                        <button type="button" id="calculate-btn" class="calculate-btn" style="flex: 2;">
                            <i class="fas fa-calculator" style="margin-right: 8px;"></i>Calculate Battery Capacity
                            <span class="spinner" id="calculate-spinner" style="display:none;"></span>
                        </button>
                        <button type="button" id="reset-calculations-btn" class="calculate-btn" style="flex: 1; background: var(--accent-color); box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);">
                            <i class="fas fa-sync-alt" style="margin-right: 8px;"></i>Reset
                        </button>
                        <button type="button" id="download-pdf-btn" class="calculate-btn" style="flex: 1; background: var(--secondary-color); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);">
                            <i class="fas fa-file-pdf" style="margin-right: 8px;"></i>Download PDF
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- Result Container - Refactored -->
            <div id="result-container" class="result-container">
                <h3>Battery Sizing Results</h3>
                <div id="calculation-details" class="math-content">
                    <!-- Calculation steps will be inserted here -->
                </div>
                <table class="result-table">
                    <thead>
                        <tr>
                            <th>Parameter</th>
                            <th>Value</th>
                        </tr>
                    </thead>
                    <tbody id="result-table-body">
                        <!-- Results will be dynamically inserted here -->
                    </tbody>
                </table>
                <div class="standard-reference" id="standard-reference">
                    <!-- Standard reference text will be inserted here -->
                </div>
            </div>
        </div>
        
        <!-- NEW CONTENT BLOCK for AdSense -->
        <div class="container">
            <div class="content-block" id="battery-guide-content" style="display: none;">
                <h2 class="math-content">Comprehensive Guide to Industrial Battery Sizing (IEEE 485)</h2>
                <p>Sizing a stationary battery bank for an industrial or critical power application (like a UPS or DC switchgear) is a complex task. A simple calculation based on average load will almost always result in an undersized battery that fails during a real emergency. This calculator uses the <strong>load profile method</strong>, which is the industry-best-practice described in <strong>IEEE 485</strong> (Recommended Practice for Sizing Large Lead-Acid Batteries for Stationary Applications).</p>
                <p>This method correctly accounts for the fact that different loads run at different times, and that batteries deliver less total energy if you discharge them very quickly. Here is a breakdown of the key principles this calculator uses.</p>
    
                <h3>1. The Load Profile: The Most Critical Component</h3>
                <p>An industrial backup scenario is rarely a single, constant load. It's a sequence of events. For example, in a power outage:</p>
                <ol>
                    <li><strong>Period 1 (e.g., first 5 minutes):</strong> An initial high load occurs. Inverters, motors, and emergency systems all draw a large inrush current.</li>
                    <li><strong>Period 2 (e.g., next 2 hours):</strong> The system stabilizes. Only the "normal" critical loads (like control systems, servers, and essential lighting) remain on.</li>
                    <li><strong>Period 3 (e.g., last 5 minutes):</strong> A final high load occurs as operators perform a safe shutdown, re-close breakers, or start emergency equipment.</li>
                </ol>
                <p>This calculator breaks your requirement into these three distinct periods. The calculation for this (as per IEEE 485) is complex, as it determines the total capacity needed by calculating the capacity for *each period* and adding the *additional* capacity required for the *change* in load between periods. This is far more accurate than just averaging the load.</p>
    
                <h3>2. Battery Capacity (Ah) vs. Load (W)</h3>
                <p>A battery's capacity is rated in <strong>Amp-hours (Ah)</strong> at a specific voltage (V). A 100Ah, 12V battery can theoretically supply 100 Amps for 1 hour at 12V. This is a measure of *energy* ($Energy = V \times I \times T$).</p>
                <p>Your loads, however, are rated in <strong>Watts (W)</strong> or <strong>Volt-Amps (VA)</strong>, which are measures of *power*. To size the battery, we must first convert your total load (in Watts) into the total energy (in Amp-hours) needed for the entire backup time. This calculator does this by:</p>
                <ol>
                    <li>Converting all your loads (VA, Amps, HP) into a common unit: <strong>Watts (W)</strong>.</li>
                    <li>Calculating the Amps required from the battery: $Amps_{DC} = \text{Load (W)} / (\text{System Voltage (V)} \times \text{System Efficiency})$.</li>
                    <li>Calculating the Amp-hours (Ah) for each period of your load profile: $Ah = \text{Amps}_{DC} \times \text{Duration (hours)}$.</li>
                    <li>Summing these Ah periods (using the IEEE 485 methodology) to get the total Ah required.</li>
                </ol>
    
                <h3>3. The Correction & Derating Factors (Why 100Ah is Not 100Ah)</h3>
                <p>A 100Ah battery will almost never provide 100Ah of usable capacity in a real-world industrial application. The "nameplate" rating must be heavily corrected. This calculator applies four critical derating factors.</p>
    
                <h4>a. Depth of Discharge (DOD) Factor</h4>
                <p>You should *never* discharge a battery to 100%. This permanently damages it. To ensure a long service life, you only use a fraction of its total capacity. This is the Depth of Discharge.</p>
                <ul>
                    <li><strong>VRLA/Lead-Acid:** A <strong>50% DOD</strong> is common for standby applications to achieve a 5-10 year life. This means to get 100Ah of *usable* capacity, you must buy a 200Ah battery ($100Ah / 0.50 = 200Ah$).</li>
                    <li><strong>Lithium-ion:</strong> Can safely handle a much deeper discharge, often <strong>90% DOD</strong>. To get 100Ah usable, you only need to buy a ~111Ah battery ($100Ah / 0.90 = 111Ah$).</li>
                </ul>
    
                <h4>b. Temperature Correction Factor</h4>
                <p>Batteries are chemical devices, and their performance plummets in the cold. The standard 100% capacity rating is almost always specified at a perfect <strong>25°C (77°F)</strong>. If your battery room drops to 10°C (50°F), a lead-acid battery might only provide <strong>85%</strong> of its rated capacity. The calculator corrects for this by *increasing* the required Ah to compensate for the cold.</p>
    
                <h4>c. Aging Factor</h4>
                <p>A battery at the *end* of its service life (e.g., 8-10 years old) will not have 100% of its original capacity. Industry standards (like IEEE) consider a battery "end of life" when it can only hold <strong>80%</strong> of its original rating. Therefore, to ensure your battery can *still* provide 100Ah of power on its very last day of service, you must oversize it from day one. An aging factor of <strong>1.25</strong> (i.e., oversizing by 25%) is standard practice ($100Ah / 0.80 = 125Ah$).</p>
    
                <h4>d. Safety / Design Margin Factor</h4>
                <p>This is a final "engineer's factor" (typically 10-20%) added to account for unknown variables: load calculations weren't perfect, a new piece of equipment was added, etc. It provides a final buffer for reliability.</p>
    
                <div class="formula-block math-content">
                    $$\text{Final Ah} = \frac{Ah_{basic} \times \text{Aging Factor} \times \text{Safety Factor}}{\text{DOD Factor} \times \text{Temperature Factor}}$$
                </div>
    
                <h3>4. Final Configuration: Series vs. Parallel</h3>
                <p>Once the final required capacity (Ah) is known, the calculator determines the physical battery bank configuration.</p>
                <ul>
                    <li><strong>Series Units:** Batteries connected in series *increase voltage* while *Ah stays the same*. The number of units in series is determined by your system voltage.
                        <br><strong>Calculation:</strong> $N_{series} = \text{System Voltage} / \text{Battery Unit Voltage}$
                        <br><em>Example: A 48V system using 12V batteries requires $48V / 12V = 4$ batteries in series.</em>
                    </li>
                    <li><strong>Parallel Strings:** Batteries connected in parallel *increase Ah* while *voltage stays the same*. You add parallel strings until you meet your final Ah requirement.
                        <br><strong>Calculation:</strong> $N_{parallel} = \text{Final Required Ah} / \text{Selected Unit Ah Capacity}$
                        <br><em>Example: If you need 800Ah and are using 200Ah batteries, you need $800Ah / 200Ah = 4$ strings in parallel.</em>
                    </li>
                </ul>
                <p><strong>Total Batteries = (Units in Series) × (Strings in Parallel)</strong>. In the example above, you would need $4 \times 4 = 16$ total 12V/200Ah batteries.</p>
            </div>
        </div>
    </main>

    <!-- NEW FOOTER -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-col">
                    <h4>Design Calculators</h4>
                    <!-- Updated Text -->
                    <p style="font-size: 0.9rem; line-height: 1.6; margin-bottom: 15px;">
                        If you find this tool helpful, please consider sharing it with your colleagues!
                    </p>
                    <div class="social-buttons">
                        <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn linkedin" aria-label="LinkedIn"><i class="fab fa-linkedin-in"></i></a>
                        <a href="https://www.youtube.com/@designcalculators" target="_blank" rel="noopener noreferrer" class="social-btn youtube" aria-label="YouTube"><i class="fab fa-youtube"></i></a>
                        <a href="https://twitter.com/intent/tweet?url=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn twitter" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
                        <a href="https://www.facebook.com/sharer/sharer.php?u=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn facebook" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
                        <a href="https://api.whatsapp.com/send?text=Check%20out%20this%20amazing%20engineering%20resource:%20https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn whatsapp" aria-label="WhatsApp"><i class="fab fa-whatsapp"></i></a>
                    </div>
                </div>
                <div class="footer-col">
                    <h4>Quick Links</h4>
                    <ul>
                        <li><a href="/">Home</a></li>
                        <li><a href='/indexele.html'>Electrical</a></li>
                        <li><a href='/indexmech.html'>Mechanical</a></li>
                        <li><a href='/indexinst.html'>Instrumentation</a></li>
                        <li><a href='/articles.html'>Articles.html</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>Resources</h4>
                    <ul>
                        <li><a href='/about.html'>About Us</a></li>
                        <li><a href='/contact.html'>Contact</a></li>
                        <li><a href='/faq.html'>FAQ</a></li>
                        <li><a href='/privacy-policy.html'>Privacy Policy</a></li>
                        <li><a href='/terms-of-service.html'>Terms of Service</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>More</h4>
                    <ul>
                        <!-- Updated Link -->
                        <li><a href="/articles.html">Articles</a></li>
                        <li><a href='/sitemap2.html'>Sitemap</a></li>
                        <li><a href="https://www.youtube.com/@designcalculators" target="_blank" rel="noopener noreferrer">YouTube Channel</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-disclaimer">
                <p>All calculations are for preliminary design guidance. Always verify results against relevant engineering standards (ISO, ASME, IEC, NEC, IEEE) and manufacturer specifications. Final designs require professional engineering verification considering site-specific conditions.</p>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Design Calculators. Created by <span class="creator-name">A Sharma</span>. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Custom Message Box -->
    <div id="custom-message-box"></div>

    <!-- UPDATED SCRIPT with FIXES -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- DATABASE & DATA TABLES ---
            const tempCorrectionFactors = {
                'lead-acid': { '-20': 0.65, '-10': 0.75, '0': 0.85, '10': 0.92, '20': 0.98, '25': 1.0, '30': 1.02, '40': 1.05, '50': 1.07, '60': 1.08 },
                'gel': { '-20': 0.70, '-10': 0.80, '0': 0.88, '10': 0.94, '20': 0.99, '25': 1.0, '30': 1.01, '40': 1.03, '50': 1.04, '60': 1.05 },
                'lithium': { '-20': 0.80, '-10': 0.85, '0': 0.90, '10': 0.95, '20': 0.98, '25': 1.0, '30': 1.02, '40': 1.03, '50': 1.02, '60': 1.00 },
                'nickel-cadmium': { '-20': 0.75, '-10': 0.82, '0': 0.88, '10': 0.94, '20': 0.98, '25': 1.0, '30': 1.02, '40': 1.04, '50': 1.05, '60': 1.06 }
            };
            const standardBatterySizes = [7, 12, 17, 26, 35, 55, 75, 100, 150, 200, 250, 300, 400, 500, 600, 800, 1000, 1200];
            const batteryNominalVoltages = {
                'lead-acid': 2.0,
                'gel': 2.0,
                'lithium': 3.6,
                'nickel-cadmium': 1.2
            };
            const defaultValues = {
                'system-voltage': '48',
                'custom-voltage': '48',
                'backup-time': '2',
                'initial-high-load': '1000',
                'initial-high-load-unit': 'W',
                'initial-high-load-duration': '5',
                'normal-load-power': '500',
                'normal-load-power-unit': 'W',
                'final-high-load': '700',
                'final-high-load-unit': 'W',
                'final-high-load-duration': '5',
                'power-factor': '0.8',
                'discharge-rate': '0.1',
                'battery-type': 'lead-acid',
                'depth-of-discharge': '50',
                'custom-dod': '80',
                'temperature': '25',
                'efficiency': '85',
                'aging-factor': '1.2',
                'safety-factor': '1.2',
                'standard': 'ieee485'
            };

            // --- UI ELEMENT REFERENCES ---
            const systemVoltageSelect = document.getElementById('system-voltage');
            const customVoltageRow = document.getElementById('custom-voltage-row');
            const customVoltageInput = document.getElementById('custom-voltage');
            const batteryTypeSelect = document.getElementById('battery-type');
            const depthOfDischargeSelect = document.getElementById('depth-of-discharge');
            const customDodRow = document.getElementById('custom-dod-row');
            const customDodInput = document.getElementById('custom-dod');
            const calculateBtn = document.getElementById('calculate-btn');
            const resetFormBtn = document.getElementById('reset-calculations-btn');
            const downloadPdfBtn = document.getElementById('download-pdf-btn');
            const calculationSpinner = document.getElementById('calculate-spinner');
            const resultContainer = document.getElementById('result-container');
            const resultTableBody = document.getElementById('result-table-body');
            const standardReferenceDiv = document.getElementById('standard-reference');
            const calculationDetailsDiv = document.getElementById('calculation-details');
            const batteryGuideContent = document.getElementById('battery-guide-content');

            const initialHighLoadUnitSelect = document.getElementById('initial-high-load-unit');
            const normalLoadPowerUnitSelect = document.getElementById('normal-load-power-unit');
            const finalHighLoadUnitSelect = document.getElementById('final-high-load-unit');
            const powerFactorInput = document.getElementById('power-factor');
            const powerFactorRow = document.getElementById('power-factor-row');

            // --- DYNAMIC FORM LOGIC ---

            // Custom Message Box
            function displayMessage(message, type = "info") {
                let messageBox = document.getElementById('custom-message-box');
                messageBox.textContent = message;
                messageBox.style.color = 'white';
                if (type === "error") messageBox.style.backgroundColor = '#dc3545';
                else if (type === "warning") {
                    messageBox.style.backgroundColor = '#ffc107';
                    messageBox.style.color = '#333';
                } else messageBox.style.backgroundColor = '#28a745';
                messageBox.classList.add('show');
                setTimeout(() => messageBox.classList.remove('show'), 5000);
            }
            
            // *** FIX: Added addResultRow function ***
            function addResultRow(parameter, value) {
                const row = resultTableBody.insertRow(); // This creates and appends the <tr>
                const paramCell = row.insertCell();
                const valueCell = row.insertCell();
                paramCell.innerHTML = parameter; // Use innerHTML for strong tags
                valueCell.innerHTML = value;   // Use innerHTML for strong tags
            }

            // Find nearest temp in correction table
            function findNearestTemperature(targetTemp, tempTable) {
                const tempKeys = Object.keys(tempTable).map(Number);
                return tempKeys.reduce((prev, curr) => (Math.abs(curr - targetTemp) < Math.abs(prev - targetTemp) ? curr : prev)).toString();
            }

            // Toggle custom voltage
            function toggleCustomVoltageInput() {
                if (systemVoltageSelect.value === 'custom') {
                    customVoltageRow.classList.remove('hidden');
                    customVoltageInput.setAttribute('required', 'true');
                } else {
                    customVoltageRow.classList.add('hidden');
                    customVoltageInput.removeAttribute('required');
                }
            }

            // Update DOD options and visibility
            function updateDodOptionsAndVisibility() {
                const dodSelect = depthOfDischargeSelect;
                const currentBatteryType = batteryTypeSelect.value;
                const currentSelectedDod = dodSelect.value;

                while (dodSelect.options.length > 0) dodSelect.remove(0);

                let newOptions = [];
                switch (currentBatteryType) {
                    case 'lead-acid':
                    case 'gel':
                        newOptions = [{ value: '50', text: '50% (Standard Lead Acid/Gel)' }, { value: '80', text: '80% (Deep Cycle)' }];
                        break;
                    case 'lithium':
                        newOptions = [{ value: '80', text: '80% (Conservative)' }, { value: '90', text: '90% (Standard Lithium)' }, { value: '95', text: '95% (Maximum)' }];
                        break;
                    case 'nickel-cadmium':
                        newOptions = [{ value: '75', text: '75% (Standard NiCd)' }, { value: '85', text: '85% (Deep Discharge)' }];
                        break;
                }
                newOptions.forEach(opt => dodSelect.add(new Option(opt.text, opt.value)));
                dodSelect.add(new Option('Custom', 'custom'));

                if (newOptions.some(opt => opt.value === currentSelectedDod)) dodSelect.value = currentSelectedDod;
                else if (currentSelectedDod === 'custom') dodSelect.value = 'custom';
                else dodSelect.value = newOptions[0].value;

                if (dodSelect.value === 'custom') {
                    customDodRow.classList.remove('hidden');
                    customDodInput.setAttribute('required', 'true');
                } else {
                    customDodRow.classList.add('hidden');
                    customDodInput.removeAttribute('required');
                }
            }

            // Toggle power factor visibility
            function togglePowerFactorInput() {
                const needsPowerFactor = ['VA'].includes(initialHighLoadUnitSelect.value) || ['VA'].includes(normalLoadPowerUnitSelect.value) || ['VA'].includes(finalHighLoadUnitSelect.value);
                if (needsPowerFactor) {
                    powerFactorRow.classList.remove('hidden');
                    powerFactorInput.setAttribute('required', 'true');
                } else {
                    powerFactorRow.classList.add('hidden');
                    powerFactorInput.removeAttribute('required');
                }
            }

            // --- Clear/Reset Functions ---
            function clearResults() {
                resultContainer.classList.remove('show');
                batteryGuideContent.classList.remove('show'); // Hide content block
                
                // Clear content immediately
                resultTableBody.innerHTML = '';
                calculationDetailsDiv.innerHTML = '';
                standardReferenceDiv.innerHTML = '';
                resultContainer.style.display = 'none';
            }

            function resetForm() {
                for (const id in defaultValues) {
                    const input = document.getElementById(id);
                    if (input) input.value = defaultValues[id];
                }
                toggleCustomVoltageInput();
                updateDodOptionsAndVisibility();
                togglePowerFactorInput();
                clearResults(); // Clear results immediately
                displayMessage("Form reset to default values.", "info");
            }
            
            // --- PDF Generation ---
            function downloadPDF() {
                if (!resultContainer.classList.contains('show')) {
                    displayMessage("Please run a calculation first to generate a report.", "error");
                    return;
                }
                displayMessage("Generating PDF... Please wait.", "info");

                try {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    let currentY = 0;
                    
                    const addHeaderFooter = (page, pageCount) => {
                        pdf.setPage(page);
                        pdf.setFont("helvetica", "bold");
                        pdf.setFontSize(16);
                        pdf.setTextColor(30, 58, 138); // var(--primary-color)
                        pdf.text("https://designcalculators.co.in", pdfWidth / 2, 15, { align: 'center' });
                        
                        pdf.setFontSize(8);
                        pdf.setTextColor(150, 150, 150);
                        pdf.text(`Page ${page} of ${pageCount}`, pdfWidth / 2, pdfHeight - 15, { align: 'center' });
                        pdf.text("https://designcalculators.co.in", pdfWidth / 2, pdfHeight - 10, { align: 'center' });
                    };

                    // --- PDF Content ---
                    currentY = 25; // Start after header
                    pdf.setFont("helvetica", "bold");
                    pdf.setFontSize(18);
                    pdf.setTextColor(30, 58, 138);
                    pdf.text("Industrial Battery Sizing Report", pdfWidth / 2, currentY, { align: 'center' });
                    currentY += 10;
                    
                    pdf.setFont("helvetica", "normal");
                    pdf.setFontSize(10);
                    pdf.setTextColor(100, 100, 100);
                    pdf.text(`Generated on: ${new Date().toLocaleString()}`, pdfWidth / 2, currentY, { align: 'center' });
                    currentY += 15;

                    // --- 1. Input Parameters ---
                    pdf.setFont("helvetica", "bold");
                    pdf.setFontSize(14);
                    pdf.setTextColor(30, 58, 138);
                    pdf.text("Input Parameters", 10, currentY);
                    currentY += 8;
                    
                    pdf.setFont("helvetica", "normal");
                    pdf.setFontSize(10);
                    pdf.setTextColor(0, 0, 0);
                    
                    let systemVoltage = document.getElementById('system-voltage').value;
                    if (systemVoltage === 'custom') systemVoltage = document.getElementById('custom-voltage').value;
                    const backupTime = document.getElementById('backup-time').value;
                    const batteryType = document.getElementById('battery-type').value;
                    let dod = document.getElementById('depth-of-discharge').value;
                    if (dod === 'custom') dod = document.getElementById('custom-dod').value;
                    
                    const inputs = [
                        ["System Voltage", `${systemVoltage} V`],
                        ["Total Backup Time", `${backupTime} hours`],
                        ["Battery Type", batteryType],
                        ["Depth of Discharge", `${dod} %`],
                        ["Operating Temperature", `${document.getElementById('temperature').value} °C`],
                        ["System Efficiency", `${document.getElementById('efficiency').value} %`],
                        ["Aging Factor", document.getElementById('aging-factor').value],
                        ["Safety Factor", document.getElementById('safety-factor').value]
                    ];
                    
                    if (pdf.autoTable) {
                        pdf.autoTable({
                            body: inputs,
                            startY: currentY,
                            theme: 'grid',
                            headStyles: { fillColor: false, textColor: 0, fontStyle: 'bold' },
                            columnStyles: { 0: { fontStyle: 'bold' } },
                            didDrawPage: (data) => addHeaderFooter(data.pageNumber, pdf.internal.getNumberOfPages()),
                        });
                        currentY = pdf.autoTable.previous.finalY + 10;
                    }

                    // --- 2. Final Sizing Results ---
                    const resultTable = document.getElementById('result-table-body').closest('table');
                    if (resultTable && pdf.autoTable) {
                        if (currentY + 20 > pdfHeight - 20) { // Check for page break
                            pdf.addPage();
                            currentY = 25;
                        }
                        pdf.setFont("helvetica", "bold");
                        pdf.setFontSize(14);
                        pdf.setTextColor(30, 58, 138);
                        pdf.text("Final Sizing Results", 10, currentY);
                        currentY += 8;
                        pdf.autoTable({
                            html: resultTable,
                            startY: currentY,
                            theme: 'grid',
                            headStyles: { fillColor: [30, 58, 138] },
                            didDrawPage: (data) => addHeaderFooter(data.pageNumber, pdf.internal.getNumberOfPages()),
                        });
                        currentY = pdf.autoTable.previous.finalY + 10;
                    }
                    
                    // Add first page header/footer
                    addHeaderFooter(1, pdf.internal.getNumberOfPages());
                    
                    pdf.save('Battery-Sizing-Report.pdf');
                } catch (e) {
                    displayMessage("Error generating PDF. See console for details.", "error");
                    console.error("PDF Generation Error: ", e);
                }
            }

            // --- CALCULATION LOGIC ---
            function calculateBatteryCapacity() {
                calculationSpinner.style.display = 'inline-block';
                calculateBtn.disabled = true;

                // Clear previous results immediately
                clearResults();

                setTimeout(() => {
                    try {
                        // 1. Get all input values
                        let systemVoltageValue = systemVoltageSelect.value;
                        const totalBackupTimeHours = parseFloat(document.getElementById('backup-time').value);

                        const initialHighLoadValue = parseFloat(document.getElementById('initial-high-load').value);
                        const initialHighLoadDurationMinutes = parseFloat(document.getElementById('initial-high-load-duration').value);
                        const initialHighLoadUnit = initialHighLoadUnitSelect.value;

                        const normalLoadPowerValue = parseFloat(document.getElementById('normal-load-power').value);
                        const normalLoadPowerUnit = normalLoadPowerUnitSelect.value;

                        const finalHighLoadValue = parseFloat(document.getElementById('final-high-load').value);
                        const finalHighLoadDurationMinutes = parseFloat(document.getElementById('final-high-load-duration').value);
                        const finalHighLoadUnit = finalHighLoadUnitSelect.value;

                        const dischargeRate = parseFloat(document.getElementById('discharge-rate').value);
                        const batteryType = batteryTypeSelect.value;
                        let depthOfDischargeValue = depthOfDischargeSelect.value;
                        const temperature = parseFloat(document.getElementById('temperature').value);
                        const efficiency = parseFloat(document.getElementById('efficiency').value) / 100;
                        const agingFactor = parseFloat(document.getElementById('aging-factor').value);
                        const safetyFactor = parseFloat(document.getElementById('safety-factor').value);
                        const standard = document.getElementById('standard').value;

                        let powerFactor = 1.0;
                        if (!powerFactorRow.classList.contains('hidden')) {
                            powerFactor = parseFloat(powerFactorInput.value);
                            if (isNaN(powerFactor) || powerFactor <= 0 || powerFactor > 1) {
                                throw new Error("Power Factor must be between 0.01 and 1.0.");
                            }
                        }

                        if (systemVoltageSelect.value === 'custom') {
                            systemVoltageValue = parseFloat(customVoltageInput.value);
                        } else {
                            systemVoltageValue = parseFloat(systemVoltageValue);
                        }

                        if (depthOfDischargeSelect.value === 'custom') {
                            depthOfDischargeValue = parseFloat(customDodInput.value) / 100;
                        } else {
                            depthOfDischargeValue = parseFloat(depthOfDischargeValue) / 100;
                        }

                        // 2. Input Validation
                        if (isNaN(systemVoltageValue) || systemVoltageValue <= 0) throw new Error("System Voltage must be a positive number.");
                        if (isNaN(totalBackupTimeHours) || totalBackupTimeHours <= 0) throw new Error("Total Backup Time must be a positive number.");
                        if (isNaN(efficiency) || efficiency <= 0) throw new Error("System Efficiency must be a positive number.");
                        if (isNaN(depthOfDischargeValue) || depthOfDischargeValue <= 0 || depthOfDischargeValue > 1) throw new Error("Depth of Discharge must be between 1% and 100%.");
                        if (isNaN(temperature)) throw new Error("Please enter a valid Operating Temperature.");
                        if (isNaN(agingFactor) || agingFactor < 1) throw new Error("Aging Factor must be 1.0 or greater.");
                        if (isNaN(safetyFactor) || safetyFactor < 1) throw new Error("Safety Factor must be 1.0 or greater.");
                        
                        const totalHighLoadDurationMinutes = initialHighLoadDurationMinutes + finalHighLoadDurationMinutes;
                        if (totalHighLoadDurationMinutes / 60 > totalBackupTimeHours) {
                            throw new Error("The sum of initial and final high load durations cannot exceed the total backup time.");
                        }

                        // 3. Convert all loads to Watts for calculation
                        let initialHighLoadWatts = 0, normalLoadPowerWatts = 0, finalHighLoadWatts = 0;
                        let conversionHtml = '<h3>Detailed Calculation Steps</h3><h4>Load Conversion to Watts:</h4>';

                        // Helper for conversion
                        const convertToWatts = (value, unit, pf, volt) => {
                            switch (unit) {
                                case 'W': return value;
                                case 'VA': return value * pf;
                                case 'A': return value * volt; // Assuming 'A' is DC or single-phase AC equiv.
                            }
                        };
                        
                        initialHighLoadWatts = convertToWatts(initialHighLoadValue, initialHighLoadUnit, powerFactor, systemVoltageValue);
                        normalLoadPowerWatts = convertToWatts(normalLoadPowerValue, normalLoadPowerUnit, powerFactor, systemVoltageValue);
                        finalHighLoadWatts = convertToWatts(finalHighLoadValue, finalHighLoadUnit, powerFactor, systemVoltageValue);

                        conversionHtml += `<p class="calculation-step">Initial High Load: ${initialHighLoadValue.toFixed(2)} ${initialHighLoadUnit} → ${initialHighLoadWatts.toFixed(2)} W</p>`;
                        conversionHtml += `<p class="calculation-step">Normal Load: ${normalLoadPowerValue.toFixed(2)} ${normalLoadPowerUnit} → ${normalLoadPowerWatts.toFixed(2)} W</p>`;
                        conversionHtml += `<p class="calculation-step">Final High Load: ${finalHighLoadValue.toFixed(2)} ${finalHighLoadUnit} → ${finalHighLoadWatts.toFixed(2)} W</p>`;

                        // 4. Perform Calculations (Load Profiling per IEEE 485)
                        let calculationHtml = conversionHtml + '<h4>Battery Sizing (IEEE 485 Load Profile):</h4>';
                        
                        // Create load profile array
                        const loadProfile = [];
                        const initialDurationHours = initialHighLoadDurationMinutes / 60;
                        const finalDurationHours = finalHighLoadDurationMinutes / 60;
                        const normalDurationHours = totalBackupTimeHours - initialDurationHours - finalDurationHours;
                        
                        if (initialDurationHours > 0 && initialHighLoadWatts > 0) {
                            loadProfile.push({ power: initialHighLoadWatts, duration: initialDurationHours });
                        }
                        if (normalDurationHours > 0 && normalLoadPowerWatts > 0) {
                            loadProfile.push({ power: normalLoadPowerWatts, duration: normalDurationHours });
                        }
                        if (finalDurationHours > 0 && finalHighLoadWatts > 0) {
                            loadProfile.push({ power: finalHighLoadWatts, duration: finalDurationHours });
                        }

                        if (loadProfile.length === 0) {
                            // Check if at least normal load is present
                            if (normalLoadPowerWatts > 0 && totalBackupTimeHours > 0) {
                                loadProfile.push({ power: normalLoadPowerWatts, duration: totalBackupTimeHours });
                                calculationHtml += `<p>No distinct load profile entered. Using Normal Load for the entire duration.</p>`;
                            } else {
                                throw new Error("No valid loads entered. Please check load power and durations.");
                            }
                        }

                        // IEEE 485 Calculation
                        let totalAhRequired = 0;
                        calculationHtml += `<p><strong>1. Calculate Amp-hours for each Load Period:</strong></p>`;
                        
                        for (let i = 0; i < loadProfile.length; i++) {
                            const load = loadProfile[i];
                            const loadAmps = (load.power / systemVoltageValue) / efficiency;
                            let periodAh = 0;
                            
                            periodAh = loadAmps * load.duration;
                            totalAhRequired += periodAh;
                            
                            calculationHtml += `<p class="calculation-step"><strong>Period ${i+1}:</strong> ${load.power.toFixed(2)} W for ${load.duration.toFixed(2)} hours</p>`;
                            calculationHtml += `<p class="formula">$$Ah_{${i+1}} = \\frac{\\text{Load (W)}}{\\text{V}_{sys} \\times \\eta_{sys}} \\times \\text{Duration (h)}$$</p>`;
                            calculationHtml += `<p class="calculation-step">Amps = ${load.power.toFixed(2)}W / (${systemVoltageValue}V × ${efficiency}) = ${loadAmps.toFixed(2)} A</p>`;
                            calculationHtml += `<p class="calculation-step">Ah = ${loadAmps.toFixed(2)} A × ${load.duration.toFixed(2)} h = ${periodAh.toFixed(2)} Ah</p>`;
                        }

                        const basicAhRequirement = totalAhRequired;
                        calculationHtml += `<p><strong>2. Total Basic Amp-hour (Ah) Requirement ($Ah_{basic}$):</strong></p>`;
                        calculationHtml += `<p class="formula">$$Ah_{basic} = \\sum Ah_{\\text{periods}}$$</p>`;
                        calculationHtml += `<p class="calculation-step">Ah_basic = ${basicAhRequirement.toFixed(2)} Ah</p>`;

                        // 5. Apply Correction Factors
                        
                        // Apply depth of discharge correction
                        const dodCorrectedCapacity = basicAhRequirement / depthOfDischargeValue;
                        calculationHtml += `<p><strong>3. Apply Depth of Discharge (DOD):</strong></p>`;
                        calculationHtml += `<p class="formula">$$Ah_{DOD} = \\frac{Ah_{basic}}{\\text{DOD}}$$</p>`;
                        calculationHtml += `<p class="calculation-step">Ah_DOD = ${basicAhRequirement.toFixed(2)} Ah / ${depthOfDischargeValue.toFixed(2)} = ${dodCorrectedCapacity.toFixed(2)} Ah</p>`;
                        
                        // Apply temperature correction
                        const nearestTemp = findNearestTemperature(temperature, tempCorrectionFactors[batteryType]);
                        const tempCorrectionFactor = tempCorrectionFactors[batteryType][nearestTemp];
                        const tempCorrectedCapacity = dodCorrectedCapacity / tempCorrectionFactor;
                        calculationHtml += `<p><strong>4. Apply Temperature Correction:</strong></p>`;
                        calculationHtml += `<p class="formula">$$Ah_{Temp} = \\frac{Ah_{DOD}}{\\text{Temp. Correction Factor}}$$</p>`;
                        calculationHtml += `<p class="calculation-step">Temp Factor for ${temperature}°C ≈ ${tempCorrectionFactor.toFixed(3)}</p>`;
                        calculationHtml += `<p class="calculation-step">Ah_Temp = ${dodCorrectedCapacity.toFixed(2)} Ah / ${tempCorrectionFactor.toFixed(3)} = ${tempCorrectedCapacity.toFixed(2)} Ah</p>`;

                        // Apply aging and safety factors
                        const finalCapacity = tempCorrectedCapacity * agingFactor * safetyFactor;
                        calculationHtml += `<p><strong>5. Apply Aging and Safety Factors:</strong></p>`;
                        calculationHtml += `<p class="formula">$$Ah_{final} = Ah_{Temp} \\times \\text{Aging Factor} \\times \\text{Safety Factor}$$</p>`;
                        calculationHtml += `<p class="calculation-step">Ah_final = ${tempCorrectedCapacity.toFixed(2)} Ah × ${agingFactor.toFixed(2)} × ${safetyFactor.toFixed(2)} = <strong>${finalCapacity.toFixed(2)} Ah</strong></p>`;

                        // 6. Battery Bank Configuration
                        const nominalUnitVoltage = batteryNominalVoltages[batteryType];
                        
                        // Find standard unit size
                        let selectedUnitAhCapacity = standardBatterySizes.find(size => size >= finalCapacity);
                        let numParallelStrings = 1;

                        if (!selectedUnitAhCapacity) {
                             // Required capacity is larger than the biggest standard unit, must use parallel strings
                            selectedUnitAhCapacity = standardBatterySizes[standardBatterySizes.length - 1]; // Use largest unit
                            numParallelStrings = Math.ceil(finalCapacity / selectedUnitAhCapacity);
                        }
                        
                        const numSeriesUnits = Math.round(systemVoltageValue / nominalUnitVoltage);
                        if (Math.abs(systemVoltageValue - (numSeriesUnits * nominalUnitVoltage)) > 0.1) {
                            displayMessage(`Warning: System voltage ${systemVoltageValue}V is not an exact multiple of ${nominalUnitVoltage}V unit voltage. Rounded to ${numSeriesUnits} units in series.`, "warning");
                        }
                        
                        const totalBatteriesRequired = numSeriesUnits * numParallelStrings;
                        const actualAhProvidedByBank = selectedUnitAhCapacity * numParallelStrings;
                        
                        // Re-calculate actual backup time
                        const avgLoadWatts = (initialHighLoadWatts * initialDurationHours + normalLoadPowerWatts * normalDurationHours + finalHighLoadWatts * finalDurationHours) / totalBackupTimeHours;
                        const avgLoadAmps = (avgLoadWatts / systemVoltageValue) / efficiency;
                        const actualBackupTime = (actualAhProvidedByBank * depthOfDischargeValue * tempCorrectionFactor) / (avgLoadAmps * agingFactor * safetyFactor);

                        calculationHtml += `<p><strong>6. Determine Battery Bank Configuration:</strong></p>`;
                        calculationHtml += `<p class="calculation-step">Selected Unit Voltage: ${nominalUnitVoltage} V</p>`;
                        calculationHtml += `<p class="calculation-step">Units in Series = ${systemVoltageValue.toFixed(0)}V / ${nominalUnitVoltage}V = ${numSeriesUnits} units</p>`;
                        calculationHtml += `<p class="calculation-step">Required Ah (Final): ${finalCapacity.toFixed(2)} Ah</p>`;
                        calculationHtml += `<p class="calculation-step">Selected Unit Capacity: ${selectedUnitAhCapacity} Ah (Next standard size)</p>`;
                        calculationHtml += `<p class="calculation-step">Parallel Strings = ceil(${finalCapacity.toFixed(2)} Ah / ${selectedUnitAhCapacity} Ah) = ${numParallelStrings} string(s)</p>`;
                        calculationHtml += `<p class="calculation-step">Total Units = ${numSeriesUnits} (series) × ${numParallelStrings} (parallel) = <strong>${totalBatteriesRequired} units</strong></p>`;
                        
                        // 7. Display Results
                        calculationDetailsDiv.innerHTML = calculationHtml;
                        if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
                            window.MathJax.typesetPromise([calculationDetailsDiv]).catch(err => console.error("MathJax Error:", err));
                        }
                        
                        resultTableBody.innerHTML = '';
                        addResultRow("<strong>Final Calculated Battery Capacity</strong>", `<strong>${finalCapacity.toFixed(2)} Ah</strong>`);
                        addResultRow("<strong>Recommended Bank Configuration</strong>", `<strong>${totalBatteriesRequired} units</strong> (${numSeriesUnits} in series x ${numParallelStrings} in parallel)`);
                        addResultRow("<strong>Selected Unit Size</strong>", `<strong>${selectedUnitAhCapacity} Ah</strong> / <strong>${nominalUnitVoltage} V</strong>`);
                        addResultRow("Total System Capacity Provided", `${actualAhProvidedByBank.toFixed(0)} Ah`);
                        addResultRow("Est. Actual Backup Time", `${(actualBackupTime * 60).toFixed(1)} minutes`);
                        addResultRow("---", "---"); // Separator
                        addResultRow("Total Load (Average)", `${avgLoadWatts.toFixed(2)} W`);
                        addResultRow("Total Basic Ah Requirement", `${basicAhRequirement.toFixed(2)} Ah`);
                        addResultRow("DOD Corrected Ah", `${dodCorrectedCapacity.toFixed(2)} Ah`);
                        addResultRow("Temp Corrected Ah", `${tempCorrectedCapacity.toFixed(2)} Ah`);
                        addResultRow("---", "---"); // Separator
                        addResultRow("Design Standard", standard.toUpperCase());
                        addResultRow("Battery Type", batteryType.charAt(0).toUpperCase() + batteryType.slice(1).replace('-', ' '));
                        addResultRow("DOD", `${(depthOfDischargeValue * 100).toFixed(1)}%`);
                        addResultRow("Temperature Factor", `${tempCorrectionFactor.toFixed(3)} (at ${temperature}°C)`);
                        addResultRow("Aging Factor", agingFactor.toFixed(2));
                        addResultRow("Safety Factor", safetyFactor.toFixed(2));
                        
                        standardReferenceDiv.innerHTML = `Calculation based on <strong>${standard.toUpperCase()}</strong> load profiling. This determines the thermal withstand. Always consult local codes for minimum mechanical/corrosion sizing. Final design must be verified by a qualified engineer.`;
                        
                        resultContainer.style.display = 'block';
                        setTimeout(() => {
                            resultContainer.classList.add('show');
                            batteryGuideContent.classList.add('show');
                        }, 10);
                        resultContainer.scrollIntoView({ behavior: 'smooth' });

                    } catch (error) {
                        displayMessage(error.message, "error");
                    } finally {
                        calculationSpinner.style.display = 'none';
                        calculateBtn.disabled = false;
                    }
                }, 500); // 500ms delay
            }

            // --- EVENT LISTENERS ---
            calculateBtn.addEventListener('click', calculateBatteryCapacity);
            resetFormBtn.addEventListener('click', resetForm);
            downloadPdfBtn.addEventListener('click', downloadPDF);
            systemVoltageSelect.addEventListener('change', toggleCustomVoltageInput);
            batteryTypeSelect.addEventListener('change', updateDodOptionsAndVisibility);
            depthOfDischargeSelect.addEventListener('change', updateDodOptionsAndVisibility);
            initialHighLoadUnitSelect.addEventListener('change', togglePowerFactorInput);
            normalLoadPowerUnitSelect.addEventListener('change', togglePowerFactorInput);
            finalHighLoadUnitSelect.addEventListener('change', togglePowerFactorInput);

            // --- Theme switch logic ---
            const themeSwitch = document.getElementById('theme-switch');
            if (themeSwitch) {
                if (localStorage.getItem('theme') === 'dark') {
                    document.body.classList.add('dark-mode');
                    themeSwitch.checked = true;
                }
                themeSwitch.addEventListener('change', function() {
                    if (this.checked) {
                        document.body.classList.add('dark-mode');
                        localStorage.setItem('theme', 'dark');
                    } else {
                        document.body.classList.remove('dark-mode');
                        localStorage.setItem('theme', 'light');
                    }
                });
            }
            
            // --- INITIALIZE FORM ---
            toggleCustomVoltageInput();
            updateDodOptionsAndVisibility();
            togglePowerFactorInput();

        });
    </script>
</body>
</html>

