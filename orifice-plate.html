<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orifice Plate Flow Calculator - Design Calculators - Instrumentation</title>
    <!-- SEO Meta Tags -->
    <meta name="description" content="Professional orifice plate flow calculator for liquids and gases. Calculates mass and volumetric flow per ISO 5167 in metric/imperial units.">
    <meta name="keywords" content="orifice plate calculator, flow calculation, differential pressure, ISO 5167, instrumentation, bernoulli, reynolds number, beta ratio">
    <meta name="author" content="Design Calculators">
    <meta name="robots" content="index, follow">
    <!-- AdSense & Analytics -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5936527763614780" crossorigin="anonymous"></script>
    <script async src="https://www.googlesyndication.com/gtag/js?id=G-23Y1V450SR"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-23Y1V450SR');
    </script>
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Montserrat:wght@700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- MathJax for Formulas -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['\\(', '\\)'], ['$', '$']],
                displayMath: [['\\[', '\\]'], ['$$', '$$']]
            },
            svg: { fontCache: 'global' }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <!-- PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>
    <!-- Favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">

    <style>
        /* Base styles from 4-20mA Calculator */
        :root {
            --primary: #1E3A8A;
            --secondary: #2563EB;
            --accent: #F59E0B;
            --success: #10B981;
            --danger: #DC2626;
            --warning: #F59E0B;
            --bg: #F8FAFC;
            --card: #FFFFFF;
            --text: #4B5563;
            --heading: #111827;
            --footer-bg: #0F172A;
            --border: #E2E8F0;
            --grad: linear-gradient(135deg, var(--primary), var(--secondary));
            --grad-dark: linear-gradient(135deg, #0F172A, #1E293B);
            --shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        body.dark-mode {
            --primary: #10B981;
            --secondary: #34D399;
            --bg: #0F172A;
            --card: #1E293B;
            --text: #CBD5E1;
            --heading: #F1F5F9;
            --footer-bg: #020617;
            --border: #334155;
        }

        * { box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.7;
            margin: 0;
            padding: 0;
        }

        .container { max-width: 1280px; margin: 0 auto; padding: 0 24px; }

        /* Header & Nav */
        header {
            background: var(--grad);
            color: white;
            padding: 24px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo-container {
            display: flex;
            flex-direction: column;
            text-decoration: none;
            color: white;
        }
        .logo-text {
            font-size: 1.75rem;
            font-weight: 800;
            font-family: 'Montserrat', sans-serif;
        }
        .logo-subtitle {
            font-size: 0.8rem;
            margin: 4px 0 0 0;
            color: #E0E7FF;
            opacity: 0.9;
        }
        .nav-links {
            display: flex;
            gap: 24px;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        .nav-links a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }
        .nav-links a:hover { color: var(--accent); }
        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .switch {
            position: relative;
            width: 56px;
            height: 30px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.2);
            transition: .4s;
            border-radius: 30px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--accent);
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* Main Content & Cards */
        main { padding: 40px 0; }
        .card {
            background: var(--card);
            border-radius: 12px;
            padding: 30px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            border: 1px solid var(--border);
        }
        h2 {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
            padding-bottom: 15px;
            margin-top: 0;
            font-family: 'Montserrat', sans-serif;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        h3 {
            color: var(--heading);
            font-family: 'Montserrat', sans-serif;
            font-size: 1.5rem;
            margin-top: 25px;
            margin-bottom: 20px;
        }
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--heading);
        }
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 6px;
            background-color: var(--bg);
            color: var(--text);
            font-size: 1rem;
        }
        .form-group input:focus,
        .form-group select:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
        }
        body.dark-mode .form-group input:focus {
             box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .btn {
            background: var(--grad);
            color: white;
            border: none;
            padding: 16px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(30, 58, 138, 0.3);
            transition: all 0.3s;
            width: 100%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(30, 58, 138, 0.4);
        }
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .btn-group .btn {
            flex: 1;
            min-width: 150px;
        }
        .btn.secondary {
            background: var(--secondary);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }
        .btn.accent {
            background: var(--accent);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }
        
        /* Results Table */
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-radius: 8px;
            overflow: hidden;
        }
        .results-table th,
        .results-table td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        .results-table th {
            background: var(--grad);
            color: white;
            font-weight: 700;
        }
        .results-table tr:nth-child(even) {
            background-color: var(--bg);
        }
        .results-table td:first-child {
            font-weight: 600;
            color: var(--heading);
        }
        .results-table .highlight {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--success);
        }
        
        /* Message Box */
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 16px 28px;
            border-radius: 8px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.25);
            z-index: 10000;
            font-weight: 600;
            color: white;
            opacity: 0;
            transition: all 0.4s;
            display: none;
        }
        .message-box.show {
            display: block;
            opacity: 1;
            top: 30px;
        }

        /* Footer */
        footer {
            background: var(--grad-dark);
            color: #CBD5E1;
            padding: 50px 0 20px 0;
            margin-top: 60px;
        }
        .footer-content {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 40px;
            margin-bottom: 30px;
        }
        .footer-col {
            flex: 1;
            min-width: 200px;
        }
        .footer-col h4 {
            color: white;
            margin-bottom: 15px;
            font-weight: 700;
        }
        .footer-col ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .footer-col a {
            color: #CBD5E1;
            text-decoration: none;
            transition: color 0.3s;
        }
        .footer-col a:hover {
            color: var(--accent);
        }
        .social-buttons {
            display: flex;
            gap: 12px;
            margin-top: 15px;
        }
        .social-btn {
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            border-radius: 50%;
            font-size: 1.1rem;
            transition: transform 0.3s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .social-btn:hover {
            transform: translateY(-4px);
        }
        .social-btn.linkedin { background-color: #0A66C2; }
        .social-btn.youtube { background-color: #FF0000; }
        .social-btn.twitter { background-color: #1DA1F2; }
        .social-btn.facebook { background-color: #1877F2; }
        .social-btn.whatsapp { background-color: #25D366; }
        .footer-disclaimer {
            text-align: center;
            padding-top: 25px;
            border-top: 1px solid #334155;
            max-width: 800px;
            margin: 0 auto;
            font-size: 0.9rem;
        }
        .footer-bottom {
            text-align: center;
            padding-top: 20px;
            font-size: 0.9rem;
            color: #94A3B8;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container { padding: 0 15px; }
            .navbar { flex-direction: column; gap: 20px; }
            .nav-links { flex-direction: column; gap: 12px; text-align: center; }
            .form-row { grid-template-columns: 1fr; }
            .card { padding: 20px; }
            .footer-content { flex-direction: column; gap: 25px; }
            .btn-group { flex-direction: column; }
        }
        .hidden { display: none; }

        /* Tooltip */
        .info-icon {
            color: var(--primary);
            margin-left: 5px;
            cursor: help;
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 10;
            bottom: 125%;
            left: 50%;
            margin-left: -125px;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            transform: translateY(10px);
            font-family: 'Inter', sans-serif;
            font-size: 0.85rem;
            line-height: 1.4;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
            transform: translateY(0);
        }

        /* --- Orifice Calc Specific Styles --- */
        .tool-description {
            margin-bottom: 25px;
            font-size: 1.1rem;
            line-height: 1.7;
        }
        .form-section {
            background-color: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 25px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }
        .form-section h3 {
            color: var(--secondary);
            margin-top: 0;
            margin-bottom: 15px;
            border-bottom: 1px dashed var(--border);
            padding-bottom: 10px;
        }
        body.dark-mode .form-section h3 {
            color: var(--primary);
        }
        
        /* Styles for calculation details */
        #calculation-details {
            background-color: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
            font-size: 1rem;
            color: var(--text);
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
        }
        #calculation-details h4 {
            color: var(--secondary);
            margin-top: 0;
            margin-bottom: 15px;
            text-align: left;
            font-size: 1.2em;
        }
        body.dark-mode #calculation-details h4 {
             color: var(--primary);
        }
        #calculation-details p.formula-wrapper {
            text-align: center;
            padding: 15px 10px;
            background-color: var(--bg);
            border: 1px solid var(--border);
            border-left: 3px solid var(--accent);
            border-radius: 6px;
            margin: 15px 0;
            overflow-x: auto;
            font-size: 1.25rem; /* Larger font for formulas */
        }
        #calculation-details p.calculation-step {
            font-family: 'Courier New', monospace;
            background-color: var(--bg);
            border: 1px solid var(--border);
            padding: 8px 15px;
            border-radius: 4px;
            margin-bottom: 8px;
            color: var(--text);
            white-space: pre-wrap;
            word-break: break-word;
        }
        #calculation-details ul {
            list-style-type: disc;
            margin-left: 25px;
            padding-left: 0;
            margin-top: 15px;
        }
        #calculation-details ul li {
            margin-bottom: 8px;
            color: var(--text);
        }

        /* Styles for selectors */
        .unit-system-selector, .fluid-type-selector {
            margin-bottom: 20px;
            background-color: var(--bg);
            border-radius: 8px;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 15px;
        }
        .unit-system-selector label, .fluid-type-selector label {
            font-weight: bold;
            color: var(--heading);
            cursor: pointer;
        }
        .fluid-type-selector input[type="radio"] {
            margin-right: 8px;
            transform: scale(1.2);
            cursor: pointer;
        }

        /* Conditional display for fluid properties */
        #liquid-properties, #gas-properties {
            display: none; /* Hidden by default */
        }
        #liquid-properties.active, #gas-properties.active {
            display: grid; /* Use grid to match form-row */
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        /* Educational Section */
        .education-section {
            margin-top: 60px;
        }
        .insight-card {
            background: linear-gradient(135deg, var(--card), rgba(37,99,235,0.03));
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            border-left: 5px solid var(--secondary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: all 0.3s;
        }
        .insight-card:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .insight-card h4 {
            color: var(--secondary);
            font-size: 1.3rem;
            margin: 0 0 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .insight-card h4 i {
            font-size: 1.5rem;
        }
        .insight-card p, .insight-card ul {
            margin: 10px 0;
            line-height: 1.8;
            font-size: 1.1rem;
        }
        .insight-card ul {
            padding-left: 20px;
        }
        .insight-card li {
            margin-bottom: 10px;
        }
        .danger-box {
            background: linear-gradient(135deg, rgba(220,38,38,0.1), rgba(220,38,38,0.05));
            border-left: 5px solid var(--danger);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }
        .danger-box h4 {
            color: var(--danger);
            margin-top: 0;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .success-box {
            background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(16,185,129,0.05));
            border-left: 5px solid var(--success);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }
        .success-box h4 {
            color: var(--success);
            margin-top: 0;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
    </style>
</head>
<body>
    <div id="message-box" class="message-box"></div>

    <header>
        <div class="container">
            <nav class="navbar">
                <a class='logo-container' href='/'>
                    <span class="logo-text">Design Calculators</span>
                    <p class="logo-subtitle">Inspired by standards such as IEC, IEEE, ISA, ASME, and API.</p>
                </a>
                <ul class="nav-links">
                    <li><a href='/'>Home</a></li>
                    <li><a href="articles">Articles</a></li>
                    <li><a href="indexmech">Mechanical</a></li>
                    <li><a href="indexele">Electrical</a></li>
                    <li><a href="indexinst">Instrumentation</a></li>
                </ul>
                <div class="theme-toggle">
                    <i class="fas fa-sun"></i>
                    <label class="switch">
                        <input type="checkbox" id="theme-switch">
                        <span class="slider"></span>
                    </label>
                    <i class="fas fa-moon"></i>
                </div>
            </nav>
        </div>
    </header>

    <main class="container">
        <div class="card">
            <h2><i class="fas fa-chart-line"></i> Orifice Plate Flow Calculator</h2>
            <div class="tool-description">
                <p>This professional tool calculates the flow rate of a fluid (liquid or gas) through an orifice plate based on differential pressure and fluid properties. It is designed for engineers worldwide, supporting both Metric and Imperial units per <strong>ISO 5167</strong>, and is essential for accurate flow measurement in various industrial applications.</p>
            </div>

            <div class="calculator-form">
                <form id="orifice-flow-form">
                    <!-- Unit System Selection -->
                    <div class="form-section unit-system-selector">
                        <label for="unit-system">Unit System:</label>
                        <select id="unit-system" required>
                            <option value="metric">Metric (mm, Pa, kg/m³)</option>
                            <option value="imperial">Imperial (in, psi, lb/ft³)</option>
                        </select>
                        <label for="output-flow-type">Output Flow Type:</label>
                        <select id="output-flow-type" required>
                            <option value="volumetric">Volumetric Flow</option>
                            <option value="mass">Mass Flow</option>
                        </select>
                        <label for="output-flow-unit">Output Flow Unit:</label>
                        <select id="output-flow-unit" required>
                            <!-- Options will be dynamically populated -->
                        </select>
                    </div>

                    <!-- Input Parameters -->
                    <div class="form-section">
                        <h3>Primary Flow Parameters</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="orifice-diameter" id="label-orifice-diameter">Orifice Bore Diameter (d) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext" id="tooltip-orifice-diameter">The diameter of the hole in the orifice plate.</span></span></label>
                                <input type="number" id="orifice-diameter" step="0.001" value="50.0" required>
                            </div>
                            <div class="form-group">
                                <label for="pipe-diameter" id="label-pipe-diameter">Pipe Inside Diameter (D) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext" id="tooltip-pipe-diameter">The inside diameter of the pipe.</span></span></label>
                                <input type="number" id="pipe-diameter" step="0.001" value="100.0" required>
                            </div>
                            <div class="form-group">
                                <label for="differential-pressure" id="label-differential-pressure">Differential Pressure (ΔP) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext" id="tooltip-differential-pressure">The pressure difference measured across the taps.</span></span></label>
                                <input type="number" id="differential-pressure" step="0.01" value="1000.0" required>
                            </div>
                            <div class="form-group">
                                <label for="discharge-coefficient">Discharge Coefficient (C<sub>d</sub>) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Dimensionless coefficient accounting for energy losses. Typically ~0.61. Refer to ISO 5167 for precise calculation.</span></span></label>
                                <input type="number" id="discharge-coefficient" step="0.001" value="0.61" required>
                            </div>
                        </div>
                    </div>

                    <!-- Fluid Type Selection -->
                    <div class="form-section">
                        <h3>Fluid Type and Properties</h3>
                        <div class="fluid-type-selector">
                            <label>
                                <input type="radio" name="fluid-type" value="liquid" checked> <i class="fas fa-water" style="margin:0 5px;"></i> Liquid
                            </label>
                            <label>
                                <input type="radio" name="fluid-type" value="gas"> <i class="fas fa-wind" style="margin:0 5px;"></i> Gas
                            </label>
                        </div>

                        <!-- Liquid Specific Properties -->
                        <div id="liquid-properties" class="form-row active">
                            <div class="form-group">
                                <label for="liquid-density" id="label-liquid-density">Liquid Density (ρ) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext" id="tooltip-liquid-density">The density of the liquid at operating conditions.</span></span></label>
                                <input type="number" id="liquid-density" step="0.01" value="1000.0" required>
                            </div>
                            <div class="form-group">
                                <label for="liquid-viscosity" id="label-liquid-viscosity">Liquid Viscosity (μ) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext" id="tooltip-liquid-viscosity">Dynamic viscosity of the liquid. Used for Reynolds number.</span></span></label>
                                <input type="number" id="liquid-viscosity" step="0.000001" value="0.001" required>
                            </div>
                        </div>

                        <!-- Gas Specific Properties -->
                        <div id="gas-properties" class="form-row">
                            <div class="form-group">
                                <label for="molecular-weight" id="label-molecular-weight">Molecular Weight (MW) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext" id="tooltip-molecular-weight">E.g., Air ≈ 28.97 g/mol. Used to calculate gas density.</span></span></label>
                                <input type="number" id="molecular-weight" step="0.01" value="28.97" required>
                            </div>
                            <div class="form-group">
                                <label for="operating-temperature" id="label-operating-temperature">Operating Temperature (T) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext" id="tooltip-operating-temperature">The temperature of the gas at operating conditions.</span></span></label>
                                <input type="number" id="operating-temperature" step="0.1" value="25.0" required>
                            </div>
                            <div class="form-group">
                                <label for="absolute-pressure" id="label-absolute-pressure">Absolute Upstream Pressure (P<sub>1</sub>) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext" id="tooltip-absolute-pressure">Absolute pressure of the gas upstream of the orifice.</span></span></label>
                                <input type="number" id="absolute-pressure" step="0.1" value="101325.0" required>
                            </div>
                            <div class="form-group">
                                <label for="specific-heat-ratio" id="label-specific-heat-ratio">Specific Heat Ratio (k) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext" id="tooltip-specific-heat-ratio">Ratio of specific heats (Cp/Cv). E.g., Air ≈ 1.4.</span></span></label>
                                <input type="number" id="specific-heat-ratio" step="0.01" value="1.4" required>
                            </div>
                            <div class="form-group">
                                <label for="gas-viscosity" id="label-gas-viscosity">Gas Viscosity (μ) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext" id="tooltip-gas-viscosity">Dynamic viscosity of the gas. Used for Reynolds number.</span></span></label>
                                <input type="number" id="gas-viscosity" step="1e-7" value="0.000018" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="btn-group" style="margin-top: 25px;">
                        <button type="button" id="calculate-flow-btn" class="btn"><i class="fas fa-calculator"></i> Calculate Flow</button>
                        <button type="button" id="reset-form-btn" class="btn accent"><i class="fas fa-sync-alt"></i> Reset Form</button>
                        <button type="button" id="pdf-btn" class="btn secondary" style="display: none;"><i class="fas fa-file-pdf"></i> Download PDF</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Results Section -->
        <div id="results-section" class="card hidden">
            <h3><i class="fas fa-clipboard-check"></i> Flow Calculation Results</h3>
            
            <div id="calculation-details" class="math-content">
                <!-- Calculation steps will be inserted here by JS -->
            </div>
            
            <table class="results-table">
                <thead>
                    <tr>
                        <th>Parameter</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody id="result-table-body">
                    <!-- Results will be dynamically inserted here by JS -->
                </tbody>
            </table>
        </div>

        <!-- NEW/EXPANDED EDUCATIONAL INSIGHTS SECTION -->
        <div id="education-section" class="education-section card">
            <h2><i class="fas fa-lightbulb"></i> Professional Insights: The Orifice Plate</h2>

            <div class="insight-card">
                <h4><i class="fas fa-wind"></i> How It Works: The Principle of Differential Pressure</h4>
                <p>An orifice plate is the simplest and most common differential pressure (DP) flow meter. It's essentially a precision-machined metal plate with a specific-sized hole (the "orifice") inserted into a pipe. As fluid (liquid or gas) flows through the pipe, it's forced to constrict to pass through the smaller hole.</p>
                <p>This constriction is governed by <strong>Bernoulli's Principle</strong>, which states that for a flowing fluid, as velocity increases, pressure must decrease (and vice versa) to conserve energy.
                    <ul>
                        <li><strong>Upstream (P<sub>1</sub>):</strong> Before the plate, the fluid is moving at its normal velocity ($v_1$) and has a higher pressure ($P_1$).</li>
                        <li><strong>At the Orifice (Vena Contracta):</strong> To squeeze through the hole, the fluid's velocity ($v_2$) increases dramatically. This causes its pressure ($P_2$) to drop significantly. The point of highest velocity and lowest pressure, which actually occurs slightly *downstream* of the plate, is called the <strong>Vena Contracta</strong>.</li>
                        <li><strong>Downstream:</strong> After passing the orifice, the fluid expands back to the full pipe diameter, its velocity slows down, and it "recovers" some, but not all, of its initial pressure.</li>
                    </ul>
                A differential pressure transmitter measures the difference between the upstream pressure ($P_1$) and the downstream low pressure ($P_2$), creating the <strong>Differential Pressure (ΔP)</strong>. This ΔP is the key measurement used to calculate the flow rate.
                </p>
            </div>

            <div class="insight-card">
                <h4><i class="fas fa-cogs"></i> The Orifice Flow Equation (ISO 5167)</h4>
                <p>While the concept is simple, the real-world calculation is complex and standardized by <strong>ISO 5167</strong>. The calculator solves this practical equation for mass flow ($q_m$):</p>
                <div class="math-content" style="padding: 20px; background: var(--bg); border-radius: 8px; border: 1px solid var(--border);">
                    <p style="text-align: center; font-size: 1.2rem; overflow-x: auto;">
                        $$q_m = \frac{C_d Y}{\sqrt{1 - \beta^4}} \times \frac{\pi}{4}d^2 \times \sqrt{2 \Delta P \rho_1}$$
                    </p>
                </div>
                <p style="margin-top: 20px;">Let's break down each component:</p>
                <ul>
                    <li><strong>$q_m$:</strong> <strong>Mass Flow Rate</strong> (e.g., in kg/s). This is what's being calculated. To get <strong>Volumetric Flow Rate ($q_v$)</strong>, we simply divide by density: $q_v = q_m / \rho_1$.</li>
                    <li><strong>$C_d$:</strong> The <strong>Discharge Coefficient</strong>. This is a crucial correction factor (usually ~0.61) that accounts for energy losses (friction, turbulence) and the fact that the Vena Contracta is smaller than the physical orifice hole. It's not a constant; it's determined by the Reynolds number, Beta ratio, and tap locations.</li>
                    <li><strong>$Y$:</strong> The <strong>Expansion (or Expansibility) Factor</strong>. This is <strong>ONLY used for gases</strong>. Since gases are compressible, their density changes as their pressure drops. $Y$ is a factor (less than 1) that corrects for this change. For liquids, $Y = 1$.</li>
                    <li><strong>$\beta$:</strong> The <strong>Beta Ratio</strong> ($d/D$). This is the ratio of the orifice diameter ($d$) to the pipe diameter ($D$). A smaller beta means a more restrictive plate and a higher $\Delta P$ for the same flow.</li>
                    <li><strong>$\sqrt{1 - \beta^4}$:</strong> This entire term in the denominator is the <strong>Velocity of Approach Factor</strong>. It corrects for the fact that the fluid upstream isn't stationary but already has an initial velocity.</li>
                    <li><strong>$A_o$ or $\frac{\pi}{4}d^2$:</strong> The physical <strong>Area of the Orifice</strong>.</li>
                    <li><strong>$\sqrt{2 \Delta P \rho_1}$:</strong> This is the core of the calculation, derived from Bernoulli's equation, relating the differential pressure ($\Delta P$) and upstream fluid density ($\rho_1$) to the flow.</li>
                </ul>
            </div>

            <div class="success-box">
                <h4><i class="fas fa-check-circle"></i> Advantages of Orifice Plates</h4>
                <ul>
                    <li><strong>Low Cost:</strong> They are simple, inexpensive to manufacture, and robust.</li>
                    <li><strong>No Moving Parts:</strong> This leads to high reliability and low maintenance.</li>
                    <li><strong>Well-Understood:</strong> The physics and standards (like ISO 5167) are decades old and globally accepted.</li>
                    <li><strong>Versatile:</strong> Can be used for most clean liquids, gases, and steam.</li>
                    <li><strong>Easy Installation (Conceptually):</strong> They fit between standard pipe flanges. (But see "Dangers" for critical installation rules).</li>
                </ul>
            </div>

            <div class="danger-box">
                <h4><i class="fas fa-exclamation-triangle"></i> Disadvantages & Critical Considerations</h4>
                <ul>
                    <li><strong>High Permanent Pressure Loss:</strong> The turbulence created by the plate causes significant, unrecoverable pressure loss (energy loss). This means pumps or compressors must work harder, increasing operating costs.</li>
                    <li><strong>Limited Turndown Ratio:</strong> Flow is proportional to the <strong>square root</strong> of $\Delta P$ ($Flow \propto \sqrt{\Delta P}$). This means that at 20% flow, the $\Delta P$ is only 4% of its maximum ($0.2^2 = 0.04$). Most DP transmitters are not accurate at such low signal levels. A typical orifice plate has a turndown ratio of only <strong>3:1 or 4:1</strong>.</li>
                    <li><strong>Wear and Tear:</strong> The accuracy of an orifice plate depends entirely on its sharp upstream edge. Over time, abrasion (from dirty fluids) or corrosion can dull this edge, causing the meter to read *low* (i.e., more fluid gets through than the meter thinks).</li>
                    <li><strong>Straight Run Requirements:</strong> This is the most critical installation rule. To get a stable, predictable flow profile, the orifice plate *must* be installed in a long, straight section of pipe, far away from any disturbances like elbows, valves, or reducers. Standards often require <strong>10 to 50 pipe diameters (D) of straight pipe *before*</strong> the plate and <strong>5-10 D *after*</strong> it.</li>
                </ul>
            </div>
            
            <div class="insight-card">
                <h4><i class="fas fa-ruler-combined"></i> Why Pressure Tap Location is Critical</h4>
                <p>The $\Delta P$ reading is highly sensitive to *where* you drill the pressure taps. The pressure profile changes rapidly around the plate. To get repeatable and standard results, taps must be placed in one of the following standardized locations:</p>
                <ul>
                    <li><strong>Flange Taps:</strong> The most common in the US. The taps are drilled directly into the flanges holding the plate, each 1 inch (25.4 mm) from the plate's face.</li>
                    <li><strong>D and D/2 Taps:</strong> Common in Europe. The upstream tap is 1 pipe diameter (D) *before* the plate, and the downstream tap is 0.5 D *after* it (near the Vena Contracta).</li>
                    <li><strong>Corner Taps:</strong> The taps are drilled right at the "corners" where the plate meets the pipe wall. These are common in smaller pipe sizes.</li>
                </ul>
                <p>The Discharge Coefficient ($C_d$) used in the calculation is specific to the type of taps being used. Using a $C_d$ for flange taps with a D-D/2 tap installation will result in significant errors.</p>
            </div>
        </div>

    </main>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-col">
                    <h4>Design Calculators</h4>
                    <p style="font-size: 0.9rem; line-height: 1.6; margin-bottom: 15px;">If you find this tool helpful, please consider sharing it with your colleagues!</p>
                    <div class="social-buttons">
                        <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn linkedin" title="LinkedIn"><i class="fab fa-linkedin-in"></i></a>
                        <a href="https://www.youtube.com/@designcalculators" target="_blank" rel="noopener noreferrer" class="social-btn youtube" title="YouTube"><i class="fab fa-youtube"></i></a>
                        <a href="https://twitter.com/intent/tweet?url=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn twitter" title="Twitter"><i class="fab fa-twitter"></i></a>
                        <a href="https://www.facebook.com/sharer/sharer.php?u=https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn facebook" title="Facebook"><i class="fab fa-facebook-f"></i></a>
                        <a href="https://api.whatsapp.com/send?text=Check%20out%20this%20amazing%20engineering%20resource%20https://designcalculators.co.in" target="_blank" rel="noopener noreferrer" class="social-btn whatsapp" title="WhatsApp"><i class="fab fa-whatsapp"></i></a>
                    </div>
                </div>
                <div class="footer-col">
                    <h4>Quick Links</h4>
                    <ul>
                        <li><a href='/'>Home</a></li>
                        <li><a href="indexele">Electrical</a></li>
                        <li><a href="indexmech">Mechanical</a></li>
                        <li><a href="indexinst">Instrumentation</a></li>
                        <li><a href="articles">Articles</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>Resources</h4>
                    <ul>
                        <li><a href="about">About Us</a></li>
                        <li><a href="contact">Contact</a></li>
                        <li><a href="faq">FAQ</a></li>
                        <li><a href="privacy-policy">Privacy Policy</a></li>
                        <li><a href="terms-of-service">Terms of Service</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>More</h4>
                    <ul>
                        <li><a href='/articles'>Articles & Whitepapers</a></li>
                        <li><a href="sitemap.html">Sitemap</a></li>
                        <li><a href="https://www.youtube.com/@designcalculators" target="_blank" rel="noopener noreferrer">YouTube Channel</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-disclaimer">
                <p>This calculator is for educational and preliminary design purposes. Calculations are based on ISO 5167. Always verify calculations against manufacturer data and ensure proper installation (straight runs, tap location) for accurate measurement. Consult a qualified engineer for critical applications.</p>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Design Calculators. Created by <span style="color: var(--secondary); font-weight: bold;">A Sharma</span>. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- Element Cache ---
            const unitSystemSelect = document.getElementById('unit-system');
            const outputFlowTypeSelect = document.getElementById('output-flow-type');
            const outputFlowUnitSelect = document.getElementById('output-flow-unit');
            const orificeDiameterInput = document.getElementById('orifice-diameter');
            const pipeDiameterInput = document.getElementById('pipe-diameter');
            const differentialPressureInput = document.getElementById('differential-pressure');
            const dischargeCoefficientInput = document.getElementById('discharge-coefficient');

            const fluidTypeRadios = document.querySelectorAll('input[name="fluid-type"]');
            const liquidPropertiesDiv = document.getElementById('liquid-properties');
            const gasPropertiesDiv = document.getElementById('gas-properties');

            const liquidDensityInput = document.getElementById('liquid-density');
            const liquidViscosityInput = document.getElementById('liquid-viscosity');
            const molecularWeightInput = document.getElementById('molecular-weight');
            const operatingTemperatureInput = document.getElementById('operating-temperature');
            const absolutePressureInput = document.getElementById('absolute-pressure');
            const specificHeatRatioInput = document.getElementById('specific-heat-ratio');
            const gasViscosityInput = document.getElementById('gas-viscosity');

            const labelOrificeDiameter = document.getElementById('label-orifice-diameter');
            const labelPipeDiameter = document.getElementById('label-pipe-diameter');
            const labelDifferentialPressure = document.getElementById('label-differential-pressure');
            const labelLiquidDensity = document.getElementById('label-liquid-density');
            const labelLiquidViscosity = document.getElementById('label-liquid-viscosity');
            const labelMolecularWeight = document.getElementById('label-molecular-weight');
            const labelOperatingTemperature = document.getElementById('label-operating-temperature');
            const labelAbsolutePressure = document.getElementById('label-absolute-pressure');
            const labelSpecificHeatRatio = document.getElementById('label-specific-heat-ratio');
            const labelGasViscosity = document.getElementById('label-gas-viscosity');

            const calculateFlowBtn = document.getElementById('calculate-flow-btn');
            const resetFormBtn = document.getElementById('reset-form-btn');
            const pdfBtn = document.getElementById('pdf-btn');
            
            const resultsSection = document.getElementById('results-section');
            const resultTableBody = document.getElementById('result-table-body');
            const calculationDetailsDiv = document.getElementById('calculation-details');
            
            const messageBox = document.getElementById('message-box');
            const themeSwitch = document.getElementById('theme-switch');

            let lastInputs = null; // For PDF generation

            // --- Constants ---
            const UNIVERSAL_GAS_CONSTANT_SI = 8.314462618; // J/(mol·K) or Pa·m³/(mol·K)
            const ABSOLUTE_ZERO_CELSIUS = 273.15; // K
            
            // Default values for resetting form (Metric)
            const defaultValues = {
                'unit-system': 'metric',
                'output-flow-type': 'volumetric',
                'orifice-diameter': 50.0, // mm
                'pipe-diameter': 100.0, // mm
                'differential-pressure': 1000.0, // Pa
                'discharge-coefficient': 0.61,
                'fluid-type': 'liquid',
                'liquid-density': 1000.0, // kg/m³
                'liquid-viscosity': 0.001, // Pa·s (water at 20°C)
                'molecular-weight': 28.97, // g/mol (air)
                'operating-temperature': 25.0, // °C
                'absolute-pressure': 101325.0, // Pa (1 atm)
                'specific-heat-ratio': 1.4, // for air
                'gas-viscosity': 0.000018 // Pa·s (air at 20°C)
            };

            // Unit configurations
            const unitsConfig = {
                'metric': {
                    diameter: { label: 'mm', tooltip: 'millimeters', toSI: 1 / 1000 },
                    pressure: { label: 'Pa', tooltip: 'Pascals', toSI: 1 },
                    temperature: { label: '°C', tooltip: 'Celsius', toKelvin: (T) => T + ABSOLUTE_ZERO_CELSIUS },
                    density: { label: 'kg/m³', tooltip: 'kilograms per cubic meter', toSI: 1 },
                    viscosity: { label: 'Pa·s', tooltip: 'Pascal-seconds', toSI: 1 },
                    molecularWeight: { label: 'g/mol', tooltip: 'grams per mole', toSI: 1 / 1000 }, // g/mol to kg/mol
                    flowOutputs: {
                        volumetric: [
                            { value: 'm3s', label: 'm³/s' },
                            { value: 'Ls', label: 'L/s' },
                            { value: 'm3hr', label: 'm³/hr' }
                        ],
                        mass: [
                            { value: 'kgs', label: 'kg/s' },
                            { value: 'kgmin', label: 'kg/min' },
                            { value: 'kghr', label: 'kg/hr' }
                        ]
                    }
                },
                'imperial': {
                    diameter: { label: 'in', tooltip: 'inches', toSI: 0.0254 },
                    pressure: { label: 'psi', tooltip: 'pounds per square inch', toSI: 6894.76 },
                    temperature: { label: '°F', tooltip: 'Fahrenheit', toKelvin: (T) => (T - 32) * 5/9 + ABSOLUTE_ZERO_CELSIUS },
                    density: { label: 'lb/ft³', tooltip: 'pounds per cubic foot', toSI: 16.0185 },
                    viscosity: { label: 'lb/(ft·s)', tooltip: 'pounds per foot-second', toSI: 1.48816 }, // lb/(ft·s) to Pa·s
                    molecularWeight: { label: 'lb/lbmol', tooltip: 'pounds per pound-mole', toSI: 1 / 1000 }, // lb/lbmol to kg/mol
                    flowOutputs: {
                        volumetric: [
                            { value: 'ft3s', label: 'ft³/s' },
                            { value: 'gpm', label: 'GPM (US)' },
                            { value: 'bpd', label: 'BPD (US)' }
                        ],
                        mass: [
                            { value: 'lbs', label: 'lb/s' },
                            { value: 'lbmin', label: 'lb/min' },
                            { value: 'lbhr', label: 'lb/hr' }
                        ]
                    }
                }
            };

            // Conversion factors for output units from m³/s or kg/s
            const outputConversions = {
                'm3s': { factor: 1, type: 'volumetric' },
                'Ls': { factor: 1000, type: 'volumetric' },
                'm3hr': { factor: 3600, type: 'volumetric' },
                'ft3s': { factor: 35.3147, type: 'volumetric' },
                'gpm': { factor: 15850.3, type: 'volumetric' },
                'bpd': { factor: 5434.36, type: 'volumetric' },
                'kgs': { factor: 1, type: 'mass' },
                'kgmin': { factor: 60, type: 'mass' },
                'kghr': { factor: 3600, type: 'mass' },
                'lbs': { factor: 2.20462, type: 'mass' },
                'lbmin': { factor: 132.277, type: 'mass' },
                'lbhr': { factor: 7936.64, type: 'mass' }
            };

            // --- Event Listeners ---
            unitSystemSelect.addEventListener('change', () => {
                populateOutputFlowUnits();
                updateUnitLabelsAndTooltips();
            });
            outputFlowTypeSelect.addEventListener('change', populateOutputFlowUnits);
            fluidTypeRadios.forEach(radio => radio.addEventListener('change', updateFluidPropertiesVisibility));
            calculateFlowBtn.addEventListener('click', calculateFlow);
            resetFormBtn.addEventListener('click', resetForm);
            pdfBtn.addEventListener('click', generatePDF);

            // Theme Toggle
            if (localStorage.getItem('theme') === 'dark') {
                document.body.classList.add('dark-mode');
                themeSwitch.checked = true;
            }
            themeSwitch.addEventListener('change', function() {
                if (this.checked) {
                    document.body.classList.add('dark-mode');
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.body.classList.remove('dark-mode');
                    localStorage.setItem('theme', 'light');
                }
            });

            // --- Initial Setup ---
            populateOutputFlowUnits();
            updateUnitLabelsAndTooltips();
            updateFluidPropertiesVisibility();
            
            // --- Utility Functions ---
            function showMessage(msg, type = 'success') {
                messageBox.textContent = msg;
                messageBox.style.color = 'white'; // Default
                if (type === 'error') {
                    messageBox.style.backgroundColor = 'var(--danger)';
                } else if (type === 'warning') {
                     messageBox.style.backgroundColor = 'var(--warning)';
                     messageBox.style.color = '#333'; // Dark text for yellow bg
                } else {
                    messageBox.style.backgroundColor = 'var(--success)';
                }
                messageBox.classList.add('show');
                setTimeout(() => messageBox.classList.remove('show'), 4000);
            }

            function format(num, decimals = 3) {
                if (isNaN(num)) return 'N/A';
                if (Math.abs(num) > 1e6 || Math.abs(num) < 1e-3 && num !== 0) {
                    return num.toExponential(decimals);
                }
                return parseFloat(num.toFixed(decimals)).toString();
            }
            
            function addResultRow(parameter, value) {
                const row = resultTableBody.insertRow();
                const paramCell = row.insertCell();
                const valueCell = row.insertCell();
                paramCell.innerHTML = parameter;
                valueCell.innerHTML = value;
            }

            // --- UI Update Functions ---
            function populateOutputFlowUnits() {
                const selectedSystem = unitSystemSelect.value;
                const selectedFlowType = outputFlowTypeSelect.value;
                const flowOutputs = unitsConfig[selectedSystem].flowOutputs[selectedFlowType];
                outputFlowUnitSelect.innerHTML = '';
                flowOutputs.forEach(unit => {
                    const option = document.createElement('option');
                    option.value = unit.value;
                    option.textContent = unit.label;
                    outputFlowUnitSelect.appendChild(option);
                });
            }

            function updateUnitLabelsAndTooltips() {
                const selectedSystem = unitSystemSelect.value;
                const config = unitsConfig[selectedSystem];
                const fluidType = document.querySelector('input[name="fluid-type"]:checked').value;

                labelOrificeDiameter.innerHTML = `Orifice Bore Diameter (d) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Unit: ${config.diameter.tooltip}.</span></span>`;
                labelPipeDiameter.innerHTML = `Pipe Inside Diameter (D) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Unit: ${config.diameter.tooltip}.</span></span>`;
                labelDifferentialPressure.innerHTML = `Differential Pressure (ΔP) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Unit: ${config.pressure.tooltip}.</span></span>`;
                
                if (fluidType === 'liquid') {
                    labelLiquidDensity.innerHTML = `Liquid Density (ρ) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Unit: ${config.density.tooltip}.</span></span>`;
                    labelLiquidViscosity.innerHTML = `Liquid Viscosity (μ) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Unit: ${config.viscosity.tooltip}.</span></span>`;
                } else {
                    labelMolecularWeight.innerHTML = `Molecular Weight (MW) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Unit: ${config.molecularWeight.tooltip}.</span></span>`;
                    labelOperatingTemperature.innerHTML = `Operating Temperature (T) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Unit: ${config.temperature.tooltip}.</span></span>`;
                    labelAbsolutePressure.innerHTML = `Absolute Upstream Pressure (P<sub>1</sub>) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Unit: ${config.pressure.tooltip}.</span></span>`;
                    labelSpecificHeatRatio.innerHTML = `Specific Heat Ratio (k) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Dimensionless. E.g., Air ≈ 1.4.</span></span>`;
                    labelGasViscosity.innerHTML = `Gas Viscosity (μ) <span class="tooltip"><i class="fas fa-info-circle info-icon"></i><span class="tooltiptext">Unit: ${config.viscosity.tooltip}.</span></span>`;
                }
                
                orificeDiameterInput.placeholder = `e.g., ${config.diameter.label}`;
                pipeDiameterInput.placeholder = `e.g., ${config.diameter.label}`;
                differentialPressureInput.placeholder = `e.g., ${config.pressure.label}`;
                liquidDensityInput.placeholder = `e.g., ${config.density.label}`;
                liquidViscosityInput.placeholder = `e.g., ${config.viscosity.label}`;
                molecularWeightInput.placeholder = `e.g., ${config.molecularWeight.label}`;
                operatingTemperatureInput.placeholder = `e.g., ${config.temperature.label}`;
                absolutePressureInput.placeholder = `e.g., ${config.pressure.label}`;
                gasViscosityInput.placeholder = `e.g., ${config.viscosity.label}`;
            }

            function updateFluidPropertiesVisibility() {
                const selectedFluidType = document.querySelector('input[name="fluid-type"]:checked').value;
                if (selectedFluidType === 'liquid') {
                    liquidPropertiesDiv.classList.add('active');
                    gasPropertiesDiv.classList.remove('active');
                    liquidDensityInput.setAttribute('required', 'required');
                    liquidViscosityInput.setAttribute('required', 'required');
                    molecularWeightInput.removeAttribute('required');
                    operatingTemperatureInput.removeAttribute('required');
                    absolutePressureInput.removeAttribute('required');
                    specificHeatRatioInput.removeAttribute('required');
                    gasViscosityInput.removeAttribute('required');
                } else {
                    liquidPropertiesDiv.classList.remove('active');
                    gasPropertiesDiv.classList.add('active');
                    liquidDensityInput.removeAttribute('required');
                    liquidViscosityInput.removeAttribute('required');
                    molecularWeightInput.setAttribute('required', 'required');
                    operatingTemperatureInput.setAttribute('required', 'required');
                    absolutePressureInput.setAttribute('required', 'required');
                    specificHeatRatioInput.setAttribute('required', 'required');
                    gasViscosityInput.setAttribute('required', 'required');
                }
                updateUnitLabelsAndTooltips();
                clearResults();
            }

            // --- Form & Calculation Logic ---
            function clearResults() {
                resultsSection.classList.add('hidden');
                resultTableBody.innerHTML = '';
                calculationDetailsDiv.innerHTML = '';
                pdfBtn.style.display = 'none';
                lastInputs = null;
            }

            function resetForm() {
                unitSystemSelect.value = defaultValues['unit-system'];
                outputFlowTypeSelect.value = defaultValues['output-flow-type'];
                document.querySelector(`input[name="fluid-type"][value="${defaultValues['fluid-type']}"]`).checked = true;
                
                orificeDiameterInput.value = defaultValues['orifice-diameter'];
                pipeDiameterInput.value = defaultValues['pipe-diameter'];
                differentialPressureInput.value = defaultValues['differential-pressure'];
                dischargeCoefficientInput.value = defaultValues['discharge-coefficient'];
                liquidDensityInput.value = defaultValues['liquid-density'];
                liquidViscosityInput.value = defaultValues['liquid-viscosity'];
                molecularWeightInput.value = defaultValues['molecular-weight'];
                operatingTemperatureInput.value = defaultValues['operating-temperature'];
                absolutePressureInput.value = defaultValues['absolute-pressure'];
                specificHeatRatioInput.value = defaultValues['specific-heat-ratio'];
                gasViscosityInput.value = defaultValues['gas-viscosity'];
                
                populateOutputFlowUnits();
                updateFluidPropertiesVisibility();
                clearResults();
                showMessage("Form reset to default values (Metric, Liquid).", "success");
            }

            function calculateFlow() {
                clearResults();
                try {
                    const selectedSystem = unitSystemSelect.value;
                    const selectedFlowType = outputFlowTypeSelect.value;
                    const outputFlowUnit = outputFlowUnitSelect.value;
                    const config = unitsConfig[selectedSystem];

                    // Get primary inputs
                    let d_in = parseFloat(orificeDiameterInput.value);
                    let D_in = parseFloat(pipeDiameterInput.value);
                    let dP_in = parseFloat(differentialPressureInput.value);
                    let Cd = parseFloat(dischargeCoefficientInput.value);
                    
                    let rho_si, mu_si, Y = 1, T_kelvin, P1_si, MW_si, k;
                    const fluidType = document.querySelector('input[name="fluid-type"]:checked').value;

                    // Validation
                    if (isNaN(d_in) || d_in <= 0) throw new Error("Orifice Diameter must be a positive number.");
                    if (isNaN(D_in) || D_in <= 0) throw new Error("Pipe Diameter must be a positive number.");
                    if (d_in >= D_in) throw new Error("Orifice Diameter (d) must be less than Pipe Diameter (D).");
                    if (isNaN(dP_in) || dP_in < 0) throw new Error("Differential Pressure (ΔP) must be a positive number.");
                    if (isNaN(Cd) || Cd <= 0 || Cd >= 1) showMessage("Warning: Discharge Coefficient (Cd) is typically between 0.59 and 0.62.", "warning");
                    
                    // Convert primary inputs to SI
                    const d_si = d_in * config.diameter.toSI;
                    const D_si = D_in * config.diameter.toSI;
                    const dP_si = dP_in * config.pressure.toSI;

                    let calculationHtml = '<h4>Detailed Calculation Steps:</h4>';
                    calculationHtml += `<p><strong>Unit System:</strong> ${selectedSystem.toUpperCase()}</p>`;
                    calculationHtml += `<p><strong>1. Convert Inputs to SI Units:</strong></p>`;
                    calculationHtml += `<p class="calculation-step">Orifice Diameter (d) = ${d_in} ${config.diameter.label} = ${format(d_si, 5)} m</p>`;
                    calculationHtml += `<p class="calculation-step">Pipe Diameter (D) = ${D_in} ${config.diameter.label} = ${format(D_si, 5)} m</p>`;
                    calculationHtml += `<p class="calculation-step">Differential Pressure (ΔP) = ${dP_in} ${config.pressure.label} = ${format(dP_si, 2)} Pa</p>`;

                    // Get fluid properties
                    if (fluidType === 'liquid') {
                        let rho_in = parseFloat(liquidDensityInput.value);
                        let mu_in = parseFloat(liquidViscosityInput.value);
                        if (isNaN(rho_in) || rho_in <= 0) throw new Error("Liquid Density must be a positive number.");
                        if (isNaN(mu_in) || mu_in <= 0) throw new Error("Liquid Viscosity must be a positive number.");
                        
                        rho_si = rho_in * config.density.toSI;
                        mu_si = mu_in * config.viscosity.toSI;
                        Y = 1; // Expansion factor is 1 for liquids

                        calculationHtml += `<p><strong>2. Liquid Properties (SI):</strong></p>`;
                        calculationHtml += `<p class="calculation-step">Density (ρ) = ${rho_in} ${config.density.label} = ${format(rho_si, 3)} kg/m³</p>`;
                        calculationHtml += `<p class="calculation-step">Viscosity (μ) = ${mu_in} ${config.viscosity.label} = ${format(mu_si, 6)} Pa·s</p>`;
                        calculationHtml += `<p class="calculation-step">Expansion Factor (Y) = 1 (for incompressible liquids)</p>`;
                    } else { // gas
                        let MW_in = parseFloat(molecularWeightInput.value);
                        let T_in = parseFloat(operatingTemperatureInput.value);
                        let P1_in = parseFloat(absolutePressureInput.value);
                        k = parseFloat(specificHeatRatioInput.value);
                        let mu_in = parseFloat(gasViscosityInput.value);
                        
                        if (isNaN(MW_in) || MW_in <= 0) throw new Error("Molecular Weight must be a positive number.");
                        if (isNaN(T_in)) throw new Error("Operating Temperature must be a valid number.");
                        if (isNaN(P1_in) || P1_in <= 0) throw new Error("Absolute Upstream Pressure must be a positive number.");
                        if (isNaN(k) || k <= 1) throw new Error("Specific Heat Ratio (k) must be greater than 1.");
                        if (isNaN(mu_in) || mu_in <= 0) throw new Error("Gas Viscosity must be a positive number.");

                        T_kelvin = config.temperature.toKelvin(T_in);
                        P1_si = P1_in * config.pressure.toSI;
                        MW_si = MW_in * config.molecularWeight.toSI;
                        mu_si = mu_in * config.viscosity.toSI;
                        
                        if (T_kelvin <= 0) throw new Error("Temperature must be above absolute zero.");

                        // Calculate gas density using Ideal Gas Law: ρ = (P * MW) / (R * T)
                        rho_si = (P1_si * MW_si) / (UNIVERSAL_GAS_CONSTANT_SI * T_kelvin);
                        
                        const beta_ratio = d_si / D_si;
                        const pressure_ratio = dP_si / P1_si;
                        if (pressure_ratio >= 1) throw new Error("Differential Pressure (ΔP) cannot be greater than Absolute Pressure (P1).");

                        // Calculate Expansion Factor (Y) per ISO 5167-2
                        Y = 1 - (0.351 + 0.256 * Math.pow(beta_ratio, 4) + 0.93 * Math.pow(beta_ratio, 8)) * (1 - Math.pow(pressure_ratio, 1/k));
                        
                        calculationHtml += `<p><strong>2. Gas Properties (SI):</strong></p>`;
                        calculationHtml += `<p class="calculation-step">Temperature (T) = ${T_in} ${config.temperature.label} = ${format(T_kelvin, 2)} K</p>`;
                        calculationHtml += `<p class="calculation-step">Upstream Pressure (P<sub>1</sub>) = ${P1_in} ${config.pressure.label} = ${format(P1_si, 2)} Pa</p>`;
                        calculationHtml += `<p class="calculation-step">Molecular Weight (MW) = ${MW_in} ${config.molecularWeight.label} = ${format(MW_si, 5)} kg/mol</p>`;
                        calculationHtml += `<p class="calculation-step">Calculated Density (ρ) = (P₁ * MW) / (R * T) = ${format(rho_si, 3)} kg/m³</p>`;
                        calculationHtml += `<p class="calculation-step">Viscosity (μ) = ${mu_in} ${config.viscosity.label} = ${format(mu_si, 8)} Pa·s</p>`;
                        calculationHtml += `<p class="calculation-step">Specific Heat Ratio (k) = ${k}</p>`;
                        calculationHtml += `<p class="calculation-step">Calculated Expansion Factor (Y) = ${format(Y, 4)}</p>`;
                    }

                    // --- Core Calculation ---
                    const Ao = (Math.PI / 4) * Math.pow(d_si, 2);
                    const beta = d_si / D_si;
                    const beta4 = Math.pow(beta, 4);
                    const velocityOfApproach = 1 / Math.sqrt(1 - beta4);
                    
                    const massFlowRate_kgs = Cd * Y * Ao * velocityOfApproach * Math.sqrt(2 * dP_si * rho_si);
                    const volumetricFlowRate_m3s = massFlowRate_kgs / rho_si;

                    // Reynolds Number (based on pipe diameter D)
                    const Re = (4 * massFlowRate_kgs) / (Math.PI * D_si * mu_si);

                    calculationHtml += `<p><strong>3. Calculate Intermediate Values:</strong></p>`;
                    calculationHtml += `<p class="calculation-step">Orifice Area (A<sub>o</sub>) = π/4 * d² = ${format(Ao, 6)} m²</p>`;
                    calculationHtml += `<p class="calculation-step">Beta Ratio (β) = d / D = ${format(beta, 4)}</p>`;
                    calculationHtml += `<p class="calculation-step">Velocity of Approach Factor = 1 / √(1 - β⁴) = ${format(velocityOfApproach, 4)}</p>`;
                    
                    calculationHtml += `<p><strong>4. Calculate Flow Rate (SI):</strong></p>`;
                    calculationHtml += `<p class="formula-wrapper">$$q_m = C_d Y A_o \left( \frac{1}{\sqrt{1 - \beta^4}} \right) \sqrt{2 \Delta P \rho_1}$$</p>`;
                    calculationHtml += `<p class="calculation-step">Mass Flow (q<sub>m</sub>) = ${format(massFlowRate_kgs, 4)} kg/s</p>`;
                    calculationHtml += `<p class="formula-wrapper">$$q_v = q_m / \rho_1$$</p>`;
                    calculationHtml += `<p class="calculation-step">Volumetric Flow (q<sub>v</sub>) = ${format(volumetricFlowRate_m3s, 4)} m³/s</p>`;

                    // --- Final Conversion ---
                    let finalFlowRate, finalFlowUnitLabel;
                    if (selectedFlowType === 'volumetric') {
                        finalFlowRate = volumetricFlowRate_m3s * outputConversions[outputFlowUnit].factor;
                        finalFlowUnitLabel = outputFlowUnitSelect.options[outputFlowUnitSelect.selectedIndex].text;
                    } else { // mass
                        finalFlowRate = massFlowRate_kgs * outputConversions[outputFlowUnit].factor;
                        finalFlowUnitLabel = outputFlowUnitSelect.options[outputFlowUnitSelect.selectedIndex].text;
                    }
                    
                    calculationHtml += `<p><strong>5. Final Converted Result:</strong></p>`;
                    calculationHtml += `<p class="calculation-step">Final Flow = ${format(finalFlowRate, 3)} ${finalFlowUnitLabel}</p>`;
                    
                    calculationDetailsDiv.innerHTML = calculationHtml;

                    // --- Populate Results Table ---
                    resultTableBody.innerHTML = '';
                    addResultRow("Beta Ratio (β)", `${format(beta, 4)}`);
                    addResultRow("Reynolds Number (Re)", `${format(Re, 2)}`);
                    if(fluidType === 'gas') {
                        addResultRow("Calculated Gas Density (ρ)", `${format(rho_si, 3)} kg/m³`);
                        addResultRow("Expansion Factor (Y)", `${format(Y, 4)}`);
                    }
                    addResultRow("Mass Flow Rate (SI)", `${format(massFlowRate_kgs, 4)} kg/s`);
                    addResultRow("Volumetric Flow Rate (SI)", `${format(volumetricFlowRate_m3s, 4)} m³/s`);
                    addResultRow(`<strong>Final ${selectedFlowType} Flow</strong>`, `<strong class="highlight">${format(finalFlowRate, 3)} ${finalFlowUnitLabel}</strong>`);

                    // Store for PDF
                    lastInputs = {
                        config, d_in, D_in, dP_in, Cd,
                        fluidType,
                        rho_in: (fluidType === 'liquid') ? parseFloat(liquidDensityInput.value) : null,
                        mu_in: (fluidType === 'liquid') ? parseFloat(liquidViscosityInput.value) : parseFloat(gasViscosityInput.value),
                        MW_in: (fluidType === 'gas') ? parseFloat(molecularWeightInput.value) : null,
                        T_in: (fluidType === 'gas') ? parseFloat(operatingTemperatureInput.value) : null,
                        P1_in: (fluidType === 'gas') ? parseFloat(absolutePressureInput.value) : null,
                        k: (fluidType === 'gas') ? k : null,
                        finalFlowRate, finalFlowUnitLabel
                    };

                    // --- Show Results ---
                    resultsSection.classList.remove('hidden');
                    pdfBtn.style.display = 'inline-flex';
                    
                    if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
                        setTimeout(() => {
                            window.MathJax.typesetPromise([calculationDetailsDiv]);
                        }, 50);
                    }
                    
                    setTimeout(() => {
                        resultsSection.scrollIntoView({ behavior: 'smooth' });
                    }, 100);
                    showMessage("Calculation successful!", "success");

                } catch (e) {
                    showMessage(e.message, "error");
                    clearResults();
                }
            }

            // --- PDF Generation ---
            function generatePDF() {
                if (!lastInputs) {
                    showMessage('Please run a calculation first.', 'error');
                    return;
                }

                try {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    let y = 15;
                    const { config, ...inputs } = lastInputs;

                    pdf.setFont('helvetica', 'bold');
                    pdf.setFontSize(16);
                    pdf.text('Orifice Plate Flow Report', 105, y, { align: 'center' });
                    y += 8;
                    pdf.setFont('helvetica', 'normal');
                    pdf.setFontSize(9);
                    pdf.text(`Generated by Design Calculators | ${new Date().toLocaleString()}`, 105, y, { align: 'center' });
                    y += 10;

                    pdf.setFont('helvetica', 'bold');
                    pdf.setFontSize(12);
                    pdf.text('Input Parameters', 14, y);
                    y += 2;

                    let inputRows = [
                        ["Unit System", unitSystemSelect.value],
                        ["Orifice Diameter (d)", `${inputs.d_in} ${config.diameter.label}`],
                        ["Pipe Diameter (D)", `${inputs.D_in} ${config.diameter.label}`],
                        ["Differential Pressure (ΔP)", `${inputs.dP_in} ${config.pressure.label}`],
                        ["Discharge Coefficient (C_d)", `${inputs.Cd}`],
                        ["Fluid Type", inputs.fluidType.charAt(0).toUpperCase() + inputs.fluidType.slice(1)]
                    ];
                    
                    if (inputs.fluidType === 'liquid') {
                        inputRows.push(["Liquid Density (ρ)", `${inputs.rho_in} ${config.density.label}`]);
                        inputRows.push(["Liquid Viscosity (μ)", `${inputs.mu_in} ${config.viscosity.label}`]);
                    } else {
                        inputRows.push(["Molecular Weight (MW)", `${inputs.MW_in} ${config.molecularWeight.label}`]);
                        inputRows.push(["Operating Temperature (T)", `${inputs.T_in} ${config.temperature.label}`]);
                        inputRows.push(["Absolute Upstream Pressure (P₁)", `${inputs.P1_in} ${config.pressure.label}`]);
                        inputRows.push(["Specific Heat Ratio (k)", `${inputs.k}`]);
                        inputRows.push(["Gas Viscosity (μ)", `${inputs.mu_in} ${config.viscosity.label}`]);
                    }

                    pdf.autoTable({
                        startY: y,
                        head: [['Parameter', 'Value']],
                        body: inputRows,
                        margin: { left: 14, right: 14 },
                        theme: 'grid',
                        headStyles: { fillColor: [30, 58, 138] }
                    });
                    y = pdf.autoTable.previous.finalY + 10;

                    // Add Results
                    pdf.setFont('helvetica', 'bold');
                    pdf.setFontSize(12);
                    pdf.text('Calculation Summary', 14, y);
                    y += 2;

                    const resultRows = Array.from(resultTableBody.querySelectorAll('tr')).map(tr => [
                        tr.cells[0].textContent,
                        tr.cells[1].textContent
                    ]);

                    pdf.autoTable({
                        startY: y,
                        head: [['Parameter', 'Value']],
                        body: resultRows,
                        margin: { left: 14, right: 14 },
                        theme: 'grid',
                        headStyles: { fillColor: [30, 58, 138] },
                        didParseCell: function (data) {
                            if (data.cell.text[0].includes('Final')) {
                                data.cell.styles.textColor = [16, 185, 129]; // Green
                                data.cell.styles.fontStyle = 'bold';
                                data.row.cells[1].styles.textColor = [16, 185, 129];
                                data.row.cells[1].styles.fontStyle = 'bold';
                            }
                        }
                    });
                    y = pdf.autoTable.previous.finalY + 15;

                    // Add footer
                    pdf.setFont('helvetica', 'normal');
                    pdf.setFontSize(10);
                    pdf.setTextColor(40, 40, 40);
                    pdf.text('For more calculators and information, visit http://designcalculators.co.in', 105, y, { align: 'center' });
                    y += 5;
                    pdf.setFontSize(8);
                    pdf.setTextColor(100, 100, 100);
                    pdf.text('This report is for guidance only. Always verify calculations per ISO 5167.', 105, y, { align: 'center' });

                    pdf.save('Orifice-Flow-Calculation-Report.pdf');
                    showMessage('PDF downloaded successfully');

                } catch (e) {
                    showMessage(`Error generating PDF: ${e.message}`, 'error');
                }
            }
        });
    </script>
</body>
</html>
